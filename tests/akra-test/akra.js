var __extends = this.__extends || function (d, b) {
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var akra;
(function (akra) {
    (function (ELogLevel) {
        ELogLevel._map = [];
        ELogLevel.NONE = 0x0000;
        ELogLevel.LOG = 0x0001;
        ELogLevel.INFORMATION = 0x0002;
        ELogLevel.WARNING = 0x0004;
        ELogLevel.ERROR = 0x0008;
        ELogLevel.CRITICAL = 0x0010;
        ELogLevel.ALL = 0x001F;
    })(akra.ELogLevel || (akra.ELogLevel = {}));
    var ELogLevel = akra.ELogLevel;
})(akra || (akra = {}));
var akra;
(function (akra) {
    akra.DEBUG = true;
    akra.logger;
    akra.typeOf;
    akra.typeOf = function typeOf(x) {
        var s = typeof x;
        if (s === "object") {
            if (x) {
                if (x instanceof Array) {
                    return 'array';
                } else if (x instanceof Object) {
                    return s;
                }
                var sClassName = Object.prototype.toString.call(x);
                if (sClassName == '[object Window]') {
                    return 'object';
                }
                if ((sClassName == '[object Array]' || typeof x.length == 'number' && typeof x.splice != 'undefined' && typeof x.propertyIsEnumerable != 'undefined' && !x.propertyIsEnumerable('splice'))) {
                    return 'array';
                }
                if ((sClassName == '[object Function]' || typeof x.call != 'undefined' && typeof x.propertyIsEnumerable != 'undefined' && !x.propertyIsEnumerable('call'))) {
                    return 'function';
                }
            } else {
                return 'null';
            }
        } else if (s == 'function' && typeof x.call == 'undefined') {
            return 'object';
        }
        return s;
    };
    akra.isDef = /** @inline */function (x) {
        return x !== undefined;
    };
    akra.isEmpty = /** @inline */function (x) {
        return x.length == 0;
    };
    akra.isDefAndNotNull = /** @inline */function (x) {
        return x != null;
    };
    akra.isNull = /** @inline */function (x) {
        return x === null;
    };
    akra.isBoolean = /** @inline */function (x) {
        return typeof x === "boolean";
    };
    akra.isString = /** @inline */function (x) {
        return typeof x === "string";
    };
    akra.isNumber = /** @inline */function (x) {
        return typeof x === "number";
    };
    akra.isFloat = akra.isNumber;
    akra.isInt = akra.isNumber;
    akra.isFunction = /** @inline */function (x) {
        return akra.typeOf(x) === "function";
    };
    akra.isObject = function (x) {
        var type = akra.typeOf(x);
        return type == "object" || type == "array" || type == "function";
    };
    akra.isArrayBuffer = /** @inline */function (x) {
        return x instanceof ArrayBuffer;
    };
    akra.isTypedArray = /** @inline */function (x) {
        return x !== null && typeof x === "object" && typeof x.byteOffset === "number";
    };
    akra.isBlob = /** @inline */function (x) {
        return x instanceof Blob;
    };
    akra.isArray = function (x) {
        return akra.typeOf(x) == "array";
    };
    ;
    function genArray(pType, nSize) {
        var tmp = new Array(nSize);
        for(var i = 0; i < nSize; ++i) {
            tmp[i] = (pType ? new pType() : null);
        }
        return tmp;
    }
    akra.genArray = genArray;
    akra.INVALID_INDEX = 0xffff;
    akra.MIN_INT32 = 0xffffffff;
    akra.MAX_INT32 = 0x7fffffff;
    akra.MIN_INT16 = 0xffff;
    akra.MAX_INT16 = 0x7fff;
    akra.MIN_INT8 = 0xff;
    akra.MAX_INT8 = 0x7f;
    akra.MIN_UINT32 = 0;
    akra.MAX_UINT32 = 0xffffffff;
    akra.MIN_UINT16 = 0;
    akra.MAX_UINT16 = 0xffff;
    akra.MIN_UINT8 = 0;
    akra.MAX_UINT8 = 0xff;
    akra.SIZE_FLOAT64 = 8;
    akra.SIZE_REAL64 = 8;
    akra.SIZE_FLOAT32 = 4;
    akra.SIZE_REAL32 = 4;
    akra.SIZE_INT32 = 4;
    akra.SIZE_UINT32 = 4;
    akra.SIZE_INT16 = 2;
    akra.SIZE_UINT16 = 2;
    akra.SIZE_INT8 = 1;
    akra.SIZE_UINT8 = 1;
    akra.SIZE_BYTE = 1;
    akra.SIZE_UBYTE = 1;
    akra.MAX_FLOAT64 = Number.MAX_VALUE;
    akra.MIN_FLOAT64 = -Number.MAX_VALUE;
    akra.TINY_FLOAT64 = Number.MIN_VALUE;
    akra.MAX_FLOAT32 = 3.4e38;
    akra.MIN_FLOAT32 = -3.4e38;
    akra.TINY_FLOAT32 = 1.5e-45;
    akra.DEFAULT_MATERIAL_NAME = "default";
    (function (EDataTypes) {
        EDataTypes._map = [];
        EDataTypes.BYTE = 0x1400;
        EDataTypes.UNSIGNED_BYTE = 0x1401;
        EDataTypes.SHORT = 0x1402;
        EDataTypes.UNSIGNED_SHORT = 0x1403;
        EDataTypes.INT = 0x1404;
        EDataTypes.UNSIGNED_INT = 0x1405;
        EDataTypes.FLOAT = 0x1406;
    })(akra.EDataTypes || (akra.EDataTypes = {}));
    var EDataTypes = akra.EDataTypes;
    ;
    (function (EDataTypeSizes) {
        EDataTypeSizes._map = [];
        EDataTypeSizes.BYTES_PER_BYTE = 1;
        EDataTypeSizes.BYTES_PER_UNSIGNED_BYTE = 1;
        EDataTypeSizes.BYTES_PER_UBYTE = 1;
        EDataTypeSizes.BYTES_PER_SHORT = 2;
        EDataTypeSizes.BYTES_PER_UNSIGNED_SHORT = 2;
        EDataTypeSizes.BYTES_PER_USHORT = 2;
        EDataTypeSizes.BYTES_PER_INT = 4;
        EDataTypeSizes.BYTES_PER_UNSIGNED_INT = 4;
        EDataTypeSizes.BYTES_PER_UINT = 4;
        EDataTypeSizes.BYTES_PER_FLOAT = 4;
    })(akra.EDataTypeSizes || (akra.EDataTypeSizes = {}));
    var EDataTypeSizes = akra.EDataTypeSizes;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
        function getTypeSize(eType) {
        switch(eType) {
            case EDataTypes.BYTE:
            case EDataTypes.UNSIGNED_BYTE:
                return 1;
            case EDataTypes.SHORT:
            case EDataTypes.UNSIGNED_SHORT:
                return 2;
            case EDataTypes.INT:
            case EDataTypes.UNSIGNED_INT:
            case EDataTypes.FLOAT:
                return 4;
            default:
 {
                    akra.logger.setSourceLocation("common.ts", 411);
                    akra.logger.error('unknown data/image type used');
                }
                ;
        }
    }
    akra.getTypeSize = getTypeSize;
    akra._total = 0;
    akra.sid = /** @inline */function (tmp) {
        if (typeof tmp === "undefined") { tmp = 1; }
        return (++akra._total);
    };
    function now() {
        return (new Date()).getTime();
    }
    akra.now = now;
    function memcpy(pDst, iDstOffset, pSrc, iSrcOffset, nLength) {
        var dstU8 = new Uint8Array(pDst, iDstOffset, nLength);
        var srcU8 = new Uint8Array(pSrc, iSrcOffset, nLength);
        dstU8.set(srcU8);
    }
    akra.memcpy = memcpy;
    ;
    (window).URL = (window).URL ? (window).URL : (window).webkitURL ? (window).webkitURL : null;
    (window).BlobBuilder = (window).WebKitBlobBuilder || (window).MozBlobBuilder || (window).BlobBuilder;
    (window).requestFileSystem = (window).requestFileSystem || (window).webkitRequestFileSystem;
    (window).requestAnimationFrame = (window).requestAnimationFrame || (window).webkitRequestAnimationFrame || (window).mozRequestAnimationFrame;
    (window).WebSocket = (window).WebSocket || (window).MozWebSocket;
    (window).storageInfo = (window).storageInfo || (window).webkitTemporaryStorage;
    (navigator).gamepads = (navigator).gamepads || (navigator).webkitGamepads;
    (navigator).getGamepads = (navigator).getGamepads || (navigator).webkitGetGamepads;
    Worker.prototype.postMessage = (Worker).prototype.webkitPostMessage || Worker.prototype.postMessage;
})(akra || (akra = {}));
;
function utf8_encode(argString) {
    if (argString === null || typeof argString === "undefined") {
        return "";
    }
    var string = (argString + "");
    var utftext = "", start, end, stringl = 0;
    start = end = 0;
    stringl = string.length;
    for(var n = 0; n < stringl; n++) {
        var c1 = string.charCodeAt(n);
        var enc = null;
        if (c1 < 128) {
            end++;
        } else if (c1 > 127 && c1 < 2048) {
            enc = String.fromCharCode((c1 >> 6) | 192) + String.fromCharCode((c1 & 63) | 128);
        } else {
            enc = String.fromCharCode((c1 >> 12) | 224) + String.fromCharCode(((c1 >> 6) & 63) | 128) + String.fromCharCode((c1 & 63) | 128);
        }
        if (enc !== null) {
            if (end > start) {
                utftext += string.slice(start, end);
            }
            utftext += enc;
            start = end = n + 1;
        }
    }
    if (end > start) {
        utftext += string.slice(start, stringl);
    }
    return utftext;
}
function utf8_decode(str_data) {
    var tmp_arr = [], i = 0, ac = 0, c1 = 0, c2 = 0, c3 = 0;
    str_data += "";
    while(i < str_data.length) {
        c1 = str_data.charCodeAt(i);
        if (c1 < 128) {
            tmp_arr[ac++] = String.fromCharCode(c1);
            i++;
        } else if (c1 > 191 && c1 < 224) {
            c2 = str_data.charCodeAt(i + 1);
            tmp_arr[ac++] = String.fromCharCode(((c1 & 31) << 6) | (c2 & 63));
            i += 2;
        } else {
            c2 = str_data.charCodeAt(i + 1);
            c3 = str_data.charCodeAt(i + 2);
            tmp_arr[ac++] = String.fromCharCode(((c1 & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
            i += 3;
        }
    }
    return tmp_arr.join("");
}
var akra;
(function (akra) {
    (function (libs) {
        String.prototype.toUTF8 = function () {
            return utf8_encode(this);
        };
        String.prototype.fromUTF8 = function () {
            return utf8_decode(this);
        };
        String.prototype.replaceAt = function (n, chr) {
            return this.substr(0, n) + chr + this.substr(n + chr.length);
        };
        Object.defineProperty(Array.prototype, 'first', {
            enumerable: false,
            configurable: true,
            get: function () {
                return this[0];
            }
        });
        Object.defineProperty(Array.prototype, 'last', {
            enumerable: false,
            configurable: true,
            get: function () {
                return this[this.length - 1];
            }
        });
        Object.defineProperty(Array.prototype, 'el', {
            enumerable: false,
            configurable: true,
            value: function (i) {
                i = i || 0;
                return this[i < 0 ? this.length + i : i];
            }
        });
        Object.defineProperty(Array.prototype, 'clear', {
            enumerable: false,
            configurable: true,
            value: function () {
                this.length = 0;
            }
        });
        Object.defineProperty(Array.prototype, 'swap', {
            enumerable: false,
            configurable: true,
            value: function (i, j) {
                if (i < this.length && j < this.length) {
                    var t = this[i];
                    this[i] = this[j];
                    this[j] = t;
                }
            }
        });
        Object.defineProperty(Array.prototype, 'insert', {
            enumerable: false,
            configurable: true,
            value: function (pElement) {
                if (typeof pElement.length === 'number') {
                    for(var i = 0, n = pElement.length; i < n; ++i) {
                        this.push(pElement[i]);
                    }
                    ;
                } else {
                    this.push(pElement);
                }
                return this;
            }
        });
        Number.prototype.toHex = function (iLength) {
            var sValue = this.toString(16);
            for(var i = 0; i < iLength - sValue.length; ++i) {
                sValue = '0' + sValue;
            }
            return sValue;
        };
        Number.prototype.printBinary = function (isPretty) {
            if (typeof isPretty === "undefined") { isPretty = true; }
            var res = "";
            for(var i = 0; i < 32; ++i) {
                if (i && (i % 4) == 0 && isPretty) {
                    res = ' ' + res;
                }
                (this >> i & 0x1 ? res = '1' + res : res = '0' + res);
            }
            return res;
        };
    })(akra.libs || (akra.libs = {}));
    var libs = akra.libs;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (bf) {
        bf.flag = /** @inline */function (x) {
            return (1 << (x));
        };
        bf.testBit = /** @inline */function (value, bit) {
            return ((value & ((1 << (bit)))) != 0);
        };
        bf.testAll = /** @inline */function (value, set) {
            return (((value) & (set)) == (set));
        };
        bf.testAny = /** @inline */function (value, set) {
            return (((value) & (set)) != 0);
        };
        bf.setBit = /** @inline */function (value, bit, setting) {
            if (typeof setting === "undefined") { setting = true; }
            return (setting ? ((value) |= ((1 << ((bit))))) : (((value) &= ~((1 << ((bit)))))));
        };
        bf.clearBit = /** @inline */function (value, bit) {
            return ((value) &= ~((1 << ((bit)))));
        };
        bf.setAll = /** @inline */function (value, set, setting) {
            if (typeof setting === "undefined") { setting = true; }
            return (setting ? ((value) |= (set)) : ((value) &= ~(set)));
        };
        bf.clearAll = /** @inline */function (value, set) {
            return ((value) &= ~(set));
        };
        bf.equal = function (value, src) {
            value = src;
        };
        bf.isEqual = /** @inline */function (value, src) {
            return value == src;
        };
        bf.isNotEqaul = /** @inline */function (value, src) {
            return value != src;
        };
        bf.set = function (value, src) {
            value = src;
        };
        bf.clear = function (value) {
            value = 0;
        };
        bf.setFlags = /** @inline */function (value, src) {
            return (value |= src);
        };
        bf.clearFlags = /** @inline */function (value, src) {
            return value &= ~src;
        };
        bf.isEmpty = /** @inline */function (value) {
            return (value == 0);
        };
        bf.totalBits = /** @inline */function (value) {
            return 32;
        };
        bf.totalSet = function (value) {
            var count = 0;
            var total = (32);
            for(var i = total; i; --i) {
                count += (value & 1);
                value >>= 1;
            }
            return (count);
        };
        function fixedToFixed(value, n, p) {
            if (n > p) {
                value >>= n - p;
            } else if (n < p) {
                if (value == 0) {
                    value = 0;
                } else if (value == ((1) << n) - 1) {
                    value = (1 << p) - 1;
                } else {
                    value = value * (1 << p) / ((1 << n) - 1);
                }
            }
            return value;
        }
        bf.fixedToFixed = fixedToFixed;
        function floatToFixed(value, bits) {
            if (value <= 0.0) {
                return 0;
            } else if (value >= 1.0) {
                return (1 << bits) - 1;
            } else {
                return (value * (1 << bits));
            }
        }
        bf.floatToFixed = floatToFixed;
        function fixedToFloat(value, bits) {
            return (value & ((1 << bits) - 1)) / ((1 << bits) - 1);
        }
        bf.fixedToFloat = fixedToFloat;
        function intWrite(pDest, n, value) {
            switch(n) {
                case 1:
                    pDest[0] = value;
                    break;
                case 2:
                    pDest[1] = ((value >> 8) & 0xFF);
                    pDest[0] = (value & 0xFF);
                    break;
                case 3:
                    pDest[2] = ((value >> 16) & 0xFF);
                    pDest[1] = ((value >> 8) & 0xFF);
                    pDest[0] = (value & 0xFF);
                    break;
                case 4:
                    pDest[3] = ((value >> 24) & 0xFF);
                    pDest[2] = ((value >> 16) & 0xFF);
                    pDest[1] = ((value >> 8) & 0xFF);
                    pDest[0] = (value & 0xFF);
                    break;
            }
        }
        bf.intWrite = intWrite;
        function intRead(pSrc, n) {
            switch(n) {
                case 1:
                    return pSrc[0];
                case 2:
                    return pSrc[0] | pSrc[1] << 8;
                case 3:
                    return pSrc[0] | pSrc[1] << 8 | pSrc[2] << 16;
                case 4:
                    return (pSrc[0]) | (pSrc[1] << 8) | (pSrc[2] << 16) | (pSrc[3] << 24);
            }
            return 0;
        }
        bf.intRead = intRead;
                var _u32 = new Uint32Array(1);
        var _f32 = new Float32Array(_u32.buffer);
        function floatToHalf(f) {
            _f32[0] = f;
            return floatToHalfI(_u32[0]);
        }
        bf.floatToHalf = floatToHalf;
        function floatToHalfI(i) {
            var s = (i >> 16) & 0x00008000;
            var e = ((i >> 23) & 0x000000ff) - (127 - 15);
            var m = i & 0x007fffff;
            if (e <= 0) {
                if (e < -10) {
                    return 0;
                }
                m = (m | 0x00800000) >> (1 - e);
                return (s | (m >> 13));
            } else if (e == 0xff - (127 - 15)) {
                if (m == 0) {
                    return (s | 0x7c00);
                } else {
                    m >>= 13;
                    return (s | 0x7c00 | m | (m == 0));
                }
            } else {
                if (e > 30) {
                    return (s | 0x7c00);
                }
                return (s | (e << 10) | (m >> 13));
            }
        }
        bf.floatToHalfI = floatToHalfI;
        function halfToFloat(y) {
            _u32[0] = halfToFloatI(y);
            return _f32[0];
        }
        bf.halfToFloat = halfToFloat;
        function halfToFloatI(y) {
            var s = (y >> 15) & 0x00000001;
            var e = (y >> 10) & 0x0000001f;
            var m = y & 0x000003ff;
            if (e == 0) {
                if (m == 0) {
                    return s << 31;
                } else {
                    while(!(m & 0x00000400)) {
                        m <<= 1;
                        e -= 1;
                    }
                    e += 1;
                    m &= ~0x00000400;
                }
            } else if (e == 31) {
                if (m == 0) {
                    return (s << 31) | 0x7f800000;
                } else {
                    return (s << 31) | 0x7f800000 | (m << 13);
                }
            }
            e = e + (127 - 15);
            m = m << 13;
            return (s << 31) | (e << 23) | m;
        }
        bf.halfToFloatI = halfToFloatI;
    })(akra.bf || (akra.bf = {}));
    var bf = akra.bf;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        var Logger = (function () {
            function Logger() {
                this._eUnknownCode = 0;
                this._sUnknownMessage = "Unknown code";
                this._eLogLevel = akra.ELogLevel.ALL;
                this._pGeneralRoutineMap = {};
                this._pCurrentSourceLocation = {
                    file: "",
                    line: 0
                };
                this._pLastLogEntity = {
                    code: this._eUnknownCode,
                    location: this._pCurrentSourceLocation,
                    message: this._sUnknownMessage,
                    info: null
                };
                this._pCodeFamilyMap = {};
                this._pCodeFamilyList = [];
                this._pCodeInfoMap = {};
                this._pCodeFamilyRoutineDMap = {};
                this._nFamilyGenerator = 0;
            }
            Logger._sDefaultFamilyName = "CodeFamily";
            Logger.prototype.init = function () {
                return true;
            };
            Logger.prototype.setLogLevel = function (eLevel) {
                this._eLogLevel = eLevel;
            };
            Logger.prototype.getLogLevel = function () {
                return this._eLogLevel;
            };
            Logger.prototype.registerCode = function (eCode, sMessage) {
                if (typeof sMessage === "undefined") { sMessage = this._sUnknownMessage; }
                if (this.isUsedCode(eCode)) {
                    return false;
                }
                var sFamilyName = this.getFamilyName(eCode);
                if (((sFamilyName) === null)) {
                    return false;
                }
                var pCodeInfo = {
                    code: eCode,
                    message: sMessage,
                    familyName: sFamilyName
                };
                this._pCodeInfoMap[eCode] = pCodeInfo;
                return true;
            };
            Logger.prototype.setUnknownCode = function (eCode, sMessage) {
                this._eUnknownCode = eCode;
                this._sUnknownMessage = sMessage;
            };
            Logger.prototype.registerCodeFamily = function (eCodeMin, eCodeMax, sFamilyName) {
                if (!((sFamilyName) !== undefined)) {
                    sFamilyName = this.generateFamilyName();
                }
                if (this.isUsedFamilyName(sFamilyName)) {
                    return false;
                }
                if (!this.isValidCodeInterval(eCodeMin, eCodeMax)) {
                    return false;
                }
                var pCodeFamily = {
                    familyName: sFamilyName,
                    codeMin: eCodeMin,
                    codeMax: eCodeMax
                };
                this._pCodeFamilyMap[sFamilyName] = pCodeFamily;
                this._pCodeFamilyList.push(pCodeFamily);
                return true;
            };
            Logger.prototype.getFamilyName = function (eCode) {
                var i = 0;
                var pCodeFamilyList = this._pCodeFamilyList;
                var pCodeFamily;
                for(i = 0; i < pCodeFamilyList.length; i++) {
                    pCodeFamily = pCodeFamilyList[i];
                    if (pCodeFamily.codeMin <= eCode && pCodeFamily.codeMax >= eCode) {
                        return pCodeFamily.familyName;
                    }
                }
                return null;
            };
            Logger.prototype.setCodeFamilyRoutine = function () {
                var sFamilyName = null;
                var fnLogRoutine = null;
                var eLevel = akra.ELogLevel.LOG;
                if ((typeof (arguments[0]) === "number")) {
                    sFamilyName = this.getFamilyName(arguments[0]);
                    fnLogRoutine = arguments[1];
                    eLevel = arguments[2];
                    if (((sFamilyName) === null)) {
                        return false;
                    }
                } else if ((typeof (arguments[0]) === "string")) {
                    sFamilyName = arguments[0];
                    fnLogRoutine = arguments[1];
                    eLevel = arguments[2];
                }
                if (!this.isUsedFamilyName(sFamilyName)) {
                    return false;
                }
                var pCodeFamilyRoutineMap = this._pCodeFamilyRoutineDMap[sFamilyName];
                if (!((pCodeFamilyRoutineMap) !== undefined)) {
                    pCodeFamilyRoutineMap = this._pCodeFamilyRoutineDMap[sFamilyName] = {};
                }
                if (((((eLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.LOG)) == (/*checked (origin: akra)>>*/akra.ELogLevel.LOG)))) {
                    pCodeFamilyRoutineMap[akra.ELogLevel.LOG] = fnLogRoutine;
                }
                if (((((eLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.INFORMATION)) == (/*checked (origin: akra)>>*/akra.ELogLevel.INFORMATION)))) {
                    pCodeFamilyRoutineMap[akra.ELogLevel.INFORMATION] = fnLogRoutine;
                }
                if (((((eLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.WARNING)) == (/*checked (origin: akra)>>*/akra.ELogLevel.WARNING)))) {
                    pCodeFamilyRoutineMap[akra.ELogLevel.WARNING] = fnLogRoutine;
                }
                if (((((eLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.ERROR)) == (/*checked (origin: akra)>>*/akra.ELogLevel.ERROR)))) {
                    pCodeFamilyRoutineMap[akra.ELogLevel.ERROR] = fnLogRoutine;
                }
                if (((((eLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.CRITICAL)) == (/*checked (origin: akra)>>*/akra.ELogLevel.CRITICAL)))) {
                    pCodeFamilyRoutineMap[akra.ELogLevel.CRITICAL] = fnLogRoutine;
                }
                return true;
            };
            Logger.prototype.setLogRoutine = function (fnLogRoutine, eLevel) {
                if (((((eLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.LOG)) == (/*checked (origin: akra)>>*/akra.ELogLevel.LOG)))) {
                    this._pGeneralRoutineMap[akra.ELogLevel.LOG] = fnLogRoutine;
                }
                if (((((eLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.INFORMATION)) == (/*checked (origin: akra)>>*/akra.ELogLevel.INFORMATION)))) {
                    this._pGeneralRoutineMap[akra.ELogLevel.INFORMATION] = fnLogRoutine;
                }
                if (((((eLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.WARNING)) == (/*checked (origin: akra)>>*/akra.ELogLevel.WARNING)))) {
                    this._pGeneralRoutineMap[akra.ELogLevel.WARNING] = fnLogRoutine;
                }
                if (((((eLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.ERROR)) == (/*checked (origin: akra)>>*/akra.ELogLevel.ERROR)))) {
                    this._pGeneralRoutineMap[akra.ELogLevel.ERROR] = fnLogRoutine;
                }
                if (((((eLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.CRITICAL)) == (/*checked (origin: akra)>>*/akra.ELogLevel.CRITICAL)))) {
                    this._pGeneralRoutineMap[akra.ELogLevel.CRITICAL] = fnLogRoutine;
                }
            };
            Logger.prototype.setSourceLocation = function () {
                var sFile;
                var iLine;
                if (arguments.length === 2) {
                    sFile = arguments[0];
                    iLine = arguments[1];
                } else {
                    if (((arguments[0]) !== undefined) && !(((arguments[0]) === null))) {
                        sFile = arguments[0].file;
                        iLine = arguments[0].line;
                    } else {
                        sFile = "";
                        iLine = 0;
                    }
                }
                this._pCurrentSourceLocation.file = sFile;
                this._pCurrentSourceLocation.line = iLine;
            };
            Logger.prototype.log = function () {
                var pArgs = [];
                for (var _i = 0; _i < (arguments.length - 0); _i++) {
                    pArgs[_i] = arguments[_i + 0];
                }
                if (!((((this._eLogLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.LOG)) == (/*checked (origin: akra)>>*/akra.ELogLevel.LOG)))) {
                    return;
                }
                var fnLogRoutine = this._pGeneralRoutineMap[akra.ELogLevel.LOG];
                if (!((fnLogRoutine) !== undefined)) {
                    return;
                }
                var pLogEntity = this._pLastLogEntity;
                pLogEntity.code = this._eUnknownCode;
                pLogEntity.location = this._pCurrentSourceLocation;
                pLogEntity.info = pArgs;
                pLogEntity.message = this._sUnknownMessage;
                fnLogRoutine.call(null, pLogEntity);
            };
            Logger.prototype.info = function () {
                if (!((((this._eLogLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.INFORMATION)) == (/*checked (origin: akra)>>*/akra.ELogLevel.INFORMATION)))) {
                    return;
                }
                var pLogEntity;
                var fnLogRoutine;
                pLogEntity = this.prepareLogEntity.apply(this, arguments);
                fnLogRoutine = this.getCodeRoutineFunc(pLogEntity.code, akra.ELogLevel.INFORMATION);
                if (((fnLogRoutine) === null)) {
                    return;
                }
                fnLogRoutine.call(null, pLogEntity);
            };
            Logger.prototype.warning = function () {
                if (!((((this._eLogLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.WARNING)) == (/*checked (origin: akra)>>*/akra.ELogLevel.WARNING)))) {
                    return;
                }
                var pLogEntity;
                var fnLogRoutine;
                pLogEntity = this.prepareLogEntity.apply(this, arguments);
                fnLogRoutine = this.getCodeRoutineFunc(pLogEntity.code, akra.ELogLevel.WARNING);
                if (((fnLogRoutine) === null)) {
                    return;
                }
                fnLogRoutine.call(null, pLogEntity);
            };
            Logger.prototype.error = function () {
                if (!((((this._eLogLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.ERROR)) == (/*checked (origin: akra)>>*/akra.ELogLevel.ERROR)))) {
                    return;
                }
                var pLogEntity;
                var fnLogRoutine;
                pLogEntity = this.prepareLogEntity.apply(this, arguments);
                fnLogRoutine = this.getCodeRoutineFunc(pLogEntity.code, akra.ELogLevel.ERROR);
                if (((fnLogRoutine) === null)) {
                    return;
                }
                fnLogRoutine.call(null, pLogEntity);
            };
            Logger.prototype.criticalError = function () {
                var pLogEntity;
                var fnLogRoutine;
                pLogEntity = this.prepareLogEntity.apply(this, arguments);
                fnLogRoutine = this.getCodeRoutineFunc(pLogEntity.code, akra.ELogLevel.CRITICAL);
                var sSystemMessage = "A Critical error has occured! Code: " + pLogEntity.code.toString();
                if (((((this._eLogLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.CRITICAL)) == (/*checked (origin: akra)>>*/akra.ELogLevel.CRITICAL))) && !((fnLogRoutine) === null)) {
                    fnLogRoutine.call(null, pLogEntity);
                }
                alert(sSystemMessage);
                throw new Error(sSystemMessage);
            };
            Logger.prototype.assert = function () {
                var bCondition = arguments[0];
                if (!bCondition) {
                    var pLogEntity;
                    var fnLogRoutine;
                    var pArgs = [];
                    for(var i = 1; i < arguments.length; i++) {
                        pArgs[i - 1] = arguments[i];
                    }
                    pLogEntity = this.prepareLogEntity.apply(this, pArgs);
                    fnLogRoutine = this.getCodeRoutineFunc(pLogEntity.code, akra.ELogLevel.CRITICAL);
                    var sSystemMessage = "A error has occured! Code: " + pLogEntity.code.toString() + "\n Accept to exit, refuse to continue.";
                    if (((((this._eLogLevel) & (/*checked (origin: akra)>>*/akra.ELogLevel.CRITICAL)) == (/*checked (origin: akra)>>*/akra.ELogLevel.CRITICAL))) && !((fnLogRoutine) === null)) {
                        fnLogRoutine.call(null, pLogEntity);
                    }
                    if (confirm(sSystemMessage)) {
                        throw new Error(sSystemMessage);
                    }
                }
            };
            Logger.prototype.generateFamilyName = function () {
                var sSuffix = (this._nFamilyGenerator++);
                var sName = Logger._sDefaultFamilyName + sSuffix;
                if (this.isUsedFamilyName(sName)) {
                    return this.generateFamilyName();
                } else {
                    return sName;
                }
            };
            Logger.prototype.isValidCodeInterval = function (eCodeMin, eCodeMax) {
                if (eCodeMin > eCodeMax) {
                    return false;
                }
                var i = 0;
                var pCodeFamilyList = this._pCodeFamilyList;
                var pCodeFamily;
                for(i = 0; i < pCodeFamilyList.length; i++) {
                    pCodeFamily = pCodeFamilyList[i];
                    if ((pCodeFamily.codeMin <= eCodeMin && pCodeFamily.codeMax >= eCodeMin) || (pCodeFamily.codeMin <= eCodeMax && pCodeFamily.codeMax >= eCodeMax)) {
                        return false;
                    }
                }
                return true;
            };
            Logger.prototype.isUsedFamilyName = function (sFamilyName) {
                return ((this._pCodeFamilyMap[sFamilyName]) !== undefined);
            };
            Logger.prototype.isUsedCode = function (eCode) {
                return ((this._pCodeInfoMap[eCode]) !== undefined);
            };
            Logger.prototype.isLogEntity = function (pObj) {
                if (akra.isObject(pObj) && ((pObj.code) !== undefined) && ((pObj.location) !== undefined)) {
                    return true;
                }
                return false;
            };
            Logger.prototype.isLogCode = function (eCode) {
                return (typeof (eCode) === "number");
            };
            Logger.prototype.prepareLogEntity = function () {
                var eCode = this._eUnknownCode;
                var sMessage = this._sUnknownMessage;
                var pInfo = null;
                if (arguments.length === 1 && this.isLogEntity(arguments[0])) {
                    var pEntity = arguments[0];
                    eCode = pEntity.code;
                    pInfo = pEntity.info;
                    this.setSourceLocation(pEntity.location);
                    if (!((pEntity.message) !== undefined)) {
                        var pCodeInfo = this._pCodeInfoMap[eCode];
                        if (((pCodeInfo) !== undefined)) {
                            sMessage = pCodeInfo.message;
                        }
                    }
                } else {
                    if (this.isLogCode(arguments[0])) {
                        eCode = arguments[0];
                        if (arguments.length > 1) {
                            pInfo = new Array(arguments.length - 1);
                            var i = 0;
                            for(i = 0; i < pInfo.length; i++) {
                                pInfo[i] = arguments[i + 1];
                            }
                        }
                    } else {
                        eCode = this._eUnknownCode;
                        pInfo = new Array(arguments.length);
                        var i = 0;
                        for(i = 0; i < pInfo.length; i++) {
                            pInfo[i] = arguments[i];
                        }
                    }
                    var pCodeInfo = this._pCodeInfoMap[eCode];
                    if (((pCodeInfo) !== undefined)) {
                        sMessage = pCodeInfo.message;
                    }
                }
                var pLogEntity = this._pLastLogEntity;
                pLogEntity.code = eCode;
                pLogEntity.location = this._pCurrentSourceLocation;
                pLogEntity.message = sMessage;
                pLogEntity.info = pInfo;
                return pLogEntity;
            };
            Logger.prototype.getCodeRoutineFunc = function (eCode, eLevel) {
                var pCodeInfo = this._pCodeInfoMap[eCode];
                var fnLogRoutine;
                if (!((pCodeInfo) !== undefined)) {
                    fnLogRoutine = this._pGeneralRoutineMap[eLevel];
                    return ((fnLogRoutine) !== undefined) ? fnLogRoutine : null;
                }
                var pCodeFamilyRoutineMap = this._pCodeFamilyRoutineDMap[pCodeInfo.familyName];
                if (!((pCodeFamilyRoutineMap) !== undefined) || !((pCodeFamilyRoutineMap[eLevel]) !== undefined)) {
                    fnLogRoutine = this._pGeneralRoutineMap[eLevel];
                    return ((fnLogRoutine) !== undefined) ? fnLogRoutine : null;
                }
                fnLogRoutine = pCodeFamilyRoutineMap[eLevel];
                return fnLogRoutine;
            };
            return Logger;
        })();
        util.Logger = Logger;        
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        util.logger = new util.Logger();
        util.logger.init();
        util.logger.setUnknownCode(0, "Unknown code.");
        util.logger.setLogLevel(akra.ELogLevel.ALL);
        util.logger.registerCodeFamily(0, 100, "SystemCodes");
        util.logger.registerCodeFamily(2000, 2199, "ParserSyntaxErrors");
        util.logger.registerCodeFamily(2200, 2500, "EffectSyntaxErrors");
        function sourceLocationToString(pLocation) {
            var pDate = new Date();
            var sTime = pDate.getHours() + ":" + pDate.getMinutes() + "." + pDate.getSeconds();
            var sLocation = "[" + pLocation.file + ":" + pLocation.line.toString() + " " + sTime + "]: ";
            return sLocation;
        }
        function logRoutine(pLogEntity) {
            var pArgs = pLogEntity.info;
            pArgs.unshift(sourceLocationToString(pLogEntity.location));
            console["log"].apply(console, pArgs);
        }
        function warningRoutine(pLogEntity) {
            var pArgs = pLogEntity.info;
            pArgs.unshift("Code: " + pLogEntity.code.toString());
            pArgs.unshift(sourceLocationToString(pLogEntity.location));
            console["warn"].apply(console, pArgs);
        }
        function errorRoutine(pLogEntity) {
            var pArgs = pLogEntity.info;
            pArgs.unshift(pLogEntity.message);
            pArgs.unshift("Error code: " + pLogEntity.code.toString() + ".");
            pArgs.unshift(sourceLocationToString(pLogEntity.location));
            console["error"].apply(console, pArgs);
        }
        util.logger.setLogRoutine(logRoutine, akra.ELogLevel.LOG | akra.ELogLevel.INFORMATION);
        util.logger.setLogRoutine(warningRoutine, akra.ELogLevel.WARNING);
        util.logger.setLogRoutine(errorRoutine, akra.ELogLevel.ERROR | akra.ELogLevel.CRITICAL);
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    akra.logger = akra.util.logger;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    akra.createEngine;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    (function (EEventTypes) {
        EEventTypes._map = [];
        EEventTypes._map[0] = "BROADCAST";
        EEventTypes.BROADCAST = 0;
        EEventTypes._map[1] = "UNICAST";
        EEventTypes.UNICAST = 1;
    })(akra.EEventTypes || (akra.EEventTypes = {}));
    var EEventTypes = akra.EEventTypes;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ESceneTypes) {
        ESceneTypes._map = [];
        ESceneTypes._map[0] = "TYPE_3D";
        ESceneTypes.TYPE_3D = 0;
        ESceneTypes._map[1] = "TYPE_2D";
        ESceneTypes.TYPE_2D = 1;
    })(akra.ESceneTypes || (akra.ESceneTypes = {}));
    var ESceneTypes = akra.ESceneTypes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    (function (EResourceFamilies) {
        EResourceFamilies._map = [];
        EResourceFamilies.VIDEO_RESOURCE = 0;
        EResourceFamilies._map[1] = "AUDIO_RESOURCE";
        EResourceFamilies.AUDIO_RESOURCE = 1;
        EResourceFamilies._map[2] = "GAME_RESOURCE";
        EResourceFamilies.GAME_RESOURCE = 2;
        EResourceFamilies._map[3] = "TOTAL_RESOURCE_FAMILIES";
        EResourceFamilies.TOTAL_RESOURCE_FAMILIES = 3;
    })(akra.EResourceFamilies || (akra.EResourceFamilies = {}));
    var EResourceFamilies = akra.EResourceFamilies;
    ;
    (function (EVideoResources) {
        EVideoResources._map = [];
        EVideoResources._map[0] = "TEXTURE_RESOURCE";
        EVideoResources.TEXTURE_RESOURCE = 0;
        EVideoResources._map[1] = "VIDEOBUFFER_RESOURCE";
        EVideoResources.VIDEOBUFFER_RESOURCE = 1;
        EVideoResources._map[2] = "VERTEXBUFFER_RESOURCE";
        EVideoResources.VERTEXBUFFER_RESOURCE = 2;
        EVideoResources._map[3] = "INDEXBUFFER_RESOURCE";
        EVideoResources.INDEXBUFFER_RESOURCE = 3;
        EVideoResources._map[4] = "EFFECT_RESOURCE";
        EVideoResources.EFFECT_RESOURCE = 4;
        EVideoResources._map[5] = "RENDERMETHOD_RESOURCE";
        EVideoResources.RENDERMETHOD_RESOURCE = 5;
        EVideoResources._map[6] = "MODEL_RESOURCE";
        EVideoResources.MODEL_RESOURCE = 6;
        EVideoResources._map[7] = "EFFECTFILEDATA_RESOURCE";
        EVideoResources.EFFECTFILEDATA_RESOURCE = 7;
        EVideoResources._map[8] = "IMAGE_RESOURCE";
        EVideoResources.IMAGE_RESOURCE = 8;
        EVideoResources._map[9] = "SURFACEMATERIAL_RESOURCE";
        EVideoResources.SURFACEMATERIAL_RESOURCE = 9;
        EVideoResources._map[10] = "SHADERPROGRAM_RESOURCE";
        EVideoResources.SHADERPROGRAM_RESOURCE = 10;
        EVideoResources._map[11] = "COMPONENT_RESOURCE";
        EVideoResources.COMPONENT_RESOURCE = 11;
        EVideoResources._map[12] = "EFFECTDATA_RESOURCE";
        EVideoResources.EFFECTDATA_RESOURCE = 12;
        EVideoResources._map[13] = "TOTAL_VIDEO_RESOURCES";
        EVideoResources.TOTAL_VIDEO_RESOURCES = 13;
    })(akra.EVideoResources || (akra.EVideoResources = {}));
    var EVideoResources = akra.EVideoResources;
    ;
    (function (EAudioResources) {
        EAudioResources._map = [];
        EAudioResources._map[0] = "TOTAL_AUDIO_RESOURCES";
        EAudioResources.TOTAL_AUDIO_RESOURCES = 0;
    })(akra.EAudioResources || (akra.EAudioResources = {}));
    var EAudioResources = akra.EAudioResources;
    ;
    (function (EGameResources) {
        EGameResources._map = [];
        EGameResources._map[0] = "TOTAL_GAME_RESOURCES";
        EGameResources.TOTAL_GAME_RESOURCES = 0;
    })(akra.EGameResources || (akra.EGameResources = {}));
    var EGameResources = akra.EGameResources;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ECompareFunction) {
        ECompareFunction._map = [];
        ECompareFunction._map[0] = "ALWAYS_FAIL";
        ECompareFunction.ALWAYS_FAIL = 0;
        ECompareFunction._map[1] = "ALWAYS_PASS";
        ECompareFunction.ALWAYS_PASS = 1;
        ECompareFunction._map[2] = "LESS";
        ECompareFunction.LESS = 2;
        ECompareFunction._map[3] = "LESS_EQUAL";
        ECompareFunction.LESS_EQUAL = 3;
        ECompareFunction._map[4] = "EQUAL";
        ECompareFunction.EQUAL = 4;
        ECompareFunction._map[5] = "NOT_EQUAL";
        ECompareFunction.NOT_EQUAL = 5;
        ECompareFunction._map[6] = "GREATER_EQUAL";
        ECompareFunction.GREATER_EQUAL = 6;
        ECompareFunction._map[7] = "GREATER";
        ECompareFunction.GREATER = 7;
    })(akra.ECompareFunction || (akra.ECompareFunction = {}));
    var ECompareFunction = akra.ECompareFunction;
    (function (ECullingMode) {
        ECullingMode._map = [];
        ECullingMode.NONE = 1;
        ECullingMode.CLOCKWISE = 2;
        ECullingMode.ANTICLOCKWISE = 3;
    })(akra.ECullingMode || (akra.ECullingMode = {}));
    var ECullingMode = akra.ECullingMode;
    (function (EFrameBufferTypes) {
        EFrameBufferTypes._map = [];
        EFrameBufferTypes.COLOR = 0x1;
        EFrameBufferTypes.DEPTH = 0x2;
        EFrameBufferTypes.STENCIL = 0x4;
    })(akra.EFrameBufferTypes || (akra.EFrameBufferTypes = {}));
    var EFrameBufferTypes = akra.EFrameBufferTypes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    (function (EPrimitiveTypes) {
        EPrimitiveTypes._map = [];
        EPrimitiveTypes.POINTLIST = 0;
        EPrimitiveTypes._map[1] = "LINELIST";
        EPrimitiveTypes.LINELIST = 1;
        EPrimitiveTypes._map[2] = "LINELOOP";
        EPrimitiveTypes.LINELOOP = 2;
        EPrimitiveTypes._map[3] = "LINESTRIP";
        EPrimitiveTypes.LINESTRIP = 3;
        EPrimitiveTypes._map[4] = "TRIANGLELIST";
        EPrimitiveTypes.TRIANGLELIST = 4;
        EPrimitiveTypes._map[5] = "TRIANGLESTRIP";
        EPrimitiveTypes.TRIANGLESTRIP = 5;
        EPrimitiveTypes._map[6] = "TRIANGLEFAN";
        EPrimitiveTypes.TRIANGLEFAN = 6;
    })(akra.EPrimitiveTypes || (akra.EPrimitiveTypes = {}));
    var EPrimitiveTypes = akra.EPrimitiveTypes;
    ;
    (function (ERenderCapabilitiesCategory) {
        ERenderCapabilitiesCategory._map = [];
        ERenderCapabilitiesCategory.C_COMMON = 0;
        ERenderCapabilitiesCategory.C_COMMON_2 = 1;
        ERenderCapabilitiesCategory.C_WEBGL = 2;
        ERenderCapabilitiesCategory.COUNT = 3;
    })(akra.ERenderCapabilitiesCategory || (akra.ERenderCapabilitiesCategory = {}));
    var ERenderCapabilitiesCategory = akra.ERenderCapabilitiesCategory;
    (function (ERenderCapabilities) {
        ERenderCapabilities._map = [];
        ERenderCapabilities.AUTOMIPMAP = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 0));
        ERenderCapabilities.BLENDING = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 1));
        ERenderCapabilities.ANISOTROPY = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 2));
        ERenderCapabilities.DOT3 = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 3));
        ERenderCapabilities.CUBEMAPPING = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 4));
        ERenderCapabilities.HWSTENCIL = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 5));
        ERenderCapabilities.VBO = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 7));
        ERenderCapabilities.VERTEX_PROGRAM = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 9));
        ERenderCapabilities.FRAGMENT_PROGRAM = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 10));
        ERenderCapabilities.SCISSOR_TEST = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 11));
        ERenderCapabilities.TWO_SIDED_STENCIL = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 12));
        ERenderCapabilities.STENCIL_WRAP = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 13));
        ERenderCapabilities.HWOCCLUSION = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 14));
        ERenderCapabilities.USER_CLIP_PLANES = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 15));
        ERenderCapabilities.VERTEX_FORMAT_UBYTE4 = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 16));
        ERenderCapabilities.INFINITE_FAR_PLANE = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 17));
        ERenderCapabilities.HWRENDER_TO_TEXTURE = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 18));
        ERenderCapabilities.TEXTURE_FLOAT = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 19));
        ERenderCapabilities.NON_POWER_OF_2_TEXTURES = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 20));
        ERenderCapabilities.TEXTURE_3D = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 21));
        ERenderCapabilities.POINT_SPRITES = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 22));
        ERenderCapabilities.POINT_EXTENDED_PARAMETERS = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 23));
        ERenderCapabilities.VERTEX_TEXTURE_FETCH = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 24));
        ERenderCapabilities.MIPMAP_LOD_BIAS = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 25));
        ERenderCapabilities.GEOMETRY_PROGRAM = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 26));
        ERenderCapabilities.HWRENDER_TO_VERTEX_BUFFER = ((ERenderCapabilitiesCategory.C_COMMON << (32 - 4)) | (1 << 27));
        ERenderCapabilities.TEXTURE_COMPRESSION = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 0));
        ERenderCapabilities.TEXTURE_COMPRESSION_DXT = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 1));
        ERenderCapabilities.TEXTURE_COMPRESSION_VTC = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 2));
        ERenderCapabilities.TEXTURE_COMPRESSION_PVRTC = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 3));
        ERenderCapabilities.FIXED_FUNCTION = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 4));
        ERenderCapabilities.MRT_DIFFERENT_BIT_DEPTHS = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 5));
        ERenderCapabilities.ALPHA_TO_COVERAGE = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 6));
        ERenderCapabilities.ADVANCED_BLEND_OPERATIONS = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 7));
        ERenderCapabilities.RTT_SEPARATE_DEPTHBUFFER = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 8));
        ERenderCapabilities.RTT_MAIN_DEPTHBUFFER_ATTACHABLE = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 9));
        ERenderCapabilities.RTT_DEPTHBUFFER_RESOLUTION_LESSEQUAL = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 10));
        ERenderCapabilities.VERTEX_BUFFER_INSTANCE_DATA = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 11));
        ERenderCapabilities.CAN_GET_COMPILED_SHADER_BUFFER = ((ERenderCapabilitiesCategory.C_COMMON_2 << (32 - 4)) | (1 << 12));
        ERenderCapabilities.GL1_5_NOVBO = ((ERenderCapabilitiesCategory.C_WEBGL << (32 - 4)) | (1 << 1));
        ERenderCapabilities.FBO = ((ERenderCapabilitiesCategory.C_WEBGL << (32 - 4)) | (1 << 2));
        ERenderCapabilities.FBO_ARB = ((ERenderCapabilitiesCategory.C_WEBGL << (32 - 4)) | (1 << 3));
        ERenderCapabilities.FBO_ATI = ((ERenderCapabilitiesCategory.C_WEBGL << (32 - 4)) | (1 << 4));
        ERenderCapabilities.PBUFFER = ((ERenderCapabilitiesCategory.C_WEBGL << (32 - 4)) | (1 << 5));
        ERenderCapabilities.GL1_5_NOHWOCCLUSION = ((ERenderCapabilitiesCategory.C_WEBGL << (32 - 4)) | (1 << 6));
        ERenderCapabilities.POINT_EXTENDED_PARAMETERS_ARB = ((ERenderCapabilitiesCategory.C_WEBGL << (32 - 4)) | (1 << 7));
        ERenderCapabilities.POINT_EXTENDED_PARAMETERS_EXT = ((ERenderCapabilitiesCategory.C_WEBGL << (32 - 4)) | (1 << 8));
        ERenderCapabilities.SEPARATE_SHADER_OBJECTS = ((ERenderCapabilitiesCategory.C_WEBGL << (32 - 4)) | (1 << 9));
    })(akra.ERenderCapabilities || (akra.ERenderCapabilities = {}));
    var ERenderCapabilities = akra.ERenderCapabilities;
    (function (EAttachmentTypes) {
        EAttachmentTypes._map = [];
        EAttachmentTypes.COLOR_ATTACHMENT0 = 0x8CE0;
        EAttachmentTypes.DEPTH_ATTACHMENT = 0x8D00;
        EAttachmentTypes.STENCIL_ATTACHMENT = 0x8D20;
        EAttachmentTypes.DEPTH_STENCIL_ATTACHMENT = 0x821A;
    })(akra.EAttachmentTypes || (akra.EAttachmentTypes = {}));
    var EAttachmentTypes = akra.EAttachmentTypes;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EUtilTimerCommands) {
        EUtilTimerCommands._map = [];
        EUtilTimerCommands._map[0] = "TIMER_RESET";
        EUtilTimerCommands.TIMER_RESET = 0;
        EUtilTimerCommands._map[1] = "TIMER_START";
        EUtilTimerCommands.TIMER_START = 1;
        EUtilTimerCommands._map[2] = "TIMER_STOP";
        EUtilTimerCommands.TIMER_STOP = 2;
        EUtilTimerCommands._map[3] = "TIMER_ADVANCE";
        EUtilTimerCommands.TIMER_ADVANCE = 3;
        EUtilTimerCommands._map[4] = "TIMER_GET_ABSOLUTE_TIME";
        EUtilTimerCommands.TIMER_GET_ABSOLUTE_TIME = 4;
        EUtilTimerCommands._map[5] = "TIMER_GET_APP_TIME";
        EUtilTimerCommands.TIMER_GET_APP_TIME = 5;
        EUtilTimerCommands._map[6] = "TIMER_GET_ELAPSED_TIME";
        EUtilTimerCommands.TIMER_GET_ELAPSED_TIME = 6;
    })(akra.EUtilTimerCommands || (akra.EUtilTimerCommands = {}));
    var EUtilTimerCommands = akra.EUtilTimerCommands;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    (function (ELightTypes) {
        ELightTypes._map = [];
        ELightTypes._map[0] = "UNKNOWN";
        ELightTypes.UNKNOWN = 0;
        ELightTypes._map[1] = "PROJECT";
        ELightTypes.PROJECT = 1;
        ELightTypes._map[2] = "OMNI";
        ELightTypes.OMNI = 2;
    })(akra.ELightTypes || (akra.ELightTypes = {}));
    var ELightTypes = akra.ELightTypes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ENodeCreateMode) {
        ENodeCreateMode._map = [];
        ENodeCreateMode._map[0] = "k_Default";
        ENodeCreateMode.k_Default = 0;
        ENodeCreateMode._map[1] = "k_Necessary";
        ENodeCreateMode.k_Necessary = 1;
        ENodeCreateMode._map[2] = "k_Not";
        ENodeCreateMode.k_Not = 2;
    })(akra.ENodeCreateMode || (akra.ENodeCreateMode = {}));
    var ENodeCreateMode = akra.ENodeCreateMode;
    (function (EParserCode) {
        EParserCode._map = [];
        EParserCode._map[0] = "k_Pause";
        EParserCode.k_Pause = 0;
        EParserCode._map[1] = "k_Ok";
        EParserCode.k_Ok = 1;
        EParserCode._map[2] = "k_Error";
        EParserCode.k_Error = 2;
    })(akra.EParserCode || (akra.EParserCode = {}));
    var EParserCode = akra.EParserCode;
    (function (EParserType) {
        EParserType._map = [];
        EParserType._map[0] = "k_LR0";
        EParserType.k_LR0 = 0;
        EParserType._map[1] = "k_LR1";
        EParserType.k_LR1 = 1;
        EParserType._map[2] = "k_LALR";
        EParserType.k_LALR = 2;
    })(akra.EParserType || (akra.EParserType = {}));
    var EParserType = akra.EParserType;
    (function (EParseMode) {
        EParseMode._map = [];
        EParseMode.k_AllNode = 0x0001;
        EParseMode.k_Negate = 0x0002;
        EParseMode.k_Add = 0x0004;
        EParseMode.k_Optimize = 0x0008;
        EParseMode.k_DebugMode = 0x0010;
    })(akra.EParseMode || (akra.EParseMode = {}));
    var EParseMode = akra.EParseMode;
    (function (ETokenType) {
        ETokenType._map = [];
        ETokenType.k_NumericLiteral = 1;
        ETokenType._map[2] = "k_CommentLiteral";
        ETokenType.k_CommentLiteral = 2;
        ETokenType._map[3] = "k_StringLiteral";
        ETokenType.k_StringLiteral = 3;
        ETokenType._map[4] = "k_PunctuatorLiteral";
        ETokenType.k_PunctuatorLiteral = 4;
        ETokenType._map[5] = "k_WhitespaceLiteral";
        ETokenType.k_WhitespaceLiteral = 5;
        ETokenType._map[6] = "k_IdentifierLiteral";
        ETokenType.k_IdentifierLiteral = 6;
        ETokenType._map[7] = "k_KeywordLiteral";
        ETokenType.k_KeywordLiteral = 7;
        ETokenType._map[8] = "k_Unknown";
        ETokenType.k_Unknown = 8;
        ETokenType._map[9] = "k_End";
        ETokenType.k_End = 9;
    })(akra.ETokenType || (akra.ETokenType = {}));
    var ETokenType = akra.ETokenType;
    (function (EOperationType) {
        EOperationType._map = [];
        EOperationType.k_Error = 100;
        EOperationType._map[101] = "k_Shift";
        EOperationType.k_Shift = 101;
        EOperationType._map[102] = "k_Reduce";
        EOperationType.k_Reduce = 102;
        EOperationType._map[103] = "k_Success";
        EOperationType.k_Success = 103;
        EOperationType._map[104] = "k_Pause";
        EOperationType.k_Pause = 104;
        EOperationType._map[105] = "k_Ok";
        EOperationType.k_Ok = 105;
    })(akra.EOperationType || (akra.EOperationType = {}));
    var EOperationType = akra.EOperationType;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    ;
    ;
    (function (EResourceItemEvents) {
        EResourceItemEvents._map = [];
        EResourceItemEvents._map[0] = "CREATED";
        EResourceItemEvents.CREATED = 0;
        EResourceItemEvents._map[1] = "LOADED";
        EResourceItemEvents.LOADED = 1;
        EResourceItemEvents._map[2] = "DISABLED";
        EResourceItemEvents.DISABLED = 2;
        EResourceItemEvents._map[3] = "ALTERED";
        EResourceItemEvents.ALTERED = 3;
        EResourceItemEvents._map[4] = "TOTALRESOURCEFLAGS";
        EResourceItemEvents.TOTALRESOURCEFLAGS = 4;
    })(akra.EResourceItemEvents || (akra.EResourceItemEvents = {}));
    var EResourceItemEvents = akra.EResourceItemEvents;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EAFXInstructionTypes) {
        EAFXInstructionTypes._map = [];
        EAFXInstructionTypes.k_Instruction = 0;
        EAFXInstructionTypes._map[1] = "k_InstructionCollector";
        EAFXInstructionTypes.k_InstructionCollector = 1;
        EAFXInstructionTypes._map[2] = "k_SimpleInstruction";
        EAFXInstructionTypes.k_SimpleInstruction = 2;
        EAFXInstructionTypes._map[3] = "k_VariableTypeInstruction";
        EAFXInstructionTypes.k_VariableTypeInstruction = 3;
        EAFXInstructionTypes._map[4] = "k_SystemTypeInstruction";
        EAFXInstructionTypes.k_SystemTypeInstruction = 4;
        EAFXInstructionTypes._map[5] = "k_ComplexTypeInstruction";
        EAFXInstructionTypes.k_ComplexTypeInstruction = 5;
        EAFXInstructionTypes._map[6] = "k_TypedInstruction";
        EAFXInstructionTypes.k_TypedInstruction = 6;
        EAFXInstructionTypes._map[7] = "k_DeclInstruction";
        EAFXInstructionTypes.k_DeclInstruction = 7;
        EAFXInstructionTypes._map[8] = "k_IntInstruction";
        EAFXInstructionTypes.k_IntInstruction = 8;
        EAFXInstructionTypes._map[9] = "k_FloatInstruction";
        EAFXInstructionTypes.k_FloatInstruction = 9;
        EAFXInstructionTypes._map[10] = "k_BoolInstruction";
        EAFXInstructionTypes.k_BoolInstruction = 10;
        EAFXInstructionTypes._map[11] = "k_StringInstruction";
        EAFXInstructionTypes.k_StringInstruction = 11;
        EAFXInstructionTypes._map[12] = "k_IdInstruction";
        EAFXInstructionTypes.k_IdInstruction = 12;
        EAFXInstructionTypes._map[13] = "k_KeywordInstruction";
        EAFXInstructionTypes.k_KeywordInstruction = 13;
        EAFXInstructionTypes._map[14] = "k_TypeDeclInstruction";
        EAFXInstructionTypes.k_TypeDeclInstruction = 14;
        EAFXInstructionTypes._map[15] = "k_VariableDeclInstruction";
        EAFXInstructionTypes.k_VariableDeclInstruction = 15;
        EAFXInstructionTypes._map[16] = "k_AnnotationInstruction";
        EAFXInstructionTypes.k_AnnotationInstruction = 16;
        EAFXInstructionTypes._map[17] = "k_UsageTypeInstruction";
        EAFXInstructionTypes.k_UsageTypeInstruction = 17;
        EAFXInstructionTypes._map[18] = "k_BaseTypeInstruction";
        EAFXInstructionTypes.k_BaseTypeInstruction = 18;
        EAFXInstructionTypes._map[19] = "k_StructDeclInstruction";
        EAFXInstructionTypes.k_StructDeclInstruction = 19;
        EAFXInstructionTypes._map[20] = "k_StructFieldsInstruction";
        EAFXInstructionTypes.k_StructFieldsInstruction = 20;
        EAFXInstructionTypes._map[21] = "k_ExprInstruction";
        EAFXInstructionTypes.k_ExprInstruction = 21;
        EAFXInstructionTypes._map[22] = "k_IdExprInstruction";
        EAFXInstructionTypes.k_IdExprInstruction = 22;
        EAFXInstructionTypes._map[23] = "k_ArithmeticExprInstruction";
        EAFXInstructionTypes.k_ArithmeticExprInstruction = 23;
        EAFXInstructionTypes._map[24] = "k_AssignmentExprInstruction";
        EAFXInstructionTypes.k_AssignmentExprInstruction = 24;
        EAFXInstructionTypes._map[25] = "k_RelationalExprInstruction";
        EAFXInstructionTypes.k_RelationalExprInstruction = 25;
        EAFXInstructionTypes._map[26] = "k_LogicalExprInstruction";
        EAFXInstructionTypes.k_LogicalExprInstruction = 26;
        EAFXInstructionTypes._map[27] = "k_ConditionalExprInstruction";
        EAFXInstructionTypes.k_ConditionalExprInstruction = 27;
        EAFXInstructionTypes._map[28] = "k_CastExprInstruction";
        EAFXInstructionTypes.k_CastExprInstruction = 28;
        EAFXInstructionTypes._map[29] = "k_UnaryExprInstruction";
        EAFXInstructionTypes.k_UnaryExprInstruction = 29;
        EAFXInstructionTypes._map[30] = "k_PostfixIndexInstruction";
        EAFXInstructionTypes.k_PostfixIndexInstruction = 30;
        EAFXInstructionTypes._map[31] = "k_PostfixPointInstruction";
        EAFXInstructionTypes.k_PostfixPointInstruction = 31;
        EAFXInstructionTypes._map[32] = "k_PostfixArithmeticInstruction";
        EAFXInstructionTypes.k_PostfixArithmeticInstruction = 32;
        EAFXInstructionTypes._map[33] = "k_PrimaryExprInstruction";
        EAFXInstructionTypes.k_PrimaryExprInstruction = 33;
        EAFXInstructionTypes._map[34] = "k_ComplexExprInstruction";
        EAFXInstructionTypes.k_ComplexExprInstruction = 34;
        EAFXInstructionTypes._map[35] = "k_FunctionCallInstruction";
        EAFXInstructionTypes.k_FunctionCallInstruction = 35;
        EAFXInstructionTypes._map[36] = "k_SystemCallInstruction";
        EAFXInstructionTypes.k_SystemCallInstruction = 36;
        EAFXInstructionTypes._map[37] = "k_ConstructorCallInstruction";
        EAFXInstructionTypes.k_ConstructorCallInstruction = 37;
        EAFXInstructionTypes._map[38] = "k_CompileExprInstruction";
        EAFXInstructionTypes.k_CompileExprInstruction = 38;
        EAFXInstructionTypes._map[39] = "k_InitExprInstruction";
        EAFXInstructionTypes.k_InitExprInstruction = 39;
        EAFXInstructionTypes._map[40] = "k_SamplerStateBlockInstruction";
        EAFXInstructionTypes.k_SamplerStateBlockInstruction = 40;
        EAFXInstructionTypes._map[41] = "k_SamplerStateInstruction";
        EAFXInstructionTypes.k_SamplerStateInstruction = 41;
        EAFXInstructionTypes._map[42] = "k_ExtractExprInstruction";
        EAFXInstructionTypes.k_ExtractExprInstruction = 42;
        EAFXInstructionTypes._map[43] = "k_MemExprInstruction";
        EAFXInstructionTypes.k_MemExprInstruction = 43;
        EAFXInstructionTypes._map[44] = "k_FunctionDeclInstruction";
        EAFXInstructionTypes.k_FunctionDeclInstruction = 44;
        EAFXInstructionTypes._map[45] = "k_ShaderFunctionInstruction";
        EAFXInstructionTypes.k_ShaderFunctionInstruction = 45;
        EAFXInstructionTypes._map[46] = "k_SystemFunctionInstruction";
        EAFXInstructionTypes.k_SystemFunctionInstruction = 46;
        EAFXInstructionTypes._map[47] = "k_FunctionDefInstruction";
        EAFXInstructionTypes.k_FunctionDefInstruction = 47;
        EAFXInstructionTypes._map[48] = "k_StmtInstruction";
        EAFXInstructionTypes.k_StmtInstruction = 48;
        EAFXInstructionTypes._map[49] = "k_StmtBlockInstruction";
        EAFXInstructionTypes.k_StmtBlockInstruction = 49;
        EAFXInstructionTypes._map[50] = "k_ExprStmtInstruction";
        EAFXInstructionTypes.k_ExprStmtInstruction = 50;
        EAFXInstructionTypes._map[51] = "k_BreakStmtInstruction";
        EAFXInstructionTypes.k_BreakStmtInstruction = 51;
        EAFXInstructionTypes._map[52] = "k_WhileStmtInstruction";
        EAFXInstructionTypes.k_WhileStmtInstruction = 52;
        EAFXInstructionTypes._map[53] = "k_ForStmtInstruction";
        EAFXInstructionTypes.k_ForStmtInstruction = 53;
        EAFXInstructionTypes._map[54] = "k_IfStmtInstruction";
        EAFXInstructionTypes.k_IfStmtInstruction = 54;
        EAFXInstructionTypes._map[55] = "k_DeclStmtInstruction";
        EAFXInstructionTypes.k_DeclStmtInstruction = 55;
        EAFXInstructionTypes._map[56] = "k_ReturnStmtInstruction";
        EAFXInstructionTypes.k_ReturnStmtInstruction = 56;
        EAFXInstructionTypes._map[57] = "k_ExtractStmtInstruction";
        EAFXInstructionTypes.k_ExtractStmtInstruction = 57;
        EAFXInstructionTypes._map[58] = "k_SemicolonStmtInstruction";
        EAFXInstructionTypes.k_SemicolonStmtInstruction = 58;
        EAFXInstructionTypes._map[59] = "k_PassInstruction";
        EAFXInstructionTypes.k_PassInstruction = 59;
        EAFXInstructionTypes._map[60] = "k_TechniqueInstruction";
        EAFXInstructionTypes.k_TechniqueInstruction = 60;
    })(akra.EAFXInstructionTypes || (akra.EAFXInstructionTypes = {}));
    var EAFXInstructionTypes = akra.EAFXInstructionTypes;
    (function (EFunctionType) {
        EFunctionType._map = [];
        EFunctionType.k_Vertex = 0;
        EFunctionType.k_Pixel = 1;
        EFunctionType.k_Fragment = 1;
        EFunctionType.k_Function = 2;
        EFunctionType.k_PassFunction = 3;
    })(akra.EFunctionType || (akra.EFunctionType = {}));
    var EFunctionType = akra.EFunctionType;
    (function (ECheckStage) {
        ECheckStage._map = [];
        ECheckStage._map[0] = "CODE_TARGET_SUPPORT";
        ECheckStage.CODE_TARGET_SUPPORT = 0;
        ECheckStage._map[1] = "SELF_CONTAINED";
        ECheckStage.SELF_CONTAINED = 1;
    })(akra.ECheckStage || (akra.ECheckStage = {}));
    var ECheckStage = akra.ECheckStage;
    (function (EVarUsedMode) {
        EVarUsedMode._map = [];
        EVarUsedMode._map[0] = "k_Read";
        EVarUsedMode.k_Read = 0;
        EVarUsedMode._map[1] = "k_Write";
        EVarUsedMode.k_Write = 1;
        EVarUsedMode._map[2] = "k_ReadWrite";
        EVarUsedMode.k_ReadWrite = 2;
        EVarUsedMode._map[3] = "k_Undefined";
        EVarUsedMode.k_Undefined = 3;
        EVarUsedMode.k_Default = EVarUsedMode.k_ReadWrite;
    })(akra.EVarUsedMode || (akra.EVarUsedMode = {}));
    var EVarUsedMode = akra.EVarUsedMode;
    (function (EExtractExprType) {
        EExtractExprType._map = [];
        EExtractExprType._map[0] = "k_Header";
        EExtractExprType.k_Header = 0;
        EExtractExprType._map[1] = "k_Float";
        EExtractExprType.k_Float = 1;
        EExtractExprType._map[2] = "k_Int";
        EExtractExprType.k_Int = 2;
        EExtractExprType._map[3] = "k_Bool";
        EExtractExprType.k_Bool = 3;
        EExtractExprType._map[4] = "k_Float2";
        EExtractExprType.k_Float2 = 4;
        EExtractExprType._map[5] = "k_Int2";
        EExtractExprType.k_Int2 = 5;
        EExtractExprType._map[6] = "k_Bool2";
        EExtractExprType.k_Bool2 = 6;
        EExtractExprType._map[7] = "k_Float3";
        EExtractExprType.k_Float3 = 7;
        EExtractExprType._map[8] = "k_Int3";
        EExtractExprType.k_Int3 = 8;
        EExtractExprType._map[9] = "k_Bool3";
        EExtractExprType.k_Bool3 = 9;
        EExtractExprType._map[10] = "k_Float4";
        EExtractExprType.k_Float4 = 10;
        EExtractExprType._map[11] = "k_Int4";
        EExtractExprType.k_Int4 = 11;
        EExtractExprType._map[12] = "k_Bool4";
        EExtractExprType.k_Bool4 = 12;
        EExtractExprType._map[13] = "k_Float4x4";
        EExtractExprType.k_Float4x4 = 13;
    })(akra.EExtractExprType || (akra.EExtractExprType = {}));
    var EExtractExprType = akra.EExtractExprType;
    (function (EAFXBlendMode) {
        EAFXBlendMode._map = [];
        EAFXBlendMode._map[0] = "k_Shared";
        EAFXBlendMode.k_Shared = 0;
        EAFXBlendMode._map[1] = "k_Uniform";
        EAFXBlendMode.k_Uniform = 1;
        EAFXBlendMode._map[2] = "k_Attribute";
        EAFXBlendMode.k_Attribute = 2;
        EAFXBlendMode._map[3] = "k_Foreign";
        EAFXBlendMode.k_Foreign = 3;
        EAFXBlendMode._map[4] = "k_Global";
        EAFXBlendMode.k_Global = 4;
        EAFXBlendMode._map[5] = "k_Varying";
        EAFXBlendMode.k_Varying = 5;
        EAFXBlendMode._map[6] = "k_TypeDecl";
        EAFXBlendMode.k_TypeDecl = 6;
        EAFXBlendMode._map[7] = "k_VertexOut";
        EAFXBlendMode.k_VertexOut = 7;
    })(akra.EAFXBlendMode || (akra.EAFXBlendMode = {}));
    var EAFXBlendMode = akra.EAFXBlendMode;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EPixelFormats) {
        EPixelFormats._map = [];
        EPixelFormats.UNKNOWN = 0;
        EPixelFormats.L8 = 1;
        EPixelFormats.BYTE_L = EPixelFormats.L8;
        EPixelFormats.L16 = 2;
        EPixelFormats.SHORT_L = EPixelFormats.L16;
        EPixelFormats.A8 = 3;
        EPixelFormats.BYTE_A = EPixelFormats.A8;
        EPixelFormats.A4L4 = 4;
        EPixelFormats.BYTE_LA = 5;
        EPixelFormats.R5G6B5 = 6;
        EPixelFormats.B5G6R5 = 7;
        EPixelFormats.R3G3B2 = 31;
        EPixelFormats.A4R4G4B4 = 8;
        EPixelFormats.A1R5G5B5 = 9;
        EPixelFormats.R8G8B8 = 10;
        EPixelFormats.B8G8R8 = 11;
        EPixelFormats.A8R8G8B8 = 12;
        EPixelFormats.A8B8G8R8 = 13;
        EPixelFormats.B8G8R8A8 = 14;
        EPixelFormats.R8G8B8A8 = 28;
        EPixelFormats.X8R8G8B8 = 26;
        EPixelFormats.X8B8G8R8 = 27;
        EPixelFormats.BYTE_RGB = EPixelFormats.R8G8B8;
        EPixelFormats.BYTE_BGR = EPixelFormats.B8G8R8;
        EPixelFormats.BYTE_BGRA = EPixelFormats.B8G8R8A8;
        EPixelFormats.BYTE_RGBA = EPixelFormats.R8G8B8A8;
        EPixelFormats.BYTE_ABGR = EPixelFormats.A8B8G8R8;
        EPixelFormats.BYTE_ARGB = EPixelFormats.A8R8G8B8;
        EPixelFormats.A2R10G10B10 = 15;
        EPixelFormats.A2B10G10R10 = 16;
        EPixelFormats.DXT1 = 17;
        EPixelFormats.DXT2 = 18;
        EPixelFormats.DXT3 = 19;
        EPixelFormats.DXT4 = 20;
        EPixelFormats.DXT5 = 21;
        EPixelFormats.FLOAT16_R = 32;
        EPixelFormats.FLOAT16_RGB = 22;
        EPixelFormats.FLOAT16_RGBA = 23;
        EPixelFormats.FLOAT32_R = 33;
        EPixelFormats.FLOAT32_RGB = 24;
        EPixelFormats.FLOAT32_RGBA = 25;
        EPixelFormats.FLOAT16_GR = 35;
        EPixelFormats.FLOAT32_GR = 36;
        EPixelFormats.FLOAT32_DEPTH = 29;
        EPixelFormats.DEPTH8 = 44;
        EPixelFormats.BYTE_DEPTH = EPixelFormats.DEPTH8;
        EPixelFormats.DEPTH16 = 45;
        EPixelFormats.SHORT_DEPTH = EPixelFormats.DEPTH16;
        EPixelFormats.DEPTH32 = 46;
        EPixelFormats.DEPTH24STENCIL8 = 47;
        EPixelFormats.SHORT_RGBA = 30;
        EPixelFormats.SHORT_GR = 34;
        EPixelFormats.SHORT_RGB = 37;
        EPixelFormats.PVRTC_RGB2 = 38;
        EPixelFormats.PVRTC_RGBA2 = 39;
        EPixelFormats.PVRTC_RGB4 = 40;
        EPixelFormats.PVRTC_RGBA4 = 41;
        EPixelFormats.R8 = 42;
        EPixelFormats.RG8 = 43;
        EPixelFormats.TOTAL = 48;
    })(akra.EPixelFormats || (akra.EPixelFormats = {}));
    var EPixelFormats = akra.EPixelFormats;
    ;
    (function (EPixelFormatFlags) {
        EPixelFormatFlags._map = [];
        EPixelFormatFlags.HASALPHA = 0x00000001;
        EPixelFormatFlags.COMPRESSED = 0x00000002;
        EPixelFormatFlags.FLOAT = 0x00000004;
        EPixelFormatFlags.DEPTH = 0x00000008;
        EPixelFormatFlags.NATIVEENDIAN = 0x00000010;
        EPixelFormatFlags.LUMINANCE = 0x00000020;
        EPixelFormatFlags.STENCIL = 0x00000040;
    })(akra.EPixelFormatFlags || (akra.EPixelFormatFlags = {}));
    var EPixelFormatFlags = akra.EPixelFormatFlags;
    (function (EPixelComponentTypes) {
        EPixelComponentTypes._map = [];
        EPixelComponentTypes.BYTE = 0;
        EPixelComponentTypes.SHORT = 1;
        EPixelComponentTypes.INT = 2;
        EPixelComponentTypes.FLOAT16 = 3;
        EPixelComponentTypes.FLOAT32 = 4;
        EPixelComponentTypes.COUNT = 5;
    })(akra.EPixelComponentTypes || (akra.EPixelComponentTypes = {}));
    var EPixelComponentTypes = akra.EPixelComponentTypes;
    ;
    (function (EFilters) {
        EFilters._map = [];
        EFilters._map[0] = "NEAREST";
        EFilters.NEAREST = 0;
        EFilters._map[1] = "LINEAR";
        EFilters.LINEAR = 1;
        EFilters._map[2] = "BILINEAR";
        EFilters.BILINEAR = 2;
        EFilters._map[3] = "BOX";
        EFilters.BOX = 3;
        EFilters._map[4] = "TRIANGLE";
        EFilters.TRIANGLE = 4;
        EFilters._map[5] = "BICUBIC";
        EFilters.BICUBIC = 5;
    })(akra.EFilters || (akra.EFilters = {}));
    var EFilters = akra.EFilters;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EHardwareBufferFlags) {
        EHardwareBufferFlags._map = [];
        EHardwareBufferFlags.STATIC = 0x01;
        EHardwareBufferFlags.DYNAMIC = 0x02;
        EHardwareBufferFlags.STREAM = 0x80;
        EHardwareBufferFlags.READABLE = 0x04;
        EHardwareBufferFlags.BACKUP_COPY = 0x08;
        EHardwareBufferFlags.SOFTWARE = 0x10;
        EHardwareBufferFlags.ALIGNMENT = 0x20;
        EHardwareBufferFlags.DISCARDABLE = 0x40;
        EHardwareBufferFlags.STATIC_READABLE = EHardwareBufferFlags.STATIC | EHardwareBufferFlags.READABLE;
        EHardwareBufferFlags.DYNAMIC_DISCARDABLE = EHardwareBufferFlags.DYNAMIC | EHardwareBufferFlags.DISCARDABLE;
    })(akra.EHardwareBufferFlags || (akra.EHardwareBufferFlags = {}));
    var EHardwareBufferFlags = akra.EHardwareBufferFlags;
    (function (ELockFlags) {
        ELockFlags._map = [];
        ELockFlags.READ = 0x01;
        ELockFlags.WRITE = 0x02;
        ELockFlags.DISCARD = 0x04;
        ELockFlags.NO_OVERWRITE = 0x08;
        ELockFlags.NORMAL = ELockFlags.READ | ELockFlags.WRITE;
    })(akra.ELockFlags || (akra.ELockFlags = {}));
    var ELockFlags = akra.ELockFlags;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    (function (ETextureFlags) {
        ETextureFlags._map = [];
        ETextureFlags.STATIC = akra.EHardwareBufferFlags.STATIC;
        ETextureFlags.DYNAMIC = akra.EHardwareBufferFlags.DYNAMIC;
        ETextureFlags.READEBLE = akra.EHardwareBufferFlags.READABLE;
        ETextureFlags.DYNAMIC_DISCARDABLE = akra.EHardwareBufferFlags.DYNAMIC_DISCARDABLE;
        ETextureFlags.AUTOMIPMAP = 0x100;
        ETextureFlags.RENDERTARGET = 0x200;
        ETextureFlags.DEFAULT = ETextureFlags.STATIC;
    })(akra.ETextureFlags || (akra.ETextureFlags = {}));
    var ETextureFlags = akra.ETextureFlags;
    (function (ETextureFilters) {
        ETextureFilters._map = [];
        ETextureFilters.NEAREST = 0x2600;
        ETextureFilters.LINEAR = 0x2601;
        ETextureFilters.NEAREST_MIPMAP_NEAREST = 0x2700;
        ETextureFilters.LINEAR_MIPMAP_NEAREST = 0x2701;
        ETextureFilters.NEAREST_MIPMAP_LINEAR = 0x2702;
        ETextureFilters.LINEAR_MIPMAP_LINEAR = 0x2703;
    })(akra.ETextureFilters || (akra.ETextureFilters = {}));
    var ETextureFilters = akra.ETextureFilters;
    ;
    (function (ETextureWrapModes) {
        ETextureWrapModes._map = [];
        ETextureWrapModes.REPEAT = 0x2901;
        ETextureWrapModes.CLAMP_TO_EDGE = 0x812F;
        ETextureWrapModes.MIRRORED_REPEAT = 0x8370;
    })(akra.ETextureWrapModes || (akra.ETextureWrapModes = {}));
    var ETextureWrapModes = akra.ETextureWrapModes;
    ;
    (function (ETextureParameters) {
        ETextureParameters._map = [];
        ETextureParameters.MAG_FILTER = 0x2800;
        ETextureParameters._map[10241] = "MIN_FILTER";
        ETextureParameters.MIN_FILTER = 10241;
        ETextureParameters._map[10242] = "WRAP_S";
        ETextureParameters.WRAP_S = 10242;
        ETextureParameters._map[10243] = "WRAP_T";
        ETextureParameters.WRAP_T = 10243;
    })(akra.ETextureParameters || (akra.ETextureParameters = {}));
    var ETextureParameters = akra.ETextureParameters;
    ;
    (function (ETextureTypes) {
        ETextureTypes._map = [];
        ETextureTypes.TEXTURE_2D = 0x0DE1;
        ETextureTypes.TEXTURE_CUBE_MAP = 0x8513;
    })(akra.ETextureTypes || (akra.ETextureTypes = {}));
    var ETextureTypes = akra.ETextureTypes;
    ;
    (function (ECubeFace) {
        ECubeFace._map = [];
        ECubeFace.POSITIVE_X = 0;
        ECubeFace.NEGATIVE_X = 1;
        ECubeFace.POSITIVE_Y = 2;
        ECubeFace.NEGATIVE_Y = 3;
        ECubeFace.POSITIVE_Z = 4;
        ECubeFace.NEGATIVE_Z = 5;
    })(akra.ECubeFace || (akra.ECubeFace = {}));
    var ECubeFace = akra.ECubeFace;
    ;
    (function (ETextureCubeFlags) {
        ETextureCubeFlags._map = [];
        ETextureCubeFlags.POSITIVE_X = 0x00000001;
        ETextureCubeFlags.NEGATIVE_X = 0x00000002;
        ETextureCubeFlags.POSITIVE_Y = 0x00000004;
        ETextureCubeFlags.NEGATIVE_Y = 0x00000008;
        ETextureCubeFlags.POSITIVE_Z = 0x0000000c;
        ETextureCubeFlags.NEGATIVE_Z = 0x000000010;
    })(akra.ETextureCubeFlags || (akra.ETextureCubeFlags = {}));
    var ETextureCubeFlags = akra.ETextureCubeFlags;
    ;
    (function (ETextureUnits) {
        ETextureUnits._map = [];
        ETextureUnits.TEXTURE0 = 0x84C0;
    })(akra.ETextureUnits || (akra.ETextureUnits = {}));
    var ETextureUnits = akra.ETextureUnits;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    (function (ESurfaceMaterialTextures) {
        ESurfaceMaterialTextures._map = [];
        ESurfaceMaterialTextures.TEXTURE0 = 0;
        ESurfaceMaterialTextures._map[1] = "TEXTURE1";
        ESurfaceMaterialTextures.TEXTURE1 = 1;
        ESurfaceMaterialTextures._map[2] = "TEXTURE2";
        ESurfaceMaterialTextures.TEXTURE2 = 2;
        ESurfaceMaterialTextures._map[3] = "TEXTURE3";
        ESurfaceMaterialTextures.TEXTURE3 = 3;
        ESurfaceMaterialTextures._map[4] = "TEXTURE4";
        ESurfaceMaterialTextures.TEXTURE4 = 4;
        ESurfaceMaterialTextures._map[5] = "TEXTURE5";
        ESurfaceMaterialTextures.TEXTURE5 = 5;
        ESurfaceMaterialTextures._map[6] = "TEXTURE6";
        ESurfaceMaterialTextures.TEXTURE6 = 6;
        ESurfaceMaterialTextures._map[7] = "TEXTURE7";
        ESurfaceMaterialTextures.TEXTURE7 = 7;
        ESurfaceMaterialTextures._map[8] = "TEXTURE8";
        ESurfaceMaterialTextures.TEXTURE8 = 8;
        ESurfaceMaterialTextures._map[9] = "TEXTURE9";
        ESurfaceMaterialTextures.TEXTURE9 = 9;
        ESurfaceMaterialTextures._map[10] = "TEXTURE10";
        ESurfaceMaterialTextures.TEXTURE10 = 10;
        ESurfaceMaterialTextures._map[11] = "TEXTURE11";
        ESurfaceMaterialTextures.TEXTURE11 = 11;
        ESurfaceMaterialTextures._map[12] = "TEXTURE12";
        ESurfaceMaterialTextures.TEXTURE12 = 12;
        ESurfaceMaterialTextures._map[13] = "TEXTURE13";
        ESurfaceMaterialTextures.TEXTURE13 = 13;
        ESurfaceMaterialTextures._map[14] = "TEXTURE14";
        ESurfaceMaterialTextures.TEXTURE14 = 14;
        ESurfaceMaterialTextures._map[15] = "TEXTURE15";
        ESurfaceMaterialTextures.TEXTURE15 = 15;
        ESurfaceMaterialTextures.DIFFUSE = ESurfaceMaterialTextures.TEXTURE0;
        ESurfaceMaterialTextures.AMBIENT = ESurfaceMaterialTextures.TEXTURE1;
        ESurfaceMaterialTextures.SPECULAR = ESurfaceMaterialTextures.TEXTURE2;
        ESurfaceMaterialTextures.EMISSIVE = ESurfaceMaterialTextures.TEXTURE3;
        ESurfaceMaterialTextures.NORMAL = ESurfaceMaterialTextures.TEXTURE4;
        ESurfaceMaterialTextures.EMISSION = ESurfaceMaterialTextures.EMISSIVE;
    })(akra.ESurfaceMaterialTextures || (akra.ESurfaceMaterialTextures = {}));
    var ESurfaceMaterialTextures = akra.ESurfaceMaterialTextures;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EAFXShaderVariableType) {
        EAFXShaderVariableType._map = [];
        EAFXShaderVariableType.k_NotVar = 0;
        EAFXShaderVariableType.k_Texture = 2;
        EAFXShaderVariableType._map[3] = "k_Float";
        EAFXShaderVariableType.k_Float = 3;
        EAFXShaderVariableType._map[4] = "k_Int";
        EAFXShaderVariableType.k_Int = 4;
        EAFXShaderVariableType._map[5] = "k_Bool";
        EAFXShaderVariableType.k_Bool = 5;
        EAFXShaderVariableType._map[6] = "k_Float2";
        EAFXShaderVariableType.k_Float2 = 6;
        EAFXShaderVariableType._map[7] = "k_Int2";
        EAFXShaderVariableType.k_Int2 = 7;
        EAFXShaderVariableType._map[8] = "k_Bool2";
        EAFXShaderVariableType.k_Bool2 = 8;
        EAFXShaderVariableType._map[9] = "k_Float3";
        EAFXShaderVariableType.k_Float3 = 9;
        EAFXShaderVariableType._map[10] = "k_Int3";
        EAFXShaderVariableType.k_Int3 = 10;
        EAFXShaderVariableType._map[11] = "k_Bool3";
        EAFXShaderVariableType.k_Bool3 = 11;
        EAFXShaderVariableType._map[12] = "k_Float4";
        EAFXShaderVariableType.k_Float4 = 12;
        EAFXShaderVariableType._map[13] = "k_Int4";
        EAFXShaderVariableType.k_Int4 = 13;
        EAFXShaderVariableType._map[14] = "k_Bool4";
        EAFXShaderVariableType.k_Bool4 = 14;
        EAFXShaderVariableType._map[15] = "k_Float2x2";
        EAFXShaderVariableType.k_Float2x2 = 15;
        EAFXShaderVariableType._map[16] = "k_Float3x3";
        EAFXShaderVariableType.k_Float3x3 = 16;
        EAFXShaderVariableType._map[17] = "k_Float4x4";
        EAFXShaderVariableType.k_Float4x4 = 17;
        EAFXShaderVariableType._map[18] = "k_Sampler2D";
        EAFXShaderVariableType.k_Sampler2D = 18;
        EAFXShaderVariableType._map[19] = "k_SamplerCUBE";
        EAFXShaderVariableType.k_SamplerCUBE = 19;
        EAFXShaderVariableType._map[20] = "k_SamplerVertexTexture";
        EAFXShaderVariableType.k_SamplerVertexTexture = 20;
        EAFXShaderVariableType._map[21] = "k_CustomSystem";
        EAFXShaderVariableType.k_CustomSystem = 21;
        EAFXShaderVariableType._map[22] = "k_Complex";
        EAFXShaderVariableType.k_Complex = 22;
    })(akra.EAFXShaderVariableType || (akra.EAFXShaderVariableType = {}));
    var EAFXShaderVariableType = akra.EAFXShaderVariableType;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    (function (EDataFlowTypes) {
        EDataFlowTypes._map = [];
        EDataFlowTypes.MAPPABLE = 1;
        EDataFlowTypes.UNMAPPABLE = 0;
    })(akra.EDataFlowTypes || (akra.EDataFlowTypes = {}));
    var EDataFlowTypes = akra.EDataFlowTypes;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EResourceCodes) {
        EResourceCodes._map = [];
        EResourceCodes.INVALID_CODE = 0xFFFFFFFF;
    })(akra.EResourceCodes || (akra.EResourceCodes = {}));
    var EResourceCodes = akra.EResourceCodes;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            var ResourceCode = (function () {
                function ResourceCode(iFamily, iType) {
                    this.iValue = (akra.EResourceCodes.INVALID_CODE);
                    switch(arguments.length) {
                        case 0:
                            this.iValue = akra.EResourceCodes.INVALID_CODE;
                            break;
                        case 1:
                            if (arguments[0] instanceof ResourceCode) {
                                this.iValue = arguments[0].iValue;
                            } else {
                                this.iValue = arguments[0];
                            }
                            break;
                        case 2:
                            this.family = arguments[0];
                            this.type = arguments[1];
                            break;
                    }
                }
                Object.defineProperty(ResourceCode.prototype, "family", {
                    get: function () {
                        return this.iValue >> 16;
                    },
                    set: function (iNewFamily) {
                        this.iValue &= 0x0000FFFF;
                        this.iValue |= iNewFamily << 16;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourceCode.prototype, "type", {
                    get: function () {
                        return this.iValue & 0x0000FFFF;
                    },
                    set: function (iNewType) {
                        this.iValue &= 0xFFFF0000;
                        this.iValue |= iNewType & 0x0000FFFF;
                    },
                    enumerable: true,
                    configurable: true
                });
                ResourceCode.prototype.setInvalid = function () {
                    this.iValue = akra.EResourceCodes.INVALID_CODE;
                };
                ResourceCode.prototype.less = function (pSrc) {
                    return this.iValue < pSrc.valueOf();
                };
                ResourceCode.prototype.eq = function (pSrc) {
                    this.iValue = pSrc.valueOf();
                    return this;
                };
                ResourceCode.prototype.valueOf = function () {
                    return this.iValue;
                };
                ResourceCode.prototype.toNumber = function () {
                    return this.iValue;
                };
                return ResourceCode;
            })();
            pool.ResourceCode = ResourceCode;            
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        var ReferenceCounter = (function () {
            function ReferenceCounter(pSrc) {
                this.nReferenceCount = 0;
            }
            ReferenceCounter.prototype.referenceCount = function () {
                return this.nReferenceCount;
            };
            ReferenceCounter.prototype.destructor = function () {
 {
                    util.logger.setSourceLocation("util/ReferenceCounter.ts", 26);
                    util.logger.assert(this.nReferenceCount === 0, 'object is used');
                }
                ;
            };
            ReferenceCounter.prototype.release = function () {
 {
                    util.logger.setSourceLocation("util/ReferenceCounter.ts", 30);
                    util.logger.assert(this.nReferenceCount > 0, 'object is used');
                }
                ;
                this.nReferenceCount--;
                return this.nReferenceCount;
            };
            ReferenceCounter.prototype.addRef = function () {
 {
                    util.logger.setSourceLocation("util/ReferenceCounter.ts", 36);
                    util.logger.assert(this.nReferenceCount != akra.MIN_INT32, 'reference fail');
                }
                ;
                this.nReferenceCount++;
                return this.nReferenceCount;
            };
            ReferenceCounter.prototype.eq = function (pSrc) {
                return this;
            };
            return ReferenceCounter;
        })();
        util.ReferenceCounter = ReferenceCounter;        
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (events) {
        var EventTable = (function () {
            function EventTable() {
                this.broadcast = {};
                this.unicast = {};
            }
            EventTable.prototype.addDestination = function (iGuid, sSignal, pTarget, sSlot, eType) {
                if (typeof eType === "undefined") { eType = akra.EEventTypes.BROADCAST; }
                if (eType === akra.EEventTypes.BROADCAST) {
                    if (this.findDestinationIndexBC(iGuid, sSignal, pTarget, sSlot) === -1) {
                        this.findBroadcastSignalMap(iGuid, sSignal).push({
                            target: pTarget,
                            callback: sSlot,
                            listener: null
                        });
                    }
                    return true;
                } else {
                    this.unicast[iGuid] = this.unicast[iGuid] || {};
                    if (!((this.unicast[iGuid][sSignal]) !== undefined)) {
                        this.unicast[iGuid][sSignal] = {
                            target: pTarget,
                            callback: sSlot,
                            listener: null
                        };
                        return true;
                    }
                }
                return false;
            };
            EventTable.prototype.findDestinationIndexBC = function (iGuid, sSignal, pTarget, sSlot) {
                var pList = this.findBroadcastSignalMap(iGuid, sSignal);
                for(var i = 0; i < pList.length; ++i) {
                    if (pList[i].target === pTarget && pList[i].callback === sSlot) {
                        return i;
                    }
                }
                return -1;
            };
            EventTable.prototype.removeDestination = function (iGuid, sSignal, pTarget, sSlot, eType) {
                if (typeof eType === "undefined") { eType = akra.EEventTypes.BROADCAST; }
                if (eType === akra.EEventTypes.BROADCAST) {
                    var pList = this.findBroadcastSignalMap(iGuid, sSignal);
                    var i = this.findDestinationIndexBC(iGuid, sSignal, pTarget, sSlot);
                    if (i != -1) {
                        pList.splice(i, 1);
                        return true;
                    }
                } else {
                    if (this.unicast[iGuid] && this.unicast[iGuid][sSignal]) {
                        delete this.unicast[iGuid][sSignal];
                        return true;
                    }
                }
 {
                    akra.logger.setSourceLocation("events/events.ts", 134);
                    akra.logger.warning("cannot remove destination for GUID <%s> with signal <%s>", iGuid, sSignal);
                }
                ;
                return false;
            };
            EventTable.prototype.addListener = function (iGuid, sSignal, fnListener, eType) {
                if (typeof eType === "undefined") { eType = akra.EEventTypes.BROADCAST; }
                if (eType === akra.EEventTypes.BROADCAST) {
                    this.findBroadcastSignalMap(iGuid, sSignal).push({
                        target: null,
                        callback: null,
                        listener: fnListener
                    });
                    return true;
                } else {
                    this.unicast[iGuid] = this.unicast[iGuid] || {};
                    if (!((this.unicast[iGuid][sSignal]) !== undefined)) {
                        this.unicast[iGuid][sSignal] = {
                            target: null,
                            callback: null,
                            listener: fnListener
                        };
                        return true;
                    }
                }
 {
                    akra.logger.setSourceLocation("events/events.ts", 151);
                    akra.logger.warning("cannot add listener for GUID <%s> with signal <%s>", iGuid, sSignal);
                }
                ;
                return false;
            };
            EventTable.prototype.removeListener = function (iGuid, sSignal, fnListener, eType) {
                if (typeof eType === "undefined") { eType = akra.EEventTypes.BROADCAST; }
                if (eType === akra.EEventTypes.BROADCAST) {
                    var pList = this.findBroadcastSignalMap(iGuid, sSignal);
                    for(var i = 0; i < pList.length; ++i) {
                        if (pList[i].listener === fnListener) {
                            pList.splice(i, 1);
                            return true;
                        }
                    }
                } else {
                    if (this.unicast[iGuid] && this.unicast[iGuid][sSignal]) {
                        delete this.unicast[iGuid][sSignal];
                        return true;
                    }
                }
                return false;
            };
            EventTable.prototype.findBroadcastList = function (iGuid) {
                return (this.broadcast[iGuid] = this.broadcast[iGuid] || {});
            };
            EventTable.prototype.findUnicastList = function (iGuid) {
                this.unicast[iGuid] = this.unicast[iGuid] || {};
                return this.unicast[iGuid];
            };
            EventTable.prototype._sync = function (pTarget, pFrom) {
                this.broadcast[pTarget.getGuid()] = this.broadcast[pFrom.getGuid()];
                this.unicast[pTarget.getGuid()] = this.unicast[pFrom.getGuid()];
            };
            EventTable.prototype.findBroadcastSignalMap = function (iGuid, sSignal) {
                this.broadcast[iGuid] = this.broadcast[iGuid] || {};
                this.broadcast[iGuid][sSignal] = this.broadcast[iGuid][sSignal] || [];
                return this.broadcast[iGuid][sSignal];
            };
            return EventTable;
        })();
        events.EventTable = EventTable;        
        var EventProvider = (function () {
            function EventProvider() {
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
            }
            EventProvider.prototype.getGuid = function () {
                return this._iGuid;
            };
            EventProvider._pEventTable = new events.EventTable();
            EventProvider.prototype.getEventTable = function () {
                return EventProvider._pEventTable;
            };
            EventProvider.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            EventProvider.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            EventProvider.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            EventProvider.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            EventProvider.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            return EventProvider;
        })();
        events.EventProvider = EventProvider;        
    })(akra.events || (akra.events = {}));
    var events = akra.events;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            var ResourcePool = (function (_super) {
                __extends(ResourcePool, _super);
                function ResourcePool(pManager, tTemplate) {
                                _super.call(this);
                    this.pManager = null;
                    this.tTemplate = null;
                    this.sExt = null;
                    this.pRegistrationCode = new pool.ResourceCode(akra.EResourceCodes.INVALID_CODE);
                    this.pNameMap = new Array();
                    this.pDataPool = null;
                    this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                    this._pUnicastSlotMap = null;
                    this._pBroadcastSlotList = null;
                    this.pManager = pManager;
                    this.tTemplate = tTemplate;
                    this.pDataPool = new pool.DataPool(this.pManager, tTemplate);
                }
                Object.defineProperty(ResourcePool.prototype, "iFourcc", {
                    get: function () {
                        return (this.sExt.charCodeAt(3) << 24) | (this.sExt.charCodeAt(2) << 16) | (this.sExt.charCodeAt(1) << 8) | (this.sExt.charCodeAt(0));
                    },
                    set: function (iNewFourcc) {
                        this.sExt = String.fromCharCode((iNewFourcc & 0x000000FF), (iNewFourcc & 0x0000FF00) >>> 8, (iNewFourcc & 0x00FF0000) >>> 16, (iNewFourcc & 0xFF000000) >>> 24);
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePool.prototype, "manager", {
                    get: function () {
                        return this.pManager;
                    },
                    enumerable: true,
                    configurable: true
                });
                ResourcePool.prototype.registerResourcePool = function (pCode) {
                    this.pRegistrationCode.eq(pCode);
                    this.pManager.registerResourcePool(this.pRegistrationCode, this);
                };
                ResourcePool.prototype.unregisterResourcePool = function () {
                    this.pManager.unregisterResourcePool(this.pRegistrationCode);
                    this.pRegistrationCode.setInvalid();
                };
                ResourcePool.prototype.findResourceHandle = function (sName) {
                    var iNewHandle = akra.INVALID_INDEX;
                    for(var iHandle = 0; iHandle < this.pNameMap.length; ++iHandle) {
                        if (this.pNameMap[iHandle] === sName) {
                            return iHandle;
                        }
                    }
                    return iNewHandle;
                };
                ResourcePool.prototype.findResourceName = function (iHandle) {
                    return this.pNameMap[iHandle];
                };
                ResourcePool.prototype.setResourceName = function (iHandle, sName) {
                    this.pNameMap[iHandle] = sName;
                };
                ResourcePool.prototype.initialize = function (iGrowSize) {
                    this.pDataPool.initialize(iGrowSize);
                };
                ResourcePool.prototype.destroy = function () {
                    this.pDataPool.destroy();
                };
                ResourcePool.prototype.clean = function () {
                    this.pDataPool.forEach(ResourcePool.callbackClean);
                };
                ResourcePool.prototype.destroyAll = function () {
                    this.pDataPool.forEach(ResourcePool.callbackDestroy);
                };
                ResourcePool.prototype.restoreAll = function () {
                    this.pDataPool.forEach(ResourcePool.callbackRestore);
                };
                ResourcePool.prototype.disableAll = function () {
                    this.pDataPool.forEach(ResourcePool.callbackDisable);
                };
                ResourcePool.prototype.isInitialized = function () {
                    return this.pDataPool.isInitialized();
                };
                ResourcePool.prototype.createResource = function (sResourceName) {
                    var iHandle = this.internalCreateResource(sResourceName);
                    if (iHandle !== akra.INVALID_INDEX) {
                        var pResource = this.getResource(iHandle);
                        pResource.setResourcePool(this);
                        pResource.setResourceHandle(iHandle);
                        pResource.setResourceCode(this.pRegistrationCode);
                        this.createdResource(pResource);
                        return pResource;
                    }
                    return null;
                };
                ResourcePool.prototype.loadResource = function (sResourceName) {
                    var pResource = this.findResource(sResourceName);
                    if (pResource == null) {
                        pResource = this.createResource(sResourceName);
                        if (pResource != null) {
                            if (pResource.loadResource(sResourceName)) {
                                return pResource;
                            }
                            pResource.release();
                            pResource = null;
                        }
                    }
                    return pResource;
                };
                ResourcePool.prototype.saveResource = function (pResource) {
                    if (pResource != null) {
                        return pResource.saveResource();
                    }
                    return false;
                };
                ResourcePool.prototype.destroyResource = function (pResource) {
                    if (pResource != null) {
                        var iReferenceCount = pResource.referenceCount();
 {
                            akra.logger.setSourceLocation("ResourcePool.ts", 180);
                            akra.logger.assert(iReferenceCount == 0, "destruction of non-zero reference count!");
                        }
                        ;
                        if (iReferenceCount <= 0) {
                            var iHandle = pResource.resourceHandle;
                            this.internalDestroyResource(iHandle);
                        }
                    }
                };
                ResourcePool.prototype.findResource = function (sName) {
                    for(var iHandle = 0; iHandle < this.pNameMap.length; ++iHandle) {
                        if (this.pNameMap[iHandle] == sName) {
                            if (iHandle != akra.INVALID_INDEX) {
                                var pResource = this.getResource(iHandle);
                                return pResource;
                            }
                        }
                    }
                    return null;
                };
                ResourcePool.prototype.getResource = function (iHandle) {
                    var pResource = this.internalGetResource(iHandle);
                    if (pResource != null) {
                        pResource.addRef();
                    }
                    return pResource;
                };
                ResourcePool.prototype.getResources = function () {
                    var pResources = [];
                    for(var iHandleResource in this.pNameMap) {
                        pResources.push(this.getResource(parseInt(iHandleResource)));
                    }
                    return pResources;
                };
                ResourcePool.prototype.internalGetResource = function (iHandle) {
                    return this.pDataPool.getPtr(iHandle);
                };
                ResourcePool.prototype.internalDestroyResource = function (iHandle) {
                    var pResource = this.pDataPool.getPtr(iHandle);
                    pResource.destroyResource();
                    delete this.pNameMap[iHandle];
                    this.pDataPool.release(iHandle);
                };
                ResourcePool.prototype.internalCreateResource = function (sResourceName) {
                    var iHandle = this.pDataPool.nextHandle();
                    for(var iter in this.pNameMap) {
 {
                            akra.logger.setSourceLocation("ResourcePool.ts", 247);
                            akra.logger.assert((this.pNameMap[iter] != sResourceName), "A resource with this name already exists: " + sResourceName);
                        }
                        ;
                    }
                    this.pNameMap[iHandle] = sResourceName;
                    var pResource = this.pDataPool.getPtr(iHandle);
                    pResource.createResource();
                    return iHandle;
                };
                ResourcePool.callbackDestroy = function callbackDestroy(pPool, iHandle, pResource) {
                    pResource.destroyResource();
                };
                ResourcePool.callbackDisable = function callbackDisable(pPool, iHandle, pResource) {
                    pResource.disableResource();
                };
                ResourcePool.callbackRestore = function callbackRestore(pPool, iHandle, pResource) {
                    pResource.restoreResource();
                };
                ResourcePool.callbackClean = function callbackClean(pPool, iHandle, pResource) {
                    if (pResource.referenceCount() == 0) {
                        pPool.release(iHandle);
                    }
                };
                ResourcePool.prototype.getGuid = function () {
                    return this._iGuid;
                };
                ResourcePool._pEventTable = new akra.events.EventTable();
                ResourcePool.prototype.getEventTable = function () {
                    return ResourcePool._pEventTable;
                };
                ResourcePool.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                    return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
                };
                ResourcePool.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                    return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
                };
                ResourcePool.prototype.bind = function (sSignal, fnListener, eType) {
                    return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
                };
                ResourcePool.prototype.unbind = function (sSignal, fnListener, eType) {
                    return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
                };
                ResourcePool.prototype._syncTable = function (pFrom) {
                    this.getEventTable()._sync(this, pFrom);
                };
                ResourcePool.prototype.createdResource = function (pResource) {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).createdResource;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pResource) : _broadcast[i].listener(_recivier, pResource);
                        }
                    }
                };
                return ResourcePool;
            })(akra.util.ReferenceCounter);
            pool.ResourcePool = ResourcePool;            
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            var PoolGroup = (function () {
                function PoolGroup(pManager, tTemplate, iMaxCount) {
                    this.iTotalOpen = 0;
                    this.iFirstOpen = 0;
                    this.iMaxCount = 0;
                    this.pNextOpenList = null;
                    this.pMemberList = null;
                    this.pManager = pManager;
                    this.tTemplate = tTemplate;
                    this.iMaxCount = iMaxCount;
                }
                Object.defineProperty(PoolGroup.prototype, "manager", {
                    get: function () {
                        return this.pManager;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(PoolGroup.prototype, "totalOpen", {
                    get: function () {
                        return this.iTotalOpen;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(PoolGroup.prototype, "totalUsed", {
                    get: function () {
                        return this.iMaxCount - this.iTotalOpen;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(PoolGroup.prototype, "firstOpen", {
                    get: function () {
                        return this.iFirstOpen;
                    },
                    enumerable: true,
                    configurable: true
                });
                PoolGroup.prototype.create = function () {
                    var i;
 {
                        akra.logger.setSourceLocation("DataPool.ts", 70);
                        akra.logger.assert(this.pMemberList == null && this.pNextOpenList == null, "Group has already been created");
                    }
                    ;
                    this.pNextOpenList = new Array(this.iMaxCount);
 {
                        akra.logger.setSourceLocation("DataPool.ts", 74);
                        akra.logger.assert(this.pNextOpenList != null, "tragic memory allocation failure!");
                    }
                    ;
                    this.pMemberList = new Array(this.iMaxCount);
                    for(i = 0; i < this.iMaxCount; i++) {
                        this.pMemberList[i] = new this.tTemplate(this.pManager);
                    }
 {
                        akra.logger.setSourceLocation("DataPool.ts", 83);
                        akra.logger.assert(this.pNextOpenList != null, "tragic memory allocation failure!");
                    }
                    ;
                    for(i = 0; i < this.iMaxCount - 1; i++) {
                        this.pNextOpenList[i] = i + 1;
                    }
                    this.pNextOpenList[i] = i;
                    this.iTotalOpen = this.iMaxCount;
                    this.iFirstOpen = 0;
                };
                PoolGroup.prototype.destroy = function () {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 99);
                        akra.logger.assert(this.pMemberList != null && this.pNextOpenList != null, "Group has not been created");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("DataPool.ts", 100);
                        akra.logger.assert(this.iTotalOpen == this.iMaxCount, "Group is not empty");
                    }
                    ;
                    delete this.pMemberList;
                    this.pMemberList = null;
                    delete this.pNextOpenList;
                    this.pNextOpenList = null;
                    this.iTotalOpen = 0;
                    this.iMaxCount = 0;
                };
                PoolGroup.prototype.nextMember = function () {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 114);
                        akra.logger.assert(this.pMemberList != null && this.pNextOpenList != null, "Group has not been created");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("DataPool.ts", 115);
                        akra.logger.assert(this.iTotalOpen != null, "no open slots");
                    }
                    ;
                    var iSlot = this.iFirstOpen;
                    this.iFirstOpen = this.pNextOpenList[iSlot];
                    this.iTotalOpen--;
 {
                        akra.logger.setSourceLocation("DataPool.ts", 123);
                        akra.logger.assert(this.iFirstOpen != akra.INVALID_INDEX, "Invalid Open Index");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("DataPool.ts", 124);
                        akra.logger.assert(this.isOpen(iSlot), "invalid index");
                    }
                    ;
                    this.pNextOpenList[iSlot] = akra.INVALID_INDEX;
                    return iSlot;
                };
                PoolGroup.prototype.addMember = function (pMember) {
                    var iSlot = this.nextMember();
                    this.pMemberList[iSlot] = pMember;
                    return iSlot;
                };
                PoolGroup.prototype.release = function (iIndex) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 142);
                        akra.logger.assert(this.pMemberList != null && this.pNextOpenList != null, "Group has not been created");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("DataPool.ts", 143);
                        akra.logger.assert(iIndex < this.iMaxCount, "invalid index");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("DataPool.ts", 144);
                        akra.logger.assert(this.isOpen(iIndex) == false, "invalid index to release");
                    }
                    ;
                    this.pNextOpenList[iIndex] = this.iTotalOpen > 0 ? this.iFirstOpen : iIndex;
                    this.iTotalOpen++;
                    this.iFirstOpen = iIndex;
                };
                PoolGroup.prototype.isOpen = function (iIndex) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 154);
                        akra.logger.assert(this.pMemberList != null && this.pNextOpenList != null, "Group has not been created");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("DataPool.ts", 155);
                        akra.logger.assert(iIndex < this.iMaxCount, "invalid index");
                    }
                    ;
                    return this.pNextOpenList[iIndex] != akra.INVALID_INDEX;
                };
                PoolGroup.prototype.member = function (iIndex) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 162);
                        akra.logger.assert(this.pMemberList != null && this.pNextOpenList != null, "Group has not been created");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("DataPool.ts", 163);
                        akra.logger.assert(iIndex < this.iMaxCount, "invalid index");
                    }
                    ;
                    return this.pMemberList[iIndex];
                };
                PoolGroup.prototype.memberPtr = function (iIndex) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 168);
                        akra.logger.assert(this.pMemberList != null && this.pNextOpenList != null, "Group has not been created");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("DataPool.ts", 169);
                        akra.logger.assert(iIndex < this.iMaxCount, "invalid index");
                    }
                    ;
                    return this.pMemberList[iIndex];
                };
                return PoolGroup;
            })();
            pool.PoolGroup = PoolGroup;            
            var DataPool = (function () {
                function DataPool(pManager, tTemplate) {
                    this.bInitialized = false;
                    this.pGroupList = [];
                    this.iTotalMembers = 0;
                    this.iTotalOpen = 0;
                    this.iGroupCount = 0;
                    this.iIndexMask = 0;
                    this.iIndexShift = 0;
                    this.pManager = pManager;
                    this.tTemplate = tTemplate;
                }
                Object.defineProperty(DataPool.prototype, "manager", {
                    get: function () {
                        return this.pManager;
                    },
                    enumerable: true,
                    configurable: true
                });
                DataPool.prototype.initialize = function (iGrowSize) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 209);
                        akra.logger.assert(this.isInitialized() == false, "the cDataPool is already initialized");
                    }
                    ;
                    this.bInitialized = true;
                    this.iGroupCount = akra.math.nearestPowerOfTwo(iGrowSize);
                    this.iIndexShift = akra.math.lowestBitSet(this.iGroupCount);
                    this.iIndexShift = (/*checked (origin: math)>>*/akra.math.max((1), /*checked (origin: math)>>*/akra.math.min((this.iIndexShift), (15))));
                    this.iGroupCount = 1 << this.iIndexShift;
                    this.iIndexMask = this.iGroupCount - 1;
                };
                DataPool.prototype.isInitialized = function () {
                    return this.bInitialized;
                };
                DataPool.prototype.destroy = function () {
                    this.clear();
                    this.bInitialized = false;
                };
                DataPool.prototype.release = function (iHandle) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 233);
                        akra.logger.assert(this.isInitialized() == true, "the cDataPool is not initialized");
                    }
                    ;
                    if (this.isHandleValid(iHandle) == true) {
 {
                            akra.logger.setSourceLocation("DataPool.ts", 236);
                            akra.logger.assert(this.pGroupList.length != 0, "The cDataPool has not been properly created");
                        }
                        ;
                        var iGroupIndex = this.getGroupNumber(iHandle);
                        var iItemIndex = this.getItemIndex(iHandle);
                        var pGroup = this.getGroup(iGroupIndex);
                        pGroup.release(iItemIndex);
                        var pGroupBack = this.pGroupList[this.pGroupList.length - 1];
                        if (pGroupBack.totalOpen == this.iGroupCount) {
                            pGroupBack.destroy();
                            this.pGroupList.splice(this.pGroupList.length - 1, 1);
                        }
                        this.iTotalOpen++;
                    }
                };
                DataPool.prototype.clear = function () {
                    for(var iGroupIter = 0; iGroupIter < this.pGroupList.length; ++iGroupIter) {
                        this.pGroupList[iGroupIter].destroy();
                    }
                    this.pGroupList.clear();
                };
                DataPool.prototype.add = function (pMembers) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 265);
                        akra.logger.assert(this.isInitialized() == true, "the cDataPool is not initialized");
                    }
                    ;
                    var iGroupNumber = {
                        value: 0
                    };
                    var pOpenGroup = this.findOpenGroup(iGroupNumber);
                    var iIndex = pOpenGroup.addMember(pMembers);
                    this.iTotalOpen--;
                    return this.buildHandle(iGroupNumber.value, iIndex);
                };
                DataPool.prototype.forEach = function (fFunction) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 278);
                        akra.logger.assert(this.isInitialized() == true, "the cDataPool is not initialized");
                    }
                    ;
                    var iGroupNumber = 0;
                    for(var iGroupIter = 0; iGroupIter < this.pGroupList.length; iGroupIter++) {
                        var nCallbackCount = this.pGroupList[iGroupIter].totalUsed;
                        var iItemIndex = 0;
                        while(nCallbackCount != 0 && iItemIndex < this.iGroupCount) {
                            if (this.pGroupList[iGroupIter].isOpen(iItemIndex) == false) {
                                fFunction(this, this.buildHandle(iGroupNumber, iItemIndex), this.pGroupList[iGroupIter].member(iItemIndex));
                                nCallbackCount--;
                            }
                            ++iItemIndex;
                        }
                        ++iGroupNumber;
                    }
                };
                DataPool.prototype.nextHandle = function () {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 305);
                        akra.logger.assert(this.isInitialized() == true, "the cDataPool is not initialized");
                    }
                    ;
                    var iGroupNumber = {
                        value: 0
                    };
                    var pOpenGroup = this.findOpenGroup(iGroupNumber);
                    var iIndex = pOpenGroup.nextMember();
                    this.iTotalOpen--;
                    return this.buildHandle(iGroupNumber.value, iIndex);
                };
                DataPool.prototype.isHandleValid = function (iHandle) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 317);
                        akra.logger.assert(this.isInitialized() == true, "the cDataPool is not initialized");
                    }
                    ;
                    if (iHandle !== akra.INVALID_INDEX) {
 {
                            akra.logger.setSourceLocation("DataPool.ts", 320);
                            akra.logger.assert(this.pGroupList.length != 0, "The cDataPool has not been properly created");
                        }
                        ;
                        var pGroup = this.getGroup(this.getGroupNumber(iHandle));
                        return !pGroup.isOpen(this.getItemIndex(iHandle));
                    }
                    return false;
                };
                DataPool.prototype.get = function (iHandle) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 331);
                        akra.logger.assert(this.isInitialized() == true, "the cDataPool is not initialized");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("DataPool.ts", 332);
                        akra.logger.assert(this.pGroupList.length != 0, "The cDataPool has not been properly created");
                    }
                    ;
                    var pGroup = this.getGroup(this.getGroupNumber(iHandle));
                    var iItemIndex = this.getItemIndex(iHandle);
                    return pGroup.member(iItemIndex);
                };
                DataPool.prototype.getPtr = function (iHandle) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 341);
                        akra.logger.assert(this.isInitialized() == true, "the cDataPool is not initialized");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("DataPool.ts", 342);
                        akra.logger.assert(this.pGroupList.length != 0, "The cDataPool has not been properly created");
                    }
                    ;
                    var pGroup = this.getGroup(this.getGroupNumber(iHandle));
                    var iItemIndex = this.getItemIndex(iHandle);
                    return pGroup.memberPtr(iItemIndex);
                };
                DataPool.prototype.getGenericPtr = function (iHandle) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 351);
                        akra.logger.assert(this.isInitialized() == true, "the cDataPool is not initialized");
                    }
                    ;
                    return this.getPtr(iHandle);
                };
                DataPool.prototype.getGroupNumber = function (iHandle) {
                    return iHandle >> this.iIndexShift;
                };
                DataPool.prototype.getItemIndex = function (iHandle) {
                    return iHandle & this.iIndexMask;
                };
                DataPool.prototype.buildHandle = function (iGroup, iIndex) {
                    return (iGroup << this.iIndexShift) + iIndex;
                };
                DataPool.prototype.addGroup = function () {
                    var pNewGroup = new PoolGroup(this.pManager, this.tTemplate, this.iGroupCount);
                    this.pGroupList.push(pNewGroup);
                    pNewGroup.create();
                    this.iTotalMembers += this.iGroupCount;
                    this.iTotalOpen += this.iGroupCount;
                    return pNewGroup;
                };
                DataPool.prototype.findOpenGroup = function (pGroupNumber) {
                    pGroupNumber.value = 0;
                    for(var iGroupIter = 0; iGroupIter < this.pGroupList.length; iGroupIter++) {
                        if (this.pGroupList[iGroupIter].totalOpen > 0) {
                            return this.pGroupList[iGroupIter];
                        }
                        pGroupNumber.value++;
                    }
 {
                        akra.logger.setSourceLocation("DataPool.ts", 411);
                        akra.logger.assert((this.pGroupList.length + 1) < akra.MAX_UINT16, "the cDataPool is full!!!!");
                    }
                    ;
                    return this.addGroup();
                };
                DataPool.prototype.getGroup = function (iIndex) {
 {
                        akra.logger.setSourceLocation("DataPool.ts", 422);
                        akra.logger.assert(iIndex < this.pGroupList.length, "Invalid group index requested");
                    }
                    ;
                    return this.pGroupList[iIndex];
                };
                return DataPool;
            })();
            pool.DataPool = DataPool;            
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            var ResourcePoolItem = (function (_super) {
                __extends(ResourcePoolItem, _super);
                function ResourcePoolItem() {
                                _super.call(this);
                    this.pResourcePool = null;
                    this.iResourceHandle = 0;
                    this.iResourceFlags = 0;
                    this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                    this._pUnicastSlotMap = null;
                    this._pBroadcastSlotList = null;
                    this.pResourceCode = new pool.ResourceCode(0);
                    this.pCallbackFunctions = [];
                    this.pStateWatcher = [];
                    this.pCallbackSlots = akra.genArray(null, akra.EResourceItemEvents.TOTALRESOURCEFLAGS);
                }
                Object.defineProperty(ResourcePoolItem.prototype, "resourceCode", {
                    get: function () {
                        return this.pResourceCode;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolItem.prototype, "resourcePool", {
                    get: function () {
                        return this.pResourcePool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolItem.prototype, "resourceHandle", {
                    get: function () {
                        return this.iResourceHandle;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolItem.prototype, "resourceFlags", {
                    get: function () {
                        return this.iResourceFlags;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolItem.prototype, "alteredFlag", {
                    get: function () {
                        return ((((this.iResourceFlags) & ((1 << ((/*checked (origin: akra)>>*/akra.EResourceItemEvents.ALTERED))))) != 0));
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolItem.prototype, "manager", {
                    get: function () {
                        return this.getManager();
                    },
                    enumerable: true,
                    configurable: true
                });
                ResourcePoolItem.prototype.getEngine = function () {
                    var pManager = this.getManager();
                    if (pManager) {
                        return pManager.getEngine();
                    }
                    return null;
                };
                ResourcePoolItem.prototype.getManager = function () {
                    return (this.pResourcePool).manager;
                };
                ResourcePoolItem.prototype.createResource = function () {
                    return false;
                };
                ResourcePoolItem.prototype.destroyResource = function () {
                    return false;
                };
                ResourcePoolItem.prototype.disableResource = function () {
                    return false;
                };
                ResourcePoolItem.prototype.restoreResource = function () {
                    return false;
                };
                ResourcePoolItem.prototype.loadResource = function (sFilename) {
                    if (typeof sFilename === "undefined") { sFilename = null; }
                    return false;
                };
                ResourcePoolItem.prototype.saveResource = function (sFilename) {
                    if (typeof sFilename === "undefined") { sFilename = null; }
                    return false;
                };
                ResourcePoolItem.prototype.setChangesNotifyRoutine = function (fn) {
                    for(var i = 0; i < this.pCallbackFunctions.length; i++) {
                        if (this.pCallbackFunctions[i] == fn) {
                            return;
                        }
                    }
                    this.pCallbackFunctions.push(fn);
                };
                ResourcePoolItem.prototype.delChangesNotifyRoutine = function (fn) {
                    for(var i = 0; i < this.pCallbackFunctions.length; i++) {
                        if (this.pCallbackFunctions[i] == fn) {
                            this.pCallbackFunctions[i] = null;
                        }
                    }
                };
                ResourcePoolItem.prototype.setStateWatcher = function (eEvent, fnWatcher) {
                    this.pStateWatcher[eEvent] = fnWatcher;
                };
                ResourcePoolItem.prototype.sync = function (pResourceItem, eSignal, eSlot) {
                    eSlot = ((eSlot) !== undefined) ? eSlot : eSignal;
                    eSlot = ResourcePoolItem.parseEvent(eSlot);
                    eSignal = ResourcePoolItem.parseEvent(eSignal);
                    var pSlots = this.pCallbackSlots, pSignSlots;
                    var me = this;
                    var n;
                    var fn;
                    var bState;
                    if (((pSlots[eSlot]) === null)) {
                        pSlots[eSlot] = [];
                    }
                    pSignSlots = pSlots[eSlot];
                    n = pSignSlots.length;
                    bState = ((((pResourceItem.resourceFlags) & ((1 << ((eSignal))))) != 0));
                    fn = function (eFlag, iResourceFlags, isSet) {
                        if (eFlag == eSignal) {
                            pSignSlots[n].bState = isSet;
                            me.notifyStateChange(eSlot, this);
                            for(var i = 0; i < pSignSlots.length; ++i) {
                                if (pSignSlots[i].bState === false) {
                                    if (((((me.resourceFlags) & ((1 << ((eFlag))))) != 0))) {
                                        me.setResourceFlag(eFlag, false);
                                    }
                                    return;
                                }
                            }
                            me.setResourceFlag(eFlag, true);
                        }
                    };
                    pSignSlots.push({
                        bState: bState,
                        fn: fn,
                        pResourceItem: pResourceItem
                    });
                    fn.call(pResourceItem, eSignal, pResourceItem.resourceFlags, bState);
                    pResourceItem.setChangesNotifyRoutine(fn);
                    return true;
                };
                ResourcePoolItem.prototype.unsync = function (pResourceItem, eSignal, eSlot) {
                    eSlot = ((eSlot) !== undefined) ? eSlot : eSignal;
                    eSlot = ResourcePoolItem.parseEvent(eSlot);
                    eSignal = ResourcePoolItem.parseEvent(eSignal);
                    var pSlots = this.pCallbackSlots, pSignSlots;
                    var me = this;
                    var isRem = false;
                    pSignSlots = pSlots[eSlot];
                    for(var i = 0, n = pSignSlots.length; i < n; ++i) {
                        if (pSignSlots[i].pResourceItem === pResourceItem) {
                            pSignSlots[i].pResourceItem.delChangesNotifyRoutine(pSignSlots[i].fn);
                            pSignSlots.splice(i, 1);
                            --n;
                            --i;
                            isRem = true;
                        }
                    }
                    return isRem;
                };
                ResourcePoolItem.prototype.isResourceCreated = function () {
                    return ((((this.iResourceFlags) & ((1 << ((/*checked (origin: akra)>>*/akra.EResourceItemEvents.CREATED))))) != 0));
                };
                ResourcePoolItem.prototype.isResourceLoaded = function () {
                    return ((((this.iResourceFlags) & ((1 << ((/*checked (origin: akra)>>*/akra.EResourceItemEvents.LOADED))))) != 0));
                };
                ResourcePoolItem.prototype.isResourceDisabled = function () {
                    return ((((this.iResourceFlags) & ((1 << ((/*checked (origin: akra)>>*/akra.EResourceItemEvents.DISABLED))))) != 0));
                };
                ResourcePoolItem.prototype.isResourceAltered = function () {
                    return ((((this.iResourceFlags) & ((1 << ((/*checked (origin: akra)>>*/akra.EResourceItemEvents.ALTERED))))) != 0));
                };
                ResourcePoolItem.prototype.setAlteredFlag = function (isOn) {
                    if (typeof isOn === "undefined") { isOn = true; }
                    if (this.setResourceFlag(akra.EResourceItemEvents.ALTERED, isOn) || isOn) {
                        isOn ? this.altered() : this.saved();
                        return true;
                    }
                    return false;
                };
                ResourcePoolItem.prototype.setResourceName = function (sName) {
                    if (this.pResourcePool != null) {
                        this.pResourcePool.setResourceName(this.iResourceHandle, sName);
                    }
                };
                ResourcePoolItem.prototype.findResourceName = function () {
                    if (this.pResourcePool != null) {
                        return this.pResourcePool.findResourceName(this.iResourceHandle);
                    }
                    return null;
                };
                ResourcePoolItem.prototype.release = function () {
                    var iRefCount = _super.prototype.release.call(this);
                    if (iRefCount == 0) {
                        if (this.pResourcePool != null) {
                            this.pResourcePool.destroyResource(this);
                        }
                    }
                    return iRefCount;
                };
                ResourcePoolItem.prototype.notifyCreated = function () {
                    if (this.setResourceFlag(akra.EResourceItemEvents.CREATED, true)) {
                        this.created();
                    }
                };
                ResourcePoolItem.prototype.notifyDestroyed = function () {
                    if (this.setResourceFlag(akra.EResourceItemEvents.CREATED, false)) {
                        this.destroyed();
                    }
                };
                ResourcePoolItem.prototype.notifyLoaded = function () {
                    this.setAlteredFlag(false);
                    if (this.setResourceFlag(akra.EResourceItemEvents.LOADED, true)) {
                        this.loaded();
                    }
                };
                ResourcePoolItem.prototype.notifyUnloaded = function () {
                    if (this.setResourceFlag(akra.EResourceItemEvents.LOADED, false)) {
                        this.unloaded();
                    }
                };
                ResourcePoolItem.prototype.notifyRestored = function () {
                    if (this.setResourceFlag(akra.EResourceItemEvents.DISABLED, false)) {
                        this.restored();
                    }
                };
                ResourcePoolItem.prototype.notifyDisabled = function () {
                    if (this.setResourceFlag(akra.EResourceItemEvents.DISABLED, true)) {
                        this.disabled();
                    }
                };
                ResourcePoolItem.prototype.notifyAltered = function () {
                    this.setAlteredFlag(true);
                };
                ResourcePoolItem.prototype.notifySaved = function () {
                    this.setAlteredFlag(false);
                };
                ResourcePoolItem.prototype.setResourceCode = function (pCode) {
                    this.pResourceCode.eq(pCode);
                };
                ResourcePoolItem.prototype.setResourcePool = function (pPool) {
                    this.pResourcePool = pPool;
                };
                ResourcePoolItem.prototype.setResourceHandle = function (iHandle) {
                    this.iResourceHandle = iHandle;
                };
                ResourcePoolItem.prototype.notifyStateChange = function (eEvent, pTarget) {
                    if (typeof pTarget === "undefined") { pTarget = null; }
                    if (!this.pStateWatcher[eEvent]) {
                        return;
                    }
                    var pSignSlots = this.pCallbackSlots[eEvent];
                    var nTotal = pSignSlots.length, nLoaded = 0;
                    for(var i = 0; i < nTotal; ++i) {
                        if (pSignSlots[i].bState) {
                            ++nLoaded;
                        }
                    }
                    this.pStateWatcher[eEvent](nLoaded, nTotal, pTarget);
                };
                ResourcePoolItem.prototype.setResourceFlag = function (iFlagBit, isSetting) {
                    var iTempFlags = this.iResourceFlags;
                    this.iResourceFlags = (((isSetting) ? ((this.iResourceFlags) |= ((1 << ((iFlagBit))))) : ((((this.iResourceFlags)) &= ~((1 << (((iFlagBit)))))))));
                    if (iTempFlags != this.iResourceFlags) {
                        for(var i = 0; i < this.pCallbackFunctions.length; i++) {
                            if (this.pCallbackFunctions[i]) {
                                this.pCallbackFunctions[i].call(this, iFlagBit, this.iResourceFlags, isSetting);
                            }
                        }
                        return true;
                    }
                    return false;
                };
                ResourcePoolItem.parseEvent = function parseEvent(pEvent) {
                    if ((typeof (pEvent) === "number")) {
                        return pEvent;
                    }
                    switch(pEvent.toLowerCase()) {
                        case 'loaded':
                            return akra.EResourceItemEvents.LOADED;
                        case 'created':
                            return akra.EResourceItemEvents.CREATED;
                        case 'disabled':
                            return akra.EResourceItemEvents.DISABLED;
                        case 'altered':
                            return akra.EResourceItemEvents.ALTERED;
                        default:
 {
                                akra.logger.setSourceLocation("../ResourcePoolItem.ts", 382);
                                akra.logger.error('Использовано неизвестное событие для ресурса.');
                            }
                            ;
                            return 0;
                    }
                };
                ResourcePoolItem.prototype.getGuid = function () {
                    return this._iGuid;
                };
                ResourcePoolItem._pEventTable = new akra.events.EventTable();
                ResourcePoolItem.prototype.getEventTable = function () {
                    return ResourcePoolItem._pEventTable;
                };
                ResourcePoolItem.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                    return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
                };
                ResourcePoolItem.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                    return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
                };
                ResourcePoolItem.prototype.bind = function (sSignal, fnListener, eType) {
                    return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
                };
                ResourcePoolItem.prototype.unbind = function (sSignal, fnListener, eType) {
                    return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
                };
                ResourcePoolItem.prototype._syncTable = function (pFrom) {
                    this.getEventTable()._sync(this, pFrom);
                };
                ResourcePoolItem.prototype.created = function () {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).created;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                        }
                    }
                };
                ResourcePoolItem.prototype.destroyed = function () {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).destroyed;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                        }
                    }
                };
                ResourcePoolItem.prototype.loaded = function () {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).loaded;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                        }
                    }
                };
                ResourcePoolItem.prototype.unloaded = function () {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).unloaded;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                        }
                    }
                };
                ResourcePoolItem.prototype.restored = function () {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).restored;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                        }
                    }
                };
                ResourcePoolItem.prototype.disabled = function () {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).disabled;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                        }
                    }
                };
                ResourcePoolItem.prototype.altered = function () {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).altered;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                        }
                    }
                };
                ResourcePoolItem.prototype.saved = function () {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).saved;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                        }
                    }
                };
                return ResourcePoolItem;
            })(akra.util.ReferenceCounter);
            pool.ResourcePoolItem = ResourcePoolItem;            
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                var RenderMethod = (function (_super) {
                    __extends(RenderMethod, _super);
                    function RenderMethod() {
                        _super.apply(this, arguments);

                        this._pEffect = null;
                        this._pSurfaceMaterial = null;
                    }
                    Object.defineProperty(RenderMethod.prototype, "effect", {
                        get: function () {
                            return this._pEffect;
                        },
                        set: function (pEffect) {
                            if (!((this._pEffect) === null)) {
                                this.unsync(this._pEffect, akra.EResourceItemEvents.LOADED);
                                this.disconnect(this._pEffect, "altered", "notifyAltered", akra.EEventTypes.BROADCAST);
                                this._pEffect.release();
                            }
                            this._pEffect = pEffect;
                            if (!((pEffect) === null)) {
                                this.sync(this._pEffect, akra.EResourceItemEvents.LOADED);
                                this.connect(this._pEffect, "altered", "notifyAltered", akra.EEventTypes.BROADCAST);
                            }
                            this._pEffect.addRef();
                            this.notifyAltered();
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(RenderMethod.prototype, "surfaceMaterial", {
                        get: function () {
                            return this._pSurfaceMaterial;
                        },
                        set: function (pMaterial) {
                            if (!((this._pSurfaceMaterial) === null)) {
                                this.unsync(this._pSurfaceMaterial, akra.EResourceItemEvents.LOADED);
                                this.disconnect(this._pSurfaceMaterial, "altered", "notifyAltered", akra.EEventTypes.BROADCAST);
                                this._pSurfaceMaterial.release();
                            }
                            this._pSurfaceMaterial = pMaterial;
                            if (!((pMaterial) === null)) {
                                this.sync(this._pSurfaceMaterial, akra.EResourceItemEvents.LOADED);
                                this.connect(this._pSurfaceMaterial, "altered", "notifyAltered", akra.EEventTypes.BROADCAST);
                            }
                            this._pSurfaceMaterial.addRef();
                            this.notifyAltered();
                        },
                        enumerable: true,
                        configurable: true
                    });
                    RenderMethod.prototype.isEqual = function (pRenderMethod) {
                        return false;
                    };
                    return RenderMethod;
                })(pool.ResourcePoolItem);
                resources.RenderMethod = RenderMethod;                
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    akra.DeclarationUsages = {
        POSITION: "POSITION",
        POSITION1: "POSITION1",
        POSITION2: "POSITION2",
        POSITION3: "POSITION3",
        BLENDWEIGHT: "BLENDWEIGHT",
        BLENDINDICES: "BLENDINDICES",
        BLENDMETA: "BLENDMETA",
        NORMAL: "NORMAL",
        NORMAL1: "NORMAL1",
        NORMAL2: "NORMAL2",
        NORMAL3: "NORMAL3",
        PSIZE: "PSIZE",
        TEXCOORD: "TEXCOORD",
        TEXCOORD1: "TEXCOORD1",
        TEXCOORD2: "TEXCOORD2",
        TEXCOORD3: "TEXCOORD3",
        TEXCOORD4: "TEXCOORD4",
        TEXCOORD5: "TEXCOORD5",
        TANGENT: "TANGENT",
        BINORMAL: "BINORMAL",
        TESSFACTOR: "TESSFACTOR",
        COLOR: "COLOR",
        FOG: "FOG",
        DEPTH: "DEPTH",
        SAMPLE: "SAMPLE",
        INDEX: "INDEX",
        INDEX0: "INDEX0",
        INDEX1: "INDEX1",
        INDEX2: "INDEX2",
        INDEX3: "INDEX3",
        INDEX10: "INDEX10",
        INDEX11: "INDEX11",
        INDEX12: "INDEX12",
        INDEX13: "INDEX13",
        MATERIAL: "MATERIAL",
        MATERIAL1: "MATERIAL1",
        MATERIAL2: "MATERIAL2",
        DIFFUSE: "DIFFUSE",
        AMBIENT: "AMBIENT",
        SPECULAR: "SPECULAR",
        EMISSIVE: "EMISSIVE",
        SHININESS: "SHININESS",
        TEXTURE_HEADER: "TEXTURE_HEADER",
        UNKNOWN: "UNKNOWN",
        END: "\a\n\r"
    };
    akra.DeclUsages = akra.DeclarationUsages;
    function VE_CUSTOM(sUsage, eType, iCount, iOffset) {
        if (typeof eType === "undefined") { eType = akra.EDataTypes.FLOAT; }
        if (typeof iCount === "undefined") { iCount = 1; }
        if (typeof iOffset === "undefined") { iOffset = akra.MAX_INT32; }
        return {
            count: iCount,
            type: eType,
            usage: sUsage,
            offset: iOffset
        };
    }
    akra.VE_CUSTOM = VE_CUSTOM;
    function VE_FLOAT(sUsage, iOffset) {
        if (typeof iOffset === "undefined") { iOffset = akra.MAX_INT32; }
        return VE_CUSTOM(sUsage, akra.EDataTypes.FLOAT, 1, iOffset);
    }
    akra.VE_FLOAT = VE_FLOAT;
    ;
    function VE_FLOAT2(sUsage, iOffset) {
        if (typeof iOffset === "undefined") { iOffset = akra.MAX_INT32; }
        return VE_CUSTOM(sUsage, akra.EDataTypes.FLOAT, 2, iOffset);
    }
    akra.VE_FLOAT2 = VE_FLOAT2;
    ;
    function VE_FLOAT3(sUsage, iOffset) {
        if (typeof iOffset === "undefined") { iOffset = akra.MAX_INT32; }
        return VE_CUSTOM(sUsage, akra.EDataTypes.FLOAT, 3, iOffset);
    }
    akra.VE_FLOAT3 = VE_FLOAT3;
    ;
    function VE_FLOAT4(sUsage, iOffset) {
        if (typeof iOffset === "undefined") { iOffset = akra.MAX_INT32; }
        return VE_CUSTOM(sUsage, akra.EDataTypes.FLOAT, 4, iOffset);
    }
    akra.VE_FLOAT4 = VE_FLOAT4;
    ;
    function VE_FLOAT4x4(sUsage, iOffset) {
        if (typeof iOffset === "undefined") { iOffset = akra.MAX_INT32; }
        return VE_CUSTOM(sUsage, akra.EDataTypes.FLOAT, 16, iOffset);
    }
    akra.VE_FLOAT4x4 = VE_FLOAT4x4;
    ;
    function VE_VEC2(sUsage, iOffset) {
        if (typeof iOffset === "undefined") { iOffset = akra.MAX_INT32; }
        return VE_CUSTOM(sUsage, akra.EDataTypes.FLOAT, 2, iOffset);
    }
    akra.VE_VEC2 = VE_VEC2;
    ;
    function VE_VEC3(sUsage, iOffset) {
        if (typeof iOffset === "undefined") { iOffset = akra.MAX_INT32; }
        return VE_CUSTOM(sUsage, akra.EDataTypes.FLOAT, 3, iOffset);
    }
    akra.VE_VEC3 = VE_VEC3;
    ;
    function VE_VEC4(sUsage, iOffset) {
        if (typeof iOffset === "undefined") { iOffset = akra.MAX_INT32; }
        return VE_CUSTOM(sUsage, akra.EDataTypes.FLOAT, 4, iOffset);
    }
    akra.VE_VEC4 = VE_VEC4;
    ;
    function VE_MAT4(sUsage, iOffset) {
        if (typeof iOffset === "undefined") { iOffset = akra.MAX_INT32; }
        return VE_CUSTOM(sUsage, akra.EDataTypes.FLOAT, 16, iOffset);
    }
    akra.VE_MAT4 = VE_MAT4;
    ;
    function VE_INT(sUsage, iOffset) {
        if (typeof iOffset === "undefined") { iOffset = akra.MAX_INT32; }
        return VE_CUSTOM(sUsage, akra.EDataTypes.INT, 1, iOffset);
    }
    akra.VE_INT = VE_INT;
    ;
    function VE_END(iOffset) {
        if (typeof iOffset === "undefined") { iOffset = 0; }
        return VE_CUSTOM(akra.DeclUsages.END, akra.EDataTypes.UNSIGNED_BYTE, 0, iOffset);
    }
    akra.VE_END = VE_END;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (data) {
        var VertexElement = (function () {
            function VertexElement(nCount, eType, eUsage, iOffset) {
                if (typeof nCount === "undefined") { nCount = 1; }
                if (typeof eType === "undefined") { eType = akra.EDataTypes.FLOAT; }
                if (typeof eUsage === "undefined") { eUsage = akra.DeclarationUsages.POSITION; }
                if (typeof iOffset === "undefined") { iOffset = akra.MAX_INT32; }
                this.size = 0;
                this.index = 0;
                this.semantics = akra.DeclarationUsages.UNKNOWN;
                this.count = nCount;
                this.type = eType;
                this.usage = eUsage;
                this.offset = iOffset;
                this.update();
            }
            VertexElement.prototype.update = function () {
                this.size = this.count * akra.getTypeSize(this.type);
                this.index = 0;
                this.semantics = null;
                var pMatches = this.usage.match(/^(.*?\w)(\d+)$/i);
                if (!((pMatches) === null)) {
                    this.semantics = pMatches[1];
                    this.index = parseInt(pMatches[2]);
                } else {
                    this.semantics = this.usage;
                }
            };
            VertexElement.prototype.clone = function () {
                return new VertexElement(this.count, this.type, this.usage, this.offset);
            };
            VertexElement.hasUnknownOffset = function hasUnknownOffset(pElement) {
                return (!((pElement.offset) !== undefined) || (pElement.offset === akra.MAX_INT32));
            };
            VertexElement.prototype.isEnd = function () {
                return this.semantics === akra.DeclUsages.END;
            };
            VertexElement.prototype.toString = function () {
                function _an(data, n, bBackward) {
                    if (typeof bBackward === "undefined") { bBackward = false; }
                    var s = String(data);
                    for(var i = 0, t = n - s.length; i < t; ++i) {
                        if (bBackward) {
                            s = " " + s;
                        } else {
                            s += " ";
                        }
                    }
                    return s;
                }
                var s = "[ USAGE: " + _an(this.usage == akra.DeclUsages.END ? "<END>" : this.usage, 12) + ", OFFSET " + _an(this.offset, 4) + ", SIZE " + _an(this.size, 4) + " ]";
                return s;
            };
            return VertexElement;
        })();
        data.VertexElement = VertexElement;        
    })(akra.data || (akra.data = {}));
    var data = akra.data;
})(akra || (akra = {}));
var akra;
(function (akra) {
    akra.VertexElement = akra.data.VertexElement;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (data) {
        var VertexDeclaration = (function () {
            function VertexDeclaration(pElements) {
                this.stride = 0;
                this._pElements = [];
                if (arguments.length > 0 && ((pElements) != null)) {
                    this.append.apply(this, arguments);
                }
            }
            Object.defineProperty(VertexDeclaration.prototype, "length", {
                get: function () {
                    return this._pElements.length;
                },
                enumerable: true,
                configurable: true
            });
            VertexDeclaration.prototype.element = function (i) {
                return this._pElements[i] || null;
            };
            VertexDeclaration.prototype.append = function (pData) {
                var pElements;
                if (!akra.isArray(arguments[0])) {
                    pElements = arguments;
                } else {
                    pElements = arguments[0];
                }
                for(var i = 0; i < pElements.length; i++) {
                    var pElement = pElements[i];
                    var iOffset;
                    if (data.VertexElement.hasUnknownOffset(pElement)) {
                        iOffset = this.stride;
                    } else {
                        iOffset = pElement.offset;
                    }
                    var pVertexElement = new data.VertexElement(pElement.count, pElement.type, pElement.usage, iOffset);
                    this._pElements.push(pVertexElement);
                    var iStride = iOffset + pVertexElement.size;
                    if (this.stride < iStride) {
                        this.stride = iStride;
                    }
                }
                return this._update();
            };
            VertexDeclaration.prototype._update = function () {
                var iStride;
                for(var i = 0; i < this.length; ++i) {
                    if (this._pElements[i].usage === akra.DeclUsages.END) {
                        this._pElements.swap(i, i + 1);
                    }
                    iStride = this._pElements[i].size + this._pElements[i].offset;
                    if (this.stride < iStride) {
                        this.stride = iStride;
                    }
                }
                var pLast = this._pElements.last;
                if (pLast.usage === akra.DeclUsages.END && pLast.offset < this.stride) {
                    pLast.offset = this.stride;
                }
                return true;
            };
            VertexDeclaration.prototype.extend = function (decl) {
                var pDecl = decl;
                var pElement;
                for(var i = 0; i < this.length; ++i) {
                    for(var j = 0; j < pDecl.length; ++j) {
                        if (pDecl.element(j).usage == this._pElements[i].usage) {
 {
                                akra.logger.setSourceLocation("data/VertexDeclaration.ts", 110);
                                akra.logger.log('inconsistent declarations:', this, pDecl);
                            }
                            ;
 {
                                akra.logger.setSourceLocation("data/VertexDeclaration.ts", 111);
                                akra.logger.error('The attempt to combine the declaration containing the exact same semantics.');
                            }
                            ;
                            return false;
                        }
                    }
                }
                for(var i = 0; i < pDecl.length; i++) {
                    pElement = pDecl.element(i).clone();
                    pElement.offset += this.stride;
                    this._pElements.push(pElement);
                }
                return this._update();
            };
            VertexDeclaration.prototype.hasSemantics = function (sSemantics) {
                return this.findElement(sSemantics) !== null;
            };
            VertexDeclaration.prototype.findElement = function (sSemantics, iCount) {
                if (typeof iCount === "undefined") { iCount = akra.MAX_INT32; }
                sSemantics = sSemantics.toUpperCase();
                for(var i = 0; i < this.length; ++i) {
                    if (this._pElements[i].usage === sSemantics && (iCount === akra.MAX_INT32 || this._pElements[i].count == iCount)) {
                        return this._pElements[i];
                    }
                }
                return null;
            };
            VertexDeclaration.prototype.clone = function () {
                var pElements = [];
                var pDecl;
                for(var i = 0; i < this.length; ++i) {
                    pElements.push(this._pElements[i].clone());
                }
                pDecl = new VertexDeclaration(pElements);
                if (pDecl._update()) {
                    return pDecl;
                }
                return null;
            };
            VertexDeclaration.prototype.toString = function () {
                var s = "\n";
                s += "  VERTEX DECLARATION ( " + this.stride + " b. ) \n";
                s += "---------------------------------------\n";
                for(var i = 0; i < this.length; ++i) {
                    s += this._pElements[i].toString() + '\n';
                }
                return s;
            };
            return VertexDeclaration;
        })();
        data.VertexDeclaration = VertexDeclaration;        
    })(akra.data || (akra.data = {}));
    var data = akra.data;
})(akra || (akra = {}));
var akra;
(function (akra) {
    akra.VertexDeclaration = akra.data.VertexDeclaration;
    akra.createVertexDeclaration = function (pData) {
        if (!(pData instanceof akra.VertexDeclaration)) {
            if (!(pData instanceof Array) && ((pData) != null)) {
                pData = [
                    pData
                ];
            }
            pData = new akra.VertexDeclaration(pData);
        }
        return pData;
    };
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        var Color = (function () {
            function Color(r, g, b, a) {
                this.set.apply(this, arguments);
            }
            Object.defineProperty(Color.prototype, "html", {
                get: function () {
                    var r = akra.math.round(this.r * 255).toString(16);
                    var g = akra.math.round(this.g * 255).toString(16);
                    var b = akra.math.round(this.b * 255).toString(16);
                    r = r.length < 2 ? "0" + r : r;
                    g = g.length < 2 ? "0" + g : g;
                    b = b.length < 2 ? "0" + b : b;
                    return "#" + r + g + b;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Color.prototype, "htmlRgba", {
                get: function () {
                    return "rgba(" + akra.math.floor(255 * this.r) + ", " + akra.math.floor(255 * this.g) + ", " + akra.math.floor(255 * this.b) + ", " + this.a + ")";
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Color.prototype, "rgba", {
                get: function () {
                    var val32 = 0;
                    val32 = (this.a * 255) << 24;
                    val32 += (this.b * 255) << 16;
                    val32 += (this.g * 255) << 8;
                    val32 += (this.r * 255);
                    val32 = val32 >>> 0;
                    return val32;
                },
                set: function (c) {
                    var val32 = c;
                    this.a = ((val32 >> 24) & 0xFF) / 255.0;
                    this.b = ((val32 >> 16) & 0xFF) / 255.0;
                    this.g = ((val32 >> 8) & 0xFF) / 255.0;
                    this.r = (val32 & 0xFF) / 255.0;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Color.prototype, "argb", {
                get: function () {
                    var val32 = 0;
                    val32 = (this.b * 255) << 24;
                    val32 += (this.g * 255) << 16;
                    val32 += (this.r * 255) << 8;
                    val32 += (this.a * 255);
                    val32 = val32 >>> 0;
                    return val32;
                },
                set: function (c) {
                    var val32 = c;
                    this.b = ((val32 >> 24) & 0xFF) / 255.0;
                    this.g = ((val32 >> 16) & 0xFF) / 255.0;
                    this.r = ((val32 >> 8) & 0xFF) / 255.0;
                    this.a = (val32 & 0xFF) / 255.0;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Color.prototype, "bgra", {
                get: function () {
                    var val32 = 0;
                    val32 = (this.a * 255) << 24;
                    val32 += (this.r * 255) << 16;
                    val32 += (this.g * 255) << 8;
                    val32 += (this.b * 255);
                    val32 = val32 >>> 0;
                    return val32;
                },
                set: function (c) {
                    var val32 = c;
                    this.a = ((val32 >> 24) & 0xFF) / 255.0;
                    this.r = ((val32 >> 16) & 0xFF) / 255.0;
                    this.g = ((val32 >> 8) & 0xFF) / 255.0;
                    this.b = (val32 & 0xFF) / 255.0;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Color.prototype, "abgr", {
                get: function () {
                    var val32 = 0;
                    val32 = (this.r * 255) << 24;
                    val32 += (this.g * 255) << 16;
                    val32 += (this.b * 255) << 8;
                    val32 += (this.a * 255);
                    val32 = val32 >>> 0;
                    return val32;
                },
                set: function (c) {
                    var val32 = c;
                    this.r = ((val32 >> 24) & 0xFF) / 255.0;
                    this.g = ((val32 >> 16) & 0xFF) / 255.0;
                    this.b = ((val32 >> 8) & 0xFF) / 255.0;
                    this.a = (val32 & 0xFF) / 255.0;
                },
                enumerable: true,
                configurable: true
            });
            Color.prototype.set = function (r, g, b, a) {
                switch(arguments.length) {
                    case 0:
                        this.r = this.g = this.b = 0.;
                        this.a = 1.;
                        break;
                    case 1:
                        if ((typeof (arguments[0]) === "number")) {
                            this.r = this.g = this.b = r;
                            this.a = 1.;
                        } else if (((arguments[0].buffer) !== undefined)) {
                            var c = arguments[0];
                            this.r = c[0];
                            this.g = c[1];
                            this.b = c[2];
                            this.a = c[3];
                        } else {
                            var v = arguments[0];
                            this.r = v.r;
                            this.g = v.g;
                            this.b = v.b;
                            this.a = v.a;
                        }
                        break;
                    case 2:
                        this.r = this.g = this.b = r;
                        this.a = g;
                        break;
                    case 3:
                    case 4:
                        this.r = r;
                        this.g = g;
                        this.b = b;
                        this.a = ((a) !== undefined) ? a : 1.;
                        break;
                }
                return this;
            };
            Color.prototype.saturate = function () {
                if (this.r < 0.) {
                    this.r = 0.;
                } else if (this.r > 1.) {
                    this.r = 1.;
                }
                if (this.g < 0.) {
                    this.g = 0.;
                } else if (this.g > 1.) {
                    this.g = 1.;
                }
                if (this.b < 0.) {
                    this.b = 0.;
                } else if (this.b > 1.) {
                    this.b = 1.;
                }
                if (this.a < 0.) {
                    this.a = 0.;
                } else if (this.a > 1.) {
                    this.a = 1.;
                }
                return this;
            };
            Color.prototype.saturateCopy = function () {
                var ret = new Color(this);
                ret.saturate();
                return ret;
            };
            Color.prototype.add = function (cColor, ppDest) {
                if (typeof ppDest === "undefined") { ppDest = new Color(); }
                ppDest.r = this.r + cColor.r;
                ppDest.g = this.g + cColor.g;
                ppDest.b = this.b + cColor.b;
                ppDest.a = this.a + cColor.a;
                return ppDest;
            };
            Color.prototype.subtract = function (cColor, ppDest) {
                if (typeof ppDest === "undefined") { ppDest = new Color(); }
                ppDest.r = this.r - cColor.r;
                ppDest.g = this.g - cColor.g;
                ppDest.b = this.b - cColor.b;
                ppDest.a = this.a - cColor.a;
                return ppDest;
            };
            Color.prototype.multiply = function (fScalar, ppDest) {
                if (typeof ppDest === "undefined") { ppDest = new Color(); }
                if ((typeof (fScalar) === "number")) {
                    var f = fScalar;
                    ppDest.r = this.r * f;
                    ppDest.g = this.g * f;
                    ppDest.b = this.b * f;
                    ppDest.a = this.a * f;
                } else {
                    var c = arguments[0];
                    ppDest.r = this.r * c.r;
                    ppDest.g = this.g * c.g;
                    ppDest.b = this.b * c.b;
                    ppDest.a = this.a * c.a;
                }
                return ppDest;
            };
            Color.prototype.divide = function (fScalar, ppDest) {
                if (typeof ppDest === "undefined") { ppDest = new Color(); }
                if ((typeof (fScalar) === "number")) {
                    var f = fScalar;
                    ppDest.r = this.r / f;
                    ppDest.g = this.g / f;
                    ppDest.b = this.b / f;
                    ppDest.a = this.a / f;
                } else {
                    var c = arguments[0];
                    ppDest.r = this.r / c.r;
                    ppDest.g = this.g / c.g;
                    ppDest.b = this.b / c.b;
                    ppDest.a = this.a / c.a;
                }
                return ppDest;
            };
            Color.prototype.setHSB = function (fHue, fSaturation, fBrightness) {
                if (fHue > 1.0) {
                    fHue -= fHue;
                } else if (fHue < 0.0) {
                    fHue += fHue + 1;
                }
                fSaturation = akra.math.min(fSaturation, 1.0);
                fSaturation = akra.math.max(fSaturation, 0.0);
                fBrightness = akra.math.min(fBrightness, 1.0);
                fBrightness = akra.math.max(fBrightness, 0.0);
                if (fBrightness == 0.0) {
                    this.r = this.g = this.b = 0.0;
                    return;
                }
                if (fSaturation == 0.0) {
                    this.r = this.g = this.b = fBrightness;
                    return;
                }
                var fHueDomain = fHue * 6.0;
                if (fHueDomain >= 6.0) {
                    fHueDomain = 0.0;
                }
                var domain = fHueDomain;
                var f1 = fBrightness * (1 - fSaturation);
                var f2 = fBrightness * (1 - fSaturation * (fHueDomain - domain));
                var f3 = fBrightness * (1 - fSaturation * (1 - (fHueDomain - domain)));
                switch(domain) {
                    case 0:
                        this.r = fBrightness;
                        this.g = f3;
                        this.b = f1;
                        break;
                    case 1:
                        this.r = f2;
                        this.g = fBrightness;
                        this.b = f1;
                        break;
                    case 2:
                        this.r = f1;
                        this.g = fBrightness;
                        this.b = f3;
                        break;
                    case 3:
                        this.r = f1;
                        this.g = f2;
                        this.b = fBrightness;
                        break;
                    case 4:
                        this.r = f3;
                        this.g = f1;
                        this.b = fBrightness;
                        break;
                    case 5:
                        this.r = fBrightness;
                        this.g = f1;
                        this.b = f2;
                        break;
                }
                return this;
            };
            Color.prototype.getHSB = function (pHsb) {
                if (typeof pHsb === "undefined") { pHsb = [
                    0., 
                    0., 
                    0.
                ]; }
                var vMin = akra.math.min(this.r, akra.math.min(this.g, this.b));
                var vMax = akra.math.max(this.r, akra.math.max(this.g, this.b));
                var delta = vMax - vMin;
                var brightness = vMax;
                var hue = 0.;
                var saturation;
                if (akra.math.isRealEqual(delta, 0.0, 1e-6)) {
                    hue = 0.;
                    saturation = 0.;
                } else {
                    saturation = delta / vMax;
                    var deltaR = (((vMax - this.r) / 6.0) + (delta / 2.0)) / delta;
                    var deltaG = (((vMax - this.g) / 6.0) + (delta / 2.0)) / delta;
                    var deltaB = (((vMax - this.b) / 6.0) + (delta / 2.0)) / delta;
                    if (akra.math.isRealEqual(this.r, vMax)) {
                        hue = deltaB - deltaG;
                    } else if (akra.math.isRealEqual(this.g, vMax)) {
                        hue = 0.3333333 + deltaR - deltaB;
                    } else if (akra.math.isRealEqual(this.b, vMax)) {
                        hue = 0.6666667 + deltaG - deltaR;
                    }
                    if (hue < 0.0) {
                        hue += 1.0;
                    }
                    if (hue > 1.0) {
                        hue -= 1.0;
                    }
                }
                pHsb[0] = hue;
                pHsb[1] = saturation;
                pHsb[2] = brightness;
                return pHsb;
            };
            Color.prototype.toString = function () {
                return "{R: " + this.r + ", G: " + this.g + ", B: " + this.b + ", A: " + this.a + "} " + "( 0x" + this.rgba.toString(16) + " )";
            };
            Color.toFloat32Array = function toFloat32Array(pValue) {
                var pArr = new Float32Array(4);
                pArr[0] = pValue.r;
                pArr[1] = pValue.g;
                pArr[2] = pValue.b;
                pArr[3] = pValue.a;
                return pArr;
            };
            Color.BLACK = new Color(0);
            Color.WHITE = new Color(0xFF, 0xFF, 0xFF);
            Color.ZERO = new Color(0., 0., 0., 0.);
            Color.isEqual = function isEqual(c1, c2) {
                return c1.r === c2.r && c1.g === c2.g && c1.b === c2.b && c1.a === c2.a;
            };
            Color.ALICE_BLUE = new Color(0xF0 / 255., 0xF8 / 255., 0xFF / 255.);
            Color.ANTIQUE_WHITE = new Color(0xFA / 255., 0xEB / 255., 0xD7 / 255.);
            Color.AQUA = new Color(0x00 / 255., 0xFF / 255., 0xFF / 255.);
            Color.AQUA_MARINE = new Color(0x7F / 255., 0xFF / 255., 0xD4 / 255.);
            Color.AZURE = new Color(0xF0 / 255., 0xFF / 255., 0xFF / 255.);
            Color.BEIGE = new Color(0xF5 / 255., 0xF5 / 255., 0xDC / 255.);
            Color.BISQUE = new Color(0xFF / 255., 0xE4 / 255., 0xC4 / 255.);
            Color.BLANCHED_ALMOND = new Color(0xFF / 255., 0xEB / 255., 0xCD / 255.);
            Color.BLUE = new Color(0x00 / 255., 0x00 / 255., 0xFF / 255.);
            Color.BLUE_VIOLET = new Color(0x8A / 255., 0x2B / 255., 0xE2 / 255.);
            Color.BROWN = new Color(0xA5 / 255., 0x2A / 255., 0x2A / 255.);
            Color.BURLY_WOOD = new Color(0xDE / 255., 0xB8 / 255., 0x87 / 255.);
            Color.CADET_BLUE = new Color(0x5F / 255., 0x9E / 255., 0xA0 / 255.);
            Color.CHARTREUSE = new Color(0x7F / 255., 0xFF / 255., 0x00 / 255.);
            Color.CHOCOLATE = new Color(0xD2 / 255., 0x69 / 255., 0x1E / 255.);
            Color.CORAL = new Color(0xFF / 255., 0x7F / 255., 0x50 / 255.);
            Color.CORNFLOWER_BLUE = new Color(0x64 / 255., 0x95 / 255., 0xED / 255.);
            Color.CORNSILK = new Color(0xFF / 255., 0xF8 / 255., 0xDC / 255.);
            Color.CRIMSON = new Color(0xDC / 255., 0x14 / 255., 0x3C / 255.);
            Color.CYAN = new Color(0x00 / 255., 0xFF / 255., 0xFF / 255.);
            Color.DARK_BLUE = new Color(0x00 / 255., 0x00 / 255., 0x8B / 255.);
            Color.DARK_CYAN = new Color(0x00 / 255., 0x8B / 255., 0x8B / 255.);
            Color.DARK_GOLDEN_ROD = new Color(0xB8 / 255., 0x86 / 255., 0x0B / 255.);
            Color.DARK_GRAY = new Color(0xA9 / 255., 0xA9 / 255., 0xA9 / 255.);
            Color.DARK_GREEN = new Color(0x00 / 255., 0x64 / 255., 0x00 / 255.);
            Color.DARK_KHAKI = new Color(0xBD / 255., 0xB7 / 255., 0x6B / 255.);
            Color.DARK_MAGENTA = new Color(0x8B / 255., 0x00 / 255., 0x8B / 255.);
            Color.DARK_OLIVE_GREEN = new Color(0x55 / 255., 0x6B / 255., 0x2F / 255.);
            Color.DARK_ORANGE = new Color(0xFF / 255., 0x8C / 255., 0x00 / 255.);
            Color.DARK_ORCHID = new Color(0x99 / 255., 0x32 / 255., 0xCC / 255.);
            Color.DARK_RED = new Color(0x8B / 255., 0x00 / 255., 0x00 / 255.);
            Color.DARK_SALMON = new Color(0xE9 / 255., 0x96 / 255., 0x7A / 255.);
            Color.DARK_SEA_GREEN = new Color(0x8F / 255., 0xBC / 255., 0x8F / 255.);
            Color.DARK_SLATE_BLUE = new Color(0x48 / 255., 0x3D / 255., 0x8B / 255.);
            Color.DARK_SLATE_GRAY = new Color(0x2F / 255., 0x4F / 255., 0x4F / 255.);
            Color.DARK_TURQUOISE = new Color(0x00 / 255., 0xCE / 255., 0xD1 / 255.);
            Color.DARK_VIOLET = new Color(0x94 / 255., 0x00 / 255., 0xD3 / 255.);
            Color.DEEP_PINK = new Color(0xFF / 255., 0x14 / 255., 0x93 / 255.);
            Color.DEEP_SKY_BLUE = new Color(0x00 / 255., 0xBF / 255., 0xFF / 255.);
            Color.DIM_GRAY = new Color(0x69 / 255., 0x69 / 255., 0x69 / 255.);
            Color.DIM_GREY = new Color(0x69 / 255., 0x69 / 255., 0x69 / 255.);
            Color.DODGER_BLUE = new Color(0x1E / 255., 0x90 / 255., 0xFF / 255.);
            Color.FIRE_BRICK = new Color(0xB2 / 255., 0x22 / 255., 0x22 / 255.);
            Color.FLORAL_WHITE = new Color(0xFF / 255., 0xFA / 255., 0xF0 / 255.);
            Color.FOREST_GREEN = new Color(0x22 / 255., 0x8B / 255., 0x22 / 255.);
            Color.FUCHSIA = new Color(0xFF / 255., 0x00 / 255., 0xFF / 255.);
            Color.GAINSBORO = new Color(0xDC / 255., 0xDC / 255., 0xDC / 255.);
            Color.GHOST_WHITE = new Color(0xF8 / 255., 0xF8 / 255., 0xFF / 255.);
            Color.GOLD = new Color(0xFF / 255., 0xD7 / 255., 0x00 / 255.);
            Color.GOLDEN_ROD = new Color(0xDA / 255., 0xA5 / 255., 0x20 / 255.);
            Color.GRAY = new Color(0x80 / 255., 0x80 / 255., 0x80 / 255.);
            Color.GREEN = new Color(0x00 / 255., 0x80 / 255., 0x00 / 255.);
            Color.GREEN_YELLOW = new Color(0xAD / 255., 0xFF / 255., 0x2F / 255.);
            Color.HONEY_DEW = new Color(0xF0 / 255., 0xFF / 255., 0xF0 / 255.);
            Color.HOT_PINK = new Color(0xFF / 255., 0x69 / 255., 0xB4 / 255.);
            Color.INDIAN_RED = new Color(0xCD / 255., 0x5C / 255., 0x5C / 255.);
            Color.INDIGO = new Color(0x4B / 255., 0x00 / 255., 0x82 / 255.);
            Color.IVORY = new Color(0xFF / 255., 0xFF / 255., 0xF0 / 255.);
            Color.KHAKI = new Color(0xF0 / 255., 0xE6 / 255., 0x8C / 255.);
            Color.LAVENDER = new Color(0xE6 / 255., 0xE6 / 255., 0xFA / 255.);
            Color.LAVENDER_BLUSH = new Color(0xFF / 255., 0xF0 / 255., 0xF5 / 255.);
            Color.LAWN_GREEN = new Color(0x7C / 255., 0xFC / 255., 0x00 / 255.);
            Color.LEMON_CHIFFON = new Color(0xFF / 255., 0xFA / 255., 0xCD / 255.);
            Color.LIGHT_BLUE = new Color(0xAD / 255., 0xD8 / 255., 0xE6 / 255.);
            Color.LIGHT_CORAL = new Color(0xF0 / 255., 0x80 / 255., 0x80 / 255.);
            Color.LIGHT_CYAN = new Color(0xE0 / 255., 0xFF / 255., 0xFF / 255.);
            Color.LIGHT_GOLDEN_ROD_YELLOW = new Color(0xFA / 255., 0xFA / 255., 0xD2 / 255.);
            Color.LIGHT_GRAY = new Color(0xD3 / 255., 0xD3 / 255., 0xD3 / 255.);
            Color.LIGHT_GREEN = new Color(0x90 / 255., 0xEE / 255., 0x90 / 255.);
            Color.LIGHT_PINK = new Color(0xFF / 255., 0xB6 / 255., 0xC1 / 255.);
            Color.LIGHT_SALMON = new Color(0xFF / 255., 0xA0 / 255., 0x7A / 255.);
            Color.LIGHT_SEA_GREEN = new Color(0x20 / 255., 0xB2 / 255., 0xAA / 255.);
            Color.LIGHT_SKY_BLUE = new Color(0x87 / 255., 0xCE / 255., 0xFA / 255.);
            Color.LIGHT_SLATE_GRAY = new Color(0x77 / 255., 0x88 / 255., 0x99 / 255.);
            Color.LIGHT_STEEL_BLUE = new Color(0xB0 / 255., 0xC4 / 255., 0xDE / 255.);
            Color.LIGHT_YELLOW = new Color(0xFF / 255., 0xFF / 255., 0xE0 / 255.);
            Color.LIME = new Color(0x00 / 255., 0xFF / 255., 0x00 / 255.);
            Color.LIME_GREEN = new Color(0x32 / 255., 0xCD / 255., 0x32 / 255.);
            Color.LINEN = new Color(0xFA / 255., 0xF0 / 255., 0xE6 / 255.);
            Color.MAGENTA = new Color(0xFF / 255., 0x00 / 255., 0xFF / 255.);
            Color.MAROON = new Color(0x80 / 255., 0x00 / 255., 0x00 / 255.);
            Color.MEDIUM_AQUA_MARINE = new Color(0x66 / 255., 0xCD / 255., 0xAA / 255.);
            Color.MEDIUM_BLUE = new Color(0x00 / 255., 0x00 / 255., 0xCD / 255.);
            Color.MEDIUM_ORCHID = new Color(0xBA / 255., 0x55 / 255., 0xD3 / 255.);
            Color.MEDIUM_PURPLE = new Color(0x93 / 255., 0x70 / 255., 0xDB / 255.);
            Color.MEDIUM_SEA_GREEN = new Color(0x3C / 255., 0xB3 / 255., 0x71 / 255.);
            Color.MEDIUM_SLATE_BLUE = new Color(0x7B / 255., 0x68 / 255., 0xEE / 255.);
            Color.MEDIUM_SPRING_GREEN = new Color(0x00 / 255., 0xFA / 255., 0x9A / 255.);
            Color.MEDIUM_TURQUOISE = new Color(0x48 / 255., 0xD1 / 255., 0xCC / 255.);
            Color.MEDIUM_VIOLET_RED = new Color(0xC7 / 255., 0x15 / 255., 0x85 / 255.);
            Color.MIDNIGHT_BLUE = new Color(0x19 / 255., 0x19 / 255., 0x70 / 255.);
            Color.MINT_CREAM = new Color(0xF5 / 255., 0xFF / 255., 0xFA / 255.);
            Color.MISTY_ROSE = new Color(0xFF / 255., 0xE4 / 255., 0xE1 / 255.);
            Color.MOCCASIN = new Color(0xFF / 255., 0xE4 / 255., 0xB5 / 255.);
            Color.NAVAJO_WHITE = new Color(0xFF / 255., 0xDE / 255., 0xAD / 255.);
            Color.NAVY = new Color(0x00 / 255., 0x00 / 255., 0x80 / 255.);
            Color.OLD_LACE = new Color(0xFD / 255., 0xF5 / 255., 0xE6 / 255.);
            Color.OLIVE = new Color(0x80 / 255., 0x80 / 255., 0x00 / 255.);
            Color.OLIVE_DRAB = new Color(0x6B / 255., 0x8E / 255., 0x23 / 255.);
            Color.ORANGE = new Color(0xFF / 255., 0xA5 / 255., 0x00 / 255.);
            Color.ORANGE_RED = new Color(0xFF / 255., 0x45 / 255., 0x00 / 255.);
            Color.ORCHID = new Color(0xDA / 255., 0x70 / 255., 0xD6 / 255.);
            Color.PALE_GOLDEN_ROD = new Color(0xEE / 255., 0xE8 / 255., 0xAA / 255.);
            Color.PALE_GREEN = new Color(0x98 / 255., 0xFB / 255., 0x98 / 255.);
            Color.PALE_TURQUOISE = new Color(0xAF / 255., 0xEE / 255., 0xEE / 255.);
            Color.PALE_VIOLET_RED = new Color(0xDB / 255., 0x70 / 255., 0x93 / 255.);
            Color.PAPAYA_WHIP = new Color(0xFF / 255., 0xEF / 255., 0xD5 / 255.);
            Color.PEACH_PUFF = new Color(0xFF / 255., 0xDA / 255., 0xB9 / 255.);
            Color.PERU = new Color(0xCD / 255., 0x85 / 255., 0x3F / 255.);
            Color.PINK = new Color(0xFF / 255., 0xC0 / 255., 0xCB / 255.);
            Color.PLUM = new Color(0xDD / 255., 0xA0 / 255., 0xDD / 255.);
            Color.POWDER_BLUE = new Color(0xB0 / 255., 0xE0 / 255., 0xE6 / 255.);
            Color.PURPLE = new Color(0x80 / 255., 0x00 / 255., 0x80 / 255.);
            Color.RED = new Color(0xFF / 255., 0x00 / 255., 0x00 / 255.);
            Color.ROSY_BROWN = new Color(0xBC / 255., 0x8F / 255., 0x8F / 255.);
            Color.ROYAL_BLUE = new Color(0x41 / 255., 0x69 / 255., 0xE1 / 255.);
            Color.SADDLE_BROWN = new Color(0x8B / 255., 0x45 / 255., 0x13 / 255.);
            Color.SALMON = new Color(0xFA / 255., 0x80 / 255., 0x72 / 255.);
            Color.SANDY_BROWN = new Color(0xF4 / 255., 0xA4 / 255., 0x60 / 255.);
            Color.SEA_GREEN = new Color(0x2E / 255., 0x8B / 255., 0x57 / 255.);
            Color.SEA_SHELL = new Color(0xFF / 255., 0xF5 / 255., 0xEE / 255.);
            Color.SIENNA = new Color(0xA0 / 255., 0x52 / 255., 0x2D / 255.);
            Color.SILVER = new Color(0xC0 / 255., 0xC0 / 255., 0xC0 / 255.);
            Color.SKY_BLUE = new Color(0x87 / 255., 0xCE / 255., 0xEB / 255.);
            Color.SLATE_BLUE = new Color(0x6A / 255., 0x5A / 255., 0xCD / 255.);
            Color.SLATE_GRAY = new Color(0x70 / 255., 0x80 / 255., 0x90 / 255.);
            Color.SNOW = new Color(0xFF / 255., 0xFA / 255., 0xFA / 255.);
            Color.SPRING_GREEN = new Color(0x00 / 255., 0xFF / 255., 0x7F / 255.);
            Color.STEEL_BLUE = new Color(0x46 / 255., 0x82 / 255., 0xB4 / 255.);
            Color.TAN = new Color(0xD2 / 255., 0xB4 / 255., 0x8C / 255.);
            Color.TEAL = new Color(0x00 / 255., 0x80 / 255., 0x80 / 255.);
            Color.THISTLE = new Color(0xD8 / 255., 0xBF / 255., 0xD8 / 255.);
            Color.TOMATO = new Color(0xFF / 255., 0x63 / 255., 0x47 / 255.);
            Color.TURQUOISE = new Color(0x40 / 255., 0xE0 / 255., 0xD0 / 255.);
            Color.VIOLET = new Color(0xEE / 255., 0x82 / 255., 0xEE / 255.);
            Color.WHEAT = new Color(0xF5 / 255., 0xDE / 255., 0xB3 / 255.);
            Color.WHITE_SMOKE = new Color(0xF5 / 255., 0xF5 / 255., 0xF5 / 255.);
            Color.YELLOW = new Color(0xFF / 255., 0xFF / 255., 0x00 / 255.);
            Color.YELLOW_GREEN = new Color(0x9A / 255., 0xCD / 255., 0x32 / 255.);
            return Color;
        })();
        util.Color = Color;        
        var pVariousColors = [
            "BLUE", 
            "BLUE_VIOLET", 
            "BROWN", 
            "CADET_BLUE", 
            "CHARTREUSE", 
            "CRIMSON", 
            "CYAN", 
            "DEEP_PINK", 
            "DEEP_SKY_BLUE", 
            "DODGER_BLUE", 
            "FIRE_BRICK", 
            "FUCHSIA", 
            "GOLD", 
            "GREEN", 
            "GREEN_YELLOW", 
            "HOT_PINK", 
            "LAWN_GREEN", 
            "LIME", 
            "LIME_GREEN", 
            "MAGENTA", 
            "MEDIUM_BLUE", 
            "MEDIUM_ORCHID", 
            "MEDIUM_SPRING_GREEN", 
            "MEDIUM_VIOLET_RED", 
            "ORANGE", 
            "ORANGE_RED", 
            "PURPLE", 
            "RED", 
            "SPRING_GREEN", 
            "STEEL_BLUE", 
            "TOMATO", 
            "TURQUOISE", 
            "VIOLET", 
            "WHEAT", 
            "YELLOW", 
            "YELLOW_GREEN"
        ];
        var iVariousColor = 0;
        function randomColor(bVarious) {
            if (typeof bVarious === "undefined") { bVarious = false; }
            if (!bVarious) {
                return new Color(Math.random(), Math.random(), Math.random(), 1.);
            }
            if (iVariousColor === pVariousColors.length) {
                iVariousColor = 0;
            }
            return (Color)[pVariousColors[iVariousColor++]] || Color.WHITE;
        }
        util.randomColor = randomColor;
        function colorToVec4(pValue) {
            return akra.vec4(pValue.r, pValue.g, pValue.b, pValue.a);
        }
        util.colorToVec4 = colorToVec4;
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    akra.Color = akra.util.Color;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (material) {
        var Material = (function () {
            function Material(sName, pMat) {
                if (typeof sName === "undefined") { sName = null; }
                this.name = null;
                this.diffuse = new akra.Color(.5);
                this.ambient = new akra.Color(.5);
                this.specular = new akra.Color(.5);
                this.emissive = new akra.Color(.5);
                this.shininess = 50.;
                this.name = sName;
                if (((pMat) != null)) {
                    this.set(pMat);
                }
            }
            Material.prototype.set = function (pMat) {
                this.diffuse.set(pMat.diffuse);
                this.ambient.set(pMat.ambient);
                this.specular.set(pMat.specular);
                this.emissive.set(pMat.emissive);
                this.shininess = pMat.shininess;
                return this;
            };
            Material.prototype.isEqual = function (pMat) {
                return akra.Color.isEqual(this.diffuse, pMat.diffuse) && akra.Color.isEqual(this.ambient, pMat.ambient) && akra.Color.isEqual(this.specular, pMat.specular) && akra.Color.isEqual(this.emissive, pMat.emissive) && this.shininess === pMat.shininess;
            };
            Material.prototype.toString = function () {
                var s = "\nMATERIAL - " + this.name + "\n";
                s += "------------------------------------\n";
                s += "diffuse:   " + this.diffuse.toString() + "\n";
                s += "ambient:   " + this.ambient.toString() + "\n";
                s += "specular:  " + this.ambient.toString() + "\n";
                s += "emissive:  " + this.emissive.toString() + "\n";
                s += "shininess: " + this.shininess + "\n";
                return s;
            };
            return Material;
        })();
        material.Material = Material;        
        var FlexMaterial = (function () {
            function FlexMaterial(sName, pData) {
                this.name = null;
                this._pData = pData;
                this.name = sName;
            }
            Object.defineProperty(FlexMaterial.prototype, "diffuse", {
                get: function () {
                    return new akra.Color(this._pData.getTypedData(akra.DeclUsages.DIFFUSE, 0, 1));
                },
                set: function (pValue) {
                    this._pData.setData(akra.Color.toFloat32Array(pValue), akra.DeclUsages.DIFFUSE);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(FlexMaterial.prototype, "ambient", {
                get: function () {
                    return new akra.Color(this._pData.getTypedData(akra.DeclUsages.AMBIENT, 0, 1));
                },
                set: function (pValue) {
                    this._pData.setData(akra.Color.toFloat32Array(pValue), akra.DeclUsages.AMBIENT);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(FlexMaterial.prototype, "specular", {
                get: function () {
                    return new akra.Color(this._pData.getTypedData(akra.DeclUsages.SPECULAR, 0, 1));
                },
                set: function (pValue) {
                    this._pData.setData(akra.Color.toFloat32Array(pValue), akra.DeclUsages.SPECULAR);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(FlexMaterial.prototype, "emissive", {
                get: function () {
                    return new akra.Color(this._pData.getTypedData(akra.DeclUsages.EMISSIVE, 0, 1));
                },
                set: function (pValue) {
                    this._pData.setData(akra.Color.toFloat32Array(pValue), akra.DeclUsages.EMISSIVE);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(FlexMaterial.prototype, "shininess", {
                get: function () {
                    return this._pData.getTypedData(akra.DeclUsages.SHININESS, 0, 1)[0];
                },
                set: function (pValue) {
                    this._pData.setData(new Float32Array([
                        pValue
                    ]), akra.DeclUsages.SHININESS);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(FlexMaterial.prototype, "data", {
                get: function () {
                    return this._pData;
                },
                enumerable: true,
                configurable: true
            });
            FlexMaterial.prototype.set = function (pMat) {
                this.diffuse = pMat.diffuse;
                this.ambient = pMat.ambient;
                this.specular = pMat.specular;
                this.emissive = pMat.emissive;
                this.shininess = pMat.shininess;
                return this;
            };
            FlexMaterial.prototype.isEqual = function (pMat) {
                return akra.Color.isEqual(this.diffuse, pMat.diffuse) && akra.Color.isEqual(this.ambient, pMat.ambient) && akra.Color.isEqual(this.specular, pMat.specular) && akra.Color.isEqual(this.emissive, pMat.emissive) && this.shininess === pMat.shininess;
            };
            FlexMaterial.prototype.toString = function () {
                var s = "\nFLEX MATERIAL - " + this.name + "\n";
                s += "------------------------------------\n";
                s += "diffuse:   " + this.diffuse.toString() + "\n";
                s += "ambient:   " + this.ambient.toString() + "\n";
                s += "specular:  " + this.ambient.toString() + "\n";
                s += "emissive:  " + this.emissive.toString() + "\n";
                s += "shininess: " + this.shininess + "\n";
                return s;
            };
            return FlexMaterial;
        })();        
        material.VERTEX_DECL = akra.createVertexDeclaration([
            akra.VE_CUSTOM(akra.DeclUsages.MATERIAL, akra.EDataTypes.FLOAT, 17), 
            akra.VE_CUSTOM(akra.DeclUsages.DIFFUSE, akra.EDataTypes.FLOAT, 4, 0), 
            akra.VE_CUSTOM(akra.DeclUsages.AMBIENT, akra.EDataTypes.FLOAT, 4, 16), 
            akra.VE_CUSTOM(akra.DeclUsages.SPECULAR, akra.EDataTypes.FLOAT, 4, 32), 
            akra.VE_CUSTOM(akra.DeclUsages.EMISSIVE, akra.EDataTypes.FLOAT, 4, 48), 
            akra.VE_CUSTOM(akra.DeclUsages.SHININESS, akra.EDataTypes.FLOAT, 1, 64)
        ]);
        material.DEFAULT = new Material();
        function create(sName, pMat) {
            if (typeof sName === "undefined") { sName = null; }
            if (typeof pMat === "undefined") { pMat = null; }
            return new Material(sName, pMat);
        }
        material.create = create;
        function _createFlex(sName, pData) {
            return new FlexMaterial(sName, pData);
        }
        material._createFlex = _createFlex;
    })(akra.material || (akra.material = {}));
    var material = akra.material;
})(akra || (akra = {}));
var akra;
(function (akra) {
    akra.Material = akra.material.Material;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                var SurfaceMaterial = (function (_super) {
                    __extends(SurfaceMaterial, _super);
                    function SurfaceMaterial() {
                                        _super.call(this);
                        this._pMaterial = new akra.Material();
                        this._nTotalTextures = 0;
                        this._iTextureFlags = 0;
                        this._iTextureMatrixFlags = 0;
                        this._pTextures = new Array(SurfaceMaterial.MAX_TEXTURES_PER_SURFACE);
                        this._pTexcoords = new Array(SurfaceMaterial.MAX_TEXTURES_PER_SURFACE);
                        this._pTextureMatrices = new Array(SurfaceMaterial.MAX_TEXTURES_PER_SURFACE);
                        this._sLastHash = "";
                        this._isNeedToUpdateHash = true;
                        for(var i = 0; i < SurfaceMaterial.MAX_TEXTURES_PER_SURFACE; ++i) {
                            this._pTexcoords[i] = i;
                        }
                    }
                    Object.defineProperty(SurfaceMaterial.prototype, "totalTextures", {
                        get: function () {
                            return this._nTotalTextures;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(SurfaceMaterial.prototype, "material", {
                        get: function () {
                            return this._pMaterial;
                        },
                        set: function (pMaterial) {
                            this._pMaterial.set(pMaterial);
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(SurfaceMaterial.prototype, "textureFlags", {
                        get: function () {
                            return this._iTextureFlags;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(SurfaceMaterial.prototype, "textureMatrixFlags", {
                        get: function () {
                            return this._iTextureMatrixFlags;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    SurfaceMaterial.prototype.createResource = function () {
                        this.notifyLoaded();
                        return _super.prototype.createResource.call(this);
                    };
                    SurfaceMaterial.prototype.setTexture = function (iIndex, texture, iTexcoord) {
                        if (typeof iTexcoord === "undefined") { iTexcoord = 0; }
 {
                            akra.logger.setSourceLocation("resources/SurfaceMaterial.ts", 48);
                            akra.logger.assert(iIndex < SurfaceMaterial.MAX_TEXTURES_PER_SURFACE, "invalid texture slot");
                        }
                        ;
                        var pRmgr = this.getManager();
                        var pTexture = null;
                        this._pTexcoords[iIndex] = iTexcoord;
                        if (iIndex !== iTexcoord) {
                            this._isNeedToUpdateHash = true;
                        }
                        if ((typeof (texture) === "string")) {
                            pTexture = this._pTextures[iIndex];
                            if (pTexture) {
                                if (pTexture.release() == 0) {
                                    this._pTextures[iIndex] = null;
                                } else {
 {
                                        akra.logger.setSourceLocation("resources/SurfaceMaterial.ts", 70);
                                        akra.logger.warning("cannot destroy resource...");
                                    }
                                }
                                ((this._iTextureFlags) &= ~(1 << (iIndex)));
                                --this._nTotalTextures;
                            }
                            this._pTextures[iIndex] = pRmgr.texturePool.loadResource(texture);
                            if (this._pTextures[iIndex]) {
                                ((this._iTextureFlags) |= (1 << (iIndex)));
                                ++this._nTotalTextures;
                                this.sync(this._pTextures[iIndex], akra.EResourceItemEvents.LOADED);
                            }
                            return true;
                        } else if (texture instanceof resources.Texture) {
                            if (!this._pTextures[iIndex] || pTexture != this._pTextures[iIndex]) {
                                pTexture = texture;
                                if (this._pTextures[iIndex]) {
                                    if (this._pTextures[iIndex].release() == 0) {
                                        this._pTextures[iIndex] = null;
                                    } else {
 {
                                            akra.logger.setSourceLocation("resources/SurfaceMaterial.ts", 102);
                                            akra.logger.warning("cannot destroy resource...");
                                        }
                                        ;
                                    }
                                    ((this._iTextureFlags) &= ~(1 << (iIndex)));
                                    --this._nTotalTextures;
                                }
                                this._pTextures[iIndex] = pTexture;
                                this._pTextures[iIndex].addRef();
                                ((this._iTextureFlags) |= (1 << (iIndex)));
                                ++this._nTotalTextures;
                                this.sync(this._pTextures[iIndex], akra.EResourceItemEvents.LOADED);
                            }
                            return true;
                        } else if ((typeof (texture) === "number")) {
                            if (!this._pTextures[iIndex] || this._pTextures[iIndex].resourceHandle != texture) {
                                if (this._pTextures[iIndex]) {
                                    if (this._pTextures[iIndex].release() === 0) {
                                        this._pTextures[iIndex] = null;
                                    } else {
 {
                                            akra.logger.setSourceLocation("resources/SurfaceMaterial.ts", 141);
                                            akra.logger.warning("cannot destroy resource...");
                                        }
                                        ;
                                    }
                                    ((this._iTextureFlags) &= ~(1 << (iIndex)));
                                    --this._nTotalTextures;
                                }
                                this._pTextures[iIndex] = pRmgr.texturePool.getResource(texture);
                                if (this._pTextures[iIndex]) {
                                    ((this._iTextureFlags) |= (1 << (iIndex)));
                                    ++this._nTotalTextures;
                                    this.sync(this._pTextures[iIndex], akra.EResourceItemEvents.LOADED);
                                }
                            }
                            return true;
                        }
                        this._pTexcoords[iIndex] = iIndex;
                        return false;
                    };
                    SurfaceMaterial.prototype.setTextureMatrix = function (iIndex, m4fValue) {
 {
                            akra.logger.setSourceLocation("resources/SurfaceMaterial.ts", 167);
                            akra.logger.assert(iIndex < SurfaceMaterial.MAX_TEXTURES_PER_SURFACE, "invalid texture slot");
                        }
                        ;
                        if (!m4fValue) {
                            this._pTextureMatrices[iIndex] = new akra.Mat4();
                        } else {
                            this._pTextureMatrices[iIndex] = new akra.Mat4(m4fValue);
                        }
                        ((this._iTextureMatrixFlags) |= (1 << (iIndex)));
                        return true;
                    };
                    SurfaceMaterial.prototype.setMaterial = function (pMaterial) {
                        this._pMaterial.set(pMaterial);
                    };
                    SurfaceMaterial.prototype.isEqual = function (pSurfaceMaterial) {
                        if (this._nTotalTextures === pSurfaceMaterial.totalTextures && this._iTextureFlags === pSurfaceMaterial.textureFlags && this._iTextureMatrixFlags === pSurfaceMaterial.textureMatrixFlags) {
                            if ((this._pMaterial && this._pMaterial.isEqual(pSurfaceMaterial.material)) || (pSurfaceMaterial.material === null)) {
                                for(var i = 0; i < this._pTextures.length; i++) {
                                    if (this._pTextures[i] !== pSurfaceMaterial.texture[i]) {
                                        return false;
                                    }
                                }
                                ;
                                for(var i = 0; i < this._pTextureMatrices.length; ++i) {
                                    for(var j = 0; j < this._pTextureMatrices[i].data.length; j++) {
                                        if (this._pTextureMatrices[i].data[j] !== pSurfaceMaterial.textureMatrix[i].data[j]) {
                                            return false;
                                        }
                                    }
                                    ;
                                }
                                return true;
                            }
                        }
                        return false;
                    };
                    SurfaceMaterial.prototype.texture = function (iSlot) {
                        return this._pTextures[iSlot];
                    };
                    SurfaceMaterial.prototype.texcoord = function (iSlot) {
                        return this._pTexcoords[iSlot];
                    };
                    SurfaceMaterial.prototype.textureMatrix = function (iSlot) {
 {
                            akra.logger.setSourceLocation("resources/SurfaceMaterial.ts", 227);
                            akra.logger.assert((iSlot >= 0 && iSlot < SurfaceMaterial.MAX_TEXTURES_PER_SURFACE), "invalid texture slot");
                        }
                        ;
                        return this._pTextureMatrices[iSlot];
                    };
                    SurfaceMaterial.MAX_TEXTURES_PER_SURFACE = 16;
                    SurfaceMaterial.prototype._getHash = function () {
                        if (this._isNeedToUpdateHash) {
                            this._sLastHash = this.calcHash();
                            this._isNeedToUpdateHash = false;
                        }
                        return this._sLastHash;
                    };
                    SurfaceMaterial.prototype.calcHash = function () {
                        var sHash = "";
                        for(var i = 0; i < this._pTexcoords.length; i++) {
                            if (this._pTexcoords[i] !== i) {
                                sHash += i.toString() + "<" + this._pTexcoords[i].toString() + ".";
                            }
                        }
                        return sHash;
                    };
                    return SurfaceMaterial;
                })(pool.ResourcePoolItem);
                resources.SurfaceMaterial = SurfaceMaterial;                
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                var Effect = (function (_super) {
                    __extends(Effect, _super);
                    function Effect() {
                                        _super.call(this);
                    }
                    Object.defineProperty(Effect.prototype, "totalComponents", {
                        get: function () {
                            return this.getComposer().getComponentCountForEffect(this);
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Effect.prototype, "totalPasses", {
                        get: function () {
                            return this.getComposer().getTotalPassesForEffect(this);
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Effect.prototype.isEqual = function (pEffect) {
                        return false;
                    };
                    Effect.prototype.isReplicated = function () {
                        return false;
                    };
                    Effect.prototype.isMixid = function () {
                        return false;
                    };
                    Effect.prototype.isParameterUsed = function (pParam, iPass) {
                        return false;
                    };
                    Effect.prototype.createResource = function () {
                        this.notifyLoaded();
                        return true;
                    };
                    Effect.prototype.replicable = function (bValue) {
                        return;
                    };
                    Effect.prototype.miscible = function (bValue) {
                        return;
                    };
                    Effect.prototype.addComponent = function (pComponent, iShift, iPass, isSet) {
                        if (typeof iShift === "undefined") { iShift = 0; }
                        if (typeof iPass === "undefined") { iPass = 0xffffff; }
                        if (typeof isSet === "undefined") { isSet = true; }
                        var pComponentPool = this.manager.componentPool;
                        if ((typeof (pComponent) === "number")) {
                            pComponent = pComponentPool.getResource(pComponent);
                        } else if ((typeof (pComponent) === "string")) {
                            pComponent = pComponentPool.findResource(pComponent);
                        }
                        if (!((pComponent) !== undefined) || ((pComponent) === null)) {
 {
                                akra.logger.setSourceLocation("resources/Effect.ts", 49);
                                akra.logger.error("Bad component for add/delete: ", pComponent);
                            }
                            ;
                            return false;
                        }
                        if (isSet) {
                            if (!this.getComposer().addComponentToEffect(this, pComponent, iShift, iPass)) {
 {
                                    akra.logger.setSourceLocation("resources/Effect.ts", 55);
                                    akra.logger.error("Can not add component '" + pComponent.findResourceName() + "'");
                                }
                                ;
                                return false;
                            }
                        } else {
                            if (!this.getComposer().removeComponentFromEffect(this, pComponent, iShift, iPass)) {
 {
                                    akra.logger.setSourceLocation("resources/Effect.ts", 61);
                                    akra.logger.error("Can not delete component '" + pComponent.findResourceName() + "'");
                                }
                                ;
                                return false;
                            }
                        }
                        this.notifyAltered();
                        if (this.totalComponents === 1 && isSet) {
                            this.notifyRestored();
                        } else if (this.totalComponents === 0 && !isSet) {
                            this.notifyDisabled();
                        }
                        return true;
                    };
                    Effect.prototype.delComponent = function (pComponent, iShift, iPass) {
                        if (typeof iShift === "undefined") { iShift = 0; }
                        if (typeof iPass === "undefined") { iPass = 0xffffff; }
                        return this.addComponent(pComponent, iShift, iPass, false);
                    };
                    Effect.prototype.activate = function (iShift) {
                        if (typeof iShift === "undefined") { iShift = 0; }
                        return this.getComposer().activateEffectResource(this, iShift);
                    };
                    Effect.prototype.deactivate = function () {
                        return this.getComposer().deactivateEffectResource(this);
                    };
                    Effect.prototype.findParameter = function (pParam, iPass) {
                        return null;
                    };
                    Effect.prototype.getComposer = function () {
                        return this.manager.getEngine().getComposer();
                    };
                    return Effect;
                })(pool.ResourcePoolItem);
                resources.Effect = Effect;                
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EImageFlags) {
        EImageFlags._map = [];
        EImageFlags.COMPRESSED = 0x00000001;
        EImageFlags.CUBEMAP = 0x00000002;
        EImageFlags.TEXTURE_3D = 0x00000004;
    })(akra.EImageFlags || (akra.EImageFlags = {}));
    var EImageFlags = akra.EImageFlags;
    ;
    (function (EImageCubeFlags) {
        EImageCubeFlags._map = [];
        EImageCubeFlags.POSITIVE_X = 0x00000001;
        EImageCubeFlags.NEGATIVE_X = 0x00000002;
        EImageCubeFlags.POSITIVE_Y = 0x00000004;
        EImageCubeFlags.NEGATIVE_Y = 0x00000008;
        EImageCubeFlags.POSITIVE_Z = 0x000000010;
        EImageCubeFlags.NEGATIVE_Z = 0x000000020;
    })(akra.EImageCubeFlags || (akra.EImageCubeFlags = {}));
    var EImageCubeFlags = akra.EImageCubeFlags;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        var Pathinfo = (function () {
            function Pathinfo(pPath) {
                this._sDirname = null;
                this._sExtension = null;
                this._sFilename = null;
                if (((pPath) !== undefined)) {
                    this.set(pPath);
                }
            }
            Object.defineProperty(Pathinfo.prototype, "path", {
                get: function () {
                    return this.toString();
                },
                set: function (sPath) {
                    this.set(sPath);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Pathinfo.prototype, "dirname", {
                get: function () {
                    return this._sDirname;
                },
                set: function (sDirname) {
                    this._sDirname = sDirname;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Pathinfo.prototype, "filename", {
                get: function () {
                    return this._sFilename;
                },
                set: function (sFilename) {
                    this._sFilename = sFilename;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Pathinfo.prototype, "ext", {
                get: function () {
                    return this._sExtension;
                },
                set: function (sExtension) {
                    this._sExtension = sExtension;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Pathinfo.prototype, "basename", {
                get: function () {
                    return (this._sFilename ? this._sFilename + (this._sExtension ? "." + this._sExtension : "") : "");
                },
                set: function (sBasename) {
                    var nPos = sBasename.lastIndexOf(".");
                    if (nPos < 0) {
                        this._sFilename = sBasename.substr(0);
                        this._sExtension = null;
                    } else {
                        this._sFilename = sBasename.substr(0, nPos);
                        this._sExtension = sBasename.substr(nPos + 1);
                    }
                },
                enumerable: true,
                configurable: true
            });
            Pathinfo.prototype.set = function (sPath) {
                if ((typeof (sPath) === "string")) {
                    var pParts = sPath.replace('\\', '/').split('/');
                    this.basename = pParts.pop();
                    this._sDirname = pParts.join('/');
                } else if (sPath instanceof Pathinfo) {
                    this._sDirname = sPath.dirname;
                    this._sFilename = sPath.filename;
                    this._sExtension = sPath.ext;
                } else {
 {
                        util.logger.setSourceLocation("Pathinfo.ts", 68);
                        util.logger.error("Unexpected data type was used.");
                    }
                    ;
                }
            };
            Pathinfo.prototype.isAbsolute = function () {
                return this._sDirname[0] === "/";
            };
            Pathinfo.prototype.toString = function () {
                return (this._sDirname ? this._sDirname + "/" : "") + (this.basename);
            };
            return Pathinfo;
        })();
        util.Pathinfo = Pathinfo;        
        util.pathinfo;
        util.pathinfo = function (pPath) {
            return new Pathinfo(pPath);
        };
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    akra.Pathinfo = akra.util.Pathinfo;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        var URI = (function () {
            function URI(pUri) {
                this.sScheme = null;
                this.sUserinfo = null;
                this.sHost = null;
                this.nPort = 0;
                this.sPath = null;
                this.sQuery = null;
                this.sFragment = null;
                if (pUri) {
                    this.set(pUri);
                }
            }
            Object.defineProperty(URI.prototype, "urn", {
                get: function () {
                    return (this.sPath ? this.sPath : "") + (this.sQuery ? '?' + this.sQuery : "") + (this.sFragment ? '#' + this.sFragment : "");
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(URI.prototype, "url", {
                get: function () {
                    return (this.sScheme ? this.sScheme : "") + this.authority;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(URI.prototype, "authority", {
                get: function () {
                    return (this.sHost ? '//' + (this.sUserinfo ? this.sUserinfo + '@' : "") + this.sHost + (this.nPort ? ':' + this.nPort : "") : "");
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(URI.prototype, "scheme", {
                get: function () {
                    return this.sScheme;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(URI.prototype, "protocol", {
                get: function () {
                    if (!this.sScheme) {
                        return this.sScheme;
                    }
                    return (this.sScheme.substr(0, this.sScheme.lastIndexOf(':')));
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(URI.prototype, "userinfo", {
                get: function () {
                    return this.sUserinfo;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(URI.prototype, "host", {
                get: function () {
                    return this.sHost;
                },
                set: function (sHost) {
                    this.sHost = sHost;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(URI.prototype, "port", {
                get: function () {
                    return this.nPort;
                },
                set: function (iPort) {
                    this.nPort = iPort;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(URI.prototype, "path", {
                get: function () {
                    return this.sPath;
                },
                set: function (sPath) {
                    this.sPath = sPath;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(URI.prototype, "query", {
                get: function () {
                    return this.sQuery;
                },
                set: function (sQuery) {
                    this.sQuery = sQuery;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(URI.prototype, "fragment", {
                get: function () {
                    return this.sFragment;
                },
                enumerable: true,
                configurable: true
            });
            URI.prototype.set = function (pData) {
                if ((typeof (pData) === "string")) {
                    var pUri = URI.uriExp.exec(pData);
 {
                        util.logger.setSourceLocation("URI.ts", 103);
                        util.logger.assert(pUri !== null, 'Invalid URI format used.\nused uri: ' + pData);
                    }
                    ;
                    if (!pUri) {
                        return null;
                    }
                    this.sScheme = pUri[1] || null;
                    this.sUserinfo = pUri[2] || null;
                    this.sHost = pUri[3] || null;
                    this.nPort = parseInt(pUri[4]) || null;
                    this.sPath = pUri[5] || pUri[6] || null;
                    this.sQuery = pUri[7] || null;
                    this.sFragment = pUri[8] || null;
                    return this;
                } else if (pData instanceof URI) {
                    return this.set(pData.toString());
                }
 {
                    util.logger.setSourceLocation("URI.ts", 124);
                    util.logger.error('Unexpected data type was used.');
                }
                ;
                return null;
            };
            URI.prototype.toString = function () {
                return this.url + this.urn;
            };
            URI.here = function here() {
                return new URI(document.location.href);
            };
            URI.uriExp = new RegExp("^([a-z0-9+.-]+:)?(?:\\/\\/(?:((?:[a-z0-9-._~!$&'()*+,;=:]|%[0-9A-F]{2})*)@)?((?:[a-z0-9-._~!$&'()*+,;=]|%[0-9A-F]{2})*)(?::(\\d*))?(\\/(?:[a-z0-9-._~!$&'()*+,;=:@/]|%[0-9A-F]{2})*)?|(\\/?(?:[a-z0-9-._~!$&'()*+,;=:@]|%[0-9A-F]{2})*(?:[a-z0-9-._~!$&'()*+,;=:@/]|%[0-9A-F]{2})*)?)(?:\\?((?:[a-z0-9-._~!$&'()*+,;=:/?@]|%[0-9A-F]{2})*))?(?:#((?:[a-z0-9-._~!$&'()*+,;=:/?@]|%[0-9A-F]{2})*))?$", "i");
            return URI;
        })();
        util.URI = URI;        
        util.uri = /** @inline */function (sUri) {
            return new akra.util.URI(sUri);
        };
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        util.stoab = function (s) {
            var len = s.length;
            var pCodeList = new Array(len);
            for(var i = 0; i < len; ++i) {
                pCodeList[i] = s.charCodeAt(i);
            }
            return (new Uint8Array(pCodeList)).buffer;
        };
        util.abtos = function (pBuf) {
            var pData = new Uint8Array(pBuf);
            var s = "";
            for(var n = 0; n < pData.length; ++n) {
                s += String.fromCharCode(pData[n]);
            }
            return s;
        };
        function abtota(pBuffer, eType) {
            switch(eType) {
                case akra.EDataTypes.FLOAT:
                    return new Float32Array(pBuffer);
                case akra.EDataTypes.SHORT:
                    return new Int16Array(pBuffer);
                case akra.EDataTypes.UNSIGNED_SHORT:
                    return new Uint16Array(pBuffer);
                case akra.EDataTypes.INT:
                    return new Int32Array(pBuffer);
                case akra.EDataTypes.UNSIGNED_INT:
                    return new Uint32Array(pBuffer);
                case akra.EDataTypes.BYTE:
                    return new Int8Array(pBuffer);
                default:
                case akra.EDataTypes.UNSIGNED_BYTE:
                    return new Uint8Array(pBuffer);
            }
        }
        util.abtota = abtota;
        function parseJSON(sJSON) {
            return eval('(' + sJSON + ')');
        }
        util.parseJSON = parseJSON;
        function btoa(pBlob, fn) {
            var pReader = new FileReader();
            pReader.onload = function (e) {
                fn(null, e.target.result);
            };
            pReader.onerror = function (e) {
                fn(e, null);
            };
            pReader.readAsArrayBuffer(pBlob);
        }
        util.btoa = btoa;
        function parseHTML(sHTML, useDocFragment) {
            if (typeof useDocFragment === "undefined") { useDocFragment = true; }
            var pDivEl = document.createElement('div');
            var pDocFrag;
            pDivEl.innerHTML = sHTML;
            if (!useDocFragment) {
                return pDivEl.childNodes;
            }
            pDocFrag = document.createDocumentFragment();
            for(var i = 0, len = pDivEl.childNodes.length; i < len; ++i) {
                if (!((pDivEl.childNodes[i]) !== undefined)) {
                    continue;
                }
                pDocFrag.appendChild(pDivEl.childNodes[i]);
            }
            return pDocFrag;
        }
        util.parseHTML = parseHTML;
        ;
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        var Singleton = (function () {
            function Singleton() {
                var _constructor = (this).constructor;
 {
                    util.logger.setSourceLocation("Singleton.ts", 10);
                    util.logger.assert(!((_constructor._pInstance) !== undefined), 'Singleton class may be created only one time.');
                }
                ;
                _constructor._pInstance = this;
            }
            return Singleton;
        })();
        util.Singleton = Singleton;        
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        var BrowserInfo = (function (_super) {
            __extends(BrowserInfo, _super);
            function BrowserInfo() {
                        _super.call(this);
                this.sBrowser = null;
                this.sVersion = null;
                this.sOS = null;
                this.sVersionSearch = null;
                this.init();
            }
            Object.defineProperty(BrowserInfo.prototype, "name", {
                get: function () {
                    return this.sBrowser;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BrowserInfo.prototype, "version", {
                get: function () {
                    return this.sVersion;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BrowserInfo.prototype, "os", {
                get: function () {
                    return this.sOS;
                },
                enumerable: true,
                configurable: true
            });
            BrowserInfo.prototype.init = function () {
                this.sBrowser = this.searchString(BrowserInfo.dataBrowser) || "An unknown browser";
                this.sVersion = this.searchVersion(navigator.userAgent) || this.searchVersion(navigator.appVersion) || "an unknown version";
                this.sOS = this.searchString(BrowserInfo.dataOS) || "an unknown OS";
            };
            BrowserInfo.prototype.searchString = function (pDataBrowser) {
                for(var i = 0; i < pDataBrowser.length; i++) {
                    var sData = pDataBrowser[i].string;
                    var dataProp = pDataBrowser[i].prop;
                    this.sVersionSearch = pDataBrowser[i].versionSearch || pDataBrowser[i].identity;
                    if (sData) {
                        if (sData.indexOf(pDataBrowser[i].subString) != -1) {
                            return pDataBrowser[i].identity;
                        }
                    } else if (dataProp) {
                        return pDataBrowser[i].identity;
                    }
                }
                return null;
            };
            BrowserInfo.prototype.searchVersion = function (sData) {
                var iStartIndex = sData.indexOf(this.sVersionSearch);
                if (iStartIndex == -1) {
                    return null;
                }
                iStartIndex = sData.indexOf('/', iStartIndex + 1);
                if (iStartIndex == -1) {
                    return null;
                }
                var iEndIndex = sData.indexOf(' ', iStartIndex + 1);
                if (iEndIndex == -1) {
                    iEndIndex = sData.indexOf(';', iStartIndex + 1);
                    if (iEndIndex == -1) {
                        return null;
                    }
                    return sData.slice(iStartIndex + 1);
                }
                return sData.slice((iStartIndex + 1), iEndIndex);
            };
            BrowserInfo.dataBrowser = [
                {
                    string: navigator.userAgent,
                    subString: "Chrome",
                    identity: "Chrome"
                }, 
                {
                    string: navigator.userAgent,
                    subString: "OmniWeb",
                    versionSearch: "OmniWeb/",
                    identity: "OmniWeb"
                }, 
                {
                    string: navigator.vendor,
                    subString: "Apple",
                    identity: "Safari",
                    versionSearch: "Version"
                }, 
                {
                    prop: window.opera,
                    identity: "Opera",
                    versionSearch: "Version"
                }, 
                {
                    string: navigator.vendor,
                    subString: "iCab",
                    identity: "iCab"
                }, 
                {
                    string: navigator.vendor,
                    subString: "KDE",
                    identity: "Konqueror"
                }, 
                {
                    string: navigator.userAgent,
                    subString: "Firefox",
                    identity: "Firefox"
                }, 
                {
                    string: navigator.vendor,
                    subString: "Camino",
                    identity: "Camino"
                }, 
                {
                    string: navigator.userAgent,
                    subString: "Netscape",
                    identity: "Netscape"
                }, 
                {
                    string: navigator.userAgent,
                    subString: "MSIE",
                    identity: "Explorer",
                    versionSearch: "MSIE"
                }, 
                {
                    string: navigator.userAgent,
                    subString: "Gecko",
                    identity: "Mozilla",
                    versionSearch: "rv"
                }, 
                {
                    string: navigator.userAgent,
                    subString: "Mozilla",
                    identity: "Netscape",
                    versionSearch: "Mozilla"
                }
            ];
            BrowserInfo.dataOS = [
                {
                    string: navigator.platform,
                    subString: "Win",
                    identity: "Windows"
                }, 
                {
                    string: navigator.platform,
                    subString: "Mac",
                    identity: "Mac"
                }, 
                {
                    string: navigator.userAgent,
                    subString: "iPhone",
                    identity: "iPhone/iPod"
                }, 
                {
                    string: navigator.platform,
                    subString: "Linux",
                    identity: "Linux"
                }
            ];
            return BrowserInfo;
        })(util.Singleton);
        util.BrowserInfo = BrowserInfo;        
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        var ScreenInfo = (function () {
            function ScreenInfo() { }
            Object.defineProperty(ScreenInfo.prototype, "width", {
                get: function () {
                    return screen.width;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ScreenInfo.prototype, "height", {
                get: function () {
                    return screen.height;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ScreenInfo.prototype, "aspect", {
                get: function () {
                    return screen.width / screen.height;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ScreenInfo.prototype, "pixelDepth", {
                get: function () {
                    return screen.pixelDepth;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ScreenInfo.prototype, "colorDepth", {
                get: function () {
                    return screen.colorDepth;
                },
                enumerable: true,
                configurable: true
            });
            return ScreenInfo;
        })();
        util.ScreenInfo = ScreenInfo;        
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
var akra;
(function (akra) {
    (function (math) {
        var Vec2 = (function () {
            function Vec2(fValue1, fValue2) {
                this.x = 0.;
                this.y = 0.;
                var nArgumentsLength = arguments.length;
                var v2fVec = this;
                switch(nArgumentsLength) {
                    case 1:
                        v2fVec.set(arguments[0]);
                        break;
                    case 2:
                        v2fVec.set(arguments[0], arguments[1]);
                        break;
                    default:
                        v2fVec.x = v2fVec.y = 0.;
                        break;
                }
            }
            Object.defineProperty(Vec2.prototype, "xx", {
                get: function () {
                    return math.vec2(this.x, this.x);
                },
                set: function (v2fVec) {
                    this.x = v2fVec.x;
                    this.x = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec2.prototype, "xy", {
                get: function () {
                    return math.vec2(this.x, this.y);
                },
                set: function (v2fVec) {
                    this.x = v2fVec.x;
                    this.y = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec2.prototype, "yx", {
                get: function () {
                    return math.vec2(this.y, this.x);
                },
                set: function (v2fVec) {
                    this.y = v2fVec.x;
                    this.x = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec2.prototype, "yy", {
                get: function () {
                    return math.vec2(this.y, this.y);
                },
                set: function (v2fVec) {
                    this.y = v2fVec.x;
                    this.y = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Vec2.prototype.set = function (fValue1, fValue2) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 0:
                        this.x = this.y = 0.;
                        break;
                    case 1:
                        if ((typeof (arguments[0]) === "number")) {
                            this.x = this.y = arguments[0];
                        } else if (arguments[0] instanceof Vec2) {
                            var v2fVec = arguments[0];
                            this.x = v2fVec.x;
                            this.y = v2fVec.y;
                        } else {
                            var pArray = arguments[0];
                            this.x = pArray[0];
                            this.y = pArray[1];
                        }
                        break;
                    case 2:
                        this.x = arguments[0];
                        this.y = arguments[1];
                        break;
                }
                ;
                return this;
            };
            Vec2.prototype.clear = function () {
                this.x = this.y = 0.;
                return this;
            };
            Vec2.prototype.add = function (v2fVec, v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = this;
                }
                v2fDestination.x = this.x + v2fVec.x;
                v2fDestination.y = this.y + v2fVec.y;
                return v2fDestination;
            };
            Vec2.prototype.subtract = function (v2fVec, v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = this;
                }
                v2fDestination.x = this.x - v2fVec.x;
                v2fDestination.y = this.y - v2fVec.y;
                return v2fDestination;
            };
            Vec2.prototype.dot = function (v2fVec) {
                return this.x * v2fVec.x + this.y * v2fVec.y;
            };
            Vec2.prototype.isEqual = function (v2fVec, fEps) {
                if (typeof fEps === "undefined") { fEps = 0.; }
                if (fEps === 0.) {
                    if (this.x != v2fVec.x || this.y != v2fVec.y) {
                        return false;
                    }
                } else {
                    if (math.abs(this.x - v2fVec.x) > fEps || math.abs(this.y - v2fVec.y) > fEps) {
                        return false;
                    }
                }
                return true;
            };
            Vec2.prototype.isClear = function (fEps) {
                if (typeof fEps === "undefined") { fEps = 0.; }
                if (fEps === 0.) {
                    if (this.x != 0. || this.y != 0.) {
                        return false;
                    }
                } else {
                    if (math.abs(this.x) > fEps || math.abs(this.y) > fEps) {
                        return false;
                    }
                }
                return true;
            };
            Vec2.prototype.negate = function (v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = this;
                }
                v2fDestination.x = -this.x;
                v2fDestination.y = -this.y;
                return v2fDestination;
            };
            Vec2.prototype.scale = function (fScale, v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = this;
                }
                v2fDestination.x = this.x * fScale;
                v2fDestination.y = this.y * fScale;
                return v2fDestination;
            };
            Vec2.prototype.normalize = function (v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = this;
                }
                var x = this.x, y = this.y;
                var fLength = math.sqrt(x * x + y * y);
                if (fLength !== 0.) {
                    var fInvLength = 1. / fLength;
                    x *= fInvLength;
                    y *= fInvLength;
                }
                v2fDestination.x = x;
                v2fDestination.y = y;
                return v2fDestination;
            };
            Vec2.prototype.length = function () {
                var x = this.x, y = this.y;
                return math.sqrt(x * x + y * y);
            };
            Vec2.prototype.lengthSquare = function () {
                var x = this.x, y = this.y;
                return x * x + y * y;
            };
            Vec2.prototype.direction = function (v2fVec, v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = this;
                }
                var x = v2fVec.x - this.x;
                var y = v2fVec.y - this.y;
                var fLength = math.sqrt(x * x + y * y);
                if (fLength !== 0.) {
                    var fInvLength = 1. / fLength;
                    x *= fInvLength;
                    y *= fInvLength;
                }
                v2fDestination.x = x;
                v2fDestination.y = y;
                return v2fDestination;
            };
            Vec2.prototype.mix = function (v2fVec, fA, v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = this;
                }
                fA = (/*checked (origin: math)>>*/akra.math.max((0.), /*checked (origin: math)>>*/akra.math.min((fA), (1.))));
                var fA1 = 1. - fA;
                var fA2 = fA;
                v2fDestination.x = fA1 * this.x + fA2 * v2fVec.x;
                v2fDestination.y = fA1 * this.y + fA2 * v2fVec.y;
                return v2fDestination;
            };
            Vec2.prototype.toString = function () {
                return "[x: " + this.x + ", y: " + this.y + "]";
            };
            Object.defineProperty(Vec2, "stackCeil", {
                get: function () {
                    Vec2.stackPosition = Vec2.stackPosition === Vec2.stackSize - 1 ? 0 : Vec2.stackPosition;
                    return Vec2.stack[Vec2.stackPosition++];
                },
                enumerable: true,
                configurable: true
            });
            Vec2.stackSize = 100;
            Vec2.stackPosition = 0;
            Vec2.stack = (function () {
                var pStack = new Array(Vec2.stackSize);
                for(var i = 0; i < Vec2.stackSize; i++) {
                    pStack[i] = new Vec2();
                }
                return pStack;
            })();
            return Vec2;
        })();
        math.Vec2 = Vec2;        
    })(akra.math || (akra.math = {}));
    var math = akra.math;
})(akra || (akra = {}));
;
;
var akra;
(function (akra) {
    (function (math) {
        var Vec3 = (function () {
            function Vec3(fValue1, fValue2, fValue3) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        this.set(arguments[0]);
                        break;
                    case 2:
                        this.set(arguments[0], arguments[1]);
                        break;
                    case 3:
                        this.set(arguments[0], arguments[1], arguments[2]);
                        break;
                    default:
                        this.x = this.y = this.z = 0.;
                        break;
                }
            }
            Object.defineProperty(Vec3.prototype, "xx", {
                get: function () {
                    return math.vec2(this.x, this.x);
                },
                set: function (v2fVec) {
                    this.x = v2fVec.x;
                    this.x = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "xy", {
                get: function () {
                    return math.vec2(this.x, this.y);
                },
                set: function (v2fVec) {
                    this.x = v2fVec.x;
                    this.y = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "xz", {
                get: function () {
                    return math.vec2(this.x, this.z);
                },
                set: function (v2fVec) {
                    this.x = v2fVec.x;
                    this.z = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "yx", {
                get: function () {
                    return math.vec2(this.y, this.x);
                },
                set: function (v2fVec) {
                    this.y = v2fVec.x;
                    this.x = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "yy", {
                get: function () {
                    return math.vec2(this.y, this.y);
                },
                set: function (v2fVec) {
                    this.y = v2fVec.x;
                    this.y = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "yz", {
                get: function () {
                    return math.vec2(this.y, this.z);
                },
                set: function (v2fVec) {
                    this.y = v2fVec.x;
                    this.z = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "zx", {
                get: function () {
                    return math.vec2(this.z, this.x);
                },
                set: function (v2fVec) {
                    this.z = v2fVec.x;
                    this.x = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "zy", {
                get: function () {
                    return math.vec2(this.z, this.y);
                },
                set: function (v2fVec) {
                    this.z = v2fVec.x;
                    this.y = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "zz", {
                get: function () {
                    return math.vec2(this.z, this.z);
                },
                set: function (v2fVec) {
                    this.z = v2fVec.x;
                    this.z = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "xxx", {
                get: function () {
                    return math.vec3(this.x, this.x, this.x);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.x = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "xxy", {
                get: function () {
                    return math.vec3(this.x, this.x, this.y);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.x = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "xxz", {
                get: function () {
                    return math.vec3(this.x, this.x, this.z);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.x = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "xyx", {
                get: function () {
                    return math.vec3(this.x, this.y, this.x);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.y = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "xyy", {
                get: function () {
                    return math.vec3(this.x, this.y, this.y);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.y = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "xyz", {
                get: function () {
                    return math.vec3(this.x, this.y, this.z);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.y = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "xzx", {
                get: function () {
                    return math.vec3(this.x, this.z, this.x);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.z = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "xzy", {
                get: function () {
                    return math.vec3(this.x, this.z, this.y);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.z = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "xzz", {
                get: function () {
                    return math.vec3(this.x, this.z, this.z);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.z = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "yxx", {
                get: function () {
                    return math.vec3(this.y, this.x, this.x);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.x = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "yxy", {
                get: function () {
                    return math.vec3(this.y, this.x, this.y);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.x = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "yxz", {
                get: function () {
                    return math.vec3(this.y, this.x, this.z);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.x = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "yyx", {
                get: function () {
                    return math.vec3(this.y, this.y, this.x);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.y = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "yyy", {
                get: function () {
                    return math.vec3(this.y, this.y, this.y);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.y = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "yyz", {
                get: function () {
                    return math.vec3(this.y, this.y, this.z);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.y = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "yzx", {
                get: function () {
                    return math.vec3(this.y, this.z, this.x);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.z = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "yzy", {
                get: function () {
                    return math.vec3(this.y, this.z, this.y);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.z = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "yzz", {
                get: function () {
                    return math.vec3(this.y, this.z, this.z);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.z = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "zxx", {
                get: function () {
                    return math.vec3(this.z, this.x, this.x);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.x = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "zxy", {
                get: function () {
                    return math.vec3(this.z, this.x, this.y);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.x = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "zxz", {
                get: function () {
                    return math.vec3(this.z, this.x, this.z);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.x = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "zyx", {
                get: function () {
                    return math.vec3(this.z, this.y, this.x);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.y = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "zyy", {
                get: function () {
                    return math.vec3(this.z, this.y, this.y);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.y = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "zyz", {
                get: function () {
                    return math.vec3(this.z, this.y, this.z);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.y = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "zzx", {
                get: function () {
                    return math.vec3(this.z, this.z, this.x);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.z = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "zzy", {
                get: function () {
                    return math.vec3(this.z, this.z, this.y);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.z = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec3.prototype, "zzz", {
                get: function () {
                    return math.vec3(this.z, this.z, this.z);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.z = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Vec3.prototype.set = function (fValue1, fValue2, fValue3) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 0:
                        this.x = this.y = this.z = 0.;
                        break;
                    case 1:
                        if ((typeof (arguments[0]) === "number")) {
                            this.x = this.y = this.z = arguments[0];
                        } else if (arguments[0] instanceof Vec3) {
                            var v3fVec = arguments[0];
                            this.x = v3fVec.x;
                            this.y = v3fVec.y;
                            this.z = v3fVec.z;
                        } else {
                            var pArray = arguments[0];
                            this.x = pArray[0];
                            this.y = pArray[1];
                            this.z = pArray[2];
                        }
                        break;
                    case 2:
                        if ((typeof (arguments[0]) === "number")) {
                            var fValue = arguments[0];
                            var v2fVec = arguments[1];
                            this.x = fValue;
                            this.y = v2fVec.x;
                            this.z = v2fVec.y;
                        } else {
                            var v2fVec = arguments[0];
                            var fValue = arguments[1];
                            this.x = v2fVec.x;
                            this.y = v2fVec.y;
                            this.z = fValue;
                        }
                        break;
                    case 3:
                        this.x = arguments[0];
                        this.y = arguments[1];
                        this.z = arguments[2];
                        break;
                }
                return this;
            };
            Vec3.prototype.clear = function () {
                this.x = this.y = this.z = 0.;
                return this;
            };
            Vec3.prototype.add = function (v3fVec, v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = this;
                }
                v3fDestination.x = this.x + v3fVec.x;
                v3fDestination.y = this.y + v3fVec.y;
                v3fDestination.z = this.z + v3fVec.z;
                return v3fDestination;
            };
            Vec3.prototype.subtract = function (v3fVec, v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = this;
                }
                v3fDestination.x = this.x - v3fVec.x;
                v3fDestination.y = this.y - v3fVec.y;
                v3fDestination.z = this.z - v3fVec.z;
                return v3fDestination;
            };
            Vec3.prototype.dot = function (v3fVec) {
                return this.x * v3fVec.x + this.y * v3fVec.y + this.z * v3fVec.z;
            };
            Vec3.prototype.cross = function (v3fVec, v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = this;
                }
                var x1 = this.x, y1 = this.y, z1 = this.z;
                var x2 = v3fVec.x, y2 = v3fVec.y, z2 = v3fVec.z;
                v3fDestination.x = y1 * z2 - z1 * y2;
                v3fDestination.y = z1 * x2 - x1 * z2;
                v3fDestination.z = x1 * y2 - y1 * x2;
                return v3fDestination;
            };
            Vec3.prototype.isEqual = function (v3fVec, fEps) {
                if (typeof fEps === "undefined") { fEps = 0.; }
                if (fEps === 0.) {
                    if (this.x != v3fVec.x || this.y != v3fVec.y || this.z != v3fVec.z) {
                        return false;
                    }
                } else {
                    if (math.abs(this.x - v3fVec.x) > fEps || math.abs(this.y - v3fVec.y) > fEps || math.abs(this.z - v3fVec.z) > fEps) {
                        return false;
                    }
                }
                return true;
            };
            Vec3.prototype.isClear = function (fEps) {
                if (typeof fEps === "undefined") { fEps = 0.; }
                if (fEps === 0.) {
                    if (this.x != 0. || this.y != 0. || this.z != 0.) {
                        return false;
                    }
                } else {
                    if (math.abs(this.x) > fEps || math.abs(this.y) > fEps || math.abs(this.z) > fEps) {
                        return false;
                    }
                }
                return true;
            };
            Vec3.prototype.negate = function (v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = this;
                }
                v3fDestination.x = -this.x;
                v3fDestination.y = -this.y;
                v3fDestination.z = -this.z;
                return v3fDestination;
            };
            Vec3.prototype.scale = function (fScale, v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = this;
                }
                if ((typeof (arguments[0]) === "number")) {
                    var fScale = arguments[0];
                    v3fDestination.x = this.x * fScale;
                    v3fDestination.y = this.y * fScale;
                    v3fDestination.z = this.z * fScale;
                } else {
                    var v3fScale = arguments[0];
                    v3fDestination.x = this.x * v3fScale.x;
                    v3fDestination.y = this.y * v3fScale.y;
                    v3fDestination.z = this.z * v3fScale.z;
                }
                return v3fDestination;
            };
            Vec3.prototype.normalize = function (v3fDestination) {
                if (!v3fDestination) {
                    v3fDestination = this;
                }
                var x = this.x, y = this.y, z = this.z;
                var fLength = math.sqrt(x * x + y * y + z * z);
                if (fLength !== 0.) {
                    var fInvLength = 1. / fLength;
                    x *= fInvLength;
                    y *= fInvLength;
                    z *= fInvLength;
                }
                v3fDestination.x = x;
                v3fDestination.y = y;
                v3fDestination.z = z;
                return v3fDestination;
            };
            Vec3.prototype.length = function () {
                var x = this.x, y = this.y, z = this.z;
                return math.sqrt(x * x + y * y + z * z);
            };
            Vec3.prototype.lengthSquare = function () {
                var x = this.x, y = this.y, z = this.z;
                return x * x + y * y + z * z;
            };
            Vec3.prototype.direction = function (v3fVec, v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = this;
                }
                var x = v3fVec.x - this.x;
                var y = v3fVec.y - this.y;
                var z = v3fVec.z - this.z;
                var fLength = math.sqrt(x * x + y * y + z * z);
                if (fLength !== 0.) {
                    var fInvLength = 1. / fLength;
                    x *= fInvLength;
                    y *= fInvLength;
                    z *= fInvLength;
                }
                v3fDestination.x = x;
                v3fDestination.y = y;
                v3fDestination.z = z;
                return v3fDestination;
            };
            Vec3.prototype.mix = function (v3fVec, fA, v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = this;
                }
                fA = (/*checked (origin: math)>>*/akra.math.max((0.), /*checked (origin: math)>>*/akra.math.min((fA), (1.))));
                var fA1 = 1. - fA;
                var fA2 = fA;
                v3fDestination.x = fA1 * this.x + fA2 * v3fVec.x;
                v3fDestination.y = fA1 * this.y + fA2 * v3fVec.y;
                v3fDestination.z = fA1 * this.z + fA2 * v3fVec.z;
                return v3fDestination;
            };
            Vec3.prototype.toString = function () {
                return "[x: " + this.x + " ,y: " + this.y + ", z: " + this.z + "]";
            };
            Vec3.prototype.toTranslationMatrix = function (m4fDestination) {
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = new math.Mat4(1.);
                } else {
                    m4fDestination.set(1.);
                }
                var pData = m4fDestination.data;
                pData[12] = this.x;
                pData[13] = this.y;
                pData[14] = this.z;
                return m4fDestination;
            };
            Vec3.prototype.vec3TransformCoord = function (m4fTransformation, v3fDestination) {
                if (!v3fDestination) {
                    v3fDestination = this;
                }
                var pData = m4fTransformation.data;
                var x = this.x;
                var y = this.y;
                var z = this.z;
                var w;
                x = pData[0] * x + pData[4] * y + pData[8] * z + pData[12];
                y = pData[1] * x + pData[5] * y + pData[9] * z + pData[13];
                z = pData[2] * x + pData[6] * y + pData[10] * z + pData[14];
                w = pData[2] * x + pData[7] * y + pData[11] * z + pData[15];
                var fInvW = 1. / w;
                v3fDestination.x = x * fInvW;
                v3fDestination.y = y * fInvW;
                v3fDestination.z = z * fInvW;
                return v3fDestination;
            };
            Object.defineProperty(Vec3, "stackCeil", {
                get: function () {
                    Vec3.stackPosition = Vec3.stackPosition === Vec3.stackSize - 1 ? 0 : Vec3.stackPosition;
                    return Vec3.stack[Vec3.stackPosition++];
                },
                enumerable: true,
                configurable: true
            });
            Vec3.stackSize = 100;
            Vec3.stackPosition = 0;
            Vec3.stack = (function () {
                var pStack = new Array(Vec3.stackSize);
                for(var i = 0; i < Vec3.stackSize; i++) {
                    pStack[i] = new Vec3();
                }
                return pStack;
            })();
            return Vec3;
        })();
        math.Vec3 = Vec3;        
    })(akra.math || (akra.math = {}));
    var math = akra.math;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (math) {
        var Vec4 = (function () {
            function Vec4(fValue1, fValue2, fValue3, fValue4) {
                var nArgumentsLength = arguments.length;
                var v4fVec = this;
                switch(nArgumentsLength) {
                    case 1:
                        v4fVec.set(arguments[0]);
                        break;
                    case 2:
                        v4fVec.set(arguments[0], arguments[1]);
                        break;
                    case 3:
                        v4fVec.set(arguments[0], arguments[1], arguments[2]);
                        break;
                    case 4:
                        v4fVec.set(arguments[0], arguments[1], arguments[2], arguments[3]);
                        break;
                    default:
                        v4fVec.x = v4fVec.y = v4fVec.z = v4fVec.w = 0.;
                        break;
                }
            }
            Object.defineProperty(Vec4.prototype, "xx", {
                get: function () {
                    return math.vec2(this.x, this.x);
                },
                set: function (v2fVec) {
                    this.x = v2fVec.x;
                    this.x = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xy", {
                get: function () {
                    return math.vec2(this.x, this.y);
                },
                set: function (v2fVec) {
                    this.x = v2fVec.x;
                    this.y = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xz", {
                get: function () {
                    return math.vec2(this.x, this.z);
                },
                set: function (v2fVec) {
                    this.x = v2fVec.x;
                    this.z = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xw", {
                get: function () {
                    return math.vec2(this.x, this.w);
                },
                set: function (v2fVec) {
                    this.x = v2fVec.x;
                    this.w = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yx", {
                get: function () {
                    return math.vec2(this.y, this.x);
                },
                set: function (v2fVec) {
                    this.y = v2fVec.x;
                    this.x = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yy", {
                get: function () {
                    return math.vec2(this.y, this.y);
                },
                set: function (v2fVec) {
                    this.y = v2fVec.x;
                    this.y = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yz", {
                get: function () {
                    return math.vec2(this.y, this.z);
                },
                set: function (v2fVec) {
                    this.y = v2fVec.x;
                    this.z = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yw", {
                get: function () {
                    return math.vec2(this.y, this.w);
                },
                set: function (v2fVec) {
                    this.y = v2fVec.x;
                    this.w = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zx", {
                get: function () {
                    return math.vec2(this.z, this.x);
                },
                set: function (v2fVec) {
                    this.z = v2fVec.x;
                    this.x = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zy", {
                get: function () {
                    return math.vec2(this.z, this.y);
                },
                set: function (v2fVec) {
                    this.z = v2fVec.x;
                    this.y = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zz", {
                get: function () {
                    return math.vec2(this.z, this.z);
                },
                set: function (v2fVec) {
                    this.z = v2fVec.x;
                    this.z = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zw", {
                get: function () {
                    return math.vec2(this.z, this.w);
                },
                set: function (v2fVec) {
                    this.z = v2fVec.x;
                    this.w = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wx", {
                get: function () {
                    return math.vec2(this.w, this.x);
                },
                set: function (v2fVec) {
                    this.w = v2fVec.x;
                    this.x = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wy", {
                get: function () {
                    return math.vec2(this.w, this.y);
                },
                set: function (v2fVec) {
                    this.w = v2fVec.x;
                    this.y = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wz", {
                get: function () {
                    return math.vec2(this.w, this.z);
                },
                set: function (v2fVec) {
                    this.w = v2fVec.x;
                    this.z = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ww", {
                get: function () {
                    return math.vec2(this.w, this.w);
                },
                set: function (v2fVec) {
                    this.w = v2fVec.x;
                    this.w = v2fVec.y;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxx", {
                get: function () {
                    return math.vec3(this.x, this.x, this.x);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.x = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxy", {
                get: function () {
                    return math.vec3(this.x, this.x, this.y);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.x = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxz", {
                get: function () {
                    return math.vec3(this.x, this.x, this.z);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.x = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxw", {
                get: function () {
                    return math.vec3(this.x, this.x, this.w);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.x = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyx", {
                get: function () {
                    return math.vec3(this.x, this.y, this.x);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.y = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyy", {
                get: function () {
                    return math.vec3(this.x, this.y, this.y);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.y = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyz", {
                get: function () {
                    return math.vec3(this.x, this.y, this.z);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.y = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyw", {
                get: function () {
                    return math.vec3(this.x, this.y, this.w);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.y = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzx", {
                get: function () {
                    return math.vec3(this.x, this.z, this.x);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.z = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzy", {
                get: function () {
                    return math.vec3(this.x, this.z, this.y);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.z = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzz", {
                get: function () {
                    return math.vec3(this.x, this.z, this.z);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.z = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzw", {
                get: function () {
                    return math.vec3(this.x, this.z, this.w);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.z = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwx", {
                get: function () {
                    return math.vec3(this.x, this.w, this.x);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.w = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwy", {
                get: function () {
                    return math.vec3(this.x, this.w, this.y);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.w = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwz", {
                get: function () {
                    return math.vec3(this.x, this.w, this.z);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.w = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xww", {
                get: function () {
                    return math.vec3(this.x, this.w, this.w);
                },
                set: function (v3fVec) {
                    this.x = v3fVec.x;
                    this.w = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxx", {
                get: function () {
                    return math.vec3(this.y, this.x, this.x);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.x = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxy", {
                get: function () {
                    return math.vec3(this.y, this.x, this.y);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.x = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxz", {
                get: function () {
                    return math.vec3(this.y, this.x, this.z);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.x = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxw", {
                get: function () {
                    return math.vec3(this.y, this.x, this.w);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.x = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyx", {
                get: function () {
                    return math.vec3(this.y, this.y, this.x);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.y = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyy", {
                get: function () {
                    return math.vec3(this.y, this.y, this.y);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.y = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyz", {
                get: function () {
                    return math.vec3(this.y, this.y, this.z);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.y = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyw", {
                get: function () {
                    return math.vec3(this.y, this.y, this.w);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.y = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzx", {
                get: function () {
                    return math.vec3(this.y, this.z, this.x);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.z = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzy", {
                get: function () {
                    return math.vec3(this.y, this.z, this.y);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.z = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzz", {
                get: function () {
                    return math.vec3(this.y, this.z, this.z);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.z = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzw", {
                get: function () {
                    return math.vec3(this.y, this.z, this.w);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.z = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywx", {
                get: function () {
                    return math.vec3(this.y, this.w, this.x);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.w = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywy", {
                get: function () {
                    return math.vec3(this.y, this.w, this.y);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.w = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywz", {
                get: function () {
                    return math.vec3(this.y, this.w, this.z);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.w = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yww", {
                get: function () {
                    return math.vec3(this.y, this.w, this.w);
                },
                set: function (v3fVec) {
                    this.y = v3fVec.x;
                    this.w = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxx", {
                get: function () {
                    return math.vec3(this.z, this.x, this.x);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.x = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxy", {
                get: function () {
                    return math.vec3(this.z, this.x, this.y);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.x = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxz", {
                get: function () {
                    return math.vec3(this.z, this.x, this.z);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.x = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxw", {
                get: function () {
                    return math.vec3(this.z, this.x, this.w);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.x = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyx", {
                get: function () {
                    return math.vec3(this.z, this.y, this.x);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.y = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyy", {
                get: function () {
                    return math.vec3(this.z, this.y, this.y);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.y = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyz", {
                get: function () {
                    return math.vec3(this.z, this.y, this.z);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.y = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyw", {
                get: function () {
                    return math.vec3(this.z, this.y, this.w);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.y = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzx", {
                get: function () {
                    return math.vec3(this.z, this.z, this.x);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.z = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzy", {
                get: function () {
                    return math.vec3(this.z, this.z, this.y);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.z = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzz", {
                get: function () {
                    return math.vec3(this.z, this.z, this.z);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.z = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzw", {
                get: function () {
                    return math.vec3(this.z, this.z, this.w);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.z = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwx", {
                get: function () {
                    return math.vec3(this.z, this.w, this.x);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.w = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwy", {
                get: function () {
                    return math.vec3(this.z, this.w, this.y);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.w = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwz", {
                get: function () {
                    return math.vec3(this.z, this.w, this.z);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.w = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zww", {
                get: function () {
                    return math.vec3(this.z, this.w, this.w);
                },
                set: function (v3fVec) {
                    this.z = v3fVec.x;
                    this.w = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxx", {
                get: function () {
                    return math.vec3(this.w, this.x, this.x);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.x = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxy", {
                get: function () {
                    return math.vec3(this.w, this.x, this.y);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.x = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxz", {
                get: function () {
                    return math.vec3(this.w, this.x, this.z);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.x = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxw", {
                get: function () {
                    return math.vec3(this.w, this.x, this.w);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.x = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyx", {
                get: function () {
                    return math.vec3(this.w, this.y, this.x);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.y = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyy", {
                get: function () {
                    return math.vec3(this.w, this.y, this.y);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.y = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyz", {
                get: function () {
                    return math.vec3(this.w, this.y, this.z);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.y = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyw", {
                get: function () {
                    return math.vec3(this.w, this.y, this.w);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.y = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzx", {
                get: function () {
                    return math.vec3(this.w, this.z, this.x);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.z = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzy", {
                get: function () {
                    return math.vec3(this.w, this.z, this.y);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.z = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzz", {
                get: function () {
                    return math.vec3(this.w, this.z, this.z);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.z = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzw", {
                get: function () {
                    return math.vec3(this.w, this.z, this.w);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.z = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwx", {
                get: function () {
                    return math.vec3(this.w, this.w, this.x);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.w = v3fVec.y;
                    this.x = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwy", {
                get: function () {
                    return math.vec3(this.w, this.w, this.y);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.w = v3fVec.y;
                    this.y = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwz", {
                get: function () {
                    return math.vec3(this.w, this.w, this.z);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.w = v3fVec.y;
                    this.z = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "www", {
                get: function () {
                    return math.vec3(this.w, this.w, this.w);
                },
                set: function (v3fVec) {
                    this.w = v3fVec.x;
                    this.w = v3fVec.y;
                    this.w = v3fVec.z;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxxx", {
                get: function () {
                    return math.vec4(this.x, this.x, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxxy", {
                get: function () {
                    return math.vec4(this.x, this.x, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxxz", {
                get: function () {
                    return math.vec4(this.x, this.x, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxxw", {
                get: function () {
                    return math.vec4(this.x, this.x, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxyx", {
                get: function () {
                    return math.vec4(this.x, this.x, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxyy", {
                get: function () {
                    return math.vec4(this.x, this.x, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxyz", {
                get: function () {
                    return math.vec4(this.x, this.x, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxyw", {
                get: function () {
                    return math.vec4(this.x, this.x, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxzx", {
                get: function () {
                    return math.vec4(this.x, this.x, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxzy", {
                get: function () {
                    return math.vec4(this.x, this.x, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxzz", {
                get: function () {
                    return math.vec4(this.x, this.x, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxzw", {
                get: function () {
                    return math.vec4(this.x, this.x, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxwx", {
                get: function () {
                    return math.vec4(this.x, this.x, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxwy", {
                get: function () {
                    return math.vec4(this.x, this.x, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxwz", {
                get: function () {
                    return math.vec4(this.x, this.x, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xxww", {
                get: function () {
                    return math.vec4(this.x, this.x, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyxx", {
                get: function () {
                    return math.vec4(this.x, this.y, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyxy", {
                get: function () {
                    return math.vec4(this.x, this.y, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyxz", {
                get: function () {
                    return math.vec4(this.x, this.y, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyxw", {
                get: function () {
                    return math.vec4(this.x, this.y, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyyx", {
                get: function () {
                    return math.vec4(this.x, this.y, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyyy", {
                get: function () {
                    return math.vec4(this.x, this.y, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyyz", {
                get: function () {
                    return math.vec4(this.x, this.y, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyyw", {
                get: function () {
                    return math.vec4(this.x, this.y, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyzx", {
                get: function () {
                    return math.vec4(this.x, this.y, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyzy", {
                get: function () {
                    return math.vec4(this.x, this.y, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyzz", {
                get: function () {
                    return math.vec4(this.x, this.y, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyzw", {
                get: function () {
                    return math.vec4(this.x, this.y, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xywx", {
                get: function () {
                    return math.vec4(this.x, this.y, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xywy", {
                get: function () {
                    return math.vec4(this.x, this.y, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xywz", {
                get: function () {
                    return math.vec4(this.x, this.y, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xyww", {
                get: function () {
                    return math.vec4(this.x, this.y, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzxx", {
                get: function () {
                    return math.vec4(this.x, this.z, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzxy", {
                get: function () {
                    return math.vec4(this.x, this.z, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzxz", {
                get: function () {
                    return math.vec4(this.x, this.z, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzxw", {
                get: function () {
                    return math.vec4(this.x, this.z, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzyx", {
                get: function () {
                    return math.vec4(this.x, this.z, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzyy", {
                get: function () {
                    return math.vec4(this.x, this.z, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzyz", {
                get: function () {
                    return math.vec4(this.x, this.z, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzyw", {
                get: function () {
                    return math.vec4(this.x, this.z, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzzx", {
                get: function () {
                    return math.vec4(this.x, this.z, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzzy", {
                get: function () {
                    return math.vec4(this.x, this.z, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzzz", {
                get: function () {
                    return math.vec4(this.x, this.z, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzzw", {
                get: function () {
                    return math.vec4(this.x, this.z, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzwx", {
                get: function () {
                    return math.vec4(this.x, this.z, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzwy", {
                get: function () {
                    return math.vec4(this.x, this.z, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzwz", {
                get: function () {
                    return math.vec4(this.x, this.z, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xzww", {
                get: function () {
                    return math.vec4(this.x, this.z, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwxx", {
                get: function () {
                    return math.vec4(this.x, this.w, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwxy", {
                get: function () {
                    return math.vec4(this.x, this.w, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwxz", {
                get: function () {
                    return math.vec4(this.x, this.w, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwxw", {
                get: function () {
                    return math.vec4(this.x, this.w, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwyx", {
                get: function () {
                    return math.vec4(this.x, this.w, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwyy", {
                get: function () {
                    return math.vec4(this.x, this.w, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwyz", {
                get: function () {
                    return math.vec4(this.x, this.w, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwyw", {
                get: function () {
                    return math.vec4(this.x, this.w, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwzx", {
                get: function () {
                    return math.vec4(this.x, this.w, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwzy", {
                get: function () {
                    return math.vec4(this.x, this.w, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwzz", {
                get: function () {
                    return math.vec4(this.x, this.w, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwzw", {
                get: function () {
                    return math.vec4(this.x, this.w, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwwx", {
                get: function () {
                    return math.vec4(this.x, this.w, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwwy", {
                get: function () {
                    return math.vec4(this.x, this.w, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwwz", {
                get: function () {
                    return math.vec4(this.x, this.w, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "xwww", {
                get: function () {
                    return math.vec4(this.x, this.w, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.x = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxxx", {
                get: function () {
                    return math.vec4(this.y, this.x, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxxy", {
                get: function () {
                    return math.vec4(this.y, this.x, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxxz", {
                get: function () {
                    return math.vec4(this.y, this.x, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxxw", {
                get: function () {
                    return math.vec4(this.y, this.x, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxyx", {
                get: function () {
                    return math.vec4(this.y, this.x, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxyy", {
                get: function () {
                    return math.vec4(this.y, this.x, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxyz", {
                get: function () {
                    return math.vec4(this.y, this.x, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxyw", {
                get: function () {
                    return math.vec4(this.y, this.x, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxzx", {
                get: function () {
                    return math.vec4(this.y, this.x, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxzy", {
                get: function () {
                    return math.vec4(this.y, this.x, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxzz", {
                get: function () {
                    return math.vec4(this.y, this.x, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxzw", {
                get: function () {
                    return math.vec4(this.y, this.x, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxwx", {
                get: function () {
                    return math.vec4(this.y, this.x, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxwy", {
                get: function () {
                    return math.vec4(this.y, this.x, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxwz", {
                get: function () {
                    return math.vec4(this.y, this.x, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yxww", {
                get: function () {
                    return math.vec4(this.y, this.x, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyxx", {
                get: function () {
                    return math.vec4(this.y, this.y, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyxy", {
                get: function () {
                    return math.vec4(this.y, this.y, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyxz", {
                get: function () {
                    return math.vec4(this.y, this.y, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyxw", {
                get: function () {
                    return math.vec4(this.y, this.y, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyyx", {
                get: function () {
                    return math.vec4(this.y, this.y, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyyy", {
                get: function () {
                    return math.vec4(this.y, this.y, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyyz", {
                get: function () {
                    return math.vec4(this.y, this.y, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyyw", {
                get: function () {
                    return math.vec4(this.y, this.y, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyzx", {
                get: function () {
                    return math.vec4(this.y, this.y, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyzy", {
                get: function () {
                    return math.vec4(this.y, this.y, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyzz", {
                get: function () {
                    return math.vec4(this.y, this.y, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyzw", {
                get: function () {
                    return math.vec4(this.y, this.y, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yywx", {
                get: function () {
                    return math.vec4(this.y, this.y, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yywy", {
                get: function () {
                    return math.vec4(this.y, this.y, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yywz", {
                get: function () {
                    return math.vec4(this.y, this.y, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yyww", {
                get: function () {
                    return math.vec4(this.y, this.y, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzxx", {
                get: function () {
                    return math.vec4(this.y, this.z, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzxy", {
                get: function () {
                    return math.vec4(this.y, this.z, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzxz", {
                get: function () {
                    return math.vec4(this.y, this.z, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzxw", {
                get: function () {
                    return math.vec4(this.y, this.z, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzyx", {
                get: function () {
                    return math.vec4(this.y, this.z, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzyy", {
                get: function () {
                    return math.vec4(this.y, this.z, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzyz", {
                get: function () {
                    return math.vec4(this.y, this.z, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzyw", {
                get: function () {
                    return math.vec4(this.y, this.z, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzzx", {
                get: function () {
                    return math.vec4(this.y, this.z, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzzy", {
                get: function () {
                    return math.vec4(this.y, this.z, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzzz", {
                get: function () {
                    return math.vec4(this.y, this.z, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzzw", {
                get: function () {
                    return math.vec4(this.y, this.z, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzwx", {
                get: function () {
                    return math.vec4(this.y, this.z, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzwy", {
                get: function () {
                    return math.vec4(this.y, this.z, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzwz", {
                get: function () {
                    return math.vec4(this.y, this.z, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "yzww", {
                get: function () {
                    return math.vec4(this.y, this.z, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywxx", {
                get: function () {
                    return math.vec4(this.y, this.w, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywxy", {
                get: function () {
                    return math.vec4(this.y, this.w, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywxz", {
                get: function () {
                    return math.vec4(this.y, this.w, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywxw", {
                get: function () {
                    return math.vec4(this.y, this.w, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywyx", {
                get: function () {
                    return math.vec4(this.y, this.w, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywyy", {
                get: function () {
                    return math.vec4(this.y, this.w, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywyz", {
                get: function () {
                    return math.vec4(this.y, this.w, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywyw", {
                get: function () {
                    return math.vec4(this.y, this.w, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywzx", {
                get: function () {
                    return math.vec4(this.y, this.w, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywzy", {
                get: function () {
                    return math.vec4(this.y, this.w, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywzz", {
                get: function () {
                    return math.vec4(this.y, this.w, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywzw", {
                get: function () {
                    return math.vec4(this.y, this.w, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywwx", {
                get: function () {
                    return math.vec4(this.y, this.w, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywwy", {
                get: function () {
                    return math.vec4(this.y, this.w, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywwz", {
                get: function () {
                    return math.vec4(this.y, this.w, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "ywww", {
                get: function () {
                    return math.vec4(this.y, this.w, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.y = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxxx", {
                get: function () {
                    return math.vec4(this.z, this.x, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxxy", {
                get: function () {
                    return math.vec4(this.z, this.x, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxxz", {
                get: function () {
                    return math.vec4(this.z, this.x, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxxw", {
                get: function () {
                    return math.vec4(this.z, this.x, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxyx", {
                get: function () {
                    return math.vec4(this.z, this.x, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxyy", {
                get: function () {
                    return math.vec4(this.z, this.x, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxyz", {
                get: function () {
                    return math.vec4(this.z, this.x, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxyw", {
                get: function () {
                    return math.vec4(this.z, this.x, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxzx", {
                get: function () {
                    return math.vec4(this.z, this.x, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxzy", {
                get: function () {
                    return math.vec4(this.z, this.x, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxzz", {
                get: function () {
                    return math.vec4(this.z, this.x, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxzw", {
                get: function () {
                    return math.vec4(this.z, this.x, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxwx", {
                get: function () {
                    return math.vec4(this.z, this.x, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxwy", {
                get: function () {
                    return math.vec4(this.z, this.x, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxwz", {
                get: function () {
                    return math.vec4(this.z, this.x, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zxww", {
                get: function () {
                    return math.vec4(this.z, this.x, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyxx", {
                get: function () {
                    return math.vec4(this.z, this.y, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyxy", {
                get: function () {
                    return math.vec4(this.z, this.y, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyxz", {
                get: function () {
                    return math.vec4(this.z, this.y, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyxw", {
                get: function () {
                    return math.vec4(this.z, this.y, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyyx", {
                get: function () {
                    return math.vec4(this.z, this.y, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyyy", {
                get: function () {
                    return math.vec4(this.z, this.y, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyyz", {
                get: function () {
                    return math.vec4(this.z, this.y, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyyw", {
                get: function () {
                    return math.vec4(this.z, this.y, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyzx", {
                get: function () {
                    return math.vec4(this.z, this.y, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyzy", {
                get: function () {
                    return math.vec4(this.z, this.y, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyzz", {
                get: function () {
                    return math.vec4(this.z, this.y, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyzw", {
                get: function () {
                    return math.vec4(this.z, this.y, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zywx", {
                get: function () {
                    return math.vec4(this.z, this.y, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zywy", {
                get: function () {
                    return math.vec4(this.z, this.y, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zywz", {
                get: function () {
                    return math.vec4(this.z, this.y, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zyww", {
                get: function () {
                    return math.vec4(this.z, this.y, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzxx", {
                get: function () {
                    return math.vec4(this.z, this.z, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzxy", {
                get: function () {
                    return math.vec4(this.z, this.z, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzxz", {
                get: function () {
                    return math.vec4(this.z, this.z, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzxw", {
                get: function () {
                    return math.vec4(this.z, this.z, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzyx", {
                get: function () {
                    return math.vec4(this.z, this.z, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzyy", {
                get: function () {
                    return math.vec4(this.z, this.z, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzyz", {
                get: function () {
                    return math.vec4(this.z, this.z, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzyw", {
                get: function () {
                    return math.vec4(this.z, this.z, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzzx", {
                get: function () {
                    return math.vec4(this.z, this.z, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzzy", {
                get: function () {
                    return math.vec4(this.z, this.z, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzzz", {
                get: function () {
                    return math.vec4(this.z, this.z, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzzw", {
                get: function () {
                    return math.vec4(this.z, this.z, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzwx", {
                get: function () {
                    return math.vec4(this.z, this.z, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzwy", {
                get: function () {
                    return math.vec4(this.z, this.z, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzwz", {
                get: function () {
                    return math.vec4(this.z, this.z, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zzww", {
                get: function () {
                    return math.vec4(this.z, this.z, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwxx", {
                get: function () {
                    return math.vec4(this.z, this.w, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwxy", {
                get: function () {
                    return math.vec4(this.z, this.w, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwxz", {
                get: function () {
                    return math.vec4(this.z, this.w, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwxw", {
                get: function () {
                    return math.vec4(this.z, this.w, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwyx", {
                get: function () {
                    return math.vec4(this.z, this.w, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwyy", {
                get: function () {
                    return math.vec4(this.z, this.w, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwyz", {
                get: function () {
                    return math.vec4(this.z, this.w, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwyw", {
                get: function () {
                    return math.vec4(this.z, this.w, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwzx", {
                get: function () {
                    return math.vec4(this.z, this.w, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwzy", {
                get: function () {
                    return math.vec4(this.z, this.w, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwzz", {
                get: function () {
                    return math.vec4(this.z, this.w, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwzw", {
                get: function () {
                    return math.vec4(this.z, this.w, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwwx", {
                get: function () {
                    return math.vec4(this.z, this.w, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwwy", {
                get: function () {
                    return math.vec4(this.z, this.w, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwwz", {
                get: function () {
                    return math.vec4(this.z, this.w, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "zwww", {
                get: function () {
                    return math.vec4(this.z, this.w, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.z = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxxx", {
                get: function () {
                    return math.vec4(this.w, this.x, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxxy", {
                get: function () {
                    return math.vec4(this.w, this.x, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxxz", {
                get: function () {
                    return math.vec4(this.w, this.x, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxxw", {
                get: function () {
                    return math.vec4(this.w, this.x, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxyx", {
                get: function () {
                    return math.vec4(this.w, this.x, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxyy", {
                get: function () {
                    return math.vec4(this.w, this.x, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxyz", {
                get: function () {
                    return math.vec4(this.w, this.x, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxyw", {
                get: function () {
                    return math.vec4(this.w, this.x, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxzx", {
                get: function () {
                    return math.vec4(this.w, this.x, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxzy", {
                get: function () {
                    return math.vec4(this.w, this.x, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxzz", {
                get: function () {
                    return math.vec4(this.w, this.x, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxzw", {
                get: function () {
                    return math.vec4(this.w, this.x, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxwx", {
                get: function () {
                    return math.vec4(this.w, this.x, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxwy", {
                get: function () {
                    return math.vec4(this.w, this.x, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxwz", {
                get: function () {
                    return math.vec4(this.w, this.x, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wxww", {
                get: function () {
                    return math.vec4(this.w, this.x, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.x = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyxx", {
                get: function () {
                    return math.vec4(this.w, this.y, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyxy", {
                get: function () {
                    return math.vec4(this.w, this.y, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyxz", {
                get: function () {
                    return math.vec4(this.w, this.y, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyxw", {
                get: function () {
                    return math.vec4(this.w, this.y, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyyx", {
                get: function () {
                    return math.vec4(this.w, this.y, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyyy", {
                get: function () {
                    return math.vec4(this.w, this.y, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyyz", {
                get: function () {
                    return math.vec4(this.w, this.y, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyyw", {
                get: function () {
                    return math.vec4(this.w, this.y, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyzx", {
                get: function () {
                    return math.vec4(this.w, this.y, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyzy", {
                get: function () {
                    return math.vec4(this.w, this.y, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyzz", {
                get: function () {
                    return math.vec4(this.w, this.y, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyzw", {
                get: function () {
                    return math.vec4(this.w, this.y, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wywx", {
                get: function () {
                    return math.vec4(this.w, this.y, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wywy", {
                get: function () {
                    return math.vec4(this.w, this.y, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wywz", {
                get: function () {
                    return math.vec4(this.w, this.y, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wyww", {
                get: function () {
                    return math.vec4(this.w, this.y, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.y = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzxx", {
                get: function () {
                    return math.vec4(this.w, this.z, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzxy", {
                get: function () {
                    return math.vec4(this.w, this.z, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzxz", {
                get: function () {
                    return math.vec4(this.w, this.z, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzxw", {
                get: function () {
                    return math.vec4(this.w, this.z, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzyx", {
                get: function () {
                    return math.vec4(this.w, this.z, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzyy", {
                get: function () {
                    return math.vec4(this.w, this.z, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzyz", {
                get: function () {
                    return math.vec4(this.w, this.z, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzyw", {
                get: function () {
                    return math.vec4(this.w, this.z, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzzx", {
                get: function () {
                    return math.vec4(this.w, this.z, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzzy", {
                get: function () {
                    return math.vec4(this.w, this.z, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzzz", {
                get: function () {
                    return math.vec4(this.w, this.z, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzzw", {
                get: function () {
                    return math.vec4(this.w, this.z, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzwx", {
                get: function () {
                    return math.vec4(this.w, this.z, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzwy", {
                get: function () {
                    return math.vec4(this.w, this.z, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzwz", {
                get: function () {
                    return math.vec4(this.w, this.z, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wzww", {
                get: function () {
                    return math.vec4(this.w, this.z, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.z = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwxx", {
                get: function () {
                    return math.vec4(this.w, this.w, this.x, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwxy", {
                get: function () {
                    return math.vec4(this.w, this.w, this.x, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwxz", {
                get: function () {
                    return math.vec4(this.w, this.w, this.x, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwxw", {
                get: function () {
                    return math.vec4(this.w, this.w, this.x, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.x = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwyx", {
                get: function () {
                    return math.vec4(this.w, this.w, this.y, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwyy", {
                get: function () {
                    return math.vec4(this.w, this.w, this.y, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwyz", {
                get: function () {
                    return math.vec4(this.w, this.w, this.y, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwyw", {
                get: function () {
                    return math.vec4(this.w, this.w, this.y, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.y = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwzx", {
                get: function () {
                    return math.vec4(this.w, this.w, this.z, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwzy", {
                get: function () {
                    return math.vec4(this.w, this.w, this.z, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwzz", {
                get: function () {
                    return math.vec4(this.w, this.w, this.z, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwzw", {
                get: function () {
                    return math.vec4(this.w, this.w, this.z, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.z = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwwx", {
                get: function () {
                    return math.vec4(this.w, this.w, this.w, this.x);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.x = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwwy", {
                get: function () {
                    return math.vec4(this.w, this.w, this.w, this.y);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.y = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwwz", {
                get: function () {
                    return math.vec4(this.w, this.w, this.w, this.z);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.z = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Vec4.prototype, "wwww", {
                get: function () {
                    return math.vec4(this.w, this.w, this.w, this.w);
                },
                set: function (v4fVec) {
                    this.w = v4fVec.x;
                    this.w = v4fVec.y;
                    this.w = v4fVec.z;
                    this.w = v4fVec.w;
                },
                enumerable: true,
                configurable: true
            });
            Vec4.prototype.set = function (fValue1, fValue2, fValue3, fValue4) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 0:
                        this.x = this.y = this.z = this.w = 0.;
                        break;
                    case 1:
                        if ((typeof (arguments[0]) === "number")) {
                            this.x = this.y = this.z = this.w = arguments[0];
                        } else if (arguments[0] instanceof Vec4) {
                            var v4fVec = arguments[0];
                            this.x = v4fVec.x;
                            this.y = v4fVec.y;
                            this.z = v4fVec.z;
                            this.w = v4fVec.w;
                        } else if (((arguments[0].r) !== undefined)) {
                            this.x = arguments[0].r;
                            this.y = arguments[0].g;
                            this.z = arguments[0].b;
                            this.w = arguments[0].a;
                        } else {
                            var pArray = arguments[0];
                            this.x = pArray[0];
                            this.y = pArray[1];
                            this.z = pArray[2];
                            this.w = pArray[3];
                        }
                        break;
                    case 2:
                        if ((typeof (arguments[0]) === "number")) {
                            var fValue = arguments[0];
                            var v3fVec = arguments[1];
                            this.x = fValue;
                            this.y = v3fVec.x;
                            this.z = v3fVec.y;
                            this.w = v3fVec.z;
                        } else if (arguments[0] instanceof math.Vec2) {
                            var v2fVec1 = arguments[0];
                            var v2fVec2 = arguments[1];
                            this.x = v2fVec1.x;
                            this.y = v2fVec1.y;
                            this.z = v2fVec2.x;
                            this.w = v2fVec2.y;
                        } else {
                            var v3fVec = arguments[0];
                            var fValue = arguments[1];
                            this.x = v3fVec.x;
                            this.y = v3fVec.y;
                            this.z = v3fVec.z;
                            this.w = fValue;
                        }
                        break;
                    case 3:
                        if ((typeof (arguments[0]) === "number")) {
                            var fValue1 = arguments[0];
                            if ((typeof (arguments[1]) === "number")) {
                                var fValue2 = arguments[1];
                                var v2fVec = arguments[2];
                                this.x = fValue1;
                                this.y = fValue2;
                                this.z = v2fVec.x;
                                this.w = v2fVec.y;
                            } else {
                                var v2fVec = arguments[1];
                                var fValue2 = arguments[2];
                                this.x = fValue1;
                                this.y = v2fVec.x;
                                this.z = v2fVec.y;
                                this.w = fValue2;
                            }
                        } else {
                            var v2fVec = arguments[0];
                            var fValue1 = arguments[1];
                            var fValue2 = arguments[2];
                            this.x = v2fVec.x;
                            this.y = v2fVec.y;
                            this.z = fValue1;
                            this.w = fValue2;
                        }
                        break;
                    case 4:
                        this.x = arguments[0];
                        this.y = arguments[1];
                        this.z = arguments[2];
                        this.w = arguments[3];
                        break;
                }
                return this;
            };
            Vec4.prototype.clear = function () {
                this.x = this.y = this.z = this.w = 0.;
                return this;
            };
            Vec4.prototype.add = function (v4fVec, v4fDestination) {
                if (!((v4fDestination) !== undefined)) {
                    v4fDestination = this;
                }
                v4fDestination.x = this.x + v4fVec.x;
                v4fDestination.y = this.y + v4fVec.y;
                v4fDestination.z = this.z + v4fVec.z;
                v4fDestination.w = this.w + v4fVec.w;
                return v4fDestination;
            };
            Vec4.prototype.subtract = function (v4fVec, v4fDestination) {
                if (!((v4fDestination) !== undefined)) {
                    v4fDestination = this;
                }
                v4fDestination.x = this.x - v4fVec.x;
                v4fDestination.y = this.y - v4fVec.y;
                v4fDestination.z = this.z - v4fVec.z;
                v4fDestination.w = this.w - v4fVec.w;
                return v4fDestination;
            };
            Vec4.prototype.dot = function (v4fVec) {
                return this.x * v4fVec.x + this.y * v4fVec.y + this.z * v4fVec.z + this.w * v4fVec.w;
            };
            Vec4.prototype.isEqual = function (v4fVec, fEps) {
                if (typeof fEps === "undefined") { fEps = 0.; }
                if (fEps === 0.) {
                    if (this.x != v4fVec.x || this.y != v4fVec.y || this.z != v4fVec.z || this.w != v4fVec.w) {
                        return false;
                    }
                } else {
                    if (math.abs(this.x - v4fVec.x) > fEps || math.abs(this.y - v4fVec.y) > fEps || math.abs(this.z - v4fVec.z) > fEps || math.abs(this.w - v4fVec.w) > fEps) {
                        return false;
                    }
                }
                return true;
            };
            Vec4.prototype.isClear = function (fEps) {
                if (typeof fEps === "undefined") { fEps = 0.; }
                if (fEps === 0.) {
                    if (this.x != 0. || this.y != 0. || this.z != 0. || this.w != 0.) {
                        return false;
                    }
                } else {
                    if (math.abs(this.x) > fEps || math.abs(this.y) > fEps || math.abs(this.z) > fEps || math.abs(this.w) > fEps) {
                        return false;
                    }
                }
                return true;
            };
            Vec4.prototype.negate = function (v4fDestination) {
                if (!((v4fDestination) !== undefined)) {
                    v4fDestination = this;
                }
                v4fDestination.x = -this.x;
                v4fDestination.y = -this.y;
                v4fDestination.z = -this.z;
                v4fDestination.w = -this.w;
                return v4fDestination;
            };
            Vec4.prototype.scale = function (fScale, v4fDestination) {
                if (!((v4fDestination) !== undefined)) {
                    v4fDestination = this;
                }
                v4fDestination.x = this.x * fScale;
                v4fDestination.y = this.y * fScale;
                v4fDestination.z = this.z * fScale;
                v4fDestination.w = this.w * fScale;
                return v4fDestination;
            };
            Vec4.prototype.normalize = function (v4fDestination) {
                if (!((v4fDestination) !== undefined)) {
                    v4fDestination = this;
                }
                var x = this.x, y = this.y, z = this.z, w = this.w;
                var fLength = math.sqrt(x * x + y * y + z * z + w * w);
                if (fLength !== 0.) {
                    var fInvLength = 1. / fLength;
                    x *= fInvLength;
                    y *= fInvLength;
                    z *= fInvLength;
                    w *= fInvLength;
                }
                v4fDestination.x = x;
                v4fDestination.y = y;
                v4fDestination.z = z;
                v4fDestination.w = w;
                return v4fDestination;
            };
            Vec4.prototype.length = function () {
                var x = this.x, y = this.y, z = this.z, w = this.w;
                return math.sqrt(x * x + y * y + z * z + w * w);
            };
            Vec4.prototype.lengthSquare = function () {
                var x = this.x, y = this.y, z = this.z, w = this.w;
                return x * x + y * y + z * z + w * w;
            };
            Vec4.prototype.direction = function (v4fVec, v4fDestination) {
                if (!((v4fDestination) !== undefined)) {
                    v4fDestination = this;
                }
                var x = v4fVec.x - this.x;
                var y = v4fVec.y - this.y;
                var z = v4fVec.z - this.z;
                var w = v4fVec.w - this.w;
                var fLength = math.sqrt(x * x + y * y + z * z + w * w);
                if (fLength !== 0.) {
                    var fInvLength = 1. / fLength;
                    x *= fInvLength;
                    y *= fInvLength;
                    z *= fInvLength;
                    w *= fInvLength;
                }
                v4fDestination.x = x;
                v4fDestination.y = y;
                v4fDestination.z = z;
                v4fDestination.w = w;
                return v4fDestination;
            };
            Vec4.prototype.mix = function (v4fVec, fA, v4fDestination) {
                if (!((v4fDestination) !== undefined)) {
                    v4fDestination = this;
                }
                fA = (/*checked (origin: math)>>*/akra.math.max((0.), /*checked (origin: math)>>*/akra.math.min((fA), (1.))));
                var fA1 = 1. - fA;
                var fA2 = fA;
                v4fDestination.x = fA1 * this.x + fA2 * v4fVec.x;
                v4fDestination.y = fA1 * this.y + fA2 * v4fVec.y;
                v4fDestination.z = fA1 * this.z + fA2 * v4fVec.z;
                v4fDestination.w = fA1 * this.w + fA2 * v4fVec.w;
                return v4fDestination;
            };
            Vec4.prototype.toString = function () {
                return "[x: " + this.x + ", y: " + this.y + ", z: " + this.z + ", w: " + this.w + "]";
            };
            Object.defineProperty(Vec4, "stackCeil", {
                get: function () {
                    Vec4.stackPosition = Vec4.stackPosition === Vec4.stackSize - 1 ? 0 : Vec4.stackPosition;
                    return Vec4.stack[Vec4.stackPosition++];
                },
                enumerable: true,
                configurable: true
            });
            Vec4.stackSize = 100;
            Vec4.stackPosition = 0;
            Vec4.stack = (function () {
                var pStack = new Array(Vec4.stackSize);
                for(var i = 0; i < Vec4.stackSize; i++) {
                    pStack[i] = new Vec4();
                }
                return pStack;
            })();
            return Vec4;
        })();
        math.Vec4 = Vec4;        
    })(akra.math || (akra.math = {}));
    var math = akra.math;
})(akra || (akra = {}));
;
;
var akra;
(function (akra) {
    (function (math) {
        var Mat3 = (function () {
            function Mat3(fValue1, fValue2, fValue3, fValue4, fValue5, fValue6, fValue7, fValue8, fValue9) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        this.set(arguments[0]);
                        break;
                    case 3:
                        this.set(arguments[0], arguments[1], arguments[2]);
                        break;
                    case 9:
                        this.set(arguments[0], arguments[1], arguments[2], arguments[3], arguments[4], arguments[5], arguments[6], arguments[7], arguments[8]);
                        break;
                    default:
                        break;
                }
            }
            Mat3.prototype.set = function (fValue1, fValue2, fValue3, fValue4, fValue5, fValue6, fValue7, fValue8, fValue9) {
                this.data = this.data || new Float32Array(9);
                var pData = this.data;
                var nArgumentsLength = arguments.length;
                if (nArgumentsLength == 0) {
                    pData[0] = pData[3] = pData[6] = 0;
                    pData[1] = pData[4] = pData[7] = 0;
                    pData[2] = pData[5] = pData[8] = 0;
                }
                if (nArgumentsLength == 1) {
                    if ((typeof (arguments[0]) === "number")) {
                        var nValue = arguments[0];
                        pData[0] = nValue;
                        pData[3] = 0;
                        pData[6] = 0;
                        pData[1] = 0;
                        pData[4] = nValue;
                        pData[7] = 0;
                        pData[2] = 0;
                        pData[5] = 0;
                        pData[8] = nValue;
                    } else if (((arguments[0].data) !== undefined)) {
                        var pElements = arguments[0].data;
                        if (pElements.length === 9) {
                            pData[0] = pElements[0];
                            pData[3] = pElements[3];
                            pData[6] = pElements[6];
                            pData[1] = pElements[1];
                            pData[4] = pElements[4];
                            pData[7] = pElements[7];
                            pData[2] = pElements[2];
                            pData[5] = pElements[5];
                            pData[8] = pElements[8];
                        } else {
                            pData[0] = pElements[0];
                            pData[3] = pElements[4];
                            pData[6] = pElements[8];
                            pData[1] = pElements[1];
                            pData[4] = pElements[5];
                            pData[7] = pElements[9];
                            pData[2] = pElements[2];
                            pData[5] = pElements[6];
                            pData[8] = pElements[10];
                        }
                    } else if (arguments[0] instanceof math.Vec3) {
                        var v3fVec = arguments[0];
                        pData[0] = v3fVec.x;
                        pData[3] = 0;
                        pData[6] = 0;
                        pData[1] = 0;
                        pData[4] = v3fVec.y;
                        pData[7] = 0;
                        pData[2] = 0;
                        pData[5] = 0;
                        pData[8] = v3fVec.z;
                    } else {
                        var pElements = arguments[0];
                        if (pElements.length == 3) {
                            pData[0] = pElements[0];
                            pData[3] = 0;
                            pData[6] = 0;
                            pData[1] = 0;
                            pData[4] = pElements[1];
                            pData[7] = 0;
                            pData[2] = 0;
                            pData[5] = 0;
                            pData[8] = pElements[2];
                        } else {
                            pData[0] = pElements[0];
                            pData[3] = pElements[3];
                            pData[6] = pElements[6];
                            pData[1] = pElements[1];
                            pData[4] = pElements[4];
                            pData[7] = pElements[7];
                            pData[2] = pElements[2];
                            pData[5] = pElements[5];
                            pData[8] = pElements[8];
                        }
                    }
                } else if (nArgumentsLength == 3) {
                    if ((typeof (arguments[0]) === "number")) {
                        pData[0] = arguments[0];
                        pData[3] = 0;
                        pData[6] = 0;
                        pData[1] = 0;
                        pData[4] = arguments[1];
                        pData[7] = 0;
                        pData[2] = 0;
                        pData[5] = 0;
                        pData[8] = arguments[2];
                    } else {
                        var pData1, pData2, pData3;
                        if (arguments[0] instanceof math.Vec3) {
                            var v3fVec1 = arguments[0];
                            var v3fVec2 = arguments[1];
                            var v3fVec3 = arguments[2];
                            pData[0] = v3fVec1.x;
                            pData[3] = v3fVec2.x;
                            pData[6] = v3fVec3.x;
                            pData[1] = v3fVec1.y;
                            pData[4] = v3fVec2.y;
                            pData[7] = v3fVec3.y;
                            pData[2] = v3fVec1.z;
                            pData[5] = v3fVec2.z;
                            pData[8] = v3fVec3.z;
                        } else {
                            var v3fVec1 = arguments[0];
                            var v3fVec2 = arguments[1];
                            var v3fVec3 = arguments[2];
                            pData[0] = v3fVec1[0];
                            pData[3] = v3fVec2[0];
                            pData[6] = v3fVec3[0];
                            pData[1] = v3fVec1[1];
                            pData[4] = v3fVec2[1];
                            pData[7] = v3fVec3[1];
                            pData[2] = v3fVec1[2];
                            pData[5] = v3fVec2[2];
                            pData[8] = v3fVec3[2];
                        }
                    }
                } else if (nArgumentsLength == 9) {
                    pData[0] = arguments[0];
                    pData[3] = arguments[3];
                    pData[6] = arguments[6];
                    pData[1] = arguments[1];
                    pData[4] = arguments[4];
                    pData[7] = arguments[7];
                    pData[2] = arguments[2];
                    pData[5] = arguments[5];
                    pData[8] = arguments[8];
                }
                return this;
            };
            Mat3.prototype.identity = function () {
                var pData = this.data;
                pData[0] = 1.;
                pData[3] = 0.;
                pData[6] = 0.;
                pData[1] = 0.;
                pData[4] = 1.;
                pData[7] = 0.;
                pData[2] = 0.;
                pData[5] = 0.;
                pData[8] = 1.;
                return this;
            };
            Mat3.prototype.add = function (m3fMat, m3fDestination) {
                if (!((m3fDestination) !== undefined)) {
                    m3fDestination = this;
                }
                var pData1 = this.data;
                var pData2 = m3fMat.data;
                var pDataDestination = m3fDestination.data;
                pDataDestination[0] = pData1[0] + pData2[0];
                pDataDestination[3] = pData1[3] + pData2[3];
                pDataDestination[6] = pData1[6] + pData2[6];
                pDataDestination[1] = pData1[1] + pData2[1];
                pDataDestination[4] = pData1[4] + pData2[4];
                pDataDestination[7] = pData1[7] + pData2[7];
                pDataDestination[2] = pData1[2] + pData2[2];
                pDataDestination[5] = pData1[5] + pData2[5];
                pDataDestination[8] = pData1[8] + pData2[8];
                return m3fDestination;
            };
            Mat3.prototype.subtract = function (m3fMat, m3fDestination) {
                if (!((m3fDestination) !== undefined)) {
                    m3fDestination = this;
                }
                var pData1 = this.data;
                var pData2 = m3fMat.data;
                var pDataDestination = m3fDestination.data;
                pDataDestination[0] = pData1[0] - pData2[0];
                pDataDestination[3] = pData1[3] - pData2[3];
                pDataDestination[6] = pData1[6] - pData2[6];
                pDataDestination[1] = pData1[1] - pData2[1];
                pDataDestination[4] = pData1[4] - pData2[4];
                pDataDestination[7] = pData1[7] - pData2[7];
                pDataDestination[2] = pData1[2] - pData2[2];
                pDataDestination[5] = pData1[5] - pData2[5];
                pDataDestination[8] = pData1[8] - pData2[8];
                return m3fDestination;
            };
            Mat3.prototype.multiply = function (m3fMat, m3fDestination) {
                var pData1 = this.data;
                var pData2 = m3fMat.data;
                if (!((m3fDestination) !== undefined)) {
                    m3fDestination = this;
                }
                var pDataDestination = m3fDestination.data;
                var a11 = pData1[0], a12 = pData1[3], a13 = pData1[6];
                var a21 = pData1[1], a22 = pData1[4], a23 = pData1[7];
                var a31 = pData1[2], a32 = pData1[5], a33 = pData1[8];
                var b11 = pData2[0], b12 = pData2[3], b13 = pData2[6];
                var b21 = pData2[1], b22 = pData2[4], b23 = pData2[7];
                var b31 = pData2[2], b32 = pData2[5], b33 = pData2[8];
                pDataDestination[0] = a11 * b11 + a12 * b21 + a13 * b31;
                pDataDestination[3] = a11 * b12 + a12 * b22 + a13 * b32;
                pDataDestination[6] = a11 * b13 + a12 * b23 + a13 * b33;
                pDataDestination[1] = a21 * b11 + a22 * b21 + a23 * b31;
                pDataDestination[4] = a21 * b12 + a22 * b22 + a23 * b32;
                pDataDestination[7] = a21 * b13 + a22 * b23 + a23 * b33;
                pDataDestination[2] = a31 * b11 + a32 * b21 + a33 * b31;
                pDataDestination[5] = a31 * b12 + a32 * b22 + a33 * b32;
                pDataDestination[8] = a31 * b13 + a32 * b23 + a33 * b33;
                return m3fDestination;
            };
            Mat3.prototype.multiplyVec3 = function (v3fVec, v3fDestination) {
                var pData = this.data;
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = v3fVec;
                }
                var x = v3fVec.x, y = v3fVec.y, z = v3fVec.z;
                v3fDestination.x = pData[0] * x + pData[3] * y + pData[6] * z;
                v3fDestination.y = pData[1] * x + pData[4] * y + pData[7] * z;
                v3fDestination.z = pData[2] * x + pData[5] * y + pData[8] * z;
                return v3fDestination;
            };
            Mat3.prototype.transpose = function (m3fDestination) {
                var pData = this.data;
                if (!((m3fDestination) !== undefined)) {
                    var a12 = pData[3], a13 = pData[6], a23 = pData[7];
                    pData[3] = pData[1];
                    pData[6] = pData[2];
                    pData[1] = a12;
                    pData[7] = pData[5];
                    pData[2] = a13;
                    pData[5] = a23;
                    return this;
                }
                var pDataDestination = m3fDestination.data;
                pDataDestination[0] = pData[0];
                pDataDestination[3] = pData[1];
                pDataDestination[6] = pData[2];
                pDataDestination[1] = pData[3];
                pDataDestination[4] = pData[4];
                pDataDestination[7] = pData[5];
                pDataDestination[2] = pData[6];
                pDataDestination[5] = pData[7];
                pDataDestination[8] = pData[8];
                return m3fDestination;
            };
            Mat3.prototype.determinant = function () {
                var pData = this.data;
                var a11 = pData[0], a12 = pData[3], a13 = pData[6];
                var a21 = pData[1], a22 = pData[4], a23 = pData[7];
                var a31 = pData[2], a32 = pData[5], a33 = pData[8];
                return a11 * (a22 * a33 - a23 * a32) - a12 * (a21 * a33 - a23 * a31) + a13 * (a21 * a32 - a22 * a31);
            };
            Mat3.prototype.inverse = function (m3fDestination) {
                if (!((m3fDestination) !== undefined)) {
                    m3fDestination = this;
                }
                var pData = this.data;
                var pDataDestination = m3fDestination.data;
                var a11 = pData[0], a12 = pData[3], a13 = pData[6];
                var a21 = pData[1], a22 = pData[4], a23 = pData[7];
                var a31 = pData[2], a32 = pData[5], a33 = pData[8];
                var A11 = a22 * a33 - a23 * a32;
                var A12 = a21 * a33 - a23 * a31;
                var A13 = a21 * a32 - a22 * a31;
                var A21 = a12 * a33 - a13 * a32;
                var A22 = a11 * a33 - a13 * a31;
                var A23 = a11 * a32 - a12 * a31;
                var A31 = a12 * a23 - a13 * a22;
                var A32 = a11 * a23 - a13 * a21;
                var A33 = a11 * a22 - a12 * a21;
                var fDeterminant = a11 * A11 - a12 * A12 + a13 * A13;
                if (fDeterminant == 0.) {
 {
                        akra.logger.setSourceLocation("Mat3.ts", 445);
                        akra.logger.error("обращение матрицы с нулевым детеминантом:\n", this.toString());
                    }
                    ;
                    return m3fDestination.set(1.);
                }
                var fInverseDeterminant = 1. / fDeterminant;
                pDataDestination[0] = A11 * fInverseDeterminant;
                pDataDestination[3] = -A21 * fInverseDeterminant;
                pDataDestination[6] = A31 * fInverseDeterminant;
                pDataDestination[1] = -A12 * fInverseDeterminant;
                pDataDestination[4] = A22 * fInverseDeterminant;
                pDataDestination[7] = -A32 * fInverseDeterminant;
                pDataDestination[2] = A13 * fInverseDeterminant;
                pDataDestination[5] = -A23 * fInverseDeterminant;
                pDataDestination[8] = A33 * fInverseDeterminant;
                return m3fDestination;
            };
            Mat3.prototype.isEqual = function (m3fMat, fEps) {
                if (typeof fEps === "undefined") { fEps = 0.; }
                var pData1 = this.data;
                var pData2 = m3fMat.data;
                if (fEps == 0) {
                    if (pData1[0] != pData2[0] || pData1[3] != pData2[3] || pData1[6] != pData2[6] || pData1[1] != pData2[1] || pData1[4] != pData2[4] || pData1[7] != pData2[7] || pData1[2] != pData2[2] || pData1[5] != pData2[5] || pData1[8] != pData2[8]) {
                        return false;
                    }
                } else {
                    if (Math.abs(pData1[0] - pData2[0]) > fEps || Math.abs(pData1[3] - pData2[3]) > fEps || Math.abs(pData1[6] - pData2[6]) > fEps || Math.abs(pData1[1] - pData2[1]) > fEps || Math.abs(pData1[4] - pData2[4]) > fEps || Math.abs(pData1[7] - pData2[7]) > fEps || Math.abs(pData1[2] - pData2[2]) > fEps || Math.abs(pData1[5] - pData2[5]) > fEps || Math.abs(pData1[8] - pData2[8]) > fEps) {
                        return false;
                    }
                }
                return true;
            };
            Mat3.prototype.isDiagonal = function (fEps) {
                if (typeof fEps === "undefined") { fEps = 0.; }
                var pData = this.data;
                if (fEps == 0) {
                    if (pData[3] != 0 || pData[6] != 0 || pData[1] != 0 || pData[7] != 0 || pData[2] != 0 || pData[5] != 0) {
                        return false;
                    }
                } else {
                    if (Math.abs(pData[3]) > fEps || Math.abs(pData[6]) > fEps || Math.abs(pData[1]) > fEps || Math.abs(pData[7]) > fEps || Math.abs(pData[2]) > fEps || Math.abs(pData[5]) > fEps) {
                        return false;
                    }
                }
                return true;
            };
            Mat3.prototype.toMat4 = function (m4fDestination) {
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = new math.Mat4();
                }
                var pData = this.data;
                var pDataDestination = m4fDestination.data;
                pDataDestination[0] = pData[0];
                pDataDestination[4] = pData[3];
                pDataDestination[8] = pData[6];
                pDataDestination[12] = 0;
                pDataDestination[1] = pData[1];
                pDataDestination[5] = pData[4];
                pDataDestination[9] = pData[7];
                pDataDestination[13] = 0;
                pDataDestination[2] = pData[2];
                pDataDestination[6] = pData[5];
                pDataDestination[10] = pData[8];
                pDataDestination[14] = 0;
                pDataDestination[3] = 0;
                pDataDestination[7] = 0;
                pDataDestination[11] = 0;
                pDataDestination[15] = 1;
                return m4fDestination;
            };
            Mat3.prototype.toQuat4 = function (q4fDestination) {
                if (!((q4fDestination) !== undefined)) {
                    q4fDestination = new math.Quat4();
                }
                var pData = this.data;
                var a11 = pData[0], a12 = pData[3], a13 = pData[6];
                var a21 = pData[1], a22 = pData[4], a23 = pData[7];
                var a31 = pData[2], a32 = pData[5], a33 = pData[8];
                var x2 = ((a11 - a22 - a33) + 1) / 4;
                var y2 = ((a22 - a11 - a33) + 1) / 4;
                var z2 = ((a33 - a11 - a22) + 1) / 4;
                var w2 = ((a11 + a22 + a33) + 1) / 4;
                var fMax = Math.max(x2, Math.max(y2, Math.max(z2, w2)));
                if (fMax == x2) {
                    var x = Math.sqrt(x2);
                    q4fDestination.x = x;
                    q4fDestination.y = (a21 + a12) / 4 / x;
                    q4fDestination.z = (a31 + a13) / 4 / x;
                    q4fDestination.w = (a32 - a23) / 4 / x;
                } else if (fMax == y2) {
                    var y = Math.sqrt(y2);
                    q4fDestination.x = (a21 + a12) / 4 / y;
                    q4fDestination.y = y;
                    q4fDestination.z = (a32 + a23) / 4 / y;
                    q4fDestination.w = (a13 - a31) / 4 / y;
                } else if (fMax == z2) {
                    var z = Math.sqrt(z2);
                    q4fDestination.x = (a31 + a13) / 4 / z;
                    q4fDestination.y = (a32 + a23) / 4 / z;
                    q4fDestination.z = z;
                    q4fDestination.w = (a21 - a12) / 4 / z;
                } else {
                    var w = Math.sqrt(w2);
                    q4fDestination.x = (a32 - a23) / 4 / w;
                    q4fDestination.y = (a13 - a31) / 4 / w;
                    q4fDestination.z = (a21 - a12) / 4 / w;
                    q4fDestination.w = w;
                }
                return q4fDestination;
            };
            Mat3.prototype.toString = function () {
                var pData = this.data;
                return '[' + pData[0] + ', ' + pData[3] + ', ' + pData[6] + ',\n' + +pData[1] + ', ' + pData[4] + ', ' + pData[7] + ',\n' + +pData[2] + ', ' + pData[5] + ', ' + pData[8] + ']';
            };
            Mat3.prototype.decompose = function (q4fRotation, v3fScale) {
                var m3fRotScale = this;
                var m3fRotScaleTransposed = this.transpose(math.mat3());
                var isRotScale = true;
                var m3fScaleRot = null, m3fScaleRotTransposed = null;
                var scaleSign = (m3fRotScale.determinant() >= 0.) ? 1 : -1;
                var m3fResult = math.mat3();
                m3fRotScaleTransposed.multiply(m3fRotScale, m3fResult);
                if (!m3fResult.isDiagonal(1e-4)) {
                    isRotScale = false;
                    m3fScaleRot = m3fRotScale;
                    m3fScaleRotTransposed = m3fRotScaleTransposed;
                    m3fScaleRot.multiply(m3fScaleRotTransposed, m3fResult);
                }
                var pResultData = m3fResult.data;
                var x = math.sqrt(pResultData[0]);
                var y = math.sqrt(pResultData[4]) * scaleSign;
                var z = math.sqrt(pResultData[8]);
                v3fScale.x = x;
                v3fScale.y = y;
                v3fScale.z = z;
                var m3fInverseScale = math.mat3(1. / x, 1. / y, 1. / z);
                if (isRotScale) {
                    m3fRotScale.multiply(m3fInverseScale, math.mat3()).toQuat4(q4fRotation);
                    return true;
                } else {
                    m3fInverseScale.multiply(m3fScaleRot, math.mat3()).toQuat4(q4fRotation);
 {
                        akra.logger.setSourceLocation("Mat3.ts", 674);
                        akra.logger.assert(false, "порядок умножения scale rot в данный момент не поддерживается");
                    }
                    ;
                    return false;
                }
            };
            Mat3.prototype.row = function (iRow, v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = new math.Vec3();
                }
                var pData = this.data;
                switch(iRow) {
                    case 1:
                        v3fDestination.x = pData[0];
                        v3fDestination.y = pData[3];
                        v3fDestination.z = pData[6];
                        break;
                    case 2:
                        v3fDestination.x = pData[1];
                        v3fDestination.y = pData[4];
                        v3fDestination.z = pData[7];
                        break;
                    case 3:
                        v3fDestination.x = pData[2];
                        v3fDestination.y = pData[5];
                        v3fDestination.z = pData[8];
                        break;
                }
                return v3fDestination;
            };
            Mat3.prototype.column = function (iColumn, v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = new math.Vec3();
                }
                var pData = this.data;
                switch(iColumn) {
                    case 1:
                        v3fDestination.x = pData[0];
                        v3fDestination.y = pData[1];
                        v3fDestination.z = pData[2];
                        break;
                    case 2:
                        v3fDestination.x = pData[3];
                        v3fDestination.y = pData[4];
                        v3fDestination.z = pData[5];
                        break;
                    case 3:
                        v3fDestination.x = pData[6];
                        v3fDestination.y = pData[7];
                        v3fDestination.z = pData[8];
                        break;
                }
                return v3fDestination;
            };
            Mat3.fromYawPitchRoll = function fromYawPitchRoll(fYaw, fPitch, fRoll, m3fDestination) {
                if (arguments.length <= 2) {
                    var v3fVec = arguments[0];
                    fYaw = v3fVec.x;
                    fPitch = v3fVec.y;
                    fRoll = v3fVec.z;
                    m3fDestination = arguments[1];
                }
                if (!((m3fDestination) !== undefined)) {
                    m3fDestination = new Mat3();
                }
                var pDataDestination = m3fDestination.data;
                var fSin1 = Math.sin(fYaw);
                var fSin2 = Math.sin(fPitch);
                var fSin3 = Math.sin(fRoll);
                var fCos1 = Math.cos(fYaw);
                var fCos2 = Math.cos(fPitch);
                var fCos3 = Math.cos(fRoll);
                pDataDestination[0] = fCos1 * fCos3 + fSin1 * fSin2 * fSin3;
                pDataDestination[3] = fCos3 * fSin1 * fSin2 - fCos1 * fSin3;
                pDataDestination[6] = fCos2 * fSin1;
                pDataDestination[1] = fCos2 * fSin3;
                pDataDestination[4] = fCos2 * fCos3;
                pDataDestination[7] = -fSin2;
                pDataDestination[2] = fCos1 * fSin2 * fSin3 - fCos3 * fSin1;
                pDataDestination[5] = fSin1 * fSin3 + fCos1 * fCos3 * fSin2;
                pDataDestination[8] = fCos1 * fCos2;
                return m3fDestination;
            };
            Mat3.fromXYZ = function fromXYZ(fX, fY, fZ, m3fDestination) {
                if (arguments.length <= 2) {
                    var v3fVec = arguments[0];
                    return Mat3.fromYawPitchRoll(v3fVec.y, v3fVec.x, v3fVec.z, arguments[1]);
                } else {
                    var fX = arguments[0];
                    var fY = arguments[1];
                    var fZ = arguments[2];
                    return Mat3.fromYawPitchRoll(fY, fX, fZ, arguments[3]);
                }
            };
            Object.defineProperty(Mat3, "stackCeil", {
                get: function () {
                    Mat3.stackPosition = Mat3.stackPosition === Mat3.stackSize - 1 ? 0 : Mat3.stackPosition;
                    return Mat3.stack[Mat3.stackPosition++];
                },
                enumerable: true,
                configurable: true
            });
            Mat3.stackSize = 100;
            Mat3.stackPosition = 0;
            Mat3.stack = (function () {
                var pStack = new Array(Mat3.stackSize);
                for(var i = 0; i < Mat3.stackSize; i++) {
                    pStack[i] = new Mat3();
                }
                return pStack;
            })();
            return Mat3;
        })();
        math.Mat3 = Mat3;        
        ;
    })(akra.math || (akra.math = {}));
    var math = akra.math;
})(akra || (akra = {}));
;
;
var akra;
(function (akra) {
    (function (math) {
        var Mat4 = (function () {
            function Mat4(fValue1, fValue2, fValue3, fValue4, fValue5, fValue6, fValue7, fValue8, fValue9, fValue10, fValue11, fValue12, fValue13, fValue14, fValue15, fValue16) {
                var nArgumentsLength = arguments.length;
                if (nArgumentsLength === 2) {
                    if ((typeof (arguments[1]) === "boolean")) {
                        if (arguments[1]) {
                            this.data = arguments[0];
                        } else {
                            this.data = new Float32Array(16);
                            this.set(arguments[0]);
                        }
                    } else {
                        this.data = new Float32Array(16);
                        this.set(arguments[0], arguments[1]);
                    }
                } else {
                    this.data = new Float32Array(16);
                    switch(nArgumentsLength) {
                        case 1:
                            if (arguments[0] instanceof math.Mat3) {
                                this.set(arguments[0], math.vec3(0.));
                            } else {
                                this.set(arguments[0]);
                            }
                            break;
                        case 4:
                            this.set(arguments[0], arguments[1], arguments[2], arguments[3]);
                            break;
                        case 16:
                            this.set(arguments[0], arguments[1], arguments[2], arguments[3], arguments[4], arguments[5], arguments[6], arguments[7], arguments[8], arguments[9], arguments[10], arguments[11], arguments[12], arguments[13], arguments[14], arguments[15]);
                            break;
                        default:
                            break;
                    }
                }
            }
            Mat4.prototype.set = function (fValue1, fValue2, fValue3, fValue4, fValue5, fValue6, fValue7, fValue8, fValue9, fValue10, fValue11, fValue12, fValue13, fValue14, fValue15, fValue16) {
                var nArgumentsLength = arguments.length;
                var pData = this.data;
                if (nArgumentsLength === 0) {
                    pData[0] = pData[4] = pData[8] = pData[12] = pData[1] = pData[5] = pData[9] = pData[13] = pData[2] = pData[6] = pData[10] = pData[14] = pData[3] = pData[7] = pData[11] = pData[15] = 0.;
                    return this;
                }
                if (nArgumentsLength === 1) {
                    if ((typeof (arguments[0]) === "number")) {
                        var fValue = arguments[0];
                        pData[0] = fValue;
                        pData[4] = 0.;
                        pData[8] = 0.;
                        pData[12] = 0.;
                        pData[1] = 0.;
                        pData[5] = fValue;
                        pData[9] = 0.;
                        pData[13] = 0.;
                        pData[2] = 0.;
                        pData[6] = 0.;
                        pData[10] = fValue;
                        pData[14] = 0.;
                        pData[3] = 0.;
                        pData[7] = 0.;
                        pData[11] = 0.;
                        pData[15] = fValue;
                    } else if (arguments[0] instanceof math.Vec4) {
                        var v4fVec = arguments[0];
                        pData[0] = v4fVec.x;
                        pData[4] = 0.;
                        pData[8] = 0.;
                        pData[12] = 0.;
                        pData[1] = 0.;
                        pData[5] = v4fVec.y;
                        pData[9] = 0.;
                        pData[13] = 0.;
                        pData[2] = 0.;
                        pData[6] = 0.;
                        pData[10] = v4fVec.z;
                        pData[14] = 0.;
                        pData[3] = 0.;
                        pData[7] = 0.;
                        pData[11] = 0.;
                        pData[15] = v4fVec.w;
                    } else if (((arguments[0].data) !== undefined)) {
                        var pMatrixData = arguments[0].data;
                        if (pMatrixData.length == 16) {
                            pData.set(pMatrixData);
                        } else {
                            pData[0] = pMatrixData[0];
                            pData[4] = pMatrixData[3];
                            pData[8] = pMatrixData[6];
                            pData[1] = pMatrixData[1];
                            pData[5] = pMatrixData[4];
                            pData[9] = pMatrixData[7];
                            pData[2] = pMatrixData[2];
                            pData[6] = pMatrixData[5];
                            pData[10] = pMatrixData[8];
                            pData[3] = 0.;
                            pData[7] = 0.;
                            pData[11] = 0.;
                            pData[15] = 1.;
                        }
                    } else {
                        var pArray = arguments[0];
                        if (pArray.length === 4) {
                            pData[0] = pArray[0];
                            pData[4] = 0.;
                            pData[8] = 0.;
                            pData[12] = 0.;
                            pData[1] = 0.;
                            pData[5] = pArray[1];
                            pData[9] = 0.;
                            pData[13] = 0.;
                            pData[2] = 0.;
                            pData[6] = 0.;
                            pData[10] = pArray[2];
                            pData[14] = 0.;
                            pData[3] = 0.;
                            pData[7] = 0.;
                            pData[11] = 0.;
                            pData[15] = pArray[3];
                        } else {
                            pData[0] = pArray[0];
                            pData[4] = pArray[4];
                            pData[8] = pArray[8];
                            pData[12] = pArray[12];
                            pData[1] = pArray[1];
                            pData[5] = pArray[5];
                            pData[9] = pArray[9];
                            pData[13] = pArray[13];
                            pData[2] = pArray[2];
                            pData[6] = pArray[6];
                            pData[10] = pArray[10];
                            pData[14] = pArray[14];
                            pData[3] = pArray[3];
                            pData[7] = pArray[7];
                            pData[11] = pArray[11];
                            pData[15] = pArray[15];
                        }
                    }
                } else if (nArgumentsLength == 2) {
                    var pMatrixData = arguments[0];
                    var v3fTranslation = arguments[1];
                    pData[0] = pMatrixData[0];
                    pData[4] = pMatrixData[3];
                    pData[8] = pMatrixData[6];
                    pData[12] = v3fTranslation.x;
                    pData[1] = pMatrixData[1];
                    pData[5] = pMatrixData[4];
                    pData[9] = pMatrixData[7];
                    pData[13] = v3fTranslation.y;
                    pData[2] = pMatrixData[2];
                    pData[6] = pMatrixData[5];
                    pData[10] = pMatrixData[8];
                    pData[14] = v3fTranslation.z;
                    pData[3] = 0.;
                    pData[7] = 0.;
                    pData[11] = 0.;
                    pData[15] = 1.;
                } else if (nArgumentsLength == 4) {
                    if ((typeof (arguments[0]) === "number")) {
                        pData[0] = arguments[0];
                        pData[4] = 0;
                        pData[8] = 0;
                        pData[12] = 0;
                        pData[1] = 0;
                        pData[5] = arguments[1];
                        pData[9] = 0;
                        pData[13] = 0;
                        pData[2] = 0;
                        pData[6] = 0;
                        pData[10] = arguments[2];
                        pData[14] = 0;
                        pData[3] = 0;
                        pData[7] = 0;
                        pData[11] = 0;
                        pData[15] = arguments[3];
                    } else if (arguments[0] instanceof math.Vec4) {
                        var v4fColumn1 = arguments[0];
                        var v4fColumn2 = arguments[1];
                        var v4fColumn3 = arguments[2];
                        var v4fColumn4 = arguments[3];
                        pData[0] = v4fColumn1.x;
                        pData[4] = v4fColumn2.x;
                        pData[8] = v4fColumn3.x;
                        pData[12] = v4fColumn4.x;
                        pData[1] = v4fColumn1.y;
                        pData[5] = v4fColumn2.y;
                        pData[9] = v4fColumn3.y;
                        pData[13] = v4fColumn4.y;
                        pData[2] = v4fColumn1.z;
                        pData[6] = v4fColumn2.z;
                        pData[10] = v4fColumn3.z;
                        pData[14] = v4fColumn4.z;
                        pData[3] = v4fColumn1.w;
                        pData[7] = v4fColumn2.w;
                        pData[11] = v4fColumn3.w;
                        pData[15] = v4fColumn4.w;
                    } else {
                        var v4fColumn1 = arguments[0];
                        var v4fColumn2 = arguments[1];
                        var v4fColumn3 = arguments[2];
                        var v4fColumn4 = arguments[3];
                        pData[0] = v4fColumn1[0];
                        pData[4] = v4fColumn2[0];
                        pData[8] = v4fColumn3[0];
                        pData[12] = v4fColumn4[0];
                        pData[1] = v4fColumn1[1];
                        pData[5] = v4fColumn2[1];
                        pData[9] = v4fColumn3[1];
                        pData[13] = v4fColumn4[1];
                        pData[2] = v4fColumn1[2];
                        pData[6] = v4fColumn2[2];
                        pData[10] = v4fColumn3[2];
                        pData[14] = v4fColumn4[2];
                        pData[3] = v4fColumn1[3];
                        pData[7] = v4fColumn2[3];
                        pData[11] = v4fColumn3[3];
                        pData[15] = v4fColumn4[3];
                    }
                } else {
                    pData[0] = arguments[0];
                    pData[4] = arguments[4];
                    pData[8] = arguments[8];
                    pData[12] = arguments[12];
                    pData[1] = arguments[1];
                    pData[5] = arguments[5];
                    pData[9] = arguments[9];
                    pData[13] = arguments[13];
                    pData[2] = arguments[2];
                    pData[6] = arguments[6];
                    pData[10] = arguments[10];
                    pData[14] = arguments[14];
                    pData[3] = arguments[3];
                    pData[7] = arguments[7];
                    pData[11] = arguments[11];
                    pData[15] = arguments[15];
                }
                return this;
            };
            Mat4.prototype.identity = function () {
                var pData = this.data;
                pData[0] = 1.;
                pData[4] = 0.;
                pData[8] = 0.;
                pData[12] = 0.;
                pData[1] = 0.;
                pData[5] = 1.;
                pData[9] = 0.;
                pData[13] = 0.;
                pData[2] = 0.;
                pData[6] = 0.;
                pData[10] = 1.;
                pData[14] = 0.;
                pData[3] = 0.;
                pData[7] = 0.;
                pData[11] = 0.;
                pData[15] = 1.;
                return this;
            };
            Mat4.prototype.add = function (m4fMat, m4fDestination) {
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = this;
                }
                var pData1 = this.data;
                var pData2 = m4fMat.data;
                var pDataDestination = m4fDestination.data;
                pDataDestination[0] = pData1[0] + pData2[0];
                pDataDestination[4] = pData1[4] + pData2[4];
                pDataDestination[8] = pData1[8] + pData2[8];
                pDataDestination[12] = pData1[12] + pData2[12];
                pDataDestination[1] = pData1[1] + pData2[1];
                pDataDestination[5] = pData1[5] + pData2[5];
                pDataDestination[9] = pData1[9] + pData2[9];
                pDataDestination[13] = pData1[13] + pData2[13];
                pDataDestination[2] = pData1[2] + pData2[2];
                pDataDestination[6] = pData1[6] + pData2[6];
                pDataDestination[10] = pData1[10] + pData2[10];
                pDataDestination[14] = pData1[14] + pData2[14];
                pDataDestination[3] = pData1[3] + pData2[3];
                pDataDestination[7] = pData1[7] + pData2[7];
                pDataDestination[11] = pData1[11] + pData2[11];
                pDataDestination[15] = pData1[15] + pData2[15];
                return m4fDestination;
            };
            Mat4.prototype.subtract = function (m4fMat, m4fDestination) {
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = this;
                }
                var pData1 = this.data;
                var pData2 = m4fMat.data;
                var pDataDestination = m4fDestination.data;
                pDataDestination[0] = pData1[0] - pData2[0];
                pDataDestination[4] = pData1[4] - pData2[4];
                pDataDestination[8] = pData1[8] - pData2[8];
                pDataDestination[12] = pData1[12] - pData2[12];
                pDataDestination[1] = pData1[1] - pData2[1];
                pDataDestination[5] = pData1[5] - pData2[5];
                pDataDestination[9] = pData1[9] - pData2[9];
                pDataDestination[13] = pData1[13] - pData2[13];
                pDataDestination[2] = pData1[2] - pData2[2];
                pDataDestination[6] = pData1[6] - pData2[6];
                pDataDestination[10] = pData1[10] - pData2[10];
                pDataDestination[14] = pData1[14] - pData2[14];
                pDataDestination[3] = pData1[3] - pData2[3];
                pDataDestination[7] = pData1[7] - pData2[7];
                pDataDestination[11] = pData1[11] - pData2[11];
                pDataDestination[15] = pData1[15] - pData2[15];
                return m4fDestination;
            };
            Mat4.prototype.multiply = function (m4fMat, m4fDestination) {
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = this;
                }
                var pData1 = this.data;
                var pData2 = m4fMat.data;
                var pDataDestination = m4fDestination.data;
                var a11 = pData1[0], a12 = pData1[4], a13 = pData1[8], a14 = pData1[12];
                var a21 = pData1[1], a22 = pData1[5], a23 = pData1[9], a24 = pData1[13];
                var a31 = pData1[2], a32 = pData1[6], a33 = pData1[10], a34 = pData1[14];
                var a41 = pData1[3], a42 = pData1[7], a43 = pData1[11], a44 = pData1[15];
                var b11 = pData2[0], b12 = pData2[4], b13 = pData2[8], b14 = pData2[12];
                var b21 = pData2[1], b22 = pData2[5], b23 = pData2[9], b24 = pData2[13];
                var b31 = pData2[2], b32 = pData2[6], b33 = pData2[10], b34 = pData2[14];
                var b41 = pData2[3], b42 = pData2[7], b43 = pData2[11], b44 = pData2[15];
                pDataDestination[0] = a11 * b11 + a12 * b21 + a13 * b31 + a14 * b41;
                pDataDestination[4] = a11 * b12 + a12 * b22 + a13 * b32 + a14 * b42;
                pDataDestination[8] = a11 * b13 + a12 * b23 + a13 * b33 + a14 * b43;
                pDataDestination[12] = a11 * b14 + a12 * b24 + a13 * b34 + a14 * b44;
                pDataDestination[1] = a21 * b11 + a22 * b21 + a23 * b31 + a24 * b41;
                pDataDestination[5] = a21 * b12 + a22 * b22 + a23 * b32 + a24 * b42;
                pDataDestination[9] = a21 * b13 + a22 * b23 + a23 * b33 + a24 * b43;
                pDataDestination[13] = a21 * b14 + a22 * b24 + a23 * b34 + a24 * b44;
                pDataDestination[2] = a31 * b11 + a32 * b21 + a33 * b31 + a34 * b41;
                pDataDestination[6] = a31 * b12 + a32 * b22 + a33 * b32 + a34 * b42;
                pDataDestination[10] = a31 * b13 + a32 * b23 + a33 * b33 + a34 * b43;
                pDataDestination[14] = a31 * b14 + a32 * b24 + a33 * b34 + a34 * b44;
                pDataDestination[3] = a41 * b11 + a42 * b21 + a43 * b31 + a44 * b41;
                pDataDestination[7] = a41 * b12 + a42 * b22 + a43 * b32 + a44 * b42;
                pDataDestination[11] = a41 * b13 + a42 * b23 + a43 * b33 + a44 * b43;
                pDataDestination[15] = a41 * b14 + a42 * b24 + a43 * b34 + a44 * b44;
                return m4fDestination;
            };
            Mat4.prototype.multiplyLeft = function (m4fMat, m4fDestination) {
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = this;
                }
                return m4fMat.multiply(this, m4fDestination);
            };
            Mat4.prototype.multiplyVec4 = function (v4fVec, v4fDestination) {
                if (!((v4fDestination) !== undefined)) {
                    v4fDestination = v4fVec;
                }
                var pData = this.data;
                var x = v4fVec.x, y = v4fVec.y, z = v4fVec.z, w = v4fVec.w;
                v4fDestination.x = pData[0] * x + pData[4] * y + pData[8] * z + pData[12] * w;
                v4fDestination.y = pData[1] * x + pData[5] * y + pData[9] * z + pData[13] * w;
                v4fDestination.z = pData[2] * x + pData[6] * y + pData[10] * z + pData[14] * w;
                v4fDestination.w = pData[3] * x + pData[7] * y + pData[11] * z + pData[15] * w;
                return v4fDestination;
            };
            Mat4.prototype.transpose = function (m4fDestination) {
                var pData = this.data;
                if (!((m4fDestination) !== undefined)) {
                    var a12 = pData[4], a13 = pData[8], a14 = pData[12];
                    var a23 = pData[9], a24 = pData[13];
                    var a34 = pData[14];
                    pData[4] = pData[1];
                    pData[8] = pData[2];
                    pData[12] = pData[3];
                    pData[1] = a12;
                    pData[9] = pData[6];
                    pData[13] = pData[7];
                    pData[2] = a13;
                    pData[6] = a23;
                    pData[14] = pData[11];
                    pData[3] = a14;
                    pData[7] = a24;
                    pData[11] = a34;
                    return this;
                }
                var pDataDestination = m4fDestination.data;
                pDataDestination[0] = pData[0];
                pDataDestination[4] = pData[1];
                pDataDestination[8] = pData[2];
                pDataDestination[12] = pData[3];
                pDataDestination[1] = pData[4];
                pDataDestination[5] = pData[5];
                pDataDestination[9] = pData[6];
                pDataDestination[13] = pData[7];
                pDataDestination[2] = pData[8];
                pDataDestination[6] = pData[9];
                pDataDestination[10] = pData[10];
                pDataDestination[14] = pData[11];
                pDataDestination[3] = pData[12];
                pDataDestination[7] = pData[13];
                pDataDestination[11] = pData[14];
                pDataDestination[15] = pData[15];
                return m4fDestination;
            };
            Mat4.prototype.determinant = function () {
                var pData = this.data;
                var a11 = pData[0], a12 = pData[4], a13 = pData[8], a14 = pData[12];
                var a21 = pData[1], a22 = pData[5], a23 = pData[9], a24 = pData[13];
                var a31 = pData[2], a32 = pData[6], a33 = pData[10], a34 = pData[14];
                var a41 = pData[3], a42 = pData[7], a43 = pData[11], a44 = pData[15];
                return a41 * a32 * a23 * a14 - a31 * a42 * a23 * a14 - a41 * a22 * a33 * a14 + a21 * a42 * a33 * a14 + a31 * a22 * a43 * a14 - a21 * a32 * a43 * a14 - a41 * a32 * a13 * a24 + a31 * a42 * a13 * a24 + a41 * a12 * a33 * a24 - a11 * a42 * a33 * a24 - a31 * a12 * a43 * a24 + a11 * a32 * a43 * a24 + a41 * a22 * a13 * a34 - a21 * a42 * a13 * a34 - a41 * a12 * a23 * a34 + a11 * a42 * a23 * a34 + a21 * a12 * a43 * a34 - a11 * a22 * a43 * a34 - a31 * a22 * a13 * a44 + a21 * a32 * a13 * a44 + a31 * a12 * a23 * a44 - a11 * a32 * a23 * a44 - a21 * a12 * a33 * a44 + a11 * a22 * a33 * a44;
            };
            Mat4.prototype.inverse = function (m4fDestination) {
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = this;
                }
                var pData = this.data;
                var pDataDestination = m4fDestination.data;
                var a11 = pData[0], a12 = pData[4], a13 = pData[8], a14 = pData[12];
                var a21 = pData[1], a22 = pData[5], a23 = pData[9], a24 = pData[13];
                var a31 = pData[2], a32 = pData[6], a33 = pData[10], a34 = pData[14];
                var a41 = pData[3], a42 = pData[7], a43 = pData[11], a44 = pData[15];
                var b00 = a11 * a22 - a12 * a21;
                var b01 = a11 * a23 - a13 * a21;
                var b02 = a11 * a24 - a14 * a21;
                var b03 = a12 * a23 - a13 * a22;
                var b04 = a12 * a24 - a14 * a22;
                var b05 = a13 * a24 - a14 * a23;
                var b06 = a31 * a42 - a32 * a41;
                var b07 = a31 * a43 - a33 * a41;
                var b08 = a31 * a44 - a34 * a41;
                var b09 = a32 * a43 - a33 * a42;
                var b10 = a32 * a44 - a34 * a42;
                var b11 = a33 * a44 - a34 * a43;
                var fDeterminant = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;
                if (fDeterminant === 0.) {
 {
                        akra.logger.setSourceLocation("Mat4.ts", 624);
                        akra.logger.assert(false, "обращение матрицы с нулевым детеминантом:\n" + this.toString());
                    }
                    ;
                    return m4fDestination.set(1.);
                }
                var fInverseDeterminant = 1 / fDeterminant;
                pDataDestination[0] = (a22 * b11 - a23 * b10 + a24 * b09) * fInverseDeterminant;
                pDataDestination[4] = (-a12 * b11 + a13 * b10 - a14 * b09) * fInverseDeterminant;
                pDataDestination[8] = (a42 * b05 - a43 * b04 + a44 * b03) * fInverseDeterminant;
                pDataDestination[12] = (-a32 * b05 + a33 * b04 - a34 * b03) * fInverseDeterminant;
                pDataDestination[1] = (-a21 * b11 + a23 * b08 - a24 * b07) * fInverseDeterminant;
                pDataDestination[5] = (a11 * b11 - a13 * b08 + a14 * b07) * fInverseDeterminant;
                pDataDestination[9] = (-a41 * b05 + a43 * b02 - a44 * b01) * fInverseDeterminant;
                pDataDestination[13] = (a31 * b05 - a33 * b02 + a34 * b01) * fInverseDeterminant;
                pDataDestination[2] = (a21 * b10 - a22 * b08 + a24 * b06) * fInverseDeterminant;
                pDataDestination[6] = (-a11 * b10 + a12 * b08 - a14 * b06) * fInverseDeterminant;
                pDataDestination[10] = (a41 * b04 - a42 * b02 + a44 * b00) * fInverseDeterminant;
                pDataDestination[14] = (-a31 * b04 + a32 * b02 - a34 * b00) * fInverseDeterminant;
                pDataDestination[3] = (-a21 * b09 + a22 * b07 - a23 * b06) * fInverseDeterminant;
                pDataDestination[7] = (a11 * b09 - a12 * b07 + a13 * b06) * fInverseDeterminant;
                pDataDestination[11] = (-a41 * b03 + a42 * b01 - a43 * b00) * fInverseDeterminant;
                pDataDestination[15] = (a31 * b03 - a32 * b01 + a33 * b00) * fInverseDeterminant;
                return m4fDestination;
            };
            Mat4.prototype.trace = function () {
                var pData = this.data;
                return pData[0] + pData[5] + pData[10] + pData[15];
            };
            Mat4.prototype.isEqual = function (m4fMat, fEps) {
                if (typeof fEps === "undefined") { fEps = 0.; }
                var pData1 = this.data;
                var pData2 = m4fMat.data;
                if (fEps === 0.) {
                    if (pData1[0] != pData2[0] || pData1[4] != pData2[4] || pData1[8] != pData2[8] || pData1[12] != pData2[12] || pData1[1] != pData2[1] || pData1[5] != pData2[5] || pData1[9] != pData2[9] || pData1[13] != pData2[13] || pData1[2] != pData2[2] || pData1[6] != pData2[6] || pData1[10] != pData2[10] || pData1[14] != pData2[14] || pData1[3] != pData2[3] || pData1[7] != pData2[7] || pData1[11] != pData2[11] || pData1[15] != pData2[15]) {
                        return false;
                    }
                } else {
                    if (math.abs(pData1[0] - pData2[0]) > fEps || math.abs(pData1[4] - pData2[4]) > fEps || math.abs(pData1[8] - pData2[8]) > fEps || math.abs(pData1[12] - pData2[12]) > fEps || math.abs(pData1[1] - pData2[1]) > fEps || math.abs(pData1[5] - pData2[5]) > fEps || math.abs(pData1[9] - pData2[9]) > fEps || math.abs(pData1[13] - pData2[13]) > fEps || math.abs(pData1[2] - pData2[2]) > fEps || math.abs(pData1[6] - pData2[6]) > fEps || math.abs(pData1[10] - pData2[10]) > fEps || math.abs(pData1[14] - pData2[14]) > fEps || math.abs(pData1[3] - pData2[3]) > fEps || math.abs(pData1[7] - pData2[7]) > fEps || math.abs(pData1[11] - pData2[11]) > fEps || math.abs(pData1[15] - pData2[15]) > fEps) {
                        return false;
                    }
                }
                return true;
            };
            Mat4.prototype.isDiagonal = function (fEps) {
                if (typeof fEps === "undefined") { fEps = 0.; }
                var pData = this.data;
                if (fEps === 0.) {
                    if (pData[4] !== 0. || pData[8] !== 0. || pData[12] != 0. || pData[1] !== 0. || pData[9] !== 0. || pData[13] != 0. || pData[2] !== 0. || pData[6] !== 0. || pData[14] != 0. || pData[3] !== 0. || pData[7] !== 0. || pData[11] != 0.) {
                        return false;
                    }
                } else {
                    if (math.abs(pData[4]) > fEps || math.abs(pData[8]) > fEps || math.abs(pData[12]) > fEps || math.abs(pData[1]) > fEps || math.abs(pData[9]) > fEps || math.abs(pData[13]) > fEps || math.abs(pData[2]) > fEps || math.abs(pData[6]) > fEps || math.abs(pData[14]) > fEps || math.abs(pData[3]) > fEps || math.abs(pData[7]) > fEps || math.abs(pData[11]) > fEps) {
                        return false;
                    }
                }
                return true;
            };
            Mat4.prototype.toMat3 = function (m3fDestination) {
                if (!((m3fDestination) !== undefined)) {
                    m3fDestination = new math.Mat3();
                }
                var pData = this.data;
                var pDataDestination = m3fDestination.data;
                pDataDestination[0] = pData[0];
                pDataDestination[3] = pData[4];
                pDataDestination[6] = pData[8];
                pDataDestination[1] = pData[1];
                pDataDestination[4] = pData[5];
                pDataDestination[7] = pData[9];
                pDataDestination[2] = pData[2];
                pDataDestination[5] = pData[6];
                pDataDestination[8] = pData[10];
                return m3fDestination;
            };
            Mat4.prototype.toQuat4 = function (q4fDestination) {
                if (!((q4fDestination) !== undefined)) {
                    q4fDestination = new math.Quat4();
                }
                var pData = this.data;
                var a11 = pData[0], a12 = pData[4], a13 = pData[8];
                var a21 = pData[1], a22 = pData[5], a23 = pData[9];
                var a31 = pData[2], a32 = pData[6], a33 = pData[10];
                var x2 = ((a11 - a22 - a33) + 1.) / 4.;
                var y2 = ((a22 - a11 - a33) + 1.) / 4.;
                var z2 = ((a33 - a11 - a22) + 1.) / 4.;
                var w2 = ((a11 + a22 + a33) + 1.) / 4.;
                var fMax = math.max(x2, math.max(y2, math.max(z2, w2)));
                if (fMax == x2) {
                    var x = math.sqrt(x2);
                    q4fDestination.x = x;
                    q4fDestination.y = (a21 + a12) / 4. / x;
                    q4fDestination.z = (a31 + a13) / 4. / x;
                    q4fDestination.w = (a32 - a23) / 4. / x;
                } else if (fMax == y2) {
                    var y = math.sqrt(y2);
                    q4fDestination.x = (a21 + a12) / 4. / y;
                    q4fDestination.y = y;
                    q4fDestination.z = (a32 + a23) / 4. / y;
                    q4fDestination.w = (a13 - a31) / 4. / y;
                } else if (fMax == z2) {
                    var z = math.sqrt(z2);
                    q4fDestination.x = (a31 + a13) / 4. / z;
                    q4fDestination.y = (a32 + a23) / 4. / z;
                    q4fDestination.z = z;
                    q4fDestination.w = (a21 - a12) / 4. / z;
                } else {
                    var w = math.sqrt(w2);
                    q4fDestination.x = (a32 - a23) / 4. / w;
                    q4fDestination.y = (a13 - a31) / 4. / w;
                    q4fDestination.z = (a21 - a12) / 4. / w;
                    q4fDestination.w = w;
                }
                return q4fDestination;
            };
            Mat4.prototype.toRotationMatrix = function (m4fDestination) {
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = new Mat4();
                }
                var pData = this.data;
                var pDataDestination = m4fDestination.data;
                pDataDestination[0] = pData[0];
                pDataDestination[4] = pData[4];
                pDataDestination[8] = pData[8];
                pDataDestination[12] = 0.;
                pDataDestination[1] = pData[1];
                pDataDestination[5] = pData[5];
                pDataDestination[9] = pData[9];
                pDataDestination[13] = 0.;
                pDataDestination[2] = pData[2];
                pDataDestination[6] = pData[6];
                pDataDestination[10] = pData[10];
                pDataDestination[14] = 0.;
                pDataDestination[3] = 0.;
                pDataDestination[7] = 0.;
                pDataDestination[11] = 0.;
                pDataDestination[15] = 1.;
                return m4fDestination;
            };
            Mat4.prototype.toString = function () {
                var pData = this.data;
                return '[' + pData[0] + ", " + pData[4] + ', ' + pData[8] + ', ' + pData[12] + ',\n' + pData[1] + ", " + pData[5] + ', ' + pData[9] + ', ' + pData[13] + ',\n' + pData[2] + ", " + pData[6] + ', ' + pData[10] + ', ' + pData[14] + ',\n' + pData[3] + ", " + pData[7] + ', ' + pData[11] + ', ' + pData[15] + ']';
            };
            Mat4.prototype.rotateRight = function (fAngle, v3fAxis, m4fDestination) {
                var pData = this.data;
                var x = v3fAxis.x, y = v3fAxis.y, z = v3fAxis.z;
                var fLength = Math.sqrt(x * x + y * y + z * z);
                if (fLength === 0.) {
 {
                        akra.logger.setSourceLocation("Mat4.ts", 860);
                        akra.logger.assert(false, "попытка вращения вокруг оси нулевой длины. Угол " + fAngle + ". Ось " + v3fAxis.toString());
                    }
                    ;
                    if (((m4fDestination) !== undefined)) {
                        m4fDestination.set(this);
                    } else {
                        m4fDestination = this;
                    }
                    return m4fDestination;
                }
                var fInvLength = 1. / fLength;
                x *= fInvLength;
                y *= fInvLength;
                z *= fInvLength;
                var a11 = pData[0], a12 = pData[4], a13 = pData[8];
                var a21 = pData[1], a22 = pData[5], a23 = pData[9];
                var a31 = pData[2], a32 = pData[6], a33 = pData[10];
                var fSin = math.sin(fAngle);
                var fCos = math.cos(fAngle);
                var fTmp = 1. - fCos;
                var b11 = fCos + fTmp * x * x, b12 = fTmp * x * y - fSin * z, b13 = fTmp * x * z + fSin * y;
                var b21 = fTmp * y * z + fSin * z, b22 = fCos + fTmp * y * y, b23 = fTmp * y * z - fSin * x;
                var b31 = fTmp * z * x - fSin * y, b32 = fTmp * z * y + fSin * x, b33 = fCos + fTmp * z * z;
                if (!((m4fDestination) !== undefined)) {
                    pData[0] = a11 * b11 + a12 * b21 + a13 * b31;
                    pData[4] = a11 * b12 + a12 * b22 + a13 * b32;
                    pData[8] = a11 * b13 + a12 * b23 + a13 * b33;
                    pData[1] = a21 * b11 + a22 * b21 + a23 * b31;
                    pData[5] = a21 * b12 + a22 * b22 + a23 * b32;
                    pData[9] = a21 * b13 + a22 * b23 + a23 * b33;
                    pData[2] = a31 * b11 + a32 * b21 + a33 * b31;
                    pData[6] = a31 * b12 + a32 * b22 + a33 * b32;
                    pData[10] = a31 * b13 + a32 * b23 + a33 * b33;
                    return this;
                }
                var pDataDestination = m4fDestination.data;
                pDataDestination[0] = a11 * b11 + a12 * b21 + a13 * b31;
                pDataDestination[4] = a11 * b12 + a12 * b22 + a13 * b32;
                pDataDestination[8] = a11 * b13 + a12 * b23 + a13 * b33;
                pDataDestination[12] = pData[12];
                pDataDestination[1] = a21 * b11 + a22 * b21 + a23 * b31;
                pDataDestination[5] = a21 * b12 + a22 * b22 + a23 * b32;
                pDataDestination[9] = a21 * b13 + a22 * b23 + a23 * b33;
                pDataDestination[13] = pData[13];
                pDataDestination[2] = a31 * b11 + a32 * b21 + a33 * b31;
                pDataDestination[6] = a31 * b12 + a32 * b22 + a33 * b32;
                pDataDestination[10] = a31 * b13 + a32 * b23 + a33 * b33;
                pDataDestination[14] = pData[14];
                pDataDestination[3] = pData[3];
                pDataDestination[7] = pData[7];
                pDataDestination[11] = pData[11];
                pDataDestination[15] = pData[15];
                return m4fDestination;
            };
            Mat4.prototype.rotateLeft = function (fAngle, v3fAxis, m4fDestination) {
                var pData = this.data;
                var x = v3fAxis.x, y = v3fAxis.y, z = v3fAxis.z;
                var fLength = Math.sqrt(x * x + y * y + z * z);
                if (fLength === 0.) {
 {
                        akra.logger.setSourceLocation("Mat4.ts", 938);
                        akra.logger.assert(false, "попытка вращения вокруг оси нулевой длины. Угол " + fAngle + ". Ось " + v3fAxis.toString());
                    }
                    ;
                    if (((m4fDestination) !== undefined)) {
                        m4fDestination.set(this);
                    } else {
                        m4fDestination = this;
                    }
                    return m4fDestination;
                }
                var fInvLength = 1. / fLength;
                x *= fInvLength;
                y *= fInvLength;
                z *= fInvLength;
                var a11 = pData[0], a12 = pData[4], a13 = pData[8], a14 = pData[12];
                var a21 = pData[1], a22 = pData[5], a23 = pData[9], a24 = pData[13];
                var a31 = pData[2], a32 = pData[6], a33 = pData[10], a34 = pData[14];
                var fSin = math.sin(fAngle);
                var fCos = math.cos(fAngle);
                var fTmp = 1. - fCos;
                var b11 = fCos + fTmp * x * x, b12 = fTmp * x * y - fSin * z, b13 = fTmp * x * z + fSin * y;
                var b21 = fTmp * y * z + fSin * z, b22 = fCos + fTmp * y * y, b23 = fTmp * y * z - fSin * x;
                var b31 = fTmp * z * x - fSin * y, b32 = fTmp * z * y + fSin * x, b33 = fCos + fTmp * z * z;
                if (!((m4fDestination) !== undefined)) {
                    pData[0] = b11 * a11 + b12 * a21 + b13 * a31;
                    pData[4] = b11 * a12 + b12 * a22 + b13 * a32;
                    pData[8] = b11 * a13 + b12 * a23 + b13 * a33;
                    pData[12] = b11 * a14 + b12 * a24 + b13 * a34;
                    pData[1] = b21 * a11 + b22 * a21 + b23 * a31;
                    pData[5] = b21 * a12 + b22 * a22 + b23 * a32;
                    pData[9] = b21 * a13 + b22 * a23 + b23 * a33;
                    pData[13] = b21 * a14 + b22 * a24 + b23 * a34;
                    pData[2] = b31 * a11 + b32 * a21 + b33 * a31;
                    pData[6] = b31 * a12 + b32 * a22 + b33 * a32;
                    pData[10] = b31 * a13 + b32 * a23 + b33 * a33;
                    pData[14] = b31 * a14 + b32 * a24 + b33 * a34;
                    return this;
                }
                var pDataDestination = m4fDestination.data;
                pDataDestination[0] = b11 * a11 + b12 * a21 + b13 * a31;
                pDataDestination[4] = b11 * a12 + b12 * a22 + b13 * a32;
                pDataDestination[8] = b11 * a13 + b12 * a23 + b13 * a33;
                pDataDestination[12] = b11 * a14 + b12 * a24 + b13 * a34;
                pDataDestination[1] = b21 * a11 + b22 * a21 + b23 * a31;
                pDataDestination[5] = b21 * a12 + b22 * a22 + b23 * a32;
                pDataDestination[9] = b21 * a13 + b22 * a23 + b23 * a33;
                pDataDestination[13] = b21 * a14 + b22 * a24 + b23 * a34;
                pDataDestination[2] = b31 * a11 + b32 * a21 + b33 * a31;
                pDataDestination[6] = b31 * a12 + b32 * a22 + b33 * a32;
                pDataDestination[10] = b31 * a13 + b32 * a23 + b33 * a33;
                pDataDestination[14] = b31 * a14 + b32 * a24 + b33 * a34;
                pDataDestination[3] = pData[3];
                pDataDestination[7] = pData[7];
                pDataDestination[11] = pData[11];
                pDataDestination[15] = pData[15];
                return m4fDestination;
            };
            Mat4.prototype.setTranslation = function (v3fTranslation) {
                var pData = this.data;
                pData[12] = v3fTranslation.x;
                pData[13] = v3fTranslation.y;
                pData[14] = v3fTranslation.z;
                return this;
            };
            Mat4.prototype.getTranslation = function (v3fTranslation) {
                if (!((v3fTranslation) !== undefined)) {
                    v3fTranslation = new math.Vec3();
                }
                var pData = this.data;
                v3fTranslation.x = pData[12];
                v3fTranslation.y = pData[13];
                v3fTranslation.z = pData[14];
                return v3fTranslation;
            };
            Mat4.prototype.translateRight = function (v3fTranslation, m4fDestination) {
                var pData = this.data;
                var x = v3fTranslation.x, y = v3fTranslation.y, z = v3fTranslation.z;
                if (!((m4fDestination) !== undefined)) {
                    pData[12] = pData[0] * x + pData[4] * y + pData[8] * z + pData[12];
                    pData[13] = pData[1] * x + pData[5] * y + pData[9] * z + pData[13];
                    pData[14] = pData[2] * x + pData[6] * y + pData[10] * z + pData[14];
                    pData[15] = pData[3] * x + pData[7] * y + pData[11] * z + pData[15];
                    return this;
                }
                var pDataDestination = m4fDestination.data;
                var a11 = pData[0], a12 = pData[4], a13 = pData[8];
                var a21 = pData[0], a22 = pData[5], a23 = pData[9];
                var a31 = pData[0], a32 = pData[6], a33 = pData[10];
                var a41 = pData[0], a42 = pData[7], a43 = pData[11];
                pDataDestination[0] = a11;
                pDataDestination[4] = a12;
                pDataDestination[8] = a13;
                pDataDestination[12] = a11 * x + a12 * y + a13 * z + pData[12];
                pDataDestination[1] = a21;
                pDataDestination[5] = a22;
                pDataDestination[9] = a23;
                pDataDestination[13] = a21 * x + a22 * y + a23 * z + pData[13];
                pDataDestination[2] = a31;
                pDataDestination[6] = a32;
                pDataDestination[10] = a33;
                pDataDestination[14] = a31 * x + a32 * y + a33 * z + pData[14];
                pDataDestination[3] = a41;
                pDataDestination[7] = a42;
                pDataDestination[11] = a43;
                pDataDestination[15] = a41 * x + a42 * y + a43 * z + pData[15];
                return m4fDestination;
            };
            Mat4.prototype.translateLeft = function (v3fTranslation, m4fDestination) {
                var pData = this.data;
                var x = v3fTranslation.x, y = v3fTranslation.y, z = v3fTranslation.z;
                if (!((m4fDestination) !== undefined)) {
                    pData[12] = x + pData[12];
                    pData[13] = y + pData[13];
                    pData[14] = z + pData[14];
                    return this;
                }
                var pDataDestination = m4fDestination.data;
                pDataDestination[0] = pData[0];
                pDataDestination[4] = pData[4];
                pDataDestination[8] = pData[8];
                pDataDestination[12] = x + pData[12];
                pDataDestination[1] = pData[1];
                pDataDestination[5] = pData[5];
                pDataDestination[9] = pData[9];
                pDataDestination[13] = y + pData[13];
                pDataDestination[2] = pData[2];
                pDataDestination[6] = pData[6];
                pDataDestination[10] = pData[10];
                pDataDestination[14] = z + pData[14];
                pDataDestination[3] = pData[3];
                pDataDestination[7] = pData[7];
                pDataDestination[11] = pData[11];
                pDataDestination[15] = pData[15];
                return m4fDestination;
            };
            Mat4.prototype.scaleRight = function (v3fScale, m4fDestination) {
                var pData = this.data;
                var x = v3fScale.x, y = v3fScale.y, z = v3fScale.z;
                if (!((m4fDestination) !== undefined)) {
                    pData[0] *= x;
                    pData[4] *= y;
                    pData[8] *= z;
                    pData[1] *= x;
                    pData[5] *= y;
                    pData[9] *= z;
                    pData[2] *= x;
                    pData[6] *= y;
                    pData[10] *= z;
                    pData[3] *= x;
                    pData[7] *= y;
                    pData[11] *= z;
                    return this;
                }
                var pDataDestination = m4fDestination.data;
                pDataDestination[0] = pData[0] * x;
                pDataDestination[4] = pData[4] * y;
                pDataDestination[8] = pData[8] * z;
                pDataDestination[12] = pData[12];
                pDataDestination[1] = pData[1] * x;
                pDataDestination[5] = pData[5] * y;
                pDataDestination[9] = pData[9] * z;
                pDataDestination[13] = pData[13];
                pDataDestination[2] = pData[2] * x;
                pDataDestination[6] = pData[6] * y;
                pDataDestination[10] = pData[10] * z;
                pDataDestination[14] = pData[14];
                pDataDestination[3] = pData[3] * x;
                pDataDestination[7] = pData[7] * y;
                pDataDestination[11] = pData[11] * z;
                pDataDestination[15] = pData[15];
                return m4fDestination;
            };
            Mat4.prototype.scaleLeft = function (v3fScale, m4fDestination) {
                var pData = this.data;
                var x = v3fScale.x, y = v3fScale.y, z = v3fScale.z;
                if (!((m4fDestination) !== undefined)) {
                    pData[0] *= x;
                    pData[4] *= x;
                    pData[8] *= x;
                    pData[12] *= x;
                    pData[1] *= y;
                    pData[5] *= y;
                    pData[9] *= y;
                    pData[13] *= y;
                    pData[2] *= z;
                    pData[6] *= z;
                    pData[10] *= z;
                    pData[14] *= z;
                    return this;
                }
                var pDataDestination = m4fDestination.data;
                pDataDestination[0] = pData[0] * x;
                pDataDestination[4] = pData[4] * x;
                pDataDestination[8] = pData[8] * x;
                pDataDestination[12] = pData[12] * x;
                pDataDestination[1] = pData[1] * y;
                pDataDestination[5] = pData[5] * y;
                pDataDestination[9] = pData[9] * y;
                pDataDestination[13] = pData[13] * y;
                pDataDestination[2] = pData[2] * z;
                pDataDestination[6] = pData[6] * z;
                pDataDestination[10] = pData[10] * z;
                pDataDestination[14] = pData[14] * z;
                pDataDestination[3] = pData[3];
                pDataDestination[7] = pData[7];
                pDataDestination[11] = pData[11];
                pDataDestination[15] = pData[15];
                return m4fDestination;
            };
            Mat4.prototype.decompose = function (q4fRotation, v3fScale, v3fTranslation) {
                this.getTranslation(v3fTranslation);
                var m3fRotScale = this.toMat3(math.mat3());
                return m3fRotScale.decompose(q4fRotation, v3fScale);
            };
            Mat4.prototype.row = function (iRow, v4fDestination) {
                if (!((v4fDestination) !== undefined)) {
                    v4fDestination = new math.Vec4();
                }
                var pData = this.data;
                switch(iRow) {
                    case 1:
                        v4fDestination.x = pData[0];
                        v4fDestination.y = pData[4];
                        v4fDestination.z = pData[8];
                        v4fDestination.w = pData[12];
                        break;
                    case 2:
                        v4fDestination.x = pData[1];
                        v4fDestination.y = pData[5];
                        v4fDestination.z = pData[9];
                        v4fDestination.w = pData[13];
                        break;
                    case 3:
                        v4fDestination.x = pData[2];
                        v4fDestination.y = pData[6];
                        v4fDestination.z = pData[10];
                        v4fDestination.w = pData[14];
                        break;
                    case 4:
                        v4fDestination.x = pData[3];
                        v4fDestination.y = pData[7];
                        v4fDestination.z = pData[11];
                        v4fDestination.w = pData[15];
                        break;
                }
                return v4fDestination;
            };
            Mat4.prototype.column = function (iColumn, v4fDestination) {
                if (!((v4fDestination) !== undefined)) {
                    v4fDestination = new math.Vec4();
                }
                var pData = this.data;
                switch(iColumn) {
                    case 1:
                        v4fDestination.x = pData[0];
                        v4fDestination.y = pData[1];
                        v4fDestination.z = pData[2];
                        v4fDestination.w = pData[3];
                        break;
                    case 2:
                        v4fDestination.x = pData[4];
                        v4fDestination.y = pData[5];
                        v4fDestination.z = pData[6];
                        v4fDestination.w = pData[7];
                        break;
                    case 3:
                        v4fDestination.x = pData[8];
                        v4fDestination.y = pData[9];
                        v4fDestination.z = pData[10];
                        v4fDestination.w = pData[11];
                        break;
                    case 4:
                        v4fDestination.x = pData[12];
                        v4fDestination.y = pData[13];
                        v4fDestination.z = pData[14];
                        v4fDestination.w = pData[15];
                        break;
                }
                return v4fDestination;
            };
            Mat4.prototype.unproj = function (v, v4fDestination) {
                if (!((v4fDestination) !== undefined)) {
                    v4fDestination = new math.Vec4();
                }
                var pData = this.data;
                var v3fScreen = v;
                var x, y, z;
                if (this.isOrthogonalProjection()) {
                    z = (v3fScreen.z - pData[14]) / pData[10];
                    y = (v3fScreen.y - pData[13]) / pData[5];
                    x = (v3fScreen.x - pData[12]) / pData[0];
                } else {
                    z = -pData[14] / (pData[10] + v3fScreen.z);
                    y = -(v3fScreen.y + pData[9]) * z / pData[5];
                    x = -(v3fScreen.x + pData[8]) * z / pData[0];
                }
                v4fDestination.x = x;
                v4fDestination.y = y;
                v4fDestination.z = z;
                v4fDestination.w = 1.;
                return v4fDestination;
            };
            Mat4.prototype.unprojZ = function (fZ) {
                var pData = this.data;
                if (this.isOrthogonalProjection()) {
                    return (fZ - pData[14]) / pData[10];
                } else {
                    return -pData[14] / (pData[10] + fZ);
                }
            };
            Mat4.prototype.isOrthogonalProjection = function () {
                return ((this.data[15] === 1) ? true : false);
            };
            Mat4.fromYawPitchRoll = function fromYawPitchRoll(fYaw, fPitch, fRoll, m4fDestination) {
                if (arguments.length <= 2) {
                    var v3fVec = arguments[0];
                    fYaw = v3fVec.x;
                    fPitch = v3fVec.y;
                    fRoll = v3fVec.z;
                    m4fDestination = arguments[1];
                }
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = new Mat4();
                }
                var pDataDestination = m4fDestination.data;
                var fSin1 = Math.sin(fYaw);
                var fSin2 = Math.sin(fPitch);
                var fSin3 = Math.sin(fRoll);
                var fCos1 = Math.cos(fYaw);
                var fCos2 = Math.cos(fPitch);
                var fCos3 = Math.cos(fRoll);
                pDataDestination[0] = fCos1 * fCos3 + fSin1 * fSin2 * fSin3;
                pDataDestination[4] = fCos3 * fSin1 * fSin2 - fCos1 * fSin3;
                pDataDestination[8] = fCos2 * fSin1;
                pDataDestination[12] = 0.;
                pDataDestination[1] = fCos2 * fSin3;
                pDataDestination[5] = fCos2 * fCos3;
                pDataDestination[9] = -fSin2;
                pDataDestination[13] = 0.;
                pDataDestination[2] = fCos1 * fSin2 * fSin3 - fCos3 * fSin1;
                pDataDestination[6] = fSin1 * fSin3 + fCos1 * fCos3 * fSin2;
                pDataDestination[10] = fCos1 * fCos2;
                pDataDestination[14] = 0.;
                pDataDestination[3] = 0.;
                pDataDestination[7] = 0.;
                pDataDestination[11] = 0.;
                pDataDestination[15] = 1.;
                return m4fDestination;
            };
            Mat4.fromXYZ = function fromXYZ(fX, fY, fZ, m4fDestination) {
                if (arguments.length <= 2) {
                    var v3fVec = arguments[0];
                    return Mat4.fromYawPitchRoll(v3fVec.y, v3fVec.x, v3fVec.z, arguments[1]);
                } else {
                    var fX = arguments[0];
                    var fY = arguments[1];
                    var fZ = arguments[2];
                    return Mat4.fromYawPitchRoll(fY, fX, fZ, arguments[3]);
                }
            };
            Mat4.frustum = function frustum(fLeft, fRight, fBottom, fTop, fNear, fFar, m4fDestination) {
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = new Mat4();
                }
                var pDataDestination = m4fDestination.data;
                var fRL = fRight - fLeft;
                var fTB = fTop - fBottom;
                var fFN = fFar - fNear;
                pDataDestination[0] = 2. * fNear / fRL;
                pDataDestination[4] = 0.;
                pDataDestination[8] = (fRight + fLeft) / fRL;
                pDataDestination[12] = 0.;
                pDataDestination[1] = 0.;
                pDataDestination[5] = 2. * fNear / fTB;
                pDataDestination[9] = (fTop + fBottom) / fTB;
                pDataDestination[13] = 0.;
                pDataDestination[2] = 0.;
                pDataDestination[6] = 0.;
                pDataDestination[10] = -(fFar + fNear) / fFN;
                pDataDestination[14] = -2. * fFar * fNear / fFN;
                pDataDestination[3] = 0.;
                pDataDestination[7] = 0.;
                pDataDestination[11] = -1.;
                pDataDestination[15] = 0.;
                return m4fDestination;
            };
            Mat4.perspective = function perspective(fFovy, fAspect, fNear, fFar, m4fDestination) {
                var fTop = fNear * math.tan(fFovy / 2.);
                var fRight = fTop * fAspect;
                return Mat4.frustum(-fRight, fRight, -fTop, fTop, fNear, fFar, m4fDestination);
            };
            Mat4.orthogonalProjectionAsymmetric = function orthogonalProjectionAsymmetric(fLeft, fRight, fBottom, fTop, fNear, fFar, m4fDestination) {
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = new Mat4();
                }
                var pDataDestination = m4fDestination.data;
                var fRL = fRight - fLeft;
                var fTB = fTop - fBottom;
                var fFN = fFar - fNear;
                pDataDestination[0] = 2. / fRL;
                pDataDestination[4] = 0.;
                pDataDestination[8] = 0.;
                pDataDestination[12] = -(fRight + fLeft) / fRL;
                pDataDestination[1] = 0.;
                pDataDestination[5] = 2. / fTB;
                pDataDestination[9] = 0.;
                pDataDestination[13] = -(fTop + fBottom) / fTB;
                pDataDestination[2] = 0.;
                pDataDestination[6] = 0.;
                pDataDestination[10] = -2. / fFN;
                pDataDestination[14] = -(fFar + fNear) / fFN;
                pDataDestination[3] = 0.;
                pDataDestination[7] = 0.;
                pDataDestination[11] = 0.;
                pDataDestination[15] = 1.;
                return m4fDestination;
            };
            Mat4.orthogonalProjection = function orthogonalProjection(fWidth, fHeight, fNear, fFar, m4fDestination) {
                var fRight = fWidth / 2.;
                var fTop = fHeight / 2.;
                return Mat4.orthogonalProjectionAsymmetric(-fRight, fRight, -fTop, fTop, fNear, fFar, m4fDestination);
            };
            Mat4.lookAt = function lookAt(v3fEye, v3fCenter, v3fUp, m4fDestination) {
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = new Mat4(1.);
                }
                var fEyeX = v3fEye.x, fEyeY = v3fEye.y, fEyeZ = v3fEye.z;
                var fCenterX = v3fCenter.x, fCenterY = v3fCenter.y, fCenterZ = v3fCenter.z;
                var fUpX = v3fUp.x, fUpY = v3fUp.y, fUpZ = v3fUp.z;
                var fLength;
                var fInvLength;
                if (fEyeX === fCenterX && fEyeY === fCenterY && fEyeZ === fCenterZ) {
                    return m4fDestination;
                }
                var fXNewX, fXNewY, fXNewZ;
                var fYNewX, fYNewY, fYNewZ;
                var fZNewX, fZNewY, fZNewZ;
                fZNewX = fEyeX - fCenterX;
                fZNewY = fEyeY - fCenterY;
                fZNewZ = fEyeZ - fCenterZ;
                fLength = math.sqrt(fZNewX * fZNewX + fZNewY * fZNewY + fZNewZ * fZNewZ);
                fInvLength = 1. / fLength;
                fZNewX = fZNewX * fInvLength;
                fZNewY = fZNewY * fInvLength;
                fZNewZ = fZNewZ * fInvLength;
                fXNewX = fUpY * fZNewZ - fUpZ * fZNewY;
                fXNewY = fUpZ * fZNewX - fUpX * fZNewZ;
                fXNewZ = fUpX * fZNewY - fUpY * fZNewX;
                fLength = math.sqrt(fXNewX * fXNewX + fXNewY * fXNewY + fXNewZ * fXNewZ);
                if (fLength) {
                    fInvLength = 1. / fLength;
                    fXNewX = fXNewX * fInvLength;
                    fXNewY = fXNewY * fInvLength;
                    fXNewZ = fXNewZ * fInvLength;
                }
                fYNewX = fZNewY * fXNewZ - fZNewZ * fXNewY;
                fYNewY = fZNewZ * fXNewX - fZNewX * fXNewZ;
                fYNewZ = fZNewX * fXNewY - fZNewY * fXNewX;
                var fEyeNewX = fEyeX * fXNewX + fEyeY * fXNewY + fEyeZ * fXNewZ;
                var fEyeNewY = fEyeX * fYNewX + fEyeY * fYNewY + fEyeZ * fYNewZ;
                var fEyeNewZ = fEyeX * fZNewX + fEyeY * fZNewY + fEyeZ * fZNewZ;
                var pDataDestination = m4fDestination.data;
                pDataDestination[0] = fXNewX;
                pDataDestination[4] = fXNewY;
                pDataDestination[8] = fXNewZ;
                pDataDestination[12] = -fEyeNewX;
                pDataDestination[1] = fYNewX;
                pDataDestination[5] = fYNewY;
                pDataDestination[9] = fYNewZ;
                pDataDestination[13] = -fEyeNewY;
                pDataDestination[2] = fZNewX;
                pDataDestination[6] = fZNewY;
                pDataDestination[10] = fZNewZ;
                pDataDestination[14] = -fEyeNewZ;
                pDataDestination[3] = 0.;
                pDataDestination[7] = 0.;
                pDataDestination[11] = 0.;
                pDataDestination[15] = 1.;
                return m4fDestination;
            };
            Object.defineProperty(Mat4, "stackCeil", {
                get: function () {
                    Mat4.stackPosition = Mat4.stackPosition === Mat4.stackSize - 1 ? 0 : Mat4.stackPosition;
                    return Mat4.stack[Mat4.stackPosition++];
                },
                enumerable: true,
                configurable: true
            });
            Mat4.stackSize = 100;
            Mat4.stackPosition = 0;
            Mat4.stack = (function () {
                var pStack = new Array(Mat4.stackSize);
                for(var i = 0; i < Mat4.stackSize; i++) {
                    pStack[i] = new Mat4();
                }
                return pStack;
            })();
            return Mat4;
        })();
        math.Mat4 = Mat4;        
    })(akra.math || (akra.math = {}));
    var math = akra.math;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (math) {
        var Quat4 = (function () {
            function Quat4(fX, fY, fZ, fW) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        this.set(arguments[0]);
                        break;
                    case 2:
                        this.set(arguments[0], arguments[1]);
                        break;
                    case 4:
                        this.set(arguments[0], arguments[1], arguments[2], arguments[3]);
                        break;
                    default:
                        this.x = this.y = this.z = 0.;
                        this.w = 1.;
                        break;
                }
            }
            Quat4.prototype.set = function (fX, fY, fZ, fW) {
                var nArgumentsLength = arguments.length;
                if (nArgumentsLength === 0) {
                    this.x = this.y = this.z = 0.;
                    this.w = 1.;
                }
                if (nArgumentsLength === 1) {
                    if (arguments[0] instanceof Quat4) {
                        var q4fQuat = arguments[0];
                        this.x = q4fQuat.x;
                        this.y = q4fQuat.y;
                        this.z = q4fQuat.z;
                        this.w = q4fQuat.w;
                    } else {
                        var pElements = arguments[0];
                        this.x = pElements[0];
                        this.y = pElements[1];
                        this.z = pElements[2];
                        this.w = pElements[3];
                    }
                } else if (nArgumentsLength === 2) {
                    if ((typeof (arguments[0]) === "number")) {
                        var fValue = arguments[0];
                        this.x = fValue;
                        this.y = fValue;
                        this.z = fValue;
                        this.w = arguments[1];
                    } else {
                        var v3fValue = arguments[0];
                        this.x = v3fValue.x;
                        this.y = v3fValue.y;
                        this.z = v3fValue.z;
                        this.w = arguments[1];
                    }
                } else if (nArgumentsLength === 4) {
                    this.x = arguments[0];
                    this.y = arguments[1];
                    this.z = arguments[2];
                    this.w = arguments[3];
                }
                return this;
            };
            Quat4.prototype.multiply = function (q4fQuat, q4fDestination) {
                if (!((q4fDestination) !== undefined)) {
                    q4fDestination = this;
                }
                var x1 = this.x, y1 = this.y, z1 = this.z, w1 = this.w;
                var x2 = q4fQuat.x, y2 = q4fQuat.y, z2 = q4fQuat.z, w2 = q4fQuat.w;
                q4fDestination.x = x1 * w2 + x2 * w1 + y1 * z2 - z1 * y2;
                q4fDestination.y = y1 * w2 + y2 * w1 + z1 * x2 - x1 * z2;
                q4fDestination.z = z1 * w2 + z2 * w1 + x1 * y2 - y1 * x2;
                q4fDestination.w = w1 * w2 - x1 * x2 - y1 * y2 - z1 * z2;
                return q4fDestination;
            };
            Quat4.prototype.multiplyVec3 = function (v3fVec, v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = v3fVec;
                }
                var q4fVec = math.quat4(v3fVec, 0);
                var qInverse = this.inverse(math.quat4());
                var qResult = this.multiply(q4fVec.multiply(qInverse), math.quat4());
                v3fDestination.x = qResult.x;
                v3fDestination.y = qResult.y;
                v3fDestination.z = qResult.z;
                return v3fDestination;
            };
            Quat4.prototype.conjugate = function (q4fDestination) {
                if (!((q4fDestination) !== undefined)) {
                    this.x = -this.x;
                    this.y = -this.y;
                    this.z = -this.z;
                    return this;
                }
                q4fDestination.x = -this.x;
                q4fDestination.y = -this.y;
                q4fDestination.z = -this.z;
                q4fDestination.w = this.w;
                return q4fDestination;
            };
            Quat4.prototype.inverse = function (q4fDestination) {
                if (!((q4fDestination) !== undefined)) {
                    q4fDestination = this;
                }
                var x = this.x, y = this.y, z = this.z, w = this.w;
                var fSqLength = x * x + y * y + z * z + w * w;
                if (fSqLength === 0.) {
                    q4fDestination.x = 0.;
                    q4fDestination.y = 0.;
                    q4fDestination.z = 0.;
                    q4fDestination.w = 0.;
                } else {
                    var fInvSqLength = 1. / fSqLength;
                    q4fDestination.x = -x * fInvSqLength;
                    q4fDestination.y = -y * fInvSqLength;
                    q4fDestination.z = -z * fInvSqLength;
                    q4fDestination.w = w * fInvSqLength;
                }
                return q4fDestination;
            };
            Quat4.prototype.length = function () {
                var x = this.x, y = this.y, z = this.z, w = this.w;
                return math.sqrt(x * x + y * y + z * z + w * w);
            };
            Quat4.prototype.normalize = function (q4fDestination) {
                if (!((q4fDestination) !== undefined)) {
                    q4fDestination = this;
                }
                var x = this.x, y = this.y, z = this.z, w = this.w;
                var fLength = math.sqrt(x * x + y * y + z * z + w * w);
                if (fLength === 0.) {
                    q4fDestination.x = 0.;
                    q4fDestination.y = 0.;
                    q4fDestination.z = 0.;
                    q4fDestination.w = 0.;
                } else {
                    var fInvLength = 1 / fLength;
                    q4fDestination.x = x * fInvLength;
                    q4fDestination.y = y * fInvLength;
                    q4fDestination.z = z * fInvLength;
                    q4fDestination.w = w * fInvLength;
                }
                return q4fDestination;
            };
            Quat4.prototype.calculateW = function (q4fDestination) {
                var x = this.x, y = this.y, z = this.z;
                if (!((q4fDestination) !== undefined)) {
                    this.w = math.sqrt(1. - x * x - y * y - z * z);
                    return this;
                }
                q4fDestination.x = x;
                q4fDestination.y = y;
                q4fDestination.z = z;
                q4fDestination.w = math.sqrt(1. - x * x - y * y - z * z);
                return q4fDestination;
            };
            Quat4.prototype.isEqual = function (q4fQuat, fEps, asMatrix) {
                if (typeof fEps === "undefined") { fEps = 0.; }
                if (typeof asMatrix === "undefined") { asMatrix = false; }
                var x1 = this.x, y1 = this.y, z1 = this.z, w1 = this.w;
                var x2 = q4fQuat.x, y2 = q4fQuat.y, z2 = q4fQuat.z, w2 = q4fQuat.w;
                var fLength1 = math.sqrt(x1 * x1 + y1 * y1 + z1 * z1 + w1 * w1);
                var fLength2 = math.sqrt(x2 * x2 + y2 * y2 + z2 * z2 + w2 * w2);
                if (math.abs(fLength2 - fLength2) > fEps) {
                    return false;
                }
                var cosHalfTheta = (x1 * x2 + y1 * y2 + z1 * z2 + w1 * w2) / fLength1 / fLength2;
                if (asMatrix) {
                    cosHalfTheta = math.abs(cosHalfTheta);
                }
                if (1. - cosHalfTheta > fEps) {
                    return false;
                }
                return true;
            };
            Quat4.prototype.getYaw = function () {
                var fYaw;
                var x = this.x, y = this.y, z = this.z, w = this.w;
                var fx2 = x * 2.;
                var fy2 = y * 2.;
                if (math.abs(x) == math.abs(w)) {
                    var wTemp = w * math.sqrt(2.);
                    var yTemp = y * math.sqrt(2.);
                    fYaw = math.atan2(yTemp, wTemp) * 2.;
                    var pi = math.PI;
                    if (fYaw > pi) {
                        fYaw -= pi;
                    } else if (fYaw < -pi) {
                        fYaw += pi;
                    }
                } else {
                    fYaw = math.atan2(fx2 * z + fy2 * w, 1. - (fx2 * x + fy2 * y));
                }
                return fYaw;
            };
            Quat4.prototype.getPitch = function () {
                var fPitch;
                var x = this.x, y = this.y, z = this.z, w = this.w;
                var fx2 = x * 2.;
                var fy2 = y * 2.;
                var fSinPitch = (/*checked (origin: math)>>*/akra.math.max((-1.), /*checked (origin: math)>>*/akra.math.min((fx2 * w - fy2 * z), (1.))));
                fPitch = math.asin(fSinPitch);
                return fPitch;
            };
            Quat4.prototype.getRoll = function () {
                var fRoll;
                var x = this.x, y = this.y, z = this.z, w = this.w;
                var fx2 = x * 2.;
                var fz2 = z * 2.;
                if (math.abs(x) == math.abs(w)) {
                    var wTemp = w * math.sqrt(2.);
                    var yTemp = y * math.sqrt(2.);
                    var fYaw = math.atan2(yTemp, wTemp) * 2.;
                    fRoll = 0.;
                    var pi = math.PI;
                    if (fYaw > pi) {
                        fRoll = (x == w) ? -pi : pi;
                    } else if (fYaw < -pi) {
                        fRoll = (x == w) ? pi : -pi;
                    }
                } else {
                    fRoll = math.atan2(fx2 * y + fz2 * w, 1. - (fx2 * x + fz2 * z));
                }
                return fRoll;
            };
            Quat4.prototype.toYawPitchRoll = function (v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = new math.Vec3();
                }
                var fYaw, fPitch, fRoll;
                var x = this.x, y = this.y, z = this.z, w = this.w;
                var fx2 = x * 2.;
                var fy2 = y * 2.;
                var fz2 = z * 2.;
                var fw2 = w * 2.;
                var fSinPitch = (/*checked (origin: math)>>*/akra.math.max((-1.), /*checked (origin: math)>>*/akra.math.min((fx2 * w - fy2 * z), (1.))));
                fPitch = math.asin(fSinPitch);
                if (math.abs(x) == math.abs(w)) {
                    var wTemp = w * math.sqrt(2.);
                    var yTemp = y * math.sqrt(2.);
                    fYaw = math.atan2(yTemp, wTemp) * 2.;
                    fRoll = 0.;
                    var pi = math.PI;
                    if (fYaw > pi) {
                        fYaw -= pi;
                        fRoll = (x == w) ? -pi : pi;
                    } else if (fYaw < -pi) {
                        fYaw += pi;
                        fRoll = (x == w) ? pi : -pi;
                    }
                } else {
                    fYaw = math.atan2(fx2 * z + fy2 * w, 1. - (fx2 * x + fy2 * y));
                    fRoll = math.atan2(fx2 * y + fz2 * w, 1. - (fx2 * x + fz2 * z));
                }
                v3fDestination.x = fYaw;
                v3fDestination.y = fPitch;
                v3fDestination.z = fRoll;
                return v3fDestination;
            };
            Quat4.prototype.toMat3 = function (m3fDestination) {
                if (!((m3fDestination) !== undefined)) {
                    m3fDestination = new math.Mat3();
                }
                var pDataDestination = m3fDestination.data;
                var x = this.x, y = this.y, z = this.z, w = this.w;
                pDataDestination[0] = 1. - 2. * (y * y + z * z);
                pDataDestination[3] = 2. * (x * y - z * w);
                pDataDestination[6] = 2. * (x * z + y * w);
                pDataDestination[1] = 2. * (x * y + z * w);
                pDataDestination[4] = 1. - 2. * (x * x + z * z);
                pDataDestination[7] = 2. * (y * z - x * w);
                pDataDestination[2] = 2. * (x * z - y * w);
                pDataDestination[5] = 2. * (y * z + x * w);
                pDataDestination[8] = 1. - 2. * (x * x + y * y);
                return m3fDestination;
            };
            Quat4.prototype.toMat4 = function (m4fDestination) {
                if (!((m4fDestination) !== undefined)) {
                    m4fDestination = new math.Mat4();
                }
                var pDataDestination = m4fDestination.data;
                var x = this.x, y = this.y, z = this.z, w = this.w;
                pDataDestination[0] = 1. - 2. * (y * y + z * z);
                pDataDestination[4] = 2. * (x * y - z * w);
                pDataDestination[8] = 2. * (x * z + y * w);
                pDataDestination[12] = 0.;
                pDataDestination[1] = 2. * (x * y + z * w);
                pDataDestination[5] = 1. - 2. * (x * x + z * z);
                pDataDestination[9] = 2. * (y * z - x * w);
                pDataDestination[13] = 0.;
                pDataDestination[2] = 2. * (x * z - y * w);
                pDataDestination[6] = 2. * (y * z + x * w);
                pDataDestination[10] = 1. - 2. * (x * x + y * y);
                pDataDestination[14] = 0.;
                pDataDestination[3] = 0.;
                pDataDestination[7] = 0.;
                pDataDestination[11] = 0.;
                pDataDestination[15] = 1.;
                return m4fDestination;
            };
            Quat4.prototype.toString = function () {
                return "[x: " + this.x + ", y: " + this.y + ", z: " + this.z + ", w: " + this.w + "]";
            };
            Quat4.prototype.mix = function (q4fQuat, fA, q4fDestination, bShortestPath) {
                if (typeof bShortestPath === "undefined") { bShortestPath = true; }
                if (!((q4fDestination) !== undefined)) {
                    q4fDestination = this;
                }
                fA = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((fA), (1))));
                var x1 = this.x, y1 = this.y, z1 = this.z, w1 = this.w;
                var x2 = q4fQuat.x, y2 = q4fQuat.y, z2 = q4fQuat.z, w2 = q4fQuat.w;
                var fCos = x1 * x2 + y1 * y2 + z1 * z2 + w1 * w2;
                if (fCos < 0. && bShortestPath) {
                    x2 = -x2;
                    y2 = -y2;
                    z2 = -z2;
                    w2 = -w2;
                }
                var k1 = 1. - fA;
                var k2 = fA;
                q4fDestination.x = x1 * k1 + x2 * k2;
                q4fDestination.y = y1 * k1 + y2 * k2;
                q4fDestination.z = z1 * k1 + z2 * k2;
                q4fDestination.w = w1 * k1 + w2 * k2;
                return q4fDestination;
            };
            Quat4.prototype.smix = function (q4fQuat, fA, q4fDestination, bShortestPath) {
                if (typeof bShortestPath === "undefined") { bShortestPath = true; }
                if (!((q4fDestination) !== undefined)) {
                    q4fDestination = this;
                }
                fA = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((fA), (1))));
                var x1 = this.x, y1 = this.y, z1 = this.z, w1 = this.w;
                var x2 = q4fQuat.x, y2 = q4fQuat.y, z2 = q4fQuat.z, w2 = q4fQuat.w;
                var fCos = x1 * x2 + y1 * y2 + z1 * z2 + w1 * w2;
                if (fCos < 0 && bShortestPath) {
                    fCos = -fCos;
                    x2 = -x2;
                    y2 = -y2;
                    z2 = -z2;
                    w2 = -w2;
                }
                var fEps = 1e-3;
                if (math.abs(fCos) < 1. - fEps) {
                    var fSin = math.sqrt(1. - fCos * fCos);
                    var fInvSin = 1. / fSin;
                    var fAngle = math.atan2(fSin, fCos);
                    var k1 = math.sin((1. - fA) * fAngle) * fInvSin;
                    var k2 = math.sin(fA * fAngle) * fInvSin;
                    q4fDestination.x = x1 * k1 + x2 * k2;
                    q4fDestination.y = y1 * k1 + y2 * k2;
                    q4fDestination.z = z1 * k1 + z2 * k2;
                    q4fDestination.w = w1 * k1 + w2 * k2;
                } else {
                    var k1 = 1 - fA;
                    var k2 = fA;
                    var x = x1 * k1 + x2 * k2;
                    var y = y1 * k1 + y2 * k2;
                    var z = z1 * k1 + z2 * k2;
                    var w = w1 * k1 + w2 * k2;
                    var fLength = math.sqrt(x * x + y * y + z * z + w * w);
                    var fInvLen = fLength ? 1 / fLength : 0;
                    q4fDestination.x = x * fInvLen;
                    q4fDestination.y = y * fInvLen;
                    q4fDestination.z = z * fInvLen;
                    q4fDestination.w = w * fInvLen;
                }
                return q4fDestination;
            };
            Quat4.fromForwardUp = function fromForwardUp(v3fForward, v3fUp, q4fDestination) {
                if (!((q4fDestination) !== undefined)) {
                    q4fDestination = new Quat4();
                }
                var fForwardX = v3fForward.x, fForwardY = v3fForward.y, fForwardZ = v3fForward.z;
                var fUpX = v3fUp.x, fUpY = v3fUp.y, fUpZ = v3fUp.z;
                var m3fTemp = math.mat3();
                var pTempData = m3fTemp.data;
                pTempData[0] = fUpY * fForwardZ - fUpZ * fForwardY;
                pTempData[3] = fUpX;
                pTempData[6] = fForwardX;
                pTempData[1] = fUpZ * fForwardX - fUpX * fForwardZ;
                pTempData[4] = fUpY;
                pTempData[7] = fForwardY;
                pTempData[2] = fUpX * fForwardY - fUpY * fForwardX;
                pTempData[5] = fUpZ;
                pTempData[8] = fForwardZ;
                return m3fTemp.toQuat4(q4fDestination);
            };
            Quat4.fromAxisAngle = function fromAxisAngle(v3fAxis, fAngle, q4fDestination) {
                if (!((q4fDestination) !== undefined)) {
                    q4fDestination = new Quat4();
                }
                var x = v3fAxis.x, y = v3fAxis.y, z = v3fAxis.z;
                var fLength = math.sqrt(x * x + y * y + z * z);
                if (fLength === 0.) {
                    q4fDestination.x = q4fDestination.y = q4fDestination.z = 0;
                    q4fDestination.w = 1;
                    return q4fDestination;
                }
                var fInvLength = 1 / fLength;
                x *= fInvLength;
                y *= fInvLength;
                z *= fInvLength;
                var fSin = math.sin(fAngle / 2);
                var fCos = math.cos(fAngle / 2);
                q4fDestination.x = x * fSin;
                q4fDestination.y = y * fSin;
                q4fDestination.z = z * fSin;
                q4fDestination.w = fCos;
                return q4fDestination;
            };
            Quat4.fromYawPitchRoll = function fromYawPitchRoll(fYaw, fPitch, fRoll, q4fDestination) {
                if (arguments.length <= 2) {
                    var v3fVec = arguments[0];
                    fYaw = v3fVec.x;
                    fPitch = v3fVec.y;
                    fRoll = v3fVec.z;
                    q4fDestination = arguments[1];
                }
                if (!((q4fDestination) !== undefined)) {
                    q4fDestination = new Quat4();
                }
                var fHalfYaw = fYaw * 0.5;
                var fHalfPitch = fPitch * 0.5;
                var fHalfRoll = fRoll * 0.5;
                var fCos1 = math.cos(fHalfYaw), fSin1 = math.sin(fHalfYaw);
                var fCos2 = math.cos(fHalfPitch), fSin2 = math.sin(fHalfPitch);
                var fCos3 = math.cos(fHalfRoll), fSin3 = math.sin(fHalfRoll);
                q4fDestination.x = fCos1 * fSin2 * fCos3 + fSin1 * fCos2 * fSin3;
                q4fDestination.y = fSin1 * fCos2 * fCos3 - fCos1 * fSin2 * fSin3;
                q4fDestination.z = fCos1 * fCos2 * fSin3 - fSin1 * fSin2 * fCos3;
                q4fDestination.w = fCos1 * fCos2 * fCos3 + fSin1 * fSin2 * fSin3;
                return q4fDestination;
            };
            Quat4.fromXYZ = function fromXYZ(fX, fY, fZ, q4fDestination) {
                if (arguments.length <= 2) {
                    var v3fVec = arguments[0];
                    return Quat4.fromYawPitchRoll(v3fVec.y, v3fVec.x, v3fVec.z, arguments[1]);
                } else {
                    var fX = arguments[0];
                    var fY = arguments[1];
                    var fZ = arguments[2];
                    return Quat4.fromYawPitchRoll(fY, fX, fZ, arguments[3]);
                }
            };
            Object.defineProperty(Quat4, "stackCeil", {
                get: function () {
                    Quat4.stackPosition = Quat4.stackPosition === Quat4.stackSize - 1 ? 0 : Quat4.stackPosition;
                    return Quat4.stack[Quat4.stackPosition++];
                },
                enumerable: true,
                configurable: true
            });
            Quat4.stackSize = 100;
            Quat4.stackPosition = 0;
            Quat4.stack = (function () {
                var pStack = new Array(Quat4.stackSize);
                for(var i = 0; i < Quat4.stackSize; i++) {
                    pStack[i] = new Quat4();
                }
                return pStack;
            })();
            return Quat4;
        })();
        math.Quat4 = Quat4;        
    })(akra.math || (akra.math = {}));
    var math = akra.math;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (math) {
        math.E = Math.E;
        math.LN2 = Math.LN2;
        math.LOG2E = Math.LOG2E;
        math.LOG10E = Math.LOG10E;
        math.PI = Math.PI;
        math.SQRT1_2 = Math.SQRT1_2;
        math.SQRT2 = Math.SQRT2;
        math.LN10 = Math.LN10;
        math.POSITIVE_INFINITY = Number.POSITIVE_INFINITY;
        math.NEGATIVE_INFINITY = Number.NEGATIVE_INFINITY;
        math.FLOAT_PRECISION = (3.4e-8);
        math.TWO_PI = (2.0 * math.PI);
        math.HALF_PI = (math.PI / 2.0);
        math.QUARTER_PI = (math.PI / 4.0);
        math.EIGHTH_PI = (math.PI / 8.0);
        math.PI_SQUARED = (9.86960440108935861883449099987615113531369940724079);
        math.PI_INVERSE = (0.31830988618379067153776752674502872406891929148091);
        math.PI_OVER_180 = (math.PI / 180);
        math.PI_DIV_180 = (180 / math.PI);
        math.NATURAL_LOGARITHM_BASE = (2.71828182845904523536028747135266249775724709369996);
        math.EULERS_CONSTANT = (0.57721566490153286060651);
        math.SQUARE_ROOT_2 = (1.41421356237309504880168872420969807856967187537695);
        math.INVERSE_ROOT_2 = (0.707106781186547524400844362105198);
        math.SQUARE_ROOT_3 = (1.73205080756887729352744634150587236694280525381038);
        math.SQUARE_ROOT_5 = (2.23606797749978969640917366873127623544061835961153);
        math.SQUARE_ROOT_10 = (3.16227766016837933199889354443271853371955513932522);
        math.CUBE_ROOT_2 = (1.25992104989487316476721060727822835057025146470151);
        math.CUBE_ROOT_3 = (1.44224957030740838232163831078010958839186925349935);
        math.FOURTH_ROOT_2 = (1.18920711500272106671749997056047591529297209246382);
        math.NATURAL_LOG_2 = (0.69314718055994530941723212145817656807550013436026);
        math.NATURAL_LOG_3 = (1.09861228866810969139524523692252570464749055782275);
        math.NATURAL_LOG_10 = (2.30258509299404568401799145468436420760110148862877);
        math.NATURAL_LOG_PI = (1.14472988584940017414342735135305871164729481291531);
        math.BASE_TEN_LOG_PI = (0.49714987269413385435126828829089887365167832438044);
        math.NATURAL_LOGARITHM_BASE_INVERSE = (0.36787944117144232159552377016146086744581113103177);
        math.NATURAL_LOGARITHM_BASE_SQUARED = (7.38905609893065022723042746057500781318031557055185);
        math.GOLDEN_RATIO = ((math.SQUARE_ROOT_5 + 1.0) / 2.0);
        math.DEGREE_RATIO = (math.PI_DIV_180);
        math.RADIAN_RATIO = (math.PI_OVER_180);
        math.GRAVITY_CONSTANT = 9.81;
    })(akra.math || (akra.math = {}));
    var math = akra.math;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (math) {
        math.abs = Math.abs;
        math.acos = Math.acos;
        math.asin = Math.asin;
        math.atan = Math.atan;
        math.atan2 = Math.atan2;
        math.exp = Math.exp;
        math.min = Math.min;
        math.random = Math.random;
        math.sqrt = Math.sqrt;
        math.log = Math.log;
        math.round = Math.round;
        math.floor = Math.floor;
        math.ceil = Math.ceil;
        math.sin = Math.sin;
        math.cos = Math.cos;
        math.tan = Math.tan;
        math.pow = Math.pow;
        math.max = Math.max;
        math.fpBits = /** @inline */function (f) {
            return math.floor(f);
        };
        math.intBits = /** @inline */function (i) {
            return i;
        };
        math.fpSign = /** @inline */function (f) {
            return (f >> 31);
        };
        math.fpExponent = /** @inline */function (f) {
            return ((((/*checked (origin: math)>>*/akra.math.floor((f))) & 0x7fffffff) >> 23) - 127);
        };
        math.fpExponentSign = /** @inline */function (f) {
            return ((((((/*checked (origin: math)>>*/akra.math.floor(((f)))) & 0x7fffffff) >> 23) - 127)) >> 31);
        };
        math.fpPureMantissa = /** @inline */function (f) {
            return ((/*checked (origin: math)>>*/akra.math.floor((f))) & 0x7fffff);
        };
        math.fpMantissa = /** @inline */function (f) {
            return ((((/*checked (origin: math)>>*/akra.math.floor(((f)))) & 0x7fffff)) | (1 << 23));
        };
        math.fpOneBits = 0x3F800000;
        math.flipSign = /** @inline */function (i, flip) {
            return ((flip == -1) ? -i : i);
        };
        math.absoluteValue = math.abs;
        math.raiseToPower = math.pow;
        math.isPositive = /** @inline */function (a) {
            return (a >= 0);
        };
        math.isNegative = /** @inline */function (a) {
            return (a < 0);
        };
        math.sameSigns = /** @inline */function (a, b) {
            return ((((a) < 0)) == (((b) < 0)));
        };
        math.copySign = /** @inline */function (a, b) {
            return ((((b) < 0)) ? -math.absoluteValue(a) : math.absoluteValue(a));
        };
        math.deltaRangeTest = /** @inline */function (a, b, epsilon) {
            if (typeof epsilon === "undefined") { epsilon = 0.0000001; }
            return ((math.absoluteValue(a - b) < epsilon) ? true : false);
        };
        math.clamp = /** @inline */function (value, low, high) {
            return math.max(low, math.min(value, high));
        };
        math.clampPositive = /** @inline */function (value) {
            return (value < 0 ? 0 : value);
        };
        math.clampNegative = /** @inline */function (value) {
            return (value > 0 ? 0 : value);
        };
        math.clampUnitSize = /** @inline */function (value) {
            return (/*checked (origin: math)>>*/akra.math.max((-1), /*checked (origin: math)>>*/akra.math.min((value), (1))));
        };
        math.highestBitSet = /** @inline */function (value) {
            return value == 0 ? (null) : (value < 0 ? 31 : ((math.log(value) / math.LN2) << 0));
        };
        math.lowestBitSet = function (value) {
            var temp;
            if (value == 0) {
                return null;
            }
            for(temp = 0; temp <= 31; temp++) {
                if (value & (1 << temp)) {
                    return temp;
                }
            }
            return null;
        };
        math.isPowerOfTwo = /** @inline */function (value) {
            return (value > 0 && ((value) == 0 ? (null) : ((value) < 0 ? 31 : ((/*checked (origin: math)>>*/akra.math.log((value)) / /*checked (origin: math)>>*/akra.math.LN2) << 0))) == math.lowestBitSet(value));
        };
        math.nearestPowerOfTwo = function (value) {
            if (value <= 1) {
                return 1;
            }
            var highestBit = ((value) == 0 ? (null) : ((value) < 0 ? 31 : ((/*checked (origin: math)>>*/akra.math.log((value)) / /*checked (origin: math)>>*/akra.math.LN2) << 0)));
            var roundingTest = value & (1 << (highestBit - 1));
            if (roundingTest != 0) {
                ++highestBit;
            }
            return 1 << highestBit;
        };
        math.ceilingPowerOfTwo = function (value) {
            if (value <= 1) {
                return 1;
            }
            var highestBit = ((value) == 0 ? (null) : ((value) < 0 ? 31 : ((/*checked (origin: math)>>*/akra.math.log((value)) / /*checked (origin: math)>>*/akra.math.LN2) << 0)));
            var mask = value & ((1 << highestBit) - 1);
            highestBit += mask && 1;
            return 1 << highestBit;
        };
        math.floorPowerOfTwo = function (value) {
            if (value <= 1) {
                return 1;
            }
            var highestBit = ((value) == 0 ? (null) : ((value) < 0 ? 31 : ((/*checked (origin: math)>>*/akra.math.log((value)) / /*checked (origin: math)>>*/akra.math.LN2) << 0)));
            return 1 << highestBit;
        };
        math.modulus = /** @inline */function (e, divisor) {
            return (e - math.floor(e / divisor) * divisor);
        };
        math.mod = math.modulus;
        math.alignUp = function (value, alignment) {
            var iRemainder = (((value) - /*checked (origin: math)>>*/akra.math.floor((value) / (alignment)) * (alignment)));
            if (iRemainder == 0) {
                return (value);
            }
            return (value + (alignment - iRemainder));
        };
        math.alignDown = function (value, alignment) {
            var remainder = (((value) - /*checked (origin: math)>>*/akra.math.floor((value) / (alignment)) * (alignment)));
            if (remainder == 0) {
                return (value);
            }
            return (value - remainder);
        };
        math.inverse = /** @inline */function (a) {
            return 1. / a;
        };
        math.log2 = /** @inline */function (f) {
            return math.log(f) / math.LN2;
        };
        math.trimFloat = /** @inline */function (f, precision) {
            return f;
        };
        math.realToInt32_chop = /** @inline */function (a) {
            return math.round(a);
        };
        math.realToInt32_floor = /** @inline */function (a) {
            return math.floor(a);
        };
        math.realToInt32_ceil = /** @inline */function (a) {
            return math.ceil(a);
        };
        math.nod = function (n, m) {
            var p = n % m;
            while(p != 0) {
                n = m;
                m = p;
                p = n % m;
            }
            return m;
        };
        math.nok = /** @inline */function (n, m) {
            return math.abs(n * m) / math.nod(n, m);
        };
        math.gcd = math.nod;
        math.lcm = math.nok;
        math.isRealEqual = function (a, b, tolerance) {
            if (typeof tolerance === "undefined") { tolerance = 1.19209e-007; }
            if (akra.math.abs(b - a) <= tolerance) {
                return true;
            } else {
                return false;
            }
        };
        function calcPOTtextureSize(nPixels) {
            var w, h;
            var n = nPixels;
            w = Math.ceil(Math.log(n) / Math.LN2 / 2.0);
            h = Math.ceil(Math.log(n / Math.pow(2, w)) / Math.LN2);
            w = Math.pow(2, w);
            h = Math.pow(2, h);
            n = w * h;
            return [
                w, 
                h, 
                n
            ];
        }
        math.calcPOTtextureSize = calcPOTtextureSize;
    })(akra.math || (akra.math = {}));
    var math = akra.math;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (math) {
                                                function vec2(fValue1, fValue2) {
            var nArgumentsLength = arguments.length;
            var v2fVec = math.Vec2.stack[math.Vec2.stackPosition++];
            if (math.Vec2.stackPosition == math.Vec2.stackSize) {
                math.Vec2.stackPosition = 0;
            }
            switch(nArgumentsLength) {
                case 1:
                    v2fVec.set(arguments[0]);
                    break;
                case 2:
                    v2fVec.set(arguments[0], arguments[1]);
                    break;
                default:
                    v2fVec.x = v2fVec.y = 0.;
                    break;
            }
            return v2fVec;
        }
        math.vec2 = vec2;
        ;
                                                                function vec3(fValue1, fValue2, fValue3) {
            var nArgumentsLength = arguments.length;
            var v3fVec = math.Vec3.stack[math.Vec3.stackPosition++];
            if (math.Vec3.stackPosition == math.Vec3.stackSize) {
                math.Vec3.stackPosition = 0;
            }
            switch(nArgumentsLength) {
                case 1:
                    v3fVec.set(arguments[0]);
                    break;
                case 2:
                    v3fVec.set(arguments[0], arguments[1]);
                    break;
                case 3:
                    v3fVec.set(arguments[0], arguments[1], arguments[2]);
                    break;
                default:
                    v3fVec.x = v3fVec.y = v3fVec.z = 0.;
                    break;
            }
            return v3fVec;
        }
        math.vec3 = vec3;
        ;
                                                                                                function vec4(fValue1, fValue2, fValue3, fValue4) {
            var nArgumentsLength = arguments.length;
            var v4fVec = math.Vec4.stack[math.Vec4.stackPosition++];
            if (math.Vec4.stackPosition == math.Vec4.stackSize) {
                math.Vec4.stackPosition = 0;
            }
            switch(nArgumentsLength) {
                case 1:
                    v4fVec.set(arguments[0]);
                    break;
                case 2:
                    v4fVec.set(arguments[0], arguments[1]);
                    break;
                case 3:
                    v4fVec.set(arguments[0], arguments[1], arguments[2]);
                    break;
                case 4:
                    v4fVec.set(arguments[0], arguments[1], arguments[2], arguments[3]);
                    break;
                default:
                    v4fVec.x = v4fVec.y = v4fVec.z = v4fVec.w = 0.;
                    break;
            }
            return v4fVec;
        }
        math.vec4 = vec4;
        ;
                                                        function quat4(fX, fY, fZ, fW) {
            var nArgumentsLength = arguments.length;
            var q4fQuat = math.Quat4.stack[math.Quat4.stackPosition++];
            if (math.Quat4.stackPosition == math.Quat4.stackSize) {
                math.Quat4.stackPosition = 0;
            }
            switch(nArgumentsLength) {
                case 1:
                    q4fQuat.set(arguments[0]);
                    break;
                case 2:
                    q4fQuat.set(arguments[0], arguments[1]);
                    break;
                case 4:
                    q4fQuat.set(arguments[0], arguments[1], arguments[2], arguments[3]);
                    break;
                default:
                    q4fQuat.x = q4fQuat.y = q4fQuat.z = 0.;
                    q4fQuat.w = 1.;
                    break;
            }
            return q4fQuat;
        }
        math.quat4 = quat4;
        ;
                                                                                        function mat3(fValue1, fValue2, fValue3, fValue4, fValue5, fValue6, fValue7, fValue8, fValue9) {
            var nArgumentsLength = arguments.length;
            var m3fMat = math.Mat3.stack[math.Mat3.stackPosition++];
            if (math.Mat3.stackPosition == math.Mat3.stackSize) {
                math.Mat3.stackPosition = 0;
            }
            switch(nArgumentsLength) {
                case 1:
                    m3fMat.set(arguments[0]);
                    break;
                case 3:
                    m3fMat.set(arguments[0], arguments[1], arguments[2]);
                    break;
                case 9:
                    m3fMat.set(arguments[0], arguments[1], arguments[2], arguments[3], arguments[4], arguments[5], arguments[6], arguments[7], arguments[8]);
                    break;
                default:
                    m3fMat.set(0.);
                    break;
            }
            return m3fMat;
        }
        math.mat3 = mat3;
        ;
                                                                                                function mat4(fValue1, fValue2, fValue3, fValue4, fValue5, fValue6, fValue7, fValue8, fValue9, fValue10, fValue11, fValue12, fValue13, fValue14, fValue15, fValue16) {
            var nArgumentsLength = arguments.length;
            var m4fMat = math.Mat4.stack[math.Mat4.stackPosition++];
            if (math.Mat4.stackPosition == math.Mat4.stackSize) {
                math.Mat4.stackPosition = 0;
            }
            if (nArgumentsLength === 2) {
                if ((typeof (arguments[1]) === "boolean")) {
                    if (arguments[1]) {
                        m4fMat.data = arguments[0];
                    } else {
                        m4fMat.set(arguments[0]);
                    }
                } else {
                    m4fMat.set(arguments[0], arguments[1]);
                }
            } else {
                switch(nArgumentsLength) {
                    case 1:
                        if (arguments[0] instanceof math.Mat3) {
                            m4fMat.set(arguments[0], vec3(0.));
                        } else {
                            m4fMat.set(arguments[0]);
                        }
                        break;
                    case 4:
                        m4fMat.set(arguments[0], arguments[1], arguments[2], arguments[3]);
                        break;
                    case 16:
                        m4fMat.set(arguments[0], arguments[1], arguments[2], arguments[3], arguments[4], arguments[5], arguments[6], arguments[7], arguments[8], arguments[9], arguments[10], arguments[11], arguments[12], arguments[13], arguments[14], arguments[15]);
                        break;
                    default:
                        break;
                }
            }
            return m4fMat;
        }
        math.mat4 = mat4;
        ;
    })(akra.math || (akra.math = {}));
    var math = akra.math;
})(akra || (akra = {}));
var akra;
(function (akra) {
    akra.Vec2 = akra.math.Vec2;
    akra.Vec3 = akra.math.Vec3;
    akra.Vec4 = akra.math.Vec4;
    akra.Mat3 = akra.math.Mat3;
    akra.Mat4 = akra.math.Mat4;
    akra.Quat4 = akra.math.Quat4;
    akra.vec2 = akra.math.vec2;
    akra.vec3 = akra.math.vec3;
    akra.vec4 = akra.math.vec4;
    akra.quat4 = akra.math.quat4;
    akra.mat3 = akra.math.mat3;
    akra.mat4 = akra.math.mat4;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (geometry) {
        var Box = (function () {
            function Box(l, t, ff, r, b, bb) {
                if (typeof l === "undefined") { l = 0; }
                if (typeof t === "undefined") { t = 0; }
                if (typeof ff === "undefined") { ff = 0; }
                if (typeof r === "undefined") { r = 1; }
                if (typeof b === "undefined") { b = 1; }
                if (typeof bb === "undefined") { bb = 1; }
                this.left = 0;
                this.top = 0;
                this.front = 0;
                this.right = 0;
                this.bottom = 0;
                this.back = 0;
                switch(arguments.length) {
                    case 1:
                        this.left = arguments[0].left;
                        this.top = arguments[0].top;
                        this.front = arguments[0].front;
                        this.right = arguments[0].right;
                        this.bottom = arguments[0].bottom;
                        this.back = arguments[0].back;
                        break;
                    case 0:
                    case 3:
                    case 6:
                        this.left = l;
                        this.top = t;
                        this.front = ff;
                        this.right = r;
                        this.bottom = b;
                        this.back = bb;
                        break;
                    case 4:
                        this.left = l;
                        this.top = t;
                        this.right = ff;
                        this.bottom = r;
                        this.back = 1;
                        this.front = 0;
                        break;
                    case 5:
 {
                            akra.logger.setSourceLocation("geometry/Box.ts", 63);
                            akra.logger.error("invalid number of arguments");
                        }
                        ;
                }
 {
                    akra.logger.setSourceLocation("geometry/Box.ts", 66);
                    akra.logger.assert(this.right >= this.left && this.bottom >= this.top && this.back >= this.front);
                }
                ;
            }
            Object.defineProperty(Box.prototype, "width", {
                get: function () {
                    return this.right - this.left;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Box.prototype, "height", {
                get: function () {
                    return this.bottom - this.top;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Box.prototype, "depth", {
                get: function () {
                    return this.back - this.front;
                },
                enumerable: true,
                configurable: true
            });
            Box.prototype.contains = function (pDest) {
                return (pDest.left >= this.left && pDest.top >= this.top && pDest.front >= this.front && pDest.right <= this.right && pDest.bottom <= this.bottom && pDest.back <= this.back);
            };
            Box.prototype.setPosition = function (iLeft, iTop, iWidth, iHeight, iFront, iDepth) {
                if (typeof iFront === "undefined") { iFront = 0; }
                if (typeof iDepth === "undefined") { iDepth = 1; }
                this.left = iLeft;
                this.top = iTop;
                this.right = iLeft + iWidth;
                this.bottom = iTop + iHeight;
                this.front = iFront;
                this.back = iFront + iDepth;
            };
            Box.prototype.isEqual = function (pDest) {
                return (pDest.left == this.left && pDest.top == this.top && pDest.front == this.front && pDest.right == this.right && pDest.bottom == this.bottom && pDest.back == this.back);
            };
            Box.prototype.toString = function () {
                return "---------------------------\n" + "left: " + this.left + ", right: " + this.right + "\n" + "top: " + this.top + ", bottom: " + this.bottom + "\n" + "front: " + this.front + ", back: " + this.back + "\n" + "---------------------------";
            };
            return Box;
        })();
        geometry.Box = Box;        
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (pixelUtil) {
        var PixelBox = (function (_super) {
            __extends(PixelBox, _super);
            function PixelBox(iWidth, iHeight, iDepth, ePixelFormat, pPixelData) {
                if (typeof pPixelData === "undefined") { pPixelData = null; }
                if (arguments.length === 0) {
                                _super.call(this);
                    this.data = null;
                    this.format = akra.EPixelFormats.UNKNOWN;
                    this.setConsecutive();
                    return;
                }
                if (arguments.length >= 4) {
                                _super.call(this, 0, 0, 0, iWidth, iHeight, iDepth);
                    this.data = ((arguments[4]) !== undefined) ? (arguments[4]) : null;
                    this.format = arguments[3];
                } else {
                                _super.call(this, arguments[0]);
                    this.data = arguments[2];
                    this.format = arguments[1];
                }
                this.setConsecutive();
            }
            PixelBox.prototype.setConsecutive = function () {
                this.rowPitch = this.width;
                this.slicePitch = this.width * this.height;
            };
            PixelBox.prototype.getRowSkip = function () {
                return this.rowPitch - this.width;
            };
            PixelBox.prototype.getSliceSkip = function () {
                return this.slicePitch - (this.height * this.rowPitch);
            };
            PixelBox.prototype.isConsecutive = function () {
                return this.rowPitch == this.width && this.slicePitch == this.width * this.height;
            };
            PixelBox.prototype.getConsecutiveSize = function () {
                return pixelUtil.getMemorySize(this.width, this.height, this.depth, this.format);
            };
            PixelBox.prototype.getSubBox = function (pDest) {
                if (pixelUtil.isCompressed(this.format)) {
                    if (pDest.left == this.left && pDest.top == this.top && pDest.front == this.front && pDest.right == this.right && pDest.bottom == this.bottom && pDest.back == this.back) {
                        return this;
                    }
 {
                        akra.logger.setSourceLocation("PixelBox.ts", 69);
                        akra.logger.error("Cannot return subvolume of compressed PixelBuffer", "PixelBox::getSubVolume");
                    }
                    ;
                }
                if (!this.contains(pDest)) {
 {
                        akra.logger.setSourceLocation("PixelBox.ts", 74);
                        akra.logger.error("Bounds out of range", "PixelBox::getSubVolume");
                    }
                    ;
                }
                var elemSize = pixelUtil.getNumElemBytes(this.format);
                var rval = new PixelBox(pDest.width, pDest.height, pDest.depth, this.format, (this.data).subarray(((pDest.left - this.left) * elemSize) + ((pDest.top - this.top) * this.rowPitch * elemSize) + ((pDest.front - this.front) * this.slicePitch * elemSize)));
                rval.rowPitch = this.rowPitch;
                rval.slicePitch = this.slicePitch;
                rval.format = this.format;
                return rval;
            };
            PixelBox.prototype.getColorAt = function (pColor, x, y, z) {
                if (typeof z === "undefined") { z = 0; }
                var pixelSize = pixelUtil.getNumElemBytes(this.format);
                var pixelOffset = pixelSize * (z * this.slicePitch + y * this.rowPitch + x);
                pixelUtil.unpackColour(pColor, this.format, this.data.subarray(pixelOffset, pixelOffset + pixelSize));
                return pColor;
            };
            PixelBox.prototype.setColorAt = function (pColor, x, y, z) {
                if (typeof z === "undefined") { z = 0; }
                var pixelSize = pixelUtil.getNumElemBytes(this.format);
                var pixelOffset = pixelSize * (z * this.slicePitch + y * this.rowPitch + x);
                pixelUtil.packColour(pColor, this.format, this.data.subarray(pixelOffset, pixelOffset + pixelSize));
            };
            PixelBox.prototype.scale = function (pDest, eFilter) {
                if (typeof eFilter === "undefined") { eFilter = akra.EFilters.BILINEAR; }
                return false;
            };
            PixelBox.prototype.refresh = function (pExtents, ePixelFormat, pPixelData) {
                this.left = pExtents.left;
                this.top = pExtents.top;
                this.front = pExtents.front;
                this.right = pExtents.right;
                this.bottom = pExtents.bottom;
                this.back = pExtents.back;
                this.data = pPixelData;
                this.format = ePixelFormat;
                this.setConsecutive();
            };
            PixelBox.prototype.toString = function () {
                return "|---------------------------|\n" + _super.prototype.toString.call(this) + "\n" + "length: " + (this.data ? this.data.length : 0) + "\n" + "|---------------------------|";
            };
            return PixelBox;
        })(akra.geometry.Box);
        pixelUtil.PixelBox = PixelBox;        
    })(akra.pixelUtil || (akra.pixelUtil = {}));
    var pixelUtil = akra.pixelUtil;
})(akra || (akra = {}));
var akra;
(function (akra) {
    function fillPixelFormats(pData) {
        var pPixelFormats = [];
        for(var i = 0; i < pData.length; ++i) {
            var pEl = pData[i];
            pPixelFormats.push({
                name: pEl[0],
                elemBytes: pEl[1],
                flags: pEl[2],
                componentType: pEl[3],
                componentCount: pEl[4],
                rbits: pEl[5],
                gbits: pEl[6],
                bbits: pEl[7],
                abits: pEl[8],
                rmask: pEl[9],
                gmask: pEl[10],
                bmask: pEl[11],
                amask: pEl[12],
                rshift: pEl[13],
                gshift: pEl[14],
                bshift: pEl[15],
                ashift: pEl[16]
            });
        }
        return pPixelFormats;
    }
    var pPixelFormats = fillPixelFormats([
        [
            "PF_UNKNOWN", 
            0, 
            0, 
            akra.EPixelComponentTypes.BYTE, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_L8", 
            1, 
            akra.EPixelFormatFlags.LUMINANCE | akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            1, 
            8, 
            0, 
            0, 
            0, 
            0xFF, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_L16", 
            2, 
            akra.EPixelFormatFlags.LUMINANCE | akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.SHORT, 
            1, 
            16, 
            0, 
            0, 
            0, 
            0xFFFF, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_A8", 
            1, 
            akra.EPixelFormatFlags.HASALPHA | akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            1, 
            0, 
            0, 
            0, 
            8, 
            0, 
            0, 
            0, 
            0xFF, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_A4L4", 
            1, 
            akra.EPixelFormatFlags.HASALPHA | akra.EPixelFormatFlags.LUMINANCE | akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            2, 
            4, 
            0, 
            0, 
            4, 
            0x0F, 
            0, 
            0, 
            0xF0, 
            0, 
            0, 
            0, 
            4
        ], 
        [
            "PF_BYTE_LA", 
            2, 
            akra.EPixelFormatFlags.HASALPHA | akra.EPixelFormatFlags.LUMINANCE, 
            akra.EPixelComponentTypes.BYTE, 
            2, 
            8, 
            0, 
            0, 
            8, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_R5G6B5", 
            2, 
            akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            3, 
            5, 
            6, 
            5, 
            0, 
            0xF800, 
            0x07E0, 
            0x001F, 
            0, 
            11, 
            5, 
            0, 
            0
        ], 
        [
            "PF_B5G6R5", 
            2, 
            akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            3, 
            5, 
            6, 
            5, 
            0, 
            0x001F, 
            0x07E0, 
            0xF800, 
            0, 
            0, 
            5, 
            11, 
            0
        ], 
        [
            "PF_A4R4G4B4", 
            2, 
            akra.EPixelFormatFlags.HASALPHA | akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            4, 
            4, 
            4, 
            4, 
            0x0F00, 
            0x00F0, 
            0x000F, 
            0xF000, 
            8, 
            4, 
            0, 
            12
        ], 
        [
            "PF_A1R5G5B5", 
            2, 
            akra.EPixelFormatFlags.HASALPHA | akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            5, 
            5, 
            5, 
            1, 
            0x7C00, 
            0x03E0, 
            0x001F, 
            0x8000, 
            10, 
            5, 
            0, 
            15, 
            
        ], 
        [
            "PF_R8G8B8", 
            3, 
            akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            3, 
            8, 
            8, 
            8, 
            0, 
            0xFF0000, 
            0x00FF00, 
            0x0000FF, 
            0, 
            16, 
            8, 
            0, 
            0
        ], 
        [
            "PF_B8G8R8", 
            3, 
            akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            3, 
            8, 
            8, 
            8, 
            0, 
            0x0000FF, 
            0x00FF00, 
            0xFF0000, 
            0, 
            0, 
            8, 
            16, 
            0
        ], 
        [
            "PF_A8R8G8B8", 
            4, 
            akra.EPixelFormatFlags.HASALPHA | akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            8, 
            8, 
            8, 
            8, 
            0x00FF0000, 
            0x0000FF00, 
            0x000000FF, 
            0xFF000000, 
            16, 
            8, 
            0, 
            24
        ], 
        [
            "PF_A8B8G8R8", 
            4, 
            akra.EPixelFormatFlags.HASALPHA | akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            8, 
            8, 
            8, 
            8, 
            0x000000FF, 
            0x0000FF00, 
            0x00FF0000, 
            0xFF000000, 
            0, 
            8, 
            16, 
            24, 
            
        ], 
        [
            "PF_B8G8R8A8", 
            4, 
            akra.EPixelFormatFlags.HASALPHA | akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            8, 
            8, 
            8, 
            8, 
            0x0000FF00, 
            0x00FF0000, 
            0xFF000000, 
            0x000000FF, 
            8, 
            16, 
            24, 
            0
        ], 
        [
            "PF_A2R10G10B10", 
            4, 
            akra.EPixelFormatFlags.HASALPHA | akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            10, 
            10, 
            10, 
            2, 
            0x3FF00000, 
            0x000FFC00, 
            0x000003FF, 
            0xC0000000, 
            20, 
            10, 
            0, 
            30
        ], 
        [
            "PF_A2B10G10R10", 
            4, 
            akra.EPixelFormatFlags.HASALPHA | akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            10, 
            10, 
            10, 
            2, 
            0x000003FF, 
            0x000FFC00, 
            0x3FF00000, 
            0xC0000000, 
            0, 
            10, 
            20, 
            30
        ], 
        [
            "PF_DXT1", 
            0, 
            akra.EPixelFormatFlags.COMPRESSED | akra.EPixelFormatFlags.HASALPHA, 
            akra.EPixelComponentTypes.BYTE, 
            3, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_DXT2", 
            0, 
            akra.EPixelFormatFlags.COMPRESSED | akra.EPixelFormatFlags.HASALPHA, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_DXT3", 
            0, 
            akra.EPixelFormatFlags.COMPRESSED | akra.EPixelFormatFlags.HASALPHA, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_DXT4", 
            0, 
            akra.EPixelFormatFlags.COMPRESSED | akra.EPixelFormatFlags.HASALPHA, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_DXT5", 
            0, 
            akra.EPixelFormatFlags.COMPRESSED | akra.EPixelFormatFlags.HASALPHA, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_FLOAT16_RGB", 
            6, 
            akra.EPixelFormatFlags.FLOAT, 
            akra.EPixelComponentTypes.FLOAT16, 
            3, 
            16, 
            16, 
            16, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_FLOAT16_RGBA", 
            8, 
            akra.EPixelFormatFlags.FLOAT | akra.EPixelFormatFlags.HASALPHA, 
            akra.EPixelComponentTypes.FLOAT16, 
            4, 
            16, 
            16, 
            16, 
            16, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_FLOAT32_RGB", 
            12, 
            akra.EPixelFormatFlags.FLOAT, 
            akra.EPixelComponentTypes.FLOAT32, 
            3, 
            32, 
            32, 
            32, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_FLOAT32_RGBA", 
            16, 
            akra.EPixelFormatFlags.FLOAT | akra.EPixelFormatFlags.HASALPHA, 
            akra.EPixelComponentTypes.FLOAT32, 
            4, 
            32, 
            32, 
            32, 
            32, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_X8R8G8B8", 
            4, 
            akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            3, 
            8, 
            8, 
            8, 
            0, 
            0x00FF0000, 
            0x0000FF00, 
            0x000000FF, 
            0xFF000000, 
            16, 
            8, 
            0, 
            24
        ], 
        [
            "PF_X8B8G8R8", 
            4, 
            akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            3, 
            8, 
            8, 
            8, 
            0, 
            0x000000FF, 
            0x0000FF00, 
            0x00FF0000, 
            0xFF000000, 
            0, 
            8, 
            16, 
            24
        ], 
        [
            "PF_R8G8B8A8", 
            4, 
            akra.EPixelFormatFlags.HASALPHA | akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            8, 
            8, 
            8, 
            8, 
            0xFF000000, 
            0x00FF0000, 
            0x0000FF00, 
            0x000000FF, 
            24, 
            16, 
            8, 
            0
        ], 
        [
            "PF_FLOAT32_DEPTH", 
            4, 
            akra.EPixelFormatFlags.DEPTH, 
            akra.EPixelComponentTypes.FLOAT32, 
            1, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_SHORT_RGBA", 
            8, 
            akra.EPixelFormatFlags.HASALPHA, 
            akra.EPixelComponentTypes.SHORT, 
            4, 
            16, 
            16, 
            16, 
            16, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_R3G3B2", 
            1, 
            akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            3, 
            3, 
            3, 
            2, 
            0, 
            0xE0, 
            0x1C, 
            0x03, 
            0, 
            5, 
            2, 
            0, 
            0
        ], 
        [
            "PF_FLOAT16_R", 
            2, 
            akra.EPixelFormatFlags.FLOAT, 
            akra.EPixelComponentTypes.FLOAT16, 
            1, 
            16, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_FLOAT32_R", 
            4, 
            akra.EPixelFormatFlags.FLOAT, 
            akra.EPixelComponentTypes.FLOAT32, 
            1, 
            32, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_SHORT_GR", 
            4, 
            akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.SHORT, 
            2, 
            16, 
            16, 
            0, 
            0, 
            0x0000FFFF, 
            0xFFFF0000, 
            0, 
            0, 
            0, 
            16, 
            0, 
            0
        ], 
        [
            "PF_FLOAT16_GR", 
            4, 
            akra.EPixelFormatFlags.FLOAT, 
            akra.EPixelComponentTypes.FLOAT16, 
            2, 
            16, 
            16, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_FLOAT32_GR", 
            8, 
            akra.EPixelFormatFlags.FLOAT, 
            akra.EPixelComponentTypes.FLOAT32, 
            2, 
            32, 
            32, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_SHORT_RGB", 
            6, 
            0, 
            akra.EPixelComponentTypes.SHORT, 
            3, 
            16, 
            16, 
            16, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_PVRTC_RGB2", 
            0, 
            akra.EPixelFormatFlags.COMPRESSED, 
            akra.EPixelComponentTypes.BYTE, 
            3, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_PVRTC_RGBA2", 
            0, 
            akra.EPixelFormatFlags.COMPRESSED | akra.EPixelFormatFlags.HASALPHA, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_PVRTC_RGB4", 
            0, 
            akra.EPixelFormatFlags.COMPRESSED, 
            akra.EPixelComponentTypes.BYTE, 
            3, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_PVRTC_RGBA4", 
            0, 
            akra.EPixelFormatFlags.COMPRESSED | akra.EPixelFormatFlags.HASALPHA, 
            akra.EPixelComponentTypes.BYTE, 
            4, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_R8", 
            1, 
            akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            1, 
            8, 
            0, 
            0, 
            0, 
            0xFF0000, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_RG8", 
            2, 
            akra.EPixelFormatFlags.NATIVEENDIAN, 
            akra.EPixelComponentTypes.BYTE, 
            2, 
            8, 
            8, 
            0, 
            0, 
            0xFF0000, 
            0x00FF00, 
            0, 
            0, 
            8, 
            0, 
            0, 
            0
        ], 
        [
            "PF_DEPTH_BYTE", 
            1, 
            akra.EPixelFormatFlags.DEPTH, 
            akra.EPixelComponentTypes.BYTE, 
            1, 
            8, 
            0, 
            0, 
            0, 
            0xFF, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_DEPTH_SHORT", 
            2, 
            akra.EPixelFormatFlags.DEPTH, 
            akra.EPixelComponentTypes.SHORT, 
            1, 
            16, 
            0, 
            0, 
            0, 
            0xFFFF, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_DEPTH_INT", 
            4, 
            akra.EPixelFormatFlags.DEPTH, 
            akra.EPixelComponentTypes.INT, 
            1, 
            32, 
            0, 
            0, 
            0, 
            0xFFFFFFFF, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0, 
            0
        ], 
        [
            "PF_DEPTH24STENCIL8", 
            4, 
            akra.EPixelFormatFlags.DEPTH | akra.EPixelFormatFlags.STENCIL, 
            akra.EPixelComponentTypes.INT, 
            1, 
            24, 
            8, 
            0, 
            0, 
            0x00FFFFFF, 
            0xFF000000, 
            0, 
            0, 
            0, 
            24, 
            0, 
            0
        ], 
        
    ]);
    var _pColorValue = {
        r: 0.,
        g: 0.,
        b: 0.,
        a: 1.
    };
    (function (pixelUtil) {
        function getDescriptionFor(eFmt) {
            var ord = eFmt;
 {
                akra.logger.setSourceLocation("pixelUtil/pixelUtil.ts", 736);
                akra.logger.assert(ord >= 0 && ord < akra.EPixelFormats.TOTAL, "getDescriptionFor:" + ord);
            }
            ;
            return pPixelFormats[ord];
        }
        pixelUtil.getDescriptionFor = getDescriptionFor;
        function getNumElemBytes(eFormat) {
            return getDescriptionFor(eFormat).elemBytes;
        }
        pixelUtil.getNumElemBytes = getNumElemBytes;
        function getNumElemBits(eFormat) {
            return getDescriptionFor(eFormat).elemBytes * 8;
        }
        pixelUtil.getNumElemBits = getNumElemBits;
        function getMemorySize(iWidth, iHeight, iDepth, eFormat) {
            if (isCompressed(eFormat)) {
                switch(eFormat) {
                    case akra.EPixelFormats.DXT1:
                        return Math.floor((iWidth + 3) / 4) * Math.floor((iHeight + 3) / 4) * 8 * iDepth;
                    case akra.EPixelFormats.DXT2:
                    case akra.EPixelFormats.DXT3:
                    case akra.EPixelFormats.DXT4:
                    case akra.EPixelFormats.DXT5:
                        return Math.floor((iWidth + 3) / 4) * Math.floor((iHeight + 3) / 4) * 16 * iDepth;
                    case akra.EPixelFormats.PVRTC_RGB2:
                    case akra.EPixelFormats.PVRTC_RGBA2:
 {
                            akra.logger.setSourceLocation("pixelUtil/pixelUtil.ts", 798);
                            akra.logger.assert(iDepth == 1);
                        }
                        ;
                        return (akra.math.max(iWidth, 16) * akra.math.max(iHeight, 8) * 2 + 7) / 8;
                    case akra.EPixelFormats.PVRTC_RGB4:
                    case akra.EPixelFormats.PVRTC_RGBA4:
 {
                            akra.logger.setSourceLocation("pixelUtil/pixelUtil.ts", 802);
                            akra.logger.assert(iDepth == 1);
                        }
                        ;
                        return (akra.math.max(iWidth, 8) * akra.math.max(iHeight, 8) * 4 + 7) / 8;
                    default:
 {
                            akra.logger.setSourceLocation("pixelUtil/pixelUtil.ts", 805);
                            akra.logger.error("Invalid compressed pixel format", "PixelUtil::getMemorySize");
                        }
                        ;
                }
            } else {
                return iWidth * iHeight * iDepth * getNumElemBytes(eFormat);
            }
        }
        pixelUtil.getMemorySize = getMemorySize;
        function getFlags(eFormat) {
            return getDescriptionFor(eFormat).flags;
        }
        pixelUtil.getFlags = getFlags;
        function hasAlpha(eFormat) {
            return (getFlags(eFormat) & akra.EPixelFormatFlags.HASALPHA) > 0;
        }
        pixelUtil.hasAlpha = hasAlpha;
        function isFloatingPoint(eFormat) {
            return (getFlags(eFormat) & akra.EPixelFormatFlags.FLOAT) > 0;
        }
        pixelUtil.isFloatingPoint = isFloatingPoint;
        function isCompressed(eFormat) {
            return (getFlags(eFormat) & akra.EPixelFormatFlags.COMPRESSED) > 0;
        }
        pixelUtil.isCompressed = isCompressed;
        function isDepth(eFormat) {
            return (getFlags(eFormat) & akra.EPixelFormatFlags.DEPTH) > 0;
        }
        pixelUtil.isDepth = isDepth;
        function isNativeEndian(eFormat) {
            return (getFlags(eFormat) & akra.EPixelFormatFlags.NATIVEENDIAN) > 0;
        }
        pixelUtil.isNativeEndian = isNativeEndian;
        function isLuminance(eFormat) {
            return (getFlags(eFormat) & akra.EPixelFormatFlags.LUMINANCE) > 0;
        }
        pixelUtil.isLuminance = isLuminance;
        function isValidExtent(iWidth, iHeight, iDepth, eFormat) {
            if (isCompressed(eFormat)) {
                switch(eFormat) {
                    case akra.EPixelFormats.DXT1:
                    case akra.EPixelFormats.DXT2:
                    case akra.EPixelFormats.DXT3:
                    case akra.EPixelFormats.DXT4:
                    case akra.EPixelFormats.DXT5:
                        return ((iWidth & 3) == 0 && (iHeight & 3) == 0 && iDepth == 1);
                    default:
                        return true;
                }
            } else {
                return true;
            }
        }
        pixelUtil.isValidExtent = isValidExtent;
        function getBitDepths(eFormat) {
            var des = getDescriptionFor(eFormat);
            var rgba = [];
            rgba[0] = des.rbits;
            rgba[1] = des.gbits;
            rgba[2] = des.bbits;
            rgba[3] = des.abits;
            return rgba;
        }
        pixelUtil.getBitDepths = getBitDepths;
        function getBitMasks(eFormat) {
            var des = getDescriptionFor(eFormat);
            var rgba = [];
            rgba[0] = des.rmask;
            rgba[1] = des.gmask;
            rgba[2] = des.bmask;
            rgba[3] = des.amask;
            return rgba;
        }
        pixelUtil.getBitMasks = getBitMasks;
        function getBitShifts(eFormat) {
            var des = getDescriptionFor(eFormat);
            var rgba = [];
            rgba[0] = des.rshift;
            rgba[1] = des.gshift;
            rgba[2] = des.bshift;
            rgba[3] = des.ashift;
            return rgba;
        }
        pixelUtil.getBitShifts = getBitShifts;
        function getFormatName(eSrcFormat) {
            return getDescriptionFor(eSrcFormat).name;
        }
        pixelUtil.getFormatName = getFormatName;
        function isAccessible(eSrcFormat) {
            if (eSrcFormat == akra.EPixelFormats.UNKNOWN) {
                return false;
            }
            var flags = getFlags(eSrcFormat);
            return !((flags & akra.EPixelFormatFlags.COMPRESSED) || (flags & akra.EPixelFormatFlags.DEPTH));
        }
        pixelUtil.isAccessible = isAccessible;
        function getComponentType(eFmt) {
            return getDescriptionFor(eFmt).componentType;
        }
        pixelUtil.getComponentType = getComponentType;
        function getComponentCount(eFmt) {
            return getDescriptionFor(eFmt).componentCount;
        }
        pixelUtil.getComponentCount = getComponentCount;
        function getComponentTypeBits(eFormat) {
            var eType = getComponentType(eFormat);
            switch(eType) {
                case akra.EPixelComponentTypes.BYTE:
                    return 8;
                case akra.EPixelComponentTypes.SHORT:
                    return 16;
                case akra.EPixelComponentTypes.FLOAT16:
                    return 16;
                case akra.EPixelComponentTypes.FLOAT32:
                    return 32;
            }
            return 0;
        }
        pixelUtil.getComponentTypeBits = getComponentTypeBits;
        function getFormatFromName(sName, isAccessibleOnly, isCaseSensitive) {
            if (typeof isAccessibleOnly === "undefined") { isAccessibleOnly = false; }
            if (typeof isCaseSensitive === "undefined") { isCaseSensitive = false; }
            var tmp = sName;
            if (!isCaseSensitive) {
                tmp = tmp.toUpperCase();
            }
            for(var i = 0; i < akra.EPixelFormats.TOTAL; ++i) {
                var ePf = i;
                if (!isAccessibleOnly || isAccessible(ePf)) {
                    if (tmp == getFormatName(ePf)) {
                        return ePf;
                    }
                }
            }
            return akra.EPixelFormats.UNKNOWN;
        }
        pixelUtil.getFormatFromName = getFormatFromName;
        function getBNFExpressionOfPixelFormats(isAccessibleOnly) {
            if (typeof isAccessibleOnly === "undefined") { isAccessibleOnly = false; }
            var formatNames = new Array();
            for(var i = 0; i < akra.EPixelFormats.TOTAL; ++i) {
                var ePf = (i);
                if (!isAccessibleOnly || isAccessible(ePf)) {
                    var formatName = getFormatName(ePf);
                    formatNames.push({
                        first: formatName.length,
                        second: formatName
                    });
                }
            }
            var result = "";
            for(var j in formatNames) {
                if (!((result).length == 0)) {
                    result += " | ";
                }
                result += "'" + formatNames[j] + "'";
            }
            return result;
        }
        pixelUtil.getBNFExpressionOfPixelFormats = getBNFExpressionOfPixelFormats;
        function getFormatForBitDepths(eFmt, iIntegerBits, iFloatBits) {
            switch(iIntegerBits) {
                case 16:
                    switch(eFmt) {
                        case akra.EPixelFormats.R8G8B8:
                        case akra.EPixelFormats.X8R8G8B8:
                            return akra.EPixelFormats.R5G6B5;
                        case akra.EPixelFormats.B8G8R8:
                        case akra.EPixelFormats.X8B8G8R8:
                            return akra.EPixelFormats.B5G6R5;
                        case akra.EPixelFormats.A8R8G8B8:
                        case akra.EPixelFormats.R8G8B8A8:
                        case akra.EPixelFormats.A8B8G8R8:
                        case akra.EPixelFormats.B8G8R8A8:
                            return akra.EPixelFormats.A4R4G4B4;
                        case akra.EPixelFormats.A2R10G10B10:
                        case akra.EPixelFormats.A2B10G10R10:
                            return akra.EPixelFormats.A1R5G5B5;
                        default:
                            break;
                    }
                    break;
                case 32:
                    switch(eFmt) {
                        case akra.EPixelFormats.R5G6B5:
                            return akra.EPixelFormats.X8R8G8B8;
                        case akra.EPixelFormats.B5G6R5:
                            return akra.EPixelFormats.X8B8G8R8;
                        case akra.EPixelFormats.A4R4G4B4:
                            return akra.EPixelFormats.A8R8G8B8;
                        case akra.EPixelFormats.A1R5G5B5:
                            return akra.EPixelFormats.A2R10G10B10;
                        default:
                            break;
                    }
                    break;
                default:
                    break;
            }
            switch(iFloatBits) {
                case 16:
                    switch(eFmt) {
                        case akra.EPixelFormats.FLOAT32_R:
                            return akra.EPixelFormats.FLOAT16_R;
                        case akra.EPixelFormats.FLOAT32_RGB:
                            return akra.EPixelFormats.FLOAT16_RGB;
                        case akra.EPixelFormats.FLOAT32_RGBA:
                            return akra.EPixelFormats.FLOAT16_RGBA;
                        default:
                            break;
                    }
                    break;
                case 32:
                    switch(eFmt) {
                        case akra.EPixelFormats.FLOAT16_R:
                            return akra.EPixelFormats.FLOAT32_R;
                        case akra.EPixelFormats.FLOAT16_RGB:
                            return akra.EPixelFormats.FLOAT32_RGB;
                        case akra.EPixelFormats.FLOAT16_RGBA:
                            return akra.EPixelFormats.FLOAT32_RGBA;
                        default:
                            break;
                    }
                    break;
                default:
                    break;
            }
            return eFmt;
        }
        pixelUtil.getFormatForBitDepths = getFormatForBitDepths;
        function packColour(cColour, ePf, pDest) {
            packColourFloat(cColour.r, cColour.g, cColour.b, cColour.a, ePf, pDest);
        }
        pixelUtil.packColour = packColour;
        function packColourUint(r, g, b, a, ePf, pDest) {
            var des = getDescriptionFor(ePf);
            if (des.flags & akra.EPixelFormatFlags.NATIVEENDIAN) {
                var value = ((akra.bf.fixedToFixed(r, 8, des.rbits) << des.rshift) & des.rmask) | ((akra.bf.fixedToFixed(g, 8, des.gbits) << des.gshift) & des.gmask) | ((akra.bf.fixedToFixed(b, 8, des.bbits) << des.bshift) & des.bmask) | ((akra.bf.fixedToFixed(a, 8, des.abits) << des.ashift) & des.amask);
                akra.bf.intWrite(pDest, des.elemBytes, value);
            } else {
                packColourFloat(r / 255.0, g / 255.0, b / 255.0, a / 255.0, ePf, pDest);
            }
        }
        pixelUtil.packColourUint = packColourUint;
        function packColourFloat(r, g, b, a, ePf, pDest) {
            var des = getDescriptionFor(ePf);
            if (des.flags & akra.EPixelFormatFlags.NATIVEENDIAN) {
                var value = ((akra.bf.floatToFixed(r, des.rbits) << des.rshift) & des.rmask) | ((akra.bf.floatToFixed(g, des.gbits) << des.gshift) & des.gmask) | ((akra.bf.floatToFixed(b, des.bbits) << des.bshift) & des.bmask) | ((akra.bf.floatToFixed(a, des.abits) << des.ashift) & des.amask);
                akra.bf.intWrite(pDest, des.elemBytes, value);
            } else {
                switch(ePf) {
                    case akra.EPixelFormats.FLOAT32_R:
                        (new Float32Array(pDest.buffer, pDest.byteOffset, 1))[0] = r;
                        break;
                    case akra.EPixelFormats.FLOAT32_GR:
                        (new Float32Array(pDest.buffer, pDest.byteOffset, 1))[0] = g;
                        (new Float32Array(pDest.buffer, pDest.byteOffset, 2))[1] = r;
                        break;
                    case akra.EPixelFormats.FLOAT32_RGB:
                        (new Float32Array(pDest.buffer, pDest.byteOffset, 1))[0] = r;
                        (new Float32Array(pDest.buffer, pDest.byteOffset, 2))[1] = g;
                        (new Float32Array(pDest.buffer, pDest.byteOffset, 3))[2] = b;
                        break;
                    case akra.EPixelFormats.FLOAT32_RGBA:
                        (new Float32Array(pDest.buffer, pDest.byteOffset, 1))[0] = r;
                        (new Float32Array(pDest.buffer, pDest.byteOffset, 2))[1] = g;
                        (new Float32Array(pDest.buffer, pDest.byteOffset, 3))[2] = b;
                        (new Float32Array(pDest.buffer, pDest.byteOffset, 4))[3] = a;
                        break;
                    case akra.EPixelFormats.FLOAT16_R:
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 1))[0] = akra.bf.floatToHalf(r);
                        break;
                    case akra.EPixelFormats.FLOAT16_GR:
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 1))[0] = akra.bf.floatToHalf(g);
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 2))[1] = akra.bf.floatToHalf(r);
                        break;
                    case akra.EPixelFormats.FLOAT16_RGB:
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 1))[0] = akra.bf.floatToHalf(r);
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 2))[1] = akra.bf.floatToHalf(g);
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 3))[2] = akra.bf.floatToHalf(b);
                        break;
                    case akra.EPixelFormats.FLOAT16_RGBA:
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 1))[0] = akra.bf.floatToHalf(r);
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 2))[1] = akra.bf.floatToHalf(g);
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 3))[2] = akra.bf.floatToHalf(b);
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 4))[3] = akra.bf.floatToHalf(a);
                        break;
                    case akra.EPixelFormats.SHORT_RGB:
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 1))[0] = akra.bf.floatToFixed(r, 16);
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 2))[1] = akra.bf.floatToFixed(g, 16);
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 3))[2] = akra.bf.floatToFixed(b, 16);
                        break;
                    case akra.EPixelFormats.SHORT_RGBA:
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 1))[0] = akra.bf.floatToFixed(r, 16);
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 2))[1] = akra.bf.floatToFixed(g, 16);
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 3))[2] = akra.bf.floatToFixed(b, 16);
                        (new Uint16Array(pDest.buffer, pDest.byteOffset, 4))[3] = akra.bf.floatToFixed(a, 16);
                        break;
                    case akra.EPixelFormats.BYTE_LA:
                        pDest[0] = akra.bf.floatToFixed(r, 8);
                        pDest[1] = akra.bf.floatToFixed(a, 8);
                        break;
                    default:
 {
                            akra.logger.setSourceLocation("pixelUtil/pixelUtil.ts", 1249);
                            akra.logger.error("pack to " + getFormatName(ePf) + " not implemented", "PixelUtil::packColour");
                        }
                        ;
                        break;
                }
            }
        }
        pixelUtil.packColourFloat = packColourFloat;
        function unpackColour(cColour, ePf, pSrc) {
            unpackColourFloat(cColour, ePf, pSrc);
        }
        pixelUtil.unpackColour = unpackColour;
        function unpackColourUint(rgba, ePf, pSrc) {
            var des = getDescriptionFor(ePf);
            var r = 0, g = 0, b = 0, a = 0;
            if (des.flags & akra.EPixelFormatFlags.NATIVEENDIAN) {
                var value = akra.bf.intRead(pSrc, des.elemBytes);
                if (des.flags & akra.EPixelFormatFlags.LUMINANCE) {
                    r = g = b = akra.bf.fixedToFixed((value & des.rmask) >> des.rshift, des.rbits, 8);
                } else {
                    r = akra.bf.fixedToFixed((value & des.rmask) >> des.rshift, des.rbits, 8);
                    g = akra.bf.fixedToFixed((value & des.gmask) >> des.gshift, des.gbits, 8);
                    b = akra.bf.fixedToFixed((value & des.bmask) >> des.bshift, des.bbits, 8);
                }
                if (des.flags & akra.EPixelFormatFlags.HASALPHA) {
                    a = akra.bf.fixedToFixed((value & des.amask) >> des.ashift, des.abits, 8);
                } else {
                    a = 255;
                }
            } else {
                var pRGBA = _pColorValue;
                unpackColourFloat(pRGBA, ePf, pSrc);
                r = akra.bf.floatToFixed(pRGBA.r, 8);
                g = akra.bf.floatToFixed(pRGBA.g, 8);
                b = akra.bf.floatToFixed(pRGBA.b, 8);
                a = akra.bf.floatToFixed(pRGBA.a, 8);
            }
            rgba[0] = r;
            rgba[1] = g;
            rgba[2] = b;
            rgba[3] = a;
        }
        pixelUtil.unpackColourUint = unpackColourUint;
        function unpackColourFloat(rgba, ePf, pSrc) {
            var des = getDescriptionFor(ePf);
            var r = 0., g = 0., b = 0., a = 0.;
            if (des.flags & akra.EPixelFormatFlags.NATIVEENDIAN) {
                var value = akra.bf.intRead(pSrc, des.elemBytes);
                if (des.flags & akra.EPixelFormatFlags.LUMINANCE) {
                    r = g = b = akra.bf.fixedToFloat((value & des.rmask) >>> des.rshift, des.rbits);
                } else {
                    r = akra.bf.fixedToFloat((value & des.rmask) >>> des.rshift, des.rbits);
                    g = akra.bf.fixedToFloat((value & des.gmask) >>> des.gshift, des.gbits);
                    b = akra.bf.fixedToFloat((value & des.bmask) >>> des.bshift, des.bbits);
                }
                if (des.flags & akra.EPixelFormatFlags.HASALPHA) {
                    a = akra.bf.fixedToFloat((value & des.amask) >>> des.ashift, des.abits);
                } else {
                    a = 1.0;
                }
            } else {
                switch(ePf) {
                    case akra.EPixelFormats.FLOAT32_R:
                        r = g = b = (new Float32Array(pSrc.buffer, pSrc.byteOffset, 1))[0];
                        a = 1.0;
                        break;
                    case akra.EPixelFormats.FLOAT32_GR:
                        g = (new Float32Array(pSrc.buffer, pSrc.byteOffset, 1))[0];
                        r = b = (new Float32Array(pSrc.buffer, pSrc.byteOffset, 2))[1];
                        a = 1.0;
                        break;
                    case akra.EPixelFormats.FLOAT32_RGB:
                        r = (new Float32Array(pSrc.buffer, pSrc.byteOffset, 1))[0];
                        g = (new Float32Array(pSrc.buffer, pSrc.byteOffset, 2))[1];
                        b = (new Float32Array(pSrc.buffer, pSrc.byteOffset, 3))[2];
                        a = 1.0;
                        break;
                    case akra.EPixelFormats.FLOAT32_RGBA:
                        r = (new Float32Array(pSrc.buffer, pSrc.byteOffset, 1))[0];
                        g = (new Float32Array(pSrc.buffer, pSrc.byteOffset, 2))[1];
                        b = (new Float32Array(pSrc.buffer, pSrc.byteOffset, 3))[2];
                        a = (new Float32Array(pSrc.buffer, pSrc.byteOffset, 4))[3];
                        break;
                    case akra.EPixelFormats.FLOAT16_R:
                        r = g = b = akra.bf.halfToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 1))[0]);
                        a = 1.0;
                        break;
                    case akra.EPixelFormats.FLOAT16_GR:
                        g = akra.bf.halfToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 1))[0]);
                        r = b = akra.bf.halfToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 2))[1]);
                        a = 1.0;
                        break;
                    case akra.EPixelFormats.FLOAT16_RGB:
                        r = akra.bf.halfToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 1))[0]);
                        g = akra.bf.halfToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 1))[1]);
                        b = akra.bf.halfToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 2))[2]);
                        a = 1.0;
                        break;
                    case akra.EPixelFormats.FLOAT16_RGBA:
                        r = akra.bf.halfToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 1))[0]);
                        g = akra.bf.halfToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 2))[1]);
                        b = akra.bf.halfToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 3))[2]);
                        a = akra.bf.halfToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 4))[3]);
                        break;
                    case akra.EPixelFormats.SHORT_RGB:
                        r = akra.bf.fixedToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 1))[0], 16);
                        g = akra.bf.fixedToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 2))[1], 16);
                        b = akra.bf.fixedToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 3))[2], 16);
                        a = 1.0;
                        break;
                    case akra.EPixelFormats.SHORT_RGBA:
                        r = akra.bf.fixedToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 1))[0], 16);
                        g = akra.bf.fixedToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 2))[1], 16);
                        b = akra.bf.fixedToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 3))[2], 16);
                        a = akra.bf.fixedToFloat((new Uint16Array(pSrc.buffer, pSrc.byteOffset, 4))[3], 16);
                        break;
                    case akra.EPixelFormats.BYTE_LA:
                        r = g = b = akra.bf.fixedToFloat((pSrc)[0], 8);
                        a = akra.bf.fixedToFloat((pSrc)[1], 8);
                        break;
                    default:
 {
                            akra.logger.setSourceLocation("pixelUtil/pixelUtil.ts", 1420);
                            akra.logger.error("unpack from " + getFormatName(ePf) + " not implemented", "PixelUtil::unpackColour");
                        }
                        ;
                        break;
                }
            }
            rgba.r = r;
            rgba.g = g;
            rgba.b = b;
            rgba.a = a;
        }
        pixelUtil.unpackColourFloat = unpackColourFloat;
                        function bulkPixelConversion(pSrc, eSrcFormat, pDest, eDstFormat, iCount) {
            var src = null, dst = null;
            if (arguments.length > 2) {
                src = new pixelUtil.PixelBox(iCount, 1, 1, eSrcFormat, pSrc);
                dst = new pixelUtil.PixelBox(iCount, 1, 1, eDstFormat, pDest);
            } else {
                src = arguments[0];
                dst = arguments[1];
            }
            if (src.width !== dst.width || src.height !== dst.height || src.depth !== dst.depth) {
 {
                    akra.logger.setSourceLocation("pixelUtil/pixelUtil.ts", 1468);
                    akra.logger.criticalError("Size dest and src pictures is different");
                }
                ;
                return;
            }
            if (isCompressed(src.format) || isCompressed(dst.format)) {
                if (src.format == dst.format) {
                    dst.data.set(src.data.subarray(0, src.getConsecutiveSize()));
                    return;
                } else {
 {
                        akra.logger.setSourceLocation("pixelUtil/pixelUtil.ts", 1481);
                        akra.logger.error("This method can not be used to compress or decompress images", "PixelUtil::bulkPixelConversion");
                    }
                    ;
                }
            }
            if (src.format == dst.format) {
                if (src.isConsecutive() && dst.isConsecutive()) {
                    dst.data.set(src.data.subarray(0, src.getConsecutiveSize()));
                    return;
                }
                var srcPixelSize = getNumElemBytes(src.format);
                var dstPixelSize = getNumElemBytes(dst.format);
                var srcptr = src.data.subarray((src.left + src.top * src.rowPitch + src.front * src.slicePitch) * srcPixelSize);
                var dstptr = dst.data.subarray((dst.left + dst.top * dst.rowPitch + dst.front * dst.slicePitch) * dstPixelSize);
                var srcRowPitchBytes = src.rowPitch * srcPixelSize;
                var srcSliceSkipBytes = src.getSliceSkip() * srcPixelSize;
                var dstRowPitchBytes = dst.rowPitch * dstPixelSize;
                var dstSliceSkipBytes = dst.getSliceSkip() * dstPixelSize;
                var rowSize = src.width * srcPixelSize;
                for(var z = src.front; z < src.back; z++) {
                    for(var y = src.top; y < src.bottom; y++) {
                        try  {
                            dstptr.set(srcptr.subarray(0, rowSize));
                        } catch (e) {
 {
                                akra.logger.setSourceLocation("pixelUtil/pixelUtil.ts", 1521);
                                akra.logger.log(z, y, srcptr, dstptr, src, dst);
                            }
                            ;
                            throw e;
                        }
                        srcptr = srcptr.subarray(srcRowPitchBytes);
                        dstptr = dstptr.subarray(dstRowPitchBytes);
                    }
                    srcptr = srcptr.subarray(srcSliceSkipBytes);
                    dstptr = dstptr.subarray(dstSliceSkipBytes);
                }
                return;
            }
            if (dst.format == akra.EPixelFormats.X8R8G8B8 || dst.format == akra.EPixelFormats.X8B8G8R8) {
                var tempdst = dst;
                tempdst.format = (dst.format == akra.EPixelFormats.X8R8G8B8) ? akra.EPixelFormats.A8R8G8B8 : akra.EPixelFormats.A8B8G8R8;
                bulkPixelConversion(src, tempdst);
                return;
            }
            if ((src.format == akra.EPixelFormats.X8R8G8B8 || src.format == akra.EPixelFormats.X8B8G8R8) && !hasAlpha(dst.format)) {
                var tempsrc = src;
                tempsrc.format = src.format == akra.EPixelFormats.X8R8G8B8 ? akra.EPixelFormats.A8R8G8B8 : akra.EPixelFormats.A8B8G8R8;
                bulkPixelConversion(tempsrc, dst);
                return;
            }
            var srcPixelSize = getNumElemBytes(src.format);
            var dstPixelSize = getNumElemBytes(dst.format);
            var srcptr = src.data.subarray((src.left + src.top * src.rowPitch + src.front * src.slicePitch) * srcPixelSize);
            var dstptr = dst.data.subarray((dst.left + dst.top * dst.rowPitch + dst.front * dst.slicePitch) * dstPixelSize);
            var srcRowSkipBytes = src.getRowSkip() * srcPixelSize;
            var srcSliceSkipBytes = src.getSliceSkip() * srcPixelSize;
            var dstRowSkipBytes = dst.getRowSkip() * dstPixelSize;
            var dstSliceSkipBytes = dst.getSliceSkip() * dstPixelSize;
            var rgba = _pColorValue;
            for(var z = src.front; z < src.back; z++) {
                for(var y = src.top; y < src.bottom; y++) {
                    for(var x = src.left; x < src.right; x++) {
                        unpackColourFloat(rgba, src.format, srcptr);
                        packColourFloat(rgba.r, rgba.g, rgba.b, rgba.a, dst.format, dstptr);
                        srcptr = srcptr.subarray(srcPixelSize);
                        dstptr = dstptr.subarray(dstPixelSize);
                    }
                    srcptr = srcptr.subarray(srcRowSkipBytes);
                    dstptr = dstptr.subarray(dstRowSkipBytes);
                }
                srcptr = srcptr.subarray(srcSliceSkipBytes);
                dstptr = dstptr.subarray(dstSliceSkipBytes);
            }
        }
        pixelUtil.bulkPixelConversion = bulkPixelConversion;
        function calculateSizeForImage(nMipLevels, nFaces, iWidth, iHeight, iDepth, eFormat) {
            var iSize = 0;
            var mip = 0;
            for(mip = 0; mip <= nMipLevels; ++mip) {
                iSize += getMemorySize(iWidth, iHeight, iDepth, eFormat) * nFaces;
                if (iWidth !== 1) {
                    iWidth /= 2;
                }
                if (iHeight !== 1) {
                    iHeight /= 2;
                }
                if (iDepth !== 1) {
                    iDepth /= 2;
                }
            }
            return iSize;
        }
        pixelUtil.calculateSizeForImage = calculateSizeForImage;
    })(akra.pixelUtil || (akra.pixelUtil = {}));
    var pixelUtil = akra.pixelUtil;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        webgl.maxTextureSize = 0;
        webgl.maxCubeMapTextureSize = 0;
        webgl.maxViewPortSize = 0;
        webgl.maxTextureImageUnits = 0;
        webgl.maxVertexAttributes = 0;
        webgl.maxVertexTextureImageUnits = 0;
        webgl.maxCombinedTextureImageUnits = 0;
        webgl.maxColorAttachments = 1;
        webgl.stencilBits = 0;
        webgl.colorBits = [
            0, 
            0, 
            0
        ];
        webgl.alphaBits = 0;
        webgl.multisampleType = 0.;
        webgl.shaderVersion = 0;
        webgl.hasNonPowerOf2Textures = false;
        webgl.isANGLE = false;
        var isSupported = false;
        webgl.pSupportedExtensionList = null;
        function makeDebugContext(pWebGLContext) {
            if ((((window).WebGLDebugUtils) !== undefined)) {
                pWebGLContext = WebGLDebugUtils.makeDebugContext(pWebGLContext, function (err, funcName, args) {
 {
                        akra.logger.setSourceLocation("webgl/WebGL.ts", 54);
                        akra.logger.log(("\n" + (new Error()).stack.split("\n").slice(1).join("\n")));
                    }
                    ;
                    throw WebGLDebugUtils.glEnumToString(err) + " was caused by call to: " + funcName;
                }, function (funcName, args) {
 {
                        akra.logger.setSourceLocation("webgl/WebGL.ts", 58);
                        akra.logger.log("gl." + funcName + "(" + WebGLDebugUtils.glFunctionArgsToString(funcName, args) + ")");
                    }
                    ;
                });
            }
            return pWebGLContext;
        }
        function loadExtension(pWebGLContext, sExtName) {
            var pWebGLExtentionList = (pWebGLContext).extentionList = (pWebGLContext).extentionList || {};
            var pWebGLExtension;
            if (!hasExtension(sExtName)) {
 {
                    akra.logger.setSourceLocation("webgl/WebGL.ts", 70);
                    akra.logger.warning("Extension " + sExtName + " unsupported for this platform.");
                }
                ;
                return false;
            }
            if (pWebGLExtension = pWebGLContext.getExtension(sExtName)) {
                if (((pWebGLExtentionList[sExtName]) != null)) {
 {
                        akra.logger.setSourceLocation("webgl/WebGL.ts", 76);
                        akra.logger.log("Extension " + sExtName + " already loaded for this context.");
                    }
                    ;
                    return true;
                }
                pWebGLExtentionList[sExtName] = pWebGLExtension;
 {
                    akra.logger.setSourceLocation("webgl/WebGL.ts", 82);
                    akra.logger.log("loaded WebGL extension: ", sExtName);
                }
                ;
                for(var j in pWebGLExtension) {
                    if ((/*checked (origin: akra)>>*/akra.typeOf((pWebGLExtension[j])) === "function")) {
                        pWebGLContext[j] = function () {
                            pWebGLContext[j] = new Function("var t = this.extentionList[" + sExtName + "];" + "t." + j + ".apply(t, arguments);");
                        };
                    } else {
                        pWebGLContext[j] = pWebGLExtension[j];
                    }
                }
                return true;
            }
 {
                akra.logger.setSourceLocation("webgl/WebGL.ts", 103);
                akra.logger.warning("cannot load extension: ", sExtName);
            }
            ;
            return false;
        }
        webgl.loadExtension = loadExtension;
        function checkIsAngle(pWebGLContext) {
            var pProgram = pWebGLContext.createProgram();
            var sVertex = "            attribute vec3 pos;            struct S {              vec3 b[1];            };            uniform S s[1];            void main(void) {              float t = s[0].b[0].x;              gl_Position = vec4(pos, 1. + t);            }";
            var sFragment = "void main(void){}";
            var pVertexShader = pWebGLContext.createShader(0x8B31);
            var pFragmentShader = pWebGLContext.createShader(0x8B30);
            pWebGLContext.shaderSource(pVertexShader, sVertex);
            pWebGLContext.compileShader(pVertexShader);
            pWebGLContext.shaderSource(pFragmentShader, sFragment);
            pWebGLContext.compileShader(pFragmentShader);
            pWebGLContext.attachShader(pProgram, pVertexShader);
            pWebGLContext.attachShader(pProgram, pFragmentShader);
            pWebGLContext.linkProgram(pProgram);
            if (!pWebGLContext.getProgramParameter(pProgram, 0x8B82)) {
 {
                    akra.logger.setSourceLocation("webgl/WebGL.ts", 138);
                    akra.logger.error("cannot compile GLSL shader for ANGLE renderer");
                }
                ;
 {
                    akra.logger.setSourceLocation("webgl/WebGL.ts", 140);
                    akra.logger.log(pWebGLContext.getShaderInfoLog(pVertexShader));
                }
                ;
 {
                    akra.logger.setSourceLocation("webgl/WebGL.ts", 141);
                    akra.logger.log(pWebGLContext.getShaderSource(pVertexShader) || sVertex);
                }
                ;
 {
                    akra.logger.setSourceLocation("webgl/WebGL.ts", 143);
                    akra.logger.log(pWebGLContext.getShaderInfoLog(pFragmentShader));
                }
                ;
 {
                    akra.logger.setSourceLocation("webgl/WebGL.ts", 144);
                    akra.logger.log(pWebGLContext.getShaderSource(pFragmentShader) || sFragment);
                }
                ;
                return false;
            }
 {
                akra.logger.setSourceLocation("webgl/WebGL.ts", 150);
                akra.logger.assert(pWebGLContext.getProgramParameter(pProgram, 0x8B86) > 0, "no uniforms founded in angle test shader!");
            }
            ;
            return pWebGLContext.getActiveUniform(pProgram, 0).name != "s[0].b[0]";
        }
        function setupContext(pWebGLContext) {
            if (((/*checked (origin: webgl)>>*/akra.webgl.pSupportedExtensionList) === null)) {
                return pWebGLContext;
            }
            for(var i = 0; i < webgl.pSupportedExtensionList.length; ++i) {
                if (!loadExtension(pWebGLContext, webgl.pSupportedExtensionList[i])) {
                    webgl.pSupportedExtensionList.splice(i, 1);
                }
            }
            return pWebGLContext;
        }
        webgl.isEnabled = /** @inline */function () {
            return isSupported;
        };
        function createContext(pCanvas, pOptions) {
            if (typeof pCanvas === "undefined") { pCanvas = document.createElement("canvas"); }
            var pWebGLContext = null;
            try  {
                pWebGLContext = pCanvas.getContext("webgl", pOptions) || pCanvas.getContext("experimental-webgl", pOptions);
            } catch (e) {
            }
            if (((pWebGLContext) != null)) {
                return makeDebugContext(setupContext(pWebGLContext));
            }
 {
                akra.logger.setSourceLocation("webgl/WebGL.ts", 192);
                akra.logger.warning("cannot get 3d device");
            }
            ;
            return null;
        }
        webgl.createContext = createContext;
        (function (pWebGLContext) {
            if (!pWebGLContext) {
                return;
            }
            webgl.maxTextureSize = pWebGLContext.getParameter(0x0D33);
            webgl.maxCubeMapTextureSize = pWebGLContext.getParameter(0x851C);
            webgl.maxViewPortSize = pWebGLContext.getParameter(0x0D3A);
            webgl.maxTextureImageUnits = pWebGLContext.getParameter(0x8872);
            webgl.maxVertexAttributes = pWebGLContext.getParameter(0x8869);
            webgl.maxVertexTextureImageUnits = pWebGLContext.getParameter(0x8B4C);
            webgl.maxCombinedTextureImageUnits = pWebGLContext.getParameter(0x8B4D);
            webgl.stencilBits = pWebGLContext.getParameter(0x0D57);
            webgl.colorBits = [
                pWebGLContext.getParameter(0x0D52), 
                pWebGLContext.getParameter(0x0D53), 
                pWebGLContext.getParameter(0x0D54)
            ];
            webgl.alphaBits = pWebGLContext.getParameter(0x0D55);
            webgl.multisampleType = pWebGLContext.getParameter(0x80AA);
            webgl.pSupportedExtensionList = pWebGLContext.getSupportedExtensions();
            isSupported = true;
            webgl.isANGLE = checkIsAngle(pWebGLContext);
        })(createContext());
        function hasExtension(sExtName) {
            for(var i = 0; i < webgl.pSupportedExtensionList.length; ++i) {
                if (webgl.pSupportedExtensionList[i].search(sExtName) != -1) {
                    return true;
                }
            }
            return false;
        }
        webgl.hasExtension = hasExtension;
        function getWebGLUsage(iFlags) {
            if ((((iFlags) & (akra.EHardwareBufferFlags.DYNAMIC)) != 0)) {
                return 0x88E8;
            } else if ((((iFlags) & (akra.EHardwareBufferFlags.STREAM)) != 0)) {
                return 0x88E0;
            }
            return 0x88E4;
        }
        webgl.getWebGLUsage = getWebGLUsage;
        function getWebGLFormat(eFormat) {
            switch(eFormat) {
                case akra.EPixelFormats.L8:
                case akra.EPixelFormats.L16:
                    return 0x1909;
                case akra.EPixelFormats.A8:
                    return 0x1906;
                case akra.EPixelFormats.A4L4:
                case akra.EPixelFormats.BYTE_LA:
                    return 0x190A;
                case akra.EPixelFormats.R5G6B5:
                    return 0;
                case akra.EPixelFormats.B5G6R5:
                    return 0x1907;
                case akra.EPixelFormats.R3G3B2:
                    return 0;
                case akra.EPixelFormats.A4R4G4B4:
                case akra.EPixelFormats.A1R5G5B5:
                    return 0x1908;
                case akra.EPixelFormats.R8G8B8:
                case akra.EPixelFormats.B8G8R8:
                    return 0x1907;
                case akra.EPixelFormats.A8R8G8B8:
                case akra.EPixelFormats.A8B8G8R8:
                    return 0x1908;
                case akra.EPixelFormats.B8G8R8A8:
                case akra.EPixelFormats.R8G8B8A8:
                case akra.EPixelFormats.X8R8G8B8:
                case akra.EPixelFormats.X8B8G8R8:
                    return 0x1908;
                case akra.EPixelFormats.A2R10G10B10:
                    return 0;
                case akra.EPixelFormats.A2B10G10R10:
                    return 0x1908;
                case akra.EPixelFormats.DXT1:
                    return 0x83F1;
                case akra.EPixelFormats.DXT2:
                    return 0;
                case akra.EPixelFormats.DXT3:
                    return 0x83F2;
                case akra.EPixelFormats.DXT4:
                    return 0;
                case akra.EPixelFormats.DXT5:
                    return 0x83F3;
                case akra.EPixelFormats.FLOAT16_R:
                    return 0;
                case akra.EPixelFormats.FLOAT16_RGB:
                    return 0x1907;
                case akra.EPixelFormats.FLOAT16_RGBA:
                    return 0x1908;
                case akra.EPixelFormats.FLOAT32_R:
                    return 0;
                case akra.EPixelFormats.FLOAT32_RGB:
                    return 0x1907;
                case akra.EPixelFormats.FLOAT32_RGBA:
                    return 0x1908;
                case akra.EPixelFormats.FLOAT16_GR:
                case akra.EPixelFormats.FLOAT32_GR:
                    return 0;
                case akra.EPixelFormats.FLOAT32_DEPTH:
                case akra.EPixelFormats.DEPTH32:
                case akra.EPixelFormats.DEPTH16:
                case akra.EPixelFormats.DEPTH8:
                    return 0x1902;
                case akra.EPixelFormats.DEPTH24STENCIL8:
                    return 0x84F9;
                case akra.EPixelFormats.SHORT_RGBA:
                    return 0x1908;
                case akra.EPixelFormats.SHORT_GR:
                    return 0;
                case akra.EPixelFormats.SHORT_RGB:
                    return 0x1907;
                case akra.EPixelFormats.PVRTC_RGB2:
                    return 0x8C01;
                case akra.EPixelFormats.PVRTC_RGBA2:
                    return 0x8C03;
                case akra.EPixelFormats.PVRTC_RGB4:
                    return 0x8C00;
                case akra.EPixelFormats.PVRTC_RGBA4:
                    return 0x8C02;
                case akra.EPixelFormats.R8:
                case akra.EPixelFormats.RG8:
                    return 0;
                default:
 {
                        akra.logger.setSourceLocation("webgl/WebGL.ts", 356);
                        akra.logger.warning("getWebGLFormat unknown format", eFormat);
                    }
                    ;
                    return 0;
            }
        }
        webgl.getWebGLFormat = getWebGLFormat;
        function isWebGLFormatSupport(eFormat) {
            switch(eFormat) {
                case akra.EPixelFormats.DXT1:
                case akra.EPixelFormats.DXT3:
                case akra.EPixelFormats.DXT5:
                    return webgl.hasExtension("WEBGL_compressed_texture_s3tc");
                case akra.EPixelFormats.PVRTC_RGB2:
                case akra.EPixelFormats.PVRTC_RGBA2:
                case akra.EPixelFormats.PVRTC_RGB4:
                case akra.EPixelFormats.PVRTC_RGBA4:
                    return webgl.hasExtension("WEBGL_compressed_texture_pvrtc");
                case akra.EPixelFormats.DEPTH32:
                case akra.EPixelFormats.DEPTH16:
                case akra.EPixelFormats.DEPTH24STENCIL8:
                    return webgl.hasExtension("WEBGL_depth_texture");
                case akra.EPixelFormats.DEPTH32:
                case akra.EPixelFormats.DEPTH16:
                case akra.EPixelFormats.DEPTH24STENCIL8:
                    return webgl.hasExtension("WEBGL_depth_texture");
                case akra.EPixelFormats.FLOAT16_RGB:
                case akra.EPixelFormats.FLOAT16_RGBA:
                    return webgl.hasExtension("OES_texture_half_float");
                case akra.EPixelFormats.FLOAT32_RGB:
                case akra.EPixelFormats.FLOAT32_RGBA:
                    return webgl.hasExtension("OES_texture_float");
            }
            if (getWebGLFormat(eFormat) && getWebGLDataType(eFormat)) {
                switch(eFormat) {
                    case akra.EPixelFormats.FLOAT32_DEPTH:
                    case akra.EPixelFormats.L16:
                        return false;
                }
                return true;
            }
            return false;
        }
        webgl.isWebGLFormatSupport = isWebGLFormatSupport;
        function getWebGLDataType(eFormat) {
            switch(eFormat) {
                case akra.EPixelFormats.L8:
                    return 0x1401;
                case akra.EPixelFormats.L16:
                    return 0x1403;
                case akra.EPixelFormats.A8:
                    return 0x1401;
                case akra.EPixelFormats.A4L4:
                    return 0;
                case akra.EPixelFormats.BYTE_LA:
                    return 0x1401;
                case akra.EPixelFormats.R5G6B5:
                case akra.EPixelFormats.B5G6R5:
                    return 0x8363;
                case akra.EPixelFormats.R3G3B2:
                    return 0;
                case akra.EPixelFormats.A4R4G4B4:
                    return 0x8033;
                case akra.EPixelFormats.A1R5G5B5:
                    return 0x8034;
                case akra.EPixelFormats.R8G8B8:
                case akra.EPixelFormats.B8G8R8:
                case akra.EPixelFormats.A8R8G8B8:
                case akra.EPixelFormats.A8B8G8R8:
                case akra.EPixelFormats.B8G8R8A8:
                case akra.EPixelFormats.R8G8B8A8:
                case akra.EPixelFormats.X8R8G8B8:
                case akra.EPixelFormats.X8B8G8R8:
                    return 0x1401;
                case akra.EPixelFormats.A2R10G10B10:
                    return 0;
                case akra.EPixelFormats.A2B10G10R10:
                    return 0;
                case akra.EPixelFormats.DXT1:
                case akra.EPixelFormats.DXT2:
                case akra.EPixelFormats.DXT3:
                case akra.EPixelFormats.DXT4:
                case akra.EPixelFormats.DXT5:
                    return 0;
                case akra.EPixelFormats.FLOAT16_R:
                case akra.EPixelFormats.FLOAT16_RGB:
                case akra.EPixelFormats.FLOAT16_RGBA:
                    return 0x8D61;
                case akra.EPixelFormats.FLOAT32_R:
                case akra.EPixelFormats.FLOAT32_RGB:
                case akra.EPixelFormats.FLOAT32_RGBA:
                case akra.EPixelFormats.FLOAT16_GR:
                case akra.EPixelFormats.FLOAT32_GR:
                    return 0x1406;
                case akra.EPixelFormats.FLOAT32_DEPTH:
                    return 0x1406;
                case akra.EPixelFormats.DEPTH8:
                    return 0x1401;
                case akra.EPixelFormats.DEPTH16:
                    return 0x1403;
                case akra.EPixelFormats.DEPTH32:
                    return 0x1405;
                case akra.EPixelFormats.DEPTH24STENCIL8:
                    return 0x8367;
                case akra.EPixelFormats.SHORT_RGBA:
                case akra.EPixelFormats.SHORT_GR:
                case akra.EPixelFormats.SHORT_RGB:
                    return 0x1403;
                case akra.EPixelFormats.PVRTC_RGB2:
                case akra.EPixelFormats.PVRTC_RGBA2:
                case akra.EPixelFormats.PVRTC_RGB4:
                case akra.EPixelFormats.PVRTC_RGBA4:
                    return 0;
                case akra.EPixelFormats.R8:
                case akra.EPixelFormats.RG8:
                    return 0x1401;
                default:
 {
                        akra.logger.setSourceLocation("webgl/WebGL.ts", 495);
                        akra.logger.criticalError("getWebGLFormat unknown format");
                    }
                    ;
                    return 0;
            }
        }
        webgl.getWebGLDataType = getWebGLDataType;
        function getWebGLInternalFormat(eFormat) {
            if (!akra.pixelUtil.isCompressed(eFormat)) {
                return getWebGLFormat(eFormat);
            } else {
                switch(eFormat) {
                    case akra.EPixelFormats.DXT1:
                        return 0x83F1;
                    case akra.EPixelFormats.DXT2:
                        return 0;
                    case akra.EPixelFormats.DXT3:
                        return 0x83F2;
                    case akra.EPixelFormats.DXT4:
                        return 0;
                    case akra.EPixelFormats.DXT5:
                        return 0x83F3;
                    case akra.EPixelFormats.PVRTC_RGB2:
                        return 0x8C01;
                    case akra.EPixelFormats.PVRTC_RGBA2:
                        return 0x8C03;
                    case akra.EPixelFormats.PVRTC_RGB4:
                        return 0x8C00;
                    case akra.EPixelFormats.PVRTC_RGBA4:
                        return 0x8C02;
                }
            }
        }
        webgl.getWebGLInternalFormat = getWebGLInternalFormat;
        function getWebGLPrimitiveType(eType) {
            switch(eType) {
                case akra.EPrimitiveTypes.POINTLIST:
                    return 0x0000;
                case akra.EPrimitiveTypes.LINELIST:
                    return 0x0001;
                case akra.EPrimitiveTypes.LINELOOP:
                    return 0x0002;
                case akra.EPrimitiveTypes.LINESTRIP:
                    return 0x0003;
                case akra.EPrimitiveTypes.TRIANGLELIST:
                    return 0x0004;
                case akra.EPrimitiveTypes.TRIANGLESTRIP:
                    return 0x0005;
                case akra.EPrimitiveTypes.TRIANGLEFAN:
                    return 0x0006;
            }
            return 0x0000;
        }
        webgl.getWebGLPrimitiveType = getWebGLPrimitiveType;
        function getClosestWebGLInternalFormat(eFormat, isHWGamma) {
            if (typeof isHWGamma === "undefined") { isHWGamma = false; }
            var iGLFormat = webgl.getWebGLInternalFormat(eFormat);
            if (iGLFormat === 0) {
                if (isHWGamma) {
                    return 0;
                } else {
                    return 0x1908;
                }
            } else {
                return iGLFormat;
            }
        }
        webgl.getClosestWebGLInternalFormat = getClosestWebGLInternalFormat;
        function getClosestAkraFormat(iGLFormat, iGLDataType) {
            switch(iGLFormat) {
                case 0x8C01:
                    return webgl.hasExtension("WEBGL_compressed_texture_pvrtc") ? akra.EPixelFormats.PVRTC_RGB2 : akra.EPixelFormats.A8R8G8B8;
                case 0x8C03:
                    return webgl.hasExtension("WEBGL_compressed_texture_pvrtc") ? akra.EPixelFormats.PVRTC_RGBA2 : akra.EPixelFormats.A8R8G8B8;
                case 0x8C00:
                    return webgl.hasExtension("WEBGL_compressed_texture_pvrtc") ? akra.EPixelFormats.PVRTC_RGB4 : akra.EPixelFormats.A8R8G8B8;
                case 0x8C02:
                    return webgl.hasExtension("WEBGL_compressed_texture_pvrtc") ? akra.EPixelFormats.PVRTC_RGBA4 : akra.EPixelFormats.A8R8G8B8;
                case 0x1909:
                    return akra.EPixelFormats.L8;
                case 0x1906:
                    return akra.EPixelFormats.A8;
                case 0x190A:
                    return akra.EPixelFormats.BYTE_LA;
                case 0x1907:
                    switch(iGLDataType) {
                        case 0x8363:
                            return akra.EPixelFormats.B5G6R5;
                        default:
                            return akra.EPixelFormats.R8G8B8;
                    }
                case 0x1908:
                    switch(iGLDataType) {
                        case 0x8034:
                            return akra.EPixelFormats.A1R5G5B5;
                        case 0x8033:
                            return akra.EPixelFormats.A4R4G4B4;
                        case 0x1406:
                            return akra.EPixelFormats.FLOAT32_RGBA;
                        default:
                            return akra.EPixelFormats.A8B8G8R8;
                    }
                case 0x80E1:
                    return akra.EPixelFormats.A8B8G8R8;
                case 0x83F0:
                case 0x83F1:
                    return webgl.hasExtension("WEBGL_compressed_texture_s3tc") ? akra.EPixelFormats.DXT1 : akra.EPixelFormats.A8R8G8B8;
                case 0x83F2:
                    return webgl.hasExtension("WEBGL_compressed_texture_s3tc") ? akra.EPixelFormats.DXT3 : akra.EPixelFormats.A8R8G8B8;
                case 0x83F3:
                    return webgl.hasExtension("WEBGL_compressed_texture_s3tc") ? akra.EPixelFormats.DXT5 : akra.EPixelFormats.A8R8G8B8;
                case 0x8229:
                    return webgl.hasExtension("EXT_texture_rg") ? akra.EPixelFormats.R8 : akra.EPixelFormats.A8R8G8B8;
                case 0x822B:
                    return webgl.hasExtension("EXT_texture_rg") ? akra.EPixelFormats.RG8 : akra.EPixelFormats.A8R8G8B8;
                case 0x1902:
                    switch(iGLDataType) {
                        case 0x1406:
                            return akra.EPixelFormats.FLOAT32_DEPTH;
                        case 0x1405:
                            return akra.EPixelFormats.DEPTH32;
                        case 0x1403:
                            return akra.EPixelFormats.DEPTH16;
                        case 0x1401:
                            return akra.EPixelFormats.DEPTH8;
                    }
                case 0x84F9:
                    return akra.EPixelFormats.DEPTH24STENCIL8;
                default:
                    return akra.EPixelFormats.A8R8G8B8;
            }
        }
        webgl.getClosestAkraFormat = getClosestAkraFormat;
        function optionalPO2(iValue) {
            if (webgl.hasNonPowerOf2Textures) {
                return iValue;
            } else {
                return akra.math.ceilingPowerOfTwo(iValue);
            }
        }
        webgl.optionalPO2 = optionalPO2;
        function convertToWebGLformat(pSource, pDest) {
            if (pDest.format == akra.EPixelFormats.A4R4G4B4) {
                var iSrcPtr = (pSource.left + pSource.top * pSource.rowPitch + pSource.front * pSource.slicePitch);
                var iDstPtr = (pDest.left + pDest.top * pDest.rowPitch + pDest.front * pDest.slicePitch);
                var iSrcSliceSkip = pSource.getSliceSkip();
                var iDstSliceSkip = pDest.getSliceSkip();
                var k = pSource.right - pSource.left;
                var x = 0, y = 0, z = 0;
                for(z = pSource.front; z < pSource.back; z++) {
                    for(y = pSource.top; y < pSource.bottom; y++) {
                        for(x = 0; x < k; x++) {
                            pDest[iDstPtr + x] = ((pSource[iSrcPtr + x] & 0x000F) << 12) | ((pSource[iSrcPtr + x] & 0x00F0) << 4) | ((pSource[iSrcPtr + x] & 0x0F00) >> 4) | ((pSource[iSrcPtr + x] & 0xF000) >> 12);
                        }
                        iSrcPtr += pSource.rowPitch;
                        iDstPtr += pDest.rowPitch;
                    }
                    iSrcPtr += iSrcSliceSkip;
                    iDstPtr += iDstSliceSkip;
                }
            }
        }
        webgl.convertToWebGLformat = convertToWebGLformat;
        function checkFBOAttachmentFormat(eFormat) {
            if (eFormat == akra.EPixelFormats.A8B8G8R8) {
                return true;
            } else if (eFormat == akra.EPixelFormats.FLOAT32_RGBA) {
                return hasExtension("WEBGL_color_buffer_float");
            } else if (eFormat == akra.EPixelFormats.FLOAT16_RGBA) {
                return hasExtension("EXT_color_buffer_half_float");
            } else if (eFormat === akra.EPixelFormats.DEPTH32) {
                return true;
            } else {
                return false;
            }
        }
        webgl.checkFBOAttachmentFormat = checkFBOAttachmentFormat;
        function checkReadPixelFormat(eFormat) {
            if (eFormat == akra.EPixelFormats.A8B8G8R8) {
                return true;
            } else if (eFormat == akra.EPixelFormats.FLOAT32_RGBA) {
                return hasExtension("WEBGL_color_buffer_float") || hasExtension("EXT_color_buffer_half_float");
            } else {
                return false;
            }
        }
        webgl.checkReadPixelFormat = checkReadPixelFormat;
        function getSupportedAlternative(eFormat) {
            if (checkFBOAttachmentFormat(eFormat)) {
                return eFormat;
            }
            var pct = akra.pixelUtil.getComponentType(eFormat);
            switch(pct) {
                case akra.EPixelComponentTypes.BYTE:
                    eFormat = akra.EPixelFormats.A8R8G8B8;
                    break;
                case akra.EPixelComponentTypes.SHORT:
                    eFormat = akra.EPixelFormats.SHORT_RGBA;
                    break;
                case akra.EPixelComponentTypes.FLOAT16:
                    eFormat = akra.EPixelFormats.FLOAT16_RGBA;
                    break;
                case akra.EPixelComponentTypes.FLOAT32:
                    eFormat = akra.EPixelFormats.FLOAT32_RGBA;
                    break;
                case akra.EPixelComponentTypes.COUNT:
                default:
                    break;
            }
            if (checkFBOAttachmentFormat(eFormat)) {
                return eFormat;
            }
            return akra.EPixelFormats.A8R8G8B8;
        }
        webgl.getSupportedAlternative = getSupportedAlternative;
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        var ApiInfo = (function (_super) {
            __extends(ApiInfo, _super);
            function ApiInfo() {
                        _super.call(this);
                this.bWebGL = false;
                this.bWebAudio = false;
                this.bFile = false;
                this.bFileSystem = false;
                this.bWebWorker = false;
                this.bTransferableObjects = false;
                this.bLocalStorage = false;
                this.bWebSocket = false;
                this.bGamepad = false;
                var pApi = {};
                this.bWebAudio = ((window).AudioContext && (window).webkitAudioContext ? true : false);
                this.bFile = ((window).File && (window).FileReader && (window).FileList && (window).Blob ? true : false);
                this.bFileSystem = (this.bFile && (window).URL && (window).requestFileSystem ? true : false);
                this.bWebWorker = (((window).Worker) !== undefined);
                this.bLocalStorage = (((window).localStorage) !== undefined);
                this.bWebSocket = (((window).WebSocket) !== undefined);
                this.bGamepad = !!(navigator).webkitGetGamepads || !!(navigator).webkitGamepads || (navigator.userAgent.indexOf('Firefox/') != -1);
            }
            Object.defineProperty(ApiInfo.prototype, "webGL", {
                get: function () {
                    return (isSupported);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ApiInfo.prototype, "transferableObjects", {
                get: function () {
                    if (!this.bTransferableObjects) {
                        this.bTransferableObjects = (this.bWebWorker && this.chechTransferableObjects() ? true : false);
                    }
                    return this.bTransferableObjects;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ApiInfo.prototype, "file", {
                get: function () {
                    return this.bFile;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ApiInfo.prototype, "fileSystem", {
                get: function () {
                    return this.bFileSystem;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ApiInfo.prototype, "webAudio", {
                get: function () {
                    return this.bWebAudio;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ApiInfo.prototype, "webWorker", {
                get: function () {
                    return this.bWebWorker;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ApiInfo.prototype, "localStorage", {
                get: function () {
                    return this.bLocalStorage;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ApiInfo.prototype, "webSocket", {
                get: function () {
                    return this.bWebSocket;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ApiInfo.prototype, "gamepad", {
                get: function () {
                    return this.bGamepad;
                },
                enumerable: true,
                configurable: true
            });
            ApiInfo.prototype.chechTransferableObjects = function () {
                var pBlob = new Blob([
                    "onmessage = function(e) { postMessage(true); }"
                ], {
                    "type": "text\/javascript"
                });
                var sBlobURL = (window).URL.createObjectURL(pBlob);
                var pWorker = new Worker(sBlobURL);
                var pBuffer = new ArrayBuffer(1);
                try  {
                    pWorker.postMessage(pBuffer, [
                        pBuffer
                    ]);
                } catch (e) {
 {
                        util.logger.setSourceLocation("util/ApiInfo.ts", 85);
                        util.logger.log('transferable objects not supported in your browser...');
                    }
                    ;
                }
                pWorker.terminate();
                if (pBuffer.byteLength) {
                    return false;
                }
                return true;
            };
            return ApiInfo;
        })(util.Singleton);
        util.ApiInfo = ApiInfo;        
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (info) {
                        function canvas(id) {
            var pCanvas = (typeof (id) === "string") ? document.getElementById(id) : id;
            return {
                width: (typeof (pCanvas.width) === "number") ? pCanvas.width : parseInt(pCanvas.style.width),
                height: (typeof (pCanvas.height) === "number") ? pCanvas.height : parseInt(pCanvas.style.height),
                id: pCanvas.id
            };
        }
        info.canvas = canvas;
        info.browser = new akra.util.BrowserInfo();
        info.api = new akra.util.ApiInfo();
        info.screen = new akra.util.ScreenInfo();
        info.uri = (new /*checked (origin: akra)>>*/akra.util.URI((document.location.href)));
        var is;
        (function (is) {
            is.online;
            is.mobile = (/mobile|iphone|ipad|ipod|android|blackberry|mini|windows\sce|palm/i).test(navigator.userAgent.toLowerCase());
            is.linux = info.browser.os === 'Linux';
            is.windows = info.browser.os === 'Windows';
            is.mac = info.browser.os === 'Mac';
            is.iPhone = info.browser.os === 'iPhone';
        })(is || (is = {}));
        Object.defineProperty(is, 'online', {
            get: function () {
                return navigator.onLine;
            }
        });
    })(akra.info || (akra.info = {}));
    var info = akra.info;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        (function (EThreadStatuses) {
            EThreadStatuses._map = [];
            EThreadStatuses._map[0] = "k_WorkerBusy";
            EThreadStatuses.k_WorkerBusy = 0;
            EThreadStatuses._map[1] = "k_WorkerFree";
            EThreadStatuses.k_WorkerFree = 1;
        })(util.EThreadStatuses || (util.EThreadStatuses = {}));
        var EThreadStatuses = util.EThreadStatuses;
        var ThreadManager = (function () {
            function ThreadManager(sScript) {
                if (typeof sScript === "undefined") { sScript = null; }
                var _this = this;
                this._pWorkerList = [];
                this._pStatsList = [];
                this._sDefaultScript = sScript;
                setInterval(function () {
                    var pStats;
                    var iNow = akra.now();
                    for(var i = 0, n = _this._pStatsList.length; i < n; ++i) {
                        pStats = _this._pStatsList[i];
                        if (pStats.releaseTime > 0 && iNow - pStats.releaseTime > 30 * 1000) {
                            if (_this.terminateThread(i)) {
 {
                                    util.logger.setSourceLocation("util/ThreadManager.ts", 45);
                                    util.logger.log("thread with id - " + i + " terminated. (" + i + "/" + n + ")");
                                }
                                ;
                                return;
                            }
 {
                                util.logger.setSourceLocation("util/ThreadManager.ts", 49);
                                util.logger.warning("thread must be removed: " + i);
                            }
                            ;
                        }
                    }
                    ;
                }, 30000);
            }
            ThreadManager.prototype.createThread = function () {
                if (this._pWorkerList.length === 32) {
 {
                        util.logger.setSourceLocation("util/ThreadManager.ts", 58);
                        util.logger.error("Reached limit the number of threads");
                    }
                    ;
                    return false;
                }
                if (!akra.info.api.webWorker) {
 {
                        util.logger.setSourceLocation("util/ThreadManager.ts", 63);
                        util.logger.error("WebWorkers unsupprted..");
                    }
                    ;
                    return false;
                }
                var pWorker = (new Worker(this._sDefaultScript));
                pWorker.id = this._pWorkerList.length;
                pWorker.send = (pWorker).postMessage;
                this._pWorkerList.push(pWorker);
                this._pStatsList.push({
                    status: EThreadStatuses.k_WorkerFree,
                    creationTime: akra.now(),
                    releaseTime: akra.now()
                });
                return true;
            };
            ThreadManager.prototype.occupyThread = function () {
                var pStats;
                for(var i = 0, n = this._pWorkerList.length; i < n; ++i) {
                    pStats = this._pStatsList[i];
                    if (pStats.status == EThreadStatuses.k_WorkerFree) {
                        pStats.status = EThreadStatuses.k_WorkerBusy;
                        pStats.releaseTime = 0;
                        return this._pWorkerList[i];
                    }
                }
                if (this.createThread()) {
                    return this.occupyThread();
                } else {
 {
                        util.logger.setSourceLocation("util/ThreadManager.ts", 99);
                        util.logger.error("cannot occupy thread");
                    }
                    ;
                    return null;
                }
            };
            ThreadManager.prototype.terminateThread = function (iThread) {
                var pStats = this._pStatsList[iThread];
                var pWorker = this._pWorkerList[iThread];
                if (!((pWorker) != null) && pStats.status != EThreadStatuses.k_WorkerFree) {
                    return false;
                }
                (pWorker).terminate();
                this._pStatsList.splice(iThread);
                this._pWorkerList.splice(iThread);
                return true;
            };
            ThreadManager.prototype.releaseThread = function (pThread) {
                var iThread;
                var pStats;
                if (!(typeof (pThread) === "number")) {
                    iThread = pThread.id;
                } else {
                    iThread = pThread;
                }
                if (((this._pStatsList[iThread]) !== undefined)) {
                    pStats = this._pStatsList[iThread];
                    pStats.status = EThreadStatuses.k_WorkerFree;
                    pStats.releaseTime = akra.now();
                }
                return false;
            };
            ThreadManager.prototype.initialize = function () {
                return true;
            };
            ThreadManager.prototype.destroy = function () {
            };
            return ThreadManager;
        })();
        util.ThreadManager = ThreadManager;        
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (io) {
        (function (EFileActions) {
            EFileActions._map = [];
            EFileActions.k_Open = 1;
            EFileActions.k_Read = 2;
            EFileActions._map[3] = "k_Write";
            EFileActions.k_Write = 3;
            EFileActions._map[4] = "k_Clear";
            EFileActions.k_Clear = 4;
            EFileActions._map[5] = "k_Exists";
            EFileActions.k_Exists = 5;
            EFileActions._map[6] = "k_Remove";
            EFileActions.k_Remove = 6;
        })(io.EFileActions || (io.EFileActions = {}));
        var EFileActions = io.EFileActions;
        ;
        (function (EFileTransferModes) {
            EFileTransferModes._map = [];
            EFileTransferModes._map[0] = "k_Normal";
            EFileTransferModes.k_Normal = 0;
            EFileTransferModes._map[1] = "k_Fast";
            EFileTransferModes.k_Fast = 1;
            EFileTransferModes._map[2] = "k_Slow";
            EFileTransferModes.k_Slow = 2;
        })(io.EFileTransferModes || (io.EFileTransferModes = {}));
        var EFileTransferModes = io.EFileTransferModes;
        var pLocalFileThreadManager = new akra.util.ThreadManager("LocalFile.t.js");
        var pRemoteFileThreadManager = new akra.util.ThreadManager("RemoteFile.t.js");
        io.getLocalFileThreadManager = /** @inline */function () {
            return pLocalFileThreadManager;
        };
        io.getRemoteFileThreadManager = /** @inline */function () {
            return pRemoteFileThreadManager;
        };
        var TFile = (function () {
            function TFile(sFilename, sMode, fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = TFile.defaultCallback; }
                this._pUri = null;
                this._nCursorPosition = 0;
                this._bOpened = false;
                this._eTransferMode = EFileTransferModes.k_Normal;
                this._pFileMeta = null;
                this._isLocal = false;
                if (((sMode) !== undefined)) {
                    this._iMode = (typeof (sMode) === "string") ? io.filemode(sMode) : sMode;
                }
                this.setAndValidateUri((new /*checked (origin: akra)>>*/akra.util.URI((sFilename))));
                if (akra.info.api.transferableObjects) {
                    this._eTransferMode = EFileTransferModes.k_Fast;
                }
                if (arguments.length > 2) {
                    this.open(sFilename, sMode, fnCallback);
                }
            }
            Object.defineProperty(TFile.prototype, "path", {
                get: function () {
 {
                        akra.logger.setSourceLocation("TFile.ts", 82);
                        akra.logger.assert(((this._pFileMeta) != null), "There is no file handle open.");
                    }
                    ;
                    return this._pUri.toString();
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TFile.prototype, "name", {
                get: function () {
                    return akra.util.pathinfo(this._pUri.path).basename;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TFile.prototype, "mode", {
                get: function () {
                    return this._iMode;
                },
                set: function (sMode) {
                    this._iMode = (typeof (sMode) === "string") ? io.filemode(sMode) : sMode;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TFile.prototype, "onread", {
                set: function (fnCallback) {
                    this.read(fnCallback);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TFile.prototype, "onopen", {
                set: function (fnCallback) {
                    this.open(fnCallback);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TFile.prototype, "position", {
                get: function () {
 {
                        akra.logger.setSourceLocation("TFile.ts", 109);
                        akra.logger.assert(((this._pFileMeta) != null), 'There is no file handle open.');
                    }
                    ;
                    return this._nCursorPosition;
                },
                set: function (iOffset) {
 {
                        akra.logger.setSourceLocation("TFile.ts", 114);
                        akra.logger.assert(((this._pFileMeta) != null), 'There is no file handle open.');
                    }
                    ;
                    this._nCursorPosition = iOffset;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TFile.prototype, "byteLength", {
                get: function () {
                    return this._pFileMeta ? this._pFileMeta.size : 0;
                },
                enumerable: true,
                configurable: true
            });
            TFile.prototype.open = function (sFilename, iMode, fnCallback) {
                var pFile = this;
                var hasMode = !(/*checked (origin: akra)>>*/akra.typeOf((iMode)) === "function");
                if (arguments.length < 3) {
                    if ((typeof (arguments[0]) === "string")) {
                        this.setAndValidateUri((new /*checked (origin: akra)>>*/akra.util.URI((sFilename))));
                        fnCallback = arguments[1];
                    } else if ((typeof (arguments[0]) === "number")) {
                        this._iMode = arguments[0];
                        fnCallback = arguments[1];
                    } else {
                        fnCallback = arguments[0];
                    }
 {
                        akra.logger.setSourceLocation("TFile.ts", 166);
                        akra.logger.assert(((this._pUri) != null), "No filename provided.");
                    }
                    ;
                    this.open(this._pUri.toString(), this._iMode, fnCallback);
                    return;
                }
                fnCallback = arguments[hasMode ? 2 : 1];
                fnCallback = fnCallback || TFile.defaultCallback;
                if (this.isOpened()) {
 {
                        akra.logger.setSourceLocation("TFile.ts", 178);
                        akra.logger.warning("file already opened: " + this.name);
                    }
                    ;
                    (fnCallback)(null, this._pFileMeta);
                }
                this.setAndValidateUri((new /*checked (origin: akra)>>*/akra.util.URI((arguments[0]))));
                if (hasMode) {
                    this._iMode = ((typeof (arguments[1]) === "string") ? io.filemode(arguments[1]) : arguments[1]);
                }
                this.update(function (err) {
                    if (err) {
 {
                            akra.logger.setSourceLocation("TFile.ts", 190);
                            akra.logger.warning("file update err", err);
                        }
                        ;
                        fnCallback.call(pFile, err);
                        return;
                    }
                    if (((this._iMode & (1 << (3))) != 0)) {
                        this.position = this.size;
                    }
                    fnCallback.call(pFile, null, pFile);
                });
            };
            TFile.prototype.close = function () {
                this._pUri = null;
                this._iMode = io.EIO.IN | io.EIO.OUT;
                this._nCursorPosition = 0;
                this._pFileMeta = null;
            };
            TFile.prototype.clear = function (fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = TFile.defaultCallback; }
                if (!this.isOpened()) {
                    var _pArgv = arguments;
                    this.open(function (err) {
                        if (err) {
                            fnCallback(err);
                        }
                        this.clear.apply(this, _pArgv);
                    });
                    return;
                }
                ;
                var pCommand = {
                    act: EFileActions.k_Clear,
                    name: this.path,
                    mode: this._iMode
                };
                this.execCommand(pCommand, fnCallback);
            };
            TFile.prototype.read = function (fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = TFile.defaultCallback; }
                if (!this.isOpened()) {
                    var _pArgv = arguments;
                    this.open(function (err) {
                        if (err) {
                            fnCallback(err);
                        }
                        this.read.apply(this, _pArgv);
                    });
                    return;
                }
                ;
                var pFile = this;
                var eTransferMode = this._eTransferMode;
 {
                    akra.logger.setSourceLocation("TFile.ts", 229);
                    akra.logger.assert(((this._iMode & (1 << (0))) != 0), "The file is not readable.");
                }
                ;
                var pCommand = {
                    act: EFileActions.k_Read,
                    name: this.path,
                    mode: this._iMode,
                    pos: this._nCursorPosition,
                    transfer: this._eTransferMode
                };
                var fnCallbackSystem = function (err, pData) {
                    if (err) {
                        fnCallback.call(pFile, err);
                        return;
                    }
                    if (eTransferMode == EFileTransferModes.k_Slow && ((this._iMode & (1 << (5))) != 0)) {
                        pData = new Uint8Array(pData).buffer;
                    }
                    pFile.atEnd();
                    fnCallback.call(pFile, null, pData);
                };
                this.execCommand(pCommand, fnCallbackSystem);
            };
            TFile.prototype.write = function (pData, fnCallback, sContentType) {
                if (typeof fnCallback === "undefined") { fnCallback = TFile.defaultCallback; }
                if (!this.isOpened()) {
                    var _pArgv = arguments;
                    this.open(function (err) {
                        if (err) {
                            fnCallback(err);
                        }
                        this.write.apply(this, _pArgv);
                    });
                    return;
                }
                ;
                var pFile = this;
                var iMode = this._iMode;
                var pCommand;
                var fnCallbackSystem = function (err, pMeta) {
                    if (err) {
                        fnCallback.call(pFile, err);
                        return;
                    }
                    pFile.position += (typeof (pData) === "string") ? pData.length : pData.byteLength;
                    (pFile)._pFileMeta = pMeta;
                    fnCallback.call(pFile, null, pMeta);
                };
 {
                    akra.logger.setSourceLocation("TFile.ts", 278);
                    akra.logger.assert(((iMode & (1 << (1))) != 0), "The file is not writable.");
                }
                ;
                sContentType = sContentType || (((iMode & (1 << (5))) != 0) ? "application/octet-stream" : "text/plain");
                pCommand = {
                    act: EFileActions.k_Write,
                    name: this.path,
                    mode: this._iMode,
                    data: pData,
                    contentType: sContentType,
                    pos: this._nCursorPosition
                };
                if (!(typeof (pData) === "string")) {
                    this.execCommand(pCommand, fnCallbackSystem, [
                        pData
                    ]);
                } else {
                    this.execCommand(pCommand, fnCallbackSystem);
                }
            };
            TFile.prototype.move = function (sFilename, fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = TFile.defaultCallback; }
                var pFile = this;
                this.copy(sFilename, function (err) {
                    if (err) {
                        fnCallback(err);
                        return;
                    }
                    pFile.remove(fnCallback);
                });
            };
            TFile.prototype.copy = function (sFilename, fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = TFile.defaultCallback; }
                var iMode = io.EIO.IN | io.EIO.OUT | io.EIO.TRUNC;
                var pFile = this;
                var pFileCopy;
                if (((this._iMode & (1 << (5))) != 0)) {
                    iMode |= io.EIO.BIN;
                }
                pFileCopy = new TFile(sFilename, iMode, function (err) {
                    if (err) {
                        fnCallback(err);
                    }
                    pFile.read(function (pData) {
                        pFile.write(pData, fnCallback);
                    });
                });
            };
            TFile.prototype.rename = function (sFilename, fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = TFile.defaultCallback; }
                var pName = akra.util.pathinfo(sFilename);
 {
                    akra.logger.setSourceLocation("TFile.ts", 336);
                    akra.logger.assert(!pName.dirname, 'only filename can be specified.');
                }
                ;
                this.move(akra.util.pathinfo(this._pUri.path).dirname + "/" + pName.basename, fnCallback);
            };
            TFile.prototype.remove = function (fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = TFile.defaultCallback; }
                if (!this.isOpened()) {
                    var _pArgv = arguments;
                    this.open(function (err) {
                        if (err) {
                            fnCallback(err);
                        }
                        this.remove.apply(this, _pArgv);
                    });
                    return;
                }
                ;
                var pFile = this;
                var pCommand = {
                    act: EFileActions.k_Remove,
                    name: this.path,
                    mode: this._iMode
                };
                var fnCallbackSystem = function (err, pData) {
                    pFile.close();
                    if (((fnCallback) !== undefined)) {
                        fnCallback.call(pFile, err, pData);
                    }
                };
                this.execCommand(pCommand, fnCallbackSystem);
            };
            TFile.prototype.atEnd = function () {
                this.position = this.byteLength;
                return this._nCursorPosition;
            };
            TFile.prototype.seek = function (iOffset) {
 {
                    akra.logger.setSourceLocation("TFile.ts", 368);
                    akra.logger.assert(((this._pFileMeta) != null), "There is no file handle open.");
                }
                ;
                var nSeek = this._nCursorPosition + iOffset;
                if (nSeek < 0) {
                    nSeek = this.byteLength - (akra.math.abs(nSeek) % this.byteLength);
                }
 {
                    akra.logger.setSourceLocation("TFile.ts", 375);
                    akra.logger.assert(nSeek >= 0 && nSeek <= this.byteLength, "Invalid offset parameter");
                }
                ;
                this._nCursorPosition = nSeek;
                return this._nCursorPosition;
            };
            TFile.prototype.isOpened = function () {
                return this._pFileMeta !== null;
            };
            TFile.prototype.isExists = function (fnCallback) {
                var pCommand = {
                    act: EFileActions.k_Exists,
                    name: this.path,
                    mode: this._iMode
                };
                this.execCommand(pCommand, fnCallback);
            };
            TFile.prototype.isLocal = function () {
                return this._isLocal;
            };
            TFile.prototype.getMetaData = function (fnCallback) {
 {
                    akra.logger.setSourceLocation("TFile.ts", 400);
                    akra.logger.assert(((this._pFileMeta) != null), 'There is no file handle open.');
                }
                ;
                fnCallback(null, {
                    lastModifiedDate: this._pFileMeta.lastModifiedDate
                });
            };
            TFile.prototype.setAndValidateUri = function (sFilename) {
                var pUri = (new /*checked (origin: akra)>>*/akra.util.URI((sFilename)));
                var pUriLocal;
                if (pUri.protocol === "filesystem") {
                    pUriLocal = (new /*checked (origin: akra)>>*/akra.util.URI((pUri.path)));
 {
                        akra.logger.setSourceLocation("TFile.ts", 415);
                        akra.logger.assert(!(pUriLocal.protocol && pUriLocal.host != akra.info.uri.host), "Поддерживаются только локальные файлы в пределах текущего домена.");
                    }
                    ;
                    var pFolders = pUriLocal.path.split('/');
                    if (pFolders[0] == "" || pFolders[0] == ".") {
                        pFolders = pFolders.slice(1);
                    }
 {
                        akra.logger.setSourceLocation("TFile.ts", 424);
                        akra.logger.assert(pUri.host === "temporary", "Поддерживаются только файловые системы типа \"temporary\".");
                    }
                    ;
                    this._pUri = (new /*checked (origin: akra)>>*/akra.util.URI((pFolders.join("/"))));
                    this._isLocal = true;
                } else {
                    this._pUri = pUri;
                }
            };
            TFile.prototype.update = function (fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = TFile.defaultCallback; }
                var pFile = this;
                var pCommand = {
                    act: EFileActions.k_Open,
                    name: this._pUri.toString(),
                    mode: this._iMode
                };
                var fnCallbackSystem = function (err, pMeta) {
                    (pFile)._pFileMeta = pMeta;
                    fnCallback.call(pFile, err, pFile);
                };
                this.execCommand(pCommand, fnCallbackSystem);
            };
            TFile.prototype.execCommand = function (pCommand, fnCallback, pTransferables) {
                TFile.execCommand(this.isLocal(), pCommand, fnCallback);
            };
            TFile.defaultCallback = function (err) {
                if (err) {
                    throw err;
                }
            };
            TFile.execCommand = function execCommand(isLocal, pCommand, fnCallback, pTransferables) {
                var pFile = this;
                var pManager = isLocal ? (pLocalFileThreadManager) : (pRemoteFileThreadManager);
                var pThread = pManager.occupyThread();
                pThread.onmessage = function (e) {
                    pManager.releaseThread(pThread);
                    pThread.onmessage = null;
                    fnCallback.call(pFile, null, e.data);
                };
                pThread.onerror = function (e) {
                    pManager.releaseThread(pThread);
                    pThread.onmessage = null;
                    fnCallback.call(pFile, e);
                };
                if (((pTransferables) !== undefined)) {
                    pThread.send(pCommand, pTransferables);
                } else {
                    pThread.send(pCommand);
                }
            };
            return TFile;
        })();
        io.TFile = TFile;        
    })(akra.io || (akra.io = {}));
    var io = akra.io;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (io) {
        var LocalFileSystem = (function () {
            function LocalFileSystem() {
                this._pFileSystem = null;
                this._pCallbackQueue = [];
            }
            LocalFileSystem.prototype.setFileSystem = function (pFS) {
                this._pFileSystem = pFS;
            };
            LocalFileSystem.prototype.get = function (fnCallback) {
                if (this._pFileSystem) {
                    fnCallback(this._pFileSystem);
                    return;
                }
                var pFileSystem = this;
                var pQueue = this._pCallbackQueue;
                pQueue.push(fnCallback);
                if (pQueue.length > 1) {
                    return;
                }
                window.storageInfo.requestQuota(window.TEMPORARY, (32 * 1024 * 1024), function (nGrantedBytes) {
                    window.requestFileSystem(window.TEMPORARY, nGrantedBytes, function (pFs) {
                        pFileSystem.setFileSystem(pFs);
                        if (pQueue.length) {
                            for(var i = 0; i < pQueue.length; ++i) {
                                pQueue[i](pFs);
                            }
                        }
                    }, LocalFileSystem.errorHandler);
                });
            };
            LocalFileSystem.errorHandler = function errorHandler(e) {
                var sMesg = "init filesystem: ";
                switch(e.code) {
                    case FileError.QUOTA_EXCEEDED_ERR:
                        sMesg += 'QUOTA_EXCEEDED_ERR';
                        break;
                    case FileError.NOT_FOUND_ERR:
                        sMesg += 'NOT_FOUND_ERR';
                        break;
                    case FileError.SECURITY_ERR:
                        sMesg += 'SECURITY_ERR';
                        break;
                    case FileError.INVALID_MODIFICATION_ERR:
                        sMesg += 'INVALID_MODIFICATION_ERR';
                        break;
                    case FileError.INVALID_STATE_ERR:
                        sMesg += 'INVALID_STATE_ERR';
                        break;
                    default:
                        sMesg += 'Unknown Error';
                        break;
                }
 {
                    akra.logger.setSourceLocation("LocalFile.ts", 102);
                    akra.logger.error(sMesg);
                }
                ;
            };
            return LocalFileSystem;
        })();        
        var pLocalFileSystem = new LocalFileSystem();
        function getFileSystem(fnCallback) {
            pLocalFileSystem.get(fnCallback);
        }
        io.getFileSystem = getFileSystem;
        var LocalFile = (function () {
            function LocalFile(sFilename, sMode, fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = LocalFile.defaultCallback; }
                this._nCursorPosition = 0;
                if (((sMode) !== undefined)) {
                    this._iMode = (typeof (sMode) === "string") ? io.filemode(sMode) : sMode;
                }
                this.setAndValidateUri((new /*checked (origin: akra)>>*/akra.util.URI((sFilename))));
                if (arguments.length > 2) {
                    this.open(sFilename, sMode, fnCallback);
                }
            }
            Object.defineProperty(LocalFile.prototype, "path", {
                get: function () {
 {
                        akra.logger.setSourceLocation("LocalFile.ts", 126);
                        akra.logger.assert(((this._pFile) != null), "There is no file handle open.");
                    }
                    ;
                    return this._pUri.toString();
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(LocalFile.prototype, "name", {
                get: function () {
                    return akra.util.pathinfo(this._pUri.path).basename;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(LocalFile.prototype, "mode", {
                get: function () {
                    return this._iMode;
                },
                set: function (sMode) {
                    this._iMode = (typeof (sMode) === "string") ? io.filemode(sMode) : sMode;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(LocalFile.prototype, "onread", {
                set: function (fnCallback) {
                    this.read(fnCallback);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(LocalFile.prototype, "onopen", {
                set: function (fnCallback) {
                    this.open(fnCallback);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(LocalFile.prototype, "position", {
                get: function () {
 {
                        akra.logger.setSourceLocation("LocalFile.ts", 153);
                        akra.logger.assert(((this._pFile) != null), "There is no file handle open.");
                    }
                    ;
                    return this._nCursorPosition;
                },
                set: function (iOffset) {
 {
                        akra.logger.setSourceLocation("LocalFile.ts", 158);
                        akra.logger.assert(((this._pFile) != null), "There is no file handle open.");
                    }
                    ;
                    this._nCursorPosition = iOffset;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(LocalFile.prototype, "byteLength", {
                get: function () {
                    return this._pFile ? this._pFile.size : 0;
                },
                enumerable: true,
                configurable: true
            });
            LocalFile.prototype.open = function (sFilename, iMode, fnCallback) {
                var pFile = this;
                var hasMode = !(/*checked (origin: akra)>>*/akra.typeOf((iMode)) === "function");
                if (arguments.length < 3) {
                    if ((typeof (arguments[0]) === "string")) {
                        this.setAndValidateUri((new /*checked (origin: akra)>>*/akra.util.URI((sFilename))));
                        fnCallback = arguments[1];
                    } else if ((typeof (arguments[0]) === "number")) {
                        this._iMode = arguments[0];
                        fnCallback = arguments[1];
                    } else {
                        fnCallback = arguments[0];
                    }
 {
                        akra.logger.setSourceLocation("LocalFile.ts", 204);
                        akra.logger.assert(((this._pUri) != null), "No filename provided.");
                    }
                    ;
                    this.open(this._pUri.toString(), this._iMode, fnCallback);
                    return;
                }
                fnCallback = arguments[hasMode ? 2 : 1];
                fnCallback = fnCallback || LocalFile.defaultCallback;
                if (this.isOpened()) {
 {
                        akra.logger.setSourceLocation("LocalFile.ts", 216);
                        akra.logger.warning("file already opened: " + this.name);
                    }
                    ;
                    (fnCallback)(null, this._pFile);
                }
                this.setAndValidateUri((new /*checked (origin: akra)>>*/akra.util.URI((arguments[0]))));
                if (hasMode) {
                    this._iMode = ((typeof (arguments[1]) === "string") ? io.filemode(arguments[1]) : arguments[1]);
                }
                var fnFSInited;
                var pFile = this;
                var pFileSystem = null;
                var fnErrorHandler = function (e) {
                    if (e.code == FileError.NOT_FOUND_ERR && ((pFile.mode & (1 << (1))) != 0)) {
                        LocalFile.createDir(pFileSystem.root, akra.util.pathinfo(pFile.path).dirname.split('/'), function (e) {
                            if (!((e) === null)) {
                                fnCallback.call(pFile, e);
                            } else {
                                fnFSInited.call(pFile, pFileSystem);
                            }
                        });
                    } else {
                        fnCallback.call(pFile, e);
                    }
                };
                fnFSInited = function (pFs) {
 {
                        akra.logger.setSourceLocation("LocalFile.ts", 250);
                        akra.logger.assert(((pFs) != null), "local file system not initialized");
                    }
                    ;
                    pFileSystem = pFs;
                    pFs.root.getFile(this.path, {
                        create: ((this._iMode & (1 << (1))) != 0),
                        exclusive: false
                    }, function (fileEntry) {
                        (pFile).setFileEntry(fileEntry);
                        (fileEntry).file(function (file) {
                            (pFile).setFile(file);
                            if (((pFile.mode & (1 << (4))) != 0) && pFile.byteLength) {
                                pFile.clear(function (err) {
                                    if (err) {
                                        fnCallback(err);
                                    } else {
                                        fnCallback.call(pFile, null, file);
                                    }
                                });
                                return;
                            }
                            if (((pFile.mode & (1 << (3))) != 0)) {
                                pFile.position = pFile.byteLength;
                            }
                            fnCallback.call(pFile, null, file);
                        }, fnErrorHandler);
                    }, fnErrorHandler);
                };
                getFileSystem(function (pFileSystem) {
                    fnFSInited.call(pFile, pFileSystem);
                });
            };
            LocalFile.prototype.close = function () {
                this._pUri = null;
                this._iMode = io.EIO.IN | io.EIO.OUT;
                this._nCursorPosition = 0;
                this._pFile = null;
            };
            LocalFile.prototype.clear = function (fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = LocalFile.defaultCallback; }
                if (!this.isOpened()) {
                    var _pArgv = arguments;
                    this.open(function (err) {
                        if (err) {
                            fnCallback(err);
                        }
                        this.clear.apply(this, _pArgv);
                    });
                    return;
                }
                ;
 {
                    akra.logger.setSourceLocation("LocalFile.ts", 303);
                    akra.logger.assert(((this._pFile) != null), 'There is no file handle open');
                }
                ;
                var pFile = this;
                var pFileEntry = this._pFileEntry;
                pFileEntry.createWriter(function (pWriter) {
                    pWriter.seek(0);
                    pWriter.onwriteend = function () {
                        fnCallback.call(pFile, null);
                    };
                    pWriter.truncate(0);
                }, function (e) {
                    fnCallback.call(pFile, e);
                });
            };
            LocalFile.prototype.read = function (fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = LocalFile.defaultCallback; }
                if (!this.isOpened()) {
                    var _pArgv = arguments;
                    this.open(function (err) {
                        if (err) {
                            fnCallback(err);
                        }
                        this.read.apply(this, _pArgv);
                    });
                    return;
                }
                ;
                var pFile = this;
                var eTransferMode = this._iMode;
 {
                    akra.logger.setSourceLocation("LocalFile.ts", 330);
                    akra.logger.assert(((this._iMode & (1 << (0))) != 0), "The file is not readable.");
                }
                ;
                var pReader = this._pFileReader;
                var pFileObject = this._pFile;
                pReader.onloadend = function (e) {
                    var pData = ((e.target)).result;
                    var nPos = pFile.position;
                    if (nPos) {
                        if (((pFile.mode & (1 << (5))) != 0)) {
                            pData = (new Uint8Array((new Uint8Array(pData)).subarray(nPos))).buffer;
                        } else {
                            pData = pData.substr(nPos);
                        }
                    }
                    pFile.atEnd();
                    fnCallback.call(pFile, null, pData);
                };
                if (((pFile.mode & (1 << (5))) != 0)) {
                    pReader.readAsArrayBuffer(pFileObject);
                } else {
                    pReader.readAsText(pFileObject);
                }
            };
            LocalFile.prototype.write = function (pData, fnCallback, sContentType) {
                if (typeof fnCallback === "undefined") { fnCallback = LocalFile.defaultCallback; }
                if (!this.isOpened()) {
                    var _pArgv = arguments;
                    this.open(function (err) {
                        if (err) {
                            fnCallback(err);
                        }
                        this.write.apply(this, _pArgv);
                    });
                    return;
                }
                ;
                var pFile = this;
                var iMode = this._iMode;
 {
                    akra.logger.setSourceLocation("LocalFile.ts", 369);
                    akra.logger.assert(((iMode & (1 << (1))) != 0), "The file is not writable.");
                }
                ;
                sContentType = sContentType || (((iMode & (1 << (5))) != 0) ? "application/octet-stream" : "text/plain");
                var pFile = this;
                var pFileEntry = this._pFileEntry;
                pFileEntry.createWriter(function (pWriter) {
                    pWriter.seek(pFile.position);
                    pWriter.onerror = function (e) {
                        fnCallback.call(pFileEntry, e);
                    };
                    pWriter.onwriteend = function () {
                        if (((iMode & (1 << (5))) != 0)) {
                            pFile.seek(pData.byteLength);
                        } else {
                            pFile.seek(pData.length);
                        }
                        fnCallback.call(pFile, null);
                    };
                    pWriter.write((new (Blob)(pData, {
                        type: sContentType
                    })));
                }, function (e) {
                    fnCallback.call(pFile, e);
                });
            };
            LocalFile.prototype.move = function (sFilename, fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = LocalFile.defaultCallback; }
                var pFile = this;
                this.copy(sFilename, function (err) {
                    if (err) {
                        fnCallback(err);
                        return;
                    }
                    pFile.remove(fnCallback);
                });
            };
            LocalFile.prototype.copy = function (sFilename, fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = LocalFile.defaultCallback; }
                var iMode = io.EIO.IN | io.EIO.OUT | io.EIO.TRUNC;
                var pFile = this;
                var pFileCopy;
                if (((this._iMode & (1 << (5))) != 0)) {
                    iMode |= io.EIO.BIN;
                }
                pFileCopy = new LocalFile(sFilename, iMode, function (err) {
                    if (err) {
                        fnCallback(err);
                    }
                    pFile.read(function (pData) {
                        pFile.write(pData, fnCallback);
                    });
                });
            };
            LocalFile.prototype.rename = function (sFilename, fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = LocalFile.defaultCallback; }
                var pName = akra.util.pathinfo(sFilename);
 {
                    akra.logger.setSourceLocation("LocalFile.ts", 441);
                    akra.logger.assert(!pName.dirname, 'only filename can be specified.');
                }
                ;
                this.move(akra.util.pathinfo(this._pUri.path).dirname + "/" + pName.basename, fnCallback);
            };
            LocalFile.prototype.remove = function (fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = LocalFile.defaultCallback; }
                if (!this.isOpened()) {
                    var _pArgv = arguments;
                    this.open(function (err) {
                        if (err) {
                            fnCallback(err);
                        }
                        this.remove.apply(this, _pArgv);
                    });
                    return;
                }
                ;
                var pFile = this;
                this._pFileEntry.remove(function () {
                    pFile.close();
                    fnCallback.call(pFile, null);
                }, fnCallback);
            };
            LocalFile.prototype.atEnd = function () {
                this.position = this.byteLength;
                return this._nCursorPosition;
            };
            LocalFile.prototype.seek = function (iOffset) {
 {
                    akra.logger.setSourceLocation("LocalFile.ts", 464);
                    akra.logger.assert(((this._pFile) != null), "There is no file handle open.");
                }
                ;
                var nSeek = this._nCursorPosition + iOffset;
                if (nSeek < 0) {
                    nSeek = this.byteLength - (akra.math.abs(nSeek) % this.byteLength);
                }
 {
                    akra.logger.setSourceLocation("LocalFile.ts", 471);
                    akra.logger.assert(nSeek >= 0 && nSeek <= this.byteLength, "Invalid offset parameter");
                }
                ;
                this._nCursorPosition = nSeek;
                return this._nCursorPosition;
            };
            LocalFile.prototype.isOpened = function () {
                return this._pFile !== null;
            };
            LocalFile.prototype.isExists = function (fnCallback) {
                this.open(function (e) {
                    fnCallback(((e) === null) ? true : false);
                });
            };
            LocalFile.prototype.isLocal = function () {
                return true;
            };
            LocalFile.prototype.getMetaData = function (fnCallback) {
 {
                    akra.logger.setSourceLocation("LocalFile.ts", 493);
                    akra.logger.assert(((this._pFile) != null), 'There is no file handle open.');
                }
                ;
                fnCallback(null, {
                    lastModifiedDate: this._pFile.lastModifiedDate
                });
            };
            LocalFile.prototype.setFileEntry = function (pFileEntry) {
                if (!((this._pFileEntry) === null)) {
                    return false;
                }
                this._pFileEntry = pFileEntry;
                return true;
            };
            LocalFile.prototype.setFile = function (pFile) {
                if (!((this._pFile) === null)) {
                    return false;
                }
                this._pFile = pFile;
                return true;
            };
            LocalFile.prototype.setAndValidateUri = function (sFilename) {
                var pUri = (new /*checked (origin: akra)>>*/akra.util.URI((sFilename)));
                var pUriLocal;
                if (pUri.protocol === "filesystem") {
                    pUriLocal = (new /*checked (origin: akra)>>*/akra.util.URI((pUri.path)));
 {
                        akra.logger.setSourceLocation("LocalFile.ts", 528);
                        akra.logger.assert(!(pUriLocal.protocol && pUriLocal.host != akra.info.uri.host), "Поддерживаются только локальные файлы в пределах текущего домена.");
                    }
                    ;
                    var pFolders = pUriLocal.path.split('/');
                    if (pFolders[0] == "" || pFolders[0] == ".") {
                        pFolders = pFolders.slice(1);
                    }
 {
                        akra.logger.setSourceLocation("LocalFile.ts", 537);
                        akra.logger.assert(pUri.host === "temporary", "Поддерживаются только файловые системы типа \"temporary\".");
                    }
                    ;
                    this._pUri = (new /*checked (origin: akra)>>*/akra.util.URI((pFolders.join("/"))));
                } else {
 {
                        akra.logger.setSourceLocation("LocalFile.ts", 542);
                        akra.logger.error("used non local uri");
                    }
                    ;
                }
            };
            LocalFile.errorHandler = function errorHandler(e) {
                var sMesg = "";
                switch(e.code) {
                    case FileError.QUOTA_EXCEEDED_ERR:
                        sMesg += 'QUOTA_EXCEEDED_ERR';
                        break;
                    case FileError.NOT_FOUND_ERR:
                        sMesg += 'NOT_FOUND_ERR';
                        break;
                    case FileError.SECURITY_ERR:
                        sMesg += 'SECURITY_ERR';
                        break;
                    case FileError.INVALID_MODIFICATION_ERR:
                        sMesg += 'INVALID_MODIFICATION_ERR';
                        break;
                    case FileError.INVALID_STATE_ERR:
                        sMesg += 'INVALID_STATE_ERR';
                        break;
                    default:
                        sMesg += 'Unknown Error';
                        break;
                }
 {
                    akra.logger.setSourceLocation("LocalFile.ts", 570);
                    akra.logger.error(sMesg);
                }
                ;
            };
            LocalFile.createDir = function createDir(pRootDirEntry, pFolders, fnCallback) {
                if (pFolders[0] == "." || pFolders[0] == "") {
                    pFolders = pFolders.slice(1);
                }
                pRootDirEntry.getDirectory(pFolders[0], {
                    create: true
                }, function (dirEntry) {
                    if (pFolders.length) {
                        LocalFile.createDir(dirEntry, pFolders.slice(1), fnCallback);
                    } else {
                        fnCallback(null);
                    }
                }, fnCallback);
            };
            LocalFile.defaultCallback = function (err) {
                if (err) {
                    LocalFile.errorHandler(err);
                }
            };
            return LocalFile;
        })();
        io.LocalFile = LocalFile;        
    })(akra.io || (akra.io = {}));
    var io = akra.io;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (io) {
        var StorageFile = (function (_super) {
            __extends(StorageFile, _super);
            function StorageFile(sFilename, sMode, fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = io.TFile.defaultCallback; }
                        _super.call(this, sFilename, sMode, fnCallback);
            }
            StorageFile.prototype.clear = function (fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = io.TFile.defaultCallback; }
                if (!this.isOpened()) {
                    var _pArgv = arguments;
                    this.open(function (err) {
                        if (err) {
                            fnCallback(err);
                        }
                        this.clear.apply(this, _pArgv);
                    });
                    return;
                }
                ;
                localStorage.setItem(this.path, "");
                this._pFileMeta.size = 0;
                fnCallback(null, this);
            };
            StorageFile.prototype.read = function (fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = io.TFile.defaultCallback; }
                if (!this.isOpened()) {
                    var _pArgv = arguments;
                    this.open(function (err) {
                        if (err) {
                            fnCallback(err);
                        }
                        this.read.apply(this, _pArgv);
                    });
                    return;
                }
                ;
 {
                    akra.logger.setSourceLocation("StorageFile.ts", 36);
                    akra.logger.assert(((this._iMode & (1 << (1))) != 0), "The file is not readable.");
                }
                ;
                var pData = this.readData();
                var nPos = this._nCursorPosition;
                if (nPos) {
                    if (((this._iMode & (1 << (5))) != 0)) {
                        pData = (new Uint8Array((new Uint8Array(pData)).subarray(nPos))).buffer;
                    } else {
                        pData = pData.substr(nPos);
                    }
                }
                this.atEnd();
                if (fnCallback) {
                    fnCallback.call(this, null, pData);
                }
            };
            StorageFile.prototype.write = function (pData, fnCallback, sContentType) {
                if (typeof fnCallback === "undefined") { fnCallback = io.TFile.defaultCallback; }
                if (!this.isOpened()) {
                    var _pArgv = arguments;
                    this.open(function (err) {
                        if (err) {
                            fnCallback(err);
                        }
                        this.write.apply(this, _pArgv);
                    });
                    return;
                }
                ;
                var iMode = this._iMode;
                var nSeek;
                var pCurrentData;
 {
                    akra.logger.setSourceLocation("StorageFile.ts", 66);
                    akra.logger.assert(((iMode & (1 << (1))) != 0), "The file is not writable.");
                }
                ;
                sContentType = sContentType || (((iMode & (1 << (5))) != 0) ? "application/octet-stream" : "text/plain");
                pCurrentData = this.readData();
                if (!(typeof (pCurrentData) === "string")) {
                    pCurrentData = akra.util.abtos(pCurrentData);
                }
                nSeek = ((typeof (pData) === "string") ? pData.length : pData.byteLength);
                if (!(typeof (pData) === "string")) {
                    pData = akra.util.abtos(pData);
                }
                pData = (pCurrentData).substr(0, this._nCursorPosition) + (pData) + (pCurrentData).substr(this._nCursorPosition + (pData).length);
                try  {
                    localStorage.setItem(this.path, pData);
                } catch (e) {
                    fnCallback(e);
                }
                this._pFileMeta.size = pData.length;
                this._nCursorPosition += nSeek;
                fnCallback(null);
            };
            StorageFile.prototype.isExists = function (fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = io.TFile.defaultCallback; }
                fnCallback.call(this, null, localStorage.getItem(this.path) == null);
            };
            StorageFile.prototype.remove = function (fnCallback) {
                if (typeof fnCallback === "undefined") { fnCallback = io.TFile.defaultCallback; }
                localStorage.removeItem(this.path);
                fnCallback.call(this, null);
            };
            StorageFile.prototype.readData = function () {
                var pFileMeta = this._pFileMeta;
                var pData = localStorage.getItem(this.path);
                var pDataBin;
                if (pData == null) {
                    pData = "";
                    if (((this._iMode & (1 << (1))) != 0)) {
                        localStorage.setItem(this.path, pData);
                    }
                }
                if (((this._iMode & (1 << (5))) != 0)) {
                    pDataBin = akra.util.stoab(pData);
                    pFileMeta.size = pDataBin.byteLength;
                    return pDataBin;
                } else {
                    pFileMeta.size = pData.length;
                    return pData;
                }
            };
            StorageFile.prototype.update = function (fnCallback) {
                this._pFileMeta = null;
                this.readData();
                fnCallback.call(this, null);
            };
            return StorageFile;
        })(io.TFile);
        io.StorageFile = StorageFile;        
    })(akra.io || (akra.io = {}));
    var io = akra.io;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (io) {
        (function (EIO) {
            EIO._map = [];
            EIO.IN = 0x01;
            EIO.OUT = 0x02;
            EIO.ATE = 0x04;
            EIO.APP = 0x08;
            EIO.TRUNC = 0x10;
            EIO.BINARY = 0x20;
            EIO.BIN = 0x20;
            EIO.TEXT = 0x40;
        })(io.EIO || (io.EIO = {}));
        var EIO = io.EIO;
        ;
        function filemode(sMode) {
            switch(sMode.toLowerCase()) {
                case "a+t":
                    return EIO.IN | EIO.OUT | EIO.APP | EIO.TEXT;
                case "w+t":
                    return EIO.IN | EIO.OUT | EIO.TRUNC | EIO.TEXT;
                case "r+t":
                    return EIO.IN | EIO.OUT | EIO.TEXT;
                case "at":
                    return EIO.APP | EIO.TEXT;
                case "wt":
                    return EIO.OUT | EIO.TEXT;
                case "rt":
                    return EIO.IN | EIO.TEXT;
                case "a+b":
                    return EIO.IN | EIO.OUT | EIO.APP | EIO.BIN;
                case "w+b":
                    return EIO.IN | EIO.OUT | EIO.TRUNC | EIO.BIN;
                case "r+b":
                    return EIO.IN | EIO.OUT | EIO.BIN;
                case "ab":
                    return EIO.APP | EIO.BIN;
                case "wb":
                    return EIO.OUT | EIO.BIN;
                case "rb":
                    return EIO.IN | EIO.BIN;
                case "a+":
                    return EIO.IN | EIO.OUT | EIO.APP;
                case "w+":
                    return EIO.IN | EIO.OUT | EIO.TRUNC;
                case "r+":
                    return EIO.IN | EIO.OUT;
                case "a":
                    return EIO.APP | EIO.OUT;
                case "w":
                    return EIO.OUT;
                case "r":
                default:
                    return EIO.IN;
            }
        }
        io.filemode = filemode;
        function _fopen(sUri, pMode) {
            if (typeof pMode === "undefined") { pMode = EIO.IN; }
            if (akra.info.api.webWorker) {
                return new io.TFile(sUri, pMode);
            } else if (akra.info.api.fileSystem) {
                return new io.LocalFile(sUri, pMode);
            } else {
                return new io.StorageFile(sUri, pMode);
            }
        }
        io.fopen = _fopen;
    })(akra.io || (akra.io = {}));
    var io = akra.io;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    var Codec = (function () {
        function Codec() { }
        Codec._pMapCodecs = {};
        Codec.registerCodec = function registerCodec(pCodec) {
            if (!((Codec._pMapCodecs[pCodec.getType()]) !== undefined)) {
                Codec._pMapCodecs[pCodec.getType()] = pCodec;
            } else {
 {
                    akra.logger.setSourceLocation("Codec.ts", 28);
                    akra.logger.criticalError(pCodec.getType() + " already has a registered codec. ");
                }
                ;
            }
        };
        Codec.isCodecRegistered = function isCodecRegistered(pCodec) {
            return ((Codec._pMapCodecs[pCodec.getType()]) !== undefined);
        };
        Codec.unRegisterCodec = function unRegisterCodec(pCodec) {
            delete Codec._pMapCodecs[pCodec.getType()];
        };
        Codec.getExtension = function getExtension() {
            var pExt = Array();
            var sExt = "";
            for(sExt in Codec._pMapCodecs) {
                pExt.push(sExt);
            }
            return pExt;
        };
        Codec.getCodec = function getCodec(pMagicNumber) {
            var sExt = "";
            if ((typeof (pMagicNumber) === "string")) {
                if (((Codec._pMapCodecs[pMagicNumber]) !== undefined)) {
                    return Codec._pMapCodecs[pMagicNumber];
                } else {
 {
                        akra.logger.setSourceLocation("Codec.ts", 66);
                        akra.logger.criticalError("Can not find codec for " + pMagicNumber);
                    }
                    ;
                    return null;
                }
            } else {
                for(sExt in Codec._pMapCodecs) {
                    var sExt1 = Codec._pMapCodecs[sExt].magicNumberToFileExt(pMagicNumber);
                    if (sExt1) {
                        if (sExt1 == Codec._pMapCodecs[sExt].getType()) {
                            return Codec._pMapCodecs[sExt];
                        } else {
                            return Codec.getCodec(sExt1);
                        }
                    }
                }
            }
            return null;
        };
        Codec.prototype.magicNumberMatch = function (pMagicNumber) {
            return !(this.magicNumberToFileExt(pMagicNumber).length == 0);
        };
        Codec.prototype.magicNumberToFileExt = function (pMagicNumber) {
 {
                akra.logger.setSourceLocation("Codec.ts", 100);
                akra.logger.criticalError("Codec.magicNumberToFileExt is virtual");
            }
            ;
            return null;
        };
        Codec.prototype.getType = function () {
 {
                akra.logger.setSourceLocation("Codec.ts", 106);
                akra.logger.criticalError("Codec.getType is virtual");
            }
            ;
            return null;
        };
        Codec.prototype.getDataType = function () {
 {
                akra.logger.setSourceLocation("Codec.ts", 112);
                akra.logger.criticalError("Codec.getDataType is virtual");
            }
            ;
            return null;
        };
        Codec.prototype.code = function (pInput, pData) {
 {
                akra.logger.setSourceLocation("Codec.ts", 118);
                akra.logger.criticalError("Codec.code is virtual");
            }
            ;
            return null;
        };
        Codec.prototype.decode = function (pData, pCodecData) {
 {
                akra.logger.setSourceLocation("Codec.ts", 123);
                akra.logger.criticalError("Codec.decode is virtual");
            }
            ;
            return null;
        };
        return Codec;
    })();
    akra.Codec = Codec;    
    var CodecData = (function () {
        function CodecData() { }
        Object.defineProperty(CodecData.prototype, "dataType", {
            get: function () {
 {
                    akra.logger.setSourceLocation("Codec.ts", 135);
                    akra.logger.criticalError("CodecData.dataType is virtual");
                }
                ;
                return "CodecData";
            },
            enumerable: true,
            configurable: true
        });
        return CodecData;
    })();
    akra.CodecData = CodecData;    
})(akra || (akra = {}));
var akra;
(function (akra) {
    var ImgCodec = (function (_super) {
        __extends(ImgCodec, _super);
        function ImgCodec() {
            _super.apply(this, arguments);

        }
        ImgCodec.prototype.getDataType = function () {
            return "ImgData";
        };
        return ImgCodec;
    })(akra.Codec);
    akra.ImgCodec = ImgCodec;    
    var ImgData = (function (_super) {
        __extends(ImgData, _super);
        function ImgData() {
            _super.apply(this, arguments);

            this._iHeight = 0;
            this._iWidth = 0;
            this._iDepth = 1;
            this._iSize = 0;
            this._nMipMaps = 0;
            this._iFlags = 0;
            this._eFormat = akra.EPixelFormats.UNKNOWN;
        }
        Object.defineProperty(ImgData.prototype, "width", {
            get: function () {
                return this._iWidth;
            },
            set: function (iWidth) {
                this._iWidth = iWidth;
            },
            enumerable: true,
            configurable: true
        });
        Object.defineProperty(ImgData.prototype, "height", {
            get: function () {
                return this._iHeight;
            },
            set: function (iHeight) {
                this._iHeight = iHeight;
            },
            enumerable: true,
            configurable: true
        });
        Object.defineProperty(ImgData.prototype, "depth", {
            get: function () {
                return this._iDepth;
            },
            set: function (iDepth) {
                this._iDepth = iDepth;
            },
            enumerable: true,
            configurable: true
        });
        Object.defineProperty(ImgData.prototype, "size", {
            get: function () {
                return akra.core.pool.resources.Img.calculateSize(this.numMipMaps, this.numFace, this.width, this.height, this.depth, this.format);
            },
            enumerable: true,
            configurable: true
        });
        Object.defineProperty(ImgData.prototype, "numMipMaps", {
            get: function () {
                return this._nMipMaps;
            },
            set: function (nNumMipMaps) {
                this._nMipMaps = nNumMipMaps;
            },
            enumerable: true,
            configurable: true
        });
        Object.defineProperty(ImgData.prototype, "format", {
            get: function () {
                return this._eFormat;
            },
            set: function (ePixelFormat) {
                this._eFormat = ePixelFormat;
            },
            enumerable: true,
            configurable: true
        });
        Object.defineProperty(ImgData.prototype, "flags", {
            get: function () {
                return this._iFlags;
            },
            set: function (iFlags) {
                this._iFlags = iFlags;
            },
            enumerable: true,
            configurable: true
        });
        Object.defineProperty(ImgData.prototype, "cubeFlags", {
            get: function () {
                return this._iCubeFlags;
            },
            set: function (iFlags) {
                this._iCubeFlags = iFlags;
            },
            enumerable: true,
            configurable: true
        });
        Object.defineProperty(ImgData.prototype, "numFace", {
            get: function () {
                if (this._iFlags & akra.EImageFlags.CUBEMAP) {
                    var nFace = 0;
                    for(var i = 0; i < 32; i++) {
                        nFace++;
                    }
                    return nFace;
                } else {
                    return 1;
                }
            },
            enumerable: true,
            configurable: true
        });
        Object.defineProperty(ImgData.prototype, "dataType", {
            get: function () {
                return "ImgData";
            },
            enumerable: true,
            configurable: true
        });
        return ImgData;
    })(akra.CodecData);
    akra.ImgData = ImgData;    
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                var Img = (function (_super) {
                    __extends(Img, _super);
                    function Img() {
                                        _super.call(this);
                        this._iWidth = 0;
                        this._iHeight = 0;
                        this._iDepth = 0;
                        this._nMipMaps = 0;
                        this._iFlags = 0;
                        this._iCubeFlags = 0;
                        this._eFormat = akra.EPixelFormats.UNKNOWN;
                        this._pBuffer = null;
                    }
                    Object.defineProperty(Img.prototype, "byteLength", {
                        get: function () {
                            return this._pBuffer.buffer.byteLength;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Img.prototype, "width", {
                        get: function () {
                            return this._iWidth;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Img.prototype, "height", {
                        get: function () {
                            return this._iHeight;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Img.prototype, "depth", {
                        get: function () {
                            return this._iDepth;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Img.prototype, "numFaces", {
                        get: function () {
                            if (this._iFlags & akra.EImageFlags.CUBEMAP) {
                                var nFace = 0;
                                for(var i = 0; i < 6; i++) {
                                    if (this._iCubeFlags & (1 << i)) {
                                        nFace++;
                                    }
                                }
                                return nFace;
                            } else {
                                return 1;
                            }
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Img.prototype, "numMipMaps", {
                        get: function () {
                            return this._nMipMaps;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Img.prototype, "format", {
                        get: function () {
                            return this._eFormat;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Img.prototype, "flags", {
                        get: function () {
                            return this._iFlags;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Img.prototype, "cubeFlags", {
                        get: function () {
                            return this._iCubeFlags;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Img.prototype.createResource = function () {
 {
                            akra.logger.setSourceLocation("resources/Img.ts", 87);
                            akra.logger.assert(!this.isResourceCreated(), "The resource has already been created.");
                        }
                        ;
                        this.notifyCreated();
                        this.notifyDisabled();
                        return true;
                    };
                    Img.prototype.destroyResource = function () {
                        if (this.isResourceCreated()) {
                            this.disableResource();
                            this.freeMemory();
                            this.notifyUnloaded();
                            this.notifyDestroyed();
                            return (true);
                        }
                        return (false);
                    };
                    Img.prototype.restoreResource = function () {
 {
                            akra.logger.setSourceLocation("resources/Img.ts", 119);
                            akra.logger.assert(this.isResourceCreated(), "The resource has not been created.");
                        }
                        ;
                        this.notifyRestored();
                        return true;
                    };
                    Img.prototype.disableResource = function () {
 {
                            akra.logger.setSourceLocation("resources/Img.ts", 127);
                            akra.logger.assert(this.isResourceCreated(), "The resource has not been created.");
                        }
                        ;
                        this.notifyDisabled();
                        return true;
                    };
                    Img.prototype.loadResource = function (sFilename) {
                        return !((this.load(sFilename)) === null);
                    };
                    Img.prototype.saveResource = function (sFilename) {
                        return false;
                    };
                    Img.prototype.create = function (iWidth, iHeight, iDepth, eFormat, nFaces, nMipMaps) {
                        if (typeof iDepth === "undefined") { iDepth = 1; }
                        if (typeof eFormat === "undefined") { eFormat = akra.EPixelFormats.BYTE_ABGR; }
                        if (typeof nFaces === "undefined") { nFaces = 1; }
                        if (typeof nMipMaps === "undefined") { nMipMaps = 0; }
                        var iSize = Img.calculateSize(nMipMaps, nFaces, iWidth, iHeight, iDepth, eFormat);
                        var pBuffer = new Uint8Array(iSize);
                        return this.loadDynamicImage(pBuffer, iWidth, iHeight, iDepth, eFormat, nFaces, nMipMaps);
                    };
                    Img.prototype.freeMemory = function () {
                        this._iWidth = 0;
                        this._iHeight = 0;
                        this._iDepth = 0;
                        this._pBuffer = null;
                    };
                    Img.prototype.set = function (pSrc) {
                        this.freeMemory();
                        this._iWidth = pSrc.width;
                        this._iHeight = pSrc.height;
                        this._iDepth = pSrc.depth;
                        this._eFormat = pSrc.format;
                        this._iFlags = pSrc.flags;
                        this._nMipMaps = pSrc.numMipMaps;
                        this._pBuffer = new Uint8Array(pSrc.getData());
                        return this;
                    };
                    Img.prototype.flipY = function (pDest) {
                        return this;
                    };
                    Img.prototype.flipX = function (pDest) {
                        return this;
                    };
                    Img.prototype.load = function (pData, sType, fnCallBack) {
                        var pMe = this;
                        if (pData instanceof HTMLCanvasElement) {
                            var pTempContext = pData.getContext('2d');
                            if (!pTempContext) {
                                if (((sType) != null)) {
                                    sType(false);
                                }
                                return this;
                            }
                            var pImageData = pTempContext.getImageData(0, 0, pData.width, pData.height);
                            this.loadDynamicImage(new Uint8Array(pImageData.data.buffer.slice(0, pImageData.data.buffer.byteLength)), pData.width, pData.height);
                            if (((sType) != null)) {
                                sType(true);
                            }
                            return this;
                        } else if ((typeof (pData) === "string")) {
                            var sExt = (new akra.Pathinfo(pData)).ext;
                            if (sExt == "png" || sExt == "jpg" || sExt == "jpeg" || sExt == "gif" || sExt == "bmp") {
                                var pImg = new Image();
                                pImg.onload = function () {
                                    var pTempCanvas = document.createElement("canvas");
                                    pTempCanvas.width = pImg.width;
                                    pTempCanvas.height = pImg.height;
                                    var pTempContext = ((pTempCanvas).getContext("2d"));
                                    pTempContext.drawImage(pImg, 0, 0);
                                    var pImageData = pTempContext.getImageData(0, 0, pImg.width, pImg.height);
                                    pMe.loadDynamicImage(new Uint8Array(pImageData.data.buffer.slice(0, pImageData.data.buffer.byteLength)), pImg.width, pImg.height, 1, akra.EPixelFormats.BYTE_ABGR);
                                    if (((sType) != null)) {
                                        sType(true);
                                    }
                                };
                                pImg.onerror = function () {
                                    if (((sType) != null)) {
                                        sType(false);
                                    }
                                };
                                pImg.onabort = function () {
                                    if (((sType) != null)) {
                                        sType(false);
                                    }
                                };
                                pImg.src = pData;
                            } else {
                                akra.io.fopen(pData, "rb").onread = function (pError, pDataInFile) {
                                    pMe.load(new Uint8Array(pDataInFile), sExt, sType);
                                };
                            }
                            return this;
                        } else {
                            var pCodec = undefined;
                            if (sType) {
                                pCodec = akra.Codec.getCodec(sType);
                            }
                            if (!pCodec) {
                                var iMagicLen = Math.min(32, pData.buffer.byteLength);
                                pCodec = akra.Codec.getCodec(pData.buffer.slice(0, iMagicLen));
                            }
                            if (!pCodec) {
 {
                                    akra.logger.setSourceLocation("resources/Img.ts", 286);
                                    akra.logger.criticalError("Unable to load image: Image format is unknown. Unable to identify codec. Check it or specify format explicitly.\n" + "Img.load");
                                }
                                ;
                                if (fnCallBack) {
                                    fnCallBack(false);
                                }
                                return this;
                            }
                            var pImgData = new akra.ImgData();
                            this._pBuffer = pCodec.decode(pData, pImgData);
                            this._iWidth = pImgData.width;
                            this._iHeight = pImgData.height;
                            this._iDepth = pImgData.depth;
                            this._nMipMaps = pImgData.numMipMaps;
                            this._iFlags = pImgData.flags;
                            this._iCubeFlags = pImgData.cubeFlags;
                            this._eFormat = pImgData.format;
                            this.notifyLoaded();
                            if (fnCallBack) {
                                fnCallBack(true);
                            }
                            return this;
                        }
                    };
                    Img.prototype.loadRawData = function (pData, iWidth, iHeight, iDepth, eFormat, nFaces, nMipMaps) {
                        if (typeof iDepth === "undefined") { iDepth = 1; }
                        if (typeof eFormat === "undefined") { eFormat = akra.EPixelFormats.BYTE_BGR; }
                        if (typeof nFaces === "undefined") { nFaces = 1; }
                        if (typeof nMipMaps === "undefined") { nMipMaps = 0; }
                        var iSize = Img.calculateSize(nMipMaps, nFaces, iWidth, iHeight, iDepth, eFormat);
                        if (iSize != pData.buffer.byteLength) {
 {
                                akra.logger.setSourceLocation("resources/Img.ts", 333);
                                akra.logger.criticalError("Stream size does not match calculated image size\n" + "Img.loadRawData");
                            }
                            ;
                        }
                        var pBuffer = new Uint8Array(iSize);
                        pBuffer.set(pData);
                        return this.loadDynamicImage(pBuffer, iWidth, iHeight, iDepth, eFormat, nFaces, nMipMaps);
                    };
                    Img.prototype.loadDynamicImage = function (pData, iWidth, iHeight, iDepth, eFormat, nFaces, nMipMaps) {
                        if (typeof iDepth === "undefined") { iDepth = 1; }
                        if (typeof eFormat === "undefined") { eFormat = akra.EPixelFormats.BYTE_BGR; }
                        if (typeof nFaces === "undefined") { nFaces = 1; }
                        if (typeof nMipMaps === "undefined") { nMipMaps = 0; }
                        this._iWidth = iWidth;
                        this._iHeight = iHeight;
                        this._iDepth = iDepth;
                        this._eFormat = eFormat;
                        this._nMipMaps = nMipMaps;
                        this._iFlags = 0;
                        if (akra.pixelUtil.isCompressed(this._eFormat)) {
                            this._iFlags |= akra.EImageFlags.COMPRESSED;
                        }
                        if (this._iDepth != 1) {
                            this._iFlags |= akra.EImageFlags.TEXTURE_3D;
                        }
                        if (nFaces == 6) {
                            this._iFlags |= akra.EImageFlags.CUBEMAP;
                        }
                        if (nFaces != 6 && nFaces != 1) {
 {
                                akra.logger.setSourceLocation("resources/Img.ts", 371);
                                akra.logger.criticalError("Number of faces currently must be 6 or 1.\n" + "Img.loadDynamicImage");
                            }
                            ;
                        }
                        this._pBuffer = pData;
                        this.notifyLoaded();
                        return this;
                    };
                    Img.prototype.convert = function (eFormat) {
                        return false;
                    };
                    Img.prototype.getRawSpan = function () {
                        return this._iWidth * this.getPixelSize();
                    };
                    Img.prototype.getBPP = function () {
                        return this.getPixelSize() * 8;
                    };
                    Img.prototype.getPixelSize = function () {
                        return akra.pixelUtil.getNumElemBytes(this._eFormat);
                    };
                    Img.prototype.getData = function () {
                        return this._pBuffer;
                    };
                    Img.prototype.hasFlag = function (eFlag) {
                        if (this._iFlags & eFlag) {
                            return true;
                        } else {
                            return false;
                        }
                    };
                    Img.prototype.hasAlpha = function () {
                        return akra.pixelUtil.hasAlpha(this._eFormat);
                    };
                    Img.prototype.isCompressed = function () {
                        return akra.pixelUtil.isCompressed(this._eFormat);
                    };
                    Img.prototype.isLuminance = function () {
                        return akra.pixelUtil.isLuminance(this._eFormat);
                    };
                    Img.prototype.getColorAt = function (pColor, x, y, z) {
                        if (typeof z === "undefined") { z = 0; }
                        var iStart = this.getPixelSize() * (z * this._iWidth * this._iHeight + this._iWidth * y + x);
                        akra.pixelUtil.unpackColour(pColor, this._eFormat, this._pBuffer.subarray(iStart, iStart + this.getPixelSize()));
                        return pColor;
                    };
                    Img.prototype.setColorAt = function (pColor, x, y, z) {
                        if (typeof z === "undefined") { z = 0; }
                        var iStart = this.getPixelSize() * (z * this._iWidth * this._iHeight + this._iWidth * y + x);
                        akra.pixelUtil.packColour(pColor, this._eFormat, this._pBuffer.subarray(iStart, iStart + this.getPixelSize()));
                    };
                    Img.prototype.getPixels = function (iFace, iMipMap) {
                        if (iMipMap > this.numMipMaps) {
 {
                                akra.logger.setSourceLocation("resources/Img.ts", 454);
                                akra.logger.warning("Mipmap index out of range", iMipMap, this.numMipMaps);
                            }
                            ;
                            return null;
                        }
                        if (iFace >= this.numFaces) {
 {
                                akra.logger.setSourceLocation("resources/Img.ts", 459);
                                akra.logger.warning("Face index out of range", iFace, this.numFaces);
                            }
                            ;
                            return null;
                        }
                        var pData = this.getData();
                        var iWidth = this._iWidth;
                        var iHeight = this._iHeight;
                        var iDepth = this._iDepth;
                        var iFullFaceSize = 0;
                        var iFinalFaceSize = 0;
                        var iFinalWidth = 0;
                        var iFinalHeight = 0;
                        var iFinalDepth = 0;
                        var iMipSize = 0;
                        var iOffset = 0;
                        for(var iMip = 0; iMip <= this.numMipMaps; ++iMip) {
                            if (iMip == iMipMap) {
                                iFinalFaceSize = iFullFaceSize;
                                iFinalWidth = iWidth;
                                iFinalHeight = iHeight;
                                iFinalDepth = iDepth;
                                iMipSize = akra.pixelUtil.getMemorySize(iWidth, iHeight, iDepth, this.format);
                            }
                            iFullFaceSize += akra.pixelUtil.getMemorySize(iWidth, iHeight, iDepth, this.format);
                            if (iWidth != 1) {
                                iWidth /= 2;
                            }
                            if (iHeight != 1) {
                                iHeight /= 2;
                            }
                            if (iDepth != 1) {
                                iDepth /= 2;
                            }
                        }
                        iOffset += iFace * iFullFaceSize;
                        iOffset += iFinalFaceSize;
                        var pSrc = new akra.pixelUtil.PixelBox(iFinalWidth, iFinalHeight, iFinalDepth, this.format, pData.subarray(iOffset, iOffset + iMipSize));
                        return pSrc;
                    };
                    Img.prototype.scale = function (pDest, eFilter) {
                        return null;
                    };
                    Img.prototype.resize = function (iWidth, iHeight, eFilter) {
                        return null;
                    };
                    Img.prototype.generatePerlinNoise = function (fScale, iOctaves, fFalloff) {
                    };
                    Img.prototype.randomChannelNoise = function (iChannel, iMinRange, iMaxRange) {
                    };
                    Img.calculateSize = function calculateSize(nMipMaps, nFaces, iWidth, iHeight, iDepth, eFormat) {
                        var iSize = 0;
                        var iMip = 0;
                        for(iMip = 0; iMip <= nMipMaps; iMip++) {
                            iSize += akra.pixelUtil.getMemorySize(iWidth, iHeight, iDepth, eFormat) * nFaces;
                            if (iWidth != 1) {
                                iWidth = Math.floor(iWidth / 2);
                            }
                            if (iHeight != 1) {
                                iHeight = Math.floor(iHeight / 2);
                            }
                            if (iDepth != 1) {
                                iDepth = Math.floor(iDepth / 2);
                            }
                        }
                        return iSize;
                    };
                    Img.getMaxMipmaps = function getMaxMipmaps(iWidth, iHeight, iDepth, eFormat) {
                        var iCount = 0;
                        if ((iWidth > 0) && (iHeight > 0)) {
                            do {
                                if (iWidth > 1) {
                                    iWidth = iWidth >>> 1;
                                }
                                if (iHeight > 1) {
                                    iHeight = iHeight >>> 1;
                                }
                                if (iDepth > 1) {
                                    iDepth = iDepth >>> 1;
                                }
                                iCount++;
                            } while(!(iWidth === 1 && iHeight === 1 && iDepth === 1));
                        }
                        return iCount;
                    };
                    return Img;
                })(pool.ResourcePoolItem);
                resources.Img = Img;                
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                var Component = (function (_super) {
                    __extends(Component, _super);
                    function Component() {
                                        _super.call(this);
                        this._pTechnique = null;
                        this._pComposer = null;
                    }
                    Component.prototype.create = function () {
                        this._pComposer = this.manager.getEngine().getComposer();
                    };
                    Component.prototype.getTechnique = function () {
                        return this._pTechnique;
                    };
                    Component.prototype.setTechnique = function (pTechnique) {
                        this._pTechnique = pTechnique;
                    };
                    Component.prototype.getName = function () {
                        return this._pTechnique.getName();
                    };
                    Component.prototype.getTotalPasses = function () {
                        return this._pTechnique.totalOwnPasses();
                    };
                    Component.prototype.getHash = function (iShift, iPass) {
                        return this.getGuid() + ">" + iShift.toString() + ">" + (iPass === 0xffffff ? "A" : iPass.toString());
                    };
                    return Component;
                })(pool.ResourcePoolItem);
                resources.Component = Component;                
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    (function (ERenderDataTypes) {
        ERenderDataTypes._map = [];
        ERenderDataTypes.ISOLATED = 0;
        ERenderDataTypes._map[1] = "INDEXED";
        ERenderDataTypes.INDEXED = 1;
        ERenderDataTypes._map[2] = "I2I";
        ERenderDataTypes.I2I = 2;
        ERenderDataTypes._map[3] = "DIRECT";
        ERenderDataTypes.DIRECT = 3;
    })(akra.ERenderDataTypes || (akra.ERenderDataTypes = {}));
    var ERenderDataTypes = akra.ERenderDataTypes;
    ;
    (function (ERenderDataOptions) {
        ERenderDataOptions._map = [];
        ERenderDataOptions.ADVANCED_INDEX = (1 << (0x10));
        ERenderDataOptions.SINGLE_INDEX = (1 << (0x11));
        ERenderDataOptions.RENDERABLE = (1 << (0x12));
    })(akra.ERenderDataOptions || (akra.ERenderDataOptions = {}));
    var ERenderDataOptions = akra.ERenderDataOptions;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    (function (EMeshOptions) {
        EMeshOptions._map = [];
        EMeshOptions.HB_READABLE = akra.EHardwareBufferFlags.READABLE;
        EMeshOptions.RD_ADVANCED_INDEX = akra.ERenderDataOptions.ADVANCED_INDEX;
    })(akra.EMeshOptions || (akra.EMeshOptions = {}));
    var EMeshOptions = akra.EMeshOptions;
    ;
    (function (EMeshCloneOptions) {
        EMeshCloneOptions._map = [];
        EMeshCloneOptions.GEOMETRY_ONLY = 0x00;
        EMeshCloneOptions.SHARED_GEOMETRY = 0x01;
    })(akra.EMeshCloneOptions || (akra.EMeshCloneOptions = {}));
    var EMeshCloneOptions = akra.EMeshCloneOptions;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    ;
    (function (ERenderDataBufferOptions) {
        ERenderDataBufferOptions._map = [];
        ERenderDataBufferOptions.VB_READABLE = akra.EHardwareBufferFlags.READABLE;
        ERenderDataBufferOptions.RD_ADVANCED_INDEX = akra.ERenderDataOptions.ADVANCED_INDEX;
        ERenderDataBufferOptions.RD_SINGLE_INDEX = akra.ERenderDataOptions.SINGLE_INDEX;
        ERenderDataBufferOptions.RD_RENDERABLE = akra.ERenderDataOptions.RENDERABLE;
    })(akra.ERenderDataBufferOptions || (akra.ERenderDataBufferOptions = {}));
    var ERenderDataBufferOptions = akra.ERenderDataBufferOptions;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    (function (EEntityTypes) {
        EEntityTypes._map = [];
        EEntityTypes._map[0] = "UNKNOWN";
        EEntityTypes.UNKNOWN = 0;
        EEntityTypes._map[1] = "NODE";
        EEntityTypes.NODE = 1;
        EEntityTypes._map[2] = "JOINT";
        EEntityTypes.JOINT = 2;
        EEntityTypes._map[3] = "SCENE_NODE";
        EEntityTypes.SCENE_NODE = 3;
        EEntityTypes._map[4] = "CAMERA";
        EEntityTypes.CAMERA = 4;
        EEntityTypes._map[5] = "SHADOW_CASTER";
        EEntityTypes.SHADOW_CASTER = 5;
        EEntityTypes._map[6] = "MODEL_ENTRY";
        EEntityTypes.MODEL_ENTRY = 6;
        EEntityTypes.LIGHT = 37;
        EEntityTypes.SCENE_OBJECT = 64;
        EEntityTypes._map[65] = "MODEL";
        EEntityTypes.MODEL = 65;
        EEntityTypes._map[66] = "TERRAIN";
        EEntityTypes.TERRAIN = 66;
        EEntityTypes._map[67] = "TERRAIN_ROAM";
        EEntityTypes.TERRAIN_ROAM = 67;
        EEntityTypes._map[68] = "TERRAIN_SECTION";
        EEntityTypes.TERRAIN_SECTION = 68;
        EEntityTypes._map[69] = "TERRAIN_SECTION_ROAM";
        EEntityTypes.TERRAIN_SECTION_ROAM = 69;
        EEntityTypes._map[70] = "TEXT3D";
        EEntityTypes.TEXT3D = 70;
        EEntityTypes._map[71] = "SPRITE";
        EEntityTypes.SPRITE = 71;
        EEntityTypes._map[72] = "EMITTER";
        EEntityTypes.EMITTER = 72;
        EEntityTypes.UI_NODE = 100;
        EEntityTypes.OBJECTS_LIMIT = 128;
    })(akra.EEntityTypes || (akra.EEntityTypes = {}));
    var EEntityTypes = akra.EEntityTypes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    (function (ENodeInheritance) {
        ENodeInheritance._map = [];
        ENodeInheritance.POSITION = 0;
        ENodeInheritance._map[1] = "ROTSCALE";
        ENodeInheritance.ROTSCALE = 1;
        ENodeInheritance._map[2] = "ALL";
        ENodeInheritance.ALL = 2;
    })(akra.ENodeInheritance || (akra.ENodeInheritance = {}));
    var ENodeInheritance = akra.ENodeInheritance;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        (function (EEntityStates) {
            EEntityStates._map = [];
            EEntityStates.k_Updated = 0x01;
            EEntityStates.k_DescendantsUpdtated = 0x02;
            EEntityStates.k_SiblingsUpdated = 0x04;
        })(util.EEntityStates || (util.EEntityStates = {}));
        var EEntityStates = util.EEntityStates;
        var Entity = (function (_super) {
            __extends(Entity, _super);
            function Entity(eType) {
                        _super.call(this);
                this._sName = null;
                this._pParent = null;
                this._pSibling = null;
                this._pChild = null;
                this._eType = akra.EEntityTypes.UNKNOWN;
                this._iStateFlags = 0;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._eType = eType;
            }
            Object.defineProperty(Entity.prototype, "name", {
                get: function () {
                    return this._sName;
                },
                set: function (sName) {
                    this._sName = sName;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Entity.prototype, "parent", {
                get: function () {
                    return this._pParent;
                },
                set: function (pParent) {
                    this.attachToParent(pParent);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Entity.prototype, "sibling", {
                get: function () {
                    return this._pSibling;
                },
                set: function (pSibling) {
                    this._pSibling = pSibling;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Entity.prototype, "child", {
                get: function () {
                    return this._pChild;
                },
                set: function (pChild) {
                    this._pChild = pChild;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Entity.prototype, "type", {
                get: function () {
                    return this._eType;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Entity.prototype, "rightSibling", {
                get: function () {
                    var pSibling = this.sibling;
                    if (pSibling) {
                        while(pSibling.sibling) {
                            pSibling = pSibling.sibling;
                        }
                        return pSibling;
                    }
                    return this;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Entity.prototype, "depth", {
                get: function () {
                    var iDepth = -1;
                    for(var pEntity = this; pEntity; pEntity = pEntity.parent, ++iDepth) {
                    }
                    ;
                    return iDepth;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Entity.prototype, "root", {
                get: function () {
                    for(var pEntity = this, iDepth = -1; pEntity.parent; pEntity = pEntity.parent, ++iDepth) {
                    }
                    ;
                    return pEntity;
                },
                enumerable: true,
                configurable: true
            });
            Entity.prototype.destroy = function (bRecursive, bPromoteChildren) {
                if (typeof bRecursive === "undefined") { bRecursive = false; }
                if (typeof bPromoteChildren === "undefined") { bPromoteChildren = true; }
                if (bRecursive) {
                    if (this._pSibling) {
                        this._pSibling.destroy(true);
                    }
                    if (this._pChild) {
                        this._pChild.destroy(true);
                    }
                }
                if (bPromoteChildren && !bRecursive) {
                    this.promoteChildren();
                }
                this.detachFromParent();
 {
                    util.logger.setSourceLocation("util/Entity.ts", 93);
                    util.logger.assert(this.referenceCount() == 0, "Attempting to delete a scene node which is still in use");
                }
                ;
 {
                    util.logger.setSourceLocation("util/Entity.ts", 94);
                    util.logger.assert(this._pSibling == null, "Failure Destroying Node");
                }
                ;
 {
                    util.logger.setSourceLocation("util/Entity.ts", 95);
                    util.logger.assert(this._pChild == null, "Failure Destroying Node");
                }
                ;
            };
            Entity.prototype.findEntity = function (sName) {
                var pEntity = null;
                if (this._sName === sName) {
                    return this;
                }
                if (this._pSibling) {
                    pEntity = this._pSibling.findEntity(sName);
                }
                if (pEntity == null && this._pChild) {
                    pEntity = this._pChild.findEntity(sName);
                }
                return pEntity;
            };
            Entity.prototype.explore = function (fn) {
                if (fn(this) === false) {
                    return;
                }
                if (this._pSibling) {
                    this._pSibling.explore(fn);
                }
                if (this._pChild) {
                    this._pChild.explore(fn);
                }
            };
            Entity.prototype.childOf = function (pParent) {
                for(var pEntity = this; pEntity; pEntity = pEntity.parent) {
                    if (pEntity.parent === pParent) {
                        return true;
                    }
                }
                return false;
            };
            Entity.prototype.children = function () {
                var pChildren = [];
                var pChild = this.child;
                while(!((pChild) === null)) {
                    pChildren.push(pChild);
                    pChild = pChild.sibling;
                }
                return pChildren;
            };
            Entity.prototype.childAt = function (i) {
                var pChild = this.child;
                var n = 0;
                while(!((pChild) === null)) {
                    if (n == i) {
                        return pChild;
                    }
                    n++;
                    pChild = pChild.sibling;
                }
                return pChild;
            };
            Entity.prototype.siblingCount = function () {
                var iCount = 0;
                if (this._pParent) {
                    var pNextSibling = this._pParent.child;
                    if (pNextSibling) {
                        while(pNextSibling) {
                            pNextSibling = pNextSibling.sibling;
                            ++iCount;
                        }
                    }
                }
                return iCount;
            };
            Entity.prototype.descCount = function () {
                var n = this.childCount();
                var pChild = this.child;
                while(!((pChild) === null)) {
                    n += pChild.descCount();
                    pChild = pChild.sibling;
                }
                return n;
            };
            Entity.prototype.childCount = function () {
                var iCount = 0;
                var pChild = this.child;
                while(!((pChild) === null)) {
                    iCount++;
                    pChild = pChild.sibling;
                }
                return iCount;
            };
            Entity.prototype.isUpdated = function () {
                return (((this._iStateFlags) & (EEntityStates.k_Updated)) == (EEntityStates.k_Updated));
            };
            Entity.prototype.hasUpdatedSubNodes = function () {
                return (((this._iStateFlags) & (EEntityStates.k_DescendantsUpdtated)) == (EEntityStates.k_DescendantsUpdtated));
            };
            Entity.prototype.recursiveUpdate = function () {
                if (this.update()) {
                    ((this._iStateFlags) |= (EEntityStates.k_Updated));
                }
                if (this._pSibling && this._pSibling.recursiveUpdate()) {
                    ((this._iStateFlags) |= (EEntityStates.k_SiblingsUpdated));
                }
                if (this._pChild && this._pChild.recursiveUpdate()) {
                    ((this._iStateFlags) |= (EEntityStates.k_DescendantsUpdtated));
                }
                return (this._iStateFlags != 0);
            };
            Entity.prototype.recursivePreUpdate = function () {
                this.prepareForUpdate();
                if (this._pSibling) {
                    this._pSibling.recursivePreUpdate();
                }
                if (this._pChild) {
                    this._pChild.recursivePreUpdate();
                }
            };
            Entity.prototype.prepareForUpdate = function () {
                this._iStateFlags = 0;
            };
            Entity.prototype.hasParent = function () {
                return ((this._pParent) != null);
            };
            Entity.prototype.hasChild = function () {
                return ((this._pChild) != null);
            };
            Entity.prototype.hasSibling = function () {
                return ((this._pSibling) != null);
            };
            Entity.prototype.isASibling = function (pSibling) {
                if (!pSibling) {
                    return false;
                }
                if (this == pSibling || this._pSibling == pSibling) {
                    return true;
                }
                if (this._pSibling) {
                    return this._pSibling.isASibling(pSibling);
                }
                return false;
            };
            Entity.prototype.isAChild = function (pChild) {
                if (!pChild) {
                    return (false);
                }
                if (this._pChild == pChild) {
                    return (true);
                }
                if (this._pChild) {
                    return (this._pChild.isASibling(pChild));
                }
                return (false);
            };
            Entity.prototype.isInFamily = function (pEntity, bSearchEntireTree) {
                if (!pEntity) {
                    return (false);
                }
                if (this == pEntity || this._pChild == pEntity || this._pSibling == pEntity) {
                    return (true);
                }
                if (!bSearchEntireTree) {
                    if (this.isASibling(pEntity)) {
                        return (true);
                    }
                    if (this._pChild && this._pChild.isASibling(pEntity)) {
                        return (true);
                    }
                } else {
                    if (this._pSibling && this._pSibling.isInFamily(pEntity, bSearchEntireTree)) {
                        return (true);
                    }
                    if (this._pChild && this._pChild.isInFamily(pEntity, bSearchEntireTree)) {
                        return (true);
                    }
                }
                return (false);
            };
            Entity.prototype.addSibling = function (pSibling) {
                if (pSibling) {
                    pSibling.sibling = this._pSibling;
                    this.sibling = pSibling;
                }
                return pSibling;
            };
            Entity.prototype.addChild = function (pChild) {
                if (pChild) {
                    pChild.sibling = this._pChild;
                    this._pChild = pChild;
                    this.childAdded(pChild);
                }
                return pChild;
            };
            Entity.prototype.removeChild = function (pChild) {
                if (this._pChild && pChild) {
                    if (this._pChild == pChild) {
                        this._pChild = pChild.sibling;
                        pChild.sibling = null;
                    } else {
                        var pTempNode = this._pChild;
                        while(pTempNode && (pTempNode.sibling != pChild)) {
                            pTempNode = pTempNode.sibling;
                        }
                        if (pTempNode) {
                            pTempNode.sibling = pChild.sibling;
                            pChild.sibling = null;
                        }
                    }
                    this.childRemoved(pChild);
                }
                return pChild;
            };
            Entity.prototype.removeAllChildren = function () {
                while(!((this._pChild) === null)) {
                    var pNextSibling = this._pChild.sibling;
                    this._pChild.detachFromParent();
                    this._pChild = pNextSibling;
                }
            };
            Entity.prototype.attachToParent = function (pParent) {
                var pParentPrev = this.parent;
                if (pParent != this._pParent) {
                    this.detachFromParent();
                    if (pParent) {
                        if (pParent.addChild(this)) {
                            this._pParent = pParent;
                            this._pParent.addRef();
                            this.attached();
                            return true;
                        }
                        return this.attachToParent(pParentPrev);
                    }
                }
                return false;
            };
            Entity.prototype.detachFromParent = function () {
                if (this._pParent) {
                    this._pParent.removeChild(this);
                    if (this._pParent) {
                        this._pParent.release();
                    }
                    this._pParent = null;
                    this.detached();
                    return true;
                }
                return false;
            };
            Entity.prototype.promoteChildren = function () {
                while(!((this._pChild) === null)) {
                    var pNextSibling = this._pChild.sibling;
                    this._pChild.attachToParent(this._pParent);
                    this._pChild = pNextSibling;
                }
            };
            Entity.prototype.relocateChildren = function (pParent) {
                if (pParent != this) {
                    while(!((this._pChild) === null)) {
                        var pNextSibling = this._pChild.sibling;
                        this._pChild.attachToParent(pParent);
                        this._pChild = pNextSibling;
                    }
                }
            };
            Entity.prototype.update = function () {
                return false;
            };
            Entity.prototype.toString = function (isRecursive, iDepth) {
                if (typeof isRecursive === "undefined") { isRecursive = false; }
                if (typeof iDepth === "undefined") { iDepth = 0; }
                if (!isRecursive) {
                    return '<entity' + (this._sName ? ' ' + this._sName : "") + '>';
                }
                var pSibling = this.sibling;
                var pChild = this.child;
                var s = "";
                for(var i = 0; i < iDepth; ++i) {
                    s += ':  ';
                }
                s += '+----[depth: ' + this.depth + ']' + this.toString() + '\n';
                if (pChild) {
                    s += pChild.toString(true, iDepth + 1);
                }
                if (pSibling) {
                    s += pSibling.toString(true, iDepth);
                }
                return s;
            };
            Entity.prototype.getGuid = function () {
                return this._iGuid;
            };
            Entity._pEventTable = new akra.events.EventTable();
            Entity.prototype.getEventTable = function () {
                return Entity._pEventTable;
            };
            Entity.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Entity.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Entity.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Entity.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Entity.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            Entity.prototype.attached = function () {
                var _recivier = this;
                this._pUnicastSlotMap = this._pUnicastSlotMap || (this.getEventTable()).findUnicastList(this._iGuid);
                var _unicast = (this._pUnicastSlotMap).attached;
                if (((_unicast) !== undefined)) {
                    _unicast.target ? _unicast.target[_unicast.callback](_recivier) : _unicast.listener(_recivier);
                }
            };
            Entity.prototype.detached = function () {
                var _recivier = this;
                this._pUnicastSlotMap = this._pUnicastSlotMap || (this.getEventTable()).findUnicastList(this._iGuid);
                var _unicast = (this._pUnicastSlotMap).detached;
                if (((_unicast) !== undefined)) {
                    _unicast.target ? _unicast.target[_unicast.callback](_recivier) : _unicast.listener(_recivier);
                }
            };
            Entity.prototype.childAdded = function (child) {
                var _recivier = this;
                this._pUnicastSlotMap = this._pUnicastSlotMap || (this.getEventTable()).findUnicastList(this._iGuid);
                var _unicast = (this._pUnicastSlotMap).childAdded;
                if (((_unicast) !== undefined)) {
                    _unicast.target ? _unicast.target[_unicast.callback](_recivier, child) : _unicast.listener(_recivier, child);
                }
            };
            Entity.prototype.childRemoved = function (child) {
                var _recivier = this;
                this._pUnicastSlotMap = this._pUnicastSlotMap || (this.getEventTable()).findUnicastList(this._iGuid);
                var _unicast = (this._pUnicastSlotMap).childRemoved;
                if (((_unicast) !== undefined)) {
                    _unicast.target ? _unicast.target[_unicast.callback](_recivier, child) : _unicast.listener(_recivier, child);
                }
            };
            return Entity;
        })(util.ReferenceCounter);
        util.Entity = Entity;        
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        (function (ENodeUpdateFlags) {
            ENodeUpdateFlags._map = [];
            ENodeUpdateFlags.k_SetForDestruction = 0;
            ENodeUpdateFlags._map[1] = "k_NewOrientation";
            ENodeUpdateFlags.k_NewOrientation = 1;
            ENodeUpdateFlags._map[2] = "k_NewWorldMatrix";
            ENodeUpdateFlags.k_NewWorldMatrix = 2;
            ENodeUpdateFlags._map[3] = "k_NewLocalMatrix";
            ENodeUpdateFlags.k_NewLocalMatrix = 3;
            ENodeUpdateFlags._map[4] = "k_RebuildInverseWorldMatrix";
            ENodeUpdateFlags.k_RebuildInverseWorldMatrix = 4;
            ENodeUpdateFlags._map[5] = "k_RebuildNormalMatrix";
            ENodeUpdateFlags.k_RebuildNormalMatrix = 5;
        })(scene.ENodeUpdateFlags || (scene.ENodeUpdateFlags = {}));
        var ENodeUpdateFlags = scene.ENodeUpdateFlags;
        ;
        var Node = (function (_super) {
            __extends(Node, _super);
            function Node() {
                _super.apply(this, arguments);

                this._m4fLocalMatrix = null;
                this._m4fWorldMatrix = null;
                this._m4fInverseWorldMatrix = null;
                this._m3fNormalMatrix = null;
                this._v3fWorldPosition = null;
                this._qRotation = null;
                this._v3fTranslation = null;
                this._v3fScale = null;
                this._iUpdateFlags = 0;
                this._eInheritance = akra.ENodeInheritance.POSITION;
            }
            Node.prototype.create = function () {
                return true;
            };
            Object.defineProperty(Node.prototype, "localOrientation", {
                get: function () {
                    return this._qRotation;
                },
                set: function (qOrient) {
                    ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
                    this._qRotation.set(qOrient);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Node.prototype, "localPosition", {
                get: function () {
                    return this._v3fTranslation;
                },
                set: function (v3fPosition) {
                    ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
                    this._v3fTranslation.set(v3fPosition);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Node.prototype, "localScale", {
                get: function () {
                    return this._v3fScale;
                },
                set: function (v3fScale) {
                    ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
                    this._v3fScale.set(v3fScale);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Node.prototype, "localMatrix", {
                get: function () {
                    return this._m4fLocalMatrix;
                },
                set: function (m4fLocalMatrix) {
                    ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewLocalMatrix)));
                    this._m4fLocalMatrix.set(m4fLocalMatrix);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Node.prototype, "worldMatrix", {
                get: function () {
                    return this._m4fWorldMatrix;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Node.prototype, "worldPosition", {
                get: function () {
                    return this._v3fWorldPosition;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Node.prototype, "inverseWorldMatrix", {
                get: function () {
                    if (((this._iUpdateFlags & (1 << (ENodeUpdateFlags.k_RebuildInverseWorldMatrix))) != 0)) {
                        this._m4fWorldMatrix.inverse(this._m4fInverseWorldMatrix);
                        ((this._iUpdateFlags) &= ~(1 << (ENodeUpdateFlags.k_RebuildInverseWorldMatrix)));
                    }
                    return this._m4fInverseWorldMatrix;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Node.prototype, "normalMatrix", {
                get: function () {
                    if (((this._iUpdateFlags & (1 << (ENodeUpdateFlags.k_RebuildNormalMatrix))) != 0)) {
                        this._m4fWorldMatrix.toMat3(this._m3fNormalMatrix).inverse().transpose();
                        ((this._iUpdateFlags) &= ~(1 << (ENodeUpdateFlags.k_RebuildNormalMatrix)));
                    }
                    return this._m3fNormalMatrix;
                },
                enumerable: true,
                configurable: true
            });
            Node.prototype.update = function () {
                return this.recalcWorldMatrix();
            };
            Node.prototype.prepareForUpdate = function () {
                _super.prototype.prepareForUpdate.call(this);
                ((this._iUpdateFlags) &= ~((1 << (ENodeUpdateFlags.k_NewLocalMatrix)) | (1 << (ENodeUpdateFlags.k_NewOrientation)) | (1 << (ENodeUpdateFlags.k_NewWorldMatrix))));
            };
            Node.prototype.setInheritance = function (eInheritance) {
                this._eInheritance = eInheritance;
            };
            Node.prototype.getInheritance = function () {
                return this._eInheritance;
            };
            Node.prototype.isWorldMatrixNew = function () {
                return ((this._iUpdateFlags & (1 << (ENodeUpdateFlags.k_NewWorldMatrix))) != 0);
            };
            Node.prototype.isLocalMatrixNew = function () {
                return ((this._iUpdateFlags & (1 << (ENodeUpdateFlags.k_NewLocalMatrix))) != 0);
            };
            Node.prototype.recalcWorldMatrix = function () {
                var isParentMoved = this._pParent && (this._pParent).isWorldMatrixNew();
                var isOrientModified = ((this._iUpdateFlags & (1 << (ENodeUpdateFlags.k_NewOrientation))) != 0);
                var isLocalModified = ((this._iUpdateFlags & (1 << (ENodeUpdateFlags.k_NewLocalMatrix))) != 0);
                if (isOrientModified || isParentMoved || isLocalModified) {
                    var m4fLocal = this._m4fLocalMatrix;
                    var m4fWorld = this._m4fWorldMatrix;
                    var m4fOrient = Node._m4fTemp;
                    var v3fTemp = Node._v3fTemp;
                    var pWorldData = m4fWorld.data;
                    var pOrientData = m4fOrient.data;
                    this._qRotation.toMat4(m4fOrient);
                    m4fOrient.setTranslation(this._v3fTranslation);
                    m4fOrient.scaleLeft(this._v3fScale);
                    m4fOrient.multiply(m4fLocal);
                    if (this._pParent) {
                        var m4fParent = (this._pParent).worldMatrix;
                        var pParentData = m4fParent.data;
                        if (this._eInheritance === akra.ENodeInheritance.ALL) {
                            m4fParent.multiply(m4fOrient, m4fWorld);
                        } else if (this._eInheritance === akra.ENodeInheritance.POSITION) {
                            m4fWorld.set(m4fOrient);
                            pWorldData[12] = pParentData[12] + pOrientData[12];
                            pWorldData[13] = pParentData[13] + pOrientData[13];
                            pWorldData[14] = pParentData[14] + pOrientData[14];
                        } else if (this._eInheritance === akra.ENodeInheritance.ROTSCALE) {
                            var p11 = pParentData[0], p12 = pParentData[4], p13 = pParentData[8];
                            var p21 = pParentData[1], p22 = pParentData[5], p23 = pParentData[9];
                            var p31 = pParentData[2], p32 = pParentData[6], p33 = pParentData[10];
                            var l11 = pOrientData[0], l12 = pOrientData[4], l13 = pOrientData[8];
                            var l21 = pOrientData[1], l22 = pOrientData[5], l23 = pOrientData[9];
                            var l31 = pOrientData[2], l32 = pOrientData[6], l33 = pOrientData[10];
                            pWorldData[0] = p11 * l11 + p12 * l21 + p13 * l31;
                            pWorldData[4] = p11 * l12 + p12 * l22 + p13 * l32;
                            pWorldData[8] = p11 * l13 + p12 * l23 + p13 * l33;
                            pWorldData[12] = pOrientData[12];
                            pWorldData[1] = p21 * l11 + p22 * l21 + p23 * l31;
                            pWorldData[5] = p21 * l12 + p22 * l22 + p23 * l32;
                            pWorldData[9] = p21 * l13 + p22 * l23 + p23 * l33;
                            pWorldData[13] = pOrientData[13];
                            pWorldData[2] = p31 * l11 + p32 * l21 + p33 * l31;
                            pWorldData[6] = p31 * l12 + p32 * l22 + p33 * l32;
                            pWorldData[10] = p31 * l13 + p32 * l23 + p33 * l33;
                            pWorldData[14] = pOrientData[14];
                            pWorldData[3] = pOrientData[3];
                            pWorldData[7] = pOrientData[7];
                            pWorldData[11] = pOrientData[11];
                            pWorldData[15] = pOrientData[15];
                        }
                    } else {
                        m4fWorld.set(m4fOrient);
                    }
                    this._v3fWorldPosition.x = pWorldData[12];
                    this._v3fWorldPosition.y = pWorldData[13];
                    this._v3fWorldPosition.z = pWorldData[14];
                    ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewWorldMatrix)));
                    ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_RebuildInverseWorldMatrix)));
                    ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_RebuildNormalMatrix)));
                    return true;
                }
                return false;
            };
            Node.prototype.setPosition = function (fX, fY, fZ) {
                var pPos = arguments.length === 1 ? arguments[0] : akra.vec3(fX, fY, fZ);
                var v3fTranslation = this._v3fTranslation;
                v3fTranslation.set(pPos);
                ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
            };
            Node.prototype.addPosition = function (fX, fY, fZ) {
                var pPos = arguments.length === 1 ? arguments[0] : akra.vec3(fX, fY, fZ);
                var v3fTranslation = this._v3fTranslation;
                v3fTranslation.add(pPos);
                ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
            };
            Node.prototype.addRelPosition = function (fX, fY, fZ) {
                var pPos = arguments.length === 1 ? arguments[0] : akra.vec3(fX, fY, fZ);
                var v3fTranslation = this._v3fTranslation;
                this._qRotation.multiplyVec3(pPos);
                v3fTranslation.add(pPos);
                ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
            };
            Node.prototype.setRotationByMatrix = function (matrix) {
                matrix.toQuat4(this._qRotation);
                ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
            };
            Node.prototype.setRotationByAxisAngle = function (v3fAxis, fAngle) {
                akra.Quat4.fromAxisAngle(v3fAxis, fAngle, this._qRotation);
                ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
            };
            Node.prototype.setRotationByForwardUp = function (v3fForward, v3fUp) {
                akra.Quat4.fromForwardUp(v3fForward, v3fUp, this._qRotation);
                ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
            };
            Node.prototype.setRotationByEulerAngles = function (fYaw, fPitch, fRoll) {
                akra.Quat4.fromYawPitchRoll(fYaw, fPitch, fRoll, this._qRotation);
                ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
            };
            Node.prototype.setRotationByXYZAxis = function (fX, fY, fZ) {
                akra.Quat4.fromYawPitchRoll(fY, fX, fZ, this._qRotation);
                ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
            };
            Node.prototype.setRotation = function (q4fRotation) {
                this._qRotation.set(q4fRotation);
                ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
            };
            Node.prototype.addRelRotationByMatrix = function (matrix) {
                this.addRelRotation(arguments[0].toQuat4(Node._q4fTemp));
            };
            Node.prototype.addRelRotationByAxisAngle = function (v3fAxis, fAngle) {
                this.addRelRotation(akra.Quat4.fromAxisAngle(v3fAxis, fAngle, Node._q4fTemp));
            };
            Node.prototype.addRelRotationByForwardUp = function (v3fForward, v3fUp) {
                this.addRelRotation(akra.Quat4.fromForwardUp(v3fForward, v3fUp, Node._q4fTemp));
            };
            Node.prototype.addRelRotationByEulerAngles = function (fYaw, fPitch, fRoll) {
                this.addRelRotation(akra.Quat4.fromYawPitchRoll(fYaw, fPitch, fRoll, Node._q4fTemp));
            };
            Node.prototype.addRelRotationByXYZAxis = function (fX, fY, fZ) {
                this.addRelRotation(akra.Quat4.fromYawPitchRoll(fY, fX, fZ, Node._q4fTemp));
            };
            Node.prototype.addRelRotation = function (q4fRotation) {
                this._qRotation.multiply(q4fRotation);
                ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
            };
            Node.prototype.addRotationByMatrix = function (matrix) {
                this.addRotation(arguments[0].toQuat4(Node._q4fTemp));
            };
            Node.prototype.addRotationByAxisAngle = function (v3fAxis, fAngle) {
                this.addRotation(akra.Quat4.fromAxisAngle(v3fAxis, fAngle, Node._q4fTemp));
            };
            Node.prototype.addRotationByForwardUp = function (v3fForward, v3fUp) {
                this.addRotation(akra.Quat4.fromForwardUp(v3fForward, v3fUp, Node._q4fTemp));
            };
            Node.prototype.addRotationByEulerAngles = function (fYaw, fPitch, fRoll) {
                this.addRotation(akra.Quat4.fromYawPitchRoll(fYaw, fPitch, fRoll, Node._q4fTemp));
            };
            Node.prototype.addRotationByXYZAxis = function (fX, fY, fZ) {
                this.addRotation(akra.Quat4.fromYawPitchRoll(fY, fX, fZ, Node._q4fTemp));
            };
            Node.prototype.addRotation = function (q4fRotation) {
                q4fRotation.multiplyVec3(this._v3fTranslation);
                q4fRotation.multiply(this._qRotation, this._qRotation);
                ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
            };
            Node.prototype.scale = function (fX, fY, fZ) {
                var pScale = arguments.length === 1 ? ((typeof (arguments[0]) === "number") ? akra.vec3(fX) : arguments[0]) : akra.vec3(fX, fY, fZ);
                var v3fScale = this._v3fScale;
                v3fScale.scale(pScale);
                ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewOrientation)));
            };
            Node.prototype.attachToParent = function (pParent) {
                if (_super.prototype.attachToParent.call(this, pParent)) {
                    var m4fInvertedParentMatrix = akra.mat4();
                    (this._pParent)._m4fWorldMatrix.inverse(m4fInvertedParentMatrix);
                    ((this._iUpdateFlags) |= (1 << (ENodeUpdateFlags.k_NewWorldMatrix)));
                    return true;
                }
                return false;
            };
            Node.prototype.detachFromParent = function () {
                if (_super.prototype.detachFromParent.call(this)) {
                    this._m4fWorldMatrix.identity();
                    return true;
                }
                return false;
            };
            Node.prototype.toString = function (isRecursive, iDepth) {
                if (typeof isRecursive === "undefined") { isRecursive = false; }
                if (typeof iDepth === "undefined") { iDepth = 0; }
                if (!isRecursive) {
                    return '<node' + (this.name ? " " + this.name : "") + '>';
                }
                var pSibling = this.sibling;
                var pChild = this.child;
                var s = "";
                for(var i = 0; i < iDepth; ++i) {
                    s += ':  ';
                }
                s += '+----[depth: ' + this.depth + ']' + this.toString() + '\n';
                if (pChild) {
                    s += pChild.toString(true, iDepth + 1);
                }
                if (pSibling) {
                    s += pSibling.toString(true, iDepth);
                }
                return s;
            };
            Node._v3fTemp = akra.vec3();
            Node._v4fTemp = akra.vec4();
            Node._m3fTemp = akra.mat3();
            Node._m4fTemp = akra.mat4();
            Node._q4fTemp = akra.quat4();
            return Node;
        })(akra.util.Entity);
        scene.Node = Node;        
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        var SceneNode = (function (_super) {
            __extends(SceneNode, _super);
            function SceneNode(pScene, eType) {
                if (typeof eType === "undefined") { eType = akra.EEntityTypes.SCENE_NODE; }
                        _super.call(this, eType);
                this._pScene = null;
                this.scene = pScene;
            }
            Object.defineProperty(SceneNode.prototype, "scene", {
                get: function () {
                    return this._pScene;
                },
                set: function (pScene) {
                    this._pScene = pScene;
                },
                enumerable: true,
                configurable: true
            });
            SceneNode.prototype.create = function () {
                _super.prototype.create.call(this);
                this._m4fLocalMatrix = new akra.Mat4(1);
                this._m4fWorldMatrix = new akra.Mat4(1);
                this._m4fInverseWorldMatrix = new akra.Mat4(1);
                this._m3fNormalMatrix = new akra.Mat3(1);
                this._v3fWorldPosition = new akra.Vec3();
                this._v3fTranslation = new akra.Vec3(0);
                this._v3fScale = new akra.Vec3(1);
                this._qRotation = new akra.Quat4(0, 1);
                return true;
            };
            SceneNode.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
            };
            SceneNode.prototype.attachToParent = function (pParent) {
                if ((pParent).scene !== this._pScene) {
 {
                        akra.logger.setSourceLocation("SceneNode.ts", 46);
                        akra.logger.warning("transfer of the scene node between trees scene - forbidden");
                    }
                    ;
                    return false;
                }
                return _super.prototype.attachToParent.call(this, pParent);
            };
            SceneNode.prototype.toString = function (isRecursive, iDepth) {
                if (typeof isRecursive === "undefined") { isRecursive = false; }
                if (typeof iDepth === "undefined") { iDepth = 0; }
                if (!isRecursive) {
                    return "<scene_node" + (this.name ? " " + this.name : "") + ">";
                }
                return _super.prototype.toString.call(this, isRecursive, iDepth);
            };
            return SceneNode;
        })(scene.Node);
        scene.SceneNode = SceneNode;        
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        var Joint = (function (_super) {
            __extends(Joint, _super);
            function Joint(pScene) {
                        _super.call(this, pScene, akra.EEntityTypes.JOINT);
                this._sBone = null;
            }
            Object.defineProperty(Joint.prototype, "boneName", {
                get: function () {
                    return this._sBone;
                },
                set: function (sBone) {
                    this._sBone = sBone;
                },
                enumerable: true,
                configurable: true
            });
            Joint.prototype.create = function () {
                this._m4fLocalMatrix = new akra.Mat4(1);
                this._m4fWorldMatrix = new akra.Mat4(1);
                this._v3fWorldPosition = new akra.Vec3();
                this._v3fTranslation = new akra.Vec3(0, 0, 0);
                this._v3fScale = new akra.Vec3(1);
                this._qRotation = new akra.Quat4(0, 1);
                this.setInheritance(akra.ENodeInheritance.ALL);
                return true;
            };
            Joint.prototype.toString = function (isRecursive, iDepth) {
                if (typeof isRecursive === "undefined") { isRecursive = false; }
                if (typeof iDepth === "undefined") { iDepth = 0; }
                isRecursive = isRecursive || false;
                if (!isRecursive) {
                    return "<joint" + (this._sName ? (' ' + this._sName) : "") + ">";
                }
                return scene.Node.prototype.toString.call(this, isRecursive, iDepth);
            };
            return Joint;
        })(scene.SceneNode);
        scene.Joint = Joint;        
        function isJoint(pEntity) {
            return pEntity.type == akra.EEntityTypes.JOINT;
        }
        scene.isJoint = isJoint;
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (model) {
        var Skeleton = (function () {
            function Skeleton(sName) {
                if (typeof sName === "undefined") { sName = null; }
                this._pRootJoints = [];
                this._pJointMap = null;
                this._pNodeList = null;
                this._pMeshNode = null;
                this._iFlags = false;
                this._sName = sName;
            }
            Object.defineProperty(Skeleton.prototype, "totalBones", {
                get: function () {
                    return Object.keys(this._pJointMap).length;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Skeleton.prototype, "totalNodes", {
                get: function () {
                    return this._pNodeList.length;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Skeleton.prototype, "name", {
                get: function () {
                    return this._sName;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Skeleton.prototype, "root", {
                get: function () {
                    return this._pRootJoints[0] || null;
                },
                enumerable: true,
                configurable: true
            });
            Skeleton.prototype.getRootJoint = function () {
                return this.getRootJoints()[0];
            };
            Skeleton.prototype.getRootJoints = function () {
                return this._pRootJoints;
            };
            Skeleton.prototype.getJointMap = function () {
                return this._pJointMap;
            };
            Skeleton.prototype.getNodeList = function () {
                return this._pNodeList;
            };
            Skeleton.prototype.addRootJoint = function (pJoint) {
 {
                    akra.logger.setSourceLocation("model/Skeleton.ts", 56);
                    akra.logger.assert(pJoint instanceof akra.scene.Joint, 'node must be joint');
                }
                ;
                var pRootJoints = this._pRootJoints;
                for(var i = 0; i < pRootJoints.length; i++) {
                    if (pJoint.childOf(pRootJoints[i])) {
                        return false;
                    } else if (pRootJoints[i].childOf(pJoint)) {
                        pRootJoints.splice(i, 1);
                    }
                }
                ;
                this._pRootJoints.push(pJoint);
                return this.update();
            };
            Skeleton.prototype.update = function () {
                var pRootJoints = this.getRootJoints();
                var pJointMap = this._pJointMap = {};
                var pNodeList = this._pNodeList = [];
                function findNodes(pNode) {
                    var sJoint = null;
                    if (!((pNode) === null)) {
                        if (akra.scene.isJoint(pNode)) {
                            sJoint = (pNode).boneName;
                        }
                        if (!((sJoint) === null)) {
 {
                                akra.logger.setSourceLocation("model/Skeleton.ts", 90);
                                akra.logger.assert(!pJointMap[sJoint], 'joint with name<' + sJoint + '> already exists in skeleton <' + this._sName + '>');
                            }
                            ;
                            pJointMap[sJoint] = pNode;
                        }
                        pNodeList.push(pNode);
                        findNodes(pNode.sibling);
                        findNodes(pNode.child);
                    }
                }
                for(var i = 0; i < pRootJoints.length; i++) {
                    findNodes(pRootJoints[i]);
                }
                ;
                return true;
            };
            Skeleton.prototype.findJoint = function (sName) {
                return this._pJointMap[sName];
            };
            Skeleton.prototype.findJointByName = function (sName) {
                for(var s in this._pJointMap) {
                    if (this._pJointMap[s].name === sName) {
                        return this._pJointMap[s];
                    }
                }
                return null;
            };
            Skeleton.prototype.attachMesh = function (pMesh) {
                if (((this.root) === null)) {
                    return false;
                }
                if (this._pMeshNode == null) {
                    this._pMeshNode = this.root.scene.createModel();
                    this._pMeshNode.setInheritance(akra.ENodeInheritance.ALL);
                    this._pMeshNode.attachToParent(this.root);
                }
                this._pMeshNode.name = this.name + "[mesh-container]";
                this._pMeshNode.mesh = (pMesh);
                return true;
            };
            Skeleton.prototype.detachMesh = function () {
            };
            return Skeleton;
        })();        
        function createSkeleton(sName) {
            if (typeof sName === "undefined") { sName = null; }
            return new Skeleton(sName);
        }
        model.createSkeleton = createSkeleton;
    })(akra.model || (akra.model = {}));
    var model = akra.model;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    (function (EAnimationInterpolations) {
        EAnimationInterpolations._map = [];
        EAnimationInterpolations._map[0] = "MATRIX_LINEAR";
        EAnimationInterpolations.MATRIX_LINEAR = 0;
        EAnimationInterpolations._map[1] = "LINEAR";
        EAnimationInterpolations.LINEAR = 1;
    })(akra.EAnimationInterpolations || (akra.EAnimationInterpolations = {}));
    var EAnimationInterpolations = akra.EAnimationInterpolations;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (animation) {
        var Frame = (function () {
            function Frame(fTime, pMatrix, fWeight) {
                this.time = 0.0;
                this.weight = 1.0;
                this.matrix = null;
                this.rotation = new akra.Quat4();
                this.scale = new akra.Vec3();
                this.translation = new akra.Vec3();
                switch(arguments.length) {
                    case 0:
                        this.matrix = new akra.Mat4();
                        return;
                    case 3:
                        this.weight = fWeight;
                    case 2:
                        this.matrix = pMatrix;
                    case 1:
                        this.time = fTime;
                }
                ;
                this.matrix.decompose(this.rotation, this.scale, this.translation);
            }
            Frame.prototype.toMatrix = function () {
                return this.rotation.toMat4(this.matrix).setTranslation(this.translation).scaleRight(this.scale);
            };
            Frame.prototype.toMatrixFromMatrix = function () {
                return this.matrix;
            };
            Frame.prototype.reset = function () {
                this.weight = 0.0;
                this.time = 0.0;
                var pData = this.matrix.data;
                pData[0] = pData[4] = pData[8] = pData[12] = pData[1] = pData[5] = pData[9] = pData[13] = pData[2] = pData[6] = pData[10] = pData[14] = pData[3] = pData[7] = pData[11] = pData[15] = 0;
                this.rotation.x = this.rotation.y = this.rotation.z = 0;
                this.rotation.w = 1.0;
                this.translation.x = this.translation.y = this.translation.z = 0;
                this.scale.x = this.scale.y = this.scale.z = 0;
                return this;
            };
            Frame.prototype.set = function (pFrame) {
                this.matrix.set(pFrame.matrix);
                this.rotation.set(pFrame.rotation);
                this.scale.set(pFrame.scale);
                this.translation.set(pFrame.translation);
                this.time = pFrame.time;
                this.weight = pFrame.weight;
            };
            Frame.prototype.add = function (pFrame, isFirst) {
                var fWeight = pFrame.weight;
                this.scale.x += pFrame.scale.x * fWeight;
                this.scale.y += pFrame.scale.y * fWeight;
                this.scale.z += pFrame.scale.z * fWeight;
                this.translation.x += pFrame.translation.x * fWeight;
                this.translation.y += pFrame.translation.y * fWeight;
                this.translation.z += pFrame.translation.z * fWeight;
                this.weight += fWeight;
                if (!isFirst) {
                    this.rotation.smix(pFrame.rotation, fWeight / this.weight);
                } else {
                    this.rotation.set(pFrame.rotation);
                }
                return this;
            };
            Frame.prototype.addMatrix = function (pFrame) {
                var pMatData = pFrame.matrix.data;
                var fWeight = pFrame.weight;
                var pResData = this.matrix.data;
                for(var i = 0; i < 16; ++i) {
                    pResData[i] += pMatData[i] * fWeight;
                }
                this.weight += fWeight;
                return this;
            };
            Frame.prototype.mult = function (fScalar) {
                this.weight *= fScalar;
                return this;
            };
            Frame.prototype.normilize = function () {
                var fScalar = 1.0 / this.weight;
                this.scale.x *= fScalar;
                this.scale.y *= fScalar;
                this.scale.z *= fScalar;
                this.translation.x *= fScalar;
                this.translation.y *= fScalar;
                this.translation.z *= fScalar;
                return this;
            };
            Frame.prototype.normilizeMatrix = function () {
                var fScalar = 1.0 / this.weight;
                var pData = this.matrix.data;
                pData[0] *= fScalar;
                pData[4] *= fScalar;
                pData[8] *= fScalar;
                pData[12] *= fScalar;
                pData[1] *= fScalar;
                pData[5] *= fScalar;
                pData[9] *= fScalar;
                pData[13] *= fScalar;
                pData[2] *= fScalar;
                pData[6] *= fScalar;
                pData[10] *= fScalar;
                pData[14] *= fScalar;
                pData[3] *= fScalar;
                pData[7] *= fScalar;
                pData[11] *= fScalar;
                pData[15] *= fScalar;
                return this;
            };
            Frame.prototype.interpolate = function (pStartFrame, pEndFrame, fBlend) {
                pStartFrame.translation.mix(pEndFrame.translation, fBlend, this.translation);
                pStartFrame.scale.mix(pEndFrame.scale, fBlend, this.scale);
                pStartFrame.rotation.smix(pEndFrame.rotation, fBlend, this.rotation);
            };
            Frame.prototype.interpolateMatrix = function (pStartFrame, pEndFrame, fBlend) {
                var pResultData = this.matrix.data;
                var pStartData = pStartFrame.matrix.data;
                var pEndData = pEndFrame.matrix.data;
                var fBlendInv = 1. - fBlend;
                for(var i = 0; i < 16; i++) {
                    pResultData[i] = pEndData[i] * fBlend + pStartData[i] * fBlendInv;
                }
                ;
            };
            Object.defineProperty(Frame, "stackCeil", {
                get: function () {
                    Frame.stackPosition = Frame.stackPosition === Frame.stackSize - 1 ? 0 : Frame.stackPosition;
                    return Frame.stack[Frame.stackPosition++];
                },
                enumerable: true,
                configurable: true
            });
            Frame.stackSize = 4 * 4096;
            Frame.stackPosition = 0;
            Frame.stack = (function () {
                var pStack = new Array(Frame.stackSize);
                for(var i = 0; i < Frame.stackSize; i++) {
                    pStack[i] = new Frame();
                }
                return pStack;
            })();
            return Frame;
        })();
        animation.Frame = Frame;        
        function animationFrame() {
            return Frame.stackCeil;
        }
        animation.animationFrame = animationFrame;
        function createFrame(fTime, pMatrix, fWeight) {
            if (typeof fTime === "undefined") { fTime = 0.0; }
            if (typeof pMatrix === "undefined") { pMatrix = null; }
            if (typeof fWeight === "undefined") { fWeight = 1.0; }
            return new Frame(fTime, pMatrix, fWeight);
        }
        animation.createFrame = createFrame;
    })(akra.animation || (akra.animation = {}));
    var animation = akra.animation;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (animation) {
        var Track = (function () {
            function Track(sTarget) {
                if (typeof sTarget === "undefined") { sTarget = null; }
                this._sTarget = null;
                this._pTarget = null;
                this._pKeyFrames = [];
                this._eInterpolationType = akra.EAnimationInterpolations.MATRIX_LINEAR;
                this._sTarget = sTarget;
            }
            Object.defineProperty(Track.prototype, "totalFrames", {
                get: function () {
                    return this._pKeyFrames.length;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Track.prototype, "target", {
                get: function () {
                    return this._pTarget;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Track.prototype, "targetName", {
                get: function () {
                    return this._sTarget;
                },
                set: function (sValue) {
                    this._sTarget = sValue;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Track.prototype, "duration", {
                get: function () {
                    return ((this._pKeyFrames.last)).time;
                },
                enumerable: true,
                configurable: true
            });
            Track.prototype.keyFrame = function (fTime, pMatrix) {
                var pFrame;
                var iFrame;
                var pKeyFrames = this._pKeyFrames;
                var nTotalFrames = pKeyFrames.length;
                if (arguments.length > 1) {
                    pFrame = animation.createFrame(fTime, pMatrix);
                } else {
                    pFrame = arguments[0];
                }
                if (nTotalFrames && (iFrame = this.findKeyFrame(pFrame.time)) >= 0) {
                    pKeyFrames.splice(iFrame, 0, pFrame);
                } else {
                    pKeyFrames.push(pFrame);
                }
                return true;
            };
            Track.prototype.getKeyFrame = function (iFrame) {
 {
                    akra.logger.setSourceLocation("animation/Track.ts", 72);
                    akra.logger.assert(iFrame < this.totalFrames, 'iFrame must be less then number of total jey frames.');
                }
                ;
                return this._pKeyFrames[iFrame];
            };
            Track.prototype.findKeyFrame = function (fTime) {
                var pKeyFrames = this._pKeyFrames;
                var nTotalFrames = pKeyFrames.length;
                if (pKeyFrames[nTotalFrames - 1].time == fTime) {
                    return nTotalFrames - 1;
                } else {
                    for(var i = nTotalFrames - 1; i >= 0; i--) {
                        if (pKeyFrames[i].time > fTime && pKeyFrames[i - 1].time <= fTime) {
                            return i - 1;
                        }
                    }
                }
                return -1;
            };
            Track.prototype.bind = function (pJoint, pSkeleton) {
                var pNode = null, pRootNode;
                var sJoint;
                switch(arguments.length) {
                    case 2:
                        sJoint = pJoint;
                        this._sTarget = sJoint;
                        pNode = (pSkeleton).findJoint(sJoint);
                        break;
                    default:
                        if (!((arguments[0].type) !== undefined)) {
                            if (this._sTarget == null) {
                                return false;
                            }
                            pSkeleton = arguments[0];
                            pNode = (pSkeleton).findJoint(this._sTarget);
                        } else {
                            pRootNode = arguments[0];
                            pNode = pRootNode.findEntity(this.targetName);
                        }
                }
                this._pTarget = pNode;
                return ((pNode) != null);
            };
            Track.prototype.frame = function (fTime) {
                var iKey1 = 0, iKey2 = 0;
                var fScalar;
                var fTimeDiff;
                var pKeys = this._pKeyFrames;
                var nKeys = pKeys.length;
                var pFrame = animation.animationFrame();
 {
                    akra.logger.setSourceLocation("animation/Track.ts", 144);
                    akra.logger.assert(nKeys > 0, 'no frames :(');
                }
                ;
                if (nKeys === 1) {
                    pFrame.set(pKeys[0]);
                } else {
                    for(var i = 0; i < nKeys; i++) {
                        if (fTime >= this._pKeyFrames[i].time) {
                            iKey1 = i;
                        }
                    }
                    iKey2 = (iKey1 >= (nKeys - 1)) ? iKey1 : iKey1 + 1;
                    fTimeDiff = pKeys[iKey2].time - pKeys[iKey1].time;
                    if (!fTimeDiff) {
                        fTimeDiff = 1;
                    }
                    fScalar = (fTime - pKeys[iKey1].time) / fTimeDiff;
                    pFrame.interpolate(this._pKeyFrames[iKey1], this._pKeyFrames[iKey2], fScalar);
                }
                pFrame.time = fTime;
                pFrame.weight = 1.0;
                return pFrame;
            };
            Track.prototype.toString = function () {
                var s = "target: " + this.targetName + ", duration: " + this.duration + ", frames: " + this.totalFrames;
                return s;
            };
            return Track;
        })();        
        function createTrack(sTarget) {
            if (typeof sTarget === "undefined") { sTarget = null; }
            return new Track(sTarget);
        }
        animation.createTrack = createTrack;
    })(akra.animation || (akra.animation = {}));
    var animation = akra.animation;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    (function (EAnimationTypes) {
        EAnimationTypes._map = [];
        EAnimationTypes._map[0] = "ANIMATION";
        EAnimationTypes.ANIMATION = 0;
        EAnimationTypes._map[1] = "LIST";
        EAnimationTypes.LIST = 1;
        EAnimationTypes._map[2] = "CLIP";
        EAnimationTypes.CLIP = 2;
        EAnimationTypes._map[3] = "CONTAINER";
        EAnimationTypes.CONTAINER = 3;
        EAnimationTypes._map[4] = "BLEND";
        EAnimationTypes.BLEND = 4;
    })(akra.EAnimationTypes || (akra.EAnimationTypes = {}));
    var EAnimationTypes = akra.EAnimationTypes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (animation) {
        var Base = (function () {
            function Base(eType, sName) {
                if (typeof sName === "undefined") { sName = null; }
                this._pTargetMap = {};
                this._pTargetList = [];
                this._fDuration = 0.0;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._sName = sName || ("animation-" + "-" + this.getGuid());
                this._eType = eType;
            }
            Object.defineProperty(Base.prototype, "type", {
                get: function () {
                    return this._eType;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Base.prototype, "duration", {
                get: function () {
                    return this._fDuration;
                },
                set: function (fValue) {
 {
                        akra.logger.setSourceLocation("Base.ts", 40);
                        akra.logger.log("new duration(", this.name, ") > " + fValue);
                    }
                    ;
                    this._fDuration = fValue;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Base.prototype, "name", {
                get: function () {
                    return this._sName;
                },
                set: function (sName) {
                    this._sName = sName;
                },
                enumerable: true,
                configurable: true
            });
            Base.prototype.play = function (fRealTime) {
                this.played(fRealTime);
            };
            Base.prototype.stop = function (fRealTime) {
                this.stoped(fRealTime);
            };
            Base.prototype.attach = function (pTarget) {
 {
                    akra.logger.setSourceLocation("Base.ts", 62);
                    akra.logger.error("method AnimationBase::attach() must be overwritten.");
                }
                ;
            };
            Base.prototype.frame = function (sName, fRealTime) {
                return null;
            };
            Base.prototype.apply = function (fRealTime) {
                var pTargetList = this._pTargetList;
                var pTarget = null;
                var pFrame = null;
                var pTransform = null;
                for(var i = 0; i < pTargetList.length; ++i) {
                    pFrame = this.frame(pTargetList[i].name, fRealTime);
                    pTarget = pTargetList[i].target;
                    if (!pFrame || !pTarget) {
                        continue;
                    }
                    pTransform = pFrame.toMatrix();
                    pTarget.localMatrix = pTransform;
                }
                ;
            };
            Base.prototype.addTarget = function (sName, pTarget) {
                if (typeof pTarget === "undefined") { pTarget = null; }
                var pPointer = this._pTargetMap[sName];
                if (pPointer) {
                    pPointer.target = pTarget || pPointer.target || null;
                    return pPointer;
                }
                pPointer = {
                    target: pTarget,
                    index: this._pTargetList.length,
                    name: sName
                };
                this._pTargetList.push(pPointer);
                this._pTargetMap[sName] = pPointer;
                return pPointer;
            };
            Base.prototype.setTarget = function (sName, pTarget) {
                var pPointer = this._pTargetMap[sName];
                pPointer.target = pTarget;
                return pPointer;
            };
            Base.prototype.getTarget = function (sTargetName) {
                return this._pTargetMap[sTargetName];
            };
            Base.prototype.getTargetList = function () {
                return this._pTargetList;
            };
            Base.prototype.getTargetByName = function (sName) {
                return this._pTargetMap[sName];
            };
            Base.prototype.targetNames = function () {
                var pTargets = this._pTargetList;
                var pTargetNames = [];
                for(var i = 0; i < pTargets.length; ++i) {
                    pTargetNames.push(pTargets[i].name);
                }
                return pTargetNames;
            };
            Base.prototype.targetList = function () {
                var pTargets = this._pTargetList;
                var pTargetList = [];
                for(var i = 0; i < pTargets.length; ++i) {
                    pTargetList.push(pTargets[i].target);
                }
                return pTargetList;
            };
            Base.prototype.jointList = function () {
                var pTargets = this._pTargetList;
                var pJointList = [];
                for(var i = 0; i < pTargets.length; ++i) {
                    if (akra.scene.isJoint(pTargets[i].target)) {
                        pJointList.push(pTargets[i].target);
                    }
                }
                return pJointList;
            };
            Base.prototype.grab = function (pAnimationBase, bRewrite) {
                if (typeof bRewrite === "undefined") { bRewrite = true; }
                var pAdoptTargets = pAnimationBase.getTargetList();
                for(var i = 0; i < pAdoptTargets.length; ++i) {
                    if (!pAdoptTargets[i].target) {
                        continue;
                    }
                    if (bRewrite || !this.getTarget(pAdoptTargets[i].name)) {
                        this.addTarget(pAdoptTargets[i].name, pAdoptTargets[i].target);
                    }
                }
                ;
            };
            Base.prototype.createAnimationMask = function () {
                var pTargets = this.targetNames();
                var pMask = {};
                for(var i = 0; i < pTargets.length; ++i) {
                    pMask[pTargets[i]] = 1.0;
                }
                return pMask;
            };
            Base.prototype.toString = function () {
                var s = "\n";
                s += "name         : " + this.name + "\n";
                s += "duration     : " + this.duration + " sec\n";
                s += "total targets: " + this.targetList().length.toString() + "\n";
                return s;
            };
            Base.prototype.getGuid = function () {
                return this._iGuid;
            };
            Base._pEventTable = new akra.events.EventTable();
            Base.prototype.getEventTable = function () {
                return Base._pEventTable;
            };
            Base.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Base.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Base.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Base.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Base.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            Base.prototype.played = function (fRealTime) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).played;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, fRealTime) : _broadcast[i].listener(_recivier, fRealTime);
                    }
                }
            };
            Base.prototype.stoped = function (fRealTime) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).stoped;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, fRealTime) : _broadcast[i].listener(_recivier, fRealTime);
                    }
                }
            };
            return Base;
        })();
        animation.Base = Base;        
    })(akra.animation || (akra.animation = {}));
    var animation = akra.animation;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (animation) {
        var Animation = (function (_super) {
            __extends(Animation, _super);
            function Animation(sName) {
                        _super.call(this, akra.EAnimationTypes.ANIMATION, sName);
                this._pTracks = [];
            }
            Object.defineProperty(Animation.prototype, "totalTracks", {
                get: function () {
                    return this._pTracks.length;
                },
                enumerable: true,
                configurable: true
            });
            Animation.prototype.push = function (pTrack) {
                this._pTracks.push(pTrack);
                this._fDuration = Math.max(this._fDuration, pTrack.duration);
                this.addTarget(pTrack.targetName);
            };
            Animation.prototype.attach = function (pTarget) {
                var pPointer;
                var pTracks = this._pTracks;
                for(var i = 0; i < pTracks.length; ++i) {
                    if (!pTracks[i].bind(pTarget)) {
 {
                            akra.logger.setSourceLocation("animation/Animation.ts", 35);
                            akra.logger.log("cannot bind animation track [", i, "] to joint <", pTracks[i].target, ">");
                        }
                        ;
                    } else {
                        pPointer = this.setTarget(pTracks[i].targetName, pTracks[i].target);
                        pPointer.track = pTracks[i];
                    }
                }
            };
            Animation.prototype.getTracks = function () {
                return this._pTracks;
            };
            Animation.prototype.getTrack = function (i) {
                return this._pTracks[i];
            };
            Animation.prototype.frame = function (sName, fTime) {
                var pPointer = this.getTargetByName(sName);
                if (!pPointer || !pPointer.track) {
                    return null;
                }
                return pPointer.track.frame((/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((fTime), (this._fDuration)))));
            };
            Animation.prototype.extend = function (pAnimation) {
                var pTracks = pAnimation.getTracks();
                for(var i = 0; i < pTracks.length; ++i) {
                    if (!this.getTarget(pTracks[i].targetName)) {
                        this.push(pTracks[i]);
                    }
                }
            };
            Animation.prototype.toString = function () {
                var s = _super.prototype.toString.call(this);
                s += "total tracks : " + this.totalTracks + "\n";
                for(var i = 0; i < this.totalTracks; ++i) {
                    s += "\t" + i + ". " + this.getTrack(i) + "\n";
                }
                return s;
            };
            return Animation;
        })(animation.Base);        
        function isAnimation(pAnimation) {
            return pAnimation.type === akra.EAnimationTypes.ANIMATION;
        }
        animation.isAnimation = isAnimation;
        function createAnimation(sName) {
            return new Animation(sName);
        }
        animation.createAnimation = createAnimation;
    })(akra.animation || (akra.animation = {}));
    var animation = akra.animation;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (animation) {
        var Controller = (function () {
            function Controller(pEngine, iOptions) {
                if (typeof iOptions === "undefined") { iOptions = 0; }
                this._pAnimations = [];
                this._iOptions = 0;
                this._pActiveAnimation = null;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._pEngine = pEngine;
                this.setOptions(iOptions);
            }
            Object.defineProperty(Controller.prototype, "totalAnimations", {
                get: function () {
                    return this._pAnimations.length;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Controller.prototype, "active", {
                get: function () {
                    return this._pActiveAnimation;
                },
                enumerable: true,
                configurable: true
            });
            Controller.prototype.getEngine = function () {
                return this._pEngine;
            };
            Controller.prototype.setOptions = function (iOptions) {
            };
            Controller.prototype.addAnimation = function (pAnimation) {
                if (this.findAnimation(pAnimation.name)) {
 {
                        akra.logger.setSourceLocation("animation/Controller.ts", 39);
                        akra.logger.warning("Animation with name <" + pAnimation.name + "> already exists in this controller");
                    }
                    ;
                    return false;
                }
                this._pAnimations.push(pAnimation);
                this._pActiveAnimation = pAnimation;
                this.animationAdded(pAnimation);
            };
            Controller.prototype.removeAnimation = function (pAnimation) {
                var pAnimation = this.findAnimation(arguments[0]);
                var pAnimations = this._pAnimations;
                for(var i = 0; i < pAnimations.length; ++i) {
                    if (pAnimations[i] === pAnimation) {
                        pAnimations.splice(i, 1);
 {
                            akra.logger.setSourceLocation("animation/Controller.ts", 61);
                            akra.logger.log("animation controller :: remove animation >> ", pAnimation.name);
                        }
                        ;
                        return true;
                    }
                }
                return false;
            };
            Controller.prototype.findAnimation = function (pAnimation) {
                var pAnimations = this._pAnimations;
                var iAnimation;
                var sAnimation;
                if ((typeof (arguments[0]) === "string")) {
                    sAnimation = arguments[0];
                    for(var i = 0; i < pAnimations.length; ++i) {
                        if (pAnimations[i].name === sAnimation) {
                            return pAnimations[i];
                        }
                    }
                    return null;
                }
                if (typeof arguments[0] === 'number') {
                    iAnimation = arguments[0];
                    return pAnimations[iAnimation] || null;
                }
                return arguments[0];
            };
            Controller.prototype.getAnimation = function (iAnim) {
                return this._pAnimations[iAnim];
            };
            Controller.prototype.setAnimation = function (iAnimation, pAnimation) {
 {
                    akra.logger.setSourceLocation("animation/Controller.ts", 102);
                    akra.logger.assert(iAnimation < this._pAnimations.length, 'invalid animation slot');
                }
                ;
                this._pAnimations[iAnimation] = pAnimation;
            };
            Controller.prototype.attach = function (pTarget) {
                var pAnimations = this._pAnimations;
                for(var i = 0; i < pAnimations.length; ++i) {
                    pAnimations[i].attach(pTarget);
                }
            };
            Controller.prototype.play = function (pAnimation, fRealTime) {
                var pAnimationNext = this.findAnimation(arguments[0]);
                var pAnimationPrev = this._pActiveAnimation;
                if (pAnimationNext && pAnimationNext !== pAnimationPrev) {
                    if (pAnimationPrev) {
                        pAnimationPrev.stop(fRealTime);
                    }
                    pAnimationNext.play(fRealTime);
                    this._pActiveAnimation = pAnimationNext;
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).play;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pAnimationNext, fRealTime) : _broadcast[i].listener(_recivier, pAnimationNext, fRealTime);
                        }
                    }
                    ;
                    return true;
                }
                return false;
            };
            Controller.prototype.update = function (fTime) {
                if (this._pActiveAnimation) {
                    this._pActiveAnimation.apply(fTime);
                }
            };
            Controller.prototype.toString = function (bFullInfo) {
                if (typeof bFullInfo === "undefined") { bFullInfo = false; }
                var s = "\n";
                s += "ANIMATION CONTROLLER (total: " + this.totalAnimations + " animations)\n";
                s += "-----------------------------------------------------\n";
                for(var i = 0; i < this.totalAnimations; ++i) {
                    s += this.getAnimation(i).toString();
                }
                return s;
            };
            Controller.prototype.getGuid = function () {
                return this._iGuid;
            };
            Controller._pEventTable = new akra.events.EventTable();
            Controller.prototype.getEventTable = function () {
                return Controller._pEventTable;
            };
            Controller.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Controller.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Controller.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Controller.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Controller.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            Controller.prototype.animationAdded = function (pAnimation) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).animationAdded;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pAnimation) : _broadcast[i].listener(_recivier, pAnimation);
                    }
                }
            };
            return Controller;
        })();
        animation.Controller = Controller;        
        function createController(pEngine, iOptions) {
            return new Controller(pEngine, iOptions);
        }
        animation.createController = createController;
    })(akra.animation || (akra.animation = {}));
    var animation = akra.animation;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (animation) {
        var Blend = (function (_super) {
            __extends(Blend, _super);
            function Blend(sName) {
                        _super.call(this, akra.EAnimationTypes.BLEND, sName);
                this.duration = 0;
                this._pAnimationList = [];
            }
            Object.defineProperty(Blend.prototype, "totalAnimations", {
                get: function () {
                    return this._pAnimationList.length;
                },
                enumerable: true,
                configurable: true
            });
            Blend.prototype.play = function (fRealTime) {
                var pAnimationList = this._pAnimationList;
                var n = pAnimationList.length;
                for(var i = 0; i < n; ++i) {
                    pAnimationList[i].realTime = fRealTime;
                    pAnimationList[i].time = fRealTime * pAnimationList[i].acceleration;
                }
                this.played(fRealTime);
            };
            Blend.prototype.stop = function () {
                this.stoped(0.);
            };
            Blend.prototype.attach = function (pTarget) {
                var pAnimationList = this._pAnimationList;
                for(var i = 0; i < pAnimationList.length; ++i) {
                    var pAnim = pAnimationList[i].animation;
                    pAnim.attach(pTarget);
                    this.grab(pAnim, true);
                }
            };
            Blend.prototype.addAnimation = function (pAnimation, fWeight, pMask) {
 {
                    akra.logger.setSourceLocation("animation/Blend.ts", 51);
                    akra.logger.assert(((pAnimation) !== undefined), 'animation must be setted.');
                }
                ;
                this._pAnimationList.push(null);
                return this.setAnimation(this._pAnimationList.length - 1, pAnimation, fWeight, pMask);
            };
            Blend.prototype.setAnimation = function (iAnimation, pAnimation, fWeight, pMask) {
                if (typeof fWeight === "undefined") { fWeight = 1.0; }
                if (typeof pMask === "undefined") { pMask = null; }
 {
                    akra.logger.setSourceLocation("animation/Blend.ts", 59);
                    akra.logger.assert(iAnimation <= this._pAnimationList.length, 'invalid animation slot: ' + iAnimation + '/' + this._pAnimationList.length);
                }
                ;
                var pPointer = this._pAnimationList[iAnimation];
                var pAnimationList = this._pAnimationList;
                if (!pAnimation) {
                    pAnimationList[iAnimation] = null;
                    return iAnimation;
                }
                if (!pPointer) {
                    pPointer = {
                        animation: pAnimation,
                        weight: fWeight,
                        mask: pMask,
                        acceleration: 1.0,
                        time: 0.0,
                        realTime: 0.0
                    };
                    this.connect(pAnimation, "durationUpdated", "_onDurationUpdate");
                    if (iAnimation == this._pAnimationList.length) {
                        pAnimationList.push(pPointer);
                    } else {
                        pAnimationList[iAnimation] = pPointer;
                    }
                }
                this.grab(pAnimation);
                this.updateDuration();
                return iAnimation;
            };
            Blend.prototype._onDurationUpdate = function (pAnimation, fDuration) {
                this.updateDuration();
            };
            Blend.prototype.updateDuration = function () {
                var fWeight = 0;
                var fSumm = 0;
                var pAnimationList = this._pAnimationList;
                var n = pAnimationList.length;
                for(var i = 0; i < n; ++i) {
                    if (pAnimationList[i] === null) {
                        continue;
                    }
                    fSumm += pAnimationList[i].weight * pAnimationList[i].animation.duration;
                    fWeight += pAnimationList[i].weight;
                }
                if (fWeight === 0) {
                    this.duration = 0;
                } else {
                    this.duration = fSumm / fWeight;
                    for(var i = 0; i < n; ++i) {
                        if (pAnimationList[i] === null) {
                            continue;
                        }
                        pAnimationList[i].acceleration = pAnimationList[i].animation.duration / this.duration;
                    }
                }
                this.durationUpdated(this.duration);
            };
            Blend.prototype.getAnimationIndex = function (sName) {
                var pAnimationList = this._pAnimationList;
                for(var i = 0; i < pAnimationList.length; i++) {
                    if (pAnimationList[i].animation.name === sName) {
                        return i;
                    }
                }
                ;
                return -1;
            };
            Blend.prototype.getAnimation = function (animation) {
                var iAnimation = (typeof (animation) === "string") ? this.getAnimationIndex(animation) : animation;
                return this._pAnimationList[iAnimation].animation;
            };
            Blend.prototype.getAnimationWeight = function (animation) {
                var iAnimation = animation;
                if ((typeof (animation) === "string")) {
                    iAnimation = this.getAnimationIndex(animation);
                }
                return this._pAnimationList[iAnimation].weight;
            };
            Blend.prototype.setWeights = function () {
                var pWeight = [];
                for (var _i = 0; _i < (arguments.length - 0); _i++) {
                    pWeight[_i] = arguments[_i + 0];
                }
                var fWeight;
                var isModified = false;
                var pAnimationList = this._pAnimationList;
                for(var i = 0; i < arguments.length; ++i) {
                    fWeight = arguments[i];
                    if (fWeight < 0 || fWeight === null || !pAnimationList[i]) {
                        continue;
                    }
                    if (pAnimationList[i].weight !== fWeight) {
                        pAnimationList[i].weight = fWeight;
                        isModified = true;
                    }
                }
                if (isModified) {
                    this.updateDuration();
                }
                return true;
            };
            Blend.prototype.setWeightSwitching = function (fWeight, iAnimationFrom, iAnimationTo) {
                var pAnimationList = this._pAnimationList;
                var isModified = false;
                var fWeightInv = 1. - fWeight;
                if (!pAnimationList[iAnimationFrom] || !pAnimationList[iAnimationTo]) {
                    return false;
                }
                if (pAnimationList[iAnimationFrom].weight !== fWeightInv) {
                    pAnimationList[iAnimationFrom].weight = fWeightInv;
                    isModified = true;
                }
                if (pAnimationList[iAnimationTo].weight !== fWeight) {
                    pAnimationList[iAnimationTo].weight = fWeight;
                    isModified = true;
                }
                if (isModified) {
                    this.updateDuration();
                }
                return true;
            };
            Blend.prototype.setAnimationWeight = function (animation, fWeight) {
                var pAnimationList = this._pAnimationList;
                var isModified = false;
                if (arguments.length === 1) {
                    fWeight = arguments[0];
                    for(var i = 0; i < pAnimationList.length; i++) {
                        pAnimationList[i].weight = fWeight;
                    }
                    ;
                    isModified = true;
                } else {
                    var iAnimation = (typeof (animation) === "string") ? this.getAnimationIndex(animation) : animation;
                    if (pAnimationList[iAnimation].weight !== fWeight) {
                        pAnimationList[iAnimation].weight = fWeight;
                        isModified = true;
                    }
                }
                if (isModified) {
                    this.updateDuration();
                }
                return true;
            };
            Blend.prototype.setAnimationMask = function (animation, pMask) {
                var iAnimation = (typeof (animation) === "string") ? this.getAnimationIndex(animation) : animation;
                this._pAnimationList[iAnimation].mask = pMask;
                return true;
            };
            Blend.prototype.getAnimationMask = function (animation) {
                var iAnimation = (typeof (animation) === "string") ? this.getAnimationIndex(animation) : animation;
                return this._pAnimationList[iAnimation].mask;
            };
            Blend.prototype.getAnimationAcceleration = function (animation) {
                var iAnimation = (typeof (animation) === "string") ? this.getAnimationIndex(animation) : animation;
                return this._pAnimationList[iAnimation].acceleration;
            };
            Blend.prototype.createAnimationMask = function (iAnimation) {
                if (arguments.length === 0) {
                    return _super.prototype.createAnimationMask.call(this);
                }
                if (typeof arguments[0] === 'string') {
                    iAnimation = this.getAnimationIndex(arguments[0]);
                }
                var pAnimation = this._pAnimationList[iAnimation].animation;
                return pAnimation.createAnimationMask();
            };
            Blend.prototype.frame = function (sName, fRealTime) {
                var pAnimationList = this._pAnimationList;
                var pResultFrame = animation.animationFrame().reset();
                var pFrame;
                var pMask;
                var pPointer;
                var fAcceleration;
                var fBoneWeight;
                var fWeight;
                var iAnim = 0;
                for(var i = 0; i < pAnimationList.length; i++) {
                    pPointer = pAnimationList[i];
                    if (!pPointer) {
                        continue;
                    }
                    fAcceleration = pPointer.acceleration;
                    pMask = pPointer.mask;
                    fBoneWeight = 1.0;
                    pPointer.time = pPointer.time + (fRealTime - pPointer.realTime) * fAcceleration;
                    pPointer.realTime = fRealTime;
                    if (pMask) {
                        fBoneWeight = ((pMask[sName]) !== undefined) ? pMask[sName] : 1.0;
                    }
                    fWeight = fBoneWeight * pPointer.weight;
                    if (fWeight > 0.0) {
                        pFrame = pPointer.animation.frame(sName, pPointer.time);
                        if (pFrame) {
                            iAnim++;
                            pResultFrame.add(pFrame.mult(fWeight), iAnim === 1);
                        }
                    }
                }
                if (pResultFrame.weight === 0.0) {
                    return null;
                }
                return pResultFrame.normilize();
            };
            Blend.prototype.durationUpdated = function (fDuration) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).durationUpdated;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, fDuration) : _broadcast[i].listener(_recivier, fDuration);
                    }
                }
            };
            return Blend;
        })(animation.Base);        
        function isBlend(pAnimation) {
            return pAnimation.type === akra.EAnimationTypes.BLEND;
        }
        animation.isBlend = isBlend;
        function createBlend(sName) {
            return new Blend(sName);
        }
        animation.createBlend = createBlend;
    })(akra.animation || (akra.animation = {}));
    var animation = akra.animation;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                                                                                                                                                                                                                                                                                var pSupportedVertexFormat;
                var pSupportedTextureFormat;
                var pSupportedColorFormat;
                var pSupportedWeightFormat;
                var pSupportedJointFormat;
                var pSupportedInvBindMatrixFormat;
                var pSupportedInterpolationFormat;
                var pSupportedInputFormat;
                var pSupportedOutputFormat;
                var pSupportedTangentFormat;
                var pFormatStrideTable;
                var pConvFormats;
                var Collada = (function (_super) {
                    __extends(Collada, _super);
                    function Collada() {
                                        _super.call(this);
                        this._pModel = null;
                        this._pOptions = null;
                        this._pLinks = {};
                        this._pLib = {};
                        this._pCache = {
                            meshMap: {},
                            sharedBuffer: null
                        };
                        this._pAsset = null;
                        this._pVisualScene = null;
                        this._pAnimations = [];
                        this._sFilename = null;
                        this._pXMLRoot = null;
                    }
                    Collada.DEFAULT_OPTIONS = {
                        drawJoints: false,
                        wireframe: false,
                        sharedBuffer: false,
                        animation: {
                            pose: true
                        },
                        scene: true,
                        extractPoses: true,
                        skeletons: null,
                        images: {
                            flipY: false
                        }
                    };
                    Collada.SCENE_TEMPLATE = [
                        {
                            lib: 'library_images',
                            element: 'image',
                            loader: "COLLADAImage"
                        }, 
                        {
                            lib: 'library_effects',
                            element: 'effect',
                            loader: "COLLADAEffect"
                        }, 
                        {
                            lib: 'library_materials',
                            element: 'material',
                            loader: "COLLADAMaterial"
                        }, 
                        {
                            lib: 'library_geometries',
                            element: 'geometry',
                            loader: "COLLADAGeometrie"
                        }, 
                        {
                            lib: 'library_controllers',
                            element: 'controller',
                            loader: "COLLADAController"
                        }, 
                        {
                            lib: 'library_visual_scenes',
                            element: 'visual_scene',
                            loader: "COLLADAVisualScene"
                        }
                    ];
                    Collada.ANIMATION_TEMPLATE = [
                        {
                            lib: 'library_animations',
                            element: 'animation',
                            loader: "COLLADAAnimation"
                        }
                    ];
                    Collada.COLLADA_MATERIAL_NAMES = [
                        "emission", 
                        "ambient", 
                        "diffuse", 
                        "shininess", 
                        "reflective", 
                        "reflectivity", 
                        "transparent", 
                        "transparency", 
                        "specular"
                    ];
                    Collada.prototype.trifanToTriangles = function (pXML, iStride) {
                        var pFans2Tri = [
                            0, 
                            0, 
                            0
                        ];
                        var pData = [];
                        var tmp = new Array(iStride), n;
                        var pIndexes = [];
                        this.eachByTag(pXML, "p", function (pXMLData) {
                            n = string2IntArray(stringData(pXMLData), pData);
                            for(var i = 0; i < 3; i++) {
                                retrieve(pData, tmp, iStride, i, 1);
                                for(var j = 0; j < iStride; ++j) {
                                    pIndexes.push(tmp[j]);
                                }
                            }
                            for(var i = 3, m = n / iStride; i < m; i++) {
                                pFans2Tri[1] = i - 1;
                                pFans2Tri[2] = i;
                                for(var j = 0; j < pFans2Tri.length; ++j) {
                                    for(var k = 0; k < iStride; ++k) {
                                        pIndexes.push(pData[pFans2Tri[j] * iStride + k]);
                                    }
                                }
                            }
                        });
                        return pIndexes;
                    };
                    Collada.prototype.polygonToTriangles = function (pXML, iStride) {
                        return this.trifanToTriangles(pXML, iStride);
                    };
                    Collada.prototype.tristripToTriangles = function (pXML, iStride) {
                        var pStrip2Tri = [
                            0, 
                            0, 
                            0
                        ];
                        var pData = [];
                        var tmp = new Array(iStride), n;
                        var pIndexes = [];
                        this.eachByTag(pXML, "p", function (pXMLData) {
                            n = string2IntArray(stringData(pXMLData), pData);
                            for(var i = 0; i < 3; i++) {
                                retrieve(pData, tmp, iStride, i, 1);
                                for(var j = 0; j < iStride; ++j) {
                                    pIndexes.push(tmp[j]);
                                }
                            }
                            for(var i = 3, m = n / iStride; i < m; i++) {
                                pStrip2Tri[0] = i - 1;
                                pStrip2Tri[1] = i - 2;
                                pStrip2Tri[2] = i;
                                for(var j = 0; j < pStrip2Tri.length; ++j) {
                                    for(var k = 0; k < iStride; ++k) {
                                        pIndexes.push(pData[pStrip2Tri[j] * iStride + k]);
                                    }
                                }
                            }
                        });
                        return pIndexes;
                    };
                    Collada.prototype.polylistToTriangles = function (pXML, iStride) {
                        var pXMLvcount = firstChild(pXML, "vcount");
                        var pXMLp = firstChild(pXML, "p");
                        var pVcount = new Array(parseInt(attr(pXML, "count")));
                        var pData, pIndexes;
                        var n, h = 0;
                        var tmp = new Array(128);
                        var buf = new Array(256);
                        var pPoly2Tri = [
                            0, 
                            0, 
                            0
                        ];
                        string2IntArray(stringData(pXMLvcount), pVcount);
                        var nElements = 0, nTotalElement = 0;
                        for(var i = 0; i < pVcount.length; i++) {
                            nElements += pVcount[i];
                            nTotalElement += (pVcount[i] - 2) * 3;
                        }
                        pIndexes = new Array(iStride * nTotalElement);
                        pData = new Array(iStride * nElements);
                        string2IntArray(stringData(pXMLp), pData);
                        for(var i = 0, m = 0; i < pVcount.length; i++) {
                            n = retrieve(pData, tmp, iStride, m, pVcount[i]);
                            for(var j = 0; j < 3; j++) {
                                retrieve(tmp, buf, iStride, j, 1);
                                for(var k = 0; k < iStride; ++k) {
                                    pIndexes[h++] = buf[k];
                                }
                            }
                            for(var x = 3, t = n / iStride; x < t; x++) {
                                pPoly2Tri[1] = x - 1;
                                pPoly2Tri[2] = x;
                                for(var j = 0; j < pPoly2Tri.length; ++j) {
                                    for(var k = 0; k < iStride; ++k) {
                                        pIndexes[h++] = pData[(m + pPoly2Tri[j]) * iStride + k];
                                    }
                                }
                            }
                            m += pVcount[i];
                        }
                        return pIndexes;
                    };
                    Collada.prototype.eachNode = function (pXMLList, fnCallback, nMax) {
                        var n = pXMLList.length, i;
                        nMax = ((typeof (nMax) === "number") ? (nMax < n ? nMax : n) : n);
                        n = 0;
                        i = 0;
                        while(n < pXMLList.length) {
                            if (pXMLList[n++].nodeType === Node.TEXT_NODE) {
                                continue;
                            }
                            var pXMLData = pXMLList[n - 1];
                            fnCallback.call(this, pXMLData, pXMLData.nodeName);
                            i++;
                            if (nMax === i) {
                                break;
                            }
                        }
                    };
                    Collada.prototype.eachChild = function (pXML, fnCallback) {
                        this.eachNode(pXML.childNodes, fnCallback);
                    };
                    Collada.prototype.eachByTag = function (pXML, sTag, fnCallback, nMax) {
                        this.eachNode(pXML.getElementsByTagName(sTag), fnCallback, nMax);
                    };
                    Collada.prototype.findNode = function (pNodes, sNode, fnNodeCallback) {
                        if (typeof sNode === "undefined") { sNode = null; }
                        if (typeof fnNodeCallback === "undefined") { fnNodeCallback = null; }
                        var pNode = null;
                        var pRootJoint = null;
                        for(var i = pNodes.length - 1; i >= 0; i--) {
                            pNode = pNodes[i];
                            if (pNode === null) {
                                continue;
                            }
                            if (sNode && "#" + pNode.id === sNode) {
                                return pNode;
                            }
                            if (!((fnNodeCallback) === null)) {
                                fnNodeCallback.call(this, pNode);
                            }
                            if (pNode.childNodes) {
                                pRootJoint = this.findNode(pNode.childNodes, sNode, fnNodeCallback);
                                if (!((pRootJoint) === null)) {
                                    return pRootJoint;
                                }
                            }
                        }
                        return null;
                    };
                    Collada.prototype.COLLADATranslateMatrix = function (pXML) {
                        var pData = new Array(3);
                        string2FloatArray(stringData(pXML), pData);
                        return (akra.vec3(pData)).toTranslationMatrix();
                    };
                    Collada.prototype.COLLADARotateMatrix = function (pXML) {
                        var pData = new Array(4);
                        string2FloatArray(stringData(pXML), pData);
                        return (new akra.Mat4(1)).rotateLeft(pData[3] * Math.PI / 180.0, akra.vec3(pData[0], pData[1], pData[2]));
                    };
                    Collada.prototype.COLLADAScaleMatrix = function (pXML) {
                        var pData = new Array(3);
                        string2FloatArray(stringData(pXML), pData);
                        return new akra.Mat4(pData[0], pData[1], pData[2], 1.0);
                    };
                    Collada.prototype.COLLADAData = function (pXML) {
                        var sName = pXML.nodeName;
                        var sData = stringData(pXML);
                        switch(sName) {
                            case "bool":
                                return string2Any(sData, 1, "bool");
                            case "int":
                                return string2Any(sData, 1, "int");
                            case "float":
                                return string2Any(sData, 1, "float");
                            case "float2":
                                return string2Any(sData, 2, "float");
                            case "float3":
                                return string2Any(sData, 3, "float");
                            case "float4":
                            case "color":
                                return string2Any(sData, 4, "float");
                            case "rotate":
                                return this.COLLADARotateMatrix(pXML);
                            case "translate":
                                return this.COLLADATranslateMatrix(pXML);
                            case "scale":
                                return this.COLLADAScaleMatrix(pXML);
                            case "bind_shape_matrix":
                            case "matrix":
                                return (new akra.Mat4(string2Any(sData, 16, "float"), true)).transpose();
                            case "float_array":
                                return string2Any(sData, parseInt(attr(pXML, "count")), "float", true);
                            case "int_array":
                                return string2Any(sData, parseInt(attr(pXML, "count")), "int", true);
                            case "bool_array":
                                return string2Any(sData, parseInt(attr(pXML, "count")), "bool", true);
                            case "Name_array":
                            case "name_array":
                            case "IDREF_array":
                                return string2Any(sData, parseInt(attr(pXML, "count")), "string", true);
                            case "sampler2D":
                                return this.COLLADASampler2D(pXML);
                            case "surface":
                                return this.COLLADASurface(pXML);
                            default:
 {
                                    akra.logger.setSourceLocation("resources/Collada.ts", 597);
                                    akra.logger.error("unsupported COLLADA data type <" + sName + " />");
                                }
                                ;
                        }
                    };
                    Collada.prototype.COLLADAGetSourceData = function (pSource, pFormat) {
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 605);
                            akra.logger.assert(((pSource) != null), "<source /> with expected format ", pFormat, " not founded");
                        }
                        ;
                        var nStride = calcFormatStride(pFormat);
                        var pTech = pSource.techniqueCommon;
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 610);
                            akra.logger.assert(((pTech) != null), "<source /> with id <" + pSource.id + "> has no <technique_common />");
                        }
                        ;
                        var pAccess = pTech.accessor;
                        var isFormatSupported;
                        if (!(pAccess.stride <= nStride)) {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 617);
                                akra.logger.log(pAccess.stride, "/", nStride);
                            }
                            ;
                        }
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 622);
                            akra.logger.assert(pAccess.stride <= nStride, "<source /> width id" + pSource.id + " has unsupported stride: " + pAccess.stride);
                        }
                        ;
                        var fnUnsupportedFormatError = function () {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 625);
                                akra.logger.log("expected format: ", pFormat);
                            }
                            ;
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 626);
                                akra.logger.log("given format: ", pAccess.params);
                            }
                            ;
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 627);
                                akra.logger.error("accessor of <" + pSource.id + "> has unsupported format");
                            }
                            ;
                        };
                        for(var i = 0; i < pAccess.params.length; ++i) {
                            isFormatSupported = false;
                            for(var f = 0; f < pFormat[i].name.length; ++f) {
                                if ((pAccess.params[i].name || "").toLowerCase() == (pFormat[i].name[f] || "").toLowerCase()) {
                                    isFormatSupported = true;
                                }
                            }
                            if (!isFormatSupported) {
                                fnUnsupportedFormatError();
                            }
                            isFormatSupported = false;
                            for(var f = 0; f < pFormat[i].type.length; ++f) {
                                if (pAccess.params[i].type.toLowerCase() == pFormat[i].type[f].toLowerCase()) {
                                    isFormatSupported = true;
                                }
                            }
                            if (!isFormatSupported) {
                                fnUnsupportedFormatError();
                            }
                        }
                        return pAccess.data;
                    };
                    Collada.prototype.COLLADATransform = function (pXML, id) {
                        var pTransform = {
                            sid: attr(pXML, "sid"),
                            transform: String(pXML.nodeName),
                            value: null
                        };
                        if ((typeof (id) === "string") && ((pTransform.sid) != null)) {
                            this.link(id + "/" + pTransform.sid, pTransform);
                        } else {
                            this.link(id + "/" + pTransform.transform, pTransform);
                        }
                        var v4f, m4f;
                        var pData;
                        switch(pTransform.transform) {
                            case "rotate":
                                pData = new Array(4);
                                string2FloatArray(stringData(pXML), pData);
                                v4f = new akra.Vec4(pData);
                                v4f.w *= Math.PI / 180.0;
                                pTransform.value = v4f;
                                break;
                            case "translate":
                            case "scale":
                                pData = new Array(3);
                                string2FloatArray(stringData(pXML), pData);
                                pTransform.value = new akra.Vec3(pData);
                                break;
                            case "matrix":
                                m4f = new akra.Mat4();
                                string2FloatArray(stringData(pXML), m4f.data);
                                m4f.transpose();
                                pTransform.value = m4f;
                                break;
                            default:
 {
                                    akra.logger.setSourceLocation("resources/Collada.ts", 714);
                                    akra.logger.error("unsupported transform detected: " + pTransform.transform);
                                }
                                ;
                        }
                        return pTransform;
                    };
                    Collada.prototype.COLLADANewParam = function (pXML) {
                        var _this = this;
                        var pParam = {
                            sid: attr(pXML, "sid"),
                            annotate: null,
                            semantics: null,
                            modifier: null,
                            value: null,
                            type: null
                        };
                        this.eachChild(pXML, function (pXMLData, sName) {
                            switch(sName) {
                                case "semantic":
                                    pParam.semantics = stringData(pXMLData);
                                    break;
                                case "modifier":
                                    pParam.modifier = stringData(pXMLData);
                                case "annotate":
                                    pParam.annotate = {
                                        name: attr(pXMLData, "name"),
                                        value: stringData(pXMLData)
                                    };
                                case "float":
                                case "float2":
                                case "float3":
                                case "float4":
                                case "surface":
                                case "sampler2D":
                                    pParam.type = sName;
                                    pParam.value = _this.COLLADAData(pXMLData);
                                    break;
                                default:
                                    pParam.value = _this.COLLADAData(pXMLData);
                            }
                        });
                        this.link(pParam.sid, pParam);
                        return pParam;
                    };
                    Collada.prototype.COLLADAAsset = function (pXML) {
                        var pAsset = {
                            unit: {
                                meter: 1.0,
                                name: "meter"
                            },
                            upAxis: "Y_UP",
                            title: null,
                            created: null,
                            modified: null,
                            contributor: {
                                author: null,
                                authoringTool: null,
                                comments: null,
                                copyright: null,
                                sourceData: null
                            }
                        };
                        this.eachChild(pXML, function (pXMLNode, sName) {
                            var sValue = stringData(pXMLNode);
                            switch(sName) {
                                case "up_axis":
                                    pAsset.upAxis = sValue;
                                    break;
                                case "created":
                                    pAsset.created = sValue;
                                    break;
                                case "modified":
                                    pAsset.modified = sValue;
                                    break;
                                case "title":
                                    pAsset.title = sValue;
                                    break;
                                case "contributor":
                                    break;
                                case "unit":
                                    pAsset.unit.meter = parseFloat(attr(pXMLNode, "meter"));
                                    pAsset.unit.name = attr(pXMLNode, "name");
                                    break;
                            }
                        });
                        return this._pAsset = pAsset;
                    };
                    Collada.prototype.COLLADALibrary = function (pXML, pTemplate) {
                        var _this = this;
                        if (!((pXML) != null)) {
                            return null;
                        }
                        var pLib = {};
                        var pData;
                        var sTag = pTemplate.element;
                        var iAutoId = 0;
                        pLib[sTag] = {};
                        this.eachChild(pXML, function (pXMLData, sName) {
                            if (sTag !== sName) {
                                return;
                            }
                            pData = (((_this)[pTemplate.loader]))(pXMLData);
                            if (((pData) === null)) {
                                return;
                            }
                            pLib[sTag][attr(pXMLData, 'id') || (sTag + "_" + (iAutoId++))] = pData;
                        });
                        return pLib;
                    };
                    Collada.prototype.COLLADAAccessor = function (pXML) {
                        var pAccessor = {
                            data: this.source(attr(pXML, "source")),
                            count: parseInt(attr(pXML, "count")),
                            stride: parseInt(attr(pXML, "stride") || 1),
                            params: []
                        };
                        this.eachChild(pXML, function (pXMLData, sName) {
                            pAccessor.params.push({
                                name: attr(pXMLData, "name"),
                                type: attr(pXMLData, "type")
                            });
                        });
                        return pAccessor;
                    };
                    Collada.prototype.COLLADAInput = function (pXML, iOffset) {
                        if (typeof iOffset === "undefined") { iOffset = 0; }
                        var pInput = {
                            semantics: attr(pXML, "semantic"),
                            source: this.source(attr(pXML, "source")),
                            offset: -1,
                            set: attr(pXML, "set")
                        };
                        if (!((attr(pXML, "offset")) === null)) {
                            pInput.offset = parseInt(attr(pXML, "offset"));
                        }
                        if ((typeof (iOffset) === "number") && pInput.offset === -1) {
                            pInput.offset = iOffset;
                        }
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 891);
                            akra.logger.assert((typeof (pInput.offset) === "number") && pInput.offset >= 0, "invalid offset detected");
                        }
                        ;
                        return pInput;
                    };
                    Collada.prototype.COLLADATechniqueCommon = function (pXML) {
                        var _this = this;
                        var pTechniqueCommon = {
                            accessor: null
                        };
                        this.eachChild(pXML, function (pXMLData, sName) {
                            switch(sName) {
                                case "accessor":
                                    pTechniqueCommon.accessor = _this.COLLADAAccessor(pXMLData);
                                    break;
                            }
                        });
                        return pTechniqueCommon;
                    };
                    Collada.prototype.COLLADASource = function (pXML) {
                        var _this = this;
                        var pSource = {
                            id: attr(pXML, "id"),
                            name: attr(pXML, "name"),
                            array: {},
                            techniqueCommon: null
                        };
                        this.link(pSource);
                        this.eachChild(pXML, function (pXMLData, sName) {
                            var pColladaArray;
                            var id;
                            switch(sName.toLowerCase()) {
                                case "int_array":
                                case "bool_array":
                                case "float_array":
                                case "idref_array":
                                case "name_array":
                                    pColladaArray = _this.COLLADAData(pXMLData);
                                    id = attr(pXMLData, "id");
                                    pSource.array[id] = pColladaArray;
                                    _this.link(id, pColladaArray);
                                    break;
                                case "technique_common":
                                    pSource.techniqueCommon = _this.COLLADATechniqueCommon(pXMLData);
                                    break;
                            }
                        });
                        return pSource;
                    };
                    Collada.prototype.COLLADAVertices = function (pXML) {
                        var pVertices = {
                            id: attr(pXML, "id"),
                            inputs: {}
                        };
                        this.eachByTag(pXML, "input", function (pXMLData) {
                            var sSemantic = attr(pXMLData, "semantic");
                            pVertices.inputs[sSemantic] = this.COLLADAInput(pXMLData);
                        });
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 963);
                            akra.logger.assert(((pVertices.inputs["POSITION"]) != null), "semantics POSITION must be in the <vertices /> tag");
                        }
                        ;
                        this.link(pVertices);
                        return pVertices;
                    };
                    Collada.prototype.COLLADAJoints = function (pXML) {
                        var _this = this;
                        var pJoints = {
                            inputs: {}
                        };
                        var pMatrixArray;
                        var iCount;
                        var pInvMatrixArray;
                        this.eachByTag(pXML, "input", function (pXMLData) {
                            switch(attr(pXMLData, "semantic")) {
                                case "JOINT":
                                    pJoints.inputs["JOINT"] = _this.COLLADAInput(pXMLData);
                                    break;
                                case "INV_BIND_MATRIX":
                                    pJoints.inputs["INV_BIND_MATRIX"] = _this.COLLADAInput(pXMLData);
                                    break;
                                default:
 {
                                        akra.logger.setSourceLocation("resources/Collada.ts", 990);
                                        akra.logger.error("semantics are different from JOINT/INV_BIND_MATRIX is not supported in the <joints /> tag");
                                    }
                                    ;
                            }
                        });
                        for(var sInput in pJoints.inputs) {
                            this.prepareInput(pJoints.inputs[sInput]);
                            if (sInput === "INV_BIND_MATRIX") {
                                pInvMatrixArray = new Float32Array(pJoints.inputs[sInput].array);
                                iCount = pInvMatrixArray.length / 16;
                                pMatrixArray = new Array(iCount);
                                for(var j = 0, n = 0; j < pInvMatrixArray.length; j += 16) {
                                    pMatrixArray[n++] = (new akra.Mat4(new Float32Array(pInvMatrixArray.buffer, j * Float32Array.BYTES_PER_ELEMENT, 16), true)).transpose();
                                }
                                pJoints.inputs[sInput].array = pMatrixArray;
                            }
                        }
                        return pJoints;
                    };
                    Collada.prototype.COLLADAPolygons = function (pXML, sType) {
                        var _this = this;
                        var pPolygons = {
                            inputs: [],
                            p: null,
                            material: attr(pXML, "material"),
                            name: null,
                            count: parseInt(attr(pXML, "count"))
                        };
                        var iOffset = 0, n = 0;
                        var iCount = parseInt(attr(pXML, "count"));
                        var iStride = 0;
                        this.eachByTag(pXML, "input", function (pXMLData) {
                            pPolygons.inputs.push(_this.COLLADAInput(pXMLData, iOffset));
                            iOffset++;
                        });
                        sortArrayByProperty(pPolygons.inputs, "iOffset");
                        for(var i = 0; i < pPolygons.inputs.length; ++i) {
                            iStride = akra.math.max((pPolygons.inputs[i]).offset + 1, iStride);
                        }
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 1042);
                            akra.logger.assert(iStride > 0, "Invalid offset detected.");
                        }
                        ;
                        switch(sType) {
                            case "polylist":
                                pPolygons.p = this.polylistToTriangles(pXML, iStride);
                                break;
                            case "polygons":
                                pPolygons.p = this.polygonToTriangles(pXML, iStride);
                                this.eachByTag(pXML, "ph", function (pXMLData) {
 {
                                        akra.logger.setSourceLocation("resources/Collada.ts", 1053);
                                        akra.logger.error("unsupported polygon[polygon] subtype founded: <ph>");
                                    }
                                    ;
                                });
                                break;
                            case "triangles":
                                pPolygons.p = new Array(3 * iCount * iStride);
                                this.eachByTag(pXML, "p", function (pXMLData) {
                                    n += string2IntArray(stringData(pXMLData), pPolygons.p, n);
                                });
                                break;
                            case "trifans":
                                pPolygons.p = this.trifanToTriangles(pXML, iStride);
                                break;
                            case "tristrips":
                                pPolygons.p = this.tristripToTriangles(pXML, iStride);
                                break;
                            default:
 {
                                    akra.logger.setSourceLocation("resources/Collada.ts", 1075);
                                    akra.logger.error("unsupported polygon[" + sType + "] type founded");
                                }
                                ;
                        }
                        if (!((pPolygons.type) !== undefined)) {
                            pPolygons.type = akra.EPrimitiveTypes.TRIANGLELIST;
                        }
                        return pPolygons;
                    };
                    Collada.prototype.COLLADAVertexWeights = function (pXML) {
                        var _this = this;
                        var pVertexWeights = {
                            count: parseInt(attr(pXML, "count")),
                            inputs: [],
                            weightInput: null,
                            vcount: null,
                            v: null
                        };
                        var iOffset = 0;
                        var pInput;
                        this.eachByTag(pXML, "input", function (pXMLData) {
                            pInput = _this.COLLADAInput(pXMLData, iOffset);
                            if (pInput.semantics === "WEIGHT") {
                                pVertexWeights.weightInput = pInput;
                            }
                            pVertexWeights.inputs.push(pInput);
                            iOffset++;
                        });
                        var pVcountData, pVData;
                        pVcountData = new Array(pVertexWeights.count);
                        string2IntArray(stringData(firstChild(pXML, "vcount")), pVcountData);
                        pVertexWeights.vcount = pVcountData;
                        var n = 0;
                        for(var i = 0; i < pVcountData.length; ++i) {
                            n += pVcountData[i];
                        }
                        n *= pVertexWeights.inputs.length;
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 1125);
                            akra.logger.assert(pVertexWeights.inputs.length === 2, "more than 2 inputs in <vertex_weights/> not supported currently");
                        }
                        ;
                        pVData = new Array(n);
                        string2IntArray(stringData(firstChild(pXML, "v")), pVData);
                        pVertexWeights.v = pVData;
                        return pVertexWeights;
                    };
                    Collada.prototype.COLLADAMesh = function (pXML) {
                        var _this = this;
                        var pMesh = {
                            sources: [],
                            polygons: []
                        };
                        var id;
                        var pPolygons, pVertices, pPos;
                        this.eachChild(pXML, function (pXMLData, sName) {
                            switch(sName) {
                                case "source":
                                    pMesh.sources.push(_this.COLLADASource(pXMLData));
                                    break;
                                case "vertices":
                                    pVertices = _this.COLLADAVertices(pXMLData);
                                    break;
                                case "lines":
                                case "linestrips":
                                case "tristrips":
                                case "trifans":
                                case "triangles":
                                case "polygons":
                                case "polylist":
                                    pPolygons = _this.COLLADAPolygons(pXMLData, sName);
                                    for(var i = 0; i < pPolygons.inputs.length; ++i) {
                                        pPos = null;
                                        if (pPolygons.inputs[i].semantics == "VERTEX") {
                                            if (pPolygons.inputs[i].source.id == pVertices.id) {
                                                pPos = pVertices.inputs["POSITION"];
                                                pPolygons.inputs[i].source = pPos.source;
                                                pPolygons.inputs[i].semantics = pPos.semantics;
                                            } else {
 {
                                                    akra.logger.setSourceLocation("resources/Collada.ts", 1175);
                                                    akra.logger.error("<input /> with semantic VERTEX must refer to <vertices /> tag in same mesh.");
                                                }
                                                ;
                                            }
                                        }
                                        _this.prepareInput(pPolygons.inputs[i]);
                                    }
                                    pMesh.polygons.push(pPolygons);
                                    break;
                            }
                        });
                        return pMesh;
                    };
                    Collada.prototype.COLLADAGeometrie = function (pXML) {
                        var pGeometrie = {
                            id: attr(pXML, "id"),
                            name: attr(pXML, "name"),
                            mesh: null,
                            convexMesh: null,
                            spline: null
                        };
                        var pXMLData = firstChild(pXML);
                        var sName = pXMLData.nodeName;
                        if (sName == "mesh") {
                            pGeometrie.mesh = this.COLLADAMesh(pXMLData);
                        }
                        this.link(pGeometrie);
                        return pGeometrie;
                    };
                    Collada.prototype.COLLADASkin = function (pXML) {
                        var _this = this;
                        var pSkin = {
                            shapeMatrix: this.COLLADAData(firstChild(pXML, "bind_shape_matrix")),
                            sources: [],
                            geometry: this.source(attr(pXML, "source")),
                            joints: null,
                            vertexWeights: null
                        };
                        var pVertexWeights, pInput;
                        this.eachChild(pXML, function (pXMLData, sName) {
                            switch(sName) {
                                case "source":
                                    pSkin.sources.push(_this.COLLADASource(pXMLData));
                                    break;
                                case "joints":
                                    pSkin.joints = _this.COLLADAJoints(pXMLData);
                                    break;
                                case "vertex_weights":
                                    pVertexWeights = _this.COLLADAVertexWeights(pXMLData);
                                    for(var i = 0; i < pVertexWeights.inputs.length; ++i) {
                                        pInput = _this.prepareInput(pVertexWeights.inputs[i]);
                                    }
                                    pSkin.vertexWeights = pVertexWeights;
                                    break;
                            }
                        });
                        return pSkin;
                    };
                    Collada.prototype.COLLADAController = function (pXML) {
                        var pController = {
                            name: attr(pXML, "name"),
                            id: attr(pXML, "id"),
                            skin: null,
                            morph: null
                        };
                        var pXMLData = firstChild(pXML, "skin");
                        if (!((pXMLData) === null)) {
                            pController.skin = this.COLLADASkin(pXMLData);
                        } else {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 1264);
                                akra.logger.warning("Founded controller without skin element!");
                            }
                            ;
                            return null;
                        }
                        this.link(pController);
                        return pController;
                    };
                    Collada.prototype.COLLADAImage = function (pXML) {
                        var pImage = {
                            id: attr(pXML, "id"),
                            name: attr(pXML, "name"),
                            format: attr(pXML, "format"),
                            height: parseInt(attr(pXML, "height") || -1),
                            width: parseInt(attr(pXML, "width") || -1),
                            depth: 1,
                            data: null,
                            path: null
                        };
                        var sFilename = this.getFilename();
                        var sPath = null;
                        var pXMLInitData = firstChild(pXML, "init_from"), pXMLData;
                        if (((pXMLInitData) != null)) {
                            sPath = stringData(pXMLInitData);
                            if (!((sFilename) === null)) {
                                if (!akra.util.pathinfo(sPath).isAbsolute()) {
                                    sPath = akra.util.pathinfo(sFilename).dirname + "/" + sPath;
                                }
                            }
                            pImage.path = sPath;
                        } else if (((pXMLData = firstChild(pXML, "data")) != null)) {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 1307);
                                akra.logger.error("image loading from <data /> tag unsupported yet.");
                            }
                            ;
                        } else {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 1310);
                                akra.logger.error("image with id: " + pImage.id + " has no data.");
                            }
                            ;
                        }
                        this.link(pImage);
                        return pImage;
                    };
                    Collada.prototype.COLLADASurface = function (pXML) {
                        var pSurface = {
                            initFrom: stringData(firstChild(pXML, "init_from"))
                        };
                        return pSurface;
                    };
                    Collada.prototype.COLLADATexture = function (pXML) {
                        if (!((pXML) != null)) {
                            return null;
                        }
                        var pTexture = {
                            texcoord: attr(pXML, "texcoord"),
                            sampler: this.source(attr(pXML, "texture")),
                            surface: null,
                            image: null
                        };
                        if (!((pTexture.sampler) === null) && ((pTexture.sampler.value) != null)) {
                            pTexture.surface = this.source((pTexture.sampler.value).source);
                        }
                        if (!((pTexture.surface) === null)) {
                            pTexture.image = this.source((pTexture.surface.value).initFrom);
                        }
                        return pTexture;
                    };
                    Collada.prototype.COLLADASampler2D = function (pXML) {
                        var pSampler = {
                            source: stringData(firstChild(pXML, "source")),
                            wrapS: stringData(firstChild(pXML, "wrap_s")),
                            wrapT: stringData(firstChild(pXML, "wrap_t")),
                            minFilter: stringData(firstChild(pXML, "minfilter")),
                            mipFilter: stringData(firstChild(pXML, "mipfilter")),
                            magFilter: stringData(firstChild(pXML, "magfilter"))
                        };
                        return pSampler;
                    };
                    Collada.prototype.COLLADAPhong = function (pXML) {
                        var _this = this;
                        var pMat = {
                            diffuse: new akra.Color(0.),
                            specular: new akra.Color(0.),
                            ambient: new akra.Color(0.),
                            emissive: new akra.Color(0.),
                            shininess: 0.0,
                            reflective: new akra.Color(0.),
                            reflectivity: 0.0,
                            transparent: new akra.Color(0.),
                            transparency: 0.0,
                            indexOfRefraction: 0.0,
                            textures: {
                                diffuse: null,
                                specular: null,
                                ambient: null,
                                emissive: null,
                                normal: null
                            }
                        };
                        var pXMLData;
                        var pList = Collada.COLLADA_MATERIAL_NAMES;
                        for(var i = 0; i < pList.length; i++) {
                            var csComponent = pList[i];
                            pXMLData = firstChild(pXML, csComponent);
                            if (csComponent === "emission") {
                                csComponent = "emissive";
                            }
                            if (pXMLData) {
                                this.eachChild(pXMLData, function (pXMLData, sName) {
                                    switch(sName) {
                                        case "float":
                                            pMat[csComponent] = _this.COLLADAData(pXMLData);
                                            break;
                                        case "color":
                                            pMat[csComponent].set(_this.COLLADAData(pXMLData));
                                            break;
                                        case "texture":
                                            pMat.textures[csComponent] = _this.COLLADATexture(pXMLData);
                                    }
                                });
                            }
                        }
                        pMat.shininess *= 10.0;
                        return pMat;
                    };
                    Collada.prototype.COLLADAEffectTechnique = function (pXML) {
                        var pTech = {
                            sid: attr(pXML, "sid"),
                            type: null,
                            value: null
                        };
                        var pValue = firstChild(pXML);
                        pTech.type = pValue.nodeName;
                        switch(pTech.type) {
                            case "blinn":
                            case "lambert":
 {
                                    akra.logger.setSourceLocation("resources/Collada.ts", 1445);
                                    akra.logger.warning("<blinn /> or <lambert /> material interprated as phong");
                                }
                                ;
                            case "phong":
                                pTech.value = this.COLLADAPhong(pValue);
                                break;
                            default:
 {
                                    akra.logger.setSourceLocation("resources/Collada.ts", 1451);
                                    akra.logger.error("unsupported technique <" + pTech.type + " /> founded");
                                }
                                ;
                        }
                        var pXMLExtra = firstChild(pXML, "extra");
                        if (((pXMLExtra) != null)) {
                            var pXMLTech = firstChild(pXMLExtra, "technique");
                            if (((pXMLTech) != null)) {
                                var pXMLBump = firstChild(pXMLTech, "bump");
                                if (((pXMLBump) != null) && attr(pXMLBump, "bumptype") === "HEIGHTFIELD") {
                                    (pTech.value).textures.normal = this.COLLADATexture(firstChild(pXMLBump, "texture"));
                                }
                            }
                        }
                        this.link(pTech.sid, pTech);
                        return pTech;
                    };
                    Collada.prototype.COLLADAProfileCommon = function (pXML) {
                        var _this = this;
                        var pProfile = {
                            technique: null,
                            newParam: {}
                        };
                        this.eachByTag(pXML, "newparam", function (pXMLData) {
                            pProfile.newParam[attr(pXMLData, "sid")] = _this.COLLADANewParam(pXMLData);
                        });
                        pProfile.technique = this.COLLADAEffectTechnique(firstChild(pXML, "technique"));
                        return pProfile;
                    };
                    Collada.prototype.COLLADAEffect = function (pXML) {
                        var _this = this;
                        var pEffect = {
                            id: attr(pXML, "id"),
                            profileCommon: null
                        };
                        this.eachChild(pXML, function (pXMLData, sName) {
                            switch(sName) {
                                case "profile_COMMON":
                                    pEffect.profileCommon = _this.COLLADAProfileCommon(pXMLData);
                                    pEffect.profileCommon.technique.value.name = pEffect.id;
                                    break;
                                default:
 {
                                        akra.logger.setSourceLocation("resources/Collada.ts", 1509);
                                        akra.logger.warning("<" + sName + " /> unsupported in effect section");
                                    }
                                    ;
                            }
                        });
                        this.link(pEffect);
                        return pEffect;
                    };
                    Collada.prototype.COLLADAMaterial = function (pXML) {
                        var pMaterial = {
                            id: attr(pXML, "id"),
                            name: attr(pXML, "name"),
                            instanceEffect: this.COLLADAInstanceEffect(firstChild(pXML, "instance_effect"))
                        };
                        this.link(pMaterial);
                        return pMaterial;
                    };
                    Collada.prototype.COLLADANode = function (pXML, iDepth) {
                        if (typeof iDepth === "undefined") { iDepth = 0; }
                        var _this = this;
                        var pNode = {
                            id: attr(pXML, "id"),
                            sid: attr(pXML, "sid"),
                            name: attr(pXML, "name") || "unknown",
                            type: attr(pXML, "type"),
                            layer: attr(pXML, "layer"),
                            transform: new akra.Mat4(1),
                            geometry: [],
                            controller: [],
                            childNodes: [],
                            depth: iDepth,
                            transforms: [],
                            constructedNode: null
                        };
                        var m4fMatrix;
                        var sType;
                        var id, sid;
                        this.link(pNode);
                        this.eachChild(pXML, function (pXMLData, sName) {
                            switch(sName) {
                                case "rotate":
                                case "matrix":
                                case "translate":
                                case "scale":
                                    pNode.transforms.push(_this.COLLADATransform(pXMLData, pNode.id));
                                    pNode.transform.multiply(_this.COLLADAData(pXMLData));
                                    break;
                                case "instance_geometry":
                                    pNode.geometry.push(_this.COLLADAInstanceGeometry(pXMLData));
                                    break;
                                case "instance_controller":
                                    pNode.controller.push(_this.COLLADAInstanceController(pXMLData));
                                    break;
                                case "node":
                                    pNode.childNodes.push(_this.COLLADANode(pXMLData, iDepth + 1));
                                    break;
                            }
                        });
                        return pNode;
                    };
                    Collada.prototype.COLLADAVisualScene = function (pXML) {
                        var _this = this;
                        var pNode;
                        var pScene = {
                            id: attr(pXML, "id"),
                            name: attr(pXML, "name"),
                            nodes: []
                        };
                        this.link(pScene);
                        this.eachChild(pXML, function (pXMLData, sName) {
                            switch(sName) {
                                case "node":
                                    pNode = _this.COLLADANode(pXMLData);
                                    if (((pNode) != null)) {
                                        pScene.nodes.push(pNode);
                                    }
                                    break;
                            }
                        });
                        return pScene;
                    };
                    Collada.prototype.COLLADABindMaterial = function (pXML) {
                        var _this = this;
                        if (!((pXML) != null)) {
                            return null;
                        }
                        var pMaterials = {};
                        var pMat = null;
                        var pSourceMat = null;
                        var pTech = firstChild(pXML, "technique_common");
                        this.eachByTag(pTech, "instance_material", function (pInstMat) {
                            pSourceMat = _this.source(attr(pInstMat, "target"));
                            pMat = {
                                target: attr(pInstMat, "target"),
                                symbol: attr(pInstMat, "symbol"),
                                material: pSourceMat,
                                vertexInput: {}
                            };
                            _this.eachByTag(pInstMat, "bind_vertex_input", function (pXMLVertexInput) {
                                var sInputSemantic = attr(pXMLVertexInput, "input_semantic");
                                if (sInputSemantic !== "TEXCOORD") {
 {
                                        akra.logger.setSourceLocation("resources/Collada.ts", 1643);
                                        akra.logger.error("unsupported vertex input semantics founded: " + sInputSemantic);
                                    }
                                    ;
                                }
                                var sSemantic = attr(pXMLVertexInput, "semantic");
                                var iInputSet = parseInt(attr(pXMLVertexInput, "input_set"));
                                pMat.vertexInput[sSemantic] = {
                                    semantics: sSemantic,
                                    inputSet: iInputSet,
                                    inputSemantic: sInputSemantic
                                };
                            });
                            pMaterials[pMat.symbol] = pMat;
                        });
                        return pMaterials;
                    };
                    Collada.prototype.COLLADAInstanceEffect = function (pXML) {
                        var _this = this;
                        var pInstance = {
                            parameters: {},
                            techniqueHint: {},
                            effect: null
                        };
                        pInstance.effect = this.source(attr(pXML, "url"));
                        this.eachByTag(pXML, "technique_hint", function (pXMLData) {
                            pInstance.techniqueHint[attr(pXMLData, "platform")] = attr(pXMLData, "ref");
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 1685);
                                akra.logger.warning("<technique_hint /> used, but will be ignored!");
                            }
                            ;
                        });
                        this.eachByTag(pXML, "setparam", function (pXMLData) {
                            pInstance.parameters[attr(pXMLData, "ref")] = _this.COLLADAData(pXMLData);
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 1691);
                                akra.logger.warning("<setparam /> used, but will be ignored!");
                            }
                            ;
                        });
                        return pInstance;
                    };
                    Collada.prototype.COLLADAInstanceController = function (pXML) {
                        var pInst = {
                            controller: this.source(attr(pXML, "url")),
                            material: this.COLLADABindMaterial(firstChild(pXML, "bind_material")),
                            skeletons: []
                        };
                        this.eachByTag(pXML, "skeleton", function (pXMLData) {
                            pInst.skeletons.push(stringData(pXMLData).substr(1));
                        });
                        return pInst;
                    };
                    Collada.prototype.COLLADAInstanceGeometry = function (pXML) {
                        var pInst = {
                            geometry: this.source(attr(pXML, "url")),
                            material: this.COLLADABindMaterial(firstChild(pXML, "bind_material"))
                        };
                        return pInst;
                    };
                    Collada.prototype.COLLADAScene = function (pXML) {
                        var pXMLData = firstChild(pXML, "instance_visual_scene");
                        var pScene = this.source(attr(pXMLData, "url"));
                        if (((pXMLData) === null) || ((pScene) === null)) {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 1727);
                                akra.logger.warning("collada model: <" + this.getBasename() + "> has no visual scenes.");
                            }
                            ;
                        }
                        return this._pVisualScene = pScene;
                    };
                    Collada.prototype.COLLADAAnimationSampler = function (pXML) {
                        var _this = this;
                        var pSampler = {
                            inputs: {},
                            id: attr(pXML, "id")
                        };
                        var pInput;
                        var sSemantic;
                        this.link(pSampler);
                        this.eachByTag(pXML, "input", function (pXMLData) {
                            sSemantic = attr(pXMLData, "semantic");
                            switch(sSemantic) {
                                case "INPUT":
                                case "OUTPUT":
                                case "INTERPOLATION":
                                case "IN_TANGENT":
                                case "OUT_TANGENT":
                                    pInput = _this.prepareInput(_this.COLLADAInput(pXMLData));
                                    pSampler.inputs[sSemantic] = pInput;
                                    break;
                                default:
 {
                                        akra.logger.setSourceLocation("resources/Collada.ts", 1761);
                                        akra.logger.error("semantics are different from OUTPUT/INTERPOLATION/IN_TANGENT/OUT_TANGENT is not supported in the <sampler /> tag");
                                    }
                                    ;
                            }
                        });
                        return pSampler;
                    };
                    Collada.prototype.COLLADAAnimationChannel = function (pXML) {
                        var pChannel = {
                            sampler: this.source(attr(pXML, "source")),
                            target: this.target(attr(pXML, "target"))
                        };
                        if (((pChannel.target) === null) || ((pChannel.target.object) === null)) {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 1776);
                                akra.logger.warning("cound not setup animation channel for <" + attr(pXML, "target") + ">");
                            }
                            ;
                            return null;
                        }
                        return pChannel;
                    };
                    Collada.prototype.COLLADAAnimation = function (pXML) {
                        var _this = this;
                        var pAnimation = {
                            id: attr(pXML, "id"),
                            name: attr(pXML, "name"),
                            sources: [],
                            samplers: [],
                            channels: [],
                            animations: []
                        };
                        var pChannel;
                        var pSubAnimation;
                        this.link(pAnimation);
                        this.eachChild(pXML, function (pXMLData, sName) {
                            switch(sName) {
                                case "source":
                                    pAnimation.sources.push(_this.COLLADASource(pXMLData));
                                    break;
                                case "sampler":
                                    pAnimation.samplers.push(_this.COLLADAAnimationSampler(pXMLData));
                                    break;
                                case "channel":
                                    pChannel = _this.COLLADAAnimationChannel(pXMLData);
                                    if (((pChannel) != null)) {
                                        pAnimation.channels.push(pChannel);
                                    }
                                    break;
                                case "animation":
                                    pSubAnimation = _this.COLLADAAnimation(pXMLData);
                                    if (((pSubAnimation) != null)) {
                                        pAnimation.animations.push(pSubAnimation);
                                    }
                            }
                        });
                        if (pAnimation.channels.length == 0 && pAnimation.animations.length == 0) {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 1828);
                                akra.logger.warning("animation with id \"" + pAnimation.id + "\" skipped, because channels/sub animation are empty");
                            }
                            ;
                            return null;
                        }
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 1833);
                            akra.logger.assert(pXML.parentNode === firstChild(this.getXMLRoot(), "library_animations"), "sub animations not supported");
                        }
                        ;
                        this._pAnimations.push(pAnimation);
                        return pAnimation;
                    };
                    Collada.prototype.source = function (sUrl) {
                        if (sUrl.charAt(0) !== "#") {
                            sUrl = "#" + sUrl;
                        }
                        var pElement = this._pLinks[sUrl];
                        if (!((pElement) != null)) {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 1850);
                                akra.logger.warning("cannot find element with id: " + sUrl + ("\n" + (new Error()).stack.split("\n").slice(1).join("\n")));
                            }
                            ;
                        }
                        return pElement || null;
                    };
                    Collada.prototype.link = function (el, pTarget) {
                        var sId;
                        if (!(typeof (arguments[0]) === "string")) {
                            pTarget = arguments[0];
                            sId = pTarget.id;
                        } else {
                            sId = arguments[0];
                        }
                        this._pLinks["#" + sId] = pTarget;
                    };
                    Collada.prototype.target = function (sPath) {
                        var pObject = {
                            value: null
                        };
                        var pSource;
                        var pMatches;
                        var sValue;
                        var iPos;
                        var jPos = 0;
                        iPos = sPath.lastIndexOf("/");
                        if (iPos >= 0) {
                            pObject.source = this.source(sPath.substr(0, iPos));
                        }
                        iPos = sPath.lastIndexOf(".");
                        if (iPos < 0) {
                            iPos = sPath.indexOf("(");
                            jPos = -1;
                        }
                        if (iPos < 0) {
                            pObject.object = this.source(sPath);
                            return pObject;
                        }
                        pSource = this.source(sPath.substr(0, iPos));
                        sValue = sPath.substr(iPos + jPos + 1);
                        pObject.object = pSource;
                        if (!pSource) {
                            return null;
                        }
                        switch(sValue) {
                            case "X":
                                pObject.value = (pSource.value).x;
                                break;
                            case "Y":
                                pObject.value = (pSource.value).y;
                                break;
                            case "Z":
                                pObject.value = (pSource.value).z;
                                break;
                            case "W":
                                pObject.value = (pSource.value).w;
                                break;
                            case "ANGLE":
                                pObject.value = (pSource.value).w;
                                break;
                        }
                        if (((pObject.value) != null)) {
                            return pObject;
                        }
                        pMatches = sValue.match(/^\((\d+)\)$/);
                        if (pMatches) {
                            pObject.value = Number(pMatches[1]);
                        }
                        pMatches = sValue.match(/^\((\d+)\)\((\d+)\)$/);
                        if (pMatches) {
                            pObject.value = Number(pMatches[1]) * 4 + Number(pMatches[2]);
                        }
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 1956);
                            akra.logger.assert(((pObject.value) != null), "unsupported target value founded: " + sValue);
                        }
                        ;
                        return pObject;
                    };
                    Collada.prototype.buildAnimationTrack = function (pChannel) {
                        var sNodeId = pChannel.target.source.id;
                        var sJoint = this.source(sNodeId).sid || null;
                        var pTrack = null;
                        var pSampler = pChannel.sampler;
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 1969);
                            akra.logger.assert(((pSampler) != null), "could not find sampler for animation channel");
                        }
                        ;
                        var pInput = pSampler.inputs["INPUT"];
                        var pOutput = pSampler.inputs["OUTPUT"];
                        var pInterpolation = pSampler.inputs["INTERPOLATION"];
                        var pTimeMarks = pInput.array;
                        var pOutputValues = pOutput.array;
                        var pFloatArray;
                        var pTransform = pChannel.target.object;
                        var sTransform = pTransform.transform;
                        var v4f;
                        var pValue;
                        var nMatrices;
                        switch(sTransform) {
                            case "translate":
 {
                                    akra.logger.setSourceLocation("resources/Collada.ts", 2000);
                                    akra.logger.criticalError("TODO: implement animation translation");
                                }
                                ;
                                break;
                            case "rotate":
 {
                                    akra.logger.setSourceLocation("resources/Collada.ts", 2013);
                                    akra.logger.criticalError("TODO: implement animation rotation");
                                }
                                ;
                                break;
                            case "matrix":
                                pValue = pChannel.target.value;
                                if (((pValue) === null)) {
                                    pTrack = akra.animation.createTrack(sJoint);
                                    nMatrices = pOutputValues.length / 16;
                                    pFloatArray = new Float32Array(pOutputValues);
 {
                                        akra.logger.setSourceLocation("resources/Collada.ts", 2024);
                                        akra.logger.assert(nMatrices % 1 === 0.0, "incorrect output length of transformation data (" + pFloatArray.length + ")");
                                    }
                                    ;
                                    for(var i = 0; i < nMatrices; i++) {
                                        pTrack.keyFrame(pTimeMarks[i], (new akra.Mat4(pFloatArray.subarray(i * 16, i * 16 + 16), true)).transpose());
                                    }
                                } else {
 {
                                        akra.logger.setSourceLocation("resources/Collada.ts", 2042);
                                        akra.logger.criticalError("TODO: implement animation matrix modification");
                                    }
                                    ;
                                }
                                break;
                            default:
 {
                                    akra.logger.setSourceLocation("resources/Collada.ts", 2046);
                                    akra.logger.error("unsupported animation typed founeed: " + sTransform);
                                }
                                ;
                        }
                        if (!((pTrack) === null)) {
                            pTrack.targetName = sNodeId;
                        }
                        return pTrack;
                    };
                    Collada.prototype.buildAnimationTrackList = function (pAnimationData) {
                        var pSubAnimations = pAnimationData.animations;
                        var pSubTracks;
                        var pTrackList = [];
                        var pTrack;
                        var pChannels = pAnimationData.channels;
                        for(var i = 0; i < pChannels.length; ++i) {
                            pTrack = this.buildAnimationTrack(pChannels[i]);
                            pTrackList.push(pTrack);
                        }
                        if (((pSubAnimations) != null)) {
                            for(var i = 0; i < pSubAnimations.length; ++i) {
                                pSubTracks = this.buildAnimationTrackList(pSubAnimations[i]);
                                pTrackList = pTrackList.concat(pSubTracks);
                            }
                        }
                        return pTrackList;
                    };
                    Collada.prototype.buildAnimation = function (pAnimationData) {
                        var pTracks = this.buildAnimationTrackList(pAnimationData);
                        var sAnimation = null;
                        var pAnimation = akra.animation.createAnimation(sAnimation || this.getBasename());
                        for(var i = 0; i < pTracks.length; i++) {
                            pAnimation.push(pTracks[i]);
                        }
                        return pAnimation;
                    };
                    Collada.prototype.buildAnimations = function (pAnimationsList) {
                        if (typeof pAnimationsList === "undefined") { pAnimationsList = []; }
                        var pAnimations = this.getAnimations();
                        if (((pAnimations) === null)) {
                            return null;
                        }
                        for(var i = 0; i < pAnimations.length; ++i) {
                            var pAnimation = this.buildAnimation(pAnimations[i]);
                            pAnimationsList.push(pAnimation);
                        }
                        return pAnimationsList;
                    };
                    Collada.prototype.buildAssetTransform = function (pNode, pAsset) {
                        if (typeof pAsset === "undefined") { pAsset = null; }
                        pAsset = pAsset || this.getAsset();
                        if (((pAsset) != null)) {
                            var fUnit = pAsset.unit.meter;
                            var sUPaxis = pAsset.upAxis;
                            pNode.localScale = akra.vec3(fUnit);
                            if (sUPaxis.toUpperCase() == "Z_UP") {
                                pNode.addRelRotationByEulerAngles(0, -.5 * akra.math.PI, 0);
                            }
                        }
                        return pNode;
                    };
                    Collada.prototype.buildDeclarationFromAccessor = function (sSemantic, pAccessor) {
                        var pDecl = [];
                        for(var i = 0; i < pAccessor.params.length; ++i) {
                            var sUsage = pAccessor.params[i].name;
                            var sType = pAccessor.params[i].type;
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 2135);
                                akra.logger.assert(sType === "float", "Only float type supported for construction declaration from accessor");
                            }
                            ;
                            pDecl.push(akra.VE_FLOAT(sUsage));
                        }
                        pDecl.push(akra.VE_CUSTOM(sSemantic, akra.EDataTypes.FLOAT, pAccessor.params.length, 0));
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 2142);
                            akra.logger.log("Automatically constructed declaration: ", akra.createVertexDeclaration(pDecl).toString());
                        }
                        ;
                        return pDecl;
                    };
                    Collada.prototype.buildDefaultMaterials = function (pMesh) {
                        var pDefaultMaterial = akra.material.create("default");
                        for(var j = 0; j < pMesh.length; ++j) {
                            var pSubMesh = pMesh.getSubset(j);
                            pSubMesh.material.set(pDefaultMaterial);
                            pSubMesh.renderMethod.effect.addComponent("akra.system.mesh_texture");
                        }
                        return pMesh;
                    };
                    Collada.prototype.buildMaterials = function (pMesh, pGeometryInstance) {
                        var pMaterials = pGeometryInstance.material;
                        var pEffects = this.getLibrary("library_effects");
                        if (((pEffects) === null) || ((pMaterials) === null)) {
                            return this.buildDefaultMaterials(pMesh);
                        }
                        for(var sMaterial in pMaterials) {
                            var pMaterialInst = pMaterials[sMaterial];
                            var pInputMap = pMaterialInst.vertexInput;
                            var sEffectId = pMaterialInst.material.instanceEffect.effect.id;
                            var pEffect = pEffects.effect[sEffectId];
                            var pPhongMaterial = pEffect.profileCommon.technique.value;
                            var pMaterial = akra.material.create(sEffectId);
                            pMaterial.set(pPhongMaterial);
                            for(var j = 0; j < pMesh.length; ++j) {
                                var pSubMesh = pMesh.getSubset(j);
                                if (pSubMesh.material.name === sMaterial) {
                                    pSubMesh.material.set(pMaterial);
                                    pSubMesh.renderMethod.effect.addComponent("akra.system.mesh_texture");
                                    for(var sTextureType in pPhongMaterial.textures) {
                                        var pColladaTexture = pPhongMaterial.textures[sTextureType];
                                        if (((pColladaTexture) === null)) {
                                            continue;
                                        }
                                        var pInput = pInputMap[pColladaTexture.texcoord];
                                        if (!((pInput) != null)) {
                                            continue;
                                        }
                                        var sInputSemantics = pInputMap[pColladaTexture.texcoord].inputSemantic;
                                        var pColladaImage = pColladaTexture.image;
                                        var pSurfaceMaterial = pSubMesh.surfaceMaterial;
                                        var pTexture = this.getManager().texturePool.loadResource(pColladaImage.path);
                                        if (this.getImageOptions().flipY === true) {
 {
                                                akra.logger.setSourceLocation("resources/Collada.ts", 2217);
                                                akra.logger.error("TODO: flipY for image unsupported!");
                                            }
                                            ;
                                        }
                                        var pMatches = sInputSemantics.match(/^(.*?\w)(\d+)$/i);
                                        var iTexCoord = (pMatches ? parseInt(pMatches[2]) : 0);
                                        var iTexture = akra.ESurfaceMaterialTextures[sTextureType.toUpperCase()];
                                        if (!((iTexture) !== undefined)) {
                                            continue;
                                        }
                                        pSurfaceMaterial.setTexture(iTexture, pTexture, iTexCoord);
                                    }
                                }
                            }
                        }
                        return pMesh;
                    };
                    Collada.prototype.buildSkeleton = function (pSkeletonsList) {
                        var pSkeleton = null;
                        pSkeleton = akra.model.createSkeleton(pSkeletonsList[0]);
                        for(var i = 0; i < pSkeletonsList.length; ++i) {
                            var pJoint = (this.source(pSkeletonsList[i])).constructedNode;
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 2250);
                                akra.logger.assert(akra.scene.isJoint(pJoint), "skeleton node must be joint");
                            }
                            ;
                            pSkeleton.addRootJoint(pJoint);
                        }
                        return pSkeleton;
                    };
                    Collada.prototype.buildMesh = function (pGeometryInstance) {
                        var pMesh = null;
                        var pGeometry = pGeometryInstance.geometry;
                        var pNodeData = pGeometry.mesh;
                        var sMeshName = pGeometry.id;
                        if (((pNodeData) === null)) {
                            return null;
                        }
                        if ((pMesh = this.findMesh(sMeshName))) {
                            return this.buildMaterials(pMesh.clone(akra.EMeshCloneOptions.GEOMETRY_ONLY | akra.EMeshCloneOptions.SHARED_GEOMETRY), pGeometryInstance);
                        }
                        var iBegin = akra.now();
                        pMesh = this.getEngine().createMesh(sMeshName, (akra.EMeshOptions.HB_READABLE), this.sharedBuffer());
                        var pPolyGroup = pNodeData.polygons;
                        var pMeshData = pMesh.data;
                        for(var i = 0; i < pPolyGroup.length; ++i) {
                            pMesh.createSubset("submesh-" + i, this.isWireframeEnabled() ? akra.EPrimitiveTypes.LINELIST : pPolyGroup[i].type);
                        }
                        for(var i = 0, pUsedSemantics = {}; i < pPolyGroup.length; ++i) {
                            var pPolygons = pPolyGroup[i];
                            for(var j = 0; j < pPolygons.inputs.length; ++j) {
                                var pInput = pPolygons.inputs[j];
                                var sSemantic = pInput.semantics;
                                var pData = pInput.array;
                                var pDecl;
                                var pDataExt;
                                if (!pUsedSemantics[sSemantic]) {
                                    pUsedSemantics[sSemantic] = true;
                                    switch(sSemantic) {
                                        case akra.DeclUsages.POSITION:
                                        case akra.DeclUsages.NORMAL:
                                            pDataExt = new Float32Array((pData).length / 3 * 4);
                                            for(var y = 0, n = 0, m = 0, l = (pData).length / 3; y < l; y++, n++) {
                                                pDataExt[n++] = pData[m++];
                                                pDataExt[n++] = pData[m++];
                                                pDataExt[n++] = pData[m++];
                                            }
                                            pData = pDataExt;
                                            pDecl = [
                                                akra.VE_FLOAT3(sSemantic), 
                                                akra.VE_END(16)
                                            ];
                                            break;
                                        case akra.DeclUsages.TEXCOORD:
                                        case akra.DeclUsages.TEXCOORD1:
                                        case akra.DeclUsages.TEXCOORD2:
                                        case akra.DeclUsages.TEXCOORD3:
                                        case akra.DeclUsages.TEXCOORD4:
                                        case akra.DeclUsages.TEXCOORD5:
                                            if (sSemantic === "TEXCOORD") {
                                                sSemantic = "TEXCOORD0";
                                            }
                                            pDecl = [
                                                akra.VE_CUSTOM(sSemantic, akra.EDataTypes.FLOAT, pInput.accessor.stride)
                                            ];
                                            break;
                                        default:
                                            pDecl = this.buildDeclarationFromAccessor(sSemantic, pInput.accessor);
 {
                                                akra.logger.setSourceLocation("resources/Collada.ts", 2340);
                                                akra.logger.warning("unsupported semantics used: " + sSemantic);
                                            }
                                            ;
                                    }
                                    pMeshData.allocateData(pDecl, pData);
                                }
                            }
                        }
                        for(var i = 0; i < pPolyGroup.length; ++i) {
                            var pPolygons = pPolyGroup[i];
                            var pSubMesh = pMesh.getSubset(i);
                            var pSubMeshData = pSubMesh.data;
                            var pIndexDecl = akra.createVertexDeclaration();
                            var pSurfaceMaterial = null;
                            var pSurfacePool = null;
                            for(var j = 0; j < pPolygons.inputs.length; ++j) {
                                var iOffset = pPolygons.inputs[j].offset;
                                var sIndexSemantic = akra.DeclUsages.INDEX + iOffset;
                                if (!pIndexDecl.hasSemantics(sIndexSemantic)) {
                                    pIndexDecl.append(akra.VE_FLOAT(sIndexSemantic));
                                }
                            }
                            pSubMeshData.allocateIndex(pIndexDecl, new Float32Array(pPolygons.p));
                            for(var j = 0; j < pPolygons.inputs.length; ++j) {
                                var sSemantic = pPolygons.inputs[j].semantics;
                                var sIndexSemantics = akra.DeclUsages.INDEX + pPolygons.inputs[j].offset;
                                pSubMeshData.index(sSemantic, sIndexSemantics);
                            }
                            pSubMesh.material.name = pPolygons.material;
                        }
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 2389);
                            akra.logger.assert(pMesh.addFlexMaterial("default"), "Could not add flex material to mesh <" + pMesh.name + ">");
                        }
                        ;
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 2390);
                            akra.logger.assert(pMesh.setFlexMaterial("default"), "Could not set flex material to mesh <" + pMesh.name + ">");
                        }
                        ;
                        this.addMesh(pMesh);
                        return this.buildMaterials(pMesh, pGeometryInstance);
                    };
                    Collada.prototype.buildSkinMesh = function (pControllerInstance) {
                        var pController = pControllerInstance.controller;
                        var pMaterials = pControllerInstance.material;
                        var pSkinData = pController.skin;
                        var pBoneList = pSkinData.joints.inputs["JOINT"].array;
                        var pBoneOffsetMatrices = pSkinData.joints.inputs["INV_BIND_MATRIX"].array;
                        var m4fBindMatrix = pSkinData.shapeMatrix;
                        var pVertexWeights = pSkinData.vertexWeights;
                        var pGeometry = pSkinData.geometry;
                        var pMesh;
                        var pSkeleton;
                        var pSkin;
                        pSkeleton = this.buildSkeleton(pControllerInstance.skeletons);
                        pMesh = this.buildMesh({
                            geometry: pGeometry,
                            material: pMaterials
                        });
                        pSkin = pMesh.createSkin();
                        pSkin.setBindMatrix(m4fBindMatrix);
                        pSkin.setBoneNames(pBoneList);
                        pSkin.setBoneOffsetMatrices(pBoneOffsetMatrices);
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 2426);
                            akra.logger.assert(pSkin.setSkeleton(pSkeleton), "Could not set skeleton to skin.");
                        }
                        ;
                        if (!pSkin.setVertexWeights(pVertexWeights.vcount, new Float32Array(pVertexWeights.v), new Float32Array(pVertexWeights.weightInput.array))) {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 2432);
                                akra.logger.error("cannot set vertex weight info to skin");
                            }
                            ;
                        }
                        pMesh.setSkin(pSkin);
                        pMesh.setSkeleton(pSkeleton);
                        pSkeleton.attachMesh(pMesh);
                        return pMesh;
                    };
                    Collada.prototype.buildSkinMeshInstance = function (pControllers, pSceneNode) {
                        if (typeof pSceneNode === "undefined") { pSceneNode = null; }
                        var pMesh = null;
                        var pMeshList = [];
                        for(var m = 0; m < pControllers.length; ++m) {
                            pMesh = this.buildSkinMesh(pControllers[m]);
                            pMeshList.push(pMesh);
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 2451);
                                akra.logger.assert(((pMesh) != null), "cannot find instance <" + pControllers[m].url + ">\"s data");
                            }
                            ;
                            if (!((pSceneNode) === null)) {
                                pSceneNode.mesh = pMesh;
                            }
                        }
                        return pMeshList;
                    };
                    Collada.prototype.buildMeshInstance = function (pGeometries, pSceneNode) {
                        if (typeof pSceneNode === "undefined") { pSceneNode = null; }
                        var pMesh = null;
                        var pMeshList = [];
                        for(var m = 0; m < pGeometries.length; ++m) {
                            pMesh = this.buildMesh(pGeometries[m]);
                            pMeshList.push(pMesh);
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 2469);
                                akra.logger.assert(((pMesh) != null), "cannot find instance <" + pGeometries[m].url + ">\"s data");
                            }
                            ;
                            if (!((pSceneNode) === null)) {
                                pSceneNode.mesh = pMesh;
                            }
                        }
                        return pMeshList;
                    };
                    Collada.prototype.buildMeshes = function () {
                        var pScene = this.getVisualScene();
                        var pMeshes = [];
                        this.findNode(pScene.nodes, null, function (pNode) {
                            var pModelNode = pNode.constructedNode;
                            if (((pModelNode) === null)) {
 {
                                    akra.logger.setSourceLocation("resources/Collada.ts", 2487);
                                    akra.logger.error("you must call buildScene() before call buildMeshes() or file corrupt");
                                }
                                ;
                                return;
                            }
                            if (pNode.controller.length == 0 && pNode.geometry.length == 0) {
                                return;
                            }
                            if (!akra.scene.isModel(pModelNode) && pNode.geometry.length > 0) {
                                pModelNode = pModelNode.scene.createModel(".joint-to-model-link-" + ((++/*checked (origin: akra)>>*/akra._total)));
                                pModelNode.attachToParent(pNode.constructedNode);
                            }
                            pMeshes.insert(this.buildSkinMeshInstance(pNode.controller));
                            pMeshes.insert(this.buildMeshInstance(pNode.geometry, pModelNode));
                        });
                        return pMeshes;
                    };
                    Collada.prototype.buildSceneNode = function (pNode, pParentNode) {
                        var pSceneNode = pNode.constructedNode;
                        var pScene = pParentNode.scene;
                        if (((pSceneNode) != null)) {
                            return pSceneNode;
                        }
                        if (pNode.geometry.length > 0) {
                            pSceneNode = pScene.createModel();
                        } else {
                            pSceneNode = pScene.createNode();
                        }
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 2526);
                            akra.logger.assert(pSceneNode.create(), "Can not initialize scene node!");
                        }
                        ;
                        pSceneNode.attachToParent(pParentNode);
                        return pSceneNode;
                    };
                    Collada.prototype.buildJointNode = function (pNode, pParentNode) {
                        var pJointNode = pNode.constructedNode;
                        var sJointSid = pNode.sid;
                        var sJointName = pNode.id;
                        var pSkeleton;
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 2539);
                            akra.logger.assert(((pParentNode) != null), "parent node is null");
                        }
                        ;
                        if (((pJointNode) != null)) {
                            return pJointNode;
                        }
                        if (((pParentNode) === null)) {
                            return null;
                        }
                        pJointNode = pParentNode.scene.createJoint();
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 2551);
                            akra.logger.assert(pJointNode.create(), "Can not initialize joint node!");
                        }
                        ;
                        pJointNode.boneName = sJointSid;
                        pJointNode.attachToParent(pParentNode);
                        if (this.isJointsVisualizationNeeded()) {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 2564);
                                akra.logger.criticalError("TODO: visualize joints...");
                            }
                            ;
                        }
                        return pJointNode;
                    };
                    Collada.prototype.buildNodes = function (pNodes, pParentNode) {
                        if (typeof pParentNode === "undefined") { pParentNode = null; }
                        if (((pNodes) === null)) {
                            return null;
                        }
                        var pNode = null;
                        var pHierarchyNode = null;
                        var m4fLocalMatrix = null;
                        for(var i = pNodes.length - 1; i >= 0; i--) {
                            pNode = pNodes[i];
                            if (!((pNode) != null)) {
                                continue;
                            }
                            if (pNode.type === "JOINT") {
                                pHierarchyNode = this.buildJointNode(pNode, pParentNode);
                            } else {
                                pHierarchyNode = this.buildSceneNode(pNode, pParentNode);
                            }
                            pHierarchyNode.name = (pNode.id || pNode.name);
                            pHierarchyNode.setInheritance(akra.ENodeInheritance.ALL);
                            pNode.constructedNode = pHierarchyNode;
                            pHierarchyNode.localMatrix = pNode.transform;
                            this.buildNodes(pNode.childNodes, pHierarchyNode);
                        }
                        return pHierarchyNode;
                    };
                    Collada.prototype.buildScene = function (pRootNode) {
                        var pScene = this.getVisualScene();
                        var pAsset = this.getAsset();
                        var pNodes = [];
                        var pNode = null;
                        for(var i = 0; i < pScene.nodes.length; i++) {
                            pNode = pScene.nodes[i];
                            pNodes.push(this.buildNodes([
                                pNode
                            ], pRootNode));
                        }
                        for(var i = 0; i < pNodes.length; i++) {
                            pNodes[i] = this.buildAssetTransform(pNodes[i]);
                        }
                        return pNodes;
                    };
                    Collada.prototype.buildInititalPose = function (pNodes, pSkeleton) {
                        var sPose = "Pose-" + this.getBasename() + "-" + pSkeleton.name;
                        var pPose = akra.animation.createAnimation(sPose);
                        var pNodeList = pSkeleton.getNodeList();
                        var pNodeMap = {};
                        var pTrack;
                        for(var i = 0; i < pNodeList.length; ++i) {
                            pNodeMap[pNodeList[i].name] = pNodeList[i];
                        }
                        this.findNode(pNodes, null, function (pNode) {
                            var sJoint = pNode.sid;
                            var sNodeId = pNode.id;
                            if (!((pNodeMap[sNodeId]) != null)) {
                                return;
                            }
                            pTrack = akra.animation.createTrack(sJoint);
                            pTrack.targetName = sNodeId;
                            pTrack.keyFrame(0.0, pNode.transform);
                            pPose.push(pTrack);
                        });
                        return pPose;
                    };
                    Collada.prototype.buildInitialPoses = function (pPoseSkeletons) {
                        if (typeof pPoseSkeletons === "undefined") { pPoseSkeletons = null; }
                        pPoseSkeletons = pPoseSkeletons || this.getSkeletonsOutput();
                        if (((pPoseSkeletons) === null)) {
                            return null;
                        }
                        var pScene = this.getVisualScene();
                        var pSkeleton;
                        var pPoses = [];
                        for(var i = 0; i < pPoseSkeletons.length; ++i) {
                            pSkeleton = pPoseSkeletons[i];
                            pPoses.push(this.buildInititalPose(pScene.nodes, pSkeleton));
                        }
                        return pPoses;
                    };
                    Collada.prototype.buildComplete = function () {
                        var pScene = this.getVisualScene();
                        if (((pScene) === null)) {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 2688);
                                akra.logger.warning("build complete, but visual scene not parsed correctly!");
                            }
                            ;
                            return;
                        }
                        this.findNode(pScene.nodes, null, function (pNode) {
                            pNode.constructedNode = null;
                        });
                    };
                    Collada.prototype.setOptions = function (pOptions) {
                        if (((pOptions) === null)) {
                            pOptions = Collada.DEFAULT_OPTIONS;
                        }
                        for(var i in Collada.DEFAULT_OPTIONS) {
                            if (((pOptions[i]) !== undefined)) {
                                continue;
                            }
                            pOptions[i] = Collada.DEFAULT_OPTIONS[i];
                        }
                        this._pOptions = pOptions;
                    };
                    Collada.prototype.setXMLRoot = function (pXML) {
                        this._pXMLRoot = pXML;
                    };
                    Collada.prototype.getXMLRoot = function () {
                        return this._pXMLRoot;
                    };
                    Collada.prototype.findMesh = function (sName) {
                        return this._pCache.meshMap[sName] || null;
                    };
                    Collada.prototype.addMesh = function (pMesh) {
                        this._pCache.meshMap[pMesh.name] = pMesh;
                        this.sharedBuffer(pMesh.data);
                    };
                    Collada.prototype.sharedBuffer = function (pBuffer) {
                        if (((pBuffer) != null)) {
                            this._pCache.sharedBuffer = pBuffer;
                        }
                        return null;
                    };
                    Collada.prototype.prepareInput = function (pInput) {
                        var pSupportedFormat = getSupportedFormat(pInput.semantics);
 {
                            akra.logger.setSourceLocation("resources/Collada.ts", 2742);
                            akra.logger.assert(((pSupportedFormat) != null), "unsupported semantic used <" + pInput.semantics + ">");
                        }
                        ;
                        pInput.array = this.COLLADAGetSourceData(pInput.source, pSupportedFormat);
                        pInput.accessor = pInput.source.techniqueCommon.accessor;
                        return pInput;
                    };
                    Collada.prototype.isJointsVisualizationNeeded = function () {
                        return this._pOptions.drawJoints === true;
                    };
                    Collada.prototype.isVisualSceneLoaded = function () {
                        return ((this._pVisualScene) != null);
                    };
                    Collada.prototype.isAnimationLoaded = function () {
                        return this._pAnimations.length > 0;
                    };
                    Collada.prototype.isSceneNeeded = function () {
                        return this._pOptions.scene === true;
                    };
                    Collada.prototype.isAnimationNeeded = function () {
                        return ((this._pOptions.animation) != null) && this._pOptions.animation !== false;
                    };
                    Collada.prototype.isPoseExtractionNeeded = function () {
                        return this._pOptions.extractPoses === true;
                    };
                    Collada.prototype.isWireframeEnabled = function () {
                        return this._pOptions.wireframe === true;
                    };
                    Collada.prototype.getSkeletonsOutput = function () {
                        return this._pOptions.skeletons || null;
                    };
                    Collada.prototype.getImageOptions = function () {
                        return this._pOptions.images;
                    };
                    Collada.prototype.getVisualScene = function () {
                        return this._pVisualScene;
                    };
                    Collada.prototype.getAnimations = function () {
                        return this._pAnimations;
                    };
                    Collada.prototype.getAsset = function () {
                        return this._pAsset;
                    };
                    Collada.prototype.isLibraryLoaded = function (sLib) {
                        return ((this._pLib[sLib]) != null);
                    };
                    Collada.prototype.isLibraryExists = function (sLib) {
                        return !((firstChild(this.getXMLRoot(), "library_animations")) === null);
                    };
                    Collada.prototype.getLibrary = function (sLib) {
                        return this._pLib[sLib] || null;
                    };
                    Collada.prototype.getBasename = function () {
                        return akra.util.pathinfo(this._sFilename).basename || "unknown";
                    };
                    Collada.prototype.getFilename = function () {
                        return this._sFilename;
                    };
                    Collada.prototype.setFilename = function (sName) {
                        this._sFilename = sName;
                    };
                    Collada.prototype.readLibraries = function (pXML, pTemplates) {
                        var pLibraries = this._pLib;
                        for(var i = 0; i < pTemplates.length; i++) {
                            var sLib = pTemplates[i].lib;
                            pLibraries[sLib] = this.COLLADALibrary(firstChild(pXML, sLib), pTemplates[i]);
                        }
                    };
                    Collada.prototype.checkLibraries = function (pXML, pTemplates) {
                        var pLibraries = this._pLib;
                        for(var i = 0; i < pTemplates.length; i++) {
                            var sLib = pTemplates[i].lib;
                            if (((firstChild(pXML, sLib)) != null)) {
                                pLibraries[sLib] = null;
                            }
                        }
                    };
                    Collada.prototype.parse = function (sXMLData, pOptions) {
                        if (typeof pOptions === "undefined") { pOptions = null; }
                        if (((sXMLData) === null)) {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 2844);
                                akra.logger.error("must be specified collada content.");
                            }
                            ;
                            return false;
                        }
                        var pParser = new DOMParser();
                        var pXMLDocument = pParser.parseFromString(sXMLData, "application/xml");
                        var pXMLRoot = pXMLDocument.getElementsByTagName("COLLADA")[0];
                        this.setOptions(pOptions);
                        this.setXMLRoot(pXMLRoot);
                        this.checkLibraries(pXMLRoot, Collada.SCENE_TEMPLATE);
                        this.checkLibraries(pXMLRoot, Collada.ANIMATION_TEMPLATE);
                        this.readLibraries(pXMLRoot, Collada.SCENE_TEMPLATE);
                        this.COLLADAAsset(firstChild(pXMLRoot, "asset"));
                        this.COLLADAScene(firstChild(pXMLRoot, "scene"));
                        if (this.isAnimationNeeded()) {
                            this.readLibraries(pXMLRoot, Collada.ANIMATION_TEMPLATE);
                        }
                        return true;
                    };
                    Collada.prototype.loadResource = function (sFilename, pOptions) {
                        if (typeof sFilename === "undefined") { sFilename = null; }
                        if (typeof pOptions === "undefined") { pOptions = null; }
                        if (((sFilename) === null)) {
                            sFilename = this.findResourceName();
                        }
                        if (this.isResourceLoaded()) {
 {
                                akra.logger.setSourceLocation("resources/Collada.ts", 2876);
                                akra.logger.warning("collada model already loaded");
                            }
                            ;
                            return false;
                        }
                        var pModel = this;
                        this.setFilename(sFilename);
                        this.notifyDisabled();
                        this.notifyUnloaded();
                        akra.io.fopen(sFilename).read(function (pErr, sXML) {
                            if (!((pErr) === null)) {
 {
                                    akra.logger.setSourceLocation("resources/Collada.ts", 2889);
                                    akra.logger.error(pErr);
                                }
                                ;
                            }
                            pModel.notifyRestored();
                            if (pModel.parse(sXML, pOptions)) {
                                pModel.notifyLoaded();
                            }
                        });
                    };
                    Collada.prototype.attachToScene = function (parent, pController) {
                        if (typeof pController === "undefined") { pController = null; }
                        var pSkeletons, pSkeleton;
                        var pPoses;
                        var pScene;
                        var pNode;
                        var pRoot;
                        var pSceneOutput = null;
                        var pAnimationOutput = null;
                        var pMeshOutput = null;
                        var pInitialPosesOutput = null;
                        if (((parent) === null)) {
                            return null;
                        }
                        if (parent instanceof akra.scene.Node) {
                            pNode = parent;
                            pScene = pNode.scene;
                        } else {
                            pScene = parent;
                            pNode = pScene.getRootNode();
                        }
                        pRoot = pScene._createModelEntry(this);
                        pRoot.create();
                        pRoot.name = this.getBasename();
                        pRoot.setInheritance(akra.ENodeInheritance.ALL);
                        if (!pRoot.attachToParent(pNode)) {
                            return null;
                        }
                        if (this.isVisualSceneLoaded() && this.isSceneNeeded()) {
                            pSceneOutput = this.buildScene(pRoot);
                            pMeshOutput = this.buildMeshes();
                        }
                        if (this.isPoseExtractionNeeded()) {
                            pInitialPosesOutput = this.buildInitialPoses();
                        }
                        if (this.isAnimationNeeded() && this.isLibraryExists("library_animations")) {
                            if (((pController) === null)) {
                                pController = this.getEngine().createAnimationController();
                            }
                            pAnimationOutput = this.buildAnimations();
                            if (this.isPoseExtractionNeeded()) {
                                pSkeletons = this.getSkeletonsOutput() || [];
                                pPoses = this.buildInitialPoses(pSkeletons);
                                for(var i = 0; i < pAnimationOutput.length; ++i) {
                                    for(var j = 0; j < pPoses.length; ++j) {
                                        pAnimationOutput[i].extend(pPoses[j]);
                                    }
                                }
                            }
                        }
                        this.buildComplete();
                        if (!((pController) === null) && !((pAnimationOutput) === null)) {
                            for(var i = 0; i < pAnimationOutput.length; ++i) {
                                pController.addAnimation(pAnimationOutput[i]);
                            }
                            pController.attach(pRoot);
                            pRoot.controller = pController;
                        }
                        return pRoot;
                    };
                    return Collada;
                })(pool.ResourcePoolItem);
                resources.Collada = Collada;                
                pSupportedVertexFormat = [
                    {
                        name: [
                            "X"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "Y"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "Z"
                        ],
                        type: [
                            "float"
                        ]
                    }
                ];
                pSupportedTextureFormat = [
                    {
                        name: [
                            "S"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "T"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "P"
                        ],
                        type: [
                            "float"
                        ]
                    }
                ];
                pSupportedColorFormat = [
                    {
                        name: [
                            "R"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "G"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "B"
                        ],
                        type: [
                            "float"
                        ]
                    }
                ];
                pSupportedWeightFormat = [
                    {
                        name: [
                            "WEIGHT"
                        ],
                        type: [
                            "float"
                        ]
                    }
                ];
                pSupportedJointFormat = [
                    {
                        name: [
                            "JOINT"
                        ],
                        type: [
                            "Name", 
                            "IDREF"
                        ]
                    }
                ];
                pSupportedInvBindMatrixFormat = [
                    {
                        name: [
                            "TRANSFORM"
                        ],
                        type: [
                            "float4x4"
                        ]
                    }
                ];
                pSupportedInterpolationFormat = [
                    {
                        name: [
                            "INTERPOLATION"
                        ],
                        type: [
                            "Name"
                        ]
                    }
                ];
                pSupportedInputFormat = [
                    {
                        name: [
                            "TIME"
                        ],
                        type: [
                            "float"
                        ]
                    }
                ];
                pSupportedOutputFormat = [
                    {
                        name: [
                            "TRANSFORM", 
                            "X", 
                            "ANGLE", 
                            null
                        ],
                        type: [
                            "float4x4", 
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "Y"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "Z"
                        ],
                        type: [
                            "float"
                        ]
                    }
                ];
                pSupportedTangentFormat = [
                    {
                        name: [
                            "X"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "Y"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "X"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "Y"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "X"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "Y"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "X"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "Y"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "X"
                        ],
                        type: [
                            "float"
                        ]
                    }, 
                    {
                        name: [
                            "Y"
                        ],
                        type: [
                            "float"
                        ]
                    }
                ];
                pFormatStrideTable = {
                    "float": 1,
                    "float2": 2,
                    "float3": 3,
                    "float4": 4,
                    "float3x3": 9,
                    "float4x4": 16,
                    "int": 1,
                    "name": 1,
                    "Name": 1,
                    "IDREF": 1
                };
                pConvFormats = {
                    "int": {
                        type: Int32Array,
                        converter: string2IntArray
                    },
                    "float": {
                        type: Float32Array,
                        converter: string2FloatArray
                    },
                    "bool": {
                        type: Array,
                        converter: string2BoolArray
                    },
                    "string": {
                        type: Array,
                        converter: string2StringArray
                    }
                };
                function getSupportedFormat(sSemantics) {
                    switch(sSemantics) {
                        case "TEXTANGENT":
                        case "TEXBINORMAL":
                        case "VERTEX":
                        case "NORMAL":
                        case "TANGENT":
                        case "BINORMAL":
                        case "POSITION":
                            return pSupportedVertexFormat;
                        case "TEXCOORD":
                            return pSupportedTextureFormat;
                        case "WEIGHT":
                            return pSupportedWeightFormat;
                        case "JOINT":
                            return pSupportedJointFormat;
                        case "INV_BIND_MATRIX":
                            return pSupportedInvBindMatrixFormat;
                        case "INTERPOLATION":
                            return pSupportedInterpolationFormat;
                        case "IN_TANGENT":
                            return pSupportedTangentFormat;
                        case "INPUT":
                            return pSupportedInputFormat;
                        case "OUT_TANGENT":
                            return pSupportedTangentFormat;
                        case "OUTPUT":
                            return pSupportedOutputFormat;
                        case "COLOR":
                            return pSupportedColorFormat;
                        case "UV":
                        case "MORPH_WEIGHT":
                        case "MORPH_TARGET":
                        case "LINEAR_STEPS":
                        case "IMAGE":
                        case "CONTINUITY":
                            return null;
                    }
 {
                        akra.logger.setSourceLocation("resources/Collada.ts", 3139);
                        akra.logger.error("unknown semantics founded: " + sSemantics);
                    }
                    ;
                    return null;
                }
                function calcFormatStride(pFormat) {
                    var iStride = 0;
                    var s = null;
                    for(var i = 0; i < pFormat.length; ++i) {
                        s = pFormat[i].type[0];
                        iStride += pFormatStrideTable[s];
                    }
                    return iStride;
                }
                function parseBool(sValue) {
                    return (sValue === "true");
                }
                function parseString(sValue) {
                    return String(sValue);
                }
                function retrieve(pSrc, pDst, iStride, iFrom, iCount, iOffset, iLen) {
                    if (typeof iStride === "undefined") { iStride = 1; }
                    if (typeof iFrom === "undefined") { iFrom = 0; }
                    if (typeof iOffset === "undefined") { iOffset = 0; }
                    if (typeof iLen === "undefined") { iLen = iStride - iOffset; }
                    if (!((iCount) !== undefined)) {
                        iCount = (pSrc.length / iStride - iFrom);
                    }
                    if (iOffset + iLen > iStride) {
                        iLen = iStride - iOffset;
                    }
                    var iBegin = iFrom * iStride;
                    var n = 0;
                    for(var i = 0; i < iCount; ++i) {
                        for(var j = 0; j < iLen; ++j) {
                            pDst[n++] = (pSrc[iBegin + i * iStride + iOffset + j]);
                        }
                    }
                    return n;
                }
                function string2Array(sData, ppData, fnConv, iFrom) {
                    if (typeof fnConv === "undefined") { fnConv = parseFloat; }
                    if (typeof iFrom === "undefined") { iFrom = 0; }
                    var pData = sData.split(/[\s]+/g);
                    for(var i = 0, n = pData.length, j = 0; i < n; ++i) {
                        if (pData[i] != "") {
                            ppData[iFrom + j] = fnConv(pData[i]);
                            j++;
                        }
                    }
                    return j;
                }
                function string2IntArray(sData, ppData, iFrom) {
                    return string2Array(sData, ppData, parseInt, iFrom);
                }
                function string2FloatArray(sData, ppData, iFrom) {
                    return string2Array(sData, ppData, parseFloat, iFrom);
                }
                function string2BoolArray(sData, ppData, iFrom) {
                    return string2Array(sData, ppData, parseBool, iFrom);
                }
                function string2StringArray(sData, ppData, iFrom) {
                    return string2Array(sData, ppData, parseString, iFrom);
                }
                function string2Any(sData, n, sType, isArray) {
                    if (typeof isArray === "undefined") { isArray = false; }
                    var ppData = new (pConvFormats[sType].type)(n);
                    pConvFormats[sType].converter(sData, ppData);
                    if (n == 1 && !isArray) {
                        return ppData[0];
                    }
                    return ppData;
                }
                ;
                function printArray(pArr, nRow, nCol) {
                    var s = "\n";
                    for(var i = 0; i < pArr.length; ++i) {
                        if (i % nCol == 0) {
                            s += "  ";
                        }
                        s += pArr[i] + ", ";
                        if ((i + 1) % nRow == 0) {
                            s += '\n';
                        }
                    }
                    return s;
                }
                function sortArrayByProperty(pData, sProperty) {
                    var tmp;
                    for(var i = pData.length - 1; i > 0; i--) {
                        for(var j = 0; j < i; j++) {
                            if (pData[j][sProperty] > pData[j + 1][sProperty]) {
                                tmp = pData[j];
                                pData[j] = pData[j + 1];
                                pData[j + 1] = tmp;
                            }
                        }
                    }
                    return pData;
                }
                function stringData(pXML) {
                    return (((pXML) != null) ? pXML.textContent : null);
                }
                function attr(pXML, sName) {
                    return pXML.getAttribute(sName);
                }
                function firstChild(pXML, sTag) {
                    if ((typeof (sTag) === "string")) {
                        return pXML.getElementsByTagName(sTag)[0];
                    }
                    for(var i = 0; i < pXML.childNodes.length; i++) {
                        if (pXML.childNodes[i].nodeType === Node.ELEMENT_NODE) {
                            return pXML.childNodes[i];
                        }
                    }
                    return null;
                }
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        akra.logger.registerCode(2001, "Grammar not LALR(1)! Cannot to generate syntax table. Add operation error.\n" + "Conflict in state with index: {stateIndex}. With grammar symbol: \"{grammarSymbol}\"\n" + "Old operation: {oldOperation}\n" + "New operation: {newOperation}\n" + "For more info init parser in debug-mode and see syntax table and list of states.");
        akra.logger.registerCode(2002, "Grammar not LALR(1)! Cannot to generate syntax table. Add state link error.\n" + "Conflict in state with index: {stateIndex}. With grammar symbol: \"{grammarSymbol}\"\n" + "Old next state: {oldNextStateIndex}\n" + "New next state: {newNextStateIndex}\n" + "For more info init parser in debug-mode and see syntax table and list of states.");
        akra.logger.registerCode(2003, "Grammar error. Can`t generate rules from grammar\n" + "Unexpected symbol: {unexpectedSymbol}\n" + "Expected: {expectedSymbol}");
        akra.logger.registerCode(2004, "Grammar error. Empty additional function name.");
        akra.logger.registerCode(2005, "Grammar error. Bad keyword: {badKeyword}\n" + "All keyword must be define in lexer rule block.");
        akra.logger.registerCode(2051, "Syntax error during parsing. Token: {tokenValue}\n" + "Line: {line}. Column: {column}.");
        akra.logger.registerCode(2101, "Unknown token: {tokenValue}");
        akra.logger.registerCode(2102, "Bad token: {tokenValue}");
        function sourceLocationToString(pLocation) {
            var sLocation = "[" + pLocation.file + ":" + pLocation.line.toString() + "]: ";
            return sLocation;
        }
        function syntaxErrorLogRoutine(pLogEntity) {
            var sPosition = sourceLocationToString(pLogEntity.location);
            var sError = "Code: " + pLogEntity.code.toString() + ". ";
            var pParseMessage = pLogEntity.message.split(/\{(\w+)\}/);
            var pInfo = pLogEntity.info;
            for(var i = 0; i < pParseMessage.length; i++) {
                if (((pInfo[pParseMessage[i]]) !== undefined)) {
                    pParseMessage[i] = pInfo[pParseMessage[i]];
                }
            }
            var sMessage = sPosition + sError + pParseMessage.join("");
            console["error"].call(console, sMessage);
        }
        akra.logger.setCodeFamilyRoutine("ParserSyntaxErrors", syntaxErrorLogRoutine, akra.ELogLevel.ERROR);
        var Item = (function () {
            function Item(pRule, iPos, pExpected) {
                this._pRule = pRule;
                this._iPos = iPos;
                this._iIndex = 0;
                this._pState = null;
                this._isNewExpected = true;
                this._iLength = 0;
                this._pExpected = {};
                if (arguments.length === 3) {
                    var i = null;
                    for(i in arguments[2]) {
                        this.addExpected(i);
                    }
                }
            }
            Object.defineProperty(Item.prototype, "rule", {
                get: function () {
                    return this._pRule;
                },
                set: function (pRule) {
                    this._pRule = pRule;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Item.prototype, "position", {
                get: function () {
                    return this._iPos;
                },
                set: function (iPos) {
                    this._iPos = iPos;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Item.prototype, "state", {
                get: function () {
                    return this._pState;
                },
                set: function (pState) {
                    this._pState = pState;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Item.prototype, "index", {
                get: function () {
                    return this._iIndex;
                },
                set: function (iIndex) {
                    this._iIndex = iIndex;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Item.prototype, "expectedSymbols", {
                get: function () {
                    return this._pExpected;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Item.prototype, "length", {
                get: function () {
                    return this._iLength;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Item.prototype, "isNewExpected", {
                get: function () {
                    return this._isNewExpected;
                },
                set: function (_isNewExpected) {
                    this._isNewExpected = _isNewExpected;
                },
                enumerable: true,
                configurable: true
            });
            Item.prototype.isEqual = function (pItem, eType) {
                if (typeof eType === "undefined") { eType = akra.EParserType.k_LR0; }
                if (eType === akra.EParserType.k_LR0) {
                    return (this._pRule === pItem.rule && this._iPos === pItem.position);
                } else if (eType === akra.EParserType.k_LR1) {
                    if (!(this._pRule === pItem.rule && this._iPos === pItem.position && this._iLength === (pItem).length)) {
                        return false;
                    }
                    var i = null;
                    for(i in this._pExpected) {
                        if (!(pItem).isExpected(i)) {
                            return false;
                        }
                    }
                    return true;
                }
            };
            Item.prototype.isParentItem = function (pItem) {
                return (this._pRule === pItem.rule && this._iPos === pItem.position + 1);
            };
            Item.prototype.isChildItem = function (pItem) {
                return (this._pRule === pItem.rule && this._iPos === pItem.position - 1);
            };
            Item.prototype.mark = function () {
                var pRight = this._pRule.right;
                if (this._iPos === pRight.length) {
                    return "END";
                }
                return pRight[this._iPos];
            };
            Item.prototype.end = function () {
                return this._pRule.right[this._pRule.right.length - 1] || "EMPTY";
            };
            Item.prototype.nextMarked = function () {
                return this._pRule.right[this._iPos + 1] || "END";
            };
            Item.prototype.isExpected = function (sSymbol) {
                return !!(this._pExpected[sSymbol]);
            };
            Item.prototype.addExpected = function (sSymbol) {
                if (this._pExpected[sSymbol]) {
                    return false;
                }
                this._pExpected[sSymbol] = true;
                this._isNewExpected = true;
                this._iLength++;
                return true;
            };
            Item.prototype.toString = function () {
                var sMsg = this._pRule.left + " -> ";
                var sExpected = "";
                var pRight = this._pRule.right;
                for(var k = 0; k < pRight.length; k++) {
                    if (k === this._iPos) {
                        sMsg += ". ";
                    }
                    sMsg += pRight[k] + " ";
                }
                if (this._iPos === pRight.length) {
                    sMsg += ". ";
                }
                if (((this._pExpected) !== undefined)) {
                    sExpected = ", ";
                    for(var l in this._pExpected) {
                        sExpected += l + "/";
                    }
                    if (sExpected !== ", ") {
                        sMsg += sExpected;
                    }
                }
                sMsg = sMsg.slice(0, sMsg.length - 1);
                return sMsg;
            };
            return Item;
        })();        
        var State = (function () {
            function State() {
                this._pItemList = [];
                this._pNextStates = {};
                this._iIndex = 0;
                this._nBaseItems = 0;
            }
            Object.defineProperty(State.prototype, "items", {
                get: function () {
                    return this._pItemList;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(State.prototype, "numBaseItems", {
                get: function () {
                    return this._nBaseItems;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(State.prototype, "index", {
                get: function () {
                    return this._iIndex;
                },
                set: function (iIndex) {
                    this._iIndex = iIndex;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(State.prototype, "nextStates", {
                get: function () {
                    return this._pNextStates;
                },
                enumerable: true,
                configurable: true
            });
            State.prototype.hasItem = function (pItem, eType) {
                var i;
                var pItems = this._pItemList;
                for(i = 0; i < pItems.length; i++) {
                    if (pItems[i].isEqual(pItem, eType)) {
                        return pItems[i];
                    }
                }
                return null;
            };
            State.prototype.hasParentItem = function (pItem) {
                var i;
                var pItems = this._pItemList;
                for(i = 0; i < pItems.length; i++) {
                    if (pItems[i].isParentItem(pItem)) {
                        return pItems[i];
                    }
                }
                return null;
            };
            State.prototype.hasChildItem = function (pItem) {
                var i;
                var pItems = this._pItemList;
                for(i = 0; i < pItems.length; i++) {
                    if (pItems[i].isChildItem(pItem)) {
                        return pItems[i];
                    }
                }
                return null;
            };
            State.prototype.hasRule = function (pRule, iPos) {
                var i = 0;
                var pItemList = this._pItemList;
                var pItem;
                for(i = 0; i < this._nBaseItems; i++) {
                    pItem = pItemList[i];
                    if (pItem.rule === pRule && pItem.position === iPos) {
                        return true;
                    }
                }
                return false;
            };
            State.prototype.isEmpty = function () {
                return !(this._pItemList.length);
            };
            State.prototype.isEqual = function (pState, eType) {
                var pItemsA = this._pItemList;
                var pItemsB = pState.items;
                if (this._nBaseItems !== pState.numBaseItems) {
                    return false;
                }
                var nItems = this._nBaseItems;
                var i, j;
                var isEqual;
                for(i = 0; i < nItems; i++) {
                    isEqual = false;
                    for(j = 0; j < nItems; j++) {
                        if (pItemsA[i].isEqual(pItemsB[j], eType)) {
                            isEqual = true;
                            break;
                        }
                    }
                    if (!isEqual) {
                        return false;
                    }
                }
                return true;
            };
            State.prototype.push = function (pItem) {
                if (this._pItemList.length === 0 || pItem.position > 0) {
                    this._nBaseItems += 1;
                }
                pItem.state = this;
                this._pItemList.push(pItem);
            };
            State.prototype.tryPush_LR0 = function (pRule, iPos) {
                var i;
                var pItems = this._pItemList;
                for(i = 0; i < pItems.length; i++) {
                    if (pItems[i].rule === pRule && pItems[i].position === iPos) {
                        return false;
                    }
                }
                var pItem = new Item(pRule, iPos);
                this.push(pItem);
                return true;
            };
            State.prototype.tryPush_LR = function (pRule, iPos, sExpectedSymbol) {
                var i;
                var pItems = (this._pItemList);
                for(i = 0; i < pItems.length; i++) {
                    if (pItems[i].rule === pRule && pItems[i].position === iPos) {
                        return pItems[i].addExpected(sExpectedSymbol);
                    }
                }
                var pExpected = {};
                pExpected[sExpectedSymbol] = true;
                var pItem = new Item(pRule, iPos, pExpected);
                this.push(pItem);
                return true;
            };
            State.prototype.getNextStateBySymbol = function (sSymbol) {
                if (((this._pNextStates[sSymbol]) !== undefined)) {
                    return this._pNextStates[sSymbol];
                } else {
                    return null;
                }
            };
            State.prototype.addNextState = function (sSymbol, pState) {
                if (((this._pNextStates[sSymbol]) !== undefined)) {
                    return false;
                } else {
                    this._pNextStates[sSymbol] = pState;
                    return true;
                }
            };
            State.prototype.deleteNotBase = function () {
                this._pItemList.length = this._nBaseItems;
            };
            State.prototype.toString = function (isBase) {
                var len = 0;
                var sMsg;
                var pItemList = this._pItemList;
                sMsg = "State " + this._iIndex + ":\n";
                len = isBase ? this._nBaseItems : pItemList.length;
                for(var j = 0; j < len; j++) {
                    sMsg += "\t\t";
                    sMsg += pItemList[j].toString();
                    sMsg += "\n";
                }
                return sMsg;
            };
            return State;
        })();        
        var ParseTree = (function () {
            function ParseTree() {
                this._pRoot = null;
                this._pNodes = [];
                this._pNodesCountStack = [];
                this._isOptimizeMode = false;
            }
            Object.defineProperty(ParseTree.prototype, "root", {
                get: function () {
                    return this._pRoot;
                },
                set: function (pRoot) {
                    this._pRoot = pRoot;
                },
                enumerable: true,
                configurable: true
            });
            ParseTree.prototype.setRoot = function () {
                this._pRoot = this._pNodes.pop();
            };
            ParseTree.prototype.setOptimizeMode = function (isOptimize) {
                this._isOptimizeMode = isOptimize;
            };
            ParseTree.prototype.addNode = function (pNode) {
                this._pNodes.push(pNode);
                this._pNodesCountStack.push(1);
            };
            ParseTree.prototype.reduceByRule = function (pRule, eCreate) {
                if (typeof eCreate === "undefined") { eCreate = akra.ENodeCreateMode.k_Default; }
                var iReduceCount = 0;
                var pNodesCountStack = this._pNodesCountStack;
                var pNode;
                var iRuleLength = pRule.right.length;
                var pNodes = this._pNodes;
                var nOptimize = this._isOptimizeMode ? 1 : 0;
                while(iRuleLength) {
                    iReduceCount += pNodesCountStack.pop();
                    iRuleLength--;
                }
                if ((eCreate === akra.ENodeCreateMode.k_Default && iReduceCount > nOptimize) || (eCreate === akra.ENodeCreateMode.k_Necessary)) {
                    pNode = {
                        name: pRule.left,
                        children: null,
                        parent: null,
                        value: "",
                        isAnalyzed: false,
                        position: this._pNodes.length
                    };
                    while(iReduceCount) {
                        this.addLink(pNode, pNodes.pop());
                        iReduceCount -= 1;
                    }
                    pNodes.push(pNode);
                    pNodesCountStack.push(1);
                } else {
                    pNodesCountStack.push(iReduceCount);
                }
            };
            ParseTree.prototype.toString = function () {
                if (this._pRoot) {
                    return this.toStringNode(this._pRoot);
                } else {
                    return "";
                }
            };
            ParseTree.prototype.clone = function () {
                var pTree = new ParseTree();
                pTree.root = this.cloneNode(this._pRoot);
                return pTree;
            };
            ParseTree.prototype.getNodes = function () {
                return this._pNodes;
            };
            ParseTree.prototype.getLastNode = function () {
                return this._pNodes[this._pNodes.length - 1];
            };
            ParseTree.prototype.addLink = function (pParent, pNode) {
                if (!pParent.children) {
                    pParent.children = [];
                }
                pParent.children.push(pNode);
                pNode.parent = pParent;
            };
            ParseTree.prototype.cloneNode = function (pNode) {
                var pNewNode;
                pNewNode = {
                    name: pNode.name,
                    value: pNode.value,
                    children: null,
                    parent: null,
                    isAnalyzed: pNode.isAnalyzed,
                    position: pNode.position
                };
                var pChildren = pNode.children;
                for(var i = 0; pChildren && i < pChildren.length; i++) {
                    this.addLink(pNewNode, this.cloneNode(pChildren[i]));
                }
                return pNewNode;
            };
            ParseTree.prototype.toStringNode = function (pNode, sPadding) {
                if (typeof sPadding === "undefined") { sPadding = ""; }
                var sRes = sPadding + "{\n";
                var sOldPadding = sPadding;
                var sDefaultPadding = "  ";
                sPadding += sDefaultPadding;
                if (pNode.value) {
                    sRes += sPadding + "name : \"" + pNode.name + "\"" + ",\n";
                    sRes += sPadding + "value : \"" + pNode.value + "\"" + "\n";
                } else {
                    sRes += sPadding + "name : \"" + pNode.name + "\"" + "\n";
                    sRes += sPadding + "children : [";
                    var pChildren = pNode.children;
                    if (pChildren) {
                        sRes += "\n";
                        sPadding += sDefaultPadding;
                        for(var i = pChildren.length - 1; i >= 0; i--) {
                            sRes += this.toStringNode(pChildren[i], sPadding);
                            sRes += ",\n";
                        }
                        sRes = sRes.slice(0, sRes.length - 2);
                        sRes += "\n";
                        sRes += sOldPadding + sDefaultPadding + "]\n";
                    } else {
                        sRes += " ]\n";
                    }
                }
                sRes += sOldPadding + "}";
                return sRes;
            };
            return ParseTree;
        })();
        util.ParseTree = ParseTree;        
        var Lexer = (function () {
            function Lexer(pParser) {
                this._iLineNumber = 0;
                this._iColumnNumber = 0;
                this._sSource = "";
                this._iIndex = 0;
                this._pParser = pParser;
                this._pPunctuatorsMap = {};
                this._pKeywordsMap = {};
                this._pPunctuatorsFirstSymbols = {};
            }
            Lexer.prototype.addPunctuator = function (sValue, sName) {
                if (sName === undefined && sValue.length === 1) {
                    sName = "T_PUNCTUATOR_" + sValue.charCodeAt(0);
                }
                this._pPunctuatorsMap[sValue] = sName;
                this._pPunctuatorsFirstSymbols[sValue[0]] = true;
                return sName;
            };
            Lexer.prototype.addKeyword = function (sValue, sName) {
                this._pKeywordsMap[sValue] = sName;
                return sName;
            };
            Lexer.prototype.getTerminalValueByName = function (sName) {
                var sValue = null;
                for(sValue in this._pPunctuatorsMap) {
                    if (this._pPunctuatorsMap[sValue] === sName) {
                        return sValue;
                    }
                }
                for(sValue in this._pKeywordsMap) {
                    if (this._pKeywordsMap[sValue] === sName) {
                        return sValue;
                    }
                }
                return sName;
            };
            Lexer.prototype.init = function (sSource) {
                this._sSource = sSource;
                this._iLineNumber = 0;
                this._iColumnNumber = 0;
                this._iIndex = 0;
            };
            Lexer.prototype.getNextToken = function () {
                var ch = this.currentChar();
                if (!ch) {
                    return {
                        name: "$",
                        value: "$",
                        start: this._iColumnNumber,
                        end: this._iColumnNumber,
                        line: this._iLineNumber
                    };
                }
                var eType = this.identityTokenType();
                var pToken;
                switch(eType) {
                    case akra.ETokenType.k_NumericLiteral:
                        pToken = this.scanNumber();
                        break;
                    case akra.ETokenType.k_CommentLiteral:
                        this.scanComment();
                        pToken = this.getNextToken();
                        break;
                    case akra.ETokenType.k_StringLiteral:
                        pToken = this.scanString();
                        break;
                    case akra.ETokenType.k_PunctuatorLiteral:
                        pToken = this.scanPunctuator();
                        break;
                    case akra.ETokenType.k_IdentifierLiteral:
                        pToken = this.scanIdentifier();
                        break;
                    case akra.ETokenType.k_WhitespaceLiteral:
                        this.scanWhiteSpace();
                        pToken = this.getNextToken();
                        break;
                    default:
                        this._error(2101, {
                            name: "UNNOWN",
                            value: ch + this._sSource[this._iIndex + 1],
                            start: this._iColumnNumber,
                            end: this._iColumnNumber + 1,
                            line: this._iLineNumber
                        });
                }
                return pToken;
            };
            Lexer.prototype._getIndex = function () {
                return this._iIndex;
            };
            Lexer.prototype._setSource = function (sSource) {
                this._sSource = sSource;
            };
            Lexer.prototype._setIndex = function (iIndex) {
                this._iIndex = iIndex;
            };
            Lexer.prototype._error = function (eCode, pToken) {
                var pLocation = {
                    file: this._pParser.getParseFileName(),
                    line: this._iLineNumber
                };
                var pInfo = {
                    tokenValue: pToken.value,
                    tokenType: pToken.type
                };
                var pLogEntity = {
                    code: eCode,
                    info: pInfo,
                    location: pLocation
                };
                akra.logger["error"](pLogEntity);
                throw new Error(eCode.toString());
            };
            Lexer.prototype.identityTokenType = function () {
                if (this.isIdentifierStart()) {
                    return akra.ETokenType.k_IdentifierLiteral;
                }
                if (this.isWhiteSpaceStart()) {
                    return akra.ETokenType.k_WhitespaceLiteral;
                }
                if (this.isStringStart()) {
                    return akra.ETokenType.k_StringLiteral;
                }
                if (this.isCommentStart()) {
                    return akra.ETokenType.k_CommentLiteral;
                }
                if (this.isNumberStart()) {
                    return akra.ETokenType.k_NumericLiteral;
                }
                if (this.isPunctuatorStart()) {
                    return akra.ETokenType.k_PunctuatorLiteral;
                }
                return akra.ETokenType.k_Unknown;
            };
            Lexer.prototype.isNumberStart = function () {
                var ch = this.currentChar();
                if ((ch >= '0') && (ch <= '9')) {
                    return true;
                }
                var ch1 = this.nextChar();
                if (ch === "." && (ch1 >= '0') && (ch1 <= '9')) {
                    return true;
                }
                return false;
            };
            Lexer.prototype.isCommentStart = function () {
                var ch = this.currentChar();
                var ch1 = this.nextChar();
                if (ch === "/" && (ch1 === "/" || ch1 === "*")) {
                    return true;
                }
                return false;
            };
            Lexer.prototype.isStringStart = function () {
                var ch = this.currentChar();
                if (ch === "\"" || ch === "'") {
                    return true;
                }
                return false;
            };
            Lexer.prototype.isPunctuatorStart = function () {
                var ch = this.currentChar();
                if (this._pPunctuatorsFirstSymbols[ch]) {
                    return true;
                }
                return false;
            };
            Lexer.prototype.isWhiteSpaceStart = function () {
                var ch = this.currentChar();
                if (ch === ' ' || ch === '\n' || ch === '\r' || ch === '\t') {
                    return true;
                }
                return false;
            };
            Lexer.prototype.isIdentifierStart = function () {
                var ch = this.currentChar();
                if ((ch === '_') || (ch >= 'a' && ch <= 'z') || (ch >= 'A' && ch <= 'Z')) {
                    return true;
                }
                return false;
            };
            Lexer.prototype.isLineTerminator = function (sSymbol) {
                return (sSymbol === '\n' || sSymbol === '\r' || sSymbol === '\u2028' || sSymbol === '\u2029');
            };
            Lexer.prototype.isWhiteSpace = function (sSymbol) {
                return (sSymbol === ' ') || (sSymbol === '\t');
            };
            Lexer.prototype.isKeyword = function (sValue) {
                return !!(this._pKeywordsMap[sValue]);
            };
            Lexer.prototype.isPunctuator = function (sValue) {
                return !!(this._pPunctuatorsMap[sValue]);
            };
            Lexer.prototype.nextChar = function () {
                return this._sSource[this._iIndex + 1];
            };
            Lexer.prototype.currentChar = function () {
                return this._sSource[this._iIndex];
            };
            Lexer.prototype.readNextChar = function () {
                this._iIndex++;
                this._iColumnNumber++;
                return this._sSource[this._iIndex];
            };
            Lexer.prototype.scanString = function () {
                var chFirst = this.currentChar();
                var sValue = chFirst;
                var ch = null;
                var chPrevious = chFirst;
                var isGoodFinish = false;
                var iStart = this._iColumnNumber;
                while(true) {
                    ch = this.readNextChar();
                    if (!ch) {
                        break;
                    }
                    sValue += ch;
                    if (ch === chFirst && chPrevious !== '\\') {
                        isGoodFinish = true;
                        this.readNextChar();
                        break;
                    }
                    chPrevious = ch;
                }
                if (isGoodFinish) {
                    return {
                        name: "T_STRING",
                        value: sValue,
                        start: iStart,
                        end: this._iColumnNumber - 1,
                        line: this._iLineNumber
                    };
                } else {
                    if (!ch) {
                        ch = "EOF";
                    }
                    sValue += ch;
                    this._error(2102, {
                        type: akra.ETokenType.k_StringLiteral,
                        value: sValue,
                        start: iStart,
                        end: this._iColumnNumber,
                        line: this._iLineNumber
                    });
                    return null;
                }
            };
            Lexer.prototype.scanPunctuator = function () {
                var sValue = this.currentChar();
                var ch;
                var iStart = this._iColumnNumber;
                while(true) {
                    ch = this.readNextChar();
                    if (ch) {
                        sValue += ch;
                        this._iColumnNumber++;
                        if (!this.isPunctuator(sValue)) {
                            sValue = sValue.slice(0, sValue.length - 1);
                            break;
                        }
                    } else {
                        break;
                    }
                }
                return {
                    name: this._pPunctuatorsMap[sValue],
                    value: sValue,
                    start: iStart,
                    end: this._iColumnNumber - 1,
                    line: this._iLineNumber
                };
            };
            Lexer.prototype.scanNumber = function () {
                var ch = this.currentChar();
                var sValue = "";
                var isFloat = false;
                var chPrevious = ch;
                var isGoodFinish = false;
                var iStart = this._iColumnNumber;
                var isE = false;
                if (ch === '.') {
                    sValue += 0;
                    isFloat = true;
                }
                sValue += ch;
                while(true) {
                    ch = this.readNextChar();
                    if (ch === '.') {
                        if (isFloat) {
                            break;
                        } else {
                            isFloat = true;
                        }
                    } else if (ch === 'e') {
                        if (isE) {
                            break;
                        } else {
                            isE = true;
                        }
                    } else if (((ch === '+' || ch === '-') && chPrevious === 'e')) {
                        sValue += ch;
                        chPrevious = ch;
                        continue;
                    } else if (ch === 'f' && isFloat) {
                        ch = this.readNextChar();
                        if ((ch >= 'a' && ch <= 'z') || (ch >= 'A' && ch <= 'Z')) {
                            break;
                        }
                        isGoodFinish = true;
                        break;
                    } else if ((ch >= 'a' && ch <= 'z') || (ch >= 'A' && ch <= 'Z')) {
                        break;
                    } else if (!((ch >= '0') && (ch <= '9')) || !ch) {
                        if ((isE && chPrevious !== '+' && chPrevious !== '-' && chPrevious !== 'e') || !isE) {
                            isGoodFinish = true;
                        }
                        break;
                    }
                    sValue += ch;
                    chPrevious = ch;
                }
                if (isGoodFinish) {
                    var sName = isFloat ? "T_FLOAT" : "T_UINT";
                    return {
                        name: sName,
                        value: sValue,
                        start: iStart,
                        end: this._iColumnNumber - 1,
                        line: this._iLineNumber
                    };
                } else {
                    if (!ch) {
                        ch = "EOF";
                    }
                    sValue += ch;
                    this._error(2102, {
                        type: akra.ETokenType.k_NumericLiteral,
                        value: sValue,
                        start: iStart,
                        end: this._iColumnNumber,
                        line: this._iLineNumber
                    });
                    return null;
                }
            };
            Lexer.prototype.scanIdentifier = function () {
                var ch = this.currentChar();
                var sValue = ch;
                var iStart = this._iColumnNumber;
                var isGoodFinish = false;
                while(true) {
                    ch = this.readNextChar();
                    if (!ch) {
                        isGoodFinish = true;
                        break;
                    }
                    if (!((ch === '_') || (ch >= 'a' && ch <= 'z') || (ch >= 'A' && ch <= 'Z') || (ch >= '0' && ch <= '9'))) {
                        isGoodFinish = true;
                        break;
                    }
                    sValue += ch;
                }
                if (isGoodFinish) {
                    if (this.isKeyword(sValue)) {
                        return {
                            name: this._pKeywordsMap[sValue],
                            value: sValue,
                            start: iStart,
                            end: this._iColumnNumber - 1,
                            line: this._iLineNumber
                        };
                    } else {
                        var sName = this._pParser.isTypeId(sValue) ? "T_TYPE_ID" : "T_NON_TYPE_ID";
                        return {
                            name: sName,
                            value: sValue,
                            start: iStart,
                            end: this._iColumnNumber - 1,
                            line: this._iLineNumber
                        };
                    }
                } else {
                    if (!ch) {
                        ch = "EOF";
                    }
                    sValue += ch;
                    this._error(2102, {
                        type: akra.ETokenType.k_IdentifierLiteral,
                        value: sValue,
                        start: iStart,
                        end: this._iColumnNumber,
                        line: this._iLineNumber
                    });
                    return null;
                }
            };
            Lexer.prototype.scanWhiteSpace = function () {
                var ch = this.currentChar();
                while(true) {
                    if (!ch) {
                        break;
                    }
                    if (this.isLineTerminator(ch)) {
                        if (ch === "\r" && this.nextChar() === "\n") {
                            this._iLineNumber--;
                        }
                        this._iLineNumber++;
                        ch = this.readNextChar();
                        this._iColumnNumber = 0;
                        continue;
                    } else if (ch === '\t') {
                        this._iColumnNumber += 3;
                    } else if (ch !== ' ') {
                        break;
                    }
                    ch = this.readNextChar();
                }
                return true;
            };
            Lexer.prototype.scanComment = function () {
                var sValue = this.currentChar();
                var ch = this.readNextChar();
                sValue += ch;
                if (ch === '/') {
                    while(true) {
                        ch = this.readNextChar();
                        if (!ch) {
                            break;
                        }
                        if (this.isLineTerminator(ch)) {
                            if (ch === "\r" && this.nextChar() === "\n") {
                                this._iLineNumber--;
                            }
                            this._iLineNumber++;
                            this.readNextChar();
                            this._iColumnNumber = 0;
                            break;
                        }
                        sValue += ch;
                    }
                    return true;
                } else {
                    var chPrevious = ch;
                    var isGoodFinish = false;
                    var iStart = this._iColumnNumber;
                    while(true) {
                        ch = this.readNextChar();
                        if (!ch) {
                            break;
                        }
                        sValue += ch;
                        if (ch === '/' && chPrevious === '*') {
                            isGoodFinish = true;
                            this.readNextChar();
                            break;
                        }
                        if (this.isLineTerminator(ch)) {
                            if (ch === "\r" && this.nextChar() === "\n") {
                                this._iLineNumber--;
                            }
                            this._iLineNumber++;
                            this._iColumnNumber = -1;
                        }
                        chPrevious = ch;
                    }
                    if (isGoodFinish) {
                        return true;
                    } else {
                        if (!ch) {
                            ch = "EOF";
                        }
                        sValue += ch;
                        this._error(2102, {
                            type: akra.ETokenType.k_CommentLiteral,
                            value: sValue,
                            start: iStart,
                            end: this._iColumnNumber,
                            line: this._iLineNumber
                        });
                    }
                }
            };
            return Lexer;
        })();        
        var Parser = (function () {
            function Parser() {
                this._sSource = "";
                this._iIndex = 0;
                this._pSyntaxTree = null;
                this._pTypeIdMap = null;
                this._pLexer = null;
                this._pStack = [];
                this._pToken = null;
                this._fnFinishCallback = null;
                this._pCaller = null;
                this._pSymbolMap = {
                    "$": true
                };
                this._pSyntaxTable = null;
                this._pReduceOperationsMap = null;
                this._pShiftOperationsMap = null;
                this._pSuccessOperation = null;
                this._pFirstTerminalsDMap = null;
                this._pFollowTerminalsDMap = null;
                this._pRulesDMap = null;
                this._pStateList = null;
                this._nRules = 0;
                this._pAdditionalFuncInfoList = null;
                this._pAdditionalFunctionsMap = null;
                this._pAdidtionalFunctByStateDMap = null;
                this._eType = akra.EParserType.k_LR0;
                this._pRuleCreationModeMap = null;
                this._eParseMode = akra.EParseMode.k_AllNode;
                this._pStatesTempMap = null;
                this._pBaseItemList = null;
                this._pExpectedExtensionDMap = null;
                this._sFileName = "stdin";
                ;
            }
            Parser.prototype.isTypeId = function (sValue) {
                return !!(this._pTypeIdMap[sValue]);
            };
            Parser.prototype.returnCode = function (pNode) {
                if (pNode) {
                    if (pNode.value) {
                        return pNode.value + " ";
                    } else if (pNode.children) {
                        var sCode = "";
                        var i = 0;
                        for(i = pNode.children.length - 1; i >= 0; i--) {
                            sCode += this.returnCode(pNode.children[i]);
                        }
                        return sCode;
                    }
                }
                return "";
            };
            Parser.prototype.init = function (sGrammar, eMode, eType) {
                if (typeof eMode === "undefined") { eMode = akra.EParseMode.k_AllNode; }
                if (typeof eType === "undefined") { eType = akra.EParserType.k_LALR; }
                try  {
                    this._eType = eType;
                    this._pLexer = new Lexer(this);
                    this._eParseMode = eMode;
                    this.generateRules(sGrammar);
                    this.buildSyntaxTable();
                    this.generateFunctionByStateMap();
                    if (!((((eMode) & (/*checked (origin: akra)>>*/akra.EParseMode.k_DebugMode)) == (/*checked (origin: akra)>>*/akra.EParseMode.k_DebugMode)))) {
                        this.clearMem();
                    }
                    return true;
                } catch (e) {
 {
                        util.logger.setSourceLocation("util/Parser.ts", 1397);
                        util.logger.log(e.stack);
                    }
                    ;
                    return false;
                }
            };
            Parser.prototype.parse = function (sSource, fnFinishCallback, pCaller) {
                if (typeof fnFinishCallback === "undefined") { fnFinishCallback = null; }
                if (typeof pCaller === "undefined") { pCaller = null; }
                try  {
                    this.defaultInit();
                    this._sSource = sSource;
                    this._pLexer.init(sSource);
                    this._fnFinishCallback = fnFinishCallback;
                    this._pCaller = pCaller;
                    var pTree = this._pSyntaxTree;
                    var pStack = this._pStack;
                    var pSyntaxTable = this._pSyntaxTable;
                    var isStop = false;
                    var isError = false;
                    var isPause = false;
                    var pToken = this.readToken();
                    var pOperation;
                    var iRuleLength;
                    var eAdditionalOperationCode;
                    var iStateIndex = 0;
                    while(!isStop) {
                        pOperation = pSyntaxTable[pStack[pStack.length - 1]][pToken.name];
                        if (((pOperation) !== undefined)) {
                            switch(pOperation.type) {
                                case akra.EOperationType.k_Success:
                                    isStop = true;
                                    break;
                                case akra.EOperationType.k_Shift:
                                    iStateIndex = pOperation.index;
                                    pStack.push(iStateIndex);
                                    pTree.addNode(pToken);
                                    eAdditionalOperationCode = this.operationAdditionalAction(iStateIndex, pToken.name);
                                    if (eAdditionalOperationCode === akra.EOperationType.k_Error) {
                                        isError = true;
                                        isStop = true;
                                    } else if (eAdditionalOperationCode === akra.EOperationType.k_Pause) {
                                        this._pToken = null;
                                        isStop = true;
                                        isPause = true;
                                    } else if (eAdditionalOperationCode === akra.EOperationType.k_Ok) {
                                        pToken = this.readToken();
                                    }
                                    break;
                                case akra.EOperationType.k_Reduce:
                                    iRuleLength = pOperation.rule.right.length;
                                    pStack.length -= iRuleLength;
                                    iStateIndex = pSyntaxTable[pStack[pStack.length - 1]][pOperation.rule.left].index;
                                    pStack.push(iStateIndex);
                                    pTree.reduceByRule(pOperation.rule, this._pRuleCreationModeMap[pOperation.rule.left]);
                                    eAdditionalOperationCode = this.operationAdditionalAction(iStateIndex, pOperation.rule.left);
                                    if (eAdditionalOperationCode === akra.EOperationType.k_Error) {
                                        isError = true;
                                        isStop = true;
                                    } else if (eAdditionalOperationCode === akra.EOperationType.k_Pause) {
                                        this._pToken = pToken;
                                        isStop = true;
                                        isPause = true;
                                    }
                                    break;
                            }
                        } else {
                            isError = true;
                            isStop = true;
                        }
                    }
                } catch (e) {
                    this._sFileName = "stdin";
                    return akra.EParserCode.k_Error;
                }
                if (isPause) {
                    return akra.EParserCode.k_Pause;
                }
                if (!isError) {
                    pTree.setRoot();
                    if (!((this._fnFinishCallback) === null)) {
                        this._fnFinishCallback.call(this._pCaller, akra.EParserCode.k_Ok, this.getParseFileName());
                    }
                    this._sFileName = "stdin";
                    return akra.EParserCode.k_Ok;
                } else {
                    this._error(2051, pToken);
                    if (!((this._fnFinishCallback) === null)) {
                        this._fnFinishCallback.call(this._pCaller, akra.EParserCode.k_Error, this.getParseFileName());
                    }
                    this._sFileName = "stdin";
                    return akra.EParserCode.k_Error;
                }
            };
            Parser.prototype.setParseFileName = function (sFileName) {
                this._sFileName = sFileName;
            };
            Parser.prototype.getParseFileName = function () {
                return this._sFileName;
            };
            Parser.prototype.pause = function () {
                return akra.EParserCode.k_Pause;
            };
            Parser.prototype.resume = function () {
                return this.resumeParse();
            };
            Parser.prototype.printStates = function (isBaseOnly) {
                if (typeof isBaseOnly === "undefined") { isBaseOnly = true; }
                if (!((this._pStateList) !== undefined)) {
 {
                        util.logger.setSourceLocation("util/Parser.ts", 1535);
                        util.logger.log("It`s impossible to print states. You must init parser in debug-mode");
                    }
                    ;
                    return;
                }
                var sMsg = "\n" + this.statesToString(isBaseOnly);
 {
                    util.logger.setSourceLocation("util/Parser.ts", 1539);
                    util.logger.log(sMsg);
                }
                ;
            };
            Parser.prototype.printState = function (iStateIndex, isBaseOnly) {
                if (typeof isBaseOnly === "undefined") { isBaseOnly = true; }
                if (!((this._pStateList) !== undefined)) {
 {
                        util.logger.setSourceLocation("util/Parser.ts", 1544);
                        util.logger.log("It`s impossible to print states. You must init parser in debug-mode");
                    }
                    ;
                    return;
                }
                var pState = this._pStateList[iStateIndex];
                if (!((pState) !== undefined)) {
 {
                        util.logger.setSourceLocation("util/Parser.ts", 1550);
                        util.logger.log("Can not print stete with index: " + iStateIndex.toString());
                    }
                    ;
                    return;
                }
                var sMsg = "\n" + pState.toString(isBaseOnly);
 {
                    util.logger.setSourceLocation("util/Parser.ts", 1555);
                    util.logger.log(sMsg);
                }
                ;
            };
            Parser.prototype.getGrammarSymbols = function () {
                return this._pGrammarSymbols;
            };
            Parser.prototype.getSyntaxTree = function () {
                return this._pSyntaxTree;
            };
            Parser.prototype._saveState = function () {
                return {
                    source: this._sSource,
                    index: this._pLexer._getIndex(),
                    fileName: this._sFileName,
                    tree: this._pSyntaxTree,
                    types: this._pTypeIdMap,
                    stack: this._pStack,
                    token: this._pToken,
                    fnCallback: this._fnFinishCallback,
                    caller: this._pCaller
                };
            };
            Parser.prototype._loadState = function (pState) {
                this._sSource = pState.source;
                this._iIndex = pState.index;
                this._sFileName = pState.fileName;
                this._pSyntaxTree = pState.tree;
                this._pTypeIdMap = pState.types;
                this._pStack = pState.stack;
                this._pToken = pState.token;
                this._fnFinishCallback = pState.fnCallback;
                this._pCaller = pState.caller;
                this._pLexer._setSource(pState.source);
                this._pLexer._setIndex(pState.index);
            };
            Parser.prototype.addAdditionalFunction = function (sFuncName, fnRuleFunction) {
                if (((this._pAdditionalFunctionsMap) === null)) {
                    this._pAdditionalFunctionsMap = {};
                }
                this._pAdditionalFunctionsMap[sFuncName] = fnRuleFunction;
            };
            Parser.prototype.addTypeId = function (sIdentifier) {
                if (((this._pTypeIdMap) === null)) {
                    this._pTypeIdMap = {};
                }
                this._pTypeIdMap[sIdentifier] = true;
            };
            Parser.prototype.defaultInit = function () {
                this._iIndex = 0;
                this._pStack = [
                    0
                ];
                this._pSyntaxTree = new ParseTree();
                this._pTypeIdMap = {};
                this._pSyntaxTree.setOptimizeMode(((((this._eParseMode) & (/*checked (origin: akra)>>*/akra.EParseMode.k_Optimize)) == (/*checked (origin: akra)>>*/akra.EParseMode.k_Optimize))));
            };
            Parser.prototype._error = function (eCode, pErrorInfo) {
                var pLocation = {};
                var pInfo = {
                    tokenValue: null,
                    line: null,
                    column: null,
                    stateIndex: null,
                    oldNextStateIndex: null,
                    newNextStateIndex: null,
                    grammarSymbol: null,
                    newOperation: null,
                    oldOperation: null,
                    expectedSymbol: null,
                    unexpectedSymbol: null,
                    badKeyword: null
                };
                var pLogEntity = {
                    code: eCode,
                    info: pInfo,
                    location: pLocation
                };
                if (eCode === 2051) {
                    var pToken = pErrorInfo;
                    var iLine = pToken.line;
                    var iColumn = pToken.start;
                    pInfo.tokenValue = pToken.value;
                    pInfo.line = iLine;
                    pInfo.column = iColumn;
                    pLocation.file = this.getParseFileName();
                    pLocation.line = iLine;
                } else if (eCode === 2001) {
                    var iStateIndex = pErrorInfo.stateIndex;
                    var sSymbol = pErrorInfo.grammarSymbol;
                    var pOldOperation = pErrorInfo.oldOperation;
                    var pNewOperation = pErrorInfo.newOperation;
                    pInfo.stateIndex = iStateIndex;
                    pInfo.grammarSymbol = sSymbol;
                    pInfo.oldOperation = this.operationToString(pOldOperation);
                    pInfo.newOperation = this.operationToString(pNewOperation);
                    pLocation.file = "GRAMMAR";
                    pLocation.line = 0;
                } else if (eCode === 2002) {
                    var iStateIndex = pErrorInfo.stateIndex;
                    var sSymbol = pErrorInfo.grammarSymbol;
                    var iOldNextStateIndex = pErrorInfo.oldNextStateIndex;
                    var iNewNextStateIndex = pErrorInfo.newNextStateIndex;
                    pInfo.stateIndex = iStateIndex;
                    pInfo.grammarSymbol = sSymbol;
                    pInfo.oldNextStateIndex = iOldNextStateIndex;
                    pInfo.newNextStateIndex = iNewNextStateIndex;
                    pLocation.file = "GRAMMAR";
                    pLocation.line = 0;
                } else if (eCode === 2003) {
                    var iLine = pErrorInfo.grammarLine;
                    var sExpectedSymbol = pErrorInfo.expectedSymbol;
                    var sUnexpectedSymbol = pErrorInfo.unexpectedSymbol;
                    pInfo.expectedSymbol = sExpectedSymbol;
                    pInfo.unexpectedSymbol = sExpectedSymbol;
                    pLocation.file = "GRAMMAR";
                    pLocation.line = iLine || 0;
                } else if (eCode === 2004) {
                    var iLine = pErrorInfo.grammarLine;
                    pLocation.file = "GRAMMAR";
                    pLocation.line = iLine || 0;
                } else if (eCode === 2005) {
                    var iLine = pErrorInfo.grammarLine;
                    var sBadKeyword = pErrorInfo.badKeyword;
                    pInfo.badKeyword = sBadKeyword;
                    pLocation.file = "GRAMMAR";
                    pLocation.line = iLine || 0;
                }
                akra.logger["error"](pLogEntity);
                throw new Error(eCode.toString());
            };
            Parser.prototype.clearMem = function () {
                delete this._pFirstTerminalsDMap;
                delete this._pFollowTerminalsDMap;
                delete this._pRulesDMap;
                delete this._pStateList;
                delete this._pReduceOperationsMap;
                delete this._pShiftOperationsMap;
                delete this._pSuccessOperation;
                delete this._pStatesTempMap;
                delete this._pBaseItemList;
                delete this._pExpectedExtensionDMap;
            };
            Parser.prototype.hasState = function (pState, eType) {
                var pStateList = this._pStateList;
                var i = 0;
                for(i = 0; i < pStateList.length; i++) {
                    if (pStateList[i].isEqual(pState, eType)) {
                        return pStateList[i];
                    }
                }
                return null;
            };
            Parser.prototype.isTerminal = function (sSymbol) {
                return !(this._pRulesDMap[sSymbol]);
            };
            Parser.prototype.pushState = function (pState) {
                pState.index = this._pStateList.length;
                this._pStateList.push(pState);
            };
            Parser.prototype.pushBaseItem = function (pItem) {
                pItem.index = this._pBaseItemList.length;
                this._pBaseItemList.push(pItem);
            };
            Parser.prototype.tryAddState = function (pState, eType) {
                var pRes = this.hasState(pState, eType);
                if (((pRes) === null)) {
                    if (eType === akra.EParserType.k_LR0) {
                        var pItems = pState.items;
                        for(var i = 0; i < pItems.length; i++) {
                            this.pushBaseItem(pItems[i]);
                        }
                    }
                    this.pushState(pState);
                    this.closure(pState, eType);
                    return pState;
                }
                return pRes;
            };
            Parser.prototype.hasEmptyRule = function (sSymbol) {
                if (this.isTerminal(sSymbol)) {
                    return false;
                }
                var pRulesDMap = this._pRulesDMap;
                for(var i in pRulesDMap[sSymbol]) {
                    if (pRulesDMap[sSymbol][i].right.length === 0) {
                        return true;
                    }
                }
                return false;
            };
            Parser.prototype.pushInSyntaxTable = function (iIndex, sSymbol, pOperation) {
                var pSyntaxTable = this._pSyntaxTable;
                if (!pSyntaxTable[iIndex]) {
                    pSyntaxTable[iIndex] = {};
                }
                if (((pSyntaxTable[iIndex][sSymbol]) !== undefined)) {
                    this._error(2001, {
                        stateIndex: iIndex,
                        grammarSymbol: this.convertGrammarSymbol(sSymbol),
                        oldOperation: this._pSyntaxTable[iIndex][sSymbol],
                        newOperation: pOperation
                    });
                }
                pSyntaxTable[iIndex][sSymbol] = pOperation;
            };
            Parser.prototype.addStateLink = function (pState, pNextState, sSymbol) {
                var isAddState = pState.addNextState(sSymbol, pNextState);
                if (!isAddState) {
                    this._error(2002, {
                        stateIndex: pState.index,
                        oldNextStateIndex: pState.getNextStateBySymbol(sSymbol),
                        newNextStateIndex: pNextState.index,
                        grammarSymbol: this.convertGrammarSymbol(sSymbol)
                    });
                }
            };
            Parser.prototype.firstTerminal = function (sSymbol) {
                if (this.isTerminal(sSymbol)) {
                    return null;
                }
                if (((this._pFirstTerminalsDMap[sSymbol]) !== undefined)) {
                    return this._pFirstTerminalsDMap[sSymbol];
                }
                var i = null, j = 0, k = null;
                var pRulesMap = this._pRulesDMap[sSymbol];
                var pTempRes = {};
                var pRes;
                var pRight;
                var isFinish;
                pRes = this._pFirstTerminalsDMap[sSymbol] = {};
                if (this.hasEmptyRule(sSymbol)) {
                    pRes["EMPTY"] = true;
                }
                for(i in pRulesMap) {
                    isFinish = false;
                    pRight = pRulesMap[i].right;
                    for(j = 0; j < pRight.length; j++) {
                        if (pRight[j] === sSymbol) {
                            if (pRes["EMPTY"]) {
                                continue;
                            }
                            isFinish = true;
                            break;
                        }
                        pTempRes = this.firstTerminal(pRight[j]);
                        if (((pTempRes) === null)) {
                            pRes[pRight[j]] = true;
                        } else {
                            for(k in pTempRes) {
                                pRes[k] = true;
                            }
                        }
                        if (!this.hasEmptyRule(pRight[j])) {
                            isFinish = true;
                            break;
                        }
                    }
                    if (!isFinish) {
                        pRes["EMPTY"] = true;
                    }
                }
                return pRes;
            };
            Parser.prototype.followTerminal = function (sSymbol) {
                if (((this._pFollowTerminalsDMap[sSymbol]) !== undefined)) {
                    return this._pFollowTerminalsDMap[sSymbol];
                }
                var i = null, j = null, k = 0, l = 0, m = null;
                var pRulesDMap = this._pRulesDMap;
                var pTempRes;
                var pRes;
                var pRight;
                var isFinish;
                pRes = this._pFollowTerminalsDMap[sSymbol] = {};
                for(i in pRulesDMap) {
                    for(j in pRulesDMap[i]) {
                        pRight = pRulesDMap[i][j].right;
                        for(k = 0; k < pRight.length; k++) {
                            if (pRight[k] === sSymbol) {
                                if (k === pRight.length - 1) {
                                    pTempRes = this.followTerminal(pRulesDMap[i][j].left);
                                    for(m in pTempRes) {
                                        pRes[m] = true;
                                    }
                                } else {
                                    isFinish = false;
                                    for(l = k + 1; l < pRight.length; l++) {
                                        pTempRes = this.firstTerminal(pRight[l]);
                                        if (((pTempRes) === null)) {
                                            pRes[pRight[l]] = true;
                                            isFinish = true;
                                            break;
                                        } else {
                                            for(m in pTempRes) {
                                                pRes[m] = true;
                                            }
                                        }
                                        if (!pTempRes["EMPTY"]) {
                                            isFinish = true;
                                            break;
                                        }
                                    }
                                    if (!isFinish) {
                                        pTempRes = this.followTerminal(pRulesDMap[i][j].left);
                                        for(m in pTempRes) {
                                            pRes[m] = true;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                return pRes;
            };
            Parser.prototype.firstTerminalForSet = function (pSet, pExpected) {
                var i = 0, j = null;
                var pTempRes;
                var pRes = {};
                var isEmpty;
                for(i = 0; i < pSet.length; i++) {
                    pTempRes = this.firstTerminal(pSet[i]);
                    if (((pTempRes) === null)) {
                        pRes[pSet[i]] = true;
                    }
                    isEmpty = false;
                    for(j in pTempRes) {
                        if (j === "EMPTY") {
                            isEmpty = true;
                            continue;
                        }
                        pRes[j] = true;
                    }
                    if (!isEmpty) {
                        return pRes;
                    }
                }
                for(j in pExpected) {
                    pRes[j] = true;
                }
                return pRes;
            };
            Parser.prototype.generateRules = function (sGrammarSource) {
                var pAllRuleList = sGrammarSource.split(/\r?\n/);
                var pTempRule;
                var pRule;
                var isLexerBlock = false;
                this._pRulesDMap = {};
                this._pAdditionalFuncInfoList = [];
                this._pRuleCreationModeMap = {};
                this._pGrammarSymbols = {};
                var i = 0, j = 0;
                var isAllNodeMode = ((((this._eParseMode) & (/*checked (origin: akra)>>*/akra.EParseMode.k_AllNode)) == (/*checked (origin: akra)>>*/akra.EParseMode.k_AllNode)));
                var isNegateMode = ((((this._eParseMode) & (/*checked (origin: akra)>>*/akra.EParseMode.k_Negate)) == (/*checked (origin: akra)>>*/akra.EParseMode.k_Negate)));
                var isAddMode = ((((this._eParseMode) & (/*checked (origin: akra)>>*/akra.EParseMode.k_Add)) == (/*checked (origin: akra)>>*/akra.EParseMode.k_Add)));
                var pSymbolsWithNodeMap = this._pRuleCreationModeMap;
                for(i = 0; i < pAllRuleList.length; i++) {
                    if (pAllRuleList[i] === "" || pAllRuleList[i] === "\r") {
                        continue;
                    }
                    pTempRule = pAllRuleList[i].split(/\s* \s*/);
                    if (isLexerBlock) {
                        if ((pTempRule.length === 3 || (pTempRule.length === 4 && pTempRule[3] === "")) && ((pTempRule[2][0] === "\"" || pTempRule[2][0] === "'") && pTempRule[2].length > 3)) {
                            if (pTempRule[2][0] !== pTempRule[2][pTempRule[2].length - 1]) {
                                this._error(2003, {
                                    unexpectedSymbol: pTempRule[2][pTempRule[2].length - 1],
                                    expectedSymbol: pTempRule[2][0],
                                    grammarLine: i
                                });
                            }
                            pTempRule[2] = pTempRule[2].slice(1, pTempRule[2].length - 1);
                            var ch = pTempRule[2][0];
                            var sName;
                            if ((ch === "_") || (ch >= "a" && ch <= "z") || (ch >= "A" && ch <= "Z")) {
                                sName = this._pLexer.addKeyword(pTempRule[2], pTempRule[0]);
                            } else {
                                sName = this._pLexer.addPunctuator(pTempRule[2], pTempRule[0]);
                            }
                            this._pGrammarSymbols[sName] = pTempRule[2];
                        }
                        continue;
                    }
                    if (pTempRule[0] === "--LEXER--") {
                        isLexerBlock = true;
                        continue;
                    }
                    if (((this._pRulesDMap[pTempRule[0]]) !== undefined) === false) {
                        this._pRulesDMap[pTempRule[0]] = {};
                    }
                    pRule = {
                        left: pTempRule[0],
                        right: [],
                        index: 0
                    };
                    this._pSymbolMap[pTempRule[0]] = true;
                    this._pGrammarSymbols[pTempRule[0]] = pTempRule[0];
                    if (isAllNodeMode) {
                        pSymbolsWithNodeMap[pTempRule[0]] = akra.ENodeCreateMode.k_Default;
                    } else if (isNegateMode && !((pSymbolsWithNodeMap[pTempRule[0]]) !== undefined)) {
                        pSymbolsWithNodeMap[pTempRule[0]] = akra.ENodeCreateMode.k_Default;
                    } else if (isAddMode && !((pSymbolsWithNodeMap[pTempRule[0]]) !== undefined)) {
                        pSymbolsWithNodeMap[pTempRule[0]] = akra.ENodeCreateMode.k_Not;
                    }
                    for(j = 2; j < pTempRule.length; j++) {
                        if (pTempRule[j] === "") {
                            continue;
                        }
                        if (pTempRule[j] === "--AN") {
                            if (isAddMode) {
                                pSymbolsWithNodeMap[pTempRule[0]] = akra.ENodeCreateMode.k_Necessary;
                            }
                            continue;
                        }
                        if (pTempRule[j] === "--NN") {
                            if (isNegateMode && !isAllNodeMode) {
                                pSymbolsWithNodeMap[pTempRule[0]] = akra.ENodeCreateMode.k_Not;
                            }
                            continue;
                        }
                        if (pTempRule[j] === "--F") {
                            if ((!pTempRule[j + 1] || pTempRule[j + 1].length === 0)) {
                                this._error(2004, {
                                    grammarLine: i
                                });
                            }
                            var pFuncInfo = {
                                name: pTempRule[j + 1],
                                position: pRule.right.length,
                                rule: pRule
                            };
                            this._pAdditionalFuncInfoList.push(pFuncInfo);
                            j++;
                            continue;
                        }
                        if (pTempRule[j][0] === "'" || pTempRule[j][0] === "\"") {
                            if (pTempRule[j].length !== 3) {
                                this._error(2005, {
                                    badKeyword: pTempRule[j],
                                    grammarLine: i
                                });
                            }
                            if (pTempRule[j][0] !== pTempRule[j][2]) {
                                this._error(2003, {
                                    unexpectedSymbol: pTempRule[j][2],
                                    expectedSymbol: pTempRule[j][0],
                                    grammarLine: i
                                });
                            }
                            var sName = this._pLexer.addPunctuator(pTempRule[j][1]);
                            pRule.right.push(sName);
                            this._pSymbolMap[sName] = true;
                        } else {
                            pRule.right.push(pTempRule[j]);
                            this._pSymbolMap[pTempRule[j]] = true;
                        }
                    }
                    pRule.index = this._nRules;
                    this._pRulesDMap[pTempRule[0]][pRule.index] = pRule;
                    this._nRules += 1;
                }
            };
            Parser.prototype.generateFunctionByStateMap = function () {
                if (((this._pAdditionalFunctionsMap) === null)) {
                    return;
                }
                var pStateList = this._pStateList;
                var pFuncInfoList = this._pAdditionalFuncInfoList;
                var pFuncInfo;
                var pRule;
                var iPos = 0;
                var pFunc;
                var sGrammarSymbol;
                var i = 0, j = 0;
                var pFuncByStateDMap = {};
                pFuncByStateDMap = this._pAdidtionalFunctByStateDMap = {};
                for(i = 0; i < pFuncInfoList.length; i++) {
                    pFuncInfo = pFuncInfoList[i];
                    pFunc = this._pAdditionalFunctionsMap[pFuncInfo.name];
                    if (!((pFunc) !== undefined)) {
                        continue;
                    }
                    pRule = pFuncInfo.rule;
                    iPos = pFuncInfo.position;
                    sGrammarSymbol = pRule.right[iPos - 1];
                    for(j = 0; j < pStateList.length; j++) {
                        if (pStateList[j].hasRule(pRule, iPos)) {
                            if (!((pFuncByStateDMap[pStateList[j].index]) !== undefined)) {
                                pFuncByStateDMap[pStateList[j].index] = {};
                            }
                            pFuncByStateDMap[pStateList[j].index][sGrammarSymbol] = pFunc;
                        }
                    }
                }
            };
            Parser.prototype.generateFirstState = function (eType) {
                if (eType === akra.EParserType.k_LR0) {
                    this.generateFirstState_LR0();
                } else {
                    this.generateFirstState_LR();
                }
            };
            Parser.prototype.generateFirstState_LR0 = function () {
                var pState = new State();
                var pItem = new Item(this._pRulesDMap["S"][0], 0);
                this.pushBaseItem(pItem);
                pState.push(pItem);
                this.closure_LR0(pState);
                this.pushState(pState);
            };
            Parser.prototype.generateFirstState_LR = function () {
                var pState = new State();
                var pExpected = {};
                pExpected["$"] = true;
                pState.push(new Item(this._pRulesDMap["S"][0], 0, pExpected));
                this.closure_LR(pState);
                this.pushState(pState);
            };
            Parser.prototype.closure = function (pState, eType) {
                if (eType === akra.EParserType.k_LR0) {
                    return this.closure_LR0(pState);
                } else {
                    this.closure_LR(pState);
                }
            };
            Parser.prototype.closure_LR0 = function (pState) {
                var pItemList = pState.items;
                var i = 0, j = null;
                var sSymbol;
                for(i = 0; i < pItemList.length; i++) {
                    sSymbol = pItemList[i].mark();
                    if (sSymbol !== "END" && (!this.isTerminal(sSymbol))) {
                        for(j in this._pRulesDMap[sSymbol]) {
                            pState.tryPush_LR0(this._pRulesDMap[sSymbol][j], 0);
                        }
                    }
                }
                return pState;
            };
            Parser.prototype.closure_LR = function (pState) {
                var pItemList = (pState.items);
                var i = 0, j = null, k = null;
                var sSymbol;
                var pSymbols;
                var pTempSet;
                var isNewExpected = false;
                while(true) {
                    if (i === pItemList.length) {
                        if (!isNewExpected) {
                            break;
                        }
                        i = 0;
                        isNewExpected = false;
                    }
                    sSymbol = pItemList[i].mark();
                    if (sSymbol !== "END" && (!this.isTerminal(sSymbol))) {
                        pTempSet = pItemList[i].rule.right.slice(pItemList[i].position + 1);
                        pSymbols = this.firstTerminalForSet(pTempSet, pItemList[i].expectedSymbols);
                        for(j in this._pRulesDMap[sSymbol]) {
                            for(k in pSymbols) {
                                if (pState.tryPush_LR(this._pRulesDMap[sSymbol][j], 0, k)) {
                                    isNewExpected = true;
                                }
                            }
                        }
                    }
                    i++;
                }
                return pState;
            };
            Parser.prototype.nexeState = function (pState, sSymbol, eType) {
                if (eType === akra.EParserType.k_LR0) {
                    return this.nextState_LR0(pState, sSymbol);
                } else {
                    return this.nextState_LR(pState, sSymbol);
                }
            };
            Parser.prototype.nextState_LR0 = function (pState, sSymbol) {
                var pItemList = pState.items;
                var i = 0;
                var pNewState = new State();
                for(i = 0; i < pItemList.length; i++) {
                    if (sSymbol === pItemList[i].mark()) {
                        pNewState.push(new Item(pItemList[i].rule, pItemList[i].position + 1));
                    }
                }
                return pNewState;
            };
            Parser.prototype.nextState_LR = function (pState, sSymbol) {
                var pItemList = pState.items;
                var i = 0;
                var pNewState = new State();
                for(i = 0; i < pItemList.length; i++) {
                    if (sSymbol === pItemList[i].mark()) {
                        pNewState.push(new Item(pItemList[i].rule, pItemList[i].position + 1, pItemList[i].expectedSymbols));
                    }
                }
                return pNewState;
            };
            Parser.prototype.deleteNotBaseItems = function () {
                var i = 0;
                for(i = 0; i < this._pStateList.length; i++) {
                    this._pStateList[i].deleteNotBase();
                }
            };
            Parser.prototype.closureForItem = function (pRule, iPos) {
                var sIndex = "";
                sIndex += pRule.index + "_" + iPos;
                var pState = this._pStatesTempMap[sIndex];
                if (((pState) !== undefined)) {
                    return pState;
                } else {
                    var pExpected = {};
                    pExpected["##"] = true;
                    pState = new State();
                    pState.push(new Item(pRule, iPos, pExpected));
                    this.closure_LR(pState);
                    this._pStatesTempMap[sIndex] = pState;
                    return pState;
                }
            };
            Parser.prototype.addLinkExpected = function (pItem, pItemX) {
                var pTable = this._pExpectedExtensionDMap;
                var iIndex = pItem.index;
                if (!((pTable[iIndex]) !== undefined)) {
                    pTable[iIndex] = {};
                }
                pTable[iIndex][pItemX.index] = true;
            };
            Parser.prototype.determineExpected = function (pTestState, sSymbol) {
                var pStateX = pTestState.getNextStateBySymbol(sSymbol);
                if (((pStateX) === null)) {
                    return;
                }
                var pItemListX = pStateX.items;
                var pItemList = pTestState.items;
                var pState;
                var pItem;
                var i = 0, j = 0, k = null;
                var nBaseItemTest = pTestState.numBaseItems;
                var nBaseItemX = pStateX.numBaseItems;
                for(i = 0; i < nBaseItemTest; i++) {
                    pState = this.closureForItem(pItemList[i].rule, pItemList[i].position);
                    for(j = 0; j < nBaseItemX; j++) {
                        pItem = pState.hasChildItem(pItemListX[j]);
                        if (pItem) {
                            var pExpected = pItem.expectedSymbols;
                            for(k in pExpected) {
                                if (k === "##") {
                                    this.addLinkExpected(pItemList[i], pItemListX[j]);
                                } else {
                                    pItemListX[j].addExpected(k);
                                }
                            }
                        }
                    }
                }
            };
            Parser.prototype.generateLinksExpected = function () {
                var i = 0, j = null;
                var pStates = this._pStateList;
                for(i = 0; i < pStates.length; i++) {
                    for(j in this._pSymbolMap) {
                        this.determineExpected(pStates[i], j);
                    }
                }
            };
            Parser.prototype.expandExpected = function () {
                var pItemList = this._pBaseItemList;
                var pTable = this._pExpectedExtensionDMap;
                var i = 0, j = null;
                var sSymbol = null;
                var isNewExpected = false;
                pItemList[0].addExpected("$");
                pItemList[0].isNewExpected = true;
                while(true) {
                    if (i === pItemList.length) {
                        if (!isNewExpected) {
                            break;
                        }
                        isNewExpected = false;
                        i = 0;
                    }
                    if (pItemList[i].isNewExpected) {
                        var pExpected = pItemList[i].expectedSymbols;
                        for(sSymbol in pExpected) {
                            for(j in pTable[i]) {
                                if (pItemList[j].addExpected(sSymbol)) {
                                    isNewExpected = true;
                                }
                            }
                        }
                    }
                    pItemList[i].isNewExpected = false;
                    i++;
                }
            };
            Parser.prototype.generateStates = function (eType) {
                if (eType === akra.EParserType.k_LR0) {
                    this.generateStates_LR0();
                } else if (eType === akra.EParserType.k_LR1) {
                    this.generateStates_LR();
                } else if (eType === akra.EParserType.k_LALR) {
                    this.generateStates_LALR();
                }
            };
            Parser.prototype.generateStates_LR0 = function () {
                this.generateFirstState_LR0();
                var i = 0;
                var pStateList = this._pStateList;
                var sSymbol = null;
                var pState;
                for(i = 0; i < pStateList.length; i++) {
                    for(sSymbol in this._pSymbolMap) {
                        pState = this.nextState_LR0(pStateList[i], sSymbol);
                        if (!pState.isEmpty()) {
                            pState = this.tryAddState(pState, akra.EParserType.k_LR0);
                            this.addStateLink(pStateList[i], pState, sSymbol);
                        }
                    }
                }
            };
            Parser.prototype.generateStates_LR = function () {
                this._pFirstTerminalsDMap = {};
                this.generateFirstState_LR();
                var i = 0;
                var pStateList = this._pStateList;
                var sSymbol = null;
                var pState;
                for(i = 0; i < pStateList.length; i++) {
                    for(sSymbol in this._pSymbolMap) {
                        pState = this.nextState_LR(pStateList[i], sSymbol);
                        if (!pState.isEmpty()) {
                            pState = this.tryAddState(pState, akra.EParserType.k_LR1);
                            this.addStateLink(pStateList[i], pState, sSymbol);
                        }
                    }
                }
            };
            Parser.prototype.generateStates_LALR = function () {
                this._pStatesTempMap = {};
                this._pBaseItemList = [];
                this._pExpectedExtensionDMap = {};
                this._pFirstTerminalsDMap = {};
                this.generateStates_LR0();
                this.deleteNotBaseItems();
                this.generateLinksExpected();
                this.expandExpected();
                var i = 0;
                var pStateList = this._pStateList;
                for(i = 0; i < pStateList.length; i++) {
                    this.closure_LR(pStateList[i]);
                }
            };
            Parser.prototype.calcBaseItem = function () {
                var num = 0;
                var i = 0;
                for(i = 0; i < this._pStateList.length; i++) {
                    num += this._pStateList[i].numBaseItems;
                }
                return num;
            };
            Parser.prototype.printExpectedTable = function () {
                var i = null, j = null;
                var sMsg = "";
                for(i in this._pExpectedExtensionDMap) {
                    sMsg += "State " + this._pBaseItemList[i].state.index + ":   ";
                    sMsg += this._pBaseItemList[i].toString() + "  |----->\n";
                    for(j in this._pExpectedExtensionDMap[i]) {
                        sMsg += "\t\t\t\t\t" + "State " + this._pBaseItemList[j].state.index + ":   ";
                        sMsg += this._pBaseItemList[j].toString() + "\n";
                    }
                    sMsg += "\n";
                }
                return sMsg;
            };
            Parser.prototype.addReducing = function (pState) {
                var i = 0, j = null;
                var pItemList = pState.items;
                for(i = 0; i < pItemList.length; i++) {
                    if (pItemList[i].mark() === "END") {
                        if (pItemList[i].rule.left === "S") {
                            this.pushInSyntaxTable(pState.index, "$", this._pSuccessOperation);
                        } else {
                            var pExpected = pItemList[i].expectedSymbols;
                            for(j in pExpected) {
                                this.pushInSyntaxTable(pState.index, j, this._pReduceOperationsMap[pItemList[i].rule.index]);
                            }
                        }
                    }
                }
            };
            Parser.prototype.addShift = function (pState) {
                var i = null;
                var pStateMap = pState.nextStates;
                for(i in pStateMap) {
                    this.pushInSyntaxTable(pState.index, i, this._pShiftOperationsMap[pStateMap[i].index]);
                }
            };
            Parser.prototype.buildSyntaxTable = function () {
                this._pStateList = [];
                var pStateList = this._pStateList;
                var pState;
                this.generateStates(this._eType);
                this._pSyntaxTable = {};
                this._pReduceOperationsMap = {};
                this._pShiftOperationsMap = {};
                this._pSuccessOperation = {
                    type: akra.EOperationType.k_Success
                };
                var i = 0, j = null, k = null;
                for(i = 0; i < pStateList.length; i++) {
                    this._pShiftOperationsMap[pStateList[i].index] = {
                        type: akra.EOperationType.k_Shift,
                        index: pStateList[i].index
                    };
                }
                for(j in this._pRulesDMap) {
                    for(k in this._pRulesDMap[j]) {
                        this._pReduceOperationsMap[k] = {
                            type: akra.EOperationType.k_Reduce,
                            rule: this._pRulesDMap[j][k]
                        };
                    }
                }
                for(var i = 0; i < pStateList.length; i++) {
                    pState = pStateList[i];
                    this.addReducing(pState);
                    this.addShift(pState);
                }
            };
            Parser.prototype.readToken = function () {
                return this._pLexer.getNextToken();
            };
            Parser.prototype.operationAdditionalAction = function (iStateIndex, sGrammarSymbol) {
                var pFuncDMap = this._pAdidtionalFunctByStateDMap;
                if (!((this._pAdidtionalFunctByStateDMap) === null) && ((pFuncDMap[iStateIndex]) !== undefined) && ((pFuncDMap[iStateIndex][sGrammarSymbol]) !== undefined)) {
                    return pFuncDMap[iStateIndex][sGrammarSymbol].call(this);
                }
                return akra.EOperationType.k_Ok;
            };
            Parser.prototype.resumeParse = function () {
                try  {
                    var pTree = this._pSyntaxTree;
                    var pStack = this._pStack;
                    var pSyntaxTable = this._pSyntaxTable;
                    var isStop = false;
                    var isError = false;
                    var isPause = false;
                    var pToken = ((this._pToken) === null) ? this.readToken() : this._pToken;
                    var pOperation;
                    var iRuleLength;
                    var eAdditionalOperationCode;
                    var iStateIndex = 0;
                    while(!isStop) {
                        pOperation = pSyntaxTable[pStack[pStack.length - 1]][pToken.name];
                        if (((pOperation) !== undefined)) {
                            switch(pOperation.type) {
                                case akra.EOperationType.k_Success:
                                    isStop = true;
                                    break;
                                case akra.EOperationType.k_Shift:
                                    iStateIndex = pOperation.index;
                                    pStack.push(iStateIndex);
                                    pTree.addNode(pToken);
                                    eAdditionalOperationCode = this.operationAdditionalAction(iStateIndex, pToken.name);
                                    if (eAdditionalOperationCode === akra.EOperationType.k_Error) {
                                        isError = true;
                                        isStop = true;
                                    } else if (eAdditionalOperationCode === akra.EOperationType.k_Pause) {
                                        this._pToken = null;
                                        isStop = true;
                                        isPause = true;
                                    } else if (eAdditionalOperationCode === akra.EOperationType.k_Ok) {
                                        pToken = this.readToken();
                                    }
                                    break;
                                case akra.EOperationType.k_Reduce:
                                    iRuleLength = pOperation.rule.right.length;
                                    pStack.length -= iRuleLength;
                                    iStateIndex = pSyntaxTable[pStack[pStack.length - 1]][pOperation.rule.left].index;
                                    pStack.push(iStateIndex);
                                    pTree.reduceByRule(pOperation.rule, this._pRuleCreationModeMap[pOperation.rule.left]);
                                    eAdditionalOperationCode = this.operationAdditionalAction(iStateIndex, pOperation.rule.left);
                                    if (eAdditionalOperationCode === akra.EOperationType.k_Error) {
                                        isError = true;
                                        isStop = true;
                                    } else if (eAdditionalOperationCode === akra.EOperationType.k_Pause) {
                                        this._pToken = pToken;
                                        isStop = true;
                                        isPause = true;
                                    }
                                    break;
                            }
                        } else {
                            isError = true;
                            isStop = true;
                        }
                    }
                } catch (e) {
                    this._sFileName = "stdin";
                    return akra.EParserCode.k_Error;
                }
                if (isPause) {
                    return akra.EParserCode.k_Pause;
                }
                if (!isError) {
                    pTree.setRoot();
                    if (((this._fnFinishCallback) !== undefined)) {
                        this._fnFinishCallback.call(this._pCaller, akra.EParserCode.k_Ok, this.getParseFileName());
                    }
                    this._sFileName = "stdin";
                    return akra.EParserCode.k_Ok;
                } else {
                    this._error(2051, pToken);
                    if (((this._fnFinishCallback) !== undefined)) {
                        this._fnFinishCallback.call(this._pCaller, akra.EParserCode.k_Error, this.getParseFileName());
                    }
                    this._sFileName = "stdin";
                    return akra.EParserCode.k_Error;
                }
            };
            Parser.prototype.statesToString = function (isBaseOnly) {
                if (typeof isBaseOnly === "undefined") { isBaseOnly = true; }
                if (!((this._pStateList) !== undefined)) {
                    return null;
                }
                var sMsg = "";
                var i = 0;
                for(i = 0; i < this._pStateList.length; i++) {
                    sMsg += this._pStateList[i].toString(isBaseOnly);
                    sMsg += " ";
                }
                return sMsg;
            };
            Parser.prototype.operationToString = function (pOperation) {
                var sOperation = null;
                switch(pOperation.type) {
                    case akra.EOperationType.k_Shift:
                        sOperation = "SHIFT to state " + pOperation.index.toString();
                        break;
                    case akra.EOperationType.k_Reduce:
                        sOperation = "REDUCE by rule { " + this.ruleToString(pOperation.rule) + " }";
                        break;
                    case akra.EOperationType.k_Success:
                        sOperation = "SUCCESS";
                        break;
                }
                return sOperation;
            };
            Parser.prototype.ruleToString = function (pRule) {
                var sRule;
                sRule = pRule.left + " : " + pRule.right.join(" ");
                return sRule;
            };
            Parser.prototype.convertGrammarSymbol = function (sSymbol) {
                if (!this.isTerminal(sSymbol)) {
                    return sSymbol;
                } else {
                    return this._pLexer.getTerminalValueByName(sSymbol);
                }
            };
            return Parser;
        })();
        util.Parser = Parser;        
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        var EffectParser = (function (_super) {
            __extends(EffectParser, _super);
            function EffectParser() {
                        _super.call(this);
                this._pIncludedFilesMap = null;
                this.addAdditionalFunction("addType", this._addType);
                this.addAdditionalFunction("includeCode", this._includeCode);
            }
            EffectParser.prototype.defaultInit = function () {
                _super.prototype.defaultInit.call(this);
                this.addTypeId("float2");
                this.addTypeId("float3");
                this.addTypeId("float4");
                this.addTypeId("float2x2");
                this.addTypeId("float3x3");
                this.addTypeId("float4x4");
                this.addTypeId("int2");
                this.addTypeId("int3");
                this.addTypeId("int4");
                this.addTypeId("bool2");
                this.addTypeId("bool3");
                this.addTypeId("bool4");
                this._pIncludedFilesMap = {};
                this._pIncludedFilesMap[this.getParseFileName()] = true;
            };
            EffectParser.prototype._addIncludedFile = function (sFileName) {
                this._pIncludedFilesMap[sFileName] = true;
            };
            EffectParser.prototype._addType = function () {
                var pTree = this.getSyntaxTree();
                var pNode = pTree.getLastNode();
                var sTypeId;
                sTypeId = pNode.children[pNode.children.length - 2].value;
                this.addTypeId(sTypeId);
                return akra.EOperationType.k_Ok;
            };
            EffectParser.prototype.normalizeIncludePath = function (sFile) {
                var pCurrentPath = null;
                var pFile = (new /*checked (origin: akra)>>*/akra.util.URI((sFile)));
                if (!((pFile.host) === null) || akra.util.pathinfo(pFile.path).isAbsolute()) {
                    return sFile;
                }
                pCurrentPath = (new /*checked (origin: akra)>>*/akra.util.URI((this.getParseFileName())));
                pCurrentPath.path = akra.util.pathinfo(pCurrentPath.path).dirname + "/" + sFile;
                return pCurrentPath.toString();
            };
            EffectParser.prototype._includeCode = function () {
                var pTree = this.getSyntaxTree();
                var pNode = pTree.getLastNode();
                var sFile = pNode.value;
                sFile = this.normalizeIncludePath(sFile.substr(1, sFile.length - 2));
                if (this._pIncludedFilesMap[sFile]) {
                    return akra.EOperationType.k_Ok;
                } else {
                    var pParserState = this._saveState();
                    var me = this;
                    var pFile = akra.io.fopen(sFile, "r+t");
                    pFile.read(function (err, sData) {
                        if (err) {
 {
                                util.logger.setSourceLocation("util/EffectParser.ts", 96);
                                util.logger.error("Can not read file");
                            }
                            ;
                        } else {
                            pParserState.source = pParserState.source.substr(0, pParserState.index) + sData + pParserState.source.substr(pParserState.index);
                            me._loadState(pParserState);
                            me._addIncludedFile(sFile);
                            me.resume();
                        }
                    });
                    return akra.EOperationType.k_Pause;
                }
            };
            EffectParser.prototype._saveState = function () {
                var pState = _super.prototype._saveState.call(this);
                pState["includeFiles"] = this._pIncludedFilesMap;
                return pState;
            };
            EffectParser.prototype._loadState = function (pState) {
                _super.prototype._loadState.call(this, pState);
                this._pIncludedFilesMap = pState["includeFiles"];
            };
            return EffectParser;
        })(util.Parser);
        util.EffectParser = EffectParser;        
        util.parser = new EffectParser();
        function initAFXParser(sGrammar) {
            util.parser.init(sGrammar, akra.EParseMode.k_Add | akra.EParseMode.k_Negate | akra.EParseMode.k_Optimize | akra.EParseMode.k_DebugMode);
        }
        util.initAFXParser = initAFXParser;
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                var EffectData = (function (_super) {
                    __extends(EffectData, _super);
                    function EffectData() {
                        _super.apply(this, arguments);

                        this._pSyntaxTree = null;
                    }
                    EffectData.prototype.loadResource = function (sFileName) {
                        var reExt = /^(.+)(\.afx|\.abf|\.fx)$/;
                        var pRes = reExt.exec(sFileName);
                        if (((pRes) === null)) {
 {
                                akra.logger.setSourceLocation("resources/EffectData.ts", 23);
                                akra.logger.error("Bad effect file extension. Only .afx, .fx, .abf are available");
                            }
                            ;
                            return;
                        }
                        var isBinary = pRes[pRes.length - 1] === ".abf";
                        var pComposer = this.getManager().getEngine().getComposer();
                        if (isBinary) {
                            var pFile = akra.io.fopen(sFileName, "r+b");
                            pFile.read(function (err, pData) {
                                if (err) {
 {
                                        akra.logger.setSourceLocation("resources/EffectData.ts", 38);
                                        akra.logger.error("Can not read file");
                                    }
                                    ;
                                } else {
                                    me._initFromBinaryData(pData, sFileName);
                                }
                            });
                        }
                        var me = this;
                        akra.io.fopen(sFileName, "r+t").read(function (pErr, sData) {
                            if (!((pErr) === null)) {
 {
                                    akra.logger.setSourceLocation("resources/EffectData.ts", 48);
                                    akra.logger.error("Can not load .afx file: '" + sFileName + "'");
                                }
                                ;
                            } else {
                                akra.util.parser.setParseFileName(sFileName);
                                akra.util.parser.parse(sData, me._initFromParsedEffect, me);
                            }
                        });
                        return true;
                    };
                    EffectData.prototype._initFromParsedEffect = function (eCode, sFileName) {
                        if (eCode === akra.EParserCode.k_Error) {
                            return;
                        }
                        this._pSyntaxTree = akra.util.parser.getSyntaxTree();
                        var pComposer = this.getManager().getEngine().getComposer();
                        if (pComposer._loadEffectFromSyntaxTree(this._pSyntaxTree, sFileName)) {
                            this.notifyLoaded();
                        }
                    };
                    EffectData.prototype._initFromBinaryData = function (pData, sFileName) {
                    };
                    return EffectData;
                })(pool.ResourcePoolItem);
                resources.EffectData = EffectData;                
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                var HardwareBuffer = (function (_super) {
                    __extends(HardwareBuffer, _super);
                    function HardwareBuffer() {
                                        _super.call(this);
                        this._iFlags = 0;
                        this._isLocked = false;
                        this._pBackupCopy = null;
                        this._pBackupUpdated = false;
                        this._bIgnoreHardwareUpdate = false;
                        this.byteLength = 0;
                        this.length = 0;
                    }
                    HardwareBuffer.prototype.isValid = function () {
                        return false;
                    };
                    HardwareBuffer.prototype.isDynamic = function () {
                        return (((this._iFlags) & (akra.EHardwareBufferFlags.DYNAMIC)) != 0);
                    };
                    HardwareBuffer.prototype.isStatic = function () {
                        return (((this._iFlags) & (akra.EHardwareBufferFlags.STATIC)) != 0);
                    };
                    HardwareBuffer.prototype.isStream = function () {
                        return (((this._iFlags) & (akra.EHardwareBufferFlags.STREAM)) != 0);
                    };
                    HardwareBuffer.prototype.isReadable = function () {
                        return (((this._iFlags) & (akra.EHardwareBufferFlags.READABLE)) != 0);
                    };
                    HardwareBuffer.prototype.isBackupPresent = function () {
                        return this._pBackupCopy != null;
                    };
                    HardwareBuffer.prototype.isSoftware = function () {
                        return (((this._iFlags) & (akra.EHardwareBufferFlags.SOFTWARE)) != 0);
                    };
                    HardwareBuffer.prototype.isAligned = function () {
                        return (((this._iFlags) & (akra.EHardwareBufferFlags.ALIGNMENT)) != 0);
                    };
                    HardwareBuffer.prototype.isLocked = function () {
                        return this._isLocked;
                    };
                    HardwareBuffer.prototype.clone = function (pSrc) {
                        return false;
                    };
                    HardwareBuffer.prototype.getFlags = function () {
                        return this._iFlags;
                    };
                    HardwareBuffer.prototype.readData = function (iOffset, iSize, ppDest) {
                        return false;
                    };
                    HardwareBuffer.prototype.writeData = function (pData, iOffset, iSize, bDiscardWholeBuffer) {
                        if (typeof bDiscardWholeBuffer === "undefined") { bDiscardWholeBuffer = false; }
                        return false;
                    };
                    HardwareBuffer.prototype.copyData = function (pSrcBuffer, iSrcOffset, iDstOffset, iSize, bDiscardWholeBuffer) {
                        if (typeof bDiscardWholeBuffer === "undefined") { bDiscardWholeBuffer = false; }
                        var pData = pSrcBuffer.lock(iSrcOffset, iSize);
                        this.writeData(pData, iDstOffset, iSize, bDiscardWholeBuffer);
                        pSrcBuffer.unlock();
                        return true;
                    };
                    HardwareBuffer.prototype.create = function (iSize, iFlags) {
                        if (typeof iFlags === "undefined") { iFlags = 0; }
                        iFlags |= akra.EHardwareBufferFlags.STATIC;
                        if ((((iFlags) & (akra.EHardwareBufferFlags.DYNAMIC)) != 0)) {
                            ((iFlags) &= ~(akra.EHardwareBufferFlags.STATIC));
                            if ((((iFlags) & (akra.EHardwareBufferFlags.BACKUP_COPY)) != 0)) {
                                ((iFlags) &= ~(akra.EHardwareBufferFlags.READABLE));
                            }
                        }
                        this._iFlags = iFlags;
                        this.notifyCreated();
                        this.notifyRestored();
                        return true;
                    };
                    HardwareBuffer.prototype.destroy = function () {
                        this._iFlags = 0;
                        this.notifyDestroyed();
                        this.notifyUnloaded();
                    };
                    HardwareBuffer.prototype.resize = function (iSize) {
                        return false;
                    };
                    HardwareBuffer.prototype.lock = function (iOffset, iSize, iLockFlags) {
                        if (typeof iLockFlags === "undefined") { iLockFlags = akra.EHardwareBufferFlags.READABLE; }
 {
                            akra.logger.setSourceLocation("core/pool/resources/HardwareBuffer.ts", 129);
                            akra.logger.assert(!this.isLocked(), "Cannot lock this buffer, it is already locked!");
                        }
                        ;
                        if (arguments.length == 1) {
                            iLockFlags = arguments[0];
                            iOffset = 0;
                            iSize = this.byteLength;
                        }
                        var pResult = null;
                        if ((iOffset + iSize) > this.byteLength) {
 {
                                akra.logger.setSourceLocation("core/pool/resources/HardwareBuffer.ts", 140);
                                akra.logger.error("Lock request out of bounds.", "HardwareBuffer::lock");
                            }
                            ;
                        } else if (this.isBackupPresent()) {
                            if (!(((iLockFlags) & (akra.ELockFlags.WRITE)) != 0)) {
                                this._pBackupUpdated = true;
                            }
                            pResult = this._pBackupCopy.lock(iOffset, iSize, iLockFlags);
                        } else {
                            pResult = this.lockImpl(iOffset, iSize, iLockFlags);
                            this._isLocked = true;
                        }
                        this._iLockStart = iOffset;
                        this._iLockSize = iSize;
                        return pResult;
                    };
                    HardwareBuffer.prototype.unlock = function () {
 {
                            akra.logger.setSourceLocation("core/pool/resources/HardwareBuffer.ts", 164);
                            akra.logger.assert(this.isLocked(), "Cannot unlock this buffer, it is not locked!");
                        }
                        ;
                        if (this._pBackupCopy && this._pBackupCopy.isLocked()) {
                            this._pBackupCopy.unlock();
                            this.restoreFromBackup();
                        } else {
                            this.unlockImpl();
                            this._isLocked = false;
                        }
                    };
                    HardwareBuffer.prototype.restoreFromBackup = function () {
                        if (this._pBackupCopy && this._pBackupUpdated && !this._bIgnoreHardwareUpdate) {
                            var pBackupData = this._pBackupCopy.lockImpl(this._iLockStart, this._iLockSize, akra.ELockFlags.READ);
                            var iLockFlags;
                            if (this._iLockStart == 0 && this._iLockSize == this.byteLength) {
                                iLockFlags = akra.ELockFlags.DISCARD;
                            } else {
                                iLockFlags = akra.ELockFlags.NORMAL;
                            }
                            var pRealData = this.lockImpl(this._iLockStart, this._iLockSize, iLockFlags);
                            this.copyBackupToRealImpl(pRealData, pBackupData, iLockFlags);
                            this.unlockImpl();
                            this._pBackupCopy.unlockImpl();
                            this._pBackupUpdated = false;
                            return true;
                        }
                        return false;
                    };
                    HardwareBuffer.prototype.createResource = function () {
 {
                            akra.logger.setSourceLocation("core/pool/resources/HardwareBuffer.ts", 212);
                            akra.logger.assert(!this.isResourceCreated(), "The resource has already been created.");
                        }
                        ;
                        this.notifyDisabled();
                        return true;
                    };
                    HardwareBuffer.prototype.destroyResource = function () {
                        if (this.isResourceCreated()) {
                            this.disableResource();
                            this.destroy();
                            return true;
                        }
                        return false;
                    };
                    HardwareBuffer.prototype.restoreResource = function () {
 {
                            akra.logger.setSourceLocation("core/pool/resources/HardwareBuffer.ts", 238);
                            akra.logger.assert(this.isResourceCreated(), "The resource has not been created.");
                        }
                        ;
                        this.notifyRestored();
                        return true;
                    };
                    HardwareBuffer.prototype.disableResource = function () {
 {
                            akra.logger.setSourceLocation("core/pool/resources/HardwareBuffer.ts", 245);
                            akra.logger.assert(this.isResourceCreated(), "The resource has not been created.");
                        }
                        ;
                        this.notifyDisabled();
                        return true;
                    };
                    HardwareBuffer.prototype.lockImpl = function (iOffset, iSize, iLockFlags) {
                        return null;
                    };
                    HardwareBuffer.prototype.unlockImpl = function () {
                    };
                    HardwareBuffer.prototype.copyBackupToRealImpl = function (pRealData, pBackupData, iLockFlags) {
                    };
                    return HardwareBuffer;
                })(pool.ResourcePoolItem);
                resources.HardwareBuffer = HardwareBuffer;                
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        var WebGLPixelBuffer = (function (_super) {
            __extends(WebGLPixelBuffer, _super);
            function WebGLPixelBuffer() {
                        _super.call(this);
                this._iWidth = 0;
                this._iHeight = 0;
                this._iDepth = 0;
                this._iRowPitch = 0;
                this._iSlicePitch = 0;
                this._eFormat = akra.EPixelFormats.UNKNOWN;
                this._pCurrentLock = null;
                this._pLockedBox = null;
                this._iCurrentLockFlags = 0;
                this._pBuffer = null;
                this._iWebGLInternalFormat = 0;
            }
            Object.defineProperty(WebGLPixelBuffer.prototype, "width", {
                get: function () {
                    return this._iWidth;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(WebGLPixelBuffer.prototype, "height", {
                get: function () {
                    return this._iHeight;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(WebGLPixelBuffer.prototype, "depth", {
                get: function () {
                    return this._iDepth;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(WebGLPixelBuffer.prototype, "format", {
                get: function () {
                    return this._eFormat;
                },
                enumerable: true,
                configurable: true
            });
            WebGLPixelBuffer.prototype.upload = function (pData, pDestBox) {
 {
                    akra.logger.setSourceLocation("webgl/WebGLPixelBuffer.ts", 46);
                    akra.logger.criticalError("Upload not possible for this pixelbuffer type");
                }
                ;
            };
            WebGLPixelBuffer.prototype.download = function (pData) {
 {
                    akra.logger.setSourceLocation("webgl/WebGLPixelBuffer.ts", 50);
                    akra.logger.criticalError("Download not possible for this pixelbuffer type");
                }
                ;
            };
            WebGLPixelBuffer.prototype._bindToFramebuffer = function (pAttachment, iZOffset) {
 {
                    akra.logger.setSourceLocation("webgl/WebGLPixelBuffer.ts", 54);
                    akra.logger.criticalError("Framebuffer bind not possible for this pixelbuffer type");
                }
                ;
            };
            WebGLPixelBuffer.prototype._getWebGLFormat = function () {
                return this._iWebGLInternalFormat;
            };
            WebGLPixelBuffer.prototype._clearRTT = function (iZOffset) {
            };
            WebGLPixelBuffer.prototype.reset = function (iWidth, iHeight) {
                if (typeof iWidth === "undefined") { iWidth = this._iWidth; }
                if (typeof iHeight === "undefined") { iHeight = iWidth; }
                this._iWidth = iWidth;
                this._iHeight = iHeight;
            };
            WebGLPixelBuffer.prototype.create = function () {
                if (arguments.length === 1) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLPixelBuffer.ts", 76);
                        akra.logger.criticalError("Invalid number of arguments. For PixelBuffer it must be six");
                    }
                    ;
                }
                var iWidth = arguments[0];
                var iHeight = arguments[1];
                var iDepth = arguments[2];
                var eFormat = arguments[3];
                var iFlags = arguments[4];
                _super.prototype.create.call(this, iFlags);
                this._iWidth = iWidth;
                this._iHeight = iHeight;
                this._iDepth = iDepth;
                this._eFormat = eFormat;
                this._iRowPitch = iWidth;
                this._iSlicePitch = iHeight * iWidth;
                this.byteLength = iHeight * iWidth * akra.pixelUtil.getNumElemBytes(eFormat);
                this._pBuffer = new akra.pixelUtil.PixelBox(iWidth, iHeight, iDepth, eFormat);
                this._iWebGLInternalFormat = 0;
                return true;
            };
            WebGLPixelBuffer.prototype.destroy = function () {
                this._pBuffer = null;
                _super.prototype.destroy.call(this);
            };
            WebGLPixelBuffer.prototype.destroyResource = function () {
                this.destroy();
                this.notifyDestroyed();
                return true;
            };
            WebGLPixelBuffer.prototype.readData = function () {
 {
                    akra.logger.setSourceLocation("webgl/WebGLPixelBuffer.ts", 116);
                    akra.logger.criticalError("Reading a byte range is not implemented. Use blitToMemory.");
                }
                ;
                return false;
            };
            WebGLPixelBuffer.prototype.writeData = function () {
 {
                    akra.logger.setSourceLocation("webgl/WebGLPixelBuffer.ts", 123);
                    akra.logger.criticalError("Writing a byte range is not implemented. Use blitFromMemory.");
                }
                ;
                return false;
            };
            WebGLPixelBuffer.prototype.blit = function (pSource, pSrcBox, pDestBox) {
                if (arguments.length == 1) {
                    return this.blit(pSource, new akra.geometry.Box(0, 0, 0, pSource.width, pSource.height, pSource.depth), new akra.geometry.Box(0, 0, 0, this._iWidth, this._iHeight, this._iDepth));
                } else {
                    if (pSource === this) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLPixelBuffer.ts", 141);
                            akra.logger.criticalError("Source must not be the same object");
                        }
                        ;
                    }
                    var pSrclock = pSource.lock(pSrcBox, akra.ELockFlags.READ);
                    var eLockMethod = akra.ELockFlags.NORMAL;
                    if (pDestBox.left === 0 && pDestBox.top === 0 && pDestBox.front === 0 && pDestBox.right === this._iWidth && pDestBox.bottom === this._iHeight && pDestBox.back === this._iDepth) {
                        eLockMethod = akra.ELockFlags.DISCARD;
                    }
                    var pDstlock = this.lock(pDestBox, eLockMethod);
                    if (pDstlock.width != pSrclock.width || pDstlock.height != pSrclock.height || pDstlock.depth != pSrclock.depth) {
                        pSrclock.scale(pDstlock);
                    } else {
                        akra.pixelUtil.bulkPixelConversion(pSrclock, pDstlock);
                    }
                    this.unlock();
                    pSource.unlock();
                    return true;
                }
            };
            WebGLPixelBuffer.prototype.blitFromMemory = function () {
                var pSource;
                var pDestBox;
                pSource = arguments[0];
                if (arguments.length === 1) {
                    pDestBox = new akra.geometry.Box(0, 0, 0, this._iWidth, this._iHeight, this._iDepth);
                    return this.blitFromMemory(pSource, pDestBox);
                } else {
                    pDestBox = arguments[1];
                }
                if (!this._pBuffer.contains(pDestBox)) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLPixelBuffer.ts", 191);
                        akra.logger.criticalError("Destination box out of range");
                    }
                    ;
                }
                var pScaledBox;
                if (pSource.width != pDestBox.width || pSource.height != pDestBox.height || pSource.depth != pDestBox.depth) {
                    this.allocateBuffer();
                    pScaledBox = this._pBuffer.getSubBox(pDestBox);
                    pSource.scale(pScaledBox, akra.EFilters.BILINEAR);
                } else if ((pSource.format != this._eFormat) || ((webgl.getWebGLFormat(pSource.format) == 0) && (pSource.format != akra.EPixelFormats.R8G8B8))) {
                    this.allocateBuffer();
                    pScaledBox = this._pBuffer.getSubBox(pDestBox);
                    akra.pixelUtil.bulkPixelConversion(pSource, pScaledBox);
                    if (this._eFormat === akra.EPixelFormats.A4R4G4B4) {
                        webgl.convertToWebGLformat(pScaledBox, pScaledBox);
                    }
                } else {
                    this.allocateBuffer();
                    pScaledBox = pSource;
                    if (pSource.format == akra.EPixelFormats.R8G8B8) {
                        pScaledBox.format = akra.EPixelFormats.B8G8R8;
                        akra.pixelUtil.bulkPixelConversion(pSource, pScaledBox);
                    }
                }
                this.upload(pScaledBox, pDestBox);
                this.freeBuffer();
                return true;
            };
            WebGLPixelBuffer.prototype.blitToMemory = function () {
                var pSrcBox;
                var pDest;
                if (arguments.length === 1) {
                    pDest = arguments[0];
                    pSrcBox = new akra.geometry.Box(0, 0, 0, this._iWidth, this._iHeight, this._iDepth);
                    return this.blitToMemory(pSrcBox, pDest);
                } else {
                    pSrcBox = arguments[0];
                    pDest = arguments[1];
                }
                if (!this._pBuffer.contains(pSrcBox)) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLPixelBuffer.ts", 255);
                        akra.logger.criticalError("source box out of range");
                    }
                    ;
                }
                if (pSrcBox.left == 0 && pSrcBox.right == this._iWidth && pSrcBox.top == 0 && pSrcBox.bottom == this._iHeight && pSrcBox.front == 0 && pSrcBox.back == this._iDepth && pDest.width == this._iWidth && pDest.height == this._iHeight && pDest.depth == this._iDepth && webgl.getWebGLFormat(pDest.format) != 0) {
                    this.download(pDest);
                } else {
                    this.allocateBuffer();
                    this.download(this._pBuffer);
                    if (pSrcBox.width != pDest.width || pSrcBox.height != pDest.height || pSrcBox.depth != pDest.depth) {
                        this._pBuffer.getSubBox(pSrcBox).scale(pDest, akra.EFilters.BILINEAR);
                    } else {
                        akra.pixelUtil.bulkPixelConversion(this._pBuffer.getSubBox(pSrcBox), pDest);
                    }
                    this.freeBuffer();
                }
                return true;
            };
            WebGLPixelBuffer.prototype.getRenderTarget = function () {
                return null;
            };
            WebGLPixelBuffer.prototype.lock = function () {
                var pLockBox = null;
                var iLockFlags = 0;
                if ((typeof (arguments[0]) === "number")) {
                    var iOffset;
                    var iSize;
                    if (arguments.length === 1) {
                        iLockFlags === arguments[0];
                        iOffset = 0;
                        iSize = this.byteLength;
                    } else {
                        iOffset = arguments[0];
                        iSize = arguments[1];
                        iLockFlags = (arguments.length === 3) ? arguments[2] : akra.EHardwareBufferFlags.READABLE;
                    }
 {
                        akra.logger.setSourceLocation("webgl/WebGLPixelBuffer.ts", 318);
                        akra.logger.assert(!this.isLocked(), "Cannot lock this buffer, it is already locked!");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("webgl/WebGLPixelBuffer.ts", 320);
                        akra.logger.assert(iOffset === 0 && iSize === this.byteLength, "Cannot lock memory region, most lock box or entire buffer");
                    }
                    ;
                    pLockBox = new akra.geometry.Box(0, 0, 0, this._iWidth, this._iHeight, this._iDepth);
                }
                if (this.isBackupPresent()) {
                    if (!(((iLockFlags) & (akra.ELockFlags.WRITE)) != 0)) {
                        this._pBackupUpdated = true;
                    }
                    this._pCurrentLock = ((this._pBackupCopy)).lock(pLockBox, iLockFlags);
                } else {
                    this._pCurrentLock = this.lockImpl(pLockBox, iLockFlags);
                    this._isLocked = true;
                }
                return this._pCurrentLock;
            };
            WebGLPixelBuffer.prototype.allocateBuffer = function () {
                if (!((this._pBuffer.data) === null)) {
                    return;
                }
                this._pBuffer.data = new Uint8Array(this.byteLength);
            };
            WebGLPixelBuffer.prototype.freeBuffer = function () {
                if ((((this._iFlags) & (akra.EHardwareBufferFlags.STATIC)) != 0)) {
                    this._pBuffer.data = null;
                }
            };
            WebGLPixelBuffer.prototype.lockImpl = function () {
                if (arguments.length === 3) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLPixelBuffer.ts", 360);
                        akra.logger.criticalError("lockImpl(offset,length) is not valid for PixelBuffers and should never be called");
                    }
                    ;
                }
                var pLockBox = arguments[0];
                var iLockFlags = arguments[1];
                this.allocateBuffer();
                if (!(((iLockFlags) & (akra.ELockFlags.DISCARD)) != 0) && (((this._iFlags) & (akra.EHardwareBufferFlags.READABLE)) != 0)) {
                    this.download(this._pBuffer);
                }
                this._iCurrentLockFlags = iLockFlags;
                this._pLockedBox = pLockBox;
                return this._pBuffer.getSubBox(pLockBox);
            };
            WebGLPixelBuffer.prototype.unlockImpl = function () {
                if ((((this._iCurrentLockFlags) & (akra.ELockFlags.WRITE)) != 0)) {
                    this.upload(this._pCurrentLock, this._pLockedBox);
                }
                this.freeBuffer();
            };
            return WebGLPixelBuffer;
        })(akra.core.pool.resources.HardwareBuffer);
        webgl.WebGLPixelBuffer = WebGLPixelBuffer;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                (function (ETextureForcedFormatFlags) {
                    ETextureForcedFormatFlags._map = [];
                    ETextureForcedFormatFlags.FORCEMIPLEVELS = 0;
                    ETextureForcedFormatFlags._map[1] = "FORCEFORMAT";
                    ETextureForcedFormatFlags.FORCEFORMAT = 1;
                    ETextureForcedFormatFlags._map[2] = "FORCESIZE";
                    ETextureForcedFormatFlags.FORCESIZE = 2;
                })(resources.ETextureForcedFormatFlags || (resources.ETextureForcedFormatFlags = {}));
                var ETextureForcedFormatFlags = resources.ETextureForcedFormatFlags;
                var Texture = (function (_super) {
                    __extends(Texture, _super);
                    function Texture() {
                                        _super.call(this);
                        this._iFlags = akra.ETextureFlags.DEFAULT;
                        this._iWidth = 512;
                        this._iHeight = 512;
                        this._iDepth = 1;
                        this._eFormat = akra.EPixelFormats.UNKNOWN;
                        this._nMipLevels = 0;
                        this._nRequestedMipLevels = 0;
                        this._eTextureType = akra.ETextureTypes.TEXTURE_2D;
                        this._pParams = {};
                        this._isInternalResourceCreated = false;
                        this._isMipmapsHardwareGenerated = false;
                    }
                    Object.defineProperty(Texture.prototype, "width", {
                        get: function () {
                            return this._iWidth;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Texture.prototype, "height", {
                        get: function () {
                            return this._iHeight;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Texture.prototype, "depth", {
                        get: function () {
                            return this._iDepth;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Texture.prototype, "format", {
                        get: function () {
                            return this._eFormat;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Texture.prototype, "textureType", {
                        get: function () {
                            return this._eTextureType;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(Texture.prototype, "mipLevels", {
                        get: function () {
                            return this._nMipLevels;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Texture.prototype.getFlags = function () {
                        return this._iFlags;
                    };
                    Texture.prototype.setFlags = function (iFlags) {
                        this._iFlags = iFlags;
                    };
                    Texture.prototype.isTexture2D = function () {
                        return this._eTextureType === akra.ETextureTypes.TEXTURE_2D;
                    };
                    Texture.prototype.isTextureCube = function () {
                        return this._eTextureType === akra.ETextureTypes.TEXTURE_CUBE_MAP;
                    };
                    Texture.prototype.isCompressed = function () {
                        return (this._eFormat >= akra.EPixelFormats.DXT1 && this._eFormat <= akra.EPixelFormats.DXT5) || (this._eFormat >= akra.EPixelFormats.PVRTC_RGB2 && this._eFormat <= akra.EPixelFormats.PVRTC_RGBA4);
                    };
                    Texture.prototype.isValid = function () {
                        return ((this._isInternalResourceCreated) != null);
                    };
                    Texture.prototype.calculateSize = function () {
                        return this.getNumFaces() * akra.pixelUtil.getMemorySize(this._iWidth, this._iHeight, this._iDepth, this._eFormat);
                    };
                    Texture.prototype.getNumFaces = function () {
                        return this._eTextureType === akra.ETextureTypes.TEXTURE_CUBE_MAP ? 6 : 1;
                    };
                    Texture.prototype.getSize = function () {
                        return this.getNumFaces() * akra.pixelUtil.getMemorySize(this._iWidth, this._iHeight, this._iDepth, this._eFormat);
                    };
                    Texture.prototype.reset = function (iWidth, iHeight) {
                        if (typeof iWidth === "undefined") { iWidth = this._iWidth; }
                        if (typeof iHeight === "undefined") { iHeight = iWidth; }
                        this._iWidth = iWidth;
                        this._iHeight = iHeight;
                    };
                    Texture.prototype.getBuffer = function (iFace, iMipmap) {
                        return null;
                    };
                    Texture.prototype.create = function (iWidth, iHeight, iDepth, pPixels, eFlags, nMipLevels, nFaces, eTextureType, eFormat) {
                        if (typeof iDepth === "undefined") { iDepth = 1; }
                        if (typeof pPixels === "undefined") { pPixels = null; }
                        if (typeof eFlags === "undefined") { eFlags = akra.ETextureFlags.DEFAULT; }
                        if (typeof nMipLevels === "undefined") { nMipLevels = 0; }
                        if (typeof nFaces === "undefined") { nFaces = 0; }
                        if (typeof eTextureType === "undefined") { eTextureType = akra.ETextureTypes.TEXTURE_2D; }
                        if (typeof eFormat === "undefined") { eFormat = akra.EPixelFormats.B8G8R8; }
                        if (eTextureType != akra.ETextureTypes.TEXTURE_2D && eTextureType != akra.ETextureTypes.TEXTURE_CUBE_MAP) {
 {
                                akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 173);
                                akra.logger.criticalError("Заданный тип текстуры не поддреживается");
                            }
                            ;
                            return false;
                        }
                        this._eTextureType = eTextureType;
                        this._iWidth = iWidth;
                        this._iHeight = iHeight;
                        this._iDepth = iDepth;
                        this._iFlags = eFlags;
                        this._nMipLevels = nMipLevels;
                        this._eFormat = eFormat;
                        if (akra.isArray(pPixels)) {
                            pPixels = new Uint8Array(pPixels);
                            return this.loadRawData(pPixels, iWidth, iHeight, iDepth, eFormat, nFaces, nMipLevels);
                        } else if (((pPixels) !== null && typeof (pPixels) === "object" && typeof (pPixels).byteOffset === "number")) {
                            return this.loadRawData(pPixels, iWidth, iHeight, iDepth, eFormat, nFaces, nMipLevels);
                        } else {
                            return this.createInternalTexture(pPixels);
                        }
                    };
                    Texture.prototype.loadResource = function (sFilename) {
                        if (arguments.length == 0) {
                            return;
                        }
                        var pImage = this.getManager().loadImage(sFilename);
                        if (pImage.isResourceLoaded()) {
                            return this.loadImage(pImage);
                        }
                        this.connect(pImage, "loaded", "_onImageLoad");
                        return true;
                    };
                    Texture.prototype._onImageLoad = function (pImage) {
 {
                            akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 221);
                            akra.logger.log("resource loaded > ", pImage.findResourceName(), this.findResourceName());
                        }
                        ;
                        this.disconnect(pImage, "loaded", "_onImageLoad");
                        this.loadImage(pImage);
                    };
                    Texture.prototype.destroyResource = function () {
                        this.freeInternalTexture();
                        this.notifyDestroyed();
                        return true;
                    };
                    Texture.prototype.setFilter = function (eParam, eValue) {
                        if (!this.isValid()) {
                            return false;
                        }
                        this._pParams[eParam] = eValue;
                        return this._setFilterInternalTexture(eParam, eValue);
                    };
                    Texture.prototype.setWrapMode = function (eParam, eValue) {
                        if (!this.isValid()) {
                            return false;
                        }
                        this._pParams[eParam] = eValue;
                        return this._setWrapModeInternalTexture(eParam, eValue);
                    };
                    Texture.prototype.getFilter = function (eParam) {
                        if (!this.isValid()) {
                            return 0;
                        }
                        var iValue = this._pParams[eParam];
                        if (!((iValue) != null)) {
                            iValue = this._getFilterInternalTexture(eParam);
                            this._pParams[eParam] = iValue;
                        }
                        return iValue;
                    };
                    Texture.prototype.getWrapMode = function (eParam) {
                        if (!this.isValid()) {
                            return 0;
                        }
                        var iValue = this._pParams[eParam];
                        if (!((iValue) != null)) {
                            iValue = this._getWrapModeInternalTexture(eParam);
                            this._pParams[eParam] = iValue;
                        }
                        return iValue;
                    };
                    Texture.prototype._setFilterInternalTexture = function (eParam, eValue) {
 {
                            akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 281);
                            akra.logger.criticalError("virual");
                        }
                        ;
                        return false;
                    };
                    Texture.prototype._setWrapModeInternalTexture = function (eParam, eValue) {
 {
                            akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 285);
                            akra.logger.criticalError("virual");
                        }
                        ;
                        return false;
                    };
                    Texture.prototype._getFilterInternalTexture = function (eParam) {
 {
                            akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 290);
                            akra.logger.criticalError("virual");
                        }
                        ;
                        return 0;
                    };
                    Texture.prototype._getWrapModeInternalTexture = function (eParam) {
 {
                            akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 294);
                            akra.logger.criticalError("virual");
                        }
                        ;
                        return 0;
                    };
                    Texture.prototype.loadRawData = function (pData, iWidth, iHeight, iDepth, eFormat, nFaces, nMipMaps) {
                        if (typeof iDepth === "undefined") { iDepth = 1; }
                        if (typeof eFormat === "undefined") { eFormat = akra.EPixelFormats.BYTE_BGR; }
                        if (typeof nFaces === "undefined") { nFaces = 1; }
                        if (typeof nMipMaps === "undefined") { nMipMaps = 0; }
                        var pTempImg = this.getManager().imagePool.findResource(".texture.temp_image");
                        if (((pTempImg) === null)) {
                            pTempImg = this.getManager().imagePool.createResource(".texture.temp_image");
                        }
                        pTempImg.loadRawData(pData, iWidth, iHeight, iDepth, eFormat, nFaces, nMipMaps);
                        var isLoaded = this.loadImage(pTempImg);
                        this.getManager().imagePool.destroyResource(pTempImg);
                        return isLoaded;
                    };
                    Texture.prototype.loadImage = function (pImage) {
                        var isLoaded = this._loadImages(pImage);
                        if (isLoaded) {
                            this.notifyLoaded();
                            return true;
                        } else {
                            return false;
                        }
                    };
                    Texture.prototype.loadImages = function (pImages) {
                        var isLoaded = this._loadImages(pImages);
                        if (isLoaded) {
                            this.notifyLoaded();
                            return true;
                        } else {
                            return false;
                        }
                    };
                    Texture.prototype._loadImages = function (pImage) {
                        if (this.isResourceLoaded()) {
 {
                                akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 352);
                                akra.logger.warning("Yoy try to load texture when it already have been loaded. All texture data was destoyed.");
                            }
                            ;
                            this.freeInternalTexture();
                        }
                        var pMainImage = null;
                        var pImageList = null;
                        if (!akra.isArray(pImage)) {
                            pMainImage = pImage;
                            pImageList = new Array(0);
                            pImageList[0] = pMainImage;
                        } else {
                            pImageList = arguments[0];
                            if (pImageList.length === 0) {
 {
                                    akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 369);
                                    akra.logger.criticalError("Cannot load empty list of images");
                                }
                                ;
                                return false;
                            }
                            pMainImage = pImageList[0];
                        }
                        this._iWidth = pMainImage.width;
                        this._iHeight = pMainImage.height;
                        this._iDepth = pMainImage.depth;
                        if (akra.webgl.isWebGLFormatSupport(pMainImage.format)) {
                            this._eFormat = pMainImage.format;
                        } else {
 {
                                akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 389);
                                akra.logger.warning("Format not support(" + akra.pixelUtil.getFormatName(pMainImage.format) + ")");
                            }
                            ;
                            if (pMainImage.convert(akra.EPixelFormats.B8G8R8A8)) {
                                this._eFormat = pMainImage.format;
                            } else {
 {
                                    akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 396);
                                    akra.logger.criticalError("Format not convert");
                                }
                                ;
                            }
                        }
                        for(i = 1; i < pImageList.length; i++) {
                            if (!pImageList[i].convert(pMainImage.format)) {
 {
                                    akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 404);
                                    akra.logger.criticalError("Format not support and not convert");
                                }
                                ;
                            }
                        }
                        var iImageMips = pMainImage.numMipMaps;
                        if (iImageMips == resources.Img.getMaxMipmaps(this._iWidth, this._iHeight, this._iDepth, this._eFormat)) {
                            this._nMipLevels = iImageMips;
                            ((this._iFlags) &= ~(akra.ETextureFlags.AUTOMIPMAP));
                        } else {
                            this._nMipLevels = 0;
                        }
                        var iFaces = 0;
                        var isMultiImage = false;
                        if (pImageList.length == 6) {
                            iFaces = 6;
                            isMultiImage = true;
                            this._eTextureType = akra.ETextureTypes.TEXTURE_CUBE_MAP;
                        } else if (pMainImage.numFaces == 6) {
                            iFaces = 6;
                            isMultiImage = false;
                            this._eTextureType = akra.ETextureTypes.TEXTURE_CUBE_MAP;
                        } else {
                            iFaces = 1;
                            isMultiImage = false;
                            this._eTextureType = akra.ETextureTypes.TEXTURE_2D;
                        }
                        if (iFaces > this.getNumFaces()) {
                            iFaces = this.getNumFaces();
                        }
                        this.createInternalTexture(null);
                        var mip = 0;
                        var i = 0;
                        for(mip = 0; mip <= this._nMipLevels; ++mip) {
                            for(i = 0; i < iFaces; ++i) {
                                var pSrc;
                                if (isMultiImage) {
                                    pSrc = pImageList[i].getPixels(0, mip);
                                } else {
                                    pSrc = pMainImage.getPixels(i, mip);
                                }
                                this.getBuffer(i, mip).blitFromMemory(pSrc);
                            }
                        }
                        return true;
                    };
                    Texture.prototype.convertToImage = function (pDestImage, bIncludeMipMaps) {
 {
                            akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 492);
                            akra.logger.criticalError("!!!нехуй");
                        }
                        var iNumMips = bIncludeMipMaps ? this._nMipLevels + 1 : 1;
                        var iDataSize = akra.pixelUtil.calculateSizeForImage(iNumMips, this._nMipLevels, this._iWidth, this._iHeight, this._iDepth, this._eFormat);
                        var pPixData = new Uint8Array(iDataSize);
                        var pCurrentPixData = pPixData;
                        var iFace = 0;
                        var mip = 0;
                        for(iFace = 0; iFace < this.getNumFaces(); ++iFace) {
                            for(mip = 0; mip < iNumMips; ++mip) {
                                var iMipDataSize = akra.pixelUtil.getMemorySize(this._iWidth, this._iHeight, this._iDepth, this._eFormat);
                                var pPixBox = new akra.pixelUtil.PixelBox(this._iWidth, this._iHeight, this._iDepth, this._eFormat, pCurrentPixData);
                                this.getBuffer(iFace, mip).blitToMemory(pPixBox);
                                pCurrentPixData = pCurrentPixData.subarray(iMipDataSize);
                            }
                        }
                        pDestImage.loadDynamicImage(pPixData, this._iWidth, this._iHeight, this._iDepth, this._eFormat, this.getNumFaces(), iNumMips - 1);
                    };
                    Texture.prototype.copyToTexture = function (pTarget) {
 {
                            akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 525);
                            akra.logger.criticalError("!!!нехуй");
                        }
                        if (pTarget.getNumFaces() !== this.getNumFaces()) {
 {
                                akra.logger.setSourceLocation("core/pool/resources/Texture.ts", 527);
                                akra.logger.criticalError("Texture types must match");
                            }
                            ;
                        }
                        var nMipLevels = Math.min(this._nMipLevels, pTarget.mipLevels);
                        if ((((this._iFlags) & (akra.ETextureFlags.AUTOMIPMAP)) != 0) || (((this.getFlags()) & (akra.ETextureFlags.AUTOMIPMAP)) != 0)) {
                            nMipLevels = 0;
                        }
                        var iFace = 0, mip = 0;
                        for(iFace = 0; iFace < this.getNumFaces(); iFace++) {
                            for(mip = 0; mip <= nMipLevels; mip++) {
                                pTarget.getBuffer(iFace, mip).blit(this.getBuffer(iFace, mip));
                            }
                        }
                    };
                    Texture.prototype.createInternalTexture = function (cFillColor) {
                        if (typeof cFillColor === "undefined") { cFillColor = null; }
                        if (!this._isInternalResourceCreated) {
                            this._createInternalTextureImpl(cFillColor);
                            this._isInternalResourceCreated = true;
                            this.notifyCreated();
                            return true;
                        }
                        return false;
                    };
                    Texture.prototype.freeInternalTexture = function () {
                        if (this._isInternalResourceCreated) {
                            this.freeInternalTextureImpl();
                            this._isInternalResourceCreated = false;
                            this.notifyDestroyed();
                            return true;
                        }
                        return false;
                    };
                    Texture.prototype._createInternalTextureImpl = function (cFillColor) {
                        if (typeof cFillColor === "undefined") { cFillColor = null; }
                        return false;
                    };
                    Texture.prototype.freeInternalTextureImpl = function () {
                        return false;
                    };
                    Texture.prototype.setPixelRGBA = function (i1, i2, iTextureWidth, iTextureHeight, pBuffer) {
                        return;
                    };
                    return Texture;
                })(pool.ResourcePoolItem);
                resources.Texture = Texture;                
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    ;
    ;
    ;
    (function (ECameraParameters) {
        ECameraParameters._map = [];
        ECameraParameters.CONST_ASPECT = 1;
    })(akra.ECameraParameters || (akra.ECameraParameters = {}));
    var ECameraParameters = akra.ECameraParameters;
    (function (ECameraTypes) {
        ECameraTypes._map = [];
        ECameraTypes._map[0] = "PERSPECTIVE";
        ECameraTypes.PERSPECTIVE = 0;
        ECameraTypes._map[1] = "ORTHO";
        ECameraTypes.ORTHO = 1;
        ECameraTypes._map[2] = "OFFSET_ORTHO";
        ECameraTypes.OFFSET_ORTHO = 2;
    })(akra.ECameraTypes || (akra.ECameraTypes = {}));
    var ECameraTypes = akra.ECameraTypes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    (function (EFramebuffer) {
        EFramebuffer._map = [];
        EFramebuffer._map[0] = "FRONT";
        EFramebuffer.FRONT = 0;
        EFramebuffer._map[1] = "BACK";
        EFramebuffer.BACK = 1;
        EFramebuffer._map[2] = "AUTO";
        EFramebuffer.AUTO = 2;
    })(akra.EFramebuffer || (akra.EFramebuffer = {}));
    var EFramebuffer = akra.EFramebuffer;
    ;
    (function (EStatFlags) {
        EStatFlags._map = [];
        EStatFlags.NONE = 0;
        EStatFlags.FPS = 1;
        EStatFlags.AVG_FPS = 2;
        EStatFlags.BEST_FPS = 4;
        EStatFlags.WORST_FPS = 8;
        EStatFlags.TRIANGLE_COUNT = 16;
        EStatFlags.ALL = 0xFFFF;
    })(akra.EStatFlags || (akra.EStatFlags = {}));
    var EStatFlags = akra.EStatFlags;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var VariableBlendContainer = (function () {
            function VariableBlendContainer() {
                this._pVarListMap = null;
                this._pVarKeys = null;
                this._pVarBlendTypeMap = null;
                this._pVarListMap = {};
                this._pVarKeys = [];
                this._pVarBlendTypeMap = {};
            }
            Object.defineProperty(VariableBlendContainer.prototype, "keys", {
                get: function () {
                    return this._pVarKeys;
                },
                enumerable: true,
                configurable: true
            });
            VariableBlendContainer.prototype.getVarList = function (sKey) {
                return this._pVarListMap[sKey];
            };
            VariableBlendContainer.prototype.getBlendType = function (sKey) {
                return this._pVarBlendTypeMap[sKey];
            };
            VariableBlendContainer.prototype.addVariable = function (pVariable, eBlendMode) {
                var sName = pVariable.getRealName();
                if (!((this._pVarListMap[sName]) !== undefined)) {
                    this._pVarListMap[sName] = [
                        pVariable
                    ];
                    this._pVarKeys.push(sName);
                    this._pVarBlendTypeMap[sName] = pVariable.getType();
                    return true;
                }
                var pBlendType = this._pVarBlendTypeMap[sName].blend(pVariable.getType(), eBlendMode);
                if (pBlendType === this._pVarBlendTypeMap[sName]) {
                    return true;
                }
                if (((pBlendType) === null)) {
 {
                        akra.logger.setSourceLocation("fx/BlendContainers.ts", 51);
                        akra.logger.error("Could not blend type for variable '" + sName + "'");
                    }
                    ;
                    return false;
                }
                this._pVarListMap[sName].push(pVariable);
                this._pVarBlendTypeMap[sName] = pBlendType;
                return true;
            };
            VariableBlendContainer.prototype.hasVariableWithName = function (sName) {
                if (!((this._pVarBlendTypeMap[sName]) != null)) {
                    this._pVarBlendTypeMap[sName] = null;
                    return false;
                }
                return true;
            };
            VariableBlendContainer.prototype.hasVariable = function (pVar) {
                return this.hasVariableWithName(pVar.getRealName());
            };
            VariableBlendContainer.prototype.getVariableByName = function (sName) {
                return this.hasVariableWithName(sName) ? this._pVarListMap[sName][0] : null;
            };
            VariableBlendContainer.prototype.getDeclCodeForVar = function (sName) {
                var pType = this.getBlendType(sName);
                var sCode = pType.toFinalCode() + " ";
                var pVar = this.getVariableByName(sName);
                sCode += pVar.getRealName();
                if (pVar.getType().isNotBaseArray()) {
                    var iLength = pVar.getType().getLength();
                    if (akra.webgl.isANGLE && iLength === 1 && pVar.getType().isComplex()) {
                        sCode += "[" + 2 + "]";
                    } else {
                        sCode += "[" + iLength + "]";
                    }
                }
                return sCode;
            };
            return VariableBlendContainer;
        })();
        fx.VariableBlendContainer = VariableBlendContainer;        
        var ComplexTypeBlendContainer = (function () {
            function ComplexTypeBlendContainer() {
                this._pTypeListMap = null;
                this._pTypeKeys = null;
                this._pTypeListMap = {};
                this._pTypeKeys = [];
            }
            Object.defineProperty(ComplexTypeBlendContainer.prototype, "keys", {
                get: function () {
                    return this._pTypeKeys;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ComplexTypeBlendContainer.prototype, "types", {
                get: function () {
                    return this._pTypeListMap;
                },
                enumerable: true,
                configurable: true
            });
            ComplexTypeBlendContainer.prototype.addComplexType = function (pComplexType) {
                var pFieldList = (pComplexType)._getFieldDeclList();
                for(var i = 0; i < pFieldList.length; i++) {
                    if (pFieldList[i].getType().isComplex()) {
                        if (!this.addComplexType(pFieldList[i].getType().getBaseType())) {
                            return false;
                        }
                    }
                }
                var sName = pComplexType.getRealName();
                if (!((this._pTypeListMap[sName]) !== undefined)) {
                    this._pTypeListMap[sName] = pComplexType;
                    this._pTypeKeys.push(sName);
                    return true;
                }
                var pBlendType = this._pTypeListMap[sName].blend(pComplexType, akra.EAFXBlendMode.k_TypeDecl);
                if (((pBlendType) === null)) {
 {
                        akra.logger.setSourceLocation("fx/BlendContainers.ts", 138);
                        akra.logger.error("Could not blend type declaration '" + sName + "'");
                    }
                    ;
                    return false;
                }
                this._pTypeListMap[sName] = pBlendType;
                return true;
            };
            ComplexTypeBlendContainer.prototype.addFromVarConatiner = function (pContainer) {
                if (((pContainer) === null)) {
                    return true;
                }
                var pKeys = pContainer.keys;
                for(var i = 0; i < pKeys.length; i++) {
                    var pType = pContainer.getBlendType(pKeys[i]).getBaseType();
                    if (pType.isComplex()) {
                        if (!this.addComplexType(pType)) {
                            return false;
                        }
                    }
                }
                return true;
            };
            return ComplexTypeBlendContainer;
        })();
        fx.ComplexTypeBlendContainer = ComplexTypeBlendContainer;        
        var ExtSystemDataContainer = (function () {
            function ExtSystemDataContainer() {
                this._pExtSystemMacrosList = null;
                this._pExtSystemTypeList = null;
                this._pExtSystemFunctionList = null;
                this._pExtSystemMacrosList = [];
                this._pExtSystemTypeList = [];
                this._pExtSystemFunctionList = [];
            }
            Object.defineProperty(ExtSystemDataContainer.prototype, "macroses", {
                get: function () {
                    return this._pExtSystemMacrosList;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ExtSystemDataContainer.prototype, "types", {
                get: function () {
                    return this._pExtSystemTypeList;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ExtSystemDataContainer.prototype, "functions", {
                get: function () {
                    return this._pExtSystemFunctionList;
                },
                enumerable: true,
                configurable: true
            });
            ExtSystemDataContainer.prototype.addFromFunction = function (pFunction) {
                var pTypes = pFunction._getExtSystemTypeList();
                var pMacroses = pFunction._getExtSystemMacrosList();
                var pFunctions = pFunction._getExtSystemFunctionList();
                if (!((pTypes) === null)) {
                    for(var j = 0; j < pTypes.length; j++) {
                        if (this._pExtSystemTypeList.indexOf(pTypes[j]) === -1) {
                            this._pExtSystemTypeList.push(pTypes[j]);
                        }
                    }
                }
                if (!((pMacroses) === null)) {
                    for(var j = 0; j < pMacroses.length; j++) {
                        if (this._pExtSystemMacrosList.indexOf(pMacroses[j]) === -1) {
                            this._pExtSystemMacrosList.push(pMacroses[j]);
                        }
                    }
                }
                if (!((pFunctions) === null)) {
                    for(var j = 0; j < pFunctions.length; j++) {
                        if (this._pExtSystemFunctionList.indexOf(pFunctions[j]) === -1) {
                            this._pExtSystemFunctionList.push(pFunctions[j]);
                        }
                    }
                }
            };
            return ExtSystemDataContainer;
        })();
        fx.ExtSystemDataContainer = ExtSystemDataContainer;        
        var AttributeBlendContainer = (function (_super) {
            __extends(AttributeBlendContainer, _super);
            function AttributeBlendContainer() {
                        _super.call(this);
                this._pSlotBySemanticMap = null;
                this._pFlowsBySemanticMap = null;
                this._pFlowBySlots = null;
                this._pHashBySlots = null;
                this._pTypesBySlots = null;
                this._pVBByBufferSlots = null;
                this._pHashByBufferSlots = null;
                this._pBufferSlotBySlots = null;
                this._pOffsetVarsBySemanticMap = null;
                this._pOffsetDefaultMap = null;
                this._sHash = "";
                this._pSlotBySemanticMap = {};
                this._pFlowsBySemanticMap = {};
                this._pFlowBySlots = new akra.util.ObjectArray();
                this._pHashBySlots = new akra.util.ObjectArray();
                this._pTypesBySlots = new akra.util.ObjectArray();
                this._pVBByBufferSlots = new akra.util.ObjectArray();
                this._pHashByBufferSlots = new akra.util.ObjectArray();
                this._pBufferSlotBySlots = new akra.util.ObjectArray();
                var pSemantics = this.semantics;
                for(var i = 0; i < pSemantics.length; i++) {
                    var sSemantic = pSemantics[i];
                    this._pSlotBySemanticMap[sSemantic] = -1;
                    this._pFlowsBySemanticMap[sSemantic] = null;
                }
            }
            Object.defineProperty(AttributeBlendContainer.prototype, "semantics", {
                get: function () {
                    return this.keys;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(AttributeBlendContainer.prototype, "totalSlots", {
                get: function () {
                    return this._pFlowBySlots.length;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(AttributeBlendContainer.prototype, "totalBufferSlots", {
                get: function () {
                    return this._pVBByBufferSlots.length;
                },
                enumerable: true,
                configurable: true
            });
            AttributeBlendContainer.prototype.getOffsetVarsBySemantic = function (sName) {
                return this._pOffsetVarsBySemanticMap[sName];
            };
            AttributeBlendContainer.prototype.getOffsetDefault = function (sName) {
                return this._pOffsetDefaultMap[sName];
            };
            AttributeBlendContainer.prototype.getSlotBySemantic = function (sSemantic) {
                return this._pSlotBySemanticMap[sSemantic];
            };
            AttributeBlendContainer.prototype.getBufferSlotBySemantic = function (sSemantic) {
                return this._pBufferSlotBySlots.value(this.getSlotBySemantic(sSemantic));
            };
            AttributeBlendContainer.prototype.getAttributeList = function (sSemantic) {
                return this.getVarList(sSemantic);
            };
            AttributeBlendContainer.prototype.getFlowBySemantic = function (sSemantic) {
                return this._pFlowsBySemanticMap[sSemantic];
            };
            AttributeBlendContainer.prototype.getFlowBySlot = function (iSlot) {
                return this._pFlowBySlots.value(iSlot);
            };
            AttributeBlendContainer.prototype.getTypeBySlot = function (iSlot) {
                return this._pTypesBySlots.value(iSlot);
            };
            AttributeBlendContainer.prototype.getType = function (sSemantic) {
                return this.getBlendType(sSemantic);
            };
            AttributeBlendContainer.prototype.addAttribute = function (pVariable) {
                return this.addVariable(pVariable, akra.EAFXBlendMode.k_Attribute);
            };
            AttributeBlendContainer.prototype.hasAttrWithSemantic = function (sSemantic) {
                return this.hasVariableWithName(sSemantic);
            };
            AttributeBlendContainer.prototype.getAttribute = function (sSemantic) {
                return this.getVariableByName(sSemantic);
            };
            AttributeBlendContainer.prototype.hasTexcoord = function (iSlot) {
                return this.hasAttrWithSemantic(akra.DeclUsages.TEXCOORD + iSlot.toString());
            };
            AttributeBlendContainer.prototype.getTexcoordVar = function (iSlot) {
                return this.getVariableByName(akra.DeclUsages.TEXCOORD + iSlot.toString());
            };
            AttributeBlendContainer.prototype.clear = function () {
                var pSemantics = this.semantics;
                for(var i = 0; i < pSemantics.length; i++) {
                    var sSemantic = pSemantics[i];
                    this._pSlotBySemanticMap[sSemantic] = -1;
                    this._pFlowsBySemanticMap[sSemantic] = null;
                }
                this._pFlowBySlots.clear(false);
                this._pHashBySlots.clear(false);
                this._pVBByBufferSlots.clear(false);
                this._pHashByBufferSlots.clear(false);
                this._pBufferSlotBySlots.clear(false);
                this._sHash = "";
            };
            AttributeBlendContainer.prototype.generateOffsetMap = function () {
                this._pOffsetVarsBySemanticMap = {};
                this._pOffsetDefaultMap = {};
                var pSemantics = this.semantics;
                for(var i = 0; i < pSemantics.length; i++) {
                    var sSemantic = pSemantics[i];
                    var pAttr = this.getAttribute(sSemantic);
                    if (pAttr.isPointer()) {
                        this._pOffsetVarsBySemanticMap[sSemantic] = [];
                        if (pAttr.getType().isComplex()) {
                            var pAttrSubDecls = pAttr.getSubVarDecls();
                            for(var j = 0; j < pAttrSubDecls.length; j++) {
                                var pSubDecl = pAttrSubDecls[j];
                                if (pSubDecl.getName() === "offset") {
                                    var sOffsetName = pSubDecl.getRealName();
                                    this._pOffsetVarsBySemanticMap[sSemantic].push(pSubDecl);
                                    this._pOffsetDefaultMap[sOffsetName] = (pSubDecl.getParent()).getType().getPadding();
                                }
                            }
                        } else {
                            var pOffsetVar = pAttr.getType()._getAttrOffset();
                            var sOffsetName = pOffsetVar.getRealName();
                            this._pOffsetVarsBySemanticMap[sSemantic].push(pOffsetVar);
                            this._pOffsetDefaultMap[sOffsetName] = 0;
                        }
                    } else {
                        this._pOffsetVarsBySemanticMap[sSemantic] = null;
                    }
                }
            };
            AttributeBlendContainer.prototype.initFromBufferMap = function (pMap) {
                this.clear();
                if (((pMap) === null)) {
 {
                        akra.logger.setSourceLocation("fx/BlendContainers.ts", 451);
                        akra.logger.warning("Yoy don`t set any buffermap for render");
                    }
                    ;
                    return false;
                }
                var pFlows = pMap.flows;
                var pSemanticList = this.semantics;
                for(var i = 0; i < pSemanticList.length; i++) {
                    var sSemantic = pSemanticList[i];
                    var pFindFlow = null;
                    if (this.getType(sSemantic).isComplex()) {
                        pFindFlow = pMap.findFlow(sSemantic) || pMap.getFlow(sSemantic);
                    } else {
                        pFindFlow = pMap.getFlow(sSemantic);
                    }
                    this._pFlowsBySemanticMap[sSemantic] = pFindFlow;
                    if (!((pFindFlow) === null)) {
                        var iBufferSlot = -1;
                        if (pFindFlow.type === akra.EDataFlowTypes.MAPPABLE) {
                            if (!this.getType(sSemantic).isPointer()) {
 {
                                    akra.logger.setSourceLocation("fx/BlendContainers.ts", 476);
                                    akra.logger.warning("You try to put pointer data into non-pointer attribute with semantic '" + sSemantic + "'");
                                }
                                ;
                                return false;
                            }
                            var iSlot = this._pFlowBySlots.indexOf(pFindFlow);
                            if (iSlot !== -1) {
                                this._pHashBySlots.value(iSlot) += this.getType(sSemantic).getGuid().toString() + "*";
                                this._pSlotBySemanticMap[sSemantic] = iSlot;
                                iBufferSlot = this._pBufferSlotBySlots.value(iSlot);
                                this._pHashByBufferSlots.value(iBufferSlot) += iSlot.toString() + "$";
                                continue;
                            }
                            iBufferSlot = this._pVBByBufferSlots.indexOf(pFindFlow.data.buffer);
                            iSlot = this._pFlowBySlots.length;
                            if (iBufferSlot !== -1) {
                                this._pHashByBufferSlots.value(iBufferSlot) += iSlot.toString() + "$";
                            } else {
                                iBufferSlot = this._pVBByBufferSlots.length;
                                this._pVBByBufferSlots.push(pFindFlow.data.buffer);
                                this._pHashByBufferSlots.push(this._pFlowBySlots.length.toString() + "$");
                            }
                        } else if (this.getType(sSemantic).isStrictPointer()) {
 {
                                akra.logger.setSourceLocation("fx/BlendContainers.ts", 505);
                                akra.logger.warning("You try to put non-pointer data into pointer attribute with semantic '" + sSemantic + "'");
                            }
                            ;
                            return false;
                        }
                        if (pFindFlow.type === akra.EDataFlowTypes.MAPPABLE) {
                            this._pTypesBySlots.push(fx.Effect.getSystemType("ptr"));
                        } else {
                            this._pTypesBySlots.push(this.getType(sSemantic).getBaseType());
                        }
                        this._pSlotBySemanticMap[sSemantic] = this._pFlowBySlots.length;
                        this._pFlowBySlots.push(pFindFlow);
                        this._pHashBySlots.push(this.getType(sSemantic).getGuid().toString() + "*");
                        this._pBufferSlotBySlots.push(iBufferSlot);
                    } else {
                        this._pSlotBySemanticMap[sSemantic] = -1;
                    }
                }
                this._sHash = "";
                for(var i = 0; i < this._pHashBySlots.length; i++) {
                    this._sHash += this._pHashBySlots.value(i) + "*";
                }
                for(var i = 0; i < this._pHashByBufferSlots.length; i++) {
                    this._sHash += this._pHashByBufferSlots.value(i) + "$";
                }
            };
            AttributeBlendContainer.prototype.getHash = function () {
                return this._sHash;
            };
            return AttributeBlendContainer;
        })(VariableBlendContainer);
        fx.AttributeBlendContainer = AttributeBlendContainer;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var SamplerBlender = (function () {
            function SamplerBlender() {
                this._pSlotList = null;
                this._nActiveSlots = 0;
                this._pIdToSlotMap = null;
                this._pIdList = null;
                this._pSlotList = new Array(32);
                for(var i = 0; i < this._pSlotList.length; i++) {
                    this._pSlotList[i] = new akra.util.ObjectArray();
                }
                this._nActiveSlots = 1;
                this._pIdToSlotMap = {
                    0: 0
                };
                this._pIdList = [];
            }
            Object.defineProperty(SamplerBlender.prototype, "slots", {
                get: function () {
                    return this._pSlotList;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(SamplerBlender.prototype, "totalActiveSlots", {
                get: function () {
                    return this._nActiveSlots;
                },
                enumerable: true,
                configurable: true
            });
            SamplerBlender.prototype.getSamplersBySlot = function (iSlot) {
                return this.slots[iSlot];
            };
            SamplerBlender.prototype.clear = function () {
                for(var i = 0; i < this._nActiveSlots; i++) {
                    for(var j = 0; j < this._pSlotList[i].length; j++) {
                        var pSampler = this._pSlotList[i].value(j);
                        pSampler.setRealName(pSampler.getSemantic() || pSampler.getName());
                        pSampler.defineByZero(false);
                    }
                    this._pSlotList[i].clear(false);
                }
                this._nActiveSlots = 1;
                for(var i = 0; i < this._pIdList.length; i++) {
                    this._pIdToSlotMap[this._pIdList[i]] = -1;
                }
            };
            SamplerBlender.prototype.addTextureSlot = function (id) {
                if (!((this._pIdToSlotMap[id]) !== undefined)) {
                    this._pIdList.push(id);
                } else if (this._pIdToSlotMap[id] > 0) {
                    return;
                }
                if (this._pSlotList.length === this._nActiveSlots) {
                    this._pSlotList.push(new akra.util.ObjectArray());
                }
                this._pIdToSlotMap[id] = this._nActiveSlots;
                this._nActiveSlots++;
            };
            SamplerBlender.prototype.addObjectToSlotById = function (pObject, id) {
                this._pSlotList[this._pIdToSlotMap[id]].push(pObject);
            };
            SamplerBlender.prototype.addObjectToSlotIdAuto = function (pObject, id) {
                this.addTextureSlot(id);
                this.addObjectToSlotById(pObject, id);
            };
            SamplerBlender.prototype.getHash = function () {
                var sHash = "";
                for(var i = 0; i < this._nActiveSlots; i++) {
                    var pBlend = this._pSlotList[i];
                    if (pBlend.length > 0) {
                        if (i === 0) {
                            sHash += "Z";
                        }
                        for(var j = 0; j < pBlend.length; j++) {
                            sHash += pBlend.value(j).getGuid() + ".";
                        }
                        sHash += ".";
                    }
                }
                return sHash;
            };
            return SamplerBlender;
        })();
        fx.SamplerBlender = SamplerBlender;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    (function (EViewportTypes) {
        EViewportTypes._map = [];
        EViewportTypes.DEFAULT = -1;
        EViewportTypes.DSVIEWPORT = 1;
        EViewportTypes.SHADOWVIEWPORT = 2;
    })(akra.EViewportTypes || (akra.EViewportTypes = {}));
    var EViewportTypes = akra.EViewportTypes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ERenderDataTypes) {
        ERenderDataTypes._map = [];
        ERenderDataTypes._map[0] = "UNKNOWN";
        ERenderDataTypes.UNKNOWN = 0;
        ERenderDataTypes._map[1] = "MESH_SUBSET";
        ERenderDataTypes.MESH_SUBSET = 1;
        ERenderDataTypes._map[2] = "SCREEN";
        ERenderDataTypes.SCREEN = 2;
    })(akra.ERenderDataTypes || (akra.ERenderDataTypes = {}));
    var ERenderDataTypes = akra.ERenderDataTypes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    (function (EVertexBufferTypes) {
        EVertexBufferTypes._map = [];
        EVertexBufferTypes._map[0] = "UNKNOWN";
        EVertexBufferTypes.UNKNOWN = 0;
        EVertexBufferTypes._map[1] = "VBO";
        EVertexBufferTypes.VBO = 1;
        EVertexBufferTypes._map[2] = "TBO";
        EVertexBufferTypes.TBO = 2;
    })(akra.EVertexBufferTypes || (akra.EVertexBufferTypes = {}));
    var EVertexBufferTypes = akra.EVertexBufferTypes;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ECanvasTypes) {
        ECanvasTypes._map = [];
        ECanvasTypes.TYPE_UNKNOWN = -1;
        ECanvasTypes.TYPE_2D = 1;
        ECanvasTypes._map[2] = "TYPE_3D";
        ECanvasTypes.TYPE_3D = 2;
    })(akra.ECanvasTypes || (akra.ECanvasTypes = {}));
    var ECanvasTypes = akra.ECanvasTypes;
    ;
})(akra || (akra = {}));
;
;
var akra;
(function (akra) {
    (function (geometry) {
        var Circle = (function () {
            function Circle(fCenterX, fCenterY, fRadius) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        var pCircle = arguments[0];
                        this.center = new akra.Vec2(pCircle.center);
                        this.radius = pCircle.radius;
                        break;
                    case 2:
                        var v2fCenter = arguments[0];
                        var fRadius = arguments[1];
                        this.center = new akra.Vec2(v2fCenter);
                        this.radius = fRadius;
                        break;
                    case 3:
                        this.center = new akra.Vec2(arguments[0], arguments[1]);
                        this.radius = arguments[2];
                        break;
                    default:
                        this.center = new akra.Vec2();
                        this.radius = 0.;
                        break;
                }
            }
            Circle.prototype.set = function (fCenterX, fCenterY, fRadius) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        var pCircle = arguments[0];
                        this.center.set(pCircle.center);
                        this.radius = pCircle.radius;
                        break;
                    case 2:
                        var v2fCenter = arguments[0];
                        var fRadius = arguments[1];
                        this.center.set(v2fCenter);
                        this.radius = fRadius;
                        break;
                    case 3:
                        this.center.set(arguments[0], arguments[1]);
                        this.radius = arguments[2];
                        break;
                    default:
                        this.center.set(0.);
                        this.radius = 0.;
                }
                return this;
            };
            Circle.prototype.clear = function () {
                this.center.clear();
                this.radius = 0.;
                return this;
            };
            Circle.prototype.isEqual = function (pCircle) {
                return this.center.isEqual(pCircle.center) && (this.radius == pCircle.radius);
            };
            Circle.prototype.isClear = function () {
                return this.center.isClear() && (this.radius === 0.);
            };
            Circle.prototype.isValid = function () {
                return (this.radius >= 0.);
            };
            Circle.prototype.offset = function (v2fOffset) {
                this.center.add(v2fOffset);
                return this;
            };
            Circle.prototype.expand = function (fInc) {
                this.radius += fInc;
                return this;
            };
            Circle.prototype.normalize = function () {
                this.radius = akra.math.abs(this.radius);
                return this;
            };
            return Circle;
        })();
        geometry.Circle = Circle;        
        ;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
;
var akra;
(function (akra) {
    (function (geometry) {
        var Rect2d = (function () {
            function Rect2d(fX0, fX1, fY0, fY1) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        this.set(arguments[0]);
                        break;
                    case 2:
                        this.set(arguments[0], arguments[1]);
                        break;
                    case 4:
                        this.set(arguments[0], arguments[1], arguments[2], arguments[3]);
                        break;
                    default:
                        this.x0 = this.x1 = this.y0 = this.y1 = 0.;
                        break;
                }
            }
            Object.defineProperty(Rect2d.prototype, "left", {
                get: function () {
                    return this.x0;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Rect2d.prototype, "top", {
                get: function () {
                    return this.y0;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Rect2d.prototype, "width", {
                get: function () {
                    return this.x1 - this.x0;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Rect2d.prototype, "height", {
                get: function () {
                    return this.y1 - this.y0;
                },
                enumerable: true,
                configurable: true
            });
            Rect2d.prototype.set = function (fX0, fX1, fY0, fY1) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        if (arguments[0] instanceof Rect2d) {
                            var pRect = arguments[0];
                            this.x0 = pRect.x0;
                            this.x1 = pRect.x1;
                            this.y0 = pRect.y0;
                            this.y1 = pRect.y1;
                        } else {
                            var v2fSizes = arguments[0];
                            this.x1 = v2fSizes.x * 0.5;
                            this.x0 = -this.x1;
                            this.y1 = v2fSizes.y * 0.5;
                            this.y0 = -this.y1;
                        }
                        break;
                    case 2:
                        var fSizeX = arguments[0];
                        var fSizeY = arguments[1];
                        this.x1 = fSizeX * 0.5;
                        this.x0 = -this.x1;
                        this.y1 = fSizeY * 0.5;
                        this.y0 = -this.y1;
                        break;
                    case 4:
                        this.x0 = arguments[0];
                        this.x1 = arguments[1];
                        this.y0 = arguments[2];
                        this.y1 = arguments[3];
                        break;
                    default:
                        this.x0 = this.x1 = this.y0 = this.y1 = 0.;
                        break;
                }
                return this;
            };
            Rect2d.prototype.setFloor = function (pRect) {
                this.x0 = akra.math.floor(pRect.x0);
                this.x1 = akra.math.floor(pRect.x1);
                this.y0 = akra.math.floor(pRect.y0);
                this.y1 = akra.math.floor(pRect.y1);
                return this;
            };
            Rect2d.prototype.setCeil = function (pRect) {
                this.x0 = akra.math.ceil(pRect.x0);
                this.x1 = akra.math.ceil(pRect.x1);
                this.y0 = akra.math.ceil(pRect.y0);
                this.y1 = akra.math.ceil(pRect.y1);
                return this;
            };
            Rect2d.prototype.clear = function () {
                this.x0 = this.x1 = this.y0 = this.y1 = 0.;
                return this;
            };
            Rect2d.prototype.addSelf = function (v2fVec) {
                if ((typeof (arguments[0]) === "number")) {
                    var fValue = arguments[0];
                    this.x0 += fValue;
                    this.x1 += fValue;
                    this.y0 += fValue;
                    this.y1 += fValue;
                } else {
                    var v2fVec = arguments[0];
                    this.x0 += v2fVec.x;
                    this.x1 += v2fVec.x;
                    this.y0 += v2fVec.y;
                    this.y1 += v2fVec.y;
                }
                return this;
            };
            Rect2d.prototype.subSelf = function (v2fVec) {
                if ((typeof (arguments[0]) === "number")) {
                    var fValue = arguments[0];
                    this.x0 -= fValue;
                    this.x1 -= fValue;
                    this.y0 -= fValue;
                    this.y1 -= fValue;
                } else {
                    var v2fVec = arguments[0];
                    this.x0 -= v2fVec.x;
                    this.x1 -= v2fVec.x;
                    this.y0 -= v2fVec.y;
                    this.y1 -= v2fVec.y;
                }
                return this;
            };
            Rect2d.prototype.multSelf = function (v2fVec) {
                if ((typeof (arguments[0]) === "number")) {
                    var fValue = arguments[0];
                    this.x0 *= fValue;
                    this.x1 *= fValue;
                    this.y0 *= fValue;
                    this.y1 *= fValue;
                } else {
                    var v2fVec = arguments[0];
                    this.x0 *= v2fVec.x;
                    this.x1 *= v2fVec.x;
                    this.y0 *= v2fVec.y;
                    this.y1 *= v2fVec.y;
                }
                return this;
            };
            Rect2d.prototype.divSelf = function (v2fVec) {
                if ((typeof (arguments[0]) === "number")) {
                    var fValue = arguments[0];
 {
                        akra.logger.setSourceLocation("geometry/Rect2d.ts", 196);
                        akra.logger.assert(fValue != 0., "divide by zero error");
                    }
                    ;
                    var fInvValue = 1. / fValue;
                    this.x0 *= fInvValue;
                    this.x1 *= fInvValue;
                    this.y0 *= fInvValue;
                    this.y1 *= fInvValue;
                } else {
                    var v2fVec = arguments[0];
 {
                        akra.logger.setSourceLocation("geometry/Rect2d.ts", 208);
                        akra.logger.assert(v2fVec.x != 0., "divide by zero error");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("geometry/Rect2d.ts", 209);
                        akra.logger.assert(v2fVec.y != 0., "divide by zero error");
                    }
                    ;
                    var fInvX = 1. / v2fVec.x;
                    var fInvY = 1. / v2fVec.y;
                    this.x0 *= fInvX;
                    this.x1 *= fInvX;
                    this.y0 *= fInvY;
                    this.y1 *= fInvY;
                }
                return this;
            };
            Rect2d.prototype.offset = function (fOffsetX, fOffsetY) {
                if (arguments.length === 1) {
                    var v2fOffset = arguments[0];
                    this.x0 += v2fOffset.x;
                    this.x1 += v2fOffset.x;
                    this.y0 += v2fOffset.y;
                    this.y1 += v2fOffset.y;
                } else {
                    this.x0 += arguments[0];
                    this.x1 += arguments[0];
                    this.y0 += arguments[1];
                    this.y1 += arguments[1];
                }
                return this;
            };
            Rect2d.prototype.expand = function (fValueX, fValueY) {
                if (arguments.length == 1) {
                    if ((typeof (arguments[0]) === "number")) {
                        var fValue = arguments[0];
                        this.x0 -= fValue;
                        this.x1 += fValue;
                        this.y0 -= fValue;
                        this.y1 += fValue;
                    } else {
                        var v2fValue = arguments[0];
                        this.x0 -= v2fValue.x;
                        this.x1 += v2fValue.x;
                        this.y0 -= v2fValue.y;
                        this.y1 += v2fValue.y;
                    }
                } else {
                    this.x0 -= arguments[0];
                    this.x1 += arguments[0];
                    this.y0 -= arguments[1];
                    this.y1 += arguments[1];
                }
                return this;
            };
            Rect2d.prototype.expandX = function (fValue) {
                this.x0 -= fValue;
                this.x1 += fValue;
                return this;
            };
            Rect2d.prototype.expandY = function (fValue) {
                this.y0 -= fValue;
                this.y1 += fValue;
                return this;
            };
            Rect2d.prototype.resize = function (fSizeX, fSizeY) {
                var fSizeX, fSizeY;
                if (arguments.length == 1) {
                    var v2fSize = arguments[0];
                    fSizeX = v2fSize.x;
                    fSizeY = v2fSize.y;
                } else {
                    fSizeX = arguments[0];
                    fSizeY = arguments[1];
                }
                this.x1 = (this.x0 + this.x1 + fSizeX) * 0.5;
                this.x0 = this.x1 - fSizeX;
                this.y1 = (this.y0 + this.y1 + fSizeY) * 0.5;
                this.y0 = this.y1 - fSizeY;
                return this;
            };
            Rect2d.prototype.resizeX = function (fSize) {
                this.x1 = (this.x0 + this.x1 + fSize) * 0.5;
                this.x0 = this.x1 - fSize;
                return this;
            };
            Rect2d.prototype.resizeY = function (fSize) {
                this.y1 = (this.y0 + this.y1 + fSize) * 0.5;
                this.y0 = this.y1 - fSize;
                return this;
            };
            Rect2d.prototype.resizeMax = function (fSpanX, fSpanY) {
                if (arguments.length == 1) {
                    var v2fSpan = arguments[0];
                    this.x1 = this.x0 + v2fSpan.x;
                    this.y1 = this.y0 + v2fSpan.y;
                } else {
                    this.x1 = this.x0 + arguments[0];
                    this.y1 = this.y0 + arguments[1];
                }
                return this;
            };
            Rect2d.prototype.resizeMaxX = function (fSpan) {
                this.x1 = this.x0 + fSpan;
                return this;
            };
            Rect2d.prototype.resizeMaxY = function (fSpan) {
                this.y1 = this.y0 + fSpan;
                return this;
            };
            Rect2d.prototype.resizeMin = function (fSpanX, fSpanY) {
                if (arguments.length == 1) {
                    var v2fSpan = arguments[0];
                    this.x0 = this.x1 - v2fSpan.x;
                    this.y0 = this.y1 - v2fSpan.y;
                } else {
                    this.x0 = this.x1 - arguments[0];
                    this.y0 = this.y1 - arguments[1];
                }
                return this;
            };
            Rect2d.prototype.resizeMinX = function (fSpan) {
                this.x0 = this.x1 - fSpan;
                return this;
            };
            Rect2d.prototype.resizeMinY = function (fSpan) {
                this.y0 = this.y1 - fSpan;
                return this;
            };
            Rect2d.prototype.unionPoint = function (fX, fY) {
                if (arguments.length == 1) {
                    var v2fPoint = arguments[0];
                    this.x0 = akra.math.min(this.x0, v2fPoint.x);
                    this.x1 = akra.math.max(this.x1, v2fPoint.x);
                    this.y0 = akra.math.min(this.y0, v2fPoint.y);
                    this.y1 = akra.math.max(this.y1, v2fPoint.y);
                } else {
                    var fX = arguments[0];
                    var fY = arguments[1];
                    this.x0 = akra.math.min(this.x0, fX);
                    this.x1 = akra.math.max(this.x1, fX);
                    this.y0 = akra.math.min(this.y0, fY);
                    this.y1 = akra.math.max(this.y1, fY);
                }
                return this;
            };
            Rect2d.prototype.unionRect = function (pRect) {
                this.normalize();
                pRect.normalize();
                this.x0 = akra.math.min(this.x0, pRect.x0);
                this.x1 = akra.math.max(this.x1, pRect.x1);
                this.y0 = akra.math.min(this.y0, pRect.y0);
                this.y1 = akra.math.max(this.y1, pRect.y1);
                return this;
            };
            Rect2d.prototype.negate = function (pDestination) {
                if (!((pDestination) !== undefined)) {
                    pDestination = this;
                }
                return pDestination.set(-this.x1, -this.x0, -this.y1, -this.y0);
            };
            Rect2d.prototype.normalize = function () {
                var fTmp;
                if (this.x0 > this.x1) {
                    fTmp = this.x0;
                    this.x0 = this.x1;
                    this.x1 = fTmp;
                }
                if (this.y0 > this.y1) {
                    fTmp = this.y0;
                    this.y0 = this.y1;
                    this.y1 = fTmp;
                }
                return this;
            };
            Rect2d.prototype.isEqual = function (pRect) {
                return this.x0 == pRect.x0 && this.x1 == pRect.x1 && this.y0 == pRect.y0 && this.y1 == pRect.y1;
            };
            Rect2d.prototype.isClear = function () {
                return this.x0 == 0. && this.x1 == 0. && this.y0 == 0. && this.y1 == 0.;
            };
            Rect2d.prototype.isValid = function () {
                return this.x0 <= this.x1 && this.y0 <= this.y1;
            };
            Rect2d.prototype.isPointInRect = function (v2fPoint) {
                var x = v2fPoint.x;
                var y = v2fPoint.y;
                return (this.x0 <= x && x <= this.x1) && (this.y0 <= y && y <= this.y1);
            };
            Rect2d.prototype.midPoint = function (v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = new akra.Vec2();
                }
                v2fDestination.x = (this.x0 + this.x1) * 0.5;
                v2fDestination.y = (this.y0 + this.y1) * 0.5;
                return v2fDestination;
            };
            Rect2d.prototype.midX = function () {
                return (this.x0 + this.x1) * 0.5;
            };
            Rect2d.prototype.midY = function () {
                return (this.y0 + this.y1) * 0.5;
            };
            Rect2d.prototype.size = function (v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = new akra.Vec2();
                }
                v2fDestination.x = this.x1 - this.x0;
                v2fDestination.y = this.y1 - this.y0;
                return v2fDestination;
            };
            Rect2d.prototype.sizeX = function () {
                return this.x1 - this.x0;
            };
            Rect2d.prototype.sizeY = function () {
                return this.y1 - this.y0;
            };
            Rect2d.prototype.minPoint = function (v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = new akra.Vec2();
                }
                v2fDestination.x = this.x0;
                v2fDestination.y = this.y0;
                return v2fDestination;
            };
            Rect2d.prototype.maxPoint = function (v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = new akra.Vec2();
                }
                v2fDestination.x = this.x1;
                v2fDestination.y = this.y1;
                return v2fDestination;
            };
            Rect2d.prototype.area = function () {
                return (this.x1 - this.x0) * (this.y1 - this.y0);
            };
            Rect2d.prototype.corner = function (iIndex, v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = new akra.Vec2();
                }
 {
                    akra.logger.setSourceLocation("geometry/Rect2d.ts", 547);
                    akra.logger.assert(0 <= iIndex && iIndex < 4, "invalid index");
                }
                ;
                switch(iIndex) {
                    case 0:
                        v2fDestination.set(this.x0, this.y0);
                        break;
                    case 1:
                        v2fDestination.set(this.x1, this.y0);
                        break;
                    case 2:
                        v2fDestination.set(this.x1, this.y1);
                        break;
                    case 3:
                        v2fDestination.set(this.x0, this.y1);
                        break;
                }
                ;
                return v2fDestination;
            };
            Rect2d.prototype.createBoundingCircle = function (pCircle) {
                if (!((pCircle) !== undefined)) {
                    pCircle = new geometry.Circle();
                }
                var fX0 = this.x0, fX1 = this.x1;
                var fY0 = this.y0, fY1 = this.y1;
                var fHalfSizeX = (fX1 - fX0) * 0.5;
                var fHalfSizeY = (fY1 - fY0) * 0.5;
                pCircle.set((fX0 + fX1) * 0.5, (fY0 + fY1) * 0.5, akra.math.sqrt(fHalfSizeX * fHalfSizeX + fHalfSizeY * fHalfSizeY));
                return pCircle;
            };
            Rect2d.prototype.toString = function () {
                return "(" + this.x0 + ", " + this.y0 + ") --> (" + this.x1 + ", " + this.y1 + ")";
            };
            return Rect2d;
        })();
        geometry.Rect2d = Rect2d;        
        ;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        var ObjectArray = (function () {
            function ObjectArray(pElements) {
                this._pData = [];
                this._bLock = false;
                this._iLength = 0;
                if (arguments.length) {
                    this.fromArray(pElements);
                }
            }
            Object.defineProperty(ObjectArray.prototype, "length", {
                get: function () {
                    return this._iLength;
                },
                enumerable: true,
                configurable: true
            });
            ObjectArray.prototype.lock = function () {
                this._bLock = true;
            };
            ObjectArray.prototype.unlock = function () {
                this._bLock = false;
            };
            ObjectArray.prototype.isLocked = function () {
                return this._bLock;
            };
            ObjectArray.prototype.clear = function (bRemoveLinks) {
                if (typeof bRemoveLinks === "undefined") { bRemoveLinks = false; }
 {
                    util.logger.setSourceLocation("util/ObjectArray.ts", 47);
                    util.logger.assert(!this._bLock, "cannot clear. array is locked.");
                }
                ;
                this._iLength = 0;
                if (bRemoveLinks) {
                    for(var i = 0; i < this._pData.length; ++i) {
                        this._pData[i] = null;
                    }
                }
                return this;
            };
            ObjectArray.prototype.release = function () {
                this.clear(true);
                this._pData.clear();
                return this;
            };
            ObjectArray.prototype.value = function (n) {
                return this._pData[n];
            };
            ObjectArray.prototype.extend = function (n) {
                if (this._pData.length < n) {
                    for(var i = this._pData.length; i < n; ++i) {
                        this._pData[i] = null;
                    }
                }
            };
            ObjectArray.prototype.set = function (n, pData) {
 {
                    util.logger.setSourceLocation("util/ObjectArray.ts", 80);
                    util.logger.assert(!this._bLock, "cannot clear. array is locked.");
                }
                ;
                var N = n + 1;
                this.extend(N);
                if (this._iLength < N) {
                    this._iLength = N;
                }
                this._pData[n] = pData;
                return this;
            };
            ObjectArray.prototype.fromArray = function (pElements, iOffset, iSize) {
                if (typeof iOffset === "undefined") { iOffset = 0; }
                if (typeof iSize === "undefined") { iSize = 0; }
 {
                    util.logger.setSourceLocation("util/ObjectArray.ts", 96);
                    util.logger.assert(!this._bLock, "cannot clear. array is locked.");
                }
                ;
                iSize = iSize > 0 ? iSize < pElements.length ? iSize : pElements.length : pElements.length;
                this.extend(iSize);
                for(var i = iOffset, j = 0; i < iSize; ++i, ++j) {
                    this._pData[i] = pElements[j];
                }
                this._iLength = i;
                return this;
            };
            ObjectArray.prototype.push = function (pElement) {
 {
                    util.logger.setSourceLocation("util/ObjectArray.ts", 113);
                    util.logger.assert(!this._bLock, "cannot clear. array is locked.");
                }
                ;
                return this.set(this._iLength, pElement);
            };
            ObjectArray.prototype.pop = function () {
 {
                    util.logger.setSourceLocation("util/ObjectArray.ts", 119);
                    util.logger.assert(!this._bLock, "cannot clear. array is locked.");
                }
                ;
                return this._iLength > 0 ? this._pData[--this._iLength] : null;
            };
            ObjectArray.prototype.swap = function (i, j) {
 {
                    util.logger.setSourceLocation("util/ObjectArray.ts", 124);
                    util.logger.assert(!this._bLock, "cannot clear. array is locked.");
                }
                ;
 {
                    util.logger.setSourceLocation("util/ObjectArray.ts", 125);
                    util.logger.assert(i < this._iLength && j < this._iLength, "invalid swap index.");
                }
                ;
                this._pData.swap(i, j);
                return this;
            };
            ObjectArray.prototype.takeAt = function (iPos) {
                var pValue = this.value(iPos);
                for(var i = iPos + 1, j = iPos; i < this.length; ++i, ++j) {
                    this._pData[j] = this._pData[i];
                }
                this._iLength--;
                return pValue;
            };
            ObjectArray.prototype.indexOf = function (pObject) {
                for(var i = 0; i < this._iLength; i++) {
                    if (pObject === this._pData[i]) {
                        return i;
                    }
                }
                return -1;
            };
            return ObjectArray;
        })();
        util.ObjectArray = ObjectArray;        
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    akra.ObjectArray = akra.util.ObjectArray;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var Viewport = (function () {
            function Viewport(pCamera, pTarget, csRenderMethod, fLeft, fTop, fWidth, fHeight, iZIndex) {
                if (typeof csRenderMethod === "undefined") { csRenderMethod = null; }
                if (typeof fLeft === "undefined") { fLeft = 0.; }
                if (typeof fTop === "undefined") { fTop = 0.; }
                if (typeof fWidth === "undefined") { fWidth = 1.; }
                if (typeof fHeight === "undefined") { fHeight = 1.; }
                if (typeof iZIndex === "undefined") { iZIndex = 0; }
                this._pViewportState = {
                    cullingMode: akra.ECullingMode.NONE,
                    depthTest: true,
                    depthWrite: true,
                    depthFunction: akra.ECompareFunction.LESS,
                    clearColor: new akra.Color(0., 0., 0., 0.),
                    clearDepth: 1.,
                    clearBuffers: akra.EFrameBufferTypes.COLOR | akra.EFrameBufferTypes.DEPTH
                };
                this._bClearEveryFrame = true;
                this._bNewFrame = false;
                this._bUpdated = false;
                this._iVisibilityMask = 0xFFFFFFFF;
                this.sMaterialSchemeName = akra.DEFAULT_MATERIAL_NAME;
                this._isAutoUpdated = true;
                this._csDefaultRenderMethod = null;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._pTarget = pTarget;
                this._fRelLeft = fLeft;
                this._fRelTop = fTop;
                this._fRelWidth = fWidth;
                this._fRelHeight = fHeight;
                this._iZIndex = iZIndex;
                this._csDefaultRenderMethod = csRenderMethod;
                this._updateDimensions();
                this._setCamera(pCamera);
                this.connect(pTarget, "resized", "_updateDimensions");
            }
            Object.defineProperty(Viewport.prototype, "zIndex", {
                get: function () {
                    return this._iZIndex;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Viewport.prototype, "left", {
                get: function () {
                    return this._fRelLeft;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Viewport.prototype, "top", {
                get: function () {
                    return this._fRelTop;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Viewport.prototype, "width", {
                get: function () {
                    return this._fRelWidth;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Viewport.prototype, "height", {
                get: function () {
                    return this._fRelHeight;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Viewport.prototype, "actualLeft", {
                get: function () {
                    return this._iActLeft;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Viewport.prototype, "actualTop", {
                get: function () {
                    return this._iActTop;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Viewport.prototype, "actualWidth", {
                get: function () {
                    return this._iActWidth;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Viewport.prototype, "actualHeight", {
                get: function () {
                    return this._iActHeight;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Viewport.prototype, "backgroundColor", {
                get: function () {
                    return this._pViewportState.clearColor;
                },
                set: function (cColor) {
                    this._pViewportState.clearColor.set(cColor);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Viewport.prototype, "depthClear", {
                get: function () {
                    return this._pViewportState.clearDepth;
                },
                set: function (fDepthClearValue) {
                    this._pViewportState.clearDepth = fDepthClearValue;
                },
                enumerable: true,
                configurable: true
            });
            Viewport.prototype.destroy = function () {
                var pRenderer = this._pTarget.getRenderer();
                if (pRenderer && pRenderer._getViewport() === this) {
                    pRenderer._setViewport(null);
                }
            };
            Viewport.prototype.newFrame = function () {
                this._bNewFrame = true;
            };
            Viewport.prototype.clear = function (iBuffers, cColor, fDepth, iStencil) {
                if (typeof iBuffers === "undefined") { iBuffers = akra.EFrameBufferTypes.COLOR | akra.EFrameBufferTypes.DEPTH; }
                if (typeof cColor === "undefined") { cColor = akra.Color.BLACK; }
                if (typeof fDepth === "undefined") { fDepth = 1.; }
                if (typeof iStencil === "undefined") { iStencil = 0; }
                var pRenderer = this._pTarget.getRenderer();
                if (pRenderer) {
                    var pCurrentViewport = pRenderer._getViewport();
                    if (pCurrentViewport && pCurrentViewport === this) {
                        pRenderer.clearFrameBuffer(iBuffers, cColor, fDepth, iStencil);
                    } else if (pCurrentViewport) {
                        pRenderer._setViewport(this);
                        pRenderer.clearFrameBuffer(iBuffers, cColor, fDepth, iStencil);
                        pRenderer._setViewport(pCurrentViewport);
                    }
                }
            };
            Viewport.prototype.getTarget = function () {
                return this._pTarget;
            };
            Viewport.prototype.getCamera = function () {
                return this._pCamera;
            };
            Viewport.prototype.setCamera = function (pCamera) {
                if (this._pCamera) {
                    if (this._pCamera._getLastViewport() == this) {
                        this._pCamera._keepLastViewport(null);
                    }
                }
                if (this._pCamera) {
                    if (!pCamera.isConstantAspect()) {
                        pCamera.aspect = (this._iActWidth / this._iActHeight);
                    }
                }
                this._setCamera(pCamera);
                this.viewportCameraChanged();
                return true;
            };
            Viewport.prototype._setCamera = function (pCamera) {
                this._pCamera = pCamera;
                if (pCamera) {
                    pCamera._keepLastViewport(this);
                }
            };
            Viewport.prototype.setDimensions = function (fLeft, fTop, fWidth, fHeight) {
                var pRect;
                if ((typeof (arguments[0]) === "number")) {
                    this._fRelLeft = fLeft;
                    this._fRelTop = fTop;
                    this._fRelWidth = fWidth;
                    this._fRelHeight = fHeight;
                } else {
                    pRect = arguments[0];
                    this._fRelLeft = pRect.left;
                    this._fRelTop = pRect.top;
                    this._fRelWidth = pRect.width;
                    this._fRelHeight = pRect.height;
                }
                this._updateDimensions();
                return true;
            };
            Viewport.prototype.getActualDimensions = function () {
                return new akra.geometry.Rect2d(this._iActLeft, this._iActTop, this._iActWidth, this._iActHeight);
            };
            Viewport.prototype.setClearEveryFrame = function (isClear, iBuffers) {
                if (typeof iBuffers === "undefined") { iBuffers = akra.EFrameBufferTypes.COLOR | akra.EFrameBufferTypes.DEPTH; }
                this._bClearEveryFrame = isClear;
                this._pViewportState.clearBuffers = iBuffers;
            };
            Viewport.prototype.getClearEveryFrame = function () {
                return this._bClearEveryFrame;
            };
            Viewport.prototype.getClearBuffers = function () {
                return this._pViewportState.clearBuffers;
            };
            Viewport.prototype.setDepthParams = function (bDepthTest, bDepthWrite, eDepthFunction) {
                this._pViewportState.depthTest = bDepthTest;
                this._pViewportState.depthWrite = bDepthWrite;
                this._pViewportState.depthFunction = eDepthFunction;
            };
            Viewport.prototype.setCullingMode = function (eCullingMode) {
                this._pViewportState.cullingMode = eCullingMode;
            };
            Viewport.prototype.setAutoUpdated = function (bValue) {
                if (typeof bValue === "undefined") { bValue = true; }
                this._isAutoUpdated = bValue;
            };
            Viewport.prototype.isAutoUpdated = function () {
                return this._isAutoUpdated;
            };
            Viewport.prototype._updateDimensions = function () {
                var fHeight = this._pTarget.height;
                var fWidth = this._pTarget.width;
                this._iActLeft = (this._fRelLeft * fWidth);
                this._iActTop = (this._fRelTop * fHeight);
                this._iActWidth = (this._fRelWidth * fWidth);
                this._iActHeight = (this._fRelHeight * fHeight);
                if (this._pCamera) {
                    if (!this._pCamera.isConstantAspect()) {
                        this._pCamera.aspect = (this._iActWidth / this._iActHeight);
                    }
                }
                this._bUpdated = true;
                this.viewportDimensionsChanged();
            };
            Viewport.prototype.update = function () {
                if (this._bClearEveryFrame) {
                    this.clear(this._pViewportState.clearBuffers, this._pViewportState.clearColor, this._pViewportState.clearDepth);
                }
                this._updateImpl();
                this.getTarget().getRenderer().executeQueue();
            };
            Viewport.prototype._updateImpl = function () {
                if (this._pCamera) {
                    this.renderAsNormal(this._csDefaultRenderMethod, this._pCamera);
                }
            };
            Viewport.prototype.renderAsNormal = function (csMethod, pCamera) {
                var pVisibleObjects = pCamera.display();
                var pRenderable;
                for(var i = 0; i < pVisibleObjects.length; ++i) {
                    pVisibleObjects.value(i).prepareForRender(this);
                }
                for(var i = 0; i < pVisibleObjects.length; ++i) {
                    var pSceneObject = pVisibleObjects.value(i);
                    for(var j = 0; j < pSceneObject.totalRenderable; j++) {
                        pRenderable = pSceneObject.getRenderable(j);
                        if (!((pRenderable) === null)) {
                            pRenderable.render(this, csMethod, pSceneObject);
                        }
                    }
                }
            };
            Viewport.prototype.isUpdated = function () {
                return this._bUpdated;
            };
            Viewport.prototype._clearUpdatedFlag = function () {
                this._bUpdated = false;
            };
            Viewport.prototype._getNumRenderedPolygons = function () {
                return this._pCamera ? this._pCamera._getNumRenderedFaces() : 0;
            };
            Viewport.prototype._getViewportState = function () {
                return this._pViewportState;
            };
            Viewport.prototype.getGuid = function () {
                return this._iGuid;
            };
            Viewport._pEventTable = new akra.events.EventTable();
            Viewport.prototype.getEventTable = function () {
                return Viewport._pEventTable;
            };
            Viewport.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Viewport.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Viewport.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Viewport.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Viewport.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            Viewport.prototype.viewportDimensionsChanged = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).viewportDimensionsChanged;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            Viewport.prototype.viewportCameraChanged = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).viewportCameraChanged;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            return Viewport;
        })();
        render.Viewport = Viewport;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var LightData = (function () {
            function LightData() {
                this.DIFFUSE = new akra.Vec4();
                this.AMBIENT = new akra.Vec4();
                this.SPECULAR = new akra.Vec4();
                this.POSITION = new akra.Vec3();
                this.ATTENUATION = new akra.Vec3();
            }
            LightData.prototype.set = function (pLightParam, v3fPosition) {
                this.DIFFUSE.set(pLightParam.diffuse);
                this.AMBIENT.set(pLightParam.ambient);
                this.SPECULAR.set(pLightParam.specular);
                this.ATTENUATION.set(pLightParam.attenuation);
                this.POSITION.set(v3fPosition);
                return this;
            };
            return LightData;
        })();
        render.LightData = LightData;        
        ;
        var UniformOmni = (function () {
            function UniformOmni() {
                this.LIGHT_DATA = new LightData();
            }
            UniformOmni.prototype.setLightData = function (pLightParam, v3fPosition) {
                this.LIGHT_DATA.set(pLightParam, v3fPosition);
                return this;
            };
            Object.defineProperty(UniformOmni, "stackCeil", {
                get: function () {
                    UniformOmni.stackPosition = UniformOmni.stackPosition === UniformOmni.stackSize - 1 ? 0 : UniformOmni.stackPosition;
                    return UniformOmni.stack[UniformOmni.stackPosition++];
                },
                enumerable: true,
                configurable: true
            });
            UniformOmni.stackSize = 200;
            UniformOmni.stackPosition = 0;
            UniformOmni.stack = (function () {
                var pStack = new Array(UniformOmni.stackSize);
                for(var i = 0; i < UniformOmni.stackSize; i++) {
                    pStack[i] = new UniformOmni();
                }
                return pStack;
            })();
            return UniformOmni;
        })();
        render.UniformOmni = UniformOmni;        
        ;
        var UniformProject = (function () {
            function UniformProject() {
                this.LIGHT_DATA = new LightData();
                this.SHADOW_MATRIX = new akra.Mat4();
            }
            UniformProject.prototype.setLightData = function (pLightParam, v3fPosition) {
                this.LIGHT_DATA.set(pLightParam, v3fPosition);
                return this;
            };
            UniformProject.prototype.setMatrix = function (m4fMatrix) {
                this.SHADOW_MATRIX.set(m4fMatrix);
                return this;
            };
            Object.defineProperty(UniformProject, "stackCeil", {
                get: function () {
                    UniformProject.stackPosition = UniformProject.stackPosition === UniformProject.stackSize - 1 ? 0 : UniformProject.stackPosition;
                    return UniformProject.stack[UniformProject.stackPosition++];
                },
                enumerable: true,
                configurable: true
            });
            UniformProject.stackSize = 200;
            UniformProject.stackPosition = 0;
            UniformProject.stack = (function () {
                var pStack = new Array(UniformProject.stackSize);
                for(var i = 0; i < UniformProject.stackSize; i++) {
                    pStack[i] = new UniformProject();
                }
                return pStack;
            })();
            return UniformProject;
        })();
        render.UniformProject = UniformProject;        
        ;
        var UniformProjectShadow = (function () {
            function UniformProjectShadow() {
                this.LIGHT_DATA = new LightData();
                this.TO_LIGHT_SPACE = new akra.Mat4();
                this.REAL_PROJECTION_MATRIX = new akra.Mat4();
                this.OPTIMIZED_PROJECTION_MATRIX = new akra.Mat4();
                this.SHADOW_SAMPLER = akra.fx.createSamplerState();
            }
            UniformProjectShadow.prototype.setLightData = function (pLightParam, v3fPosition) {
                this.LIGHT_DATA.set(pLightParam, v3fPosition);
                return this;
            };
            UniformProjectShadow.prototype.setMatrix = function (m4fToLightSpace, m4fRealProj, m4fOptimizedProj) {
                this.TO_LIGHT_SPACE.set(m4fToLightSpace);
                this.REAL_PROJECTION_MATRIX.set(m4fRealProj);
                this.OPTIMIZED_PROJECTION_MATRIX.set(m4fOptimizedProj);
                return this;
            };
            UniformProjectShadow.prototype.setSampler = function (sTexture) {
                this.SHADOW_SAMPLER.textureName = sTexture;
                return this;
            };
            Object.defineProperty(UniformProjectShadow, "stackCeil", {
                get: function () {
                    UniformProjectShadow.stackPosition = UniformProjectShadow.stackPosition === UniformProjectShadow.stackSize - 1 ? 0 : UniformProjectShadow.stackPosition;
                    return UniformProjectShadow.stack[UniformProjectShadow.stackPosition++];
                },
                enumerable: true,
                configurable: true
            });
            UniformProjectShadow.stackSize = 20;
            UniformProjectShadow.stackPosition = 0;
            UniformProjectShadow.stack = (function () {
                var pStack = new Array(UniformProjectShadow.stackSize);
                for(var i = 0; i < UniformProjectShadow.stackSize; i++) {
                    pStack[i] = new UniformProjectShadow();
                }
                return pStack;
            })();
            return UniformProjectShadow;
        })();
        render.UniformProjectShadow = UniformProjectShadow;        
        var UniformOmniShadow = (function () {
            function UniformOmniShadow() {
                this.LIGHT_DATA = new LightData();
                this.TO_LIGHT_SPACE = [
                    new akra.Mat4(), 
                    new akra.Mat4(), 
                    new akra.Mat4(), 
                    new akra.Mat4(), 
                    new akra.Mat4(), 
                    new akra.Mat4()
                ];
                this.OPTIMIZED_PROJECTION_MATRIX = [
                    new akra.Mat4(), 
                    new akra.Mat4(), 
                    new akra.Mat4(), 
                    new akra.Mat4(), 
                    new akra.Mat4(), 
                    new akra.Mat4()
                ];
                this.SHADOW_SAMPLER = [
                    akra.fx.createSamplerState(), 
                    akra.fx.createSamplerState(), 
                    akra.fx.createSamplerState(), 
                    akra.fx.createSamplerState(), 
                    akra.fx.createSamplerState(), 
                    akra.fx.createSamplerState()
                ];
            }
            UniformOmniShadow.prototype.setLightData = function (pLightParam, v3fPosition) {
                this.LIGHT_DATA.set(pLightParam, v3fPosition);
                return this;
            };
            UniformOmniShadow.prototype.setMatrix = function (m4fToLightSpace, m4fOptimizedProj, index) {
                this.TO_LIGHT_SPACE[index].set(m4fToLightSpace);
                this.OPTIMIZED_PROJECTION_MATRIX[index].set(m4fOptimizedProj);
                return this;
            };
            UniformOmniShadow.prototype.setSampler = function (sTexture, index) {
                this.SHADOW_SAMPLER[index].textureName = sTexture;
                return this;
            };
            Object.defineProperty(UniformOmniShadow, "stackCeil", {
                get: function () {
                    UniformOmniShadow.stackPosition = UniformOmniShadow.stackPosition === UniformOmniShadow.stackSize - 1 ? 0 : UniformOmniShadow.stackPosition;
                    return UniformOmniShadow.stack[UniformOmniShadow.stackPosition++];
                },
                enumerable: true,
                configurable: true
            });
            UniformOmniShadow.stackSize = 3;
            UniformOmniShadow.stackPosition = 0;
            UniformOmniShadow.stack = (function () {
                var pStack = new Array(UniformOmniShadow.stackSize);
                for(var i = 0; i < UniformOmniShadow.stackSize; i++) {
                    pStack[i] = new UniformOmniShadow();
                }
                return pStack;
            })();
            return UniformOmniShadow;
        })();
        render.UniformOmniShadow = UniformOmniShadow;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var RenderPass = (function () {
            function RenderPass(pTechnique, iPass) {
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pTechnique = null;
                this._pRenderTarget = null;
                this._iPassNumber = 0;
                this._pInput = null;
                this._isActive = true;
                this._pTechnique = pTechnique;
                this._iPassNumber = iPass;
            }
            RenderPass.prototype.getGuid = function () {
                return this._iGuid;
            };
            RenderPass.prototype.setForeign = function (sName, fValue) {
                this._pInput.setForeign(sName, fValue);
            };
            RenderPass.prototype.setTexture = function (sName, pTexture) {
                this._pInput.setTexture(sName, pTexture);
            };
            RenderPass.prototype.setUniform = function (sName, pValue) {
                this._pInput.setUniform(sName, pValue);
            };
            RenderPass.prototype.setStruct = function (sName, pValue) {
                this._pInput.setStruct(sName, pValue);
            };
            RenderPass.prototype.setSamplerTexture = function (sName, pTexture) {
                this._pInput.setSamplerTexture(sName, pTexture);
            };
            RenderPass.prototype.getRenderTarget = function () {
                return this._pRenderTarget;
            };
            RenderPass.prototype.setRenderTarget = function (pTarget) {
                this._pRenderTarget = pTarget;
            };
            RenderPass.prototype.getPassInput = function () {
                return this._pInput;
            };
            RenderPass.prototype.setPassInput = function (pInput, isNeedRelocate) {
                if (isNeedRelocate) {
                    this.relocateOldInput(pInput);
                }
                if (!((this._pInput) === null)) {
                    this._pInput._release();
                }
                this._pInput = pInput;
            };
            RenderPass.prototype.blend = function (sComponentName, iPass) {
                return this._pTechnique.addComponent(sComponentName, this._iPassNumber, iPass);
            };
            RenderPass.prototype.activate = function () {
                this._isActive = true;
            };
            RenderPass.prototype.deactivate = function () {
                this._isActive = false;
            };
            RenderPass.prototype.isActive = function () {
                return this._isActive;
            };
            RenderPass.prototype.relocateOldInput = function (pNewInput) {
            };
            return RenderPass;
        })();
        render.RenderPass = RenderPass;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var RenderTechnique = (function () {
            function RenderTechnique(pMethod) {
                if (typeof pMethod === "undefined") { pMethod = null; }
                this._pMethod = null;
                this._isFreeze = false;
                this._pComposer = null;
                this._pPassList = null;
                this._pPassBlackList = null;
                this._iCurrentPass = 0;
                this._pCurrentPass = null;
                this._iGlobalPostEffectsStart = 0;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._pPassList = [];
                this._pPassBlackList = [];
                if (!((pMethod) === null)) {
                    this.setMethod(pMethod);
                }
            }
            Object.defineProperty(RenderTechnique.prototype, "modified", {
                get: function () {
                    return this.getGuid();
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderTechnique.prototype, "totalPasses", {
                get: function () {
                    return this._pComposer.getTotalPassesForTechnique(this);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderTechnique.prototype, "data", {
                get: function () {
                    return null;
                },
                enumerable: true,
                configurable: true
            });
            RenderTechnique.prototype.destroy = function () {
            };
            RenderTechnique.prototype.getPass = function (iPass) {
                this._pComposer.prepareTechniqueBlend(this);
                return this._pPassList[iPass];
            };
            RenderTechnique.prototype.getMethod = function () {
                return this._pMethod;
            };
            RenderTechnique.prototype.setMethod = function (pMethod) {
                if (!((this._pMethod) === null)) {
                    this.disconnect(this._pMethod, "altered", "_updateMethod", akra.EEventTypes.BROADCAST);
                }
                this._pMethod = pMethod;
                if (!((pMethod) === null)) {
                    var pComposer = pMethod.manager.getEngine().getComposer();
                    this._setComposer(pComposer);
                    this.connect(pMethod, "altered", "_updateMethod", akra.EEventTypes.BROADCAST);
                }
                this.informComposer();
            };
            RenderTechnique.prototype.setState = function (sName, pValue) {
            };
            RenderTechnique.prototype.setForeign = function (sName, pValue) {
            };
            RenderTechnique.prototype.setStruct = function (sName, pValue) {
            };
            RenderTechnique.prototype.setTextureBySemantics = function (sName, pValue) {
            };
            RenderTechnique.prototype.setShadowSamplerArray = function (sName, pValue) {
            };
            RenderTechnique.prototype.setVec2BySemantic = function (sName, pValue) {
            };
            RenderTechnique.prototype.isReady = function () {
                return this._pMethod.isResourceLoaded() && !this._pMethod.isResourceDisabled();
            };
            RenderTechnique.prototype.addComponent = function (pComponent, iShift, iPass, isSet) {
                if (typeof iShift === "undefined") { iShift = 0; }
                if (typeof iPass === "undefined") { iPass = 0xffffff; }
                if (typeof isSet === "undefined") { isSet = true; }
                if (((this._pComposer) === null)) {
                    return false;
                }
                var pComponentPool = this._pComposer.getEngine().getResourceManager().componentPool;
                if ((typeof (pComponent) === "number")) {
                    pComponent = pComponentPool.getResource(pComponent);
                } else if ((typeof (pComponent) === "string")) {
                    pComponent = pComponentPool.findResource(pComponent);
                }
                if (!((pComponent) !== undefined) || ((pComponent) === null)) {
 {
                        akra.logger.setSourceLocation("RenderTechnique.ts", 120);
                        akra.logger.error("Bad component for add/delete.");
                    }
                    ;
                    return false;
                }
                if (isSet) {
                    if (!this._pComposer.addOwnComponentToTechnique(this, pComponent, iShift, iPass)) {
 {
                            akra.logger.setSourceLocation("RenderTechnique.ts", 126);
                            akra.logger.error("Can not add component '" + pComponent.findResourceName() + "'");
                        }
                        ;
                        return false;
                    }
                } else {
                    if (!this._pComposer.removeOwnComponentToTechnique(this, pComponent, iShift, iPass)) {
 {
                            akra.logger.setSourceLocation("RenderTechnique.ts", 132);
                            akra.logger.error("Can not delete component '" + pComponent.findResourceName() + "'");
                        }
                        ;
                        return false;
                    }
                }
                return true;
            };
            RenderTechnique.prototype.delComponent = function (pComponent, iShift, iPass) {
                if (typeof iShift === "undefined") { iShift = 0; }
                if (typeof iPass === "undefined") { iPass = 0xffffff; }
                return this.addComponent(pComponent, iShift, iPass, false);
            };
            RenderTechnique.prototype.hasComponent = function (sComponent, iShift, iPass) {
                if (((this._pComposer) === null)) {
                    return false;
                }
                var pComponentPool = this._pComposer.getEngine().getResourceManager().componentPool;
                var pComponent = null;
                pComponent = pComponentPool.findResource(sComponent);
                return this._pComposer.hasOwnComponentInTechnique(this, pComponent, iShift, iPass);
            };
            RenderTechnique.prototype.hasGlobalPostEffect = function () {
                return this._iGlobalPostEffectsStart > 0;
            };
            RenderTechnique.prototype.isPostEffectPass = function (iPass) {
                return this._iGlobalPostEffectsStart <= iPass;
            };
            RenderTechnique.prototype.isLastPass = function (iPass) {
                var iMaxPass = this.totalPasses - 1;
                if (iMaxPass === iPass) {
                    return true;
                }
                if (!this._pPassBlackList[iMaxPass]) {
                    return false;
                }
                for(var i = this._pPassBlackList.length - 2; i >= 0; i--) {
                    if (!this._pPassBlackList[i]) {
                        if (i !== iPass) {
                            return false;
                        } else {
                            return true;
                        }
                    }
                }
                return false;
            };
            RenderTechnique.prototype.isFirstPass = function (iPass) {
                if (iPass === 0) {
                    return true;
                }
                if (!this._pPassBlackList[0]) {
                    return false;
                }
                for(var i = 1; i < this._pPassBlackList.length; i++) {
                    if (!this._pPassBlackList[i]) {
                        if (i !== iPass) {
                            return false;
                        } else {
                            return true;
                        }
                    }
                }
                return false;
            };
            RenderTechnique.prototype.isFreeze = function () {
                return this._isFreeze;
            };
            RenderTechnique.prototype.updatePasses = function (bSaveOldUniformValue) {
                this._isFreeze = true;
                var iTotalPasses = this.totalPasses;
                for(var i = this._pPassList.length; i < iTotalPasses; i++) {
                    if (!((this._pPassBlackList[i]) !== undefined) || this._pPassBlackList[i] === false) {
                        this._pPassList[i] = new render.RenderPass(this, i);
                        this._pPassBlackList[i] = false;
                    }
                }
                for(var i = 0; i < iTotalPasses; i++) {
                    if (!this._pPassBlackList[i]) {
                        var pInput = this._pComposer.getPassInputBlend(this, i);
                        if (!((pInput) === null)) {
                            this._pPassList[i].setPassInput(pInput, bSaveOldUniformValue);
                            this._pPassList[i].activate();
                        } else {
                            this._pPassList[i].deactivate();
                        }
                    }
                }
                this._isFreeze = false;
            };
            RenderTechnique.prototype._setComposer = function (pComposer) {
                this._pComposer = pComposer;
            };
            RenderTechnique.prototype._renderTechnique = function (pViewport, pRenderable, pSceneObject) {
                if (((this._pComposer) === null)) {
                    return;
                }
                var pComposer = this._pComposer;
                pComposer.prepareTechniqueBlend(this);
                pComposer._setCurrentViewport(pViewport);
                pComposer._setCurrentSceneObject(pSceneObject);
                pComposer._setCurrentRenderableObject(pRenderable);
                pComposer.applySurfaceMaterial(this._pMethod.surfaceMaterial);
                this._isFreeze = true;
                for(var i = 0; i < this.totalPasses; i++) {
                    if (this._pPassBlackList[i] === false && this._pPassList[i].isActive()) {
                        this.activatePass(i);
                        this.render(i);
                        pComposer.renderTechniquePass(this, i);
                    }
                }
                this._isFreeze = false;
                pComposer._setCurrentSceneObject(null);
            };
            RenderTechnique.prototype._updateMethod = function (pMethod) {
                this.informComposer();
            };
            RenderTechnique.prototype._blockPass = function (iPass) {
                this._pPassBlackList[iPass] = true;
                this._pComposer.prepareTechniqueBlend(this);
            };
            RenderTechnique.prototype._setGlobalPostEffectsFrom = function (iPass) {
                this._iGlobalPostEffectsStart = iPass;
            };
            RenderTechnique.prototype.informComposer = function () {
                if (!((this._pComposer) === null)) {
                    this._pComposer.markTechniqueAsNeedUpdate(this);
                }
            };
            RenderTechnique.prototype.activatePass = function (iPass) {
                this._iCurrentPass = iPass;
                this._pCurrentPass = this._pPassList[iPass];
            };
            RenderTechnique.prototype.getGuid = function () {
                return this._iGuid;
            };
            RenderTechnique._pEventTable = new akra.events.EventTable();
            RenderTechnique.prototype.getEventTable = function () {
                return RenderTechnique._pEventTable;
            };
            RenderTechnique.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            RenderTechnique.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            RenderTechnique.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            RenderTechnique.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            RenderTechnique.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            RenderTechnique.prototype.render = function (iPass) {
                var _recivier = this;
                this._pUnicastSlotMap = this._pUnicastSlotMap || (this.getEventTable()).findUnicastList(this._iGuid);
                var _unicast = (this._pUnicastSlotMap).render;
                if (((_unicast) !== undefined)) {
                    _unicast.target ? _unicast.target[_unicast.callback](_recivier, iPass) : _unicast.listener(_recivier, iPass);
                }
            };
            return RenderTechnique;
        })();
        render.RenderTechnique = RenderTechnique;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
;
var akra;
(function (akra) {
    (function (geometry) {
        var Sphere = (function () {
            function Sphere(fCenterX, fCenterY, fCenterZ, fRadius) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        var pSphere = arguments[0];
                        this.center = new akra.Vec3(pSphere.v3fCenter);
                        this.radius = pSphere.fRadius;
                        break;
                    case 2:
                        var v3fCenter = arguments[0];
                        var fRadius = arguments[1];
                        this.center = new akra.Vec3(v3fCenter);
                        this.radius = fRadius;
                        break;
                    case 4:
                        this.center = new akra.Vec3(arguments[0], arguments[1], arguments[2]);
                        this.radius = arguments[3];
                        break;
                    default:
                        this.center = new akra.Vec3();
                        this.radius = 0.;
                        break;
                }
            }
            Object.defineProperty(Sphere.prototype, "circle", {
                get: function () {
                    var v3fCenter = this.center;
                    return new geometry.Circle(v3fCenter.x, v3fCenter.y, this.radius);
                },
                set: function (pCircle) {
                    var v3fCenter = this.center;
                    var v2fCircleCenter = pCircle.center;
                    v3fCenter.x = v2fCircleCenter.x;
                    v3fCenter.y = v2fCircleCenter.y;
                    this.radius = pCircle.radius;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Sphere.prototype, "z", {
                get: function () {
                    return this.center.z;
                },
                set: function (fZ) {
                    this.center.z = fZ;
                },
                enumerable: true,
                configurable: true
            });
            Sphere.prototype.set = function (fCenterX, fCenterY, fCenterZ, fRadius) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        var pSphere = arguments[0];
                        this.center.set(pSphere.center);
                        this.radius = pSphere.radius;
                        break;
                    case 2:
                        var v3fCenter = arguments[0];
                        var fRadius = arguments[1];
                        this.center.set(v3fCenter);
                        this.radius = fRadius;
                        break;
                    case 4:
                        this.center.set(arguments[0], arguments[1], arguments[2]);
                        this.radius = arguments[3];
                        break;
                    default:
                        this.center.set(0.);
                        this.radius = 0.;
                        break;
                }
                return this;
            };
            Sphere.prototype.clear = function () {
                this.center.clear();
                this.radius = 0.;
                return this;
            };
            Sphere.prototype.isEqual = function (pSphere) {
                return this.center.isEqual(pSphere.center) && (this.radius == pSphere.radius);
            };
            Sphere.prototype.isClear = function () {
                return this.center.isClear() && (this.radius === 0.);
            };
            Sphere.prototype.isValid = function () {
                return (this.radius >= 0.);
            };
            Sphere.prototype.offset = function (v3fOffset) {
                this.center.add(v3fOffset);
                return this;
            };
            Sphere.prototype.expand = function (fInc) {
                this.radius += fInc;
                return this;
            };
            Sphere.prototype.normalize = function () {
                this.radius = akra.math.abs(this.radius);
                return this;
            };
            Sphere.prototype.transform = function (m4fMatrix) {
 {
                    akra.logger.setSourceLocation("Sphere.ts", 133);
                    akra.logger.criticalError("TODO: transform() for Sphere similar to Rect3d::transform();");
                }
                ;
                return this;
            };
            return Sphere;
        })();
        geometry.Sphere = Sphere;        
        ;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (geometry) {
        var Rect3d = (function () {
            function Rect3d(fX0, fX1, fY0, fY1, fZ0, fZ1) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        this.set(arguments[0]);
                        break;
                    case 2:
                        this.set(arguments[0], arguments[1]);
                        break;
                    case 3:
                        this.set(arguments[0], arguments[1], arguments[2]);
                        break;
                    case 6:
                        this.set(arguments[0], arguments[1], arguments[2], arguments[3], arguments[4], arguments[5]);
                        break;
                    default:
                        this.x0 = this.x1 = this.y0 = this.y1 = this.z0 = this.z1 = 0.;
                        break;
                }
            }
            Object.defineProperty(Rect3d.prototype, "rect2d", {
                get: function () {
                    return new geometry.Rect2d(this.x0, this.x1, this.y0, this.y1);
                },
                set: function (pRect) {
                    this.x0 = pRect.x0;
                    this.x1 = pRect.x1;
                    this.y0 = pRect.y0;
                    this.y1 = pRect.y1;
                },
                enumerable: true,
                configurable: true
            });
            Rect3d.prototype.set = function (fX0, fX1, fY0, fY1, fZ0, fZ1) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        if (arguments[0] instanceof Rect3d) {
                            var pRect = arguments[0];
                            this.x0 = pRect.x0;
                            this.x1 = pRect.x1;
                            this.y0 = pRect.y0;
                            this.y1 = pRect.y1;
                            this.z0 = pRect.z0;
                            this.z1 = pRect.z1;
                        } else {
                            var v3fSize = arguments[0];
                            this.x1 = v3fSize.x * 0.5;
                            this.x0 = -this.x1;
                            this.y1 = v3fSize.y * 0.5;
                            this.y0 = -this.y1;
                            this.z1 = v3fSize.z * 0.5;
                            this.z0 = -this.z1;
                        }
                        break;
                    case 2:
                        var v3fMinPoint = arguments[0];
                        var v3fMaxPoint = arguments[1];
                        this.x0 = v3fMinPoint.x;
                        this.y0 = v3fMinPoint.y;
                        this.z0 = v3fMinPoint.z;
                        this.x1 = v3fMaxPoint.x;
                        this.y1 = v3fMaxPoint.y;
                        this.z1 = v3fMaxPoint.z;
                        break;
                    case 3:
                        var fSizeX = arguments[0];
                        var fSizeY = arguments[1];
                        var fSizeZ = arguments[2];
                        this.x1 = fSizeX * 0.5;
                        this.x0 = -this.x1;
                        this.y1 = fSizeY * 0.5;
                        this.y0 = -this.y1;
                        this.z1 = fSizeZ * 0.5;
                        this.z0 = -this.z1;
                        break;
                    case 6:
                        this.x0 = arguments[0];
                        this.x1 = arguments[1];
                        this.y0 = arguments[2];
                        this.y1 = arguments[3];
                        this.z0 = arguments[4];
                        this.z1 = arguments[5];
                        break;
                    default:
                        this.x0 = this.x1 = this.y0 = this.y1 = this.z0 = this.z1 = 0.;
                        break;
                }
                return this;
            };
            Rect3d.prototype.setFloor = function (pRect) {
                this.x0 = akra.math.floor(pRect.x0);
                this.x1 = akra.math.floor(pRect.x1);
                this.y0 = akra.math.floor(pRect.y0);
                this.y1 = akra.math.floor(pRect.y1);
                this.z0 = akra.math.floor(pRect.z0);
                this.z1 = akra.math.floor(pRect.z1);
                return this;
            };
            Rect3d.prototype.setCeil = function (pRect) {
                this.x0 = akra.math.ceil(pRect.x0);
                this.x1 = akra.math.ceil(pRect.x1);
                this.y0 = akra.math.ceil(pRect.y0);
                this.y1 = akra.math.ceil(pRect.y1);
                this.z0 = akra.math.ceil(pRect.z0);
                this.z1 = akra.math.ceil(pRect.z1);
                return this;
            };
            Rect3d.prototype.clear = function () {
                this.x0 = this.x1 = this.y0 = this.y1 = this.z0 = this.z1 = 0.;
                return this;
            };
            Rect3d.prototype.addSelf = function (v3fVec) {
                if ((typeof (arguments[0]) === "number")) {
                    var fValue = arguments[0];
                    this.x0 += fValue;
                    this.x1 += fValue;
                    this.y0 += fValue;
                    this.y1 += fValue;
                    this.z0 += fValue;
                    this.z1 += fValue;
                } else {
                    var v3fVec = arguments[0];
                    this.x0 += v3fVec.x;
                    this.x1 += v3fVec.x;
                    this.y0 += v3fVec.y;
                    this.y1 += v3fVec.y;
                    this.z0 += v3fVec.z;
                    this.z1 += v3fVec.z;
                }
                return this;
            };
            Rect3d.prototype.subSelf = function (v3fVec) {
                if ((typeof (arguments[0]) === "number")) {
                    var fValue = arguments[0];
                    this.x0 -= fValue;
                    this.x1 -= fValue;
                    this.y0 -= fValue;
                    this.y1 -= fValue;
                    this.z0 -= fValue;
                    this.z1 -= fValue;
                } else {
                    var v3fVec = arguments[0];
                    this.x0 -= v3fVec.x;
                    this.x1 -= v3fVec.x;
                    this.y0 -= v3fVec.y;
                    this.y1 -= v3fVec.y;
                    this.z0 -= v3fVec.z;
                    this.z1 -= v3fVec.z;
                }
                return this;
            };
            Rect3d.prototype.multSelf = function (v3fVec) {
                if ((typeof (arguments[0]) === "number")) {
                    var fValue = arguments[0];
                    this.x0 *= fValue;
                    this.x1 *= fValue;
                    this.y0 *= fValue;
                    this.y1 *= fValue;
                    this.z0 *= fValue;
                    this.z1 *= fValue;
                } else {
                    var v3fVec = arguments[0];
                    this.x0 *= v3fVec.x;
                    this.x1 *= v3fVec.x;
                    this.y0 *= v3fVec.y;
                    this.y1 *= v3fVec.y;
                    this.z0 *= v3fVec.z;
                    this.z1 *= v3fVec.z;
                }
                return this;
            };
            Rect3d.prototype.divSelf = function (v3fVec) {
                if ((typeof (arguments[0]) === "number")) {
                    var fValue = arguments[0];
 {
                        akra.logger.setSourceLocation("geometry/Rect3d.ts", 261);
                        akra.logger.assert(fValue != 0.0, "divide by zero error");
                    }
                    ;
                    var fInvValue = 1. / fValue;
                    this.x0 *= fInvValue;
                    this.x1 *= fInvValue;
                    this.y0 *= fInvValue;
                    this.y1 *= fInvValue;
                    this.z0 *= fInvValue;
                    this.z1 *= fInvValue;
                } else {
                    var v3fVec = arguments[0];
 {
                        akra.logger.setSourceLocation("geometry/Rect3d.ts", 275);
                        akra.logger.assert(v3fVec.x != 0.0, "divide by zero error");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("geometry/Rect3d.ts", 276);
                        akra.logger.assert(v3fVec.y != 0.0, "divide by zero error");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("geometry/Rect3d.ts", 277);
                        akra.logger.assert(v3fVec.z != 0.0, "divide by zero error");
                    }
                    ;
                    var fInvX = 1. / v3fVec.x;
                    var fInvY = 1. / v3fVec.y;
                    var fInvZ = 1. / v3fVec.z;
                    this.x0 *= fInvX;
                    this.x1 *= fInvX;
                    this.y0 *= fInvY;
                    this.y1 *= fInvY;
                    this.z0 *= fInvZ;
                    this.z1 *= fInvZ;
                }
                return this;
            };
            Rect3d.prototype.offset = function (fOffsetX, fOffsetY, fOffsetZ) {
                if (arguments.length === 1) {
                    var v3fOffset = arguments[0];
                    this.x0 += v3fOffset.x;
                    this.x1 += v3fOffset.x;
                    this.y0 += v3fOffset.y;
                    this.y1 += v3fOffset.y;
                    this.z0 += v3fOffset.z;
                    this.z1 += v3fOffset.z;
                } else {
                    this.x0 += arguments[0];
                    this.x1 += arguments[0];
                    this.y0 += arguments[1];
                    this.y1 += arguments[1];
                    this.z0 += arguments[2];
                    this.z1 += arguments[2];
                }
                return this;
            };
            Rect3d.prototype.expand = function (fValueX, fValueY, fValueZ) {
                if (arguments.length === 1) {
                    if ((typeof (arguments[0]) === "number")) {
                        var fValue = arguments[0];
                        this.x0 -= fValue;
                        this.x1 += fValue;
                        this.y0 -= fValue;
                        this.y1 += fValue;
                        this.z0 -= fValue;
                        this.z1 += fValue;
                    } else {
                        var v3fVec = arguments[0];
                        this.x0 -= v3fVec.x;
                        this.x1 += v3fVec.x;
                        this.y0 -= v3fVec.y;
                        this.y1 += v3fVec.y;
                        this.z0 -= v3fVec.z;
                        this.z1 += v3fVec.z;
                    }
                } else {
                    this.x0 -= arguments[0];
                    this.x1 += arguments[0];
                    this.y0 -= arguments[1];
                    this.y1 += arguments[1];
                    this.z0 -= arguments[2];
                    this.z1 += arguments[2];
                }
                return this;
            };
            Rect3d.prototype.expandX = function (fValue) {
                this.x0 -= fValue;
                this.x1 += fValue;
                return this;
            };
            Rect3d.prototype.expandY = function (fValue) {
                this.y0 -= fValue;
                this.y1 += fValue;
                return this;
            };
            Rect3d.prototype.expandZ = function (fValue) {
                this.z0 -= fValue;
                this.z1 += fValue;
                return this;
            };
            Rect3d.prototype.resize = function (fSizeX, fSizeY, fSizeZ) {
                var fSizeX, fSizeY, fSizeZ;
                if (arguments.length === 1) {
                    var v3fSize = arguments[0];
                    fSizeX = v3fSize.x;
                    fSizeY = v3fSize.y;
                    fSizeZ = v3fSize.z;
                } else {
                    fSizeX = arguments[0];
                    fSizeY = arguments[1];
                    fSizeZ = arguments[2];
                }
                this.x1 = (this.x0 + this.x1 + fSizeX) * 0.5;
                this.x0 = this.x1 - fSizeX;
                this.y1 = (this.y0 + this.y1 + fSizeY) * 0.5;
                this.y0 = this.y1 - fSizeY;
                this.z1 = (this.z0 + this.z1 + fSizeZ) * 0.5;
                this.z0 = this.z1 - fSizeZ;
                return this;
            };
            Rect3d.prototype.resizeX = function (fSize) {
                this.x1 = (this.x0 + this.x1 + fSize) * 0.5;
                this.x0 = this.x1 - fSize;
                return this;
            };
            Rect3d.prototype.resizeY = function (fSize) {
                this.y1 = (this.y0 + this.y1 + fSize) * 0.5;
                this.y0 = this.y1 - fSize;
                return this;
            };
            Rect3d.prototype.resizeZ = function (fSize) {
                this.z1 = (this.z0 + this.z1 + fSize) * 0.5;
                this.z0 = this.z1 - fSize;
                return this;
            };
            Rect3d.prototype.resizeMax = function (fSpanX, fSpanY, fSpanZ) {
                if (arguments.length === 1) {
                    var v3fSpan = arguments[0];
                    this.x1 = this.x0 + v3fSpan.x;
                    this.y1 = this.y0 + v3fSpan.y;
                    this.z1 = this.z0 + v3fSpan.z;
                } else {
                    this.x1 = this.x0 + arguments[0];
                    this.y1 = this.y0 + arguments[1];
                    this.z1 = this.z0 + arguments[2];
                }
                return this;
            };
            Rect3d.prototype.resizeMaxX = function (fSpan) {
                this.x1 = this.x0 + fSpan;
                return this;
            };
            Rect3d.prototype.resizeMaxY = function (fSpan) {
                this.y1 = this.y0 + fSpan;
                return this;
            };
            Rect3d.prototype.resizeMaxZ = function (fSpan) {
                this.z1 = this.z0 + fSpan;
                return this;
            };
            Rect3d.prototype.resizeMin = function (fSpanX, fSpanY, fSpanZ) {
                if (arguments.length === 1) {
                    var v3fSpan = arguments[0];
                    this.x0 = this.x1 - v3fSpan.x;
                    this.y0 = this.y1 - v3fSpan.y;
                    this.z0 = this.z1 - v3fSpan.z;
                } else {
                    this.x0 = this.x1 - arguments[0];
                    this.y0 = this.y1 - arguments[1];
                    this.z0 = this.z1 - arguments[2];
                }
                return this;
            };
            Rect3d.prototype.resizeMinX = function (fSpan) {
                this.x0 = this.x1 - fSpan;
                return this;
            };
            Rect3d.prototype.resizeMinY = function (fSpan) {
                this.y0 = this.y1 - fSpan;
                return this;
            };
            Rect3d.prototype.resizeMinZ = function (fSpan) {
                this.z0 = this.z1 - fSpan;
                return this;
            };
            Rect3d.prototype.unionPoint = function (fX, fY, fZ) {
                if (arguments.length === 1) {
                    var v3fPoint = arguments[0];
                    this.x0 = akra.math.min(this.x0, v3fPoint.x);
                    this.x1 = akra.math.max(this.x1, v3fPoint.x);
                    this.y0 = akra.math.min(this.y0, v3fPoint.y);
                    this.y1 = akra.math.max(this.y1, v3fPoint.y);
                    this.z0 = akra.math.min(this.z0, v3fPoint.z);
                    this.z1 = akra.math.max(this.z1, v3fPoint.z);
                } else {
                    this.x0 = akra.math.min(this.x0, arguments[0]);
                    this.x1 = akra.math.max(this.x1, arguments[0]);
                    this.y0 = akra.math.min(this.y0, arguments[1]);
                    this.y1 = akra.math.max(this.y1, arguments[1]);
                    this.z0 = akra.math.min(this.z0, arguments[2]);
                    this.z1 = akra.math.max(this.z1, arguments[2]);
                }
                return this;
            };
            Rect3d.prototype.unionRect = function (pRect) {
                this.normalize();
                pRect.normalize();
                this.x0 = akra.math.min(this.x0, pRect.x0);
                this.x1 = akra.math.max(this.x1, pRect.x1);
                this.y0 = akra.math.min(this.y0, pRect.y0);
                this.y1 = akra.math.max(this.y1, pRect.y1);
                this.z0 = akra.math.min(this.z0, pRect.z0);
                this.z1 = akra.math.max(this.z1, pRect.z1);
                return this;
            };
            Rect3d.prototype.negate = function (pDestination) {
                if (!((pDestination) !== undefined)) {
                    pDestination = this;
                }
                return pDestination.set(-this.x1, -this.x0, -this.y1, -this.y0, -this.z1, -this.z0);
            };
            Rect3d.prototype.normalize = function () {
                var fTmp;
                if (this.x0 > this.x1) {
                    fTmp = this.x0;
                    this.x0 = this.x1;
                    this.x1 = fTmp;
                }
                if (this.y0 > this.y1) {
                    fTmp = this.y0;
                    this.y0 = this.y1;
                    this.y1 = fTmp;
                }
                if (this.z0 > this.z1) {
                    fTmp = this.z0;
                    this.z0 = this.z1;
                    this.z1 = fTmp;
                }
                return this;
            };
            Rect3d.prototype.transform = function (m4fMatrix) {
                var pData = m4fMatrix.data;
                var a11 = pData[0], a12 = pData[4], a13 = pData[8], a14 = pData[12];
                var a21 = pData[1], a22 = pData[5], a23 = pData[9], a24 = pData[13];
                var a31 = pData[2], a32 = pData[6], a33 = pData[10], a34 = pData[14];
                var fX0 = this.x0, fX1 = this.x1;
                var fY0 = this.y0, fY1 = this.y1;
                var fZ0 = this.z0, fZ1 = this.z1;
                var fBaseX = a11 * fX0 + a12 * fY0 + a13 * fZ0 + a14;
                var fBaseY = a21 * fX0 + a22 * fY0 + a23 * fZ0 + a24;
                var fBaseZ = a31 * fX0 + a32 * fY0 + a33 * fZ0 + a34;
                var fXNewX = a11 * (fX1 - fX0);
                var fXNewY = a21 * (fX1 - fX0);
                var fXNewZ = a31 * (fX1 - fX0);
                var fYNewX = a12 * (fY1 - fY0);
                var fYNewY = a22 * (fY1 - fY0);
                var fYNewZ = a32 * (fY1 - fY0);
                var fZNewX = a13 * (fZ1 - fZ0);
                var fZNewY = a23 * (fZ1 - fZ0);
                var fZNewZ = a33 * (fZ1 - fZ0);
                var fXMultX = (fXNewX > 0.) ? 1. : 0.;
                var fYMultX = (fYNewX > 0.) ? 1. : 0.;
                var fZMultX = (fZNewX > 0.) ? 1. : 0.;
                var fXMultY = (fXNewY > 0.) ? 1. : 0.;
                var fYMultY = (fYNewY > 0.) ? 1. : 0.;
                var fZMultY = (fZNewY > 0.) ? 1. : 0.;
                var fXMultZ = (fXNewZ > 0.) ? 1. : 0.;
                var fYMultZ = (fYNewZ > 0.) ? 1. : 0.;
                var fZMultZ = (fZNewZ > 0.) ? 1. : 0.;
                this.x1 = fBaseX + fXMultX * fXNewX + fYMultX * fYNewX + fZMultX * fZNewX;
                this.y1 = fBaseY + fXMultY * fXNewY + fYMultY * fYNewY + fZMultY * fZNewY;
                this.z1 = fBaseZ + fXMultZ * fXNewZ + fYMultZ * fYNewZ + fZMultZ * fZNewZ;
                this.x0 = fBaseX + (1. - fXMultX) * fXNewX + (1. - fYMultX) * fYNewX + (1. - fZMultX) * fZNewX;
                this.y0 = fBaseY + (1. - fXMultY) * fXNewY + (1. - fYMultY) * fYNewY + (1. - fZMultY) * fZNewY;
                this.z0 = fBaseZ + (1. - fXMultZ) * fXNewZ + (1. - fYMultZ) * fYNewZ + (1. - fZMultZ) * fZNewZ;
                return this;
            };
            Rect3d.prototype.isEqual = function (pRect) {
                return this.x0 == pRect.x0 && this.x1 == pRect.x1 && this.y0 == pRect.y0 && this.y1 == pRect.y1 && this.z0 == pRect.z0 && this.z1 == pRect.z1;
            };
            Rect3d.prototype.isClear = function () {
                return this.x0 == 0. && this.x1 == 0. && this.y0 == 0. && this.y1 == 0. && this.z0 == 0. && this.z1 == 0.;
            };
            Rect3d.prototype.isValid = function () {
                return this.x0 <= this.x1 && this.y0 <= this.y1 && this.z0 <= this.z1;
            };
            Rect3d.prototype.isPointInRect = function (v3fPoint) {
                var x = v3fPoint.x;
                var y = v3fPoint.y;
                var z = v3fPoint.z;
                return (this.x0 <= x && x <= this.x1) && (this.y0 <= y && y <= this.y1) && (this.z0 <= z && z <= this.z1);
            };
            Rect3d.prototype.midPoint = function (v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = new akra.Vec3();
                }
                return v3fDestination.set((this.x0 + this.x1) * 0.5, (this.y0 + this.y1) * 0.5, (this.z0 + this.z1) * 0.5);
            };
            Rect3d.prototype.midX = function () {
                return (this.x0 + this.x1) * 0.5;
            };
            Rect3d.prototype.midY = function () {
                return (this.y0 + this.y1) * 0.5;
            };
            Rect3d.prototype.midZ = function () {
                return (this.z0 + this.z1) * 0.5;
            };
            Rect3d.prototype.size = function (v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = new akra.Vec3();
                }
                return v3fDestination.set(this.x1 - this.x0, this.y1 - this.y0, this.z1 - this.z0);
            };
            Rect3d.prototype.sizeX = function () {
                return this.x1 - this.x0;
            };
            Rect3d.prototype.sizeY = function () {
                return this.y1 - this.y0;
            };
            Rect3d.prototype.sizeZ = function () {
                return this.z1 - this.z0;
            };
            Rect3d.prototype.minPoint = function (v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = new akra.Vec3();
                }
                return v3fDestination.set(this.x0, this.y0, this.z0);
            };
            Rect3d.prototype.maxPoint = function (v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = new akra.Vec3();
                }
                return v3fDestination.set(this.x1, this.y1, this.z1);
            };
            Rect3d.prototype.volume = function () {
                return (this.x1 - this.x0) * (this.y1 - this.y0) * (this.z1 - this.z0);
            };
            Rect3d.prototype.corner = function (iIndex, v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = new akra.Vec3();
                }
 {
                    akra.logger.setSourceLocation("geometry/Rect3d.ts", 752);
                    akra.logger.assert(0 <= iIndex && iIndex < 8, "invalid index");
                }
                ;
                switch(iIndex) {
                    case 0:
                        v3fDestination.set(this.x0, this.y0, this.z0);
                        break;
                    case 1:
                        v3fDestination.set(this.x1, this.y0, this.z0);
                        break;
                    case 2:
                        v3fDestination.set(this.x1, this.y1, this.z0);
                        break;
                    case 3:
                        v3fDestination.set(this.x0, this.y1, this.z0);
                        break;
                    case 4:
                        v3fDestination.set(this.x0, this.y0, this.z1);
                        break;
                    case 5:
                        v3fDestination.set(this.x1, this.y0, this.z1);
                        break;
                    case 6:
                        v3fDestination.set(this.x1, this.y1, this.z1);
                        break;
                    case 7:
                        v3fDestination.set(this.x0, this.y1, this.z1);
                        break;
                }
                return v3fDestination;
            };
            Rect3d.prototype.createBoundingSphere = function (pSphere) {
                if (!((pSphere) !== undefined)) {
                    pSphere = new geometry.Sphere();
                }
                var fX0 = this.x0, fX1 = this.x1;
                var fY0 = this.y0, fY1 = this.y1;
                var fZ0 = this.z0, fZ1 = this.z1;
                var fHalfSizeX = (fX1 - fX0) * 0.5;
                var fHalfSizeY = (fY1 - fY0) * 0.5;
                var fHalfSizeZ = (fZ1 - fZ0) * 0.5;
                pSphere.set((fX0 + fX1) * 0.5, (fY0 + fY1) * 0.5, (fZ0 + fZ1) * 0.5, akra.math.sqrt(fHalfSizeX * fHalfSizeX + fHalfSizeY * fHalfSizeY + fHalfSizeZ * fHalfSizeZ));
                return pSphere;
            };
            Rect3d.prototype.toString = function () {
                return "(" + this.x0 + ", " + this.y0 + ", " + this.z0 + ") --> (" + this.x1 + ", " + this.y1 + ", " + this.z1 + ")";
            };
            Object.defineProperty(Rect3d, "stackCeil", {
                get: function () {
                    Rect3d.stackPosition = Rect3d.stackPosition === Rect3d.stackSize - 1 ? 0 : Rect3d.stackPosition;
                    return Rect3d.stack[Rect3d.stackPosition++];
                },
                enumerable: true,
                configurable: true
            });
            Rect3d.stackSize = 128;
            Rect3d.stackPosition = 0;
            Rect3d.stack = (function () {
                var pStack = new Array(Rect3d.stackSize);
                for(var i = 0; i < Rect3d.stackSize; i++) {
                    pStack[i] = new Rect3d();
                }
                return pStack;
            })();
            return Rect3d;
        })();
        geometry.Rect3d = Rect3d;        
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        (function (ESceneObjectFlags) {
            ESceneObjectFlags._map = [];
            ESceneObjectFlags.k_NewLocalBounds = 0;
            ESceneObjectFlags._map[1] = "k_NewWorldBounds";
            ESceneObjectFlags.k_NewWorldBounds = 1;
        })(scene.ESceneObjectFlags || (scene.ESceneObjectFlags = {}));
        var ESceneObjectFlags = scene.ESceneObjectFlags;
        ;
        var SceneObject = (function (_super) {
            __extends(SceneObject, _super);
            function SceneObject(pScene, eType) {
                if (typeof eType === "undefined") { eType = akra.EEntityTypes.SCENE_OBJECT; }
                        _super.call(this, pScene, eType);
                this._iObjectFlags = 0;
                this._pLocalBounds = new akra.geometry.Rect3d();
                this._pWorldBounds = new akra.geometry.Rect3d();
                this._hasShadow = false;
            }
            Object.defineProperty(SceneObject.prototype, "totalRenderable", {
                get: function () {
                    return 0;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(SceneObject.prototype, "worldBounds", {
                get: function () {
                    return this._pWorldBounds;
                },
                set: function (pBox) {
                    this._pWorldBounds = pBox;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(SceneObject.prototype, "localBounds", {
                get: function () {
                    return this._pLocalBounds;
                },
                enumerable: true,
                configurable: true
            });
            SceneObject.prototype.getRenderable = function (i) {
                return null;
            };
            SceneObject.prototype.accessLocalBounds = function () {
                ((this._iObjectFlags) |= (1 << (ESceneObjectFlags.k_NewLocalBounds)));
                return this._pLocalBounds;
            };
            SceneObject.prototype.isWorldBoundsNew = function () {
                return ((this._iObjectFlags & (1 << (ESceneObjectFlags.k_NewLocalBounds))) != 0);
            };
            SceneObject.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
            };
            SceneObject.prototype.prepareForUpdate = function () {
                _super.prototype.prepareForUpdate.call(this);
                ((this._iObjectFlags) &= ~((1 << (ESceneObjectFlags.k_NewLocalBounds)) | (1 << (ESceneObjectFlags.k_NewWorldBounds))));
            };
            SceneObject.prototype.update = function () {
                _super.prototype.update.call(this);
                return this.recalcWorldBounds();
            };
            SceneObject.prototype.recalcWorldBounds = function () {
                if (((this._iObjectFlags & (1 << (ESceneObjectFlags.k_NewLocalBounds))) != 0) || this.isWorldMatrixNew()) {
                    this._pWorldBounds.set(this._pLocalBounds);
                    if (true) {
                        this._pWorldBounds.x1 = Math.max(this._pWorldBounds.x1, this._pWorldBounds.x0 + 0.01);
                        this._pWorldBounds.y1 = Math.max(this._pWorldBounds.y1, this._pWorldBounds.y0 + 0.01);
                        this._pWorldBounds.z1 = Math.max(this._pWorldBounds.z1, this._pWorldBounds.z0 + 0.01);
                    }
                    this._pWorldBounds.transform(this.worldMatrix);
                    ((this._iObjectFlags) |= (1 << (ESceneObjectFlags.k_NewWorldBounds)));
                    this.worldBoundsUpdated();
                    return true;
                }
                return false;
            };
            Object.defineProperty(SceneObject.prototype, "hasShadow", {
                get: function () {
                    return this._hasShadow;
                },
                set: function (bValue) {
                    this._hasShadow = bValue;
                    for(var i = 0; i < this.totalRenderable; i++) {
                        this.getRenderable(i).hasShadow = bValue;
                    }
                },
                enumerable: true,
                configurable: true
            });
            SceneObject.prototype.getObjectFlags = function () {
                return this._iObjectFlags;
            };
            SceneObject.prototype.prepareForRender = function (pViewport) {
            };
            SceneObject.prototype.toString = function (isRecursive, iDepth) {
                if (typeof isRecursive === "undefined") { isRecursive = false; }
                if (typeof iDepth === "undefined") { iDepth = 0; }
                if (!isRecursive) {
                    return "<scene_object" + (this._sName ? " " + this._sName : "") + ">";
                }
                return _super.prototype.toString.call(this, isRecursive, iDepth);
            };
            SceneObject.prototype.worldBoundsUpdated = function () {
                var _recivier = this;
                this._pUnicastSlotMap = this._pUnicastSlotMap || (this.getEventTable()).findUnicastList(this._iGuid);
                var _unicast = (this._pUnicastSlotMap).worldBoundsUpdated;
                if (((_unicast) !== undefined)) {
                    _unicast.target ? _unicast.target[_unicast.callback](_recivier) : _unicast.listener(_recivier);
                }
            };
            return SceneObject;
        })(scene.SceneNode);
        scene.SceneObject = SceneObject;        
        function isSceneObject(pEntity) {
            return pEntity.type >= akra.EEntityTypes.SCENE_OBJECT && pEntity.type < akra.EEntityTypes.OBJECTS_LIMIT;
        }
        scene.isSceneObject = isSceneObject;
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (geometry) {
        var Plane3d = (function () {
            function Plane3d(v3fPoint1, v3fPoint2, v3fPoint3) {
                this.normal = new akra.Vec3();
                this.distance = 0.;
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        this.set(arguments[0]);
                        break;
                    case 2:
                        this.set(arguments[0], arguments[1]);
                        break;
                    case 3:
                        this.set(arguments[0], arguments[1], arguments[2]);
                        break;
                    default:
                        break;
                }
            }
            Plane3d.prototype.set = function (v3fPoint1, v3fPoint2, v3fPoint3) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        var pPlane = arguments[0];
                        this.normal.set(pPlane.normal);
                        this.distance = pPlane.distance;
                        break;
                    case 2:
                        this.normal.set(arguments[0]);
                        this.distance = arguments[1];
                        break;
                    case 3:
                        var v3fPoint1 = arguments[0];
                        var v3fPoint2 = arguments[1];
                        var v3fPoint3 = arguments[2];
                        var x1 = v3fPoint2.x - v3fPoint1.x;
                        var y1 = v3fPoint2.y - v3fPoint1.y;
                        var z1 = v3fPoint2.z - v3fPoint1.z;
                        var x2 = v3fPoint3.x - v3fPoint1.x;
                        var y2 = v3fPoint3.y - v3fPoint1.y;
                        var z2 = v3fPoint3.z - v3fPoint1.z;
                        var x = y1 * z2 - y2 * z1;
                        var y = z1 * x2 - z2 * x1;
                        var z = x1 * y2 - x2 * y1;
                        this.distance = -(x * v3fPoint1.x + y * v3fPoint1.y + z * v3fPoint1.z);
                        this.normal.set(x, y, z);
                        break;
                    default:
                        this.normal.clear();
                        this.distance = 0.;
                        break;
                }
                return this.normalize();
            };
            Plane3d.prototype.clear = function () {
                this.normal.clear();
                this.distance = 0.;
                return this;
            };
            Plane3d.prototype.negate = function () {
                this.normal.negate();
                this.distance = -this.distance;
                return this;
            };
            Plane3d.prototype.normalize = function () {
                var v3fNormal = this.normal;
                var x = v3fNormal.x, y = v3fNormal.y, z = v3fNormal.z;
                var fLength = akra.math.sqrt(x * x + y * y + z * z);
                if (fLength !== 0.) {
                    var fInvLength = 1. / fLength;
                    v3fNormal.x = x * fInvLength;
                    v3fNormal.y = y * fInvLength;
                    v3fNormal.z = z * fInvLength;
                    this.distance *= fInvLength;
                }
                return this;
            };
            Plane3d.prototype.isEqual = function (pPlane) {
                return this.normal.isEqual(pPlane.normal) && (this.distance == pPlane.distance);
            };
            Plane3d.prototype.projectPointToPlane = function (v3fPoint, v3fDestination) {
                if (!((v3fDestination) !== undefined)) {
                    v3fDestination = new akra.Vec3();
                }
                var v3fNormal = this.normal;
                var fDistance = this.distance + v3fNormal.dot(v3fPoint);
                v3fDestination.x = v3fPoint.x - fDistance * v3fNormal.x;
                v3fDestination.y = v3fPoint.y - fDistance * v3fNormal.y;
                v3fDestination.z = v3fPoint.z - fDistance * v3fNormal.z;
                return v3fDestination;
            };
            Plane3d.prototype.solveForX = function (fY, fZ) {
                var v3fNormal = this.normal;
                if (v3fNormal.x !== 0.) {
                    return -(this.distance + v3fNormal.y * fY + v3fNormal.z * fZ) / v3fNormal.x;
                }
                return 0.;
            };
            Plane3d.prototype.solveForY = function (fX, fZ) {
                var v3fNormal = this.normal;
                if (v3fNormal.y !== 0.) {
                    return -(this.distance + v3fNormal.x * fX + v3fNormal.z * fZ) / v3fNormal.y;
                }
                return 0.;
            };
            Plane3d.prototype.solveForZ = function (fX, fY) {
                var v3fNormal = this.normal;
                if (v3fNormal.z !== 0.) {
                    return -(this.distance + v3fNormal.x * fX + v3fNormal.y * fY) / v3fNormal.z;
                }
                return 0.;
            };
            Plane3d.prototype.signedDistance = function (v3fPoint) {
                return this.distance + this.normal.dot(v3fPoint);
            };
            return Plane3d;
        })();
        geometry.Plane3d = Plane3d;        
        ;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
;
var akra;
(function (akra) {
    (function (geometry) {
        var Plane2d = (function () {
            function Plane2d(v2fPoint1, v2fPoint2) {
                this.normal = new akra.Vec2();
                this.distance = 0.;
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        this.set(arguments[0]);
                        break;
                    case 2:
                        this.set(arguments[0], arguments[1]);
                        break;
                    default:
                        break;
                }
            }
            Plane2d.prototype.set = function (v2fPoint1, v2fPoint2) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        var pPlane = arguments[0];
                        this.normal.set(pPlane.normal);
                        this.distance = pPlane.distance;
                        break;
                    case 2:
                        if ((typeof (arguments[1]) === "number")) {
                            this.normal.set(arguments[0]);
                            this.distance = arguments[1];
                        } else {
                            var v2fLine = akra.vec2(arguments[1]).subtract(arguments[0]);
                            var v2fNormal = this.normal;
                            v2fNormal.set(-v2fLine.y, v2fLine.x);
                            this.distance = -v2fNormal.dot(arguments[0]);
                        }
                        break;
                    default:
                        this.normal.clear();
                        this.distance = 0.;
                        break;
                }
                return this.normalize();
            };
            Plane2d.prototype.clear = function () {
                this.normal.clear();
                this.distance = 0.;
                return this;
            };
            Plane2d.prototype.negate = function () {
                this.normal.negate();
                this.distance = -this.distance;
                return this;
            };
            Plane2d.prototype.normalize = function () {
                var v2fNormal = this.normal;
                var x = v2fNormal.x;
                var y = v2fNormal.y;
                var fLength = akra.math.sqrt(x * x + y * y);
                if (fLength !== 0.) {
                    var fInvLength = 1. / fLength;
                    v2fNormal.x = x * fInvLength;
                    v2fNormal.y = y * fInvLength;
                    this.distance = this.distance * fInvLength;
                }
                return this;
            };
            Plane2d.prototype.isEqual = function (pPlane) {
                return this.normal.isEqual(pPlane.normal) && (this.distance == pPlane.distance);
            };
            Plane2d.prototype.projectPointToPlane = function (v2fPoint, v2fDestination) {
                if (!((v2fDestination) !== undefined)) {
                    v2fDestination = new akra.Vec2();
                }
                var v2fNormal = this.normal;
                var fDistance = this.distance + v2fNormal.dot(v2fPoint);
                v2fDestination.x = v2fPoint.x - fDistance * v2fNormal.x;
                v2fDestination.y = v2fPoint.y - fDistance * v2fNormal.y;
                return v2fDestination;
            };
            Plane2d.prototype.solveForX = function (fY) {
                var v2fNormal = this.normal;
                if (v2fNormal.x !== 0.) {
                    return -(this.distance + v2fNormal.y * fY) / v2fNormal.x;
                }
                return 0.;
            };
            Plane2d.prototype.solveForY = function (fX) {
                var v2fNormal = this.normal;
                if (v2fNormal.y !== 0.) {
                    return -(this.distance + v2fNormal.x * fX) / v2fNormal.y;
                }
                return 0.;
            };
            Plane2d.prototype.signedDistance = function (v2fPoint) {
                return this.distance + this.normal.dot(v2fPoint);
            };
            return Plane2d;
        })();
        geometry.Plane2d = Plane2d;        
        ;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EVolumeClassifications) {
        EVolumeClassifications._map = [];
        EVolumeClassifications.NO_RELATION = 0;
        EVolumeClassifications._map[1] = "EQUAL";
        EVolumeClassifications.EQUAL = 1;
        EVolumeClassifications._map[2] = "A_CONTAINS_B";
        EVolumeClassifications.A_CONTAINS_B = 2;
        EVolumeClassifications._map[3] = "B_CONTAINS_A";
        EVolumeClassifications.B_CONTAINS_A = 3;
        EVolumeClassifications._map[4] = "INTERSECTING";
        EVolumeClassifications.INTERSECTING = 4;
    })(akra.EVolumeClassifications || (akra.EVolumeClassifications = {}));
    var EVolumeClassifications = akra.EVolumeClassifications;
    ;
    (function (EPlaneClassifications) {
        EPlaneClassifications._map = [];
        EPlaneClassifications.PLANE_FRONT = 0;
        EPlaneClassifications._map[1] = "PLANE_BACK";
        EPlaneClassifications.PLANE_BACK = 1;
        EPlaneClassifications._map[2] = "PLANE_INTERSECT";
        EPlaneClassifications.PLANE_INTERSECT = 2;
    })(akra.EPlaneClassifications || (akra.EPlaneClassifications = {}));
    var EPlaneClassifications = akra.EPlaneClassifications;
    ;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (geometry) {
        function planeClassifyCircle(pPlane, pCircle) {
            var fDistance = pPlane.signedDistance(pCircle.center);
            var fRadius = pCircle.radius;
            if (fDistance > fRadius) {
                return akra.EPlaneClassifications.PLANE_FRONT;
            } else if (fDistance < -fRadius) {
                return akra.EPlaneClassifications.PLANE_BACK;
            } else {
                return akra.EPlaneClassifications.PLANE_INTERSECT;
            }
        }
        geometry.planeClassifyCircle = planeClassifyCircle;
        ;
        function planeClassifySphere(pPlane, pSphere) {
            var fDistance = pPlane.signedDistance(pSphere.center);
            var fRadius = pSphere.radius;
            if (fDistance > fRadius) {
                return akra.EPlaneClassifications.PLANE_FRONT;
            } else if (fDistance < -fRadius) {
                return akra.EPlaneClassifications.PLANE_BACK;
            } else {
                return akra.EPlaneClassifications.PLANE_INTERSECT;
            }
        }
        geometry.planeClassifySphere = planeClassifySphere;
        ;
        function planeClassifyRect2d(pPlane, pRect) {
            var v2fMinPoint = akra.vec2();
            var v2fMaxPoint = akra.vec2();
            var v2fNormal = pPlane.normal;
            if (v2fNormal.x > 0.) {
                v2fMinPoint.x = pRect.x0;
                v2fMaxPoint.x = pRect.x1;
            } else {
                v2fMinPoint.x = pRect.x1;
                v2fMaxPoint.x = pRect.x0;
            }
            if (v2fNormal.y > 0.) {
                v2fMinPoint.y = pRect.y0;
                v2fMaxPoint.y = pRect.y1;
            } else {
                v2fMinPoint.y = pRect.y1;
                v2fMaxPoint.y = pRect.y0;
            }
            var fMinDistance = pPlane.signedDistance(v2fMinPoint);
            var fMaxDistance = pPlane.signedDistance(v2fMaxPoint);
            if (fMinDistance * fMaxDistance <= 0.) {
                return akra.EPlaneClassifications.PLANE_INTERSECT;
            } else if (fMaxDistance < 0.) {
                return akra.EPlaneClassifications.PLANE_BACK;
            } else {
                return akra.EPlaneClassifications.PLANE_FRONT;
            }
        }
        geometry.planeClassifyRect2d = planeClassifyRect2d;
        ;
        function planeClassifyRect3d(pPlane, pRect) {
            var v3fMinPoint = akra.vec3();
            var v3fMaxPoint = akra.vec3();
            var v3fNormal = pPlane.normal;
            if (v3fNormal.x > 0.) {
                v3fMinPoint.x = pRect.x0;
                v3fMaxPoint.x = pRect.x1;
            } else {
                v3fMinPoint.x = pRect.x1;
                v3fMaxPoint.x = pRect.x0;
            }
            if (v3fNormal.y > 0.) {
                v3fMinPoint.y = pRect.y0;
                v3fMaxPoint.y = pRect.y1;
            } else {
                v3fMinPoint.y = pRect.y1;
                v3fMaxPoint.y = pRect.y0;
            }
            if (v3fNormal.z > 0.) {
                v3fMinPoint.z = pRect.z0;
                v3fMaxPoint.z = pRect.z1;
            } else {
                v3fMinPoint.z = pRect.z1;
                v3fMaxPoint.z = pRect.z0;
            }
            var fMinDistance = pPlane.signedDistance(v3fMinPoint);
            var fMaxDistance = pPlane.signedDistance(v3fMaxPoint);
            if (fMinDistance * fMaxDistance <= 0.) {
                return akra.EPlaneClassifications.PLANE_INTERSECT;
            } else if (fMaxDistance < 0.) {
                return akra.EPlaneClassifications.PLANE_BACK;
            } else {
                return akra.EPlaneClassifications.PLANE_FRONT;
            }
        }
        geometry.planeClassifyRect3d = planeClassifyRect3d;
        ;
                                        function planeClassify(pPlane, pRect) {
            var pArg0 = arguments[0];
            var pArg1 = arguments[1];
            if (pArg0 instanceof geometry.Plane2d) {
                if (pArg1 instanceof geometry.Circle) {
                    return planeClassifyCircle(pArg0, pArg1);
                } else {
                    return planeClassifyRect2d(pArg0, pArg1);
                }
            } else {
                if (pArg1 instanceof geometry.Sphere) {
                    return planeClassifySphere(pArg0, pArg1);
                } else {
                    return planeClassifyRect3d(pArg0, pArg1);
                }
            }
        }
        geometry.planeClassify = planeClassify;
        ;
        function classifyRect2d(pRectA, pRectB) {
            var fRectAX0 = pRectA.x0, fRectAX1 = pRectA.x1;
            var fRectAY0 = pRectA.y0, fRectAY1 = pRectA.y1;
            var fRectBX0 = pRectB.x0, fRectBX1 = pRectB.x1;
            var fRectBY0 = pRectB.y0, fRectBY1 = pRectB.y1;
            if ((fRectAX1 < fRectBX0 || fRectBX1 < fRectAX0) || (fRectAY1 < fRectBY0 || fRectAY1 < fRectBY0)) {
                return akra.EVolumeClassifications.NO_RELATION;
            }
            if ((fRectAX0 == fRectBX0 && fRectAX1 == fRectBX1) && (fRectAY0 == fRectBY0 && fRectAY1 == fRectBY1)) {
                return akra.EVolumeClassifications.EQUAL;
            }
            if ((fRectAX0 <= fRectBX0 && fRectBX1 <= fRectAX1) && (fRectAY0 <= fRectBY0 && fRectBY1 <= fRectAY1)) {
                return akra.EVolumeClassifications.A_CONTAINS_B;
            }
            if ((fRectBX0 <= fRectAX0 && fRectAX1 <= fRectBX1) && (fRectBY0 <= fRectAY0 && fRectAY1 <= fRectBY1)) {
                return akra.EVolumeClassifications.B_CONTAINS_A;
            }
            return akra.EVolumeClassifications.INTERSECTING;
        }
        geometry.classifyRect2d = classifyRect2d;
        ;
        function classifyRect3d(pRectA, pRectB) {
            var fRectAX0 = pRectA.x0, fRectAX1 = pRectA.x1;
            var fRectAY0 = pRectA.y0, fRectAY1 = pRectA.y1;
            var fRectAZ0 = pRectA.z0, fRectAZ1 = pRectA.z1;
            var fRectBX0 = pRectB.x0, fRectBX1 = pRectB.x1;
            var fRectBY0 = pRectB.y0, fRectBY1 = pRectB.y1;
            var fRectBZ0 = pRectB.z0, fRectBZ1 = pRectB.z1;
            if ((fRectAX1 < fRectBX0 || fRectBX1 < fRectAX0) || (fRectAY1 < fRectBY0 || fRectAY1 < fRectBY0) || (fRectAZ1 < fRectBZ0 || fRectAZ1 < fRectBZ0)) {
                return akra.EVolumeClassifications.NO_RELATION;
            }
            if ((fRectAX0 == fRectBX0 && fRectAX1 == fRectBX1) && (fRectAY0 == fRectBY0 && fRectAY1 == fRectBY1) && (fRectAZ0 == fRectBZ0 && fRectAZ1 == fRectBZ1)) {
                return akra.EVolumeClassifications.EQUAL;
            }
            if ((fRectAX0 <= fRectBX0 && fRectBX1 <= fRectAX1) && (fRectAY0 <= fRectBY0 && fRectBY1 <= fRectAY1) && (fRectAZ0 <= fRectBZ0 && fRectBZ1 <= fRectAZ1)) {
                return akra.EVolumeClassifications.A_CONTAINS_B;
            }
            if ((fRectBX0 <= fRectAX0 && fRectAX1 <= fRectBX1) && (fRectBY0 <= fRectAY0 && fRectAY1 <= fRectBY1) && (fRectBZ0 <= fRectAZ0 && fRectAZ1 <= fRectBZ1)) {
                return akra.EVolumeClassifications.B_CONTAINS_A;
            }
            return akra.EVolumeClassifications.INTERSECTING;
        }
        geometry.classifyRect3d = classifyRect3d;
        ;
        function classifyFrustumRect3d(pFrustum, pRect) {
            var kClassification;
            var isIntersect = false;
            kClassification = planeClassifyRect3d(pFrustum.leftPlane, pRect);
            if (kClassification == akra.EPlaneClassifications.PLANE_FRONT) {
                return akra.EVolumeClassifications.NO_RELATION;
            } else if (kClassification == akra.EPlaneClassifications.PLANE_INTERSECT) {
                isIntersect = true;
            }
            kClassification = planeClassifyRect3d(pFrustum.rightPlane, pRect);
            if (kClassification == akra.EPlaneClassifications.PLANE_FRONT) {
                return akra.EVolumeClassifications.NO_RELATION;
            } else if (kClassification == akra.EPlaneClassifications.PLANE_INTERSECT) {
                isIntersect = true;
            }
            kClassification = planeClassifyRect3d(pFrustum.topPlane, pRect);
            if (kClassification == akra.EPlaneClassifications.PLANE_FRONT) {
                return akra.EVolumeClassifications.NO_RELATION;
            } else if (kClassification == akra.EPlaneClassifications.PLANE_INTERSECT) {
                isIntersect = true;
            }
            kClassification = planeClassifyRect3d(pFrustum.bottomPlane, pRect);
            if (kClassification == akra.EPlaneClassifications.PLANE_FRONT) {
                return akra.EVolumeClassifications.NO_RELATION;
            } else if (kClassification == akra.EPlaneClassifications.PLANE_INTERSECT) {
                isIntersect = true;
            }
            kClassification = planeClassifyRect3d(pFrustum.nearPlane, pRect);
            if (kClassification == akra.EPlaneClassifications.PLANE_FRONT) {
                return akra.EVolumeClassifications.NO_RELATION;
            } else if (kClassification == akra.EPlaneClassifications.PLANE_INTERSECT) {
                isIntersect = true;
            }
            kClassification = planeClassifyRect3d(pFrustum.farPlane, pRect);
            if (kClassification == akra.EPlaneClassifications.PLANE_FRONT) {
                return akra.EVolumeClassifications.NO_RELATION;
            } else if (kClassification == akra.EPlaneClassifications.PLANE_INTERSECT) {
                isIntersect = true;
            }
            if (isIntersect) {
                return akra.EVolumeClassifications.INTERSECTING;
            } else {
                return akra.EVolumeClassifications.A_CONTAINS_B;
            }
        }
        geometry.classifyFrustumRect3d = classifyFrustumRect3d;
        ;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
;
var akra;
(function (akra) {
    (function (geometry) {
        var Frustum = (function () {
            function Frustum(pLeftPlane, pRightPlane, pTopPlane, pBottomPlane, pNearPlane, pFarPlane) {
                this._pFrustumVertices = null;
                this.leftPlane = new geometry.Plane3d();
                this.rightPlane = new geometry.Plane3d();
                this.topPlane = new geometry.Plane3d();
                this.bottomPlane = new geometry.Plane3d();
                this.nearPlane = new geometry.Plane3d();
                this.farPlane = new geometry.Plane3d();
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        this.set(arguments[0]);
                        break;
                    case 6:
                        this.set(arguments[0], arguments[1], arguments[2], arguments[3], arguments[4], arguments[5]);
                        break;
                    default:
                        break;
                }
            }
            Object.defineProperty(Frustum.prototype, "frustumVertices", {
                get: function () {
                    return this._pFrustumVertices;
                },
                enumerable: true,
                configurable: true
            });
            Frustum.prototype.set = function (pLeftPlane, pRightPlane, pTopPlane, pBottomPlane, pNearPlane, pFarPlane) {
                var nArgumentsLength = arguments.length;
                switch(nArgumentsLength) {
                    case 1:
                        var pFrustum = arguments[0];
                        this.leftPlane.set(pFrustum.leftPlane);
                        this.rightPlane.set(pFrustum.rightPlane);
                        this.topPlane.set(pFrustum.topPlane);
                        this.bottomPlane.set(pFrustum.bottomPlane);
                        this.nearPlane.set(pFrustum.nearPlane);
                        this.farPlane.set(pFrustum.farPlane);
                        break;
                    case 6:
                        this.leftPlane.set(arguments[0]);
                        this.rightPlane.set(arguments[1]);
                        this.topPlane.set(arguments[2]);
                        this.bottomPlane.set(arguments[3]);
                        this.nearPlane.set(arguments[4]);
                        this.farPlane.set(arguments[5]);
                        break;
                    default:
                        this.leftPlane.clear();
                        this.rightPlane.clear();
                        this.topPlane.clear();
                        this.bottomPlane.clear();
                        this.nearPlane.clear();
                        this.farPlane.clear();
                        break;
                }
                return this;
            };
            Frustum.prototype.calculateFrustumVertices = function () {
                if (this._pFrustumVertices == null) {
                    this._pFrustumVertices = new Array(8);
                    for(var i = 0; i < 8; i++) {
                        this._pFrustumVertices[i] = new akra.Vec3();
                    }
                }
                var v3fLeftNormal = this.leftPlane.normal;
                var v3fRightNormal = this.rightPlane.normal;
                var v3fTopNormal = this.topPlane.normal;
                var v3fBottomNormal = this.bottomPlane.normal;
                var v3fNearNormal = this.nearPlane.normal;
                var v3fFarNormal = this.farPlane.normal;
                var fLeft = -this.leftPlane.distance;
                var fRight = -this.rightPlane.distance;
                var fTop = -this.topPlane.distance;
                var fBottom = -this.bottomPlane.distance;
                var fNear = -this.nearPlane.distance;
                var fFar = -this.farPlane.distance;
                var m3fTemp = akra.mat3();
                var pFrustumVertices = this._pFrustumVertices;
                pFrustumVertices[0].set(fLeft, fBottom, fNear);
                m3fTemp.set(v3fLeftNormal.x, v3fBottomNormal.x, v3fNearNormal.x, v3fLeftNormal.y, v3fBottomNormal.y, v3fNearNormal.y, v3fLeftNormal.z, v3fBottomNormal.z, v3fNearNormal.z);
                m3fTemp.inverse().multiplyVec3(pFrustumVertices[0]);
                pFrustumVertices[1].set(fRight, fBottom, fNear);
                m3fTemp.set(v3fRightNormal.x, v3fBottomNormal.x, v3fNearNormal.x, v3fRightNormal.y, v3fBottomNormal.y, v3fNearNormal.y, v3fRightNormal.z, v3fBottomNormal.z, v3fNearNormal.z);
                m3fTemp.inverse().multiplyVec3(pFrustumVertices[1]);
                pFrustumVertices[2].set(fLeft, fTop, fNear);
                m3fTemp.set(v3fLeftNormal.x, v3fTopNormal.x, v3fNearNormal.x, v3fLeftNormal.y, v3fTopNormal.y, v3fNearNormal.y, v3fLeftNormal.z, v3fTopNormal.z, v3fNearNormal.z);
                m3fTemp.inverse().multiplyVec3(pFrustumVertices[2]);
                pFrustumVertices[3].set(fRight, fTop, fNear);
                m3fTemp.set(v3fRightNormal.x, v3fTopNormal.x, v3fNearNormal.x, v3fRightNormal.y, v3fTopNormal.y, v3fNearNormal.y, v3fRightNormal.z, v3fTopNormal.z, v3fNearNormal.z);
                m3fTemp.inverse().multiplyVec3(pFrustumVertices[3]);
                pFrustumVertices[4].set(fLeft, fBottom, fFar);
                m3fTemp.set(v3fLeftNormal.x, v3fBottomNormal.x, v3fFarNormal.x, v3fLeftNormal.y, v3fBottomNormal.y, v3fFarNormal.y, v3fLeftNormal.z, v3fBottomNormal.z, v3fFarNormal.z);
                m3fTemp.inverse().multiplyVec3(pFrustumVertices[4]);
                pFrustumVertices[5].set(fRight, fBottom, fFar);
                m3fTemp.set(v3fRightNormal.x, v3fBottomNormal.x, v3fFarNormal.x, v3fRightNormal.y, v3fBottomNormal.y, v3fFarNormal.y, v3fRightNormal.z, v3fBottomNormal.z, v3fFarNormal.z);
                m3fTemp.inverse().multiplyVec3(pFrustumVertices[5]);
                pFrustumVertices[6].set(fLeft, fTop, fFar);
                m3fTemp.set(v3fLeftNormal.x, v3fTopNormal.x, v3fFarNormal.x, v3fLeftNormal.y, v3fTopNormal.y, v3fFarNormal.y, v3fLeftNormal.z, v3fTopNormal.z, v3fFarNormal.z);
                m3fTemp.inverse().multiplyVec3(pFrustumVertices[6]);
                pFrustumVertices[7].set(fRight, fTop, fFar);
                m3fTemp.set(v3fRightNormal.x, v3fTopNormal.x, v3fFarNormal.x, v3fRightNormal.y, v3fTopNormal.y, v3fFarNormal.y, v3fRightNormal.z, v3fTopNormal.z, v3fFarNormal.z);
                m3fTemp.inverse().multiplyVec3(pFrustumVertices[7]);
                return pFrustumVertices;
            };
            Frustum.prototype.extractFromMatrix = function (m4fProjection, m4fWorld, pSearchRect) {
                if (this._pFrustumVertices == null) {
                    this._pFrustumVertices = new Array(8);
                    for(var i = 0; i < 8; i++) {
                        this._pFrustumVertices[i] = new akra.Vec3();
                    }
                }
                var pFrustumVertices = this._pFrustumVertices;
                var v4fLeftBottomNear = akra.vec4();
                var v4fRightBottomNear = akra.vec4();
                var v4fLeftTopNear = akra.vec4();
                var v4fRightTopNear = akra.vec4();
                var v4fLeftBottomFar = akra.vec4();
                var v4fRightBottomFar = akra.vec4();
                var v4fLeftTopFar = akra.vec4();
                var v4fRightTopFar = akra.vec4();
                m4fProjection.unproj(akra.vec3(-1, -1, -1), v4fLeftBottomNear);
                m4fProjection.unproj(akra.vec3(1, -1, -1), v4fRightBottomNear);
                m4fProjection.unproj(akra.vec3(-1, 1, -1), v4fLeftTopNear);
                m4fProjection.unproj(akra.vec3(1, 1, -1), v4fRightTopNear);
                m4fProjection.unproj(akra.vec3(-1, -1, 1), v4fLeftBottomFar);
                m4fProjection.unproj(akra.vec3(1, -1, 1), v4fRightBottomFar);
                m4fProjection.unproj(akra.vec3(-1, 1, 1), v4fLeftTopFar);
                m4fProjection.unproj(akra.vec3(1, 1, 1), v4fRightTopFar);
                if (((m4fWorld) !== undefined)) {
                    m4fWorld.multiplyVec4(v4fLeftBottomNear);
                    m4fWorld.multiplyVec4(v4fRightBottomNear);
                    m4fWorld.multiplyVec4(v4fLeftTopNear);
                    m4fWorld.multiplyVec4(v4fRightTopNear);
                    m4fWorld.multiplyVec4(v4fLeftBottomFar);
                    m4fWorld.multiplyVec4(v4fRightBottomFar);
                    m4fWorld.multiplyVec4(v4fLeftTopFar);
                    m4fWorld.multiplyVec4(v4fRightTopFar);
                }
                var v3fLeftBottomNear = pFrustumVertices[0].set(v4fLeftBottomNear.xyz);
                var v3fRightBottomNear = pFrustumVertices[1].set(v4fRightBottomNear.xyz);
                var v3fLeftTopNear = pFrustumVertices[2].set(v4fLeftTopNear.xyz);
                var v3fRightTopNear = pFrustumVertices[3].set(v4fRightTopNear.xyz);
                var v3fLeftBottomFar = pFrustumVertices[4].set(v4fLeftBottomFar.xyz);
                var v3fRightBottomFar = pFrustumVertices[5].set(v4fRightBottomFar.xyz);
                var v3fLeftTopFar = pFrustumVertices[6].set(v4fLeftTopFar.xyz);
                var v3fRightTopFar = pFrustumVertices[7].set(v4fRightTopFar.xyz);
                if (((pSearchRect) !== undefined)) {
                    pSearchRect.set(v3fLeftBottomNear, v3fLeftBottomNear);
                    pSearchRect.unionPoint(v3fRightBottomNear);
                    pSearchRect.unionPoint(v3fLeftTopNear);
                    pSearchRect.unionPoint(v3fRightTopNear);
                    pSearchRect.unionPoint(v3fLeftBottomFar);
                    pSearchRect.unionPoint(v3fRightBottomFar);
                    pSearchRect.unionPoint(v3fLeftTopFar);
                    pSearchRect.unionPoint(v3fRightTopFar);
                }
                this.leftPlane.set(v3fLeftTopNear, v3fLeftTopFar, v3fLeftBottomNear);
                this.rightPlane.set(v3fRightBottomFar, v3fRightTopFar, v3fRightBottomNear);
                this.topPlane.set(v3fLeftTopNear, v3fRightTopNear, v3fLeftTopFar);
                this.bottomPlane.set(v3fRightBottomFar, v3fRightBottomNear, v3fLeftBottomFar);
                this.nearPlane.set(v3fLeftTopNear, v3fLeftBottomNear, v3fRightTopNear);
                this.farPlane.set(v3fRightBottomFar, v3fLeftBottomFar, v3fRightTopFar);
                return this;
            };
            Frustum.prototype.isEqual = function (pFrustum) {
                return (this.leftPlane.isEqual(pFrustum.leftPlane) && this.rightPlane.isEqual(pFrustum.rightPlane) && this.topPlane.isEqual(pFrustum.topPlane) && this.bottomPlane.isEqual(pFrustum.bottomPlane) && this.nearPlane.isEqual(pFrustum.nearPlane) && this.farPlane.isEqual(pFrustum.farPlane));
            };
            Frustum.prototype.getPlanePoints = function (sPlaneKey, pDestination) {
                if (arguments.length == 1) {
                    pDestination = [
                        akra.vec3(), 
                        akra.vec3(), 
                        akra.vec3(), 
                        akra.vec3()
                    ];
                }
                var pFrustumVertices = this.frustumVertices;
                if (pFrustumVertices === null) {
                    pFrustumVertices = this.calculateFrustumVertices();
                }
                switch(sPlaneKey) {
                    case "leftPlane":
                        pDestination[0].set(pFrustumVertices[6]);
                        pDestination[1].set(pFrustumVertices[4]);
                        pDestination[2].set(pFrustumVertices[0]);
                        pDestination[3].set(pFrustumVertices[2]);
                        break;
                    case "rightPlane":
                        pDestination[0].set(pFrustumVertices[7]);
                        pDestination[1].set(pFrustumVertices[3]);
                        pDestination[2].set(pFrustumVertices[1]);
                        pDestination[3].set(pFrustumVertices[5]);
                        break;
                    case "topPlane":
                        pDestination[0].set(pFrustumVertices[7]);
                        pDestination[1].set(pFrustumVertices[6]);
                        pDestination[2].set(pFrustumVertices[2]);
                        pDestination[3].set(pFrustumVertices[3]);
                        break;
                    case "bottomPlane":
                        pDestination[0].set(pFrustumVertices[5]);
                        pDestination[1].set(pFrustumVertices[1]);
                        pDestination[2].set(pFrustumVertices[0]);
                        pDestination[3].set(pFrustumVertices[4]);
                        break;
                    case "nearPlane":
                        pDestination[0].set(pFrustumVertices[3]);
                        pDestination[1].set(pFrustumVertices[2]);
                        pDestination[2].set(pFrustumVertices[0]);
                        pDestination[3].set(pFrustumVertices[1]);
                        break;
                    case "farPlane":
                        pDestination[0].set(pFrustumVertices[7]);
                        pDestination[1].set(pFrustumVertices[5]);
                        pDestination[2].set(pFrustumVertices[4]);
                        pDestination[3].set(pFrustumVertices[6]);
                        break;
                    default:
 {
                            akra.logger.setSourceLocation("geometry/Frustum.ts", 324);
                            akra.logger.assert(false, "invalid plane key");
                        }
                        ;
                        break;
                }
                return pDestination;
            };
            Frustum.prototype.testPoint = function (v3fPoint) {
                if (this.leftPlane.signedDistance(v3fPoint) > 0. || this.rightPlane.signedDistance(v3fPoint) > 0. || this.topPlane.signedDistance(v3fPoint) > 0. || this.bottomPlane.signedDistance(v3fPoint) > 0. || this.nearPlane.signedDistance(v3fPoint) > 0. || this.farPlane.signedDistance(v3fPoint) > 0.) {
                    return false;
                }
                return true;
            };
            Frustum.prototype.testRect = function (pRect) {
                if (geometry.planeClassifyRect3d(this.leftPlane, pRect) == akra.EPlaneClassifications.PLANE_FRONT || geometry.planeClassifyRect3d(this.rightPlane, pRect) == akra.EPlaneClassifications.PLANE_FRONT || geometry.planeClassifyRect3d(this.topPlane, pRect) == akra.EPlaneClassifications.PLANE_FRONT || geometry.planeClassifyRect3d(this.bottomPlane, pRect) == akra.EPlaneClassifications.PLANE_FRONT || geometry.planeClassifyRect3d(this.nearPlane, pRect) == akra.EPlaneClassifications.PLANE_FRONT || geometry.planeClassifyRect3d(this.farPlane, pRect) == akra.EPlaneClassifications.PLANE_FRONT) {
                    return false;
                }
                return true;
            };
            Frustum.prototype.testSphere = function (pSphere) {
                if (geometry.planeClassifySphere(this.leftPlane, pSphere) == akra.EPlaneClassifications.PLANE_FRONT || geometry.planeClassifySphere(this.rightPlane, pSphere) == akra.EPlaneClassifications.PLANE_FRONT || geometry.planeClassifySphere(this.topPlane, pSphere) == akra.EPlaneClassifications.PLANE_FRONT || geometry.planeClassifySphere(this.bottomPlane, pSphere) == akra.EPlaneClassifications.PLANE_FRONT || geometry.planeClassifySphere(this.nearPlane, pSphere) == akra.EPlaneClassifications.PLANE_FRONT || geometry.planeClassifySphere(this.farPlane, pSphere) == akra.EPlaneClassifications.PLANE_FRONT) {
                    return false;
                }
                return true;
            };
            Frustum.prototype.testFrustum = function (pFrustum) {
                var pFrustumVertices1 = this.frustumVertices;
                var pFrustumVertices2 = pFrustum.frustumVertices;
                if (pFrustumVertices1 == null) {
                    pFrustumVertices1 = this.calculateFrustumVertices();
                }
                if (pFrustumVertices2 == null) {
                    pFrustumVertices2 = pFrustum.calculateFrustumVertices();
                }
                var pFrustumPlanes = Frustum.frustumPlanesKeys;
                var nTest;
                for(var i = 0; i < 6; i++) {
                    var pPlane = this[pFrustumPlanes[i]];
                    nTest = 0;
                    for(var j = 0; j < 8; j++) {
                        if (pPlane.signedDistance(pFrustumVertices2[j]) > 0) {
                            nTest++;
                        }
                    }
                    if (nTest == 8) {
                        return false;
                    }
                }
                for(var i = 0; i < 6; i++) {
                    var pPlane = pFrustum[pFrustumPlanes[i]];
                    nTest = 0;
                    for(var j = 0; j < 8; j++) {
                        if (pPlane.signedDistance(pFrustumVertices1[j]) > 0) {
                            nTest++;
                        }
                    }
                    if (nTest == 8) {
                        return false;
                    }
                }
                return true;
            };
            Frustum.frustumPlanesKeys = [
                "leftPlane", 
                "rightPlane", 
                "topPlane", 
                "bottomPlane", 
                "nearPlane", 
                "farPlane"
            ];
            return Frustum;
        })();
        geometry.Frustum = Frustum;        
        ;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        (function (objects) {
            (function (ECameraFlags) {
                ECameraFlags._map = [];
                ECameraFlags.k_NewProjectionMatrix = 0;
                ECameraFlags._map[1] = "k_NewProjectionParams";
                ECameraFlags.k_NewProjectionParams = 1;
            })(objects.ECameraFlags || (objects.ECameraFlags = {}));
            var ECameraFlags = objects.ECameraFlags;
            var DLTechnique = (function () {
                function DLTechnique(pList, pCamera) {
                    this._pPrevResult = null;
                    this.list = pList;
                    this.camera = pCamera;
                }
                DLTechnique.prototype.findObjects = function (pResultArray, bQuickSearch) {
                    if (typeof bQuickSearch === "undefined") { bQuickSearch = false; }
                    var pResult = this.list._findObjects(this.camera, pResultArray, bQuickSearch && ((this._pPrevResult) != null));
                    if (((this._pPrevResult) === null)) {
                        this._pPrevResult = pResult;
                    }
                    return this._pPrevResult;
                };
                return DLTechnique;
            })();
            objects.DLTechnique = DLTechnique;            
            var Camera = (function (_super) {
                __extends(Camera, _super);
                function Camera(pScene, eType) {
                    if (typeof eType === "undefined") { eType = akra.EEntityTypes.CAMERA; }
                                _super.call(this, pScene, eType);
                    this._eCameraType = akra.ECameraTypes.PERSPECTIVE;
                    this._iCameraOptions = 0;
                    this._iUpdateProjectionFlags = 0;
                    this._m4fView = new akra.Mat4();
                    this._m4fProj = new akra.Mat4();
                    this._m4fProjView = new akra.Mat4();
                    this._m4fRenderStageProj = new akra.Mat4();
                    this._m4fRenderStageProjView = new akra.Mat4();
                    this._pSearchRect = new akra.geometry.Rect3d();
                    this._v3fTargetPos = new akra.Vec3();
                    this._fFOV = akra.math.PI / 5.;
                    this._fAspect = 4. / 3.;
                    this._fNearPlane = 0.1;
                    this._fFarPlane = 500.;
                    this._fWidth = 0.;
                    this._fHeight = 0.;
                    this._fMinX = 0.;
                    this._fMaxX = 0.;
                    this._fMinY = 0.;
                    this._fMaxY = 0.;
                    this._pFrustum = new akra.geometry.Frustum();
                    this._pLastViewport = null;
                    this._pDLTechniques = [];
                    this._pDLResultStorage = [];
                }
                Object.defineProperty(Camera.prototype, "viewMatrix", {
                    get: function () {
                        return this._m4fView;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Camera.prototype, "projectionMatrix", {
                    get: function () {
                        return this._m4fProj;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Camera.prototype, "projViewMatrix", {
                    get: function () {
                        return this._m4fProjView;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Camera.prototype, "targetPos", {
                    get: function () {
                        return this._v3fTargetPos;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Camera.prototype, "fov", {
                    get: function () {
                        return this._fFOV;
                    },
                    set: function (fFOV) {
                        this._fFOV = fFOV;
                        ((this._iUpdateProjectionFlags) |= (1 << (ECameraFlags.k_NewProjectionParams)));
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Camera.prototype, "aspect", {
                    get: function () {
                        return this._fAspect;
                    },
                    set: function (fAspect) {
                        this._fAspect = fAspect;
                        ((this._iUpdateProjectionFlags) |= (1 << (ECameraFlags.k_NewProjectionParams)));
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Camera.prototype, "nearPlane", {
                    get: function () {
                        return this._fNearPlane;
                    },
                    set: function (fNearPlane) {
                        this._fNearPlane = fNearPlane;
                        ((this._iUpdateProjectionFlags) |= (1 << (ECameraFlags.k_NewProjectionParams)));
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Camera.prototype, "farPlane", {
                    get: function () {
                        return this._fFarPlane;
                    },
                    set: function (fFarPlane) {
                        this._fFarPlane = fFarPlane;
                        ((this._iUpdateProjectionFlags) |= (1 << (ECameraFlags.k_NewProjectionParams)));
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Camera.prototype, "viewDistance", {
                    get: function () {
                        return this._fFarPlane - this._fNearPlane;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Camera.prototype, "searchRect", {
                    get: function () {
                        return this._pSearchRect;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Camera.prototype, "frustum", {
                    get: function () {
                        return this._pFrustum;
                    },
                    enumerable: true,
                    configurable: true
                });
                Camera.prototype.create = function () {
                    var isOK = _super.prototype.create.call(this);
                    if (isOK) {
                        this._v3fTargetPos.set(this._m4fLocalMatrix.data[8], this._m4fLocalMatrix.data[9], this._m4fLocalMatrix.data[10]);
                        this._v3fTargetPos.negate();
                        this.recalcProjMatrix();
                        this.recalcMatrices();
                        var pScene = this._pScene;
                        this.connect(pScene, "displayListAdded", "_addDisplayList");
                        this.connect(pScene, "displayListRemoved", "_removeDisplayList");
                        for(var i = 0; i < pScene.totalDL; ++i) {
                            var pList = pScene.getDisplayList(i);
                            if (!((pList) === null)) {
                                this._addDisplayList(pScene, pList, i);
                            }
                        }
                    }
                    return isOK;
                };
                Camera.prototype.isProjParamsNew = function () {
                    return ((this._iUpdateProjectionFlags & (1 << (ECameraFlags.k_NewProjectionParams))) != 0);
                };
                Camera.prototype.recalcProjMatrix = function () {
                    this.setProjParams(this._fFOV, this._fAspect, this._fNearPlane, this._fFarPlane);
                };
                Camera.prototype.prepareForUpdate = function () {
                    _super.prototype.prepareForUpdate.call(this);
                };
                Camera.prototype.display = function (iList) {
                    if (typeof iList === "undefined") { iList = 0; }
                    var pObjects = this._pDLTechniques[iList].findObjects(this._pDLResultStorage[iList], !this.isUpdated());
                    return pObjects;
                };
                Camera.prototype.setParameter = function (eParam, pValue) {
                    if (eParam === akra.ECameraParameters.CONST_ASPECT && pValue) {
                        ((this._iCameraOptions) |= (eParam));
                    }
                };
                Camera.prototype.isConstantAspect = function () {
                    return (((this._iCameraOptions) & (akra.ECameraParameters.CONST_ASPECT)) != 0);
                };
                Camera.prototype.setProjParams = function (fFOV, fAspect, fNearPlane, fFarPlane) {
                    this._fFOV = fFOV;
                    this._fAspect = fAspect;
                    this._fNearPlane = fNearPlane;
                    this._fFarPlane = fFarPlane;
                    this._eCameraType = akra.ECameraTypes.PERSPECTIVE;
                    akra.Mat4.perspective(fFOV, fAspect, fNearPlane, fFarPlane, this._m4fProj);
                    ((this._iUpdateProjectionFlags) |= (1 << (ECameraFlags.k_NewProjectionMatrix)));
                };
                Camera.prototype.setOrthoParams = function (fWidth, fHeight, fNearPlane, fFarPlane) {
 {
                        akra.logger.setSourceLocation("scene/objects/Camera.ts", 230);
                        akra.logger.criticalError("TODO: setOrthoParams();");
                    }
                    ;
                };
                Camera.prototype.setOffsetOrthoParams = function (fMinX, fMaxX, fMinY, fMaxY, fNearPlane, fFarPlane) {
                    this._fMinX = fMinX;
                    this._fMaxX = fMaxX;
                    this._fMinY = fMinY;
                    this._fMaxY = fMaxY;
                    this._fNearPlane = fNearPlane;
                    this._fFarPlane = fFarPlane;
                    this._eCameraType = akra.ECameraTypes.OFFSET_ORTHO;
                    akra.Mat4.orthogonalProjectionAsymmetric(fMinX, fMaxX, fMinY, fMaxY, fNearPlane, fFarPlane, this._m4fProj);
                    ((this._iUpdateProjectionFlags) |= (1 << (ECameraFlags.k_NewProjectionMatrix)));
                };
                Camera.prototype.recalcMatrices = function () {
                    this._v3fTargetPos.set(this._m4fLocalMatrix.data[8], this._m4fLocalMatrix.data[9], this._m4fLocalMatrix.data[10]);
                    this._v3fTargetPos.negate();
                    this._m4fView.set(this.inverseWorldMatrix);
                };
                Camera.prototype.update = function () {
                    var isUpdated = _super.prototype.update.call(this);
                    if (this.isProjParamsNew()) {
                        this.recalcProjMatrix();
                    }
                    if (this.isWorldMatrixNew() || ((this._iUpdateProjectionFlags & (1 << (ECameraFlags.k_NewProjectionMatrix))) != 0)) {
                        this._pFrustum.extractFromMatrix(this._m4fProj, this._m4fWorldMatrix, this._pSearchRect);
                        if (this.isWorldMatrixNew()) {
                            this.recalcMatrices();
                        }
                        this._m4fProj.multiply(this._m4fView, this._m4fProjView);
                        isUpdated = true;
                        ((this._iUpdateProjectionFlags) &= ~(1 << (ECameraFlags.k_NewProjectionMatrix)));
                    }
                    return isUpdated;
                };
                Camera.prototype.lookAt = function (v3f) {
                    var v3fFrom, v3fCenter, v3fUp;
                    if (arguments.length < 3) {
                        v3fFrom = this.worldPosition;
                        v3fCenter = arguments[0];
                        v3fUp = arguments[1];
                    } else {
                        v3fFrom = arguments[0];
                        v3fCenter = arguments[1];
                        v3fUp = arguments[2];
                    }
                    v3fUp = v3fUp || akra.vec3(0., 1., 0.);
                    var v3fParentPos = (this.parent).worldPosition;
                    var m4fTemp = akra.Mat4.lookAt(v3fFrom, v3fCenter, v3fUp, akra.mat4()).inverse();
                    var pData = m4fTemp.data;
                    switch(this._eInheritance) {
                        case akra.ENodeInheritance.ALL:
                            (this._pParent).inverseWorldMatrix.multiply(m4fTemp, m4fTemp);
                            m4fTemp.toQuat4(this._qRotation);
                            this.setPosition(pData[12], pData[13], pData[14]);
                            break;
                        case akra.ENodeInheritance.ROTSCALE:
                            var m3fTemp = m4fTemp.toMat3();
                            m3fTemp = (this._pParent).inverseWorldMatrix.toMat3().multiply(m3fTemp, akra.mat3());
                            m3fTemp.toQuat4(this._qRotation);
                            this.setPosition(pData[12], pData[13], pData[14]);
                            break;
                        default:
                            m4fTemp.toQuat4(this._qRotation);
                            this.setPosition(pData[12] - v3fParentPos.x, pData[13] - v3fParentPos.y, pData[14] - v3fParentPos.z);
                    }
                };
                Camera.prototype._renderScene = function (pViewport) {
                    this.preRenderScene();
                    pViewport.update();
                    this.postRenderScene();
                };
                Camera.prototype._keepLastViewport = function (pViewport) {
                    this._pLastViewport = pViewport;
                };
                Camera.prototype._getLastViewport = function () {
                    return this._pLastViewport;
                };
                Camera.prototype._getNumRenderedFaces = function () {
                    return 0;
                };
                Camera.prototype._notifyRenderedFaces = function (nFaces) {
                };
                Camera.prototype.toString = function (isRecursive, iDepth) {
                    if (typeof isRecursive === "undefined") { isRecursive = false; }
                    if (typeof iDepth === "undefined") { iDepth = 0; }
                    if (!isRecursive) {
                        return "<camera" + (this._sName ? " " + this._sName : "") + ">";
                    }
                    return _super.prototype.toString.call(this, isRecursive, iDepth);
                };
                Camera.prototype._addDisplayList = function (pScene, pList, index) {
                    this._pDLTechniques[index] = new DLTechnique(pList, this);
                    this._pDLResultStorage[index] = new akra.util.ObjectArray();
                };
                Camera.prototype._removeDisplayList = function (pScene, pList, index) {
                    this._pDLTechniques[index] = null;
                    this._pDLResultStorage[index] = null;
                };
                Camera.prototype.preRenderScene = function () {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).preRenderScene;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                        }
                    }
                };
                Camera.prototype.postRenderScene = function () {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).postRenderScene;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                        }
                    }
                };
                return Camera;
            })(scene.SceneNode);
            objects.Camera = Camera;            
            function isCamera(pNode) {
                return pNode.type >= akra.EEntityTypes.CAMERA && pNode.type <= akra.EEntityTypes.SHADOW_CASTER;
            }
            objects.isCamera = isCamera;
        })(scene.objects || (scene.objects = {}));
        var objects = scene.objects;
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        (function (light) {
            var ShadowCaster = (function (_super) {
                __extends(ShadowCaster, _super);
                function ShadowCaster(pLightPoint, iFace) {
                    if (typeof iFace === "undefined") { iFace = akra.ECubeFace.POSITIVE_X; }
                                _super.call(this, pLightPoint.scene, akra.EEntityTypes.SHADOW_CASTER);
                    this._pLightPoint = null;
                    this._iFace = 0;
                    this._pAffectedObjects = new akra.util.ObjectArray();
                    this._m4fOptimizedProj = new akra.Mat4();
                    this._isShadowCasted = false;
                    this._pLightPoint = pLightPoint;
                    this._iFace = iFace;
                }
                Object.defineProperty(ShadowCaster.prototype, "lightPoint", {
                    get: function () {
                        return this._pLightPoint;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ShadowCaster.prototype, "face", {
                    get: function () {
                        return this._iFace;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ShadowCaster.prototype, "affectedObjects", {
                    get: function () {
                        return this._pAffectedObjects;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ShadowCaster.prototype, "optimizedProjection", {
                    get: function () {
                        return this._m4fOptimizedProj;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ShadowCaster.prototype, "isShadowCasted", {
                    get: function () {
                        return this._isShadowCasted;
                    },
                    set: function (isShadowCasted) {
                        this._isShadowCasted = isShadowCasted;
                    },
                    enumerable: true,
                    configurable: true
                });
                ShadowCaster.prototype._optimizeProjectionMatrix = function () {
                    var m4fView = this.viewMatrix;
                    var m4fProj = this.projectionMatrix;
                    var m4fProjData = m4fProj.data;
                    var pBox = akra.geometry.Rect3d.stackCeil;
                    var pAffectedObjects = this._pAffectedObjects;
                    if (pAffectedObjects.length == 0) {
                        this._m4fOptimizedProj.set(m4fProj);
                        return;
                    }
                    var fX0, fX1, fY0, fY1, fZ0, fZ1;
                    var fX, fY, fZ, fW;
                    var fX_LBN, fY_LBN;
                    var fX_RTN, fY_RTN;
                    var fZ_Near, fZ_Far;
                    var fXRes_LBN = 1., fXRes_RTN = -1, fYRes_LBN = 1, fYRes_RTN = -1, fZRes_Near = 1, fZRes_Far = -1;
                    for(var i = 0; i < pAffectedObjects.length; i++) {
                        var pObject = pAffectedObjects.value(i);
                        if (!pObject.hasShadow) {
                            continue;
                        }
                        pBox.set(pObject.worldBounds);
                        pBox.transform(m4fView);
                        fX0 = pBox.x0;
                        fX1 = pBox.x1;
                        fY0 = pBox.y0;
                        fY1 = pBox.y1;
                        fZ0 = pBox.z0;
                        fZ1 = pBox.z1;
                        fX = m4fProjData[0] * fX0 + m4fProjData[4] * fY0 + m4fProjData[8] * fZ1 + m4fProjData[12];
                        fY = m4fProjData[1] * fX0 + m4fProjData[5] * fY0 + m4fProjData[9] * fZ1 + m4fProjData[13];
                        fZ = m4fProjData[2] * fX0 + m4fProjData[6] * fY0 + m4fProjData[10] * fZ1 + m4fProjData[14];
                        fW = m4fProjData[3] * fX0 + m4fProjData[7] * fY0 + m4fProjData[11] * fZ1 + m4fProjData[15];
                        if (fW <= 0) {
                            fX = -1;
                            fY = -1;
                            fZ = -1;
                            fW = 1;
                        }
                        fX_LBN = fX / fW;
                        fY_LBN = fY / fW;
                        fZ_Near = fZ / fW;
                        fX = m4fProjData[0] * fX1 + m4fProjData[4] * fY1 + m4fProjData[8] * fZ1 + m4fProjData[12];
                        fY = m4fProjData[1] * fX1 + m4fProjData[5] * fY1 + m4fProjData[9] * fZ1 + m4fProjData[13];
                        fW = m4fProjData[3] * fX1 + m4fProjData[7] * fY1 + m4fProjData[11] * fZ1 + m4fProjData[15];
                        if (fW <= 0) {
                            fX = 1;
                            fY = 1;
                            fW = 1;
                        }
                        fX_RTN = fX / fW;
                        fY_RTN = fY / fW;
                        fZ = m4fProjData[2] * fX0 + m4fProjData[6] * fY0 + m4fProjData[10] * fZ0 + m4fProjData[14];
                        fW = m4fProjData[3] * fX0 + m4fProjData[7] * fY0 + m4fProjData[11] * fZ0 + m4fProjData[15];
                        fZ_Far = fZ / fW;
                        fXRes_LBN = (fX_LBN < fXRes_LBN) ? fX_LBN : fXRes_LBN;
                        fXRes_RTN = (fX_RTN > fXRes_RTN) ? fX_RTN : fXRes_RTN;
                        fYRes_LBN = (fY_LBN < fYRes_LBN) ? fY_LBN : fYRes_LBN;
                        fYRes_RTN = (fY_RTN > fYRes_RTN) ? fY_RTN : fYRes_RTN;
                        fZRes_Near = (fZ_Near < fZRes_Near) ? fZ_Near : fZRes_Near;
                        fZRes_Far = (fZ_Far > fZRes_Far) ? fZ_Far : fZRes_Far;
                    }
                    fXRes_LBN = (fXRes_LBN < -1 || fXRes_LBN == 1) ? -1 : fXRes_LBN;
                    fXRes_RTN = (fXRes_RTN > 1 || fXRes_RTN == -1) ? 1 : fXRes_RTN;
                    fYRes_LBN = (fYRes_LBN < -1 || fYRes_LBN == 1) ? -1 : fYRes_LBN;
                    fYRes_RTN = (fYRes_RTN > 1 || fYRes_RTN == -1) ? 1 : fYRes_RTN;
                    fZRes_Near = (fZRes_Near < -1 || fZRes_Near == 1) ? -1 : fZRes_Near;
                    fZRes_Far = (fZRes_Far > 1 || fZRes_Far == -1) ? 1 : fZRes_Far;
                    var v4fTmp1 = m4fProj.unproj(akra.vec3(fXRes_LBN, fYRes_LBN, fZRes_Near), akra.vec4());
                    var v4fTmp2 = m4fProj.unproj(akra.vec3(fXRes_RTN, fYRes_RTN, fZRes_Near), akra.vec4());
                    var fXLeft = v4fTmp1.x;
                    var fXRight = v4fTmp2.x;
                    var fYBottom = v4fTmp1.y;
                    var fYTop = v4fTmp2.y;
                    var fZNear = v4fTmp1.z;
                    var fZFar = m4fProj.unprojZ(fZRes_Far);
                    if (m4fProj.isOrthogonalProjection()) {
                        akra.Mat4.orthogonalProjectionAsymmetric(fXLeft, fXRight, fYBottom, fYTop, -fZNear, -fZFar, this._m4fOptimizedProj);
                    } else {
                        akra.Mat4.frustum(fXLeft, fXRight, fYBottom, fYTop, -fZNear, -fZFar, this._m4fOptimizedProj);
                    }
                };
                return ShadowCaster;
            })(scene.objects.Camera);
            light.ShadowCaster = ShadowCaster;            
            function isShadowCaster(pEntity) {
                return !((pEntity) === null) && pEntity.type === akra.EEntityTypes.SHADOW_CASTER;
            }
            light.isShadowCaster = isShadowCaster;
        })(scene.light || (scene.light = {}));
        var light = scene.light;
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var ShadowViewport = (function (_super) {
            __extends(ShadowViewport, _super);
            function ShadowViewport(pCamera, pTarget, csRenderMethod, fLeft, fTop, fWidth, fHeight, iZIndex) {
                if (typeof csRenderMethod === "undefined") { csRenderMethod = ".prepare-shadows"; }
                if (typeof fLeft === "undefined") { fLeft = 0.; }
                if (typeof fTop === "undefined") { fTop = 0.; }
                if (typeof fWidth === "undefined") { fWidth = 1.; }
                if (typeof fHeight === "undefined") { fHeight = 1.; }
                if (typeof iZIndex === "undefined") { iZIndex = 0; }
                        _super.call(this, pCamera, pTarget, csRenderMethod, fLeft, fTop, fWidth, fHeight, iZIndex);
                this.setClearEveryFrame(true, akra.EFrameBufferTypes.DEPTH);
                this.setDepthParams(true, true, akra.ECompareFunction.LESS);
                this.depthClear = 1.;
                this._csDefaultRenderMethod = ".prepare-shadows";
            }
            ShadowViewport.prototype._updateImpl = function () {
                var pShadowCaster = this._pCamera;
                var pAffectedObjects = pShadowCaster.affectedObjects;
                var pRenderable;
                var pSceneObject;
                var nShadowsCasted = 0;
                for(var i = 0; i < pAffectedObjects.length; i++) {
                    pSceneObject = pAffectedObjects.value(i);
                    if (pSceneObject.hasShadow) {
                        for(var j = 0; j < pSceneObject.totalRenderable; j++) {
                            pRenderable = pSceneObject.getRenderable(j);
                            if (!((pRenderable) === null) && pRenderable.hasShadow) {
                                this.prepareRenderableForShadows(pRenderable);
                                pRenderable.render(this, this._csDefaultRenderMethod, pSceneObject);
                                nShadowsCasted++;
                            }
                        }
                    }
                }
                pShadowCaster.isShadowCasted = (nShadowsCasted > 0) ? true : false;
            };
            ShadowViewport.prototype.prepareRenderableForShadows = function (pRenderable) {
                var pRenderTechnique = pRenderable.getTechnique(this._csDefaultRenderMethod);
                if (!((pRenderTechnique) === null)) {
                    return;
                }
                var pRmgr = this.getTarget().getRenderer().getEngine().getResourceManager();
                var pMethodPool = pRmgr.renderMethodPool;
                var pMethod = pMethodPool.findResource(".method-prepare-shadows");
                if (((pMethod) === null)) {
                    pMethod = pRmgr.createRenderMethod(".method-prepare-shadows");
                    pMethod.effect = pRmgr.createEffect(".effect-prepare-shadows");
                    pMethod.effect.addComponent("akra.system.prepareShadows");
                }
                pRenderable.addRenderMethod(pMethod, this._csDefaultRenderMethod);
            };
            return ShadowViewport;
        })(render.Viewport);
        render.ShadowViewport = ShadowViewport;        
        ;
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var RenderableObject = (function () {
            function RenderableObject(eType) {
                if (typeof eType === "undefined") { eType = akra.ERenderDataTypes.UNKNOWN; }
                this._pRenderData = null;
                this._pTechnique = null;
                this._pTechniqueMap = {};
                this._bShadow = true;
                this._bVisible = true;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._eRenderableType = eType;
            }
            Object.defineProperty(RenderableObject.prototype, "type", {
                get: function () {
                    return this._eRenderableType;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderableObject.prototype, "renderMethod", {
                get: function () {
                    return this._pTechnique.getMethod();
                },
                set: function (pMethod) {
                    this.switchRenderMethod(pMethod);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderableObject.prototype, "effect", {
                get: function () {
                    return this._pTechnique.getMethod().effect;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderableObject.prototype, "surfaceMaterial", {
                get: function () {
                    return this._pTechnique.getMethod().surfaceMaterial;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderableObject.prototype, "material", {
                get: function () {
                    return this.surfaceMaterial.material;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderableObject.prototype, "data", {
                get: function () {
                    return this._pRenderData;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderableObject.prototype, "hasShadow", {
                get: function () {
                    return this._bShadow;
                },
                set: function (bShadow) {
                    if (this._bShadow !== bShadow) {
                        this._bShadow = bShadow;
                        this.shadow(bShadow);
                    }
                },
                enumerable: true,
                configurable: true
            });
            RenderableObject.prototype._setRenderData = function (pData) {
                this._pRenderData = pData;
            };
            RenderableObject.prototype._setup = function (pRenderer, csDefaultMethod) {
                if (typeof csDefaultMethod === "undefined") { csDefaultMethod = null; }
                this._pRenderer = pRenderer;
                if (!this.addRenderMethod(csDefaultMethod) || this.switchRenderMethod(null) === false) {
 {
                        akra.logger.setSourceLocation("RenderableObject.ts", 69);
                        akra.logger.criticalError("cannot add & switch render method to default");
                    }
                    ;
                }
            };
            RenderableObject.prototype.getRenderer = function () {
                return this._pRenderer;
            };
            RenderableObject.prototype.destroy = function () {
                this._pRenderer = null;
                this._pTechnique = null;
                for(var i in this._pTechniqueMap) {
                    this._pTechniqueMap[i].destroy();
                }
                this._pTechniqueMap = null;
            };
            RenderableObject.prototype.addRenderMethod = function (csMethod, csName) {
                if (typeof csName === "undefined") { csName = "default"; }
                var pTechnique = new render.RenderTechnique();
                var pRmgr = this.getRenderer().getEngine().getResourceManager();
                var pMethod = null;
                if (((csMethod) === null)) {
                    csMethod = "default";
                }
                if ((typeof (arguments[0]) === "string") || arguments.length === 0) {
                    pMethod = pRmgr.createRenderMethod((csMethod) + this.getGuid());
                    if (!((pMethod) != null)) {
                        return false;
                    }
                    pMethod.surfaceMaterial = pRmgr.createSurfaceMaterial(csMethod + ".material." + this.getGuid());
                    pMethod.effect = pRmgr.createEffect(csMethod + ".effect." + this.getGuid());
                } else {
                    pMethod = arguments[0];
                }
 {
                    akra.logger.setSourceLocation("RenderableObject.ts", 116);
                    akra.logger.assert(pMethod.getManager().getEngine().getRenderer() === this._pRenderer, "Render method should belong to the same engine instance that the renderable object.");
                }
                ;
                pTechnique.setMethod(pMethod);
                this._pTechniqueMap[csName || "default"] = pTechnique;
                return true;
            };
            RenderableObject.prototype.switchRenderMethod = function (csName) {
                var pTechnique;
                var sName = null;
                if (((arguments[0]) === null)) {
                    sName = "default";
                } else if ((typeof (arguments[0]) === "string")) {
                    sName = csName;
                } else if (((arguments[0]) != null)) {
                    sName = (arguments[0]).findResourceName();
                    if (!((this._pTechniqueMap[sName]) != null)) {
                        if (!this.addRenderMethod(arguments[0], sName)) {
                            return false;
                        }
                    }
                }
                pTechnique = this._pTechniqueMap[sName];
                if (((pTechnique) != null)) {
                    this._pTechnique = pTechnique;
                    return true;
                }
                return false;
            };
            RenderableObject.prototype.removeRenderMethod = function (csName) {
                var pTechnique = this._pTechniqueMap[csName];
                if (((pTechnique) != null)) {
                    delete this._pTechniqueMap[csName || "default"];
                    return true;
                }
                return false;
            };
            RenderableObject.prototype.getRenderMethod = function (csName) {
                if (typeof csName === "undefined") { csName = null; }
                var pTechnique = this._pTechniqueMap[csName || "default"];
                return pTechnique ? pTechnique.getMethod() : null;
            };
            RenderableObject.prototype.getRenderMethodDefault = function () {
                return this.getRenderMethod("default");
            };
            RenderableObject.prototype.isReadyForRender = function () {
                return this._bVisible && this._pTechnique.isReady();
            };
            RenderableObject.prototype.isAllMethodsLoaded = function () {
                for(var i in this._pTechniqueMap) {
                    var pMethod = this._pTechniqueMap[i].getMethod();
                    if (!((pMethod) != null) || !pMethod.isResourceLoaded()) {
                        return false;
                    }
                }
                return true;
            };
            RenderableObject.prototype.render = function (pViewport, csMethod, pSceneObject) {
                if (typeof csMethod === "undefined") { csMethod = null; }
                if (typeof pSceneObject === "undefined") { pSceneObject = null; }
                this.beforeRender(pViewport);
                if (!this.isReadyForRender()) {
                    return;
                }
                if (!this.switchRenderMethod(csMethod)) {
                    return;
                }
                this.data._draw(this._pTechnique, pViewport, this, pSceneObject);
            };
            RenderableObject.prototype.getTechnique = function (sName) {
                if (typeof sName === "undefined") { sName = "default"; }
                return this._pTechniqueMap[sName] || null;
            };
            RenderableObject.prototype.getTechniqueDefault = function () {
                return this.getTechnique("default");
            };
            RenderableObject.prototype._draw = function () {
 {
                    akra.logger.setSourceLocation("RenderableObject.ts", 220);
                    akra.logger.error("RenderableObject::_draw() pure virtual method() isn't callable!!");
                }
                ;
            };
            RenderableObject.prototype._setVisible = function (bVisible) {
                this._bVisible = bVisible;
            };
            RenderableObject.prototype.getGuid = function () {
                return this._iGuid;
            };
            RenderableObject._pEventTable = new akra.events.EventTable();
            RenderableObject.prototype.getEventTable = function () {
                return RenderableObject._pEventTable;
            };
            RenderableObject.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            RenderableObject.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            RenderableObject.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            RenderableObject.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            RenderableObject.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            RenderableObject.prototype.shadow = function (bValue) {
                var _recivier = this;
                this._pUnicastSlotMap = this._pUnicastSlotMap || (this.getEventTable()).findUnicastList(this._iGuid);
                var _unicast = (this._pUnicastSlotMap).shadow;
                if (((_unicast) !== undefined)) {
                    _unicast.target ? _unicast.target[_unicast.callback](_recivier, bValue) : _unicast.listener(_recivier, bValue);
                }
            };
            RenderableObject.prototype.beforeRender = function (pViewport) {
                var _recivier = this;
                this._pUnicastSlotMap = this._pUnicastSlotMap || (this.getEventTable()).findUnicastList(this._iGuid);
                var _unicast = (this._pUnicastSlotMap).beforeRender;
                if (((_unicast) !== undefined)) {
                    _unicast.target ? _unicast.target[_unicast.callback](_recivier, pViewport) : _unicast.listener(_recivier, pViewport);
                }
            };
            return RenderableObject;
        })();
        render.RenderableObject = RenderableObject;        
        function isMeshSubset(pObject) {
            return pObject.type === akra.ERenderDataTypes.MESH_SUBSET;
        }
        render.isMeshSubset = isMeshSubset;
        function isScreen(pObject) {
            return pObject.type === akra.ERenderDataTypes.SCREEN;
        }
        render.isScreen = isScreen;
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var Screen = (function (_super) {
            __extends(Screen, _super);
            function Screen(pRenderer) {
                        _super.call(this, akra.ERenderDataTypes.SCREEN);
                var pCollection = pRenderer.getEngine().createRenderDataCollection(0);
                var pData = pCollection.getEmptyRenderData(akra.EPrimitiveTypes.TRIANGLESTRIP);
                pData.allocateAttribute(akra.createVertexDeclaration([
                    akra.VE_FLOAT2(akra.DeclUsages.POSITION)
                ]), new Float32Array([
                    -1, 
                    -1, 
                    -1, 
                    1, 
                    1, 
                    -1, 
                    1, 
                    1
                ]));
                this._pRenderData = pData;
                this._setup(pRenderer);
            }
            return Screen;
        })(render.RenderableObject);
        render.Screen = Screen;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var DSViewport = (function (_super) {
            __extends(DSViewport, _super);
            function DSViewport(pCamera, pTarget, csRenderMethod, fLeft, fTop, fWidth, fHeight, iZIndex) {
                if (typeof csRenderMethod === "undefined") { csRenderMethod = null; }
                if (typeof fLeft === "undefined") { fLeft = 0.; }
                if (typeof fTop === "undefined") { fTop = 0.; }
                if (typeof fWidth === "undefined") { fWidth = 1.; }
                if (typeof fHeight === "undefined") { fHeight = 1.; }
                if (typeof iZIndex === "undefined") { iZIndex = 0; }
                        _super.call(this, pCamera, pTarget, null, fLeft, fTop, fWidth, fHeight, iZIndex);
                this._pDefereedColorTextures = [];
                this._pDeferredDepthTexture = null;
                this._pDeferredView = null;
                this._pDeferredSkyTexture = null;
                this._pLightingUnifoms = {
                    omni: [],
                    project: [],
                    omniShadows: [],
                    projectShadows: [],
                    textures: [],
                    samplersOmni: [],
                    samplersProject: []
                };
                this._pLightPoints = null;
                var pEngine = this.getTarget().getRenderer().getEngine();
                var pResMgr = pEngine.getResourceManager();
                var pDeferredData = new Array(2);
                var pDeferredTextures = new Array(2);
                var pDepthTexture;
                var pDefferedView = this._pDeferredView = new render.Screen(pEngine.getRenderer());
                var iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                var iWidth = akra.math.ceilingPowerOfTwo(this.actualWidth);
                var iHeight = akra.math.ceilingPowerOfTwo(this.actualHeight);
                if (akra.info.browser.name === "Firefox") {
                    iWidth = akra.math.min(iWidth, 1024);
                    iHeight = akra.math.min(iHeight, 1024);
                }
                pDepthTexture = this._pDeferredDepthTexture = pResMgr.createTexture("deferred-depth-texture-" + iGuid);
                pDepthTexture.create(iWidth, iHeight, 1, null, 0, 0, 0, akra.ETextureTypes.TEXTURE_2D, akra.EPixelFormats.DEPTH32);
                for(var i = 0; i < 2; ++i) {
                    pDeferredTextures[i] = this._pDefereedColorTextures[i] = pResMgr.createTexture("deferred-color-texture-" + i + "-" + iGuid);
                    pDeferredTextures[i].create(iWidth, iHeight, 1, null, akra.ETextureFlags.RENDERTARGET, 0, 0, akra.ETextureTypes.TEXTURE_2D, akra.EPixelFormats.FLOAT32_RGBA);
                    pDeferredData[i] = pDeferredTextures[i].getBuffer().getRenderTarget();
                    pDeferredData[i].setAutoUpdated(false);
                    var pViewport = pDeferredData[i].addViewport(this.getCamera(), "deferred_shading_pass_" + i, 0, 0, 0, this.actualWidth / pDeferredTextures[i].width, this.actualHeight / pDeferredTextures[i].height);
                    pDeferredData[i].attachDepthTexture(pDepthTexture);
                    if (i === 1) {
                        pViewport.setDepthParams(true, false, akra.ECompareFunction.EQUAL);
                        pViewport.setClearEveryFrame(true, akra.EFrameBufferTypes.COLOR);
                    }
                }
                var pDSMethod = pResMgr.createRenderMethod(".deferred_shading");
                var pDSEffect = pResMgr.createEffect(".deferred_shading");
                pDSEffect.addComponent("akra.system.deferredShading");
                pDSEffect.addComponent("akra.system.omniLighting");
                pDSEffect.addComponent("akra.system.projectLighting");
                pDSEffect.addComponent("akra.system.omniShadowsLighting");
                pDSEffect.addComponent("akra.system.projectShadowsLighting");
                pDSEffect.addComponent("akra.system.skybox", 1, 0);
                pDSMethod.effect = pDSEffect;
                pDefferedView.getTechnique().setMethod(pDSMethod);
                pDefferedView.getTechnique()._setGlobalPostEffectsFrom(1);
                this.setClearEveryFrame(false);
                this.setDepthParams(false, false, 0);
                this.setFXAA(true);
                this.connect(pDefferedView.getTechnique(), "render", "_onRender", akra.EEventTypes.UNICAST);
            }
            DSViewport.prototype._updateDimensions = function () {
                _super.prototype._updateDimensions.call(this);
                var pDeferredTextures = this._pDefereedColorTextures;
                if (((this._pDeferredDepthTexture) != null)) {
                    this._pDeferredDepthTexture.reset(akra.math.ceilingPowerOfTwo(this.actualWidth), akra.math.ceilingPowerOfTwo(this.actualHeight));
                    for(var i = 0; i < 2; ++i) {
                        pDeferredTextures[i].reset(akra.math.ceilingPowerOfTwo(this.actualWidth), akra.math.ceilingPowerOfTwo(this.actualHeight));
                        pDeferredTextures[i].getBuffer().getRenderTarget().getViewport(0).setDimensions(0., 0., this.actualWidth / pDeferredTextures[i].width, this.actualHeight / pDeferredTextures[i].height);
                    }
                }
            };
            DSViewport.prototype._updateImpl = function () {
                this.prepareForDeferredShading();
                var pLights = this.getCamera().display(1);
                for(var i = 0; i < pLights.length; i++) {
                    pLights.value(i)._calculateShadows();
                }
                this._pLightPoints = pLights;
                this._pDefereedColorTextures[0].getBuffer().getRenderTarget().update();
                this._pDefereedColorTextures[1].getBuffer().getRenderTarget().update();
                this.newFrame();
                this._pDeferredView.render(this);
            };
            DSViewport.prototype.prepareForDeferredShading = function () {
                var pNodeList = this.getCamera().display();
                for(var i = 0; i < pNodeList.length; ++i) {
                    var pSceneObject = pNodeList.value(i);
                    for(var k = 0; k < pSceneObject.totalRenderable; k++) {
                        var pRenderable = pSceneObject.getRenderable(k);
                        var pTechCurr = pRenderable.getTechniqueDefault();
                        for(var j = 0; j < 2; j++) {
                            var sMethod = "deferred_shading_pass_" + j;
                            var pTechnique = pRenderable.getTechnique(sMethod);
                            if (((pTechnique) === null) || pTechCurr.modified > pTechnique.modified) {
                                if (!pRenderable.addRenderMethod(pRenderable.getRenderMethod(), sMethod)) {
 {
                                        akra.logger.setSourceLocation("DSViewport2.ts", 215);
                                        akra.logger.criticalError("cannot clone active render method");
                                    }
                                    ;
                                }
                                pTechnique = pRenderable.getTechnique(sMethod);
                                pTechnique._syncTable(pTechCurr);
                                if (j === 0) {
                                    pTechnique._blockPass(1);
                                } else {
                                    pTechnique._blockPass(0);
                                }
                                if (pTechnique.totalPasses > j) {
                                    var pPass = pTechnique.getPass(j);
                                    pPass.blend("akra.system.prepareForDeferredShading", j);
                                }
                            }
                        }
                    }
                }
                ;
            };
            DSViewport.prototype.setSkybox = function (pSkyTexture) {
                if (pSkyTexture.textureType !== akra.ETextureTypes.TEXTURE_CUBE_MAP) {
                    return null;
                }
                this._pDeferredSkyTexture = pSkyTexture;
                return true;
            };
            DSViewport.prototype.setFXAA = function (bValue) {
                if (typeof bValue === "undefined") { bValue = true; }
                var pEffect = this._pDeferredView.getTechnique().getMethod().effect;
                if (bValue) {
                    pEffect.addComponent("akra.system.fxaa", 2, 0);
                    this._pDeferredView.getTechnique()._setGlobalPostEffectsFrom(2);
                } else {
                    pEffect.delComponent("akra.system.fxaa", 2, 0);
                    this._pDeferredView.getTechnique()._setGlobalPostEffectsFrom(1);
                }
            };
            DSViewport.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
                this._pDeferredDepthTexture.destroyResource();
                this._pDefereedColorTextures[0].destroyResource();
                this._pDefereedColorTextures[1].destroyResource();
                this._pDeferredView.destroy();
                this._pDeferredView = null;
                this._pDeferredSkyTexture = null;
            };
            DSViewport.prototype._onRender = function (pTechnique, iPass) {
                var pPass = pTechnique.getPass(iPass);
                var pDepthTexture = this._pDeferredDepthTexture;
                var pDeferredTextures = this._pDefereedColorTextures;
                switch(iPass) {
                    case 0:
                        var pLightUniforms = this._pLightingUnifoms;
                        var pLightPoints = this._pLightPoints;
                        var pCamera = this.getCamera();
                        this.createLightingUniforms(pCamera, pLightPoints, pLightUniforms);
                        pPass.setForeign("nOmni", pLightUniforms.omni.length);
                        pPass.setForeign("nProject", pLightUniforms.project.length);
                        pPass.setForeign("nOmniShadows", pLightUniforms.omniShadows.length);
                        pPass.setForeign("nProjectShadows", pLightUniforms.projectShadows.length);
                        pPass.setStruct("points_omni", pLightUniforms.omni);
                        pPass.setStruct("points_project", pLightUniforms.project);
                        pPass.setStruct("points_omni_shadows", pLightUniforms.omniShadows);
                        pPass.setStruct("points_project_shadows", pLightUniforms.projectShadows);
                        for(var i = 0; i < pLightUniforms.textures.length; i++) {
                            pPass.setTexture("TEXTURE" + i, pLightUniforms.textures[i]);
                        }
                        pPass.setUniform("PROJECT_SHADOW_SAMPLER", pLightUniforms.samplersProject);
                        pPass.setUniform("OMNI_SHADOW_SAMPLER", pLightUniforms.samplersOmni);
                        pPass.setUniform("MIN_SHADOW_VALUE", 0.5);
                        pPass.setUniform("SHADOW_CONSTANT", 5.e+2);
                        pPass.setUniform("SCREEN_TEXTURE_RATIO", akra.vec2(this.actualWidth / pDepthTexture.width, this.actualHeight / pDepthTexture.height));
                        pPass.setTexture("DEFERRED_TEXTURE0", pDeferredTextures[0]);
                        pPass.setTexture("DEFERRED_TEXTURE1", pDeferredTextures[1]);
                        pPass.setTexture("SCENE_DEPTH_TEXTURE", pDepthTexture);
                        pPass.setUniform("SAMPLER_TEXTURE0", {
                            textureName: "DEFERRED_TEXTURE0",
                            texture: null,
                            wrap_s: akra.ETextureWrapModes.CLAMP_TO_EDGE,
                            wrap_t: akra.ETextureWrapModes.CLAMP_TO_EDGE,
                            mag_filter: akra.ETextureFilters.NEAREST,
                            min_filter: akra.ETextureFilters.NEAREST
                        });
                        pPass.setUniform("SAMPLER_TEXTURE1", {
                            textureName: "DEFERRED_TEXTURE1",
                            texture: null,
                            wrap_s: akra.ETextureWrapModes.CLAMP_TO_EDGE,
                            wrap_t: akra.ETextureWrapModes.CLAMP_TO_EDGE,
                            mag_filter: akra.ETextureFilters.NEAREST,
                            min_filter: akra.ETextureFilters.NEAREST
                        });
                        pPass.setUniform("SAMPLER_SCENE_DEPTH", {
                            textureName: "SCENE_DEPTH_TEXTURE",
                            texture: null,
                            wrap_s: akra.ETextureWrapModes.CLAMP_TO_EDGE,
                            wrap_t: akra.ETextureWrapModes.CLAMP_TO_EDGE,
                            mag_filter: akra.ETextureFilters.LINEAR,
                            min_filter: akra.ETextureFilters.LINEAR
                        });
                        break;
                    case 1:
                        pPass.setTexture("DEFERRED_TEXTURE0", pDeferredTextures[0]);
                        pPass.setTexture("SKYBOX_TEXTURE", this._pDeferredSkyTexture);
                        pPass.setUniform("SCREEN_TEXTURE_RATIO", akra.vec2(this.actualWidth / pDepthTexture.width, this.actualHeight / pDepthTexture.height));
                        pPass.setUniform("SAMPLER_SKYBOX", {
                            textureName: "SKYBOX_TEXTURE",
                            texture: null,
                            wrap_s: akra.ETextureWrapModes.CLAMP_TO_EDGE,
                            wrap_t: akra.ETextureWrapModes.CLAMP_TO_EDGE,
                            mag_filter: akra.ETextureFilters.LINEAR,
                            min_filter: akra.ETextureFilters.LINEAR
                        });
                        pPass.setUniform("SAMPLER_TEXTURE0", {
                            textureName: "DEFERRED_TEXTURE0",
                            texture: null,
                            wrap_s: akra.ETextureWrapModes.CLAMP_TO_EDGE,
                            wrap_t: akra.ETextureWrapModes.CLAMP_TO_EDGE,
                            mag_filter: akra.ETextureFilters.NEAREST,
                            min_filter: akra.ETextureFilters.NEAREST
                        });
                        break;
                }
            };
            DSViewport.prototype.resetUniforms = function () {
                var pUniforms = this._pLightingUnifoms;
                pUniforms.omni.clear();
                pUniforms.project.clear();
                pUniforms.omniShadows.clear();
                pUniforms.projectShadows.clear();
                pUniforms.textures.clear();
                pUniforms.samplersProject.clear();
                pUniforms.samplersOmni.clear();
            };
            DSViewport.prototype.createLightingUniforms = function (pCamera, pLightPoints, pUniforms) {
                var pLight;
                var pOmniLight;
                var pProjectLight;
                var i, j;
                var pUniformData;
                var pCameraView = pCamera.viewMatrix;
                var v4fLightPosition = akra.vec4();
                var v3fLightTransformPosition = akra.vec3();
                var v4fTemp = akra.vec4();
                var pShadowCaster;
                var m4fShadow, m4fToLightSpace;
                var iLastTextureIndex = 0;
                var sTexture = "TEXTURE";
                this.resetUniforms();
                for(i = 0; i < pLightPoints.length; i++) {
                    pLight = pLightPoints.value(i);
                    v4fLightPosition.set(pLight.worldPosition, 1.);
                    pCameraView.multiplyVec4(v4fLightPosition, v4fTemp);
                    v3fLightTransformPosition.set(v4fTemp.x, v4fTemp.y, v4fTemp.z);
                    if (pLight.lightType === akra.ELightTypes.OMNI) {
                        pOmniLight = pLight;
                        if (pLight.isShadowCaster) {
                            pUniformData = render.UniformOmniShadow.stackCeil;
                            (pUniformData).setLightData(pLight.params, v3fLightTransformPosition);
                            var pDepthCube = pOmniLight.getDepthTextureCube();
                            var pShadowCasterCube = pOmniLight.getShadowCaster();
                            for(j = 0; j < 6; ++j) {
                                pShadowCaster = pShadowCasterCube[j];
                                m4fToLightSpace = pShadowCaster.viewMatrix.multiply(pCamera.worldMatrix, akra.mat4());
                                pUniforms.textures.push(pDepthCube[j]);
                                sTexture = "TEXTURE" + (pUniforms.textures.length - 1);
                                (pUniformData).setSampler(sTexture, j);
                                pUniforms.samplersOmni.push((pUniformData).SHADOW_SAMPLER[j]);
                                (pUniformData).setMatrix(m4fToLightSpace, pShadowCaster.optimizedProjection, j);
                            }
                            pUniforms.omniShadows.push(pUniformData);
                        } else {
                            pUniformData = render.UniformOmni.stackCeil;
                            (pUniformData).setLightData(pLight.params, v3fLightTransformPosition);
                            pUniforms.omni.push(pUniformData);
                        }
                    } else if (pLight.lightType === akra.ELightTypes.PROJECT) {
                        pProjectLight = pLight;
                        pShadowCaster = pProjectLight.getShadowCaster();
                        if (pLight.isShadowCaster && pShadowCaster.isShadowCasted) {
                            pUniformData = render.UniformProjectShadow.stackCeil;
                            (pUniformData).setLightData(pLight.params, v3fLightTransformPosition);
                            m4fToLightSpace = pShadowCaster.viewMatrix.multiply(pCamera.worldMatrix, akra.mat4());
                            pUniforms.textures.push(pProjectLight.getDepthTexture());
                            sTexture = "TEXTURE" + (pUniforms.textures.length - 1);
                            (pUniformData).setSampler(sTexture);
                            pUniforms.samplersProject.push((pUniformData).SHADOW_SAMPLER);
                            (pUniformData).setMatrix(m4fToLightSpace, pShadowCaster.projectionMatrix, pShadowCaster.optimizedProjection);
                            pUniforms.projectShadows.push(pUniformData);
                        } else {
                            pUniformData = render.UniformProject.stackCeil;
                            (pUniformData).setLightData(pLight.params, v3fLightTransformPosition);
                            m4fShadow = pShadowCaster.projViewMatrix.multiply(pCamera.worldMatrix, akra.mat4());
                            (pUniformData).setMatrix(m4fShadow);
                            pUniforms.project.push(pUniformData);
                        }
                    } else {
 {
                            akra.logger.setSourceLocation("DSViewport2.ts", 491);
                            akra.logger.criticalError("Invalid light point type detected.");
                        }
                        ;
                    }
                }
            };
            return DSViewport;
        })(render.Viewport);
        render.DSViewport = DSViewport;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var RenderTarget = (function () {
            function RenderTarget(pRenderer) {
                this._iPriority = 4;
                this._pDepthBuffer = null;
                this._pDepthPixelBuffer = null;
                this._isActive = true;
                this._isAutoUpdate = true;
                this._bHwGamma = false;
                this._pViewportList = [];
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._pRenderer = pRenderer;
                this._pTimer = pRenderer.getEngine().getTimer();
                this._pFrameStats = {
                    fps: {
                        last: 0.,
                        avg: 0.,
                        best: 0.,
                        worst: 0.
                    },
                    time: {
                        best: 0.,
                        worst: 0.
                    },
                    polygonsCount: 0
                };
                this.resetStatistics();
            }
            Object.defineProperty(RenderTarget.prototype, "name", {
                get: function () {
                    return this._sName;
                },
                set: function (sName) {
                    this._sName = sName;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderTarget.prototype, "width", {
                get: function () {
                    return this._iWidth;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderTarget.prototype, "height", {
                get: function () {
                    return this._iHeight;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderTarget.prototype, "colorDepth", {
                get: function () {
                    return this._iColorDepth;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderTarget.prototype, "totalViewports", {
                get: function () {
                    return this._pViewportList.length;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderTarget.prototype, "totalFrames", {
                get: function () {
                    return this._iFrameCount;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderTarget.prototype, "priority", {
                get: function () {
                    return this._iPriority;
                },
                enumerable: true,
                configurable: true
            });
            RenderTarget.prototype.getRenderer = function () {
                return this._pRenderer;
            };
            RenderTarget.prototype.destroy = function () {
                var pViewport;
                for(var i in this._pViewportList) {
                    pViewport = this._pViewportList[i];
                    this.viewportRemoved(pViewport);
                    pViewport.destroy();
                }
                this.detachDepthBuffer();
 {
                    akra.logger.setSourceLocation("render/RenderTarget.ts", 100);
                    akra.logger.log("RenderTarget '%s'\n Average FPS: %s\n Best FPS: %s\n Worst FPS: %s", this._sName, this._pFrameStats.fps.avg, this._pFrameStats.fps.best, this._pFrameStats.fps.worst);
                }
                ;
            };
            RenderTarget.prototype.getDepthBuffer = function () {
                return this._pDepthBuffer;
            };
            RenderTarget.prototype.attachDepthBuffer = function (pBuffer) {
                var isOk = false;
                if ((isOk = pBuffer.isCompatible(this))) {
                    this.detachDepthBuffer();
                    this._pDepthBuffer = pBuffer;
                    this._pDepthBuffer._notifyRenderTargetAttached(this);
                }
                return isOk;
            };
            RenderTarget.prototype.attachDepthPixelBuffer = function (pBuffer) {
                if (this._iWidth !== pBuffer.width || this._iHeight !== pBuffer.height) {
                    return false;
                }
                var eFormat = pBuffer.format;
                if (eFormat !== akra.EPixelFormats.FLOAT32_DEPTH || eFormat !== akra.EPixelFormats.DEPTH8) {
                    return false;
                }
                this.detachDepthPixelBuffer();
                this._pDepthPixelBuffer = pBuffer;
                return true;
            };
            RenderTarget.prototype.detachDepthPixelBuffer = function () {
                if (this._pDepthPixelBuffer) {
                    this._pDepthPixelBuffer = null;
                }
            };
            RenderTarget.prototype.detachDepthBuffer = function () {
                if (this._pDepthBuffer) {
                    this._pDepthBuffer._notifyRenderTargetDetached(this);
                    this._pDepthBuffer = null;
                }
            };
            RenderTarget.prototype.attachDepthTexture = function (pTexture) {
                return false;
            };
            RenderTarget.prototype.detachDepthTexture = function () {
            };
            RenderTarget.prototype._detachDepthBuffer = function () {
                this._pDepthBuffer = null;
            };
            RenderTarget.prototype._beginUpdate = function () {
                this.preUpdate();
                this._pFrameStats.polygonsCount = 0;
            };
            RenderTarget.prototype._updateAutoUpdatedViewports = function (bUpdateStatistics) {
                if (typeof bUpdateStatistics === "undefined") { bUpdateStatistics = true; }
                var pViewport;
                for(var i in this._pViewportList) {
                    pViewport = this._pViewportList[i];
                    if (pViewport.isAutoUpdated()) {
                        this._updateViewport(pViewport, bUpdateStatistics);
                    }
                }
            };
            RenderTarget.prototype._endUpdate = function () {
                this.postUpdate();
                this.updateStats();
            };
            RenderTarget.prototype._updateViewport = function (pViewportPtr, bUpdateStatistics) {
                if (typeof bUpdateStatistics === "undefined") { bUpdateStatistics = true; }
                var pViewport;
                var iZIndex;
                if ((typeof (arguments[0]) === "number")) {
                    iZIndex = arguments[0];
                    pViewport = this._pViewportList[iZIndex];
 {
                        akra.logger.setSourceLocation("render/RenderTarget.ts", 198);
                        akra.logger.assert(((pViewport) != null), "No viewport with given z-index : %s", iZIndex, "RenderTarget::_updateViewport");
                    }
                    ;
                } else {
                    pViewport = arguments[0];
                }
 {
                    akra.logger.setSourceLocation("render/RenderTarget.ts", 205);
                    akra.logger.assert(pViewport.getTarget() == this, "RenderTarget::_updateViewport the requested viewport is not bound to the rendertarget!");
                }
                ;
                this.viewportPreUpdate(pViewport);
                pViewport.update();
                if (bUpdateStatistics) {
                    this._pFrameStats.polygonsCount += pViewport._getNumRenderedPolygons();
                }
                this.viewportPostUpdate(pViewport);
            };
            RenderTarget.prototype.addViewport = function (pCamera, csRenderMethod, iZIndex, fLeft, fTop, fWidth, fHeight) {
                if (typeof csRenderMethod === "undefined") { csRenderMethod = null; }
                if (typeof iZIndex === "undefined") { iZIndex = 0; }
                if (typeof fLeft === "undefined") { fLeft = 0.; }
                if (typeof fTop === "undefined") { fTop = 0.; }
                if (typeof fWidth === "undefined") { fWidth = 1.; }
                if (typeof fHeight === "undefined") { fHeight = 1.; }
                var pViewport = this._pViewportList[iZIndex];
                if (((pViewport) != null)) {
 {
                        akra.logger.setSourceLocation("render/RenderTarget.ts", 225);
                        akra.logger.criticalError("Can't create another viewport for %s with Z-index %s 					because a viewport exists with this Z-Order already.", this._sName, iZIndex, "RenderTarget::addViewport");
                    }
                    ;
                }
                if ((typeof (arguments[1]) === "number")) {
                    switch(arguments[1]) {
                        case akra.EViewportTypes.DSVIEWPORT:
                            pViewport = new render.DSViewport(pCamera, this, null, fLeft, fTop, fWidth, fHeight, iZIndex);
                            break;
                        case akra.EViewportTypes.SHADOWVIEWPORT:
                            pViewport = new render.ShadowViewport(pCamera, this, null, fLeft, fTop, fWidth, fHeight, iZIndex);
                            break;
                        default:
                            pViewport = new render.Viewport(pCamera, this, null, fLeft, fTop, fWidth, fHeight, iZIndex);
                            break;
                    }
                } else {
                    pViewport = new render.Viewport(pCamera, this, csRenderMethod, fLeft, fTop, fWidth, fHeight, iZIndex);
                }
                this._pViewportList[iZIndex] = pViewport;
                this.viewportAdded(pViewport);
                return pViewport;
            };
            RenderTarget.prototype.removeViewport = function (iZIndex) {
                var pViewport = this._pViewportList[iZIndex];
                if (((pViewport) != null)) {
                    this.viewportRemoved(pViewport);
                    this._pViewportList.splice(iZIndex, 1);
                    pViewport = null;
                    return true;
                }
                return false;
            };
            RenderTarget.prototype.removeAllViewports = function () {
                var pViewport;
                var iTotal;
                for(var i in this._pViewportList) {
                    pViewport = this._pViewportList[i];
                    this.viewportRemoved(pViewport);
                }
                iTotal = this._pViewportList.length;
                (this._pViewportList).clear();
                return iTotal;
            };
            RenderTarget.prototype.getStatistics = function () {
                return this._pFrameStats;
            };
            RenderTarget.prototype.getLastFPS = function () {
                return this._pFrameStats.fps.last;
            };
            RenderTarget.prototype.getAverageFPS = function () {
                return this._pFrameStats.fps.avg;
            };
            RenderTarget.prototype.getBestFPS = function () {
                return this._pFrameStats.fps.best;
            };
            RenderTarget.prototype.getWorstFPS = function () {
                return this._pFrameStats.fps.worst;
            };
            RenderTarget.prototype.getPolygonCount = function () {
                return this._pFrameStats.polygonsCount;
            };
            RenderTarget.prototype.getBestFrameTime = function () {
                return this._pFrameStats.time.best;
            };
            RenderTarget.prototype.getWorstFrameTime = function () {
                return this._pFrameStats.time.worst;
            };
            RenderTarget.prototype.resetStatistics = function () {
                var pStats = this._pFrameStats;
                pStats.fps.avg = 0.;
                pStats.fps.best = 0.;
                pStats.fps.last = 0.;
                pStats.fps.worst = 999.;
                pStats.polygonsCount = 0;
                pStats.time.best = 9999999;
                pStats.time.worst = 0;
                this._fLastTime = this._pTimer.appTime;
                this._fLastSecond = this._fLastTime;
                this._iFrameCount = 0;
            };
            RenderTarget.prototype.updateStats = function () {
                this._iFrameCount++;
                var fThisTime = this._pTimer.appTime;
                var fFrameTime = fThisTime - this._fLastTime;
                this._pFrameStats.time.best = akra.math.min(this._pFrameStats.time.best, fFrameTime);
                this._pFrameStats.time.worst = akra.math.min(this._pFrameStats.time.worst, fFrameTime);
                if (fThisTime - this._fLastTime > 1.) {
                    this._pFrameStats.fps.last = this._iFrameCount / (fThisTime - this._fLastSecond);
                    if (this._pFrameStats.fps.avg == 0.) {
                        this._pFrameStats.fps.avg = this._pFrameStats.fps.last;
                    } else {
                        this._pFrameStats.fps.avg = (this._pFrameStats.fps.avg + this._pFrameStats.fps.last) / 2.;
                        this._pFrameStats.fps.best = akra.math.max(this._pFrameStats.fps.best, this._pFrameStats.fps.last);
                        this._pFrameStats.fps.worst = akra.math.max(this._pFrameStats.fps.worst, this._pFrameStats.fps.last);
                        this._fLastSecond = fThisTime;
                        this._iFrameCount = 0;
                    }
                    this._fLastTime = fThisTime;
                }
            };
            RenderTarget.prototype.getCustomAttribute = function (sName) {
                return null;
            };
            RenderTarget.prototype.getViewport = function (iIndex) {
 {
                    akra.logger.setSourceLocation("render/RenderTarget.ts", 371);
                    akra.logger.assert(iIndex < this._pViewportList.length, "Index out of bounds");
                }
                ;
                for(var i in this._pViewportList) {
                    if (iIndex--) {
                        continue;
                    }
                    return this._pViewportList[i];
                }
                return null;
            };
            RenderTarget.prototype.getViewportByZIndex = function (iZIndex) {
                var pViewport = this._pViewportList[iZIndex];
 {
                    akra.logger.setSourceLocation("render/RenderTarget.ts", 388);
                    akra.logger.assert(((pViewport) != null), "No viewport with given z-index : " + String(iZIndex), "RenderTarget::getViewportByZIndex");
                }
                ;
                return pViewport;
            };
            RenderTarget.prototype.hasViewportByZIndex = function (iZIndex) {
                return ((this._pViewportList[iZIndex]) != null);
            };
            RenderTarget.prototype.isActive = function () {
                return this._isActive;
            };
            RenderTarget.prototype.setActive = function (bValue) {
                if (typeof bValue === "undefined") { bValue = true; }
                this._isActive = bValue;
            };
            RenderTarget.prototype.setAutoUpdated = function (isAutoUpdate) {
                if (typeof isAutoUpdate === "undefined") { isAutoUpdate = true; }
                this._isAutoUpdate = isAutoUpdate;
            };
            RenderTarget.prototype._notifyCameraRemoved = function (pCamera) {
                var isRemoved = false;
                for(var i in this._pViewportList) {
                    var pViewport = this._pViewportList[i];
                    if (pViewport.getCamera() === pCamera) {
                        pViewport.setCamera(null);
                        isRemoved = true;
                    }
                }
                if (isRemoved) {
                    this.cameraRemoved(pCamera);
                }
            };
            RenderTarget.prototype.isAutoUpdated = function () {
                return this._isAutoUpdate;
            };
            RenderTarget.prototype.isPrimary = function () {
                return false;
            };
            RenderTarget.prototype.update = function () {
                this.updateImpl();
            };
            RenderTarget.prototype.readPixels = function (ppDest, eFramebuffer) {
                return null;
            };
            RenderTarget.prototype.updateImpl = function () {
                this._beginUpdate();
                this._updateAutoUpdatedViewports(true);
                this._endUpdate();
            };
            RenderTarget.prototype.getGuid = function () {
                return this._iGuid;
            };
            RenderTarget._pEventTable = new akra.events.EventTable();
            RenderTarget.prototype.getEventTable = function () {
                return RenderTarget._pEventTable;
            };
            RenderTarget.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            RenderTarget.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            RenderTarget.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            RenderTarget.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            RenderTarget.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            RenderTarget.prototype.preUpdate = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).preUpdate;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            RenderTarget.prototype.viewportPreUpdate = function (pViewport) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).viewportPreUpdate;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pViewport) : _broadcast[i].listener(_recivier, pViewport);
                    }
                }
            };
            RenderTarget.prototype.viewportPostUpdate = function (pViewport) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).viewportPostUpdate;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pViewport) : _broadcast[i].listener(_recivier, pViewport);
                    }
                }
            };
            RenderTarget.prototype.viewportAdded = function (pViewport) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).viewportAdded;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pViewport) : _broadcast[i].listener(_recivier, pViewport);
                    }
                }
            };
            RenderTarget.prototype.viewportRemoved = function (pViewport) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).viewportRemoved;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pViewport) : _broadcast[i].listener(_recivier, pViewport);
                    }
                }
            };
            RenderTarget.prototype.postUpdate = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).postUpdate;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            RenderTarget.prototype.resized = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).resized;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            RenderTarget.prototype.cameraRemoved = function (pCamera) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).cameraRemoved;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pCamera) : _broadcast[i].listener(_recivier, pCamera);
                    }
                }
            };
            return RenderTarget;
        })();
        render.RenderTarget = RenderTarget;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var RenderEntry = (function () {
            function RenderEntry() {
                this.viewport = null;
                this.renderTarget = null;
                this.maker = null;
                this.input = null;
                this.bufferMap = null;
            }
            RenderEntry.prototype.clear = function () {
                this.maker._releaseShaderInput(this.input);
                this.viewport = null;
                this.renderTarget = null;
                this.bufferMap = null;
                this.input = null;
                this.maker = null;
            };
            return RenderEntry;
        })();
        render.RenderEntry = RenderEntry;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var RenderQueue = (function () {
            function RenderQueue(pRenderer) {
                this._pRenderer = pRenderer;
                this._pEntryList = new akra.util.ObjectArray();
            }
            RenderQueue.prototype.execute = function () {
                this._pRenderer._beginRender();
                for(var i = 0; i < this._pEntryList.length; i++) {
                    var pEntry = this._pEntryList.value(i);
                    this._pRenderer._renderEntry(pEntry);
                    this.releaseEntry(pEntry);
                }
                this._pEntryList.clear(false);
                this._pRenderer._endRender();
            };
            RenderQueue.prototype.push = function (pEntry) {
                this._pEntryList.push(pEntry);
            };
            RenderQueue.prototype.createEntry = function () {
                return RenderQueue.createEntry();
            };
            RenderQueue.prototype.releaseEntry = function (pEntry) {
                return RenderQueue.releaseEntry(pEntry);
            };
            RenderQueue.createEntry = function createEntry() {
                return RenderQueue.pool.length > 0 ? RenderQueue.pool.pop() : new render.RenderEntry();
            };
            RenderQueue.releaseEntry = function releaseEntry(pEntry) {
                RenderQueue.pool.push(pEntry);
                pEntry.clear();
            };
            RenderQueue.pool = new akra.util.ObjectArray();
            return RenderQueue;
        })();
        render.RenderQueue = RenderQueue;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        render.SShaderPrefixes = {
            k_Sampler: "A_s_",
            k_Header: "A_h_",
            k_Attribute: "A_a_",
            k_Offset: "A_o_",
            k_Texture: "TEXTURE",
            k_Texcoord: "TEXCOORD",
            k_Texmatrix: "TEXMATRIX",
            k_Temp: "TEMP_",
            k_BlendType: "AUTO_BLEND_TYPE_"
        };
        render.ZEROSAMPLER = 19;
        render.SSystemSemantics = {
            MODEL_MATRIX: "MODEL_MATRIX",
            VIEW_MATRIX: "VIEW_MATRIX",
            PROJ_MATRIX: "PROJ_MATRIX",
            NORMAL_MATRIX: "NORMAL_MATRIX",
            BIND_MATRIX: "BIND_SHAPE_MATRIX",
            RENDER_OBJECT_ID: "RENDER_OBJECT_ID"
        };
        var Renderer = (function () {
            function Renderer(pEngine) {
                this._isActive = false;
                this._pRenderTargets = [];
                this._pPrioritisedRenderTargets = {};
                this._pRenderQueue = null;
                this._pActiveViewport = null;
                this._pActiveRenderTarget = null;
                this._bLockRenderTarget = false;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._pEngine = pEngine;
                this.connect(pEngine, "active", "active");
                this.connect(pEngine, "inactive", "inactive");
                this._pRenderQueue = new render.RenderQueue(this);
            }
            Renderer.prototype.getEngine = function () {
                return this._pEngine;
            };
            Renderer.prototype.hasCapability = function (eCapability) {
                return false;
            };
            Renderer.prototype.debug = function (bValue, useApiTrace) {
                return false;
            };
            Renderer.prototype.isDebug = function () {
                return false;
            };
            Renderer.prototype.isValid = function () {
                return false;
            };
            Renderer.prototype.getError = function () {
                return null;
            };
            Renderer.prototype._beginRender = function () {
            };
            Renderer.prototype._renderEntry = function (pEntry) {
            };
            Renderer.prototype._endRender = function () {
            };
            Renderer.prototype.clearFrameBuffer = function (iBuffer, cColor, fDepth, iStencil) {
            };
            Renderer.prototype.attachRenderTarget = function (pTarget) {
                if (this._pRenderTargets.indexOf(pTarget) != -1) {
                    return false;
                }
                var pList = this._pPrioritisedRenderTargets[pTarget.priority];
                if (!((pList) !== undefined)) {
                    pList = this._pPrioritisedRenderTargets[pTarget.priority] = [];
                }
                pList.push(pTarget);
                this._pRenderTargets.push(pTarget);
                return true;
            };
            Renderer.prototype.detachRenderTarget = function (pTarget) {
                var i = this._pRenderTargets.indexOf(pTarget);
                if (i == -1) {
                    return false;
                }
                this._pRenderTargets.splice(i, 1);
                i = this._pPrioritisedRenderTargets[pTarget.priority].indexOf(pTarget);
                this._pPrioritisedRenderTargets[pTarget.priority].splice(i, 1);
                return true;
            };
            Renderer.prototype.destroyRenderTarget = function (pTarget) {
                var hasTarget = this.detachRenderTarget(pTarget);
                if (hasTarget) {
                    pTarget.destroy();
                    pTarget = null;
                }
            };
            Renderer.prototype.getActiveProgram = function () {
 {
                    akra.logger.setSourceLocation("render/Renderer.ts", 157);
                    akra.logger.criticalError("Renderer::getActiveProgram() is uncompleted method!");
                }
                ;
                return null;
            };
            Renderer.prototype._disableAllTextureUnits = function () {
                this._disableTextureUnitsFrom(0);
            };
            Renderer.prototype._disableTextureUnitsFrom = function (iUnit) {
            };
            Renderer.prototype._initRenderTargets = function () {
                for(var i = 0; i < this._pRenderTargets.length; ++i) {
                    this._pRenderTargets[i].resetStatistics();
                }
            };
            Renderer.prototype._updateAllRenderTargets = function () {
                var pTarget;
                for(var iPriority in this._pPrioritisedRenderTargets) {
                    var pTargetList = this._pPrioritisedRenderTargets[iPriority];
                    for(var j = 0; j < pTargetList.length; ++j) {
                        pTarget = pTargetList[j];
                        if (pTarget.isActive() && pTarget.isAutoUpdated()) {
                            pTarget.update();
                        }
                    }
                }
            };
            Renderer.prototype._setViewport = function (pViewport) {
            };
            Renderer.prototype._setViewportForRender = function (pViewport) {
                var isViewportUpdate = pViewport !== this._pActiveViewport || pViewport.isUpdated();
                var isRenderTargetUpdate = pViewport.getTarget() !== this._pActiveRenderTarget;
                if (isViewportUpdate || isRenderTargetUpdate) {
                    this._setViewport(pViewport);
                    if (isViewportUpdate) {
                        var pState = pViewport._getViewportState();
                        this._setCullingMode(pState.cullingMode);
                        this._setDepthBufferParams(pState.depthTest, pState.depthWrite, pState.depthFunction, pState.clearDepth);
                    }
                }
            };
            Renderer.prototype._getViewport = function () {
                return this._pActiveViewport;
            };
            Renderer.prototype._setRenderTarget = function (pTarget) {
            };
            Renderer.prototype._setCullingMode = function (eMode) {
            };
            Renderer.prototype._setDepthBufferParams = function (bDepthTest, bDepthWrite, eDepthFunction, fClearDepth) {
            };
            Renderer.prototype.getDefaultCanvas = function () {
                return null;
            };
            Renderer.prototype.createEntry = function () {
                return this._pRenderQueue.createEntry();
            };
            Renderer.prototype.releaseEntry = function (pEntry) {
                this._pRenderQueue.releaseEntry(pEntry);
            };
            Renderer.prototype.pushEntry = function (pEntry) {
                this._pRenderQueue.push(pEntry);
            };
            Renderer.prototype.executeQueue = function () {
                this._pRenderQueue.execute();
            };
            Renderer.prototype.lockRenderTarget = function () {
                this._bLockRenderTarget = true;
            };
            Renderer.prototype.unlockRenderTarget = function () {
                this._bLockRenderTarget = false;
            };
            Renderer.prototype.isLockRenderTarget = function () {
                return this._bLockRenderTarget;
            };
            Renderer.prototype.getGuid = function () {
                return this._iGuid;
            };
            Renderer._pEventTable = new akra.events.EventTable();
            Renderer.prototype.getEventTable = function () {
                return Renderer._pEventTable;
            };
            Renderer.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Renderer.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Renderer.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Renderer.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Renderer.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            Renderer.prototype.active = function (pEngine) {
                this._isActive = true;
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).active;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pEngine) : _broadcast[i].listener(_recivier, pEngine);
                    }
                }
                ;
            };
            Renderer.prototype.inactive = function (pEngine) {
                this._isActive = false;
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).inactive;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pEngine) : _broadcast[i].listener(_recivier, pEngine);
                    }
                }
                ;
            };
            return Renderer;
        })();
        render.Renderer = Renderer;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
;
var akra;
(function (akra) {
    (function (util) {
        var UtilTimer = (function () {
            function UtilTimer() {
                this.isTimerInitialized = false;
                this.isTimerStopped = false;
                this.fTicksPerSec = 0.;
                this.iStopTime = 0;
                this.iLastElapsedTime = 0;
                this.iBaseTime = 0;
            }
            Object.defineProperty(UtilTimer.prototype, "absoluteTime", {
                get: function () {
                    return this.execCommand(akra.EUtilTimerCommands.TIMER_GET_ABSOLUTE_TIME);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(UtilTimer.prototype, "appTime", {
                get: function () {
                    return this.execCommand(akra.EUtilTimerCommands.TIMER_GET_APP_TIME);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(UtilTimer.prototype, "elapsedTime", {
                get: function () {
                    return this.execCommand(akra.EUtilTimerCommands.TIMER_GET_ELAPSED_TIME);
                },
                enumerable: true,
                configurable: true
            });
            UtilTimer.prototype.start = function () {
                return this.execCommand(akra.EUtilTimerCommands.TIMER_START) === 0;
            };
            UtilTimer.prototype.stop = function () {
                return this.execCommand(akra.EUtilTimerCommands.TIMER_STOP) === 0;
            };
            UtilTimer.prototype.reset = function () {
                return this.execCommand(akra.EUtilTimerCommands.TIMER_RESET) === 0;
            };
            UtilTimer.prototype.execCommand = function (eCommand) {
                var fTime = 0.;
                var fElapsedTime = 0.;
                var iTime;
                if (this.isTimerInitialized == false) {
                    this.isTimerInitialized = true;
                    this.fTicksPerSec = 1000;
                }
                if (this.iStopTime != 0 && eCommand != akra.EUtilTimerCommands.TIMER_START && eCommand != akra.EUtilTimerCommands.TIMER_GET_ABSOLUTE_TIME) {
                    iTime = this.iStopTime;
                } else {
                    iTime = akra.now();
                }
                if (eCommand == akra.EUtilTimerCommands.TIMER_GET_ELAPSED_TIME) {
                    fElapsedTime = (iTime - this.iLastElapsedTime) / this.fTicksPerSec;
                    this.iLastElapsedTime = iTime;
                    return fElapsedTime;
                }
                if (eCommand == akra.EUtilTimerCommands.TIMER_GET_APP_TIME) {
                    var fAppTime = (iTime - this.iBaseTime) / this.fTicksPerSec;
                    return fAppTime;
                }
                if (eCommand == akra.EUtilTimerCommands.TIMER_RESET) {
                    this.iBaseTime = iTime;
                    this.iLastElapsedTime = iTime;
                    this.iStopTime = 0;
                    this.isTimerStopped = false;
                    return 0;
                }
                if (eCommand == akra.EUtilTimerCommands.TIMER_START) {
                    if (this.isTimerStopped) {
                        this.iBaseTime += iTime - this.iStopTime;
                    }
                    this.iStopTime = 0;
                    this.iLastElapsedTime = iTime;
                    this.isTimerStopped = false;
                    return 0;
                }
                if (eCommand == akra.EUtilTimerCommands.TIMER_STOP) {
                    if (!this.isTimerStopped) {
                        this.iStopTime = iTime;
                        this.iLastElapsedTime = iTime;
                        this.isTimerStopped = true;
                    }
                    return 0;
                }
                if (eCommand == akra.EUtilTimerCommands.TIMER_ADVANCE) {
                    this.iStopTime += this.fTicksPerSec / 10;
                    return 0;
                }
                if (eCommand == akra.EUtilTimerCommands.TIMER_GET_ABSOLUTE_TIME) {
                    fTime = iTime / this.fTicksPerSec;
                    return fTime;
                }
                return -1;
            };
            UtilTimer.start = function start() {
                var pTimer = new UtilTimer();
                if (pTimer.start()) {
                    return pTimer;
                }
 {
                    util.logger.setSourceLocation("util/UtilTimer.ts", 124);
                    util.logger.error('cannot start util timer');
                }
                ;
                return null;
            };
            return UtilTimer;
        })();
        util.UtilTimer = UtilTimer;        
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var Canvas3d = (function (_super) {
            __extends(Canvas3d, _super);
            function Canvas3d(pRenderer) {
                        _super.call(this, pRenderer);
                this._isFullscreen = false;
                this._isPrimary = false;
                this._bAutoDeactivatedOnFocusChange = false;
                this.left = 0;
                this.top = 0;
                this._pRenderer = pRenderer;
            }
            Object.defineProperty(Canvas3d.prototype, "type", {
                get: function () {
                    return akra.ECanvasTypes.TYPE_3D;
                },
                enumerable: true,
                configurable: true
            });
            Canvas3d.prototype.create = function (sName, iWidth, iHeight, isFullscreen) {
                if (typeof isFullscreen === "undefined") { isFullscreen = false; }
                return false;
            };
            Canvas3d.prototype.destroy = function () {
            };
            Canvas3d.prototype.setFullscreen = function (isFullscreen) {
            };
            Canvas3d.prototype.setVisible = function (bVisible) {
            };
            Canvas3d.prototype.setDeactivateOnFocusChange = function (bDeactivate) {
                this._bAutoDeactivatedOnFocusChange = bDeactivate;
            };
            Canvas3d.prototype.isFullscreen = function () {
                return this._isFullscreen;
            };
            Canvas3d.prototype.isVisible = function () {
                return true;
            };
            Canvas3d.prototype.isClosed = function () {
                return false;
            };
            Canvas3d.prototype.isPrimary = function () {
                return this._isPrimary;
            };
            Canvas3d.prototype.isDeactivatedOnFocusChange = function () {
                return this._bAutoDeactivatedOnFocusChange;
            };
            Canvas3d.prototype.resize = function (iWidth, iHeight) {
            };
            return Canvas3d;
        })(render.RenderTarget);
        render.Canvas3d = Canvas3d;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        var WebGLCanvas = (function (_super) {
            __extends(WebGLCanvas, _super);
            function WebGLCanvas(pRenderer) {
                        _super.call(this, pRenderer);
                this._pCanvas = (pRenderer).getHTMLCanvas();
                this._pCanvasCreationInfo = akra.info.canvas(this._pCanvas);
            }
            Object.defineProperty(WebGLCanvas.prototype, "left", {
                get: function () {
                    var el = this._pCanvas;
                    for(var lx = 0; el != null; lx += el.offsetLeft, el = el.offsetParent) {
                        ;
                    }
                    return lx;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(WebGLCanvas.prototype, "top", {
                get: function () {
                    var el = this._pCanvas;
                    for(var ly = 0; el != null; ly += el.offsetTop, el = el.offsetParent) {
                        ;
                    }
                    return ly;
                },
                enumerable: true,
                configurable: true
            });
            WebGLCanvas.prototype.create = function (sName, iWidth, iHeight, isFullscreen) {
                if (typeof sName === "undefined") { sName = null; }
                if (typeof iWidth === "undefined") { iWidth = this._pCanvasCreationInfo.width; }
                if (typeof iHeight === "undefined") { iHeight = this._pCanvasCreationInfo.height; }
                if (typeof isFullscreen === "undefined") { isFullscreen = false; }
                this.name = sName;
                this.resize(iWidth, iHeight);
                this.setFullscreen(isFullscreen);
                return true;
            };
            WebGLCanvas.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
                this._pCanvas = null;
                this._pCanvasCreationInfo = null;
            };
            WebGLCanvas.prototype.getCustomAttribute = function (sName) {
                return null;
            };
            WebGLCanvas.prototype.setFullscreen = function (isFullscreen) {
                if (typeof isFullscreen === "undefined") { isFullscreen = true; }
                var _this = this;
                var pCanvasElement = this._pCanvas;
                var pScreen;
                var pCanvasInfo;
                var iRealWidth = this._iRealWidth;
                var iRealHeight = this._iRealHeight;
                var pCanvas = this;
                if (this._isFullscreen === isFullscreen) {
                    return;
                }
                if (WebGLCanvas.fullscreenLock) {
 {
                        akra.logger.setSourceLocation("WebGLCanvas.ts", 74);
                        akra.logger.warning("fullscreen is changing, do not try change before process will be ended");
                    }
                    ;
                    return;
                }
                this._isFullscreen = isFullscreen;
                if (isFullscreen) {
                    iRealWidth = this._iRealWidth = this._iWidth;
                    iRealHeight = this._iRealHeight = this._iHeight;
                }
                var el = pCanvasElement, doc = document, rfs = el.requestFullScreen || el.webkitRequestFullScreen || el.mozRequestFullScreen;
                try  {
                    WebGLCanvas.fullscreenLock = true;
                    if (isFullscreen) {
                        rfs.call(el);
                    }
                    el.onfullscreenchange = el.onmozfullscreenchange = el.onwebkitfullscreenchange = el.onfullscreenchange || /** @inline */function (e) {
                        if (!!(doc.webkitFullscreenElement || doc.mozFullScreenElement || doc.fullscreenElement)) {
                            pCanvas.resize(akra.info.screen.width, akra.info.screen.height);
                        } else {
                            _this.setFullscreen(false);
                            pCanvas.resize(iRealWidth, iRealHeight);
                        }
                        WebGLCanvas.fullscreenLock = false;
                    };
                } catch (e) {
 {
                        akra.logger.setSourceLocation("WebGLCanvas.ts", 117);
                        akra.logger.error("Fullscreen API not supported", e);
                    }
                    ;
                    throw e;
                }
            };
            WebGLCanvas.prototype.isVisible = function () {
                return this._pCanvas.style.display !== "none";
            };
            WebGLCanvas.prototype.setVisible = function (bVisible) {
                if (typeof bVisible === "undefined") { bVisible = true; }
                this._pCanvas.style.display = bVisible ? "block" : "none";
            };
            WebGLCanvas.prototype.resize = function (iWidth, iHeight) {
                if (typeof iWidth === "undefined") { iWidth = this._iWidth; }
                if (typeof iHeight === "undefined") { iHeight = this._iHeight; }
                var pCanvas = this._pCanvas;
                this._iWidth = iWidth;
                this._iHeight = iHeight;
                pCanvas.width = iWidth;
                pCanvas.height = iHeight;
                this.resized();
            };
            WebGLCanvas.prototype.readPixels = function (ppDest, eFramebuffer) {
                if (typeof ppDest === "undefined") { ppDest = null; }
                if (typeof eFramebuffer === "undefined") { eFramebuffer = akra.EFramebuffer.AUTO; }
                if (((ppDest) === null)) {
                    var ePixelFormat = akra.EPixelFormats.BYTE_RGB;
                    ppDest = new akra.pixelUtil.PixelBox(this._iWidth, this._iHeight, 1, ePixelFormat, new Uint8Array(akra.pixelUtil.getMemorySize(this._iWidth, this._iHeight, 1, ePixelFormat)));
                }
                if ((ppDest.right > this._iWidth) || (ppDest.bottom > this._iHeight) || (ppDest.front != 0) || (ppDest.back != 1)) {
 {
                        akra.logger.setSourceLocation("WebGLCanvas.ts", 172);
                        akra.logger.criticalError("Invalid box.", "GLXWindow::copyContentsToMemory");
                    }
                    ;
                }
                if (eFramebuffer == akra.EFramebuffer.AUTO) {
                    eFramebuffer = this._isFullscreen ? akra.EFramebuffer.FRONT : akra.EFramebuffer.BACK;
                }
                var eFormat = webgl.getWebGLFormat(ppDest.format);
                var eType = webgl.getWebGLDataType(ppDest.format);
                if (eFormat == 0 || eType == 0) {
 {
                        akra.logger.setSourceLocation("WebGLCanvas.ts", 183);
                        akra.logger.criticalError("Unsupported format.", "WebGLCanvas::readPixels");
                    }
                    ;
                }
                var pWebGLRenderer = this.getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLRenderer._setViewport(this.getViewport(0));
                pWebGLRenderer.bindWebGLFramebuffer(0x8D40, null);
                pWebGLContext.pixelStorei(0x0D05, 1);
                pWebGLContext.readPixels(ppDest.left, ppDest.top, ppDest.width, ppDest.height, eFormat, eType, ppDest.data);
                pWebGLContext.pixelStorei(0x0D05, 4);
                return ppDest;
            };
            WebGLCanvas.fullscreenLock = false;
            return WebGLCanvas;
        })(akra.render.Canvas3d);
        webgl.WebGLCanvas = WebGLCanvas;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        var WebGLShaderProgram = (function (_super) {
            __extends(WebGLShaderProgram, _super);
            function WebGLShaderProgram() {
                _super.apply(this, arguments);

                this._iTotalAttributes = 0;
            }
            WebGLShaderProgram.prototype.create = function (csVertex, csPixel) {
                if (arguments.length > 0) {
                    return this.compile(csVertex || "void main(void){gl_Position = vec4(0., 0., 0., 1.);}", csPixel || "void main(void){}");
                }
                return false;
            };
            WebGLShaderProgram.prototype.destroy = function () {
                this._pWebGLRenderer.deleteWebGLProgram(this._pWebGLProgram);
                this._pWebGLUniformLocations = null;
                this._pWebGLAttributeLocations = null;
                this._pWebGLAttributesInfo = null;
                this.notifyDestroyed();
                this.notifyDisabled();
            };
            WebGLShaderProgram.prototype.compile = function (csVertex, csPixel) {
                if (typeof csVertex === "undefined") { csVertex = "void main(void){gl_Position = vec4(0., 0., 0., 1.);}"; }
                if (typeof csPixel === "undefined") { csPixel = "void main(void){}"; }
                var pWebGLRenderer = this._pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = this._pWebGLContext = pWebGLRenderer.getWebGLContext();
                var pWebGLProgram = this._pWebGLProgram = pWebGLRenderer.createWebGLProgram();
                var pWebGLVs = this.createWebGLShader(0x8B31, csVertex);
                var pWebGLFs = this.createWebGLShader(0x8B30, csPixel);
                pWebGLRenderer._disableAllTextureUnits();
                pWebGLContext.attachShader(pWebGLProgram, pWebGLVs);
                pWebGLContext.attachShader(pWebGLProgram, pWebGLFs);
                pWebGLContext.linkProgram(pWebGLProgram);
                if (!this.isLinked()) {
 {
                        akra.logger.setSourceLocation("WebGLShaderProgram.ts", 65);
                        akra.logger.error("cannot link GLSL program(guid: %d)", this.getGuid());
                    }
                    ;
                    if (webgl.loadExtension(pWebGLContext, "WEBGL_debug_shaders")) {
 {
                            akra.logger.setSourceLocation("WebGLShaderProgram.ts", 71);
                            akra.logger.log("translated(from GLSL) VS shader: \n %s\ntranslated(from GLSL) PS shader: \n%s", pWebGLContext.getExtension("WEBGL_debug_shaders").getTranslatedShaderSource(pWebGLVs), pWebGLContext.getExtension("WEBGL_debug_shaders").getTranslatedShaderSource(pWebGLFs));
                        }
                        ;
                    }
                    var sInfo = pWebGLContext.getProgramInfoLog(pWebGLProgram);
 {
                        akra.logger.setSourceLocation("WebGLShaderProgram.ts", 76);
                        akra.logger.log("shader program errors: \n" + sInfo + "\n\nvertex code:\n" + csVertex + "\n\n pixel code: " + csPixel);
                    }
                    ;
                    return false;
                }
                pWebGLContext.validateProgram(pWebGLProgram);
                if (!this.isValid()) {
 {
                        akra.logger.setSourceLocation("WebGLShaderProgram.ts", 85);
                        akra.logger.warning("GLSL program not valid(guid: %d)", this.getGuid());
                    }
                    ;
 {
                        akra.logger.setSourceLocation("WebGLShaderProgram.ts", 87);
                        akra.logger.log(pWebGLContext.getProgramInfoLog(pWebGLProgram));
                    }
                    ;
                }
                this.obtainWebGLUniforms();
                this.obtainWebGLAttributes();
                this.notifyCreated();
                this.notifyRestored();
                return true;
            };
            Object.defineProperty(WebGLShaderProgram.prototype, "totalAttributes", {
                get: function () {
                    return this._iTotalAttributes;
                },
                enumerable: true,
                configurable: true
            });
            WebGLShaderProgram.prototype._getActiveUniformNames = function () {
                return Object.keys(this._pWebGLUniformLocations);
            };
            WebGLShaderProgram.prototype._getActiveAttributeNames = function () {
                return Object.keys(this._pWebGLAttributeLocations);
            };
            WebGLShaderProgram.prototype._getActiveAttribLocations = function () {
                return this._pWebGLAttributeLocations;
            };
            WebGLShaderProgram.prototype.isLinked = function () {
                return ((this._pWebGLProgram) != null) && this._pWebGLContext.getProgramParameter(this._pWebGLProgram, 0x8B82);
            };
            WebGLShaderProgram.prototype.isValid = function () {
                return ((this._pWebGLProgram) != null) && this._pWebGLContext.getProgramParameter(this._pWebGLProgram, 0x8B83);
            };
            WebGLShaderProgram.prototype.isActive = function () {
                return (((this._pWebGLProgram) != null) && this._pWebGLContext.getParameter(0x8B8D) === this._pWebGLProgram);
            };
            WebGLShaderProgram.prototype.setFloat = function (sName, fValue) {
                this._pWebGLContext.uniform1f(this._pWebGLUniformLocations[sName], fValue);
            };
            WebGLShaderProgram.prototype.setInt = function (sName, iValue) {
                this._pWebGLContext.uniform1i(this._pWebGLUniformLocations[sName], iValue);
            };
            WebGLShaderProgram.prototype.setVec2 = function (sName, x, y) {
                (arguments.length == 2) ? this._pWebGLContext.uniform2f(this._pWebGLUniformLocations[sName], arguments[1].x, arguments[1].y) : this._pWebGLContext.uniform2f(this._pWebGLUniformLocations[sName], arguments[1], arguments[2]);
            };
            WebGLShaderProgram.prototype.setVec2i = function (sName, x, y) {
                (arguments.length == 2) ? this._pWebGLContext.uniform2i(this._pWebGLUniformLocations[sName], arguments[1].x, arguments[1].y) : this._pWebGLContext.uniform2i(this._pWebGLUniformLocations[sName], arguments[1], arguments[2]);
            };
            WebGLShaderProgram.prototype.setVec3 = function (sName, x, y, z) {
                (arguments.length == 2) ? this._pWebGLContext.uniform3f(this._pWebGLUniformLocations[sName], arguments[1].x, arguments[1].y, arguments[1].z) : this._pWebGLContext.uniform3f(this._pWebGLUniformLocations[sName], arguments[1], arguments[2], arguments[3]);
            };
            WebGLShaderProgram.prototype.setVec3i = function (sName, x, y, z) {
                (arguments.length == 2) ? this._pWebGLContext.uniform3i(this._pWebGLUniformLocations[sName], arguments[1].x, arguments[1].y, arguments[1].z) : this._pWebGLContext.uniform3i(this._pWebGLUniformLocations[sName], arguments[1], arguments[2], arguments[3]);
            };
            WebGLShaderProgram.prototype.setVec4 = function (sName, x, y, z, w) {
                (arguments.length == 2) ? this._pWebGLContext.uniform4f(this._pWebGLUniformLocations[sName], arguments[1].x, arguments[1].y, arguments[1].z, arguments[1].w) : this._pWebGLContext.uniform4f(this._pWebGLUniformLocations[sName], arguments[1], arguments[2], arguments[3], arguments[3]);
            };
            WebGLShaderProgram.prototype.setVec4i = function (sName, x, y, z, w) {
                (arguments.length == 2) ? this._pWebGLContext.uniform4i(this._pWebGLUniformLocations[sName], arguments[1].x, arguments[1].y, arguments[1].z, arguments[1].w) : this._pWebGLContext.uniform4i(this._pWebGLUniformLocations[sName], arguments[1], arguments[2], arguments[3], arguments[3]);
            };
            WebGLShaderProgram.prototype.setMat3 = function (sName, m3fValue) {
                this._pWebGLContext.uniformMatrix3fv(this._pWebGLUniformLocations[sName], false, m3fValue.data);
            };
            WebGLShaderProgram.prototype.setMat4 = function (sName, m4fValue) {
                this._pWebGLContext.uniformMatrix4fv(this._pWebGLUniformLocations[sName], false, m4fValue.data);
            };
            WebGLShaderProgram.prototype.setFloat32Array = function (sName, pValue) {
                this._pWebGLContext.uniform1fv(this._pWebGLUniformLocations[sName], pValue);
            };
            WebGLShaderProgram.prototype.setInt32Array = function (sName, pValue) {
                this._pWebGLContext.uniform1iv(this._pWebGLUniformLocations[sName], pValue);
            };
            WebGLShaderProgram.uniformBuffer = new ArrayBuffer(4096 * 16);
            WebGLShaderProgram.prototype.setVec2Array = function (sName, pValue) {
                var pBuffer = new Float32Array(WebGLShaderProgram.uniformBuffer, 0, pValue.length * 2);
                for(var i = 0, j = 0; i < pValue.length; i += 2, ++j) {
                    pBuffer[i] = pValue[j].x;
                    pBuffer[i + 1] = pValue[j].y;
                }
                this._pWebGLContext.uniform2fv(this._pWebGLUniformLocations[sName], pBuffer);
            };
            WebGLShaderProgram.prototype.setVec2iArray = function (sName, pValue) {
                var pBuffer = new Int32Array(WebGLShaderProgram.uniformBuffer, 0, pValue.length * 2);
                for(var i = 0, j = 0; i < pValue.length; i += 2, ++j) {
                    pBuffer[i] = pValue[j].x;
                    pBuffer[i + 1] = pValue[j].y;
                }
                this._pWebGLContext.uniform2iv(this._pWebGLUniformLocations[sName], pBuffer);
            };
            WebGLShaderProgram.prototype.setVec3Array = function (sName, pValue) {
                var pBuffer = new Float32Array(WebGLShaderProgram.uniformBuffer, 0, pValue.length * 3);
                for(var i = 0, j = 0; i < pValue.length; i += 3, ++j) {
                    pBuffer[i] = pValue[j].x;
                    pBuffer[i + 1] = pValue[j].y;
                    pBuffer[i + 2] = pValue[j].z;
                }
                this._pWebGLContext.uniform3fv(this._pWebGLUniformLocations[sName], pBuffer);
            };
            WebGLShaderProgram.prototype.setVec3iArray = function (sName, pValue) {
                var pBuffer = new Int32Array(WebGLShaderProgram.uniformBuffer, 0, pValue.length * 3);
                for(var i = 0, j = 0; i < pValue.length; i += 3, ++j) {
                    pBuffer[i] = pValue[j].x;
                    pBuffer[i + 1] = pValue[j].y;
                    pBuffer[i + 2] = pValue[j].z;
                }
                this._pWebGLContext.uniform3iv(this._pWebGLUniformLocations[sName], pBuffer);
            };
            WebGLShaderProgram.prototype.setVec4Array = function (sName, pValue) {
                var pBuffer = new Float32Array(WebGLShaderProgram.uniformBuffer, 0, pValue.length * 4);
                for(var i = 0, j = 0; i < pValue.length; i += 4, ++j) {
                    pBuffer[i] = pValue[j].x;
                    pBuffer[i + 1] = pValue[j].y;
                    pBuffer[i + 2] = pValue[j].z;
                    pBuffer[i + 3] = pValue[j].w;
                }
                this._pWebGLContext.uniform4fv(this._pWebGLUniformLocations[sName], pBuffer);
            };
            WebGLShaderProgram.prototype.setVec4iArray = function (sName, pValue) {
                var pBuffer = new Int32Array(WebGLShaderProgram.uniformBuffer, 0, pValue.length * 4);
                for(var i = 0, j = 0; i < pValue.length; i += 4, ++j) {
                    pBuffer[i] = pValue[j].x;
                    pBuffer[i + 1] = pValue[j].y;
                    pBuffer[i + 2] = pValue[j].z;
                    pBuffer[i + 3] = pValue[j].w;
                }
                this._pWebGLContext.uniform4iv(this._pWebGLUniformLocations[sName], pBuffer);
            };
            WebGLShaderProgram.prototype.setMat3Array = function (sName, pValue) {
                var pBuffer = new Float32Array(WebGLShaderProgram.uniformBuffer, 0, pValue.length * 9);
                for(var i = 0; i < pValue.length; i++) {
                    pBuffer.set(pValue[i].data, 9 * i);
                }
                this._pWebGLContext.uniformMatrix3fv(this._pWebGLUniformLocations[sName], false, pBuffer);
            };
            WebGLShaderProgram.prototype.setMat4Array = function (sName, pValue) {
                var pBuffer = new Float32Array(WebGLShaderProgram.uniformBuffer, 0, pValue.length * 16);
                for(var i = 0; i < pValue.length; i++) {
                    pBuffer.set(pValue[i].data, 16 * i);
                }
                this._pWebGLContext.uniformMatrix4fv(this._pWebGLUniformLocations[sName], false, pBuffer);
            };
            WebGLShaderProgram.prototype.setStruct = function (sName, pData) {
            };
            WebGLShaderProgram.prototype.setSampler = function (sName, pSampler) {
                var iSlot = this.applySamplerState(pSampler);
                this.setInt(sName, iSlot);
            };
            WebGLShaderProgram.prototype.setVertexBuffer = function (sName, pBuffer) {
                var iSlot = this._pWebGLRenderer.getNextTextureSlot();
                this._pWebGLRenderer.activateWebGLTexture(iSlot + 0x84C0);
                this._pWebGLRenderer.bindWebGLTexture(0x0DE1, (pBuffer).getWebGLTexture());
                this.setInt(sName, iSlot);
            };
            WebGLShaderProgram.prototype.setSamplerArray = function (sName, pList) {
                var pBuffer = new Int32Array(WebGLShaderProgram.uniformBuffer, 0, pList.length);
                for(var i = 0; i < pList.length; ++i) {
                    pBuffer[i] = this.applySamplerState(pList[i]);
                }
                this.setInt32Array(sName, pBuffer);
            };
            WebGLShaderProgram.prototype.setTexture = function (sName, pData) {
            };
            WebGLShaderProgram.prototype.applySamplerState = function (pSampler) {
                var pTexture = pSampler.texture;
                if (((pTexture) === null)) {
                    return;
                }
                var iSlot = this._pWebGLRenderer.getNextTextureSlot();
                this._pWebGLRenderer.activateWebGLTexture(iSlot + 0x84C0);
                this._pWebGLRenderer.bindWebGLTexture(pTexture._getWebGLTextureTarget(), pTexture.getWebGLTexture());
                pTexture._setFilterInternalTexture(akra.ETextureParameters.MIN_FILTER, pSampler.mag_filter);
                pTexture._setFilterInternalTexture(akra.ETextureParameters.MAG_FILTER, pSampler.min_filter);
                pTexture._setWrapModeInternalTexture(akra.ETextureParameters.WRAP_S, pSampler.wrap_s);
                pTexture._setWrapModeInternalTexture(akra.ETextureParameters.WRAP_T, pSampler.wrap_t);
                return iSlot;
            };
            WebGLShaderProgram.prototype.applyVertexData = function (sName, pData) {
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                ;
                var pVertexBuffer = pData.buffer;
                var iStride = pData.stride;
                if (pVertexBuffer.type !== akra.EVertexBufferTypes.VBO) {
                    return false;
                }
                var pVertexDecl = pData.getVertexDeclaration();
                var pVertexElement;
                var iLoc;
                for(var i = 0; i < pVertexDecl.length; ++i) {
                    pVertexElement = pVertexDecl[i];
                    iLoc = this.getWebGLAttributeLocation(pVertexElement.usage);
                    if (iLoc < 0) {
 {
                            akra.logger.setSourceLocation("WebGLShaderProgram.ts", 375);
                            akra.logger.warning("founded invalid GLSL attribute location(guid: %s): %s", this.getGuid(), pVertexElement.usage);
                        }
                        ;
                        continue;
                    }
                    pWebGLRenderer.bindWebGLBuffer(0x8892, (pVertexBuffer).getWebGLBuffer());
                    pWebGLContext.vertexAttribPointer(iLoc, pVertexElement.count, pVertexElement.type, false, iStride, pVertexElement.offset);
                }
                return true;
            };
            WebGLShaderProgram.prototype.applyBufferMap = function (pMap) {
 {
                    akra.logger.setSourceLocation("WebGLShaderProgram.ts", 393);
                    akra.logger.criticalError("WebGLShaderProgram::applyBufferMap() is uncompleted method!");
                }
                ;
            };
            WebGLShaderProgram.prototype.getWebGLAttributeLocation = function (sName) {
                return ((this._pWebGLAttributeLocations[sName]) !== undefined) ? this._pWebGLAttributeLocations[sName] : -1;
            };
            WebGLShaderProgram.prototype.getWebGLUniformLocations = function () {
                return this._pWebGLUniformLocations;
            };
            WebGLShaderProgram.prototype.getWebGLUniformLocation = function (sName) {
                var iLoc = this._pWebGLUniformLocations[sName];
                if (!((iLoc) !== undefined)) {
 {
                        akra.logger.setSourceLocation("WebGLShaderProgram.ts", 410);
                        akra.logger.warning("could not find location for GLSL attribute(guid: %s): %s", this.getGuid(), sName);
                    }
                    ;
                }
                return null;
            };
            WebGLShaderProgram.prototype.getWebGLProgram = function () {
                return this._pWebGLProgram;
            };
            WebGLShaderProgram.prototype.createWebGLShader = function (eType, csCode) {
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                var pWebGLShader = pWebGLContext.createShader(eType);
                pWebGLContext.shaderSource(pWebGLShader, csCode);
                pWebGLContext.compileShader(pWebGLShader);
                if (!pWebGLContext.getShaderParameter(pWebGLShader, 0x8B81)) {
 {
                        akra.logger.setSourceLocation("WebGLShaderProgram.ts", 432);
                        akra.logger.error("cannot compile GLSL shader(guid: %d)", this.getGuid());
                    }
                    ;
                    var sInfo = pWebGLContext.getShaderInfoLog(pWebGLShader);
                    var sCode = pWebGLContext.getShaderSource(pWebGLShader) || csCode;
                    if (webgl.loadExtension(pWebGLContext, "WEBGL_debug_shaders")) {
 {
                            akra.logger.setSourceLocation("WebGLShaderProgram.ts", 439);
                            akra.logger.log("translated(from GLSL) " + (eType == 0x8B31 ? "VS" : "PS") + " shader: \n" + pWebGLContext.getExtension("WEBGL_debug_shaders").getTranslatedShaderSource(pWebGLShader));
                        }
                        ;
                    }
 {
                        akra.logger.setSourceLocation("WebGLShaderProgram.ts", 442);
                        akra.logger.log("shader errors: \n %s \n----------\n %s", sInfo, sCode);
                    }
                    ;
                    return null;
                }
                return pWebGLShader;
            };
            WebGLShaderProgram.prototype.obtainWebGLUniforms = function () {
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                ;
                var nUniforms = pWebGLContext.getProgramParameter(this._pWebGLProgram, 0x8B86);
                var pUniformLocations = {};
                var iLoc;
                var pUniformInfo;
                for(var i = 0; i < nUniforms; ++i) {
                    pUniformInfo = pWebGLContext.getActiveUniform(this._pWebGLProgram, i);
                    iLoc = pWebGLContext.getUniformLocation(this._pWebGLProgram, pUniformInfo.name);
                    pUniformLocations[pUniformInfo.name] = iLoc;
                }
                this._pWebGLUniformLocations = pUniformLocations;
            };
            WebGLShaderProgram.prototype.obtainWebGLAttributes = function () {
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                ;
                var nAttributes = pWebGLContext.getProgramParameter(this._pWebGLProgram, 0x8B89);
                var pAttributeLocations = {};
                var pAttributesInfo = [];
                var iLoc;
                var pAttributeInfo;
                for(var i = 0; i < nAttributes; ++i) {
                    pAttributeInfo = pWebGLContext.getActiveAttrib(this._pWebGLProgram, i);
                    iLoc = pWebGLContext.getAttribLocation(this._pWebGLProgram, pAttributeInfo.name);
                    if (iLoc < 0 || !((iLoc) !== undefined)) {
 {
                            akra.logger.setSourceLocation("WebGLShaderProgram.ts", 481);
                            akra.logger.warning("could not get GLSL attribute location(guid: %s): %s", this.getGuid(), pAttributeInfo.name);
                        }
                        ;
                    }
                    pAttributeLocations[pAttributeInfo.name] = iLoc;
                    pAttributesInfo[iLoc] = pAttributeInfo;
                }
                this._pWebGLAttributeLocations = pAttributeLocations;
                this._pWebGLAttributesInfo = pAttributesInfo;
                this._iTotalAttributes = nAttributes;
            };
            return WebGLShaderProgram;
        })(akra.core.pool.ResourcePoolItem);
        webgl.WebGLShaderProgram = WebGLShaderProgram;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        var WebGLRenderer = (function (_super) {
            __extends(WebGLRenderer, _super);
            function WebGLRenderer(pEngine, pCanvas) {
                        _super.call(this, pEngine);
                this._pWebGLInternalContext = null;
                this._nActiveAttributes = 0;
                this._iSlot = 0;
                if (((pCanvas) !== undefined)) {
                    if ((typeof (pCanvas) === "string")) {
                        this._pCanvas = document.getElementById(pCanvas);
                    } else {
                        this._pCanvas = pCanvas;
                    }
                } else {
                    this._pCanvas = document.createElement('canvas');
                }
                this._pWebGLContext = webgl.createContext(this._pCanvas);
                this._pWebGLFramebufferList = new Array(32);
                for(var i = 0; i < this._pWebGLFramebufferList.length; ++i) {
                    this._pWebGLFramebufferList[i] = this._pWebGLContext.createFramebuffer();
                }
                this._pDefaultCanvas = new webgl.WebGLCanvas(this);
                this.attachRenderTarget(this._pDefaultCanvas);
            }
            WebGLRenderer.prototype.debug = function (bValue, useApiTrace) {
                if (typeof bValue === "undefined") { bValue = true; }
                if (typeof useApiTrace === "undefined") { useApiTrace = false; }
                var pWebGLInternalContext = this._pWebGLContext;
                if (bValue) {
                    if ((((window).WebGLDebugUtils) !== undefined) && !((pWebGLInternalContext) === null)) {
                        this._pWebGLContext = WebGLDebugUtils.makeDebugContext(pWebGLInternalContext, function (err, funcName, args) {
                            throw WebGLDebugUtils.glEnumToString(err) + " was caused by call to: " + funcName;
                        }, useApiTrace ? function (funcName, args) {
 {
                                akra.logger.setSourceLocation("WebGLRenderer.ts", 73);
                                akra.logger.log("gl." + funcName + "(" + WebGLDebugUtils.glFunctionArgsToString(funcName, args) + ")");
                            }
                            ;
                        } : null);
                        this._pWebGLInternalContext = pWebGLInternalContext;
                        return true;
                    }
                } else if (this.isDebug()) {
                    this._pWebGLContext = this._pWebGLInternalContext;
                    this._pWebGLInternalContext = null;
                    return true;
                }
                return false;
            };
            WebGLRenderer.prototype._beginRender = function () {
                this._pWebGLContext.enable(0x0C11);
                this._pWebGLContext.disable(0x0BE2);
            };
            WebGLRenderer.prototype._renderEntry = function (pEntry) {
                var pViewport = pEntry.viewport;
                var pRenderTarget = (pViewport).getTarget();
                var pInput = pEntry.input;
                var pMaker = pEntry.maker;
                if (!((pEntry.renderTarget) === null)) {
                    this._setRenderTarget(pEntry.renderTarget);
                    this.lockRenderTarget();
                    this._setViewportForRender(pViewport);
                    this.unlockRenderTarget();
                } else {
                    this._setViewportForRender(pViewport);
                }
                var pWebGLProgram = (pMaker).shaderProgram;
                this.useWebGLProgram(pWebGLProgram.getWebGLProgram());
                this.enableWebGLVertexAttribs(pWebGLProgram.totalAttributes);
                var pAttribLocations = pWebGLProgram._getActiveAttribLocations();
                var pAttributeSemantics = pMaker.attributeSemantics;
                var pAttributeNames = pMaker.attributeNames;
                var pBufferMap = pEntry.bufferMap;
                if (!((pBufferMap.index) === null)) {
                    this.bindWebGLBuffer(0x8893, (pBufferMap.index.buffer).getWebGLBuffer());
                }
                var nPreparedBuffers = 0;
                for(var i = 0; i < pAttributeNames.length; i++) {
                    var sAttrName = pAttributeNames[i];
                    var sAttrSemantic = pAttributeSemantics[i];
                    if (((sAttrSemantic) === null)) {
                        continue;
                    }
                    var iLoc = pAttribLocations[sAttrName];
                    var pFlow = pInput[sAttrName];
                    var pData = null;
                    var sSemantics = null;
                    if (pFlow.type === akra.EDataFlowTypes.MAPPABLE) {
                        pData = pFlow.mapper.data;
                        sSemantics = pFlow.mapper.semantics;
                    } else {
                        pData = pFlow.data;
                        sSemantics = sAttrSemantic;
                    }
                    var pDecl = pData.getVertexDeclaration();
                    var pVertexElement = pDecl.findElement(sSemantics);
                    this.bindWebGLBuffer(0x8892, (pData.buffer).getWebGLBuffer());
                    this._pWebGLContext.vertexAttribPointer(iLoc, pVertexElement.count, pVertexElement.type, false, pData.stride, pVertexElement.offset);
                }
                var pUniforms = pWebGLProgram.getWebGLUniformLocations();
                for(var sUniformName in pUniforms) {
                    var pValue = pInput[sUniformName];
                    pMaker.setUniform(sUniformName, pValue);
                }
                pEntry.bufferMap._draw();
            };
            WebGLRenderer.prototype._endRender = function () {
                this._pWebGLContext.disable(0x0C11);
            };
            WebGLRenderer.prototype._setViewport = function (pViewport) {
                if (((pViewport) === null)) {
                    this._pActiveViewport = null;
                    this._setRenderTarget(null);
                    return;
                }
                var isViewportUpdate = pViewport !== this._pActiveViewport || pViewport.isUpdated();
                var isRenderTargetUpdate = pViewport.getTarget() !== this._pActiveRenderTarget;
                if (isViewportUpdate || isRenderTargetUpdate) {
                    var pTarget = pViewport.getTarget();
                    this._setRenderTarget(pTarget);
                    if (isViewportUpdate) {
                        this._pActiveViewport = pViewport;
                        var x = pViewport.actualLeft, y = pViewport.actualTop, w = pViewport.actualWidth, h = pViewport.actualHeight;
                        this._pWebGLContext.viewport(x, y, w, h);
                        this._pWebGLContext.scissor(x, y, w, h);
                        pViewport._clearUpdatedFlag();
                    }
                }
            };
            WebGLRenderer.prototype._setRenderTarget = function (pTarget) {
                if (this.isLockRenderTarget()) {
                    return;
                }
                this._pActiveRenderTarget = pTarget;
                if (!((pTarget) === null)) {
                    var pFrameBuffer = pTarget.getCustomAttribute("FBO");
                    if (!((pFrameBuffer) === null)) {
                        pFrameBuffer._bind();
                    } else {
                        this.bindWebGLFramebuffer(0x8D40, null);
                    }
                }
            };
            WebGLRenderer.prototype._setCullingMode = function (eMode) {
                var iWebGLCullMode = 0;
                switch(eMode) {
                    case akra.ECullingMode.NONE:
                        this._pWebGLContext.disable(0x0B44);
                        return;
                    default:
                    case akra.ECullingMode.CLOCKWISE:
                        iWebGLCullMode = 0x0404;
                        break;
                    case akra.ECullingMode.ANTICLOCKWISE:
                        iWebGLCullMode = 0x0405;
                        break;
                }
                this._pWebGLContext.enable(0x0B44);
                this._pWebGLContext.cullFace(iWebGLCullMode);
            };
            WebGLRenderer.prototype._setDepthBufferParams = function (bDepthTest, bDepthWrite, eDepthFunction, fClearDepth) {
                if (typeof fClearDepth === "undefined") { fClearDepth = 1.; }
                if (bDepthTest) {
                    this._pWebGLContext.clearDepth(fClearDepth);
                    this._pWebGLContext.enable(0x0B71);
                } else {
                    this._pWebGLContext.disable(0x0B71);
                }
                this._pWebGLContext.depthMask(bDepthWrite);
                this._pWebGLContext.depthFunc(this.convertCompareFunction(eDepthFunction));
            };
            WebGLRenderer.prototype.isDebug = function () {
                return !((this._pWebGLInternalContext) === null);
            };
            WebGLRenderer.prototype.getHTMLCanvas = function () {
                return this._pCanvas;
            };
            WebGLRenderer.prototype.getWebGLContext = function () {
                return this._pWebGLContext;
            };
            WebGLRenderer.prototype.bindWebGLBuffer = function (eTarget, pBuffer) {
                this._pWebGLContext.bindBuffer(eTarget, pBuffer);
            };
            WebGLRenderer.prototype.createWebGLBuffer = function () {
                return this._pWebGLContext.createBuffer();
            };
            WebGLRenderer.prototype.deleteWebGLBuffer = function (pBuffer) {
                this._pWebGLContext.deleteBuffer(pBuffer);
            };
            WebGLRenderer.prototype.bindWebGLTexture = function (eTarget, pTexture) {
                this._pWebGLContext.bindTexture(eTarget, pTexture);
            };
            WebGLRenderer.prototype.activateWebGLTexture = function (iWebGLSlot) {
                this._pWebGLContext.activeTexture(iWebGLSlot);
            };
            WebGLRenderer.prototype.getNextTextureSlot = function () {
                return this._iSlot === (webgl.maxTextureImageUnits - 1) ? (this._iSlot = 0) : (++this._iSlot);
            };
            WebGLRenderer.prototype.getTextureSlot = function () {
                return this._iSlot - 1;
            };
            WebGLRenderer.prototype.createWebGLTexture = function () {
                return this._pWebGLContext.createTexture();
            };
            WebGLRenderer.prototype.deleteWebGLTexture = function (pTexture) {
                this._pWebGLContext.deleteTexture(pTexture);
            };
            WebGLRenderer.prototype.createWebGLFramebuffer = function () {
                if (this._pWebGLFramebufferList.length === 0) {
 {
                        akra.logger.setSourceLocation("WebGLRenderer.ts", 347);
                        akra.logger.criticalError("WebGL framebuffer limit exidit");
                    }
                    ;
                }
                return this._pWebGLFramebufferList.pop();
            };
            WebGLRenderer.prototype.bindWebGLFramebuffer = function (eTarget, pBuffer) {
                this._pWebGLContext.bindFramebuffer(eTarget, pBuffer);
            };
            WebGLRenderer.prototype.bindWebGLFramebufferTexture2D = function (eTarget, eAttachment, eTexTarget, pTexture, iMipLevel) {
                if (typeof iMipLevel === "undefined") { iMipLevel = 0; }
                this._pWebGLContext.framebufferTexture2D(eTarget, eAttachment, eTexTarget, pTexture, iMipLevel);
            };
            WebGLRenderer.prototype.deleteWebGLFramebuffer = function (pBuffer) {
                this._pWebGLFramebufferList.push(pBuffer);
            };
            WebGLRenderer.prototype.createWebGLRenderbuffer = function () {
                return this._pWebGLContext.createRenderbuffer();
            };
            WebGLRenderer.prototype.bindWebGLRenderbuffer = function (eTarget, pBuffer) {
                this._pWebGLContext.bindRenderbuffer(eTarget, pBuffer);
            };
            WebGLRenderer.prototype.deleteWebGLRenderbuffer = function (pBuffer) {
                this._pWebGLContext.deleteRenderbuffer(pBuffer);
            };
            WebGLRenderer.prototype.createWebGLProgram = function () {
                return this._pWebGLContext.createProgram();
            };
            WebGLRenderer.prototype.deleteWebGLProgram = function (pProgram) {
                this._pWebGLContext.deleteProgram(pProgram);
            };
            WebGLRenderer.prototype.useWebGLProgram = function (pProgram) {
                this._pWebGLContext.useProgram(pProgram);
            };
            WebGLRenderer.prototype.enableWebGLVertexAttribs = function (iTotal) {
                if (this._nActiveAttributes > iTotal) {
                    for(var i = iTotal; i < this._nActiveAttributes; i++) {
                        this._pWebGLContext.disableVertexAttribArray(i);
                    }
                } else {
                    for(var i = this._nActiveAttributes; i < iTotal; i++) {
                        this._pWebGLContext.enableVertexAttribArray(i);
                    }
                }
                this._nActiveAttributes = iTotal;
            };
            WebGLRenderer.prototype.disableAllWebGLVertexAttribs = function () {
                var i = 0;
                for(i = 0; i < this._nActiveAttributes; i++) {
                    this._pWebGLContext.disableVertexAttribArray(i);
                }
                this._nActiveAttributes = 0;
            };
            WebGLRenderer.prototype.getDefaultCanvas = function () {
                return this._pDefaultCanvas;
            };
            WebGLRenderer.prototype.clearFrameBuffer = function (iBuffers, cColor, fDepth, iStencil) {
                var iWebGLFlag = 0;
                var bOldDepthWrite = this._pWebGLContext.getParameter(0x0B72);
                if (iBuffers & akra.EFrameBufferTypes.COLOR) {
                    iWebGLFlag |= 0x00004000;
                    this._pWebGLContext.clearColor(cColor.r, cColor.g, cColor.b, cColor.a);
                }
                if (iBuffers & akra.EFrameBufferTypes.DEPTH) {
                    iWebGLFlag |= 0x00000100;
                    if (!bOldDepthWrite) {
                        this._pWebGLContext.depthMask(true);
                    }
                    this._pWebGLContext.clearDepth(fDepth);
                }
                if (iBuffers & akra.EFrameBufferTypes.STENCIL) {
                    iWebGLFlag |= 0x00000400;
                    this._pWebGLContext.stencilMask(0xFFFFFFFF);
                    this._pWebGLContext.clearStencil(iStencil);
                }
                this._pWebGLContext.clear(iWebGLFlag);
                if (!bOldDepthWrite && (iBuffers & akra.EFrameBufferTypes.DEPTH)) {
                    this._pWebGLContext.depthMask(false);
                }
            };
            WebGLRenderer.prototype.convertCompareFunction = function (eFunc) {
                switch(eFunc) {
                    case akra.ECompareFunction.ALWAYS_FAIL:
                        return 0x0200;
                    case akra.ECompareFunction.ALWAYS_PASS:
                        return 0x0207;
                    case akra.ECompareFunction.LESS:
                        return 0x0201;
                    case akra.ECompareFunction.LESS_EQUAL:
                        return 0x0203;
                    case akra.ECompareFunction.EQUAL:
                        return 0x0202;
                    case akra.ECompareFunction.NOT_EQUAL:
                        return 0x0205;
                    case akra.ECompareFunction.GREATER_EQUAL:
                        return 0x0206;
                    case akra.ECompareFunction.GREATER:
                        return 0x0204;
                }
                return 0x0207;
            };
            return WebGLRenderer;
        })(akra.render.Renderer);
        webgl.WebGLRenderer = WebGLRenderer;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        function computeLog(iValue) {
            var i = 0;
            if (iValue === 0) {
                return -1;
            }
            for(; ; ) {
                if (iValue & 1) {
                    if (iValue !== 1) {
                        return -1;
                    }
                    return i;
                }
                iValue = iValue >> 1;
                i++;
            }
        }
        webgl.computeLog = computeLog;
        var WebGLTextureBuffer = (function (_super) {
            __extends(WebGLTextureBuffer, _super);
            function WebGLTextureBuffer() {
                        _super.call(this);
                this._eTarget = null;
                this._eFaceTarget = null;
                this._pWebGLTexture = null;
                this._iFace = 0;
                this._iLevel = 0;
                this._bSoftwareMipmap = false;
                this._pRTTList = null;
            }
            WebGLTextureBuffer.prototype._clearRTT = function (iZOffset) {
                this._pRTTList[iZOffset] = null;
            };
            WebGLTextureBuffer.prototype.reset = function (iWidth, iHeight) {
                if (typeof iWidth === "undefined") { iWidth = this._iWidth; }
                if (typeof iHeight === "undefined") { iHeight = iWidth; }
                iWidth = akra.math.ceilingPowerOfTwo(iWidth);
                iHeight = akra.math.ceilingPowerOfTwo(iHeight);
                this._iWidth = this._iLevel === 0 ? iWidth : iWidth / Math.pow(2.0, this._iLevel);
                this._iHeight = this._iLevel === 0 ? iHeight : iHeight / Math.pow(2.0, this._iLevel);
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLRenderer.bindWebGLTexture(this._eTarget, this._pWebGLTexture);
                pWebGLContext.texImage2D(this._eFaceTarget, this._iLevel, webgl.getClosestWebGLInternalFormat(webgl.getSupportedAlternative(this._eFormat)), this._iWidth, this._iHeight, 0, webgl.getWebGLFormat(this._eFormat), webgl.getWebGLDataType(this._eFormat), null);
                this.byteLength = akra.pixelUtil.getMemorySize(this._iWidth, this._iHeight, this._iDepth, this._eFormat);
                this._pBuffer.setPosition(0, 0, this._iWidth, this._iHeight, 0, this._iDepth);
                this.notifyResized();
            };
            WebGLTextureBuffer.prototype.notifyResized = function () {
                if (!((this._pRTTList) === null)) {
                    for(var i = 0; i < this._pRTTList.length; ++i) {
                        this._pRTTList[i].resized();
                    }
                }
            };
            WebGLTextureBuffer.prototype.create = function () {
                if (arguments.length < 6) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 96);
                        akra.logger.criticalError("Invalid number of params. For WebGLTextureBuffer");
                    }
                    ;
                }
                var eTarget = arguments[0];
                var pTexture = arguments[1];
                var iWidth = arguments[2];
                var iHeight = arguments[3];
                var iInternalFormat = arguments[4];
                var iFormat = arguments[5];
                var iFace = arguments[6];
                var iLevel = arguments[7];
                var iFlags = arguments[8];
                var bSoftwareMipmap = arguments[9];
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                pWebGLRenderer.bindWebGLTexture(eTarget, pTexture);
                this._eTarget = eTarget;
                this._pWebGLTexture = pTexture;
                this._iFace = iFace;
                this._iLevel = iLevel;
                this._iFlags = iFlags;
                this._bSoftwareMipmap = bSoftwareMipmap;
                this._eFaceTarget = eTarget;
                if (eTarget === 0x8513) {
                    this._eFaceTarget = 0x8515 + iFace;
                }
                this._iWidth = iLevel === 0 ? iWidth : iWidth / Math.pow(2.0, iLevel);
                this._iHeight = iLevel === 0 ? iHeight : iHeight / Math.pow(2.0, iLevel);
                this._iDepth = 1;
                this._iWebGLInternalFormat = iInternalFormat;
                this._eFormat = webgl.getClosestAkraFormat(iInternalFormat, iFormat);
                this._iRowPitch = this._iWidth;
                this._iSlicePitch = this._iHeight * this._iWidth;
                this.byteLength = akra.pixelUtil.getMemorySize(this._iWidth, this._iHeight, this._iDepth, this._eFormat);
                this._pBuffer = new akra.pixelUtil.PixelBox(this._iWidth, this._iHeight, this._iDepth, this._eFormat);
                if (this._iWidth === 0 || this._iHeight === 0 || this._iDepth === 0) {
                    return false;
                }
                if ((((this._iFlags) & (akra.ETextureFlags.RENDERTARGET)) != 0)) {
                    this._pRTTList = new Array();
                    for(var iZOffset = 0; iZOffset < this._iDepth; ++iZOffset) {
                        var pRenderTexture = new webgl.WebGLRenderTexture(pWebGLRenderer, this);
                        this._pRTTList.push(pRenderTexture);
                        pWebGLRenderer.attachRenderTarget(pRenderTexture);
                    }
                }
                var pProgram = this.getManager().shaderProgramPool.findResource("WEBGL_blit_texture_buffer");
                if (((pProgram) === null)) {
                    pProgram = this.getManager().shaderProgramPool.createResource("WEBGL_blit_texture_buffer");
                    pProgram.create("																									\n	        	attribute vec2 POSITION;																			\n				attribute vec3 TEXCOORD;																			\n				                      																				\n				varying vec3 texcoord;																				\n				                   																					\n				void main(void){																					\n				    texcoord = TEXCOORD;																			\n				    gl_Position = vec4(POSITION, 0., 1.);															\n				}																									\n				", "													\n				#ifdef GL_ES                        				\n				    precision highp float;          				\n				#endif												\n				varying vec3 texcoord;              				\n				uniform sampler2D uSampler;        					\n																	\n				void main(void) {  									\n					vec4 color;										\n					color = texture2D(uSampler, texcoord.xy);      	\n				    gl_FragColor = color;           				\n				}                                   				\n				");
                }
                return true;
            };
            WebGLTextureBuffer.prototype.destroy = function () {
                if ((((this._iFlags) & (akra.ETextureFlags.RENDERTARGET)) != 0)) {
                    var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                    for(var i = 0; i < this._pRTTList.length; i++) {
                        pWebGLRenderer.destroyRenderTarget(this._pRTTList[i]);
                    }
                }
            };
            WebGLTextureBuffer.prototype.upload = function (pData, pDestBox) {
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLRenderer.bindWebGLTexture(this._eTarget, this._pWebGLTexture);
                if (akra.pixelUtil.isCompressed(pData.format)) {
                    if (pData.format !== this._eFormat || !pData.isConsecutive()) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 217);
                            akra.logger.criticalError("Compressed images must be consecutive, in the source format");
                        }
                        ;
                    }
                    var iWebGLFormat = akra.webgl.getClosestWebGLInternalFormat(this._eFormat);
                    if (pDestBox.left === 0 && pDestBox.top === 0) {
                        pWebGLContext.compressedTexImage2D(this._eFaceTarget, this._iLevel, iWebGLFormat, pDestBox.width, pDestBox.height, 0, pData.data);
                    } else {
                        pWebGLContext.compressedTexSubImage2D(this._eFaceTarget, this._iLevel, pDestBox.left, pDestBox.top, pDestBox.width, pDestBox.height, iWebGLFormat, pData.data);
                    }
                } else if (this._bSoftwareMipmap) {
                    if (pData.width !== pData.rowPitch) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 242);
                            akra.logger.criticalError("Unsupported texture format");
                        }
                        ;
                    }
                    if (pData.height * pData.width !== pData.slicePitch) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 247);
                            akra.logger.criticalError("Unsupported texture format");
                        }
                        ;
                    }
                    pWebGLContext.pixelStorei(0x0CF5, 1);
                    this.buildMipmaps(pData);
                } else {
                    if (pData.width !== pData.rowPitch) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 256);
                            akra.logger.criticalError("Unsupported texture format");
                        }
                        ;
                    }
                    if (pData.height * pData.width !== pData.slicePitch) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 261);
                            akra.logger.criticalError("Unsupported texture format");
                        }
                        ;
                    }
                    if ((pData.width * akra.pixelUtil.getNumElemBytes(pData.format)) & 3) {
                        pWebGLContext.pixelStorei(0x0CF5, 1);
                    }
                    if (pDestBox.left === 0 && pDestBox.top === 0) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 269);
                            akra.logger.log("Buffer::upload --> One color:", pData.data[0], pData.data[1], pData.data[2], pData.format, akra.webgl.getWebGLFormat(pData.format), akra.webgl.getWebGLDataType(pData.format));
                        }
                        ;
                        pWebGLContext.texImage2D(this._eFaceTarget, this._iLevel, akra.webgl.getWebGLFormat(pData.format), pDestBox.width, pDestBox.height, 0, akra.webgl.getWebGLFormat(pData.format), akra.webgl.getWebGLDataType(pData.format), new Uint8Array(pData.data));
                    } else {
                        pWebGLContext.texSubImage2D(this._eFaceTarget, this._iLevel, pDestBox.left, pDestBox.top, pDestBox.width, pDestBox.height, akra.webgl.getWebGLFormat(pData.format), akra.webgl.getWebGLDataType(pData.format), pData.data);
                    }
                }
                if ((((this._iFlags) & (akra.ETextureFlags.AUTOMIPMAP)) != 0) && !this._bSoftwareMipmap && (this._iLevel === 0)) {
                    pWebGLContext.generateMipmap(this._eFaceTarget);
                }
                pWebGLContext.pixelStorei(0x0CF5, 4);
                this.notifyAltered();
            };
            WebGLTextureBuffer.prototype.download = function (pData) {
                if ((pData.right > this._iWidth) || (pData.bottom > this._iHeight) || (pData.front != 0) || (pData.back != 1)) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 304);
                        akra.logger.criticalError("Invalid box");
                    }
                    ;
                }
                var pSrcBox;
                if (webgl.checkReadPixelFormat(pData.format)) {
                    pSrcBox = pData;
                } else {
                    console.log("download. new Pixel Box подходящего формата");
                    pSrcBox = new akra.pixelUtil.PixelBox(pData, akra.EPixelFormats.BYTE_ABGR);
                }
                if (!webgl.checkFBOAttachmentFormat(this.format)) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 320);
                        akra.logger.criticalError("Read from texture this format not support");
                    }
                    ;
                }
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                var pOldFramebuffer = pWebGLContext.getParameter(0x8CA6);
                var pFrameBuffer = pWebGLRenderer.createWebGLFramebuffer();
                pWebGLRenderer.bindWebGLFramebuffer(0x8D40, pFrameBuffer);
                var eFormat = webgl.getWebGLFormat(pSrcBox.format);
                var eType = webgl.getWebGLDataType(pSrcBox.format);
                pWebGLContext.framebufferTexture2D(0x8D40, 0x8CE0, this._eFaceTarget, this._pWebGLTexture, this._iLevel);
                pWebGLContext.readPixels(pSrcBox.left, pSrcBox.top, pSrcBox.width, pSrcBox.height, eFormat, eType, pSrcBox.data);
                if (!webgl.checkReadPixelFormat(pData.format)) {
                    console.log("download. конвертация");
                    akra.pixelUtil.bulkPixelConversion(pSrcBox, pData);
                }
                pWebGLRenderer.bindWebGLFramebuffer(0x8D40, pOldFramebuffer);
                pWebGLRenderer.deleteWebGLFramebuffer(pFrameBuffer);
            };
            WebGLTextureBuffer.prototype.buildMipmaps = function (pData) {
                var iWidth = 0;
                var iHeight = 0;
                var iLogW = 0;
                var iLogH = 0;
                var iLevel = 0;
                var pScaled = new akra.pixelUtil.PixelBox();
                pScaled.data = pData.data;
                pScaled.left = pData.left;
                pScaled.right = pData.right;
                pScaled.top = pData.top;
                pScaled.bottom = pData.bottom;
                pScaled.front = pData.front;
                pScaled.back = pData.back;
                iWidth = pData.width;
                iHeight = pData.height;
                iLogW = computeLog(iWidth);
                iLogH = computeLog(iHeight);
                iLevel = (iLogW > iLogH ? iLogW : iLogH);
                var mip = 0;
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                for(mip = 0; mip <= iLevel; mip++) {
                    var iWebGLFormat = akra.webgl.getWebGLFormat(pScaled.format);
                    var iWebGLDataType = akra.webgl.getWebGLDataType(pScaled.format);
                    pWebGLContext.texImage2D(this._eFaceTarget, mip, iWebGLFormat, iWidth, iHeight, 0, iWebGLFormat, iWebGLDataType, pScaled.data);
                    if (mip !== 0) {
                        pScaled.data = null;
                    }
                    if (iWidth > 1) {
                        iWidth = iWidth / 2;
                    }
                    if (iHeight > 1) {
                        iHeight = iHeight / 2;
                    }
                    var iSizeInBytes = akra.pixelUtil.getMemorySize(iWidth, iHeight, 1, pData.format);
                    pScaled = new akra.pixelUtil.PixelBox(iWidth, iHeight, 1, pData.format);
                    pScaled.data = new Uint8Array(iSizeInBytes);
                    pData.scale(pScaled, akra.EFilters.LINEAR);
                }
                if (iLevel > 0) {
                    pScaled.data = null;
                }
            };
            WebGLTextureBuffer.prototype._bindToFramebuffer = function (iAttachment, iZOffset) {
 {
                    akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 447);
                    akra.logger.assert(iZOffset < this._iDepth);
                }
                ;
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLContext.framebufferTexture2D(0x8D40, iAttachment, this._eFaceTarget, this._pWebGLTexture, this._iLevel);
            };
            WebGLTextureBuffer.prototype._copyFromFramebuffer = function (iZOffset) {
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLRenderer.bindWebGLTexture(this._eTarget, this._pWebGLTexture);
                pWebGLContext.copyTexSubImage2D(this._eFaceTarget, this._iLevel, 0, 0, 0, 0, this._iWidth, this._iHeight);
            };
            WebGLTextureBuffer.prototype._getTarget = function () {
                return this._eTarget;
            };
            WebGLTextureBuffer.prototype._getWebGLTexture = function () {
                return this._pWebGLTexture;
            };
            WebGLTextureBuffer.prototype.blit = function (pSource, pSrcBox, pDestBox) {
                if (arguments.length == 1) {
                    return this.blit(pSource, new akra.geometry.Box(0, 0, 0, pSource.width, pSource.height, pSource.depth), new akra.geometry.Box(0, 0, 0, this._iWidth, this._iHeight, this._iDepth));
                } else {
                    var pSourceTexture = pSource;
                    if (!(((pSourceTexture.getFlags()) & (akra.ETextureFlags.RENDERTARGET)) != 0) && pSourceTexture._getTarget() === 0x0DE1) {
                        return this.blitFromTexture(pSourceTexture, pSrcBox, pDestBox);
                    } else {
                        return _super.prototype.blit.call(this, pSource, pSrcBox, pDestBox);
                    }
                }
            };
            WebGLTextureBuffer.prototype.blitFromTexture = function (pSource, pSrcBox, pDestBox) {
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLRenderer._disableTextureUnitsFrom(0);
                pWebGLRenderer.activateWebGLTexture(0x84C0);
                pWebGLContext.disable(0x0B71);
                pWebGLContext.disable(0x0C11);
                pWebGLContext.disable(0x0BE2);
                pWebGLContext.disable(0x0B44);
                pWebGLRenderer.bindWebGLTexture(pSource._getTarget(), pSource._getWebGLTexture());
                if (pSrcBox.width === pDestBox.width && pSrcBox.height === pDestBox.height && pSrcBox.depth === pDestBox.depth) {
                    pWebGLContext.texParameteri(pSource._getTarget(), 0x2801, 0x2600);
                    pWebGLContext.texParameteri(pSource._getTarget(), 0x2800, 0x2600);
                } else {
                    if ((((pSource.getFlags()) & (akra.ETextureFlags.AUTOMIPMAP)) != 0)) {
                        pWebGLContext.texParameteri(pSource._getTarget(), 0x2801, 0x2703);
                        pWebGLContext.texParameteri(pSource._getTarget(), 0x2800, 0x2601);
                    } else {
                        pWebGLContext.texParameteri(pSource._getTarget(), 0x2801, 0x2601);
                        pWebGLContext.texParameteri(pSource._getTarget(), 0x2800, 0x2601);
                    }
                }
                pWebGLContext.texParameteri(pSource._getTarget(), 0x2802, 0x812F);
                pWebGLContext.texParameteri(pSource._getTarget(), 0x2803, 0x812F);
                var pOldFramebuffer = pWebGLContext.getParameter(0x8CA6);
                var pFramebuffer = pWebGLRenderer.createWebGLFramebuffer();
                pWebGLRenderer.bindWebGLFramebuffer(0x8D40, pFramebuffer);
                var pTempWebGLTexture = null;
                if (!akra.webgl.checkFBOAttachmentFormat(this._eFormat) || pSource === this) {
                    var iGLTempFormat = akra.webgl.getClosestWebGLInternalFormat(akra.webgl.getSupportedAlternative(this._eFormat));
                    pTempWebGLTexture = pWebGLRenderer.createWebGLTexture();
                    pWebGLRenderer.bindWebGLTexture(0x0DE1, pTempWebGLTexture);
                    pWebGLContext.texImage2D(0x0DE1, 0, iGLTempFormat, akra.math.ceilingPowerOfTwo(pDestBox.width), akra.math.ceilingPowerOfTwo(pDestBox.height), 0, 0x1908, 0x1401, null);
                    pWebGLContext.framebufferTexture2D(0x8D40, 0x8CE0, 0x0DE1, pTempWebGLTexture, 0);
                    pWebGLContext.viewport(0, 0, pDestBox.width, pDestBox.height);
                } else {
                    pWebGLContext.viewport(pDestBox.left, pDestBox.top, pDestBox.width, pDestBox.height);
                }
                var pWebGLShaderProgram = this.getManager().shaderProgramPool.findResource("WEBGL_blit_texture_buffer");
                pWebGLRenderer.disableAllWebGLVertexAttribs();
                pWebGLRenderer.useWebGLProgram(pWebGLShaderProgram.getWebGLProgram());
                var iPosAttrIndex = 0;
                var iTexAttrIndex = 0;
                iPosAttrIndex = pWebGLShaderProgram.getWebGLAttributeLocation("POSITION");
                iTexAttrIndex = pWebGLShaderProgram.getWebGLAttributeLocation("TEXCOORD");
                pWebGLContext.enableVertexAttribArray(iPosAttrIndex);
                pWebGLContext.enableVertexAttribArray(iTexAttrIndex);
                var pSquareVertices = new Float32Array([
                    -1.0, 
                    -1.0, 
                    1.0, 
                    -1.0, 
                    -1.0, 
                    1.0, 
                    1.0, 
                    1.0
                ]);
                var pTexCoords = new Float32Array(12);
                var pPositionBuffer = pWebGLRenderer.createWebGLBuffer();
                var pTexCoordsBuffer = pWebGLRenderer.createWebGLBuffer();
                pWebGLRenderer.bindWebGLBuffer(0x8892, pPositionBuffer);
                pWebGLContext.bufferData(0x8892, pSquareVertices, 0x88E0);
                pWebGLContext.vertexAttribPointer(iPosAttrIndex, 2, 0x1406, false, 0, 0);
                pWebGLShaderProgram.setInt("uSampler", 0);
                var iSlice = 0;
                for(iSlice = pDestBox.front; iSlice < pDestBox.back; ++iSlice) {
                    if (((pTempWebGLTexture) === null)) {
                        this._bindToFramebuffer(0x8CE0, iSlice);
                    }
                    var u1 = pSrcBox.left / pSource.width;
                    var v1 = pSrcBox.top / pSource.height;
                    var u2 = pSrcBox.right / pSource.width;
                    var v2 = pSrcBox.bottom / pSource.height;
                    var w = (iSlice - pDestBox.front) / pDestBox.depth;
                    w = w * pSrcBox.depth + pSrcBox.front;
                    w = (w + 0.5) / pSource.depth;
                    pTexCoords[0] = u1;
                    pTexCoords[1] = v1;
                    pTexCoords[2] = w;
                    pTexCoords[3] = u2;
                    pTexCoords[4] = v1;
                    pTexCoords[5] = w;
                    pTexCoords[6] = u2;
                    pTexCoords[7] = v2;
                    pTexCoords[8] = w;
                    pTexCoords[9] = u1;
                    pTexCoords[10] = v2;
                    pTexCoords[11] = w;
                    pWebGLRenderer.bindWebGLTexture(pSource._getTarget(), pSource._getWebGLTexture());
                    pWebGLContext.enable(pSource._getTarget());
                    pWebGLRenderer.bindWebGLBuffer(0x8892, pTexCoordsBuffer);
                    pWebGLContext.bufferData(0x8892, pTexCoords, 0x88E0);
                    pWebGLContext.vertexAttribPointer(iTexAttrIndex, 3, 0x1406, false, 0, 0);
                    pWebGLContext.drawArrays(0x0005, 0, 4);
                    pWebGLContext.disable(pSource._getTarget());
                    if (!((pTempWebGLTexture) === null)) {
                        if (pSource === this) {
                            pWebGLRenderer.deleteWebGLTexture(this._pWebGLTexture);
                            this._pWebGLTexture = pTempWebGLTexture;
                            this._iWidth = akra.math.ceilingPowerOfTwo(pDestBox.width);
                            this._iHeight = akra.math.ceilingPowerOfTwo(pDestBox.height);
                        } else {
                            pWebGLRenderer.bindWebGLTexture(this._eTarget, this._pWebGLTexture);
                            switch(this._eTarget) {
                                case 0x0DE1:
                                case 0x8513:
                                    pWebGLContext.copyTexSubImage2D(this._eFaceTarget, this._iLevel, pDestBox.left, pDestBox.top, 0, 0, pDestBox.width, pDestBox.height);
                                    break;
                            }
                        }
                    }
                }
                pWebGLContext.disableVertexAttribArray(iPosAttrIndex);
                pWebGLContext.disableVertexAttribArray(iTexAttrIndex);
                pWebGLRenderer.deleteWebGLBuffer(pPositionBuffer);
                pWebGLRenderer.deleteWebGLBuffer(pTexCoordsBuffer);
                if (!((pTempWebGLTexture) === null)) {
                    if ((((this._iFlags) & (akra.ETextureFlags.AUTOMIPMAP)) != 0)) {
                        pWebGLRenderer.bindWebGLTexture(this._eTarget, this._pWebGLTexture);
                        pWebGLContext.generateMipmap(this._eTarget);
                    }
                }
                pWebGLRenderer.bindWebGLTexture(this._eTarget, this._pWebGLTexture);
                pWebGLContext.framebufferRenderbuffer(0x8D40, 0x8CE0, 0x8D41, null);
                pWebGLRenderer.bindWebGLFramebuffer(0x8D40, pOldFramebuffer);
                if (pSource !== this) {
                    pWebGLRenderer.deleteWebGLTexture(pTempWebGLTexture);
                }
                pWebGLRenderer.deleteWebGLFramebuffer(pFramebuffer);
                pTempWebGLTexture = null;
                this.notifyAltered();
                return true;
            };
            WebGLTextureBuffer.prototype.blitFromMemory = function () {
                if (arguments.length === 1) {
                    return _super.prototype.blitFromMemory.call(this, arguments[0]);
                }
                var pSourceOrigin = arguments[0];
                var pDestBox = arguments[1];
                if (akra.pixelUtil.isLuminance(pSourceOrigin.format) || akra.pixelUtil.isLuminance(this._eFormat) || (pSourceOrigin.width === pDestBox.width && pSourceOrigin.height === pDestBox.height && pSourceOrigin.depth === pDestBox.depth)) {
                    return _super.prototype.blitFromMemory.call(this, pSourceOrigin, pDestBox);
                }
                if (!this._pBuffer.contains(pDestBox)) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 739);
                        akra.logger.criticalError("Destination box out of range");
                    }
                    ;
                }
                var pSource;
                if (webgl.getWebGLFormat(pSourceOrigin.format) === 0) {
                    var iSizeInBytes = akra.pixelUtil.getMemorySize(pSourceOrigin.width, pSourceOrigin.height, pSourceOrigin.depth, this._eFormat);
                    pSource = new akra.pixelUtil.PixelBox(pSourceOrigin.width, pSourceOrigin.height, pSourceOrigin.depth, this._eFormat, new Uint8Array(iSizeInBytes));
                    akra.pixelUtil.bulkPixelConversion(pSourceOrigin, pSource);
                } else {
                    pSource = pSourceOrigin;
                }
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                var pTempWebGLTexture = null;
                var eTarget = 0x0DE1;
                var iWidth = akra.math.ceilingPowerOfTwo(pSource.width);
                var iHeight = akra.math.ceilingPowerOfTwo(pSource.height);
                var iWebGLFormat = webgl.getClosestWebGLInternalFormat(pSource.format);
                var iWebGLDataType = webgl.getWebGLDataType(pSource.format);
                pTempWebGLTexture = pWebGLRenderer.createWebGLTexture();
                if (((pTempWebGLTexture) === null)) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 772);
                        akra.logger.error("Can not create WebGL texture");
                    }
                    ;
                    return false;
                }
                pWebGLRenderer.bindWebGLTexture(eTarget, pTempWebGLTexture);
                pWebGLContext.texImage2D(eTarget, 0, iWebGLFormat, iWidth, iHeight, 0, iWebGLFormat, iWebGLDataType, null);
                var pTextureBufferPool = this.getManager().textureBufferPool;
                var pTempTexBuffer = pTextureBufferPool.createResource(".temp");
                pTempTexBuffer.create(eTarget, pTempWebGLTexture, iWidth, iHeight, iWebGLFormat, pSource.format, 0, 0, akra.ETextureFlags.AUTOMIPMAP | akra.EHardwareBufferFlags.STATIC, false);
                var pTempBoxTarget = new akra.geometry.Box(0, 0, 0, pSource.width, pSource.height, pSource.depth);
                pTempTexBuffer.upload(pSource, pTempBoxTarget);
                this.blitFromTexture(pTempTexBuffer, pTempBoxTarget, pDestBox);
                pTempTexBuffer.release();
                pTextureBufferPool.destroyResource(pTempTexBuffer);
                pWebGLRenderer.deleteWebGLTexture(pTempWebGLTexture);
                pTempWebGLTexture = null;
                pTempBoxTarget = null;
                return true;
            };
            WebGLTextureBuffer.prototype.getRenderTarget = function (iZOffest) {
                if (typeof iZOffest === "undefined") { iZOffest = 0; }
 {
                    akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 813);
                    akra.logger.assert((((this._iFlags) & (akra.ETextureFlags.RENDERTARGET)) != 0));
                }
                ;
 {
                    akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 814);
                    akra.logger.assert(iZOffest < this._iDepth, "iZOffest: " + iZOffest + ", iDepth: " + this._iDepth);
                }
                ;
                return this._pRTTList[iZOffest];
            };
            WebGLTextureBuffer.prototype.resize = function (iWidth, iHeight) {
                if (typeof iHeight === "undefined") { iHeight = iWidth; }
                if (arguments.length === 1) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLTextureBuffer.ts", 821);
                        akra.logger.criticalError("resize with one parametr not available for WebGLTextureBuffer");
                    }
                    ;
                    return false;
                }
                var pSrcBox = new akra.geometry.Box(0, 0, 0, this._iWidth, this._iHeight, this._iDepth);
                var pDestBox = new akra.geometry.Box(0, 0, 0, iWidth, iHeight, this._iDepth);
                return this.blitFromTexture(this, pSrcBox, pDestBox);
            };
            return WebGLTextureBuffer;
        })(webgl.WebGLPixelBuffer);
        webgl.WebGLTextureBuffer = WebGLTextureBuffer;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        var WebGLInternalTexture = (function (_super) {
            __extends(WebGLInternalTexture, _super);
            function WebGLInternalTexture() {
                        _super.call(this);
                this._pSurfaceList = null;
                this._pWebGLTexture = null;
            }
            WebGLInternalTexture.prototype.getWebGLTexture = function () {
                return this._pWebGLTexture;
            };
            WebGLInternalTexture.prototype._getWebGLTextureTarget = function () {
                switch(this._eTextureType) {
                    case akra.ETextureTypes.TEXTURE_2D:
                        return 0x0DE1;
                    case akra.ETextureTypes.TEXTURE_CUBE_MAP:
                        return 0x8513;
                    default:
                        return 0;
                }
            };
            WebGLInternalTexture.prototype._getWebGLTextureParameter = function (eParam) {
                switch(eParam) {
                    case akra.ETextureParameters.MAG_FILTER:
                        return 0x2800;
                    case akra.ETextureParameters.MIN_FILTER:
                        return 0x2801;
                    case akra.ETextureParameters.WRAP_S:
                        return 0x2802;
                    case akra.ETextureParameters.WRAP_T:
                        return 0x2803;
                    default:
                        return 0;
                }
            };
            WebGLInternalTexture.prototype._getWebGLTextureParameterValue = function (eValue) {
                switch(eValue) {
                    case akra.ETextureFilters.NEAREST:
                        return 0x2600;
                    case akra.ETextureFilters.LINEAR:
                        return 0x2601;
                    case akra.ETextureFilters.NEAREST_MIPMAP_NEAREST:
                        return 0x2700;
                    case akra.ETextureFilters.LINEAR_MIPMAP_NEAREST:
                        return 0x2701;
                    case akra.ETextureFilters.NEAREST_MIPMAP_LINEAR:
                        return 0x2702;
                    case akra.ETextureFilters.LINEAR_MIPMAP_LINEAR:
                        return 0x2703;
                    case akra.ETextureWrapModes.REPEAT:
                        return 0x2901;
                    case akra.ETextureWrapModes.CLAMP_TO_EDGE:
                        return 0x812F;
                    case akra.ETextureWrapModes.MIRRORED_REPEAT:
                        return 0x8370;
                    default:
                        return 0;
                }
            };
            WebGLInternalTexture.prototype.reset = function (iWidth, iHeight) {
                if (typeof iWidth === "undefined") { iWidth = this._iWidth; }
                if (typeof iHeight === "undefined") { iHeight = iWidth; }
                _super.prototype.reset.call(this, iWidth, iHeight);
                for(var i = 0; i < this._pSurfaceList.length; i++) {
                    this._pSurfaceList[i].reset(iWidth, iHeight);
                }
            };
            WebGLInternalTexture.prototype._setFilterInternalTexture = function (eParam, eValue) {
                if (!this.isValid()) {
                    return false;
                }
                var iWebGLTarget = this._getWebGLTextureTarget();
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLRenderer.bindWebGLTexture(iWebGLTarget, this._pWebGLTexture);
                pWebGLContext.texParameteri(iWebGLTarget, this._getWebGLTextureParameter(eParam), this._getWebGLTextureParameterValue(eValue));
                return true;
            };
            WebGLInternalTexture.prototype._setWrapModeInternalTexture = function (eParam, eValue) {
                if (!this.isValid()) {
                    return false;
                }
                var iWebGLTarget = this._getWebGLTextureTarget();
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLRenderer.bindWebGLTexture(iWebGLTarget, this._pWebGLTexture);
                pWebGLContext.texParameteri(iWebGLTarget, this._getWebGLTextureParameter(eParam), this._getWebGLTextureParameterValue(eValue));
                return true;
            };
            WebGLInternalTexture.prototype._getFilterInternalTexture = function (eParam) {
                if (!this.isValid()) {
                    return 0;
                }
                var iWebGLTarget = this._getWebGLTextureTarget();
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLRenderer.bindWebGLTexture(iWebGLTarget, this._pWebGLTexture);
                return pWebGLContext.getTexParameter(iWebGLTarget, this._getWebGLTextureParameter(eParam));
            };
            WebGLInternalTexture.prototype._getWrapModeInternalTexture = function (eParam) {
                if (!this.isValid()) {
                    return 0;
                }
                var iWebGLTarget = this._getWebGLTextureTarget();
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLRenderer.bindWebGLTexture(iWebGLTarget, this._pWebGLTexture);
                return pWebGLContext.getTexParameter(iWebGLTarget, this._getWebGLTextureParameter(eParam));
            };
            WebGLInternalTexture.prototype._createInternalTextureImpl = function (cFillColor) {
                if (typeof cFillColor === "undefined") { cFillColor = null; }
                if (!((cFillColor) === null)) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 147);
                        akra.logger.warning("Texture can create with filled only by default(black) color");
                    }
                    ;
                }
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                if (this._eTextureType == akra.ETextureTypes.TEXTURE_2D) {
                    if (this._iWidth > akra.webgl.maxTextureSize) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 161);
                            akra.logger.warning("Заданная ширина не поддерживается(" + this._iWidth + ")");
                        }
                        ;
                        this._iWidth = akra.webgl.maxTextureSize;
                    }
                    if (this._iHeight > akra.webgl.maxTextureSize) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 166);
                            akra.logger.warning("Заданная высота не поддерживается(" + this._iHeight + ")");
                        }
                        ;
                        this._iHeight = akra.webgl.maxTextureSize;
                    }
                } else if (this._eTextureType == akra.ETextureTypes.TEXTURE_CUBE_MAP) {
                    if (this._iWidth > akra.webgl.maxCubeMapTextureSize) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 175);
                            akra.logger.warning("Заданная ширина не поддерживается(" + this._iWidth + ")");
                        }
                        ;
                        this._iWidth = akra.webgl.maxCubeMapTextureSize;
                    }
                    if (this._iHeight > akra.webgl.maxCubeMapTextureSize) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 180);
                            akra.logger.warning("Заданная высота не поддерживается(" + this._iHeight + ")");
                        }
                        ;
                        this._iHeight = akra.webgl.maxCubeMapTextureSize;
                    }
                }
                if (this._iWidth == 0) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 188);
                        akra.logger.warning("Заданная ширина не поддерживается(" + this._iWidth + ")");
                    }
                    ;
                    this._iWidth = 1;
                }
                if (this._iHeight == 0) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 194);
                        akra.logger.warning("Заданная высота не поддерживается(" + this._iHeight + ")");
                    }
                    ;
                    this._iHeight = 1;
                }
                if (this._iDepth != 1) {
                    this._iDepth = 1;
 {
                        akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 200);
                        akra.logger.warning("Трехмерные текстуры не поддерживаются, сброс глубины в 1");
                    }
                    ;
                }
                if (this._nMipLevels != 0 && !akra.webgl.hasExtension("EXT_texture_npot_2D_mipmap") && (!(((this._iDepth) > 0 && (((this._iDepth)) == 0 ? (null) : (((this._iDepth)) < 0 ? 31 : ((/*checked (origin: math)>>*/akra.math.log(((this._iDepth))) / /*checked (origin: math)>>*/akra.math.LN2) << 0))) == /*checked (origin: math)>>*/akra.math.lowestBitSet((this._iDepth)))) || !(((this._iHeight) > 0 && (((this._iHeight)) == 0 ? (null) : (((this._iHeight)) < 0 ? 31 : ((/*checked (origin: math)>>*/akra.math.log(((this._iHeight))) / /*checked (origin: math)>>*/akra.math.LN2) << 0))) == /*checked (origin: math)>>*/akra.math.lowestBitSet((this._iHeight)))) || !(((this._iWidth) > 0 && (((this._iWidth)) == 0 ? (null) : (((this._iWidth)) < 0 ? 31 : ((/*checked (origin: math)>>*/akra.math.log(((this._iWidth))) / /*checked (origin: math)>>*/akra.math.LN2) << 0))) == /*checked (origin: math)>>*/akra.math.lowestBitSet((this._iWidth)))))) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 204);
                        akra.logger.warning("Мип мапы у текстуры не стпени двойки не поддерживаются, сброс мипмапов в 0");
                    }
                    ;
                    this._nMipLevels = 0;
                    ((this._iFlags) &= ~(akra.ETextureFlags.AUTOMIPMAP));
                }
                if (!akra.webgl.isWebGLFormatSupport(this._eFormat)) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 211);
                        akra.logger.warning("Данный тип текстуры не поддерживается: ", this._eFormat);
                    }
                    ;
                    this._eFormat = akra.EPixelFormats.A8B8G8R8;
                }
                if (this._nMipLevels != 0 && this._nMipLevels != akra.core.pool.resources.Img.getMaxMipmaps(this._iWidth, this._iHeight, this._iDepth, this._eFormat)) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 218);
                        akra.logger.warning("Нехватает мипмапов, сброс в 0");
                    }
                    ;
                    this._nMipLevels = 0;
                }
                var iWebGLTarget = this._getWebGLTextureTarget();
                this._pWebGLTexture = pWebGLRenderer.createWebGLTexture();
                pWebGLRenderer.bindWebGLTexture(iWebGLTarget, this._pWebGLTexture);
                this._isMipmapsHardwareGenerated = pWebGLRenderer.hasCapability(akra.ERenderCapabilities.AUTOMIPMAP);
                this.setFilter(akra.ETextureParameters.MIN_FILTER, akra.ETextureFilters.NEAREST);
                this.setFilter(akra.ETextureParameters.MAG_FILTER, akra.ETextureFilters.NEAREST);
                this.setWrapMode(akra.ETextureParameters.WRAP_S, akra.ETextureWrapModes.CLAMP_TO_EDGE);
                this.setWrapMode(akra.ETextureParameters.WRAP_T, akra.ETextureWrapModes.CLAMP_TO_EDGE);
                var iWebGLFormat = akra.webgl.getWebGLFormat(this._eFormat);
                var iWebGLDataType = akra.webgl.getWebGLDataType(this._eFormat);
                var iWidth = this._iWidth;
                var iHeight = this._iHeight;
                var iDepth = this._iDepth;
                if (akra.pixelUtil.isCompressed(this._eFormat)) {
                    var iSize = akra.pixelUtil.getMemorySize(iWidth, iHeight, iDepth, this._eFormat);
                    var pTmpData = new Uint8Array(iSize);
                    var pEmptyData;
                    var mip = 0;
                    for(mip = 0; mip <= this._nMipLevels; mip++) {
                        iSize = akra.pixelUtil.getMemorySize(iWidth, iHeight, iDepth, this._eFormat);
                        pEmptyData = pTmpData.subarray(0, iSize);
                        switch(this._eTextureType) {
                            case akra.ETextureTypes.TEXTURE_2D:
                                pWebGLContext.compressedTexImage2D(0x0DE1, mip, iWebGLFormat, iWidth, iHeight, 0, pEmptyData);
                                break;
                            case akra.ETextureTypes.TEXTURE_CUBE_MAP:
                                var iFace = 0;
                                for(iFace = 0; iFace < 6; iFace++) {
                                    pWebGLContext.compressedTexImage2D(0x8515 + iFace, mip, iWebGLFormat, iWidth, iHeight, 0, pEmptyData);
                                }
                                break;
                            default:
                                break;
                        }
                        ;
                        if (iWidth > 1) {
                            iWidth = iWidth / 2;
                        }
                        if (iHeight > 1) {
                            iHeight = iHeight / 2;
                        }
                        if (iDepth > 1) {
                            iDepth = iDepth / 2;
                        }
                    }
                    pTmpData = null;
                    pEmptyData = null;
                } else {
                    var mip = 0;
                    for(mip = 0; mip <= this._nMipLevels; mip++) {
                        switch(this._eTextureType) {
                            case akra.ETextureTypes.TEXTURE_2D:
                                pWebGLContext.texImage2D(0x0DE1, mip, iWebGLFormat, iWidth, iHeight, 0, iWebGLFormat, iWebGLDataType, null);
                                break;
                            case akra.ETextureTypes.TEXTURE_CUBE_MAP:
                                var iFace = 0;
                                for(iFace = 0; iFace < 6; iFace++) {
                                    pWebGLContext.texImage2D(0x8515 + iFace, mip, iWebGLFormat, iWidth, iHeight, 0, iWebGLFormat, iWebGLDataType, null);
                                }
                                break;
                            default:
                                break;
                        }
                        if (iWidth > 1) {
                            iWidth = iWidth >>> 1;
                        }
                        if (iHeight > 1) {
                            iHeight = iHeight >>> 1;
                        }
                        if (iDepth > 1) {
                            iDepth = iDepth >>> 1;
                        }
                    }
                }
                this._createSurfaceList();
                return true;
            };
            WebGLInternalTexture.prototype.freeInternalTextureImpl = function () {
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLRenderer.deleteWebGLTexture(this._pWebGLTexture);
                this._pWebGLTexture = null;
                for(var i = 0; i < this._pSurfaceList.length; i++) {
                    this._pSurfaceList[i].release();
                }
                this._pSurfaceList = null;
                return true;
            };
            WebGLInternalTexture.prototype._createSurfaceList = function () {
                this._pSurfaceList = new Array();
                var bWantGeneratedMips = (((this._iFlags) & (akra.ETextureFlags.AUTOMIPMAP)) != 0);
                var bDoSoftware = bWantGeneratedMips && !this._isMipmapsHardwareGenerated && this._nMipLevels !== 0;
                var iFace = 0;
                var mip = 0;
                var pTextureBufferPool = this.getManager().textureBufferPool;
                var sResourceName = this.findResourceName();
                for(iFace = 0; iFace < this.getNumFaces(); iFace++) {
                    var iWidth = this._iWidth;
                    var iHeight = this._iHeight;
                    for(mip = 0; mip <= this._nMipLevels; mip++) {
                        var pBuf = pTextureBufferPool.createResource(sResourceName + "_" + iFace + "_" + mip);
                        pBuf.create(this._getWebGLTextureTarget(), this._pWebGLTexture, iWidth, iHeight, akra.webgl.getClosestWebGLInternalFormat(this._eFormat), akra.webgl.getWebGLDataType(this._eFormat), iFace, mip, this._iFlags, bDoSoftware && mip === 0);
                        this._pSurfaceList.push(pBuf);
                        if (pBuf.width === 0 || pBuf.height === 0 || pBuf.depth === 0) {
 {
                                akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 386);
                                akra.logger.criticalError("Zero sized texture surface on texture " + sResourceName + " face " + iFace + " mipmap " + mip + ". The GL driver probably refused to create the texture.");
                            }
                            ;
                        }
                    }
                }
            };
            WebGLInternalTexture.prototype.getBuffer = function (iFace, iMipmap) {
                if (typeof iFace === "undefined") { iFace = 0; }
                if (typeof iMipmap === "undefined") { iMipmap = 0; }
                if (iFace >= this.getNumFaces()) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 395);
                        akra.logger.criticalError("Face index out of range", iFace, this.getNumFaces());
                    }
                    ;
                }
                if (iMipmap > this._nMipLevels) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 399);
                        akra.logger.criticalError("Mipmap index out of range", iMipmap, this._nMipLevels);
                    }
                    ;
                }
                var idx = iFace * (this._nMipLevels + 1) + iMipmap;
 {
                    akra.logger.setSourceLocation("webgl/WebGLInternalTexture.ts", 403);
                    akra.logger.assert(idx < this._pSurfaceList.length, "smth " + this._pSurfaceList.length + " , " + iFace + " , " + this._nMipLevels + " , " + iMipmap);
                }
                ;
                return this._pSurfaceList[idx];
            };
            WebGLInternalTexture.prototype.createRenderTexture = function () {
                return this.createInternalTexture();
            };
            return WebGLInternalTexture;
        })(akra.core.pool.resources.Texture);
        webgl.WebGLInternalTexture = WebGLInternalTexture;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (data) {
        var EVertexDataLimits;
        (function (EVertexDataLimits) {
            EVertexDataLimits._map = [];
            EVertexDataLimits.k_MaxElementsSize = 256;
        })(EVertexDataLimits || (EVertexDataLimits = {}));
        ;
        var VertexData = (function () {
            function VertexData(pVertexBuffer, id, iOffset, iCount, pDecl) {
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._pVertexBuffer = pVertexBuffer;
                this._iOffset = iOffset;
                this._iLength = iCount;
                this._iId = id;
                this._pVertexDeclaration = null;
                this._iStride = 0;
                if ((typeof (pDecl) === "number")) {
                    this._iStride = pDecl;
                } else {
                    this._iStride = pDecl.stride;
                    this.setVertexDeclaration(pDecl);
                }
 {
                    akra.logger.setSourceLocation("data/VertexData.ts", 59);
                    akra.logger.assert(pVertexBuffer.byteLength >= this.byteLength + this.byteOffset, "vertex data out of array linits");
                }
                ;
            }
            Object.defineProperty(VertexData.prototype, "id", {
                get: function () {
                    return this._iId;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(VertexData.prototype, "length", {
                get: function () {
                    return this._iLength;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(VertexData.prototype, "byteOffset", {
                get: function () {
                    return this._iOffset;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(VertexData.prototype, "byteLength", {
                get: function () {
                    return this._iLength * this._iStride;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(VertexData.prototype, "buffer", {
                get: function () {
                    return this._pVertexBuffer;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(VertexData.prototype, "stride", {
                get: function () {
                    return this._iStride;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(VertexData.prototype, "startIndex", {
                get: function () {
                    var iIndex = this.byteOffset / this.stride;
 {
                        akra.logger.setSourceLocation("data/VertexData.ts", 34);
                        akra.logger.assert(iIndex % 1 == 0, "cannot calc first element index");
                    }
                    ;
                    return iIndex;
                },
                enumerable: true,
                configurable: true
            });
            VertexData.prototype.getVertexDeclaration = function () {
                return this._pVertexDeclaration;
            };
            VertexData.prototype.setVertexDeclaration = function (pDecl) {
                if (this._pVertexDeclaration) {
 {
                        akra.logger.setSourceLocation("data/VertexData.ts", 69);
                        akra.logger.error("vertex declaration already exists");
                    }
                    ;
                    return false;
                }
                var iStride = pDecl.stride;
                this._pVertexDeclaration = pDecl.clone();
 {
                    akra.logger.setSourceLocation("data/VertexData.ts", 80);
                    akra.logger.assert(iStride < EVertexDataLimits.k_MaxElementsSize, "stride max is 255 bytes");
                }
                ;
 {
                    akra.logger.setSourceLocation("data/VertexData.ts", 82);
                    akra.logger.assert(iStride <= this.stride, "stride in VertexDeclaration grather than stride in construtor");
                }
                ;
                return true;
            };
            VertexData.prototype.getVertexElementCount = function () {
                return this._pVertexDeclaration.length;
            };
            VertexData.prototype.hasSemantics = function (sUsage) {
                if (this._pVertexDeclaration != null) {
                    return this._pVertexDeclaration.hasSemantics(sUsage);
                }
                return false;
            };
            VertexData.prototype.destroy = function () {
                this._pVertexDeclaration = null;
                this._iLength = 0;
            };
            VertexData.prototype.extend = function (pDecl, pData) {
                if (typeof pData === "undefined") { pData = null; }
                pDecl = akra.createVertexDeclaration(pDecl);
                if (((pData) === null)) {
                    pData = new Uint8Array(this.length * pDecl.stride);
                } else {
                    pData = new Uint8Array(pData.buffer);
                }
 {
                    akra.logger.setSourceLocation("data/VertexData.ts", 114);
                    akra.logger.assert(this.length === pData.byteLength / pDecl.stride, 'invalid data size for extending');
                }
                ;
                var nCount = this._iLength;
                var nStrideNew = pDecl.stride;
                var nStridePrev = this.stride;
                var nStrideNext = nStridePrev + nStrideNew;
                var nTotalSize = nStrideNext * this.length;
                var pDeclNew = this.getVertexDeclaration().clone();
                var pDataPrev = new Uint8Array(this.getData());
                var pDataNext = new Uint8Array(nTotalSize);
                for(var i = 0, iOffset; i < nCount; ++i) {
                    iOffset = i * nStrideNext;
                    pDataNext.set(pDataPrev.subarray(i * nStridePrev, (i + 1) * nStridePrev), iOffset);
                    pDataNext.set((pData).subarray(i * nStrideNew, (i + 1) * nStrideNew), iOffset + nStridePrev);
                }
                if (!pDeclNew.extend(pDecl)) {
                    return false;
                }
                if (!this.resize(nCount, pDeclNew)) {
                    return false;
                }
                return this.setData(pDataNext, 0, nStrideNext);
            };
            VertexData.prototype.resize = function (nCount, pDecl) {
                var iStride = 0;
                var iOldOffset = this.byteOffset;
                var pOldVertexBuffer;
                var pOldVertexDeclaration;
                var iOldStride;
                if (arguments.length == 2) {
                    if ((typeof (pDecl) === "number")) {
                        iStride = pDecl;
                    } else {
                        iStride = (pDecl).stride;
                    }
                    if (nCount * iStride <= this.byteLength) {
                        this._iLength = nCount;
                        this._iStride = iStride;
                        this._pVertexDeclaration = null;
                        if (!(typeof (pDecl) === "number")) {
                            this.setVertexDeclaration(pDecl);
                        }
                        return true;
                    } else {
                        pOldVertexBuffer = this.buffer;
                        pOldVertexBuffer.freeVertexData(this);
                        if (pOldVertexBuffer.getEmptyVertexData(nCount, pDecl, this) !== this) {
                            return false;
                        }
                        if (this.byteOffset != iOldOffset) {
 {
                                akra.logger.setSourceLocation("data/VertexData.ts", 187);
                                akra.logger.warning("vertex data moved from " + iOldOffset + " ---> " + this.byteOffset);
                            }
                            ;
                            this.relocation(this, iOldOffset, this.byteOffset);
                        }
                        return true;
                    }
                } else if (arguments.length == 1) {
                    if (nCount <= this.length) {
                        this._iLength = nCount;
                        return true;
                    } else {
                        pOldVertexBuffer = this.buffer;
                        pOldVertexDeclaration = this.getVertexDeclaration();
                        iOldStride = this.stride;
                        pOldVertexBuffer.freeVertexData(this);
                        if (pOldVertexBuffer.getEmptyVertexData(nCount, iOldStride, this) == null) {
                            return false;
                        }
                        this.setVertexDeclaration(pOldVertexDeclaration);
                        if (this.byteOffset != iOldOffset) {
 {
                                akra.logger.setSourceLocation("data/VertexData.ts", 213);
                                akra.logger.warning("vertex data moved from " + iOldOffset + " ---> " + this.byteOffset);
                            }
                            ;
                            this.relocation(this, iOldOffset, this.byteOffset);
                        }
                        return true;
                    }
                }
                return false;
            };
            VertexData.prototype.applyModifier = function (sUsage, fnModifier) {
                var pData = this.getTypedData(sUsage);
                fnModifier(pData);
                return this.setData(pData, sUsage);
            };
            VertexData.prototype.setData = function (pData, iOffset, iSize, nCountStart, nCount) {
                var iStride;
                var pVertexBuffer = this._pVertexBuffer;
                var pBackupBuf;
                var pDataU8;
                var k;
                var iOffsetBuffer;
                var pDeclaration = this._pVertexDeclaration;
                var pElement;
                switch(arguments.length) {
                    case 5:
                        if ((typeof (arguments[1]) === "string")) {
                            iOffset = this._pVertexDeclaration.findElement(arguments[1]).offset;
                        }
                        iStride = this.stride;
                        pDataU8 = new Uint8Array(pData.buffer);
                        if (iStride != iSize) {
                            if (pVertexBuffer.isBackupPresent() && nCount > 1) {
                                pBackupBuf = new Uint8Array(pVertexBuffer.byteLength);
                                pVertexBuffer.readData(pBackupBuf);
                                iOffsetBuffer = this.byteOffset;
                                for(var i = nCountStart; i < nCount + nCountStart; i++) {
                                    for(k = 0; k < iSize; k++) {
                                        pBackupBuf[iStride * i + iOffset + iOffsetBuffer + k] = pDataU8[iSize * (i - nCountStart) + k];
                                    }
                                }
                                pVertexBuffer.writeData(pBackupBuf, 0, pVertexBuffer.byteLength);
                            } else {
                                for(var i = 0; i < nCount; i++) {
                                    var iCurrent = i + nCountStart;
                                    pVertexBuffer.writeData(pDataU8.subarray(iSize * i, iSize * (i + 1)), iStride * iCurrent + iOffset + this.byteOffset, iSize);
                                }
                            }
                        } else {
                            pVertexBuffer.writeData(pDataU8.subarray(0, iStride * nCount), this.byteOffset + iStride * nCountStart, iStride * nCount);
                        }
                        return true;
                    case 4:
                        pElement = null;
                        if ((typeof (arguments[1]) === "string")) {
                            pElement = pDeclaration.findElement(arguments[1]);
                            if (pElement) {
                                return this.setData(pData, pElement.offset, pElement.size, arguments[2], arguments[3]);
                            }
                            return false;
                        }
                        nCountStart = nCountStart || 0;
                        if (!nCount) {
                            nCount = pData.byteLength / iSize;
                        }
                        return this.setData(pData, iOffset, iSize, nCountStart, nCount);
                    case 2:
                    case 3:
                        var pDeclaration = this._pVertexDeclaration, pElement = null;
                        if ((typeof (arguments[1]) === "string")) {
                            pElement = pDeclaration.findElement(arguments[1]);
                            if (pElement) {
                                arguments[2] = arguments[2] || 0;
                                if (!arguments[3]) {
                                    arguments[3] = pData.buffer.byteLength / pElement.size;
                                }
                                return this.setData(pData, pElement.offset, pElement.size, arguments[2], arguments[3]);
                            }
                            return false;
                        } else if (arguments.length === 3) {
                            nCountStart = nCountStart || 0;
                            if (!nCount) {
                                nCount = pData.byteLength / iSize;
                            }
                            return this.setData(pData, iOffset, iSize, nCountStart, nCount);
                        }
                        return false;
                    case 1:
                        return this.setData(pData, this._pVertexDeclaration.element(0).usage);
                    default:
                        return false;
                }
            };
            VertexData.prototype.getData = function (iOffset, iSize, iFrom, iCount) {
                switch(arguments.length) {
                    case 4:
                    case 2:
                        if ((typeof (arguments[0]) === "string")) {
                            return null;
                        }
                        iFrom = iFrom || 0;
                        iCount = iCount || this._iLength;
                        iCount = akra.math.min(iCount, this._iLength);
                        var iStride = this.stride;
                        var pBufferData = new Uint8Array(iSize * iCount);
                        for(var i = 0; i < iCount; i++) {
                            var iCurrent = iFrom + i;
 {
                                akra.logger.setSourceLocation("data/VertexData.ts", 385);
                                akra.logger.assert(this._pVertexBuffer.readData(iStride * iCurrent + iOffset + this.byteOffset, iSize, pBufferData.subarray(i * iSize, (i + 1) * iSize)), "cannot read buffer");
                            }
                            ;
                        }
                        return pBufferData.buffer;
                    case 3:
                    case 1:
                        var pDeclaration = this._pVertexDeclaration, pElement = null;
                        if ((typeof ("string") === "string")) {
                            pElement = pDeclaration.findElement(arguments[0]);
                            if (((pElement) != null)) {
                                return this.getData(pElement.offset, pElement.size, arguments[1], arguments[2]);
                            }
                            return null;
                        }
                        return null;
                    case 0:
                        return this.getData(0, this._pVertexDeclaration.stride);
                    default:
                        return null;
                }
            };
            VertexData.prototype.getTypedData = function (sUsage, iFrom, iCount) {
                var pVertexElement = this._pVertexDeclaration.findElement(sUsage);
                if (pVertexElement) {
                    return akra.util.abtota(this.getData(sUsage, iFrom, iCount), pVertexElement.type);
                }
                return null;
            };
            VertexData.prototype.getBufferHandle = function () {
                return this._pVertexBuffer.resourceHandle;
            };
            VertexData.prototype.toString = function () {
                if (akra.DEBUG) {
                    var s = "";
                    s += "          VERTEX DATA  #" + this.id + "\n";
                    s += "---------------+-----------------------\n";
                    s += "        BUFFER : " + this.getBufferHandle() + "\n";
                    s += "          SIZE : " + this.byteLength + " b.\n";
                    s += "        OFFSET : " + this.byteOffset + " b.\n";
                    s += "---------------+-----------------------\n";
                    s += " MEMBERS COUNT : " + this.length + " \n";
                    s += "        STRIDE : " + this.stride + " \n";
                    s += "---------------+-----------------------\n";
                    s += this.getVertexDeclaration().toString();
                    return s;
                }
                return null;
            };
            VertexData.prototype.getGuid = function () {
                return this._iGuid;
            };
            VertexData._pEventTable = new akra.events.EventTable();
            VertexData.prototype.getEventTable = function () {
                return VertexData._pEventTable;
            };
            VertexData.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            VertexData.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            VertexData.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            VertexData.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            VertexData.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            VertexData.prototype.relocation = function (pTarget, iFrom, iTo) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).relocation;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pTarget, iFrom, iTo) : _broadcast[i].listener(_recivier, pTarget, iFrom, iTo);
                    }
                }
            };
            return VertexData;
        })();
        data.VertexData = VertexData;        
    })(akra.data || (akra.data = {}));
    var data = akra.data;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                var MemoryBuffer = (function (_super) {
                    __extends(MemoryBuffer, _super);
                    function MemoryBuffer() {
                        _super.apply(this, arguments);

                    }
                    Object.defineProperty(MemoryBuffer.prototype, "byteLength", {
                        get: function () {
                            return this._pData.byteLength;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    MemoryBuffer.prototype.create = function (iByteSize, iFlags) {
                        if (typeof iFlags === "undefined") { iFlags = akra.EHardwareBufferFlags.DYNAMIC; }
                        ((iFlags) &= ~(akra.EHardwareBufferFlags.BACKUP_COPY | akra.EHardwareBufferFlags.DISCARDABLE | akra.EHardwareBufferFlags.ALIGNMENT));
                        var isCreated = _super.prototype.create.call(this, 0, iFlags | akra.EHardwareBufferFlags.SOFTWARE);
                        this._pData = new Uint8Array(iByteSize);
                        return isCreated;
                    };
                    MemoryBuffer.prototype.destroy = function () {
                        _super.prototype.destroy.call(this);
                        this._pData = null;
                    };
                    MemoryBuffer.prototype.resize = function (iSize) {
                        var pData = new Uint8Array(iSize);
                        if (iSize >= this.byteLength) {
                            pData.set(this._pData);
                        } else {
                            pData.set(this._pData.subarray(0, iSize));
                        }
                        this._pData = pData;
                        this.notifyAltered();
                        return true;
                    };
                    MemoryBuffer.prototype.lockImpl = function (iOffset, iLength, iLockFlags) {
                        return this._pData.subarray(iOffset, iOffset + iLength);
                    };
                    MemoryBuffer.prototype.readData = function (iOffset, iSize, ppDest) {
                        if (arguments.length < 3) {
                            ppDest = arguments[0];
                            iOffset = 0;
                            iSize = ppDest.byteLength;
                        }
 {
                            akra.logger.setSourceLocation("MemoryBuffer.ts", 62);
                            akra.logger.assert((iOffset + iSize) <= this.byteLength);
                        }
                        ;
                        akra.memcpy((ppDest).buffer, (ppDest).byteOffset, this._pData.buffer, iOffset, iSize);
                        return true;
                    };
                    MemoryBuffer.prototype.writeData = function (pData, iOffset, iSize, bDiscardWholeBuffer) {
                        if (typeof bDiscardWholeBuffer === "undefined") { bDiscardWholeBuffer = false; }
                        if (arguments.length < 3) {
                            iSize = pData.byteLength;
                        }
                        if (arguments.length < 2) {
                            iOffset = 0;
                        }
 {
                            akra.logger.setSourceLocation("MemoryBuffer.ts", 80);
                            akra.logger.assert((iOffset + iSize) <= this.byteLength);
                        }
                        ;
                        if (((pData) != null)) {
                            akra.memcpy(this._pData.buffer, iOffset, (pData).buffer, (pData).byteOffset, iSize);
                        }
                        this.notifyAltered();
                        return true;
                    };
                    return MemoryBuffer;
                })(resources.HardwareBuffer);
                resources.MemoryBuffer = MemoryBuffer;                
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                var VertexBuffer = (function (_super) {
                    __extends(VertexBuffer, _super);
                    function VertexBuffer() {
                                        _super.call(this);
                        this._pVertexDataArray = [];
                        this._iDataCounter = 0;
                    }
                    Object.defineProperty(VertexBuffer.prototype, "type", {
                        get: function () {
                            return akra.EVertexBufferTypes.UNKNOWN;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(VertexBuffer.prototype, "length", {
                        get: function () {
                            return this._pVertexDataArray.length;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    VertexBuffer.prototype.create = function (iByteSize, iFlags, pData) {
                        _super.prototype.create.call(this, 0, iFlags || 0);
                        if ((((iFlags) & (akra.EHardwareBufferFlags.BACKUP_COPY)) != 0)) {
                            this._pBackupCopy = new resources.MemoryBuffer();
                            this._pBackupCopy.create(iByteSize);
                            this._pBackupCopy.writeData(pData, 0, iByteSize);
                        }
                        return true;
                    };
                    VertexBuffer.prototype.destroy = function () {
                        _super.prototype.destroy.call(this);
                        this._pBackupCopy.destroy();
                        this.freeVertexData();
                        this._iDataCounter = 0;
                    };
                    VertexBuffer.prototype.getVertexData = function (iOffset, iCount, pData) {
                        if (arguments.length < 2) {
                            return this._pVertexDataArray[arguments[0]];
                        }
                        var pDecl = akra.createVertexDeclaration(pData);
                        var pVertexData = new akra.data.VertexData(this, this._iDataCounter++, iOffset, iCount, pDecl);
                        this._pVertexDataArray.push(pVertexData);
                        this.notifyAltered();
                        return pVertexData;
                    };
                    VertexBuffer.prototype.getEmptyVertexData = function (iCount, pDeclData, ppVertexDataIn) {
                        var pDecl = null;
                        var pHole = [];
                        var i;
                        var pVertexData;
                        var iTemp;
                        var iStride = 0;
                        var iAligStart;
                        var iNewSize = 0;
                        while(true) {
                            pHole[0] = {
                                start: 0,
                                end: this.byteLength
                            };
                            for(var k = 0; k < this._pVertexDataArray.length; ++k) {
                                pVertexData = this._pVertexDataArray[k];
                                for(i = 0; i < pHole.length; i++) {
                                    if (pVertexData.byteOffset > pHole[i].start && pVertexData.byteOffset + pVertexData.byteLength < pHole[i].end) {
                                        iTemp = pHole[i].end;
                                        pHole[i].end = pVertexData.byteOffset;
                                        pHole.splice(i + 1, 0, {
                                            start: pVertexData.byteOffset + pVertexData.byteLength,
                                            end: iTemp
                                        });
                                        i--;
                                    } else if (pVertexData.byteOffset == pHole[i].start && pVertexData.byteOffset + pVertexData.byteLength < pHole[i].end) {
                                        pHole[i].start = pVertexData.byteOffset + pVertexData.byteLength;
                                    } else if (pVertexData.byteOffset > pHole[i].start && pVertexData.byteOffset + pVertexData.byteLength == pHole[i].end) {
                                    } else if (pVertexData.byteOffset == pHole[i].start && pVertexData.byteLength == (pHole[i].end - pHole[i].start)) {
                                        pHole.splice(i, 1);
                                        i--;
                                    } else if (pVertexData.byteOffset < pHole[i].start && pVertexData.byteOffset + pVertexData.byteLength > pHole[i].start && pVertexData.byteOffset + pVertexData.byteLength < pHole[i].end) {
                                        pHole[i].start = pVertexData.byteOffset + pVertexData.byteLength;
                                    } else if (pVertexData.byteOffset < pHole[i].start && pVertexData.byteOffset + pVertexData.byteLength > pHole[i].start && pVertexData.byteOffset + pVertexData.byteLength == pHole[i].end) {
                                        pHole.splice(i, 1);
                                        i--;
                                    } else if (pVertexData.byteOffset + pVertexData.byteLength > pHole[i].end && pVertexData.byteOffset > pHole[i].start && pVertexData.byteOffset < pHole[i].end) {
                                        pHole[i].end = pVertexData.byteOffset;
                                    } else if (pVertexData.byteOffset + pVertexData.byteLength > pHole[i].end && pVertexData.byteOffset == pHole[i].start && pVertexData.byteOffset < pHole[i].end) {
                                        pHole.splice(i, 1);
                                        i--;
                                    } else if (pVertexData.byteOffset < pHole[i].start && pVertexData.byteOffset + pVertexData.byteLength > pHole[i].end) {
                                        i--;
                                    }
                                }
                            }
                            pHole.sort(/** @inline */function (a, b) {
                                return ((a.end - a.start) - (b.end - b.start));
                            });
                            if (!(typeof (pDeclData) === "number")) {
                                pDecl = akra.createVertexDeclaration(pDeclData);
                                iStride = pDecl.stride;
                            } else {
                                iStride = pDeclData;
                            }
                            for(i = 0; i < pHole.length; i++) {
                                iAligStart = this.isAligned() ? akra.math.alignUp(pHole[i].start, (/*checked (origin: math)>>*/akra.math.abs((iStride) * (4)) / /*checked (origin: math)>>*/akra.math.nod((iStride), (4)))) : akra.math.alignUp(pHole[i].start, iStride);
                                if ((pHole[i].end - iAligStart) >= iCount * iStride) {
                                    if (arguments.length == 2) {
                                        pVertexData = new akra.data.VertexData(this, this._iDataCounter++, iAligStart, iCount, pDeclData);
                                        this._pVertexDataArray.push(pVertexData);
                                        this.notifyAltered();
                                        return pVertexData;
                                    } else if (arguments.length == 3) {
                                        ((ppVertexDataIn).constructor).call(ppVertexDataIn, this, ppVertexDataIn.id, iAligStart, iCount, pDeclData);
                                        this._pVertexDataArray.push(ppVertexDataIn);
                                        this.notifyAltered();
                                        return ppVertexDataIn;
                                    }
                                    return null;
                                }
                            }
                            iNewSize = akra.math.max(this.byteLength * 2, this.byteLength + iCount * iStride);
                            if (this.resize(iNewSize) == false) {
 {
                                    akra.logger.setSourceLocation("core/pool/resources/VertexBuffer.ts", 181);
                                    akra.logger.warning("cannot resize buffer from " + this.byteLength + " bytes to " + iNewSize + " bytes ");
                                }
                                ;
                                break;
                            }
                        }
                        return null;
                    };
                    VertexBuffer.prototype.freeVertexData = function (pVertexData) {
                        if (arguments.length == 0) {
                            for(var i = 0; i < this._pVertexDataArray.length; i++) {
                                this._pVertexDataArray[Number(i)].destroy();
                            }
                            this._pVertexDataArray = null;
                        } else {
                            for(var i = 0; i < this._pVertexDataArray.length; i++) {
                                if (this._pVertexDataArray[i] == pVertexData) {
                                    pVertexData.destroy();
                                    this._pVertexDataArray.splice(i, 1);
                                    this.notifyAltered();
                                    return true;
                                }
                            }
                            return false;
                        }
                        this.notifyAltered();
                        return true;
                    };
                    VertexBuffer.prototype.allocateData = function (pDeclData, pData) {
                        var pDecl = akra.createVertexDeclaration(pDeclData);
                        var pVertexData;
                        var iCount = pData.byteLength / pDecl.stride;
 {
                            akra.logger.setSourceLocation("core/pool/resources/VertexBuffer.ts", 225);
                            akra.logger.assert(iCount === akra.math.floor(iCount), 'Data size should be a multiple of the vertex declaration.');
                        }
                        ;
                        pVertexData = this.getEmptyVertexData(iCount, pDecl);
 {
                            akra.logger.setSourceLocation("core/pool/resources/VertexBuffer.ts", 229);
                            akra.logger.assert(!((pVertexData) === null), "Could not allocate vertex data!");
                        }
                        ;
                        pVertexData.setData(pData, 0, pDecl.stride);
                        return pVertexData;
                    };
                    return VertexBuffer;
                })(resources.HardwareBuffer);
                resources.VertexBuffer = VertexBuffer;                
                function isVBO(pBuffer) {
                    return pBuffer.type === akra.EVertexBufferTypes.VBO;
                }
                resources.isVBO = isVBO;
                function isTBO(pBuffer) {
                    return pBuffer.type === akra.EVertexBufferTypes.TBO;
                }
                resources.isTBO = isTBO;
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        var WebGLVertexBuffer = (function (_super) {
            __extends(WebGLVertexBuffer, _super);
            function WebGLVertexBuffer() {
                        _super.call(this);
                this._pLockData = null;
                this._sCS = null;
            }
            Object.defineProperty(WebGLVertexBuffer.prototype, "type", {
                get: function () {
                    return akra.EVertexBufferTypes.VBO;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(WebGLVertexBuffer.prototype, "byteLength", {
                get: function () {
                    return this._iByteSize;
                },
                enumerable: true,
                configurable: true
            });
            WebGLVertexBuffer.prototype.create = function (iByteSize, iFlags, pData) {
                if (typeof iFlags === "undefined") { iFlags = akra.EHardwareBufferFlags.STATIC; }
                if (typeof pData === "undefined") { pData = null; }
                iByteSize = akra.math.max(iByteSize, 1024);
                if ((((iFlags) & (akra.EHardwareBufferFlags.READABLE)) != 0)) {
                    ((iFlags) |= (akra.EHardwareBufferFlags.BACKUP_COPY));
                }
                _super.prototype.create.call(this, iByteSize, iFlags, pData);
                var pWebGLRenderer = this.getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                var i;
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 45);
                    akra.logger.assert(this._pWebGLBuffer == null, "webgl buffer already allocated");
                }
                ;
                this._iByteSize = iByteSize;
                this._iFlags = iFlags;
                pWebGLContext = pWebGLRenderer.getWebGLContext();
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 51);
                    akra.logger.assert(pWebGLContext !== null, "cannot grab webgl context");
                }
                ;
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 54);
                    akra.logger.assert(!this.isSoftware(), "no sftware rendering");
                }
                ;
                if (this.isBackupPresent()) {
                    ((this._iFlags) |= (akra.EHardwareBufferFlags.READABLE));
                }
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 62);
                    akra.logger.assert(!pData || pData.byteLength <= iByteSize, "Размер переданного массива больше переданного размера буфера");
                }
                ;
                this._pWebGLBuffer = pWebGLRenderer.createWebGLBuffer();
                if (!this._pWebGLBuffer) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 68);
                        akra.logger.criticalError("Не удалось создать буфер");
                    }
                    ;
                    this.destroy();
                    return false;
                }
                pWebGLRenderer.bindWebGLBuffer(0x8892, this._pWebGLBuffer);
                pWebGLContext.bufferData(0x8892, this._iByteSize, webgl.getWebGLUsage(this._iFlags));
                if (((pData) != null)) {
                    pWebGLContext.bufferSubData(0x8892, 0, pData.buffer);
                }
                return true;
            };
            WebGLVertexBuffer.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
                var pWebGLRenderer = this.getEngine().getRenderer();
                pWebGLRenderer.deleteWebGLBuffer(this._pWebGLBuffer);
                this._pWebGLBuffer = null;
                this._iByteSize = 0;
            };
            WebGLVertexBuffer.prototype.readData = function (iOffset, iSize, ppDest) {
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 102);
                    akra.logger.assert(!((this._pWebGLBuffer) === null), "Буффер еще не создан");
                }
                ;
                if (!this.isBackupPresent()) {
                    return false;
                }
                if (arguments.length === 1) {
                    this._pBackupCopy.readData(arguments[0]);
                } else {
                    this._pBackupCopy.readData(iOffset, iSize, ppDest);
                }
                return true;
            };
            WebGLVertexBuffer.prototype.writeData = function (pData, iOffset, iSize, bDiscardWholeBuffer) {
                if (typeof bDiscardWholeBuffer === "undefined") { bDiscardWholeBuffer = false; }
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 122);
                    akra.logger.assert(!((this._pWebGLBuffer) === null), "WebGL buffer not exists");
                }
                ;
                var pWebGLRenderer = this.getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLRenderer.bindWebGLBuffer(0x8892, this._pWebGLBuffer);
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 129);
                    akra.logger.assert(pData.byteLength <= iSize, "Размер переданного массива больше переданного размера");
                }
                ;
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 130);
                    akra.logger.assert(this.byteLength >= iOffset + iSize, "Данные выйдут за предел буфера");
                }
                ;
                var pU8Data = null;
                if (((pData) instanceof ArrayBuffer)) {
                    pU8Data = new Uint8Array(pData);
                } else {
                    pU8Data = new Uint8Array(pData.buffer, pData.byteOffset, pData.byteLength);
                }
                pU8Data = pU8Data.subarray(0, iSize);
                pWebGLContext.bufferSubData(0x8892, iOffset, pU8Data);
                if (this.isBackupPresent()) {
                    this._pBackupCopy.writeData(pU8Data, iOffset);
                }
                this.notifyAltered();
                return true;
            };
            WebGLVertexBuffer.prototype.resize = function (iSize) {
                var eUsage;
                var pData;
                var iMax = 0;
                var pVertexData;
                var pWebGLRenderer = this.getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                if (!this.isBackupPresent()) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 164);
                        akra.logger.log("Not resized, because backup not present!");
                    }
                    ;
                    return false;
                }
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 168);
                    akra.logger.log("WebGLVertexBuffer resized from " + this.byteLength + " to " + iSize + "(" + this.getGuid() + ")");
                }
                ;
                if (iSize < this.byteLength) {
                    for(var k = 0; k < this._pVertexDataArray.length; ++k) {
                        pVertexData = this._pVertexDataArray[k];
                        if (pVertexData.byteOffset + pVertexData.byteLength > iMax) {
                            iMax = pVertexData.byteOffset + pVertexData.byteLength;
                        }
                    }
 {
                        akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 181);
                        akra.logger.assert(iMax <= iSize, "Уменьшение невозможно. Страая разметка не укладывается в новый размер");
                    }
                    ;
                }
                if (pWebGLContext.isBuffer(this._pWebGLBuffer)) {
                    pWebGLRenderer.deleteWebGLBuffer(this._pWebGLBuffer);
                }
                eUsage = webgl.getWebGLUsage(this._iFlags);
                this._pWebGLBuffer = pWebGLRenderer.createWebGLBuffer();
                if (!this._pWebGLBuffer) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 193);
                        akra.logger.criticalError("Не удалось создать буфер");
                    }
                    ;
                    this.destroy();
                    return false;
                }
                pWebGLRenderer.bindWebGLBuffer(0x8892, this._pWebGLBuffer);
                pWebGLContext.bufferData(0x8892, iSize, eUsage);
                pData = new Uint8Array(this._iByteSize);
                if (!this.readData(pData)) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLVertexBuffer.ts", 206);
                        akra.logger.warning("cannot read data from buffer");
                    }
                    ;
                    return false;
                }
                this.writeData(pData, 0, this._iByteSize);
                this._pBackupCopy.resize(iSize);
                this._iByteSize = iSize;
                this.notifyAltered();
                return true;
            };
            WebGLVertexBuffer.prototype.getWebGLBuffer = function () {
                return this._pWebGLBuffer;
            };
            WebGLVertexBuffer.prototype.lockImpl = function (iOffset, iSize, iLockFlags) {
                var pRetData = new Uint8Array(iSize);
                this.readData(iOffset, iSize, pRetData);
                this._pLockData = pRetData;
                return pRetData;
            };
            WebGLVertexBuffer.prototype.unlockImpl = function () {
                this.writeData(this._pLockData, this._iLockStart, this._iLockSize);
            };
            WebGLVertexBuffer.prototype.copyBackupToRealImpl = function (pRealData, pBackupData, iLockFlags) {
                pRealData.set(pBackupData);
            };
            return WebGLVertexBuffer;
        })(akra.core.pool.resources.VertexBuffer);
        webgl.WebGLVertexBuffer = WebGLVertexBuffer;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        var WebGLVertexTexture = (function (_super) {
            __extends(WebGLVertexTexture, _super);
            function WebGLVertexTexture() {
                        _super.call(this);
                this._iWidth = 0;
                this._iHeight = 0;
                this._pWebGLTexture = null;
                this._ePixelFormat = akra.EPixelFormats.FLOAT32_RGBA;
                this._bForceUpdateBackupCopy = true;
                this._pHeader = null;
                this._pLockData = null;
            }
            Object.defineProperty(WebGLVertexTexture.prototype, "type", {
                get: function () {
                    return akra.EVertexBufferTypes.TBO;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(WebGLVertexTexture.prototype, "byteLength", {
                get: function () {
                    return akra.pixelUtil.getMemorySize(this._iWidth, this._iHeight, 1, this._ePixelFormat);
                },
                enumerable: true,
                configurable: true
            });
            WebGLVertexTexture.prototype.getWebGLTexture = function () {
                return this._pWebGLTexture;
            };
            WebGLVertexTexture.prototype.create = function (iByteSize, iFlags, pData) {
                if (typeof iFlags === "undefined") { iFlags = akra.EHardwareBufferFlags.STATIC; }
                if (typeof pData === "undefined") { pData = null; }
                var iMinWidth = 32;
                var iWidth, iHeight;
                var pTextureData = null;
                var pDataU8 = pData;
                var iAdditionalHeaderSize = (((pData) != null)) ? 32 : 0;
                iByteSize = akra.math.max(iByteSize + iAdditionalHeaderSize, akra.pixelUtil.getMemorySize(iMinWidth, iMinWidth, 1, this._ePixelFormat));
                if ((((iFlags) & (akra.EHardwareBufferFlags.READABLE)) != 0)) {
                    ((iFlags) |= (akra.EHardwareBufferFlags.BACKUP_COPY));
                }
                _super.prototype.create.call(this, iByteSize, iFlags, pData);
                var pPOTSize = akra.math.calcPOTtextureSize(akra.math.ceil(iByteSize / akra.pixelUtil.getNumElemBytes(this._ePixelFormat)));
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                var i;
                iWidth = pPOTSize[0];
                iHeight = pPOTSize[1];
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 77);
                    akra.logger.assert(this._pWebGLTexture == null, "webgl texture already allocated");
                }
                ;
                this._iWidth = iWidth;
                this._iHeight = iHeight;
                this._iFlags = iFlags;
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 83);
                    akra.logger.assert(pWebGLContext !== null, "cannot grab webgl context");
                }
                ;
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 86);
                    akra.logger.assert(!this.isSoftware(), "no software rendering");
                }
                ;
                if (this.isBackupPresent()) {
                    ((this._iFlags) |= (akra.EHardwareBufferFlags.READABLE));
                }
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 94);
                    akra.logger.assert(!pData || pData.byteLength <= iByteSize, "Размер переданного массива больше переданного размера буфера");
                }
                ;
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 97);
                    akra.logger.assert(webgl.loadExtension(pWebGLContext, "OES_texture_float"), "OES_texture_float extension is necessary for correct work.");
                }
                ;
                this._pWebGLTexture = pWebGLRenderer.createWebGLTexture();
                this._eWebGLFormat = webgl.getWebGLFormat(this._ePixelFormat);
                this._eWebGLType = webgl.getWebGLDataType(this._ePixelFormat);
                if (!this._pWebGLTexture) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 104);
                        akra.logger.criticalError("Не удалось создать буфер");
                    }
                    ;
                    this.destroy();
                    return false;
                }
                if (((pData) != null)) {
                    if (pData.BYTES_PER_ELEMENT > 1) {
                        pDataU8 = new Uint8Array(pData, pData.byteOffset, pData.byteLength);
                    }
                    pTextureData = new Uint8Array(this.byteLength);
                    pTextureData.set(pDataU8);
                }
                pWebGLRenderer.bindWebGLTexture(0x0DE1, this._pWebGLTexture);
                pWebGLContext.texImage2D(0x0DE1, 0, this._eWebGLFormat, this._iWidth, this._iHeight, 0, this._eWebGLFormat, this._eWebGLType, pTextureData);
                pWebGLContext.texParameterf(pWebGLContext.TEXTURE_2D, pWebGLContext.TEXTURE_MAG_FILTER, pWebGLContext.NEAREST);
                pWebGLContext.texParameterf(pWebGLContext.TEXTURE_2D, pWebGLContext.TEXTURE_MIN_FILTER, pWebGLContext.NEAREST);
                pWebGLContext.texParameterf(pWebGLContext.TEXTURE_2D, pWebGLContext.TEXTURE_WRAP_S, pWebGLContext.CLAMP_TO_EDGE);
                pWebGLContext.texParameterf(pWebGLContext.TEXTURE_2D, pWebGLContext.TEXTURE_WRAP_T, pWebGLContext.CLAMP_TO_EDGE);
                this._pHeader = this.allocateData([
                    akra.VE_VEC2(akra.DeclarationUsages.TEXTURE_HEADER)
                ], this._header());
                var pProgram = this.getManager().shaderProgramPool.findResource("WEBGL_vertex_texture_update");
                if (((pProgram) === null)) {
                    pProgram = this.getManager().shaderProgramPool.createResource("WEBGL_vertex_texture_update");
                    pProgram.create("																									\n	        	uniform sampler2D sourceTexture;																	\n				attribute vec4  VALUE;																				\n				attribute float INDEX;																				\n				attribute float SHIFT;																				\n				                      																				\n				uniform vec2 size;																					\n				varying vec4 color;																					\n				                   																					\n				void main(void){																					\n				    vec4 value = VALUE;																				\n				    float  serial = INDEX;																			\n				                          																			\n				    int shift = int(SHIFT);																			\n				    if (shift != 0) {																				\n				        color = texture2D(sourceTexture,                                        					\n				            vec2((mod(serial, size.x) +.5 ) / size.x, (floor(serial / size.x) + .5) / size.y)		\n				            );																						\n																													\n																													\n				        if (shift == 1) {																			\n				            color = vec4(color.r, value.gba);														\n				        }																							\n				        else if (shift == 2) {																		\n				            color = vec4(color.rg, value.ba);														\n				        }																							\n				        else if (shift == 3) {																		\n				            color = vec4(color.rgb, value.a);														\n				        }																							\n				        else if (shift == -1) {																		\n				            color = vec4(value.r, color.gba);														\n				        }																							\n				        else if (shift == -2) {																		\n				            color = vec4(value.rg, color.ba);														\n				        }																							\n				        else {																						\n				            color = vec4(value.rgb, color.a);														\n				        }																							\n				    }																								\n				    else {																							\n				        color = value;																				\n				    }																								\n				    gl_PointSize = 1.;																				\n				    gl_Position = vec4(2. * (mod(serial, size.x) + .5) / size.x - 1.,								\n				                    2. * (floor(serial / size.x)  + .5) / size.y - 1., 0., 1.);						\n				}																									\n				", "									\n				#ifdef GL_ES                        \n				    precision highp float;          \n				#endif								\n				varying vec4 color;                 \n				                                    \n				void main(void) {                   \n				    gl_FragColor = color;           \n				}                                   \n				");
                }
                pProgram = this.getManager().shaderProgramPool.findResource("WEBGL_vertex_texture_resize");
                if (((pProgram) === null)) {
                    pProgram = this.getManager().shaderProgramPool.createResource("WEBGL_vertex_texture_resize");
                    pProgram.create("																									\n	        	attribute float INDEX;																				\n	        																										\n	        	uniform sampler2D sourceTexture;																	\n				                      																				\n				uniform vec2 v2fSrcTexSize;																			\n				uniform vec2 v2fDstTexSize;																			\n																													\n				varying vec4 v4fValue;																				\n				                   																					\n				void main(void){																					\n					                       																			\n				    vec2 v2fSrcPosition = vec2((mod(INDEX, v2fSrcTexSize.x) + 0.5)/v2fSrcTexSize.x,					\n				    						   (floor(INDEX/v2fSrcTexSize.x) + 0.5)/v2fSrcTexSize.y);				\n	        																										\n	        		vec2 v2fDstPosition = vec2((mod(INDEX, v2fDstTexSize.x) + 0.5)/v2fDstTexSize.x,					\n				    						   (floor(INDEX/v2fDstTexSize.x) + 0.5)/v2fDstTexSize.y);				\n	        																										\n	        		v4fValue = texture2D(sourceTexture, v2fSrcPosition);											\n	        																										\n	        		gl_PointSize = 1.;																				\n	        		gl_Position = vec4(v2fDstPosition*2. - 1., 0., 1.);												\n				}																									\n				", "									\n				#ifdef GL_ES                        \n				    precision highp float;          \n				#endif								\n				varying vec4 v4fValue;              \n				                                    \n				void main(void) {                   \n				    gl_FragColor = v4fValue;        \n				}                                   \n				");
                }
                if (((WebGLVertexTexture._pWebGLBuffer1) === null)) {
                    WebGLVertexTexture._pWebGLBuffer1 = pWebGLRenderer.createWebGLBuffer();
                }
                if (((WebGLVertexTexture._pWebGLBuffer2) === null)) {
                    WebGLVertexTexture._pWebGLBuffer2 = pWebGLRenderer.createWebGLBuffer();
                }
                if (((WebGLVertexTexture._pWebGLBuffer3) === null)) {
                    WebGLVertexTexture._pWebGLBuffer3 = pWebGLRenderer.createWebGLBuffer();
                }
                return true;
            };
            WebGLVertexTexture.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                pWebGLRenderer.deleteWebGLTexture(this._pWebGLTexture);
                this._pWebGLTexture = null;
            };
            WebGLVertexTexture.prototype.readData = function (iOffset, iSize, ppDest) {
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 271);
                    akra.logger.assert(!((this._pWebGLTexture) === null), "Буффер еще не создан");
                }
                ;
                if (!this.isBackupPresent()) {
                    return false;
                }
                if (arguments.length === 1) {
                    this._pBackupCopy.readData(arguments[0]);
                } else {
                    this._pBackupCopy.readData(iOffset, iSize, ppDest);
                }
                return true;
            };
            WebGLVertexTexture.prototype.writeData = function (pData, iOffset, iSize, bDiscardWholeBuffer) {
                if (typeof bDiscardWholeBuffer === "undefined") { bDiscardWholeBuffer = false; }
                var iTypeSize = akra.pixelUtil.getComponentTypeBits(this._ePixelFormat) / 8, nElementsPerPix = akra.pixelUtil.getComponentCount(this._ePixelFormat), iFrom, iCount;
                var pBufferData;
                var iLeftShift, iRightShift, iBeginPix, iEndPix, nPixels, nElements;
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                var pDataU8 = pData;
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 309);
                    akra.logger.assert(bDiscardWholeBuffer === false, "Discard option temporary unsupported.");
                }
                ;
                if (pData.BYTES_PER_ELEMENT > 1) {
                    pDataU8 = new Uint8Array(pData.buffer, pData.byteOffset, pData.byteLength);
                }
                iOffset = iOffset || 0;
                iSize = iSize || pData.byteLength;
                pDataU8 = pDataU8.subarray(0, iSize);
                if (this.byteLength < iOffset + iSize) {
                    this.resize(iOffset + iSize);
                }
                if (this.isBackupPresent() && this._bForceUpdateBackupCopy) {
                    this._pBackupCopy.writeData(pDataU8, iOffset);
                }
                this._bForceUpdateBackupCopy = true;
 {
                    akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 330);
                    akra.logger.assert(iOffset % iTypeSize === 0 && iSize % iTypeSize === 0, "Incorrect data size or offset");
                }
                ;
                iFrom = iOffset / iTypeSize;
                iCount = iSize / iTypeSize;
                iLeftShift = iFrom % nElementsPerPix;
                iRightShift = ((iFrom + iCount) % nElementsPerPix);
                iBeginPix = Math.floor(iFrom / nElementsPerPix);
                iEndPix = Math.floor((iFrom + iCount) / nElementsPerPix);
                nPixels = Math.ceil((iFrom + iCount) / nElementsPerPix) - Math.floor(iFrom / nElementsPerPix);
                nElements = nPixels * nElementsPerPix;
                pBufferData = new Float32Array(pDataU8.buffer, pDataU8.byteOffset);
                if (iLeftShift === 0 && iRightShift === 0) {
                    var iWidth = this._iWidth;
                    var iYmin = Math.floor(iBeginPix / iWidth);
                    var iYmax = Math.ceil(iEndPix / iWidth);
                    var iXbegin = iBeginPix % iWidth;
                    var iXend = iEndPix % iWidth;
                    var iHeight = iYmax - iYmin;
                    var iBeginElement = 0, iEndElement = 0;
                    iXend = (iXend === 0 ? iWidth : iXend);
                    var me = this;
                    function updatePixelRect(iX, iY, iW, iH) {
                        iBeginElement = iEndElement;
                        iEndElement = iW * iH * nElementsPerPix + iEndElement;
                        pWebGLRenderer.bindWebGLTexture(0x0DE1, me._pWebGLTexture);
                        pWebGLContext.texSubImage2D(0x0DE1, 0, iX, iY, iW, iH, me._eWebGLFormat, me._eWebGLType, pBufferData.subarray(iBeginElement, iEndElement));
                    }
                    ;
                    if (iHeight === 1) {
                        updatePixelRect(iXbegin, iYmin, iXend - iXbegin, 1);
                    } else {
                        updatePixelRect(iXbegin, iYmin, iWidth - iXbegin, 1);
                        if (iHeight > 2) {
                            updatePixelRect(0, iYmin + 1, iWidth, iHeight - 2);
                        }
                        updatePixelRect(0, iYmax - 1, iXend, 1);
                    }
                } else if (this.isBackupPresent()) {
                    var iRealOffset = iBeginPix * nElementsPerPix * iTypeSize;
                    var iRealSize = nElements * iTypeSize;
                    var pTempData = this._pBackupCopy.lock(iRealOffset, iRealSize);
                    this._pBackupCopy.unlock();
                    this._bForceUpdateBackupCopy = false;
                    return this.writeData(pTempData, iRealOffset, iRealSize);
                } else {
                    var pMarkupDataIndex = new Float32Array(nPixels);
                    var pMarkupDataShift = new Float32Array(nPixels);
                    var pRealData = new Float32Array(nElements);
                    pMarkupDataIndex[0] = iBeginPix;
                    pMarkupDataShift[0] = iLeftShift;
                    pMarkupDataIndex[nPixels - 1] = iBeginPix + nPixels - 1;
                    pMarkupDataShift[nPixels - 1] = -iRightShift;
                    for(var i = 1; i < nPixels - 1; ++i) {
                        pMarkupDataIndex[i] = iBeginPix + i;
                    }
                    for(var i = 0; i < iCount; i++) {
                        pRealData[iLeftShift + i] = pBufferData[i];
                    }
                    var pOldFrameBuffer = pWebGLContext.getParameter(0x8CA6);
                    var pWebGLFramebuffer = pWebGLRenderer.createWebGLFramebuffer();
                    var pWebGLProgram = this.getManager().shaderProgramPool.findResource("WEBGL_vertex_texture_update");
                    var pValueBuffer = WebGLVertexTexture._pWebGLBuffer1;
                    var pMarkupIndexBuffer = WebGLVertexTexture._pWebGLBuffer2;
                    var pMarkupShiftBuffer = WebGLVertexTexture._pWebGLBuffer3;
 {
                        akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 428);
                        akra.logger.assert(((pWebGLProgram) !== undefined), "cound not find WEBGL_vertex_texture_update program");
                    }
                    ;
                    pWebGLRenderer.disableAllWebGLVertexAttribs();
                    pWebGLRenderer.bindWebGLFramebuffer(0x8D40, pWebGLFramebuffer);
                    pWebGLRenderer.useWebGLProgram(pWebGLProgram.getWebGLProgram());
                    pWebGLContext.disable(0x0B71);
                    pWebGLContext.disable(0x0C11);
                    pWebGLContext.disable(0x0BE2);
                    pWebGLContext.disable(0x0B44);
                    var iValueAttribLocation = pWebGLProgram.getWebGLAttributeLocation("VALUE");
                    var iIndexAttribLocation = pWebGLProgram.getWebGLAttributeLocation("INDEX");
                    var iShiftAttribLocation = pWebGLProgram.getWebGLAttributeLocation("SHIFT");
                    pWebGLContext.enableVertexAttribArray(iValueAttribLocation);
                    pWebGLContext.enableVertexAttribArray(iIndexAttribLocation);
                    pWebGLContext.enableVertexAttribArray(iShiftAttribLocation);
                    pWebGLContext.framebufferTexture2D(0x8D40, 0x8CE0, 0x0DE1, this._pWebGLTexture, 0);
                    pWebGLRenderer.bindWebGLBuffer(0x8892, pValueBuffer);
                    pWebGLContext.bufferData(0x8892, pRealData, 0x88E0);
                    pWebGLContext.vertexAttribPointer(iValueAttribLocation, 4, 0x1406, false, 0, 0);
                    pWebGLRenderer.bindWebGLBuffer(0x8892, pMarkupIndexBuffer);
                    pWebGLContext.bufferData(0x8892, pMarkupDataIndex, 0x88E0);
                    pWebGLContext.vertexAttribPointer(iIndexAttribLocation, 1, 0x1406, false, 0, 0);
                    pWebGLRenderer.bindWebGLBuffer(0x8892, pMarkupShiftBuffer);
                    pWebGLContext.bufferData(0x8892, pMarkupDataShift, 0x88E0);
                    pWebGLContext.vertexAttribPointer(iShiftAttribLocation, 1, 0x1406, false, 0, 0);
                    pWebGLRenderer.activateWebGLTexture(0x84C0);
                    pWebGLRenderer.bindWebGLTexture(0x0DE1, this._pWebGLTexture);
                    pWebGLProgram.setInt("sourceTexture", 0);
                    pWebGLProgram.setVec2("size", this._iWidth, this._iHeight);
                    pWebGLContext.viewport(0, 0, this._iWidth, this._iHeight);
                    pWebGLContext.drawArrays(0x0000, 0, nPixels);
                    pWebGLContext.flush();
                    pWebGLContext.framebufferTexture2D(0x8D40, 0x8CE0, 0x0DE1, null, 0);
                    pWebGLRenderer.bindWebGLBuffer(0x8892, null);
                    pWebGLContext.disableVertexAttribArray(iValueAttribLocation);
                    pWebGLContext.disableVertexAttribArray(iIndexAttribLocation);
                    pWebGLContext.disableVertexAttribArray(iShiftAttribLocation);
                    pWebGLRenderer.bindWebGLFramebuffer(0x8D40, pOldFrameBuffer);
                    pWebGLRenderer.deleteWebGLFramebuffer(pWebGLFramebuffer);
                }
                return true;
            };
            WebGLVertexTexture.prototype.resize = function (iSize) {
                var pWebGLRenderer = this.getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                var iMax = 0;
                if (iSize < this.byteLength) {
                    for(var k = 0; k < this._pVertexDataArray.length; ++k) {
                        var pVertexData = this._pVertexDataArray[k];
                        if (pVertexData.byteOffset + pVertexData.byteLength > iMax) {
                            iMax = pVertexData.byteOffset + pVertexData.byteLength;
                        }
                    }
                    if (iMax > iSize) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 510);
                            akra.logger.assert(false, "Уменьшение невозможно. Страая разметка не укладывается в новый размер");
                        }
                        ;
                        return false;
                    }
                }
                var pPOTSize = akra.math.calcPOTtextureSize(akra.math.ceil(iSize / akra.pixelUtil.getNumElemBytes(this._ePixelFormat)));
                pPOTSize[0] = (pPOTSize[0] < 32) ? 32 : pPOTSize[0];
                pPOTSize[1] = (pPOTSize[1] < 32) ? 32 : pPOTSize[1];
                if (pPOTSize[0] !== this._iWidth || pPOTSize[1] !== this._iHeight) {
                    if (this.isBackupPresent()) {
                        this._iWidth = pPOTSize[0];
                        this._iHeight = pPOTSize[1];
                        pWebGLRenderer.bindWebGLTexture(0x0DE1, this._pWebGLTexture);
                        pWebGLContext.texImage2D(0x0DE1, 0, this._eWebGLFormat, this._iWidth, this._iHeight, 0, this._eWebGLFormat, this._eWebGLType, null);
                        var iByteLength = this.byteLength;
                        this._pBackupCopy.resize(iByteLength);
                        var pData = new Uint8Array(iByteLength);
                        if (!this.readData(pData)) {
 {
                                akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 538);
                                akra.logger.warning("cannot read data from buffer");
                            }
                            ;
                            return false;
                        }
                        this.writeData(pData, 0, iByteLength);
                    } else {
                        var pWebGLProgram = this.getManager().shaderProgramPool.findResource("WEBGL_vertex_texture_resize");
 {
                            akra.logger.setSourceLocation("webgl/WebGLVertexTexture.ts", 547);
                            akra.logger.assert(((pWebGLProgram) !== undefined), "cound not find WEBGL_vertex_texture_resize program");
                        }
                        ;
                        pWebGLRenderer.useWebGLProgram(pWebGLProgram.getWebGLProgram());
                        var pTexture = pWebGLRenderer.createWebGLTexture();
                        pWebGLRenderer.activateWebGLTexture(0x84C1);
                        pWebGLRenderer.bindWebGLTexture(0x0DE1, pTexture);
                        pWebGLContext.texImage2D(0x0DE1, 0, this._eWebGLFormat, pPOTSize[0], pPOTSize[1], 0, this._eWebGLFormat, this._eWebGLType, null);
                        pWebGLContext.texParameterf(pWebGLContext.TEXTURE_2D, pWebGLContext.TEXTURE_MAG_FILTER, pWebGLContext.NEAREST);
                        pWebGLContext.texParameterf(pWebGLContext.TEXTURE_2D, pWebGLContext.TEXTURE_MIN_FILTER, pWebGLContext.NEAREST);
                        pWebGLContext.texParameterf(pWebGLContext.TEXTURE_2D, pWebGLContext.TEXTURE_WRAP_S, pWebGLContext.CLAMP_TO_EDGE);
                        pWebGLContext.texParameterf(pWebGLContext.TEXTURE_2D, pWebGLContext.TEXTURE_WRAP_T, pWebGLContext.CLAMP_TO_EDGE);
                        var pOldFrameBuffer = pWebGLContext.getParameter(0x8CA6);
                        var pWebGLFramebuffer = pWebGLRenderer.createWebGLFramebuffer();
                        pWebGLRenderer.bindWebGLFramebuffer(0x8D40, pWebGLFramebuffer);
                        pWebGLContext.framebufferTexture2D(0x8D40, 0x8CE0, 0x0DE1, pTexture, 0);
                        if (iSize >= this.byteLength) {
                            for(var k = 0; k < this._pVertexDataArray.length; ++k) {
                                var pVertexData = this._pVertexDataArray[k];
                                if (pVertexData.byteOffset + pVertexData.byteLength > iMax) {
                                    iMax = pVertexData.byteOffset + pVertexData.byteLength;
                                }
                            }
                        }
                        var iTypeSize = akra.pixelUtil.getComponentTypeBits(this._ePixelFormat) / 8;
                        var nElementsPerPix = akra.pixelUtil.getComponentCount(this._ePixelFormat);
                        var nPixels = akra.math.ceil(iMax / iTypeSize / nElementsPerPix);
                        var pIndexBufferData = new Float32Array(nPixels);
                        for(var i = 0; i < nPixels; i++) {
                            pIndexBufferData[i] = i;
                        }
                        pWebGLRenderer.disableAllWebGLVertexAttribs();
                        var iIndexAttribLocation = pWebGLProgram.getWebGLAttributeLocation("INDEX");
                        pWebGLContext.enableVertexAttribArray(iIndexAttribLocation);
                        if (((WebGLVertexTexture._pWebGLBuffer1) === null)) {
                            WebGLVertexTexture._pWebGLBuffer1 = pWebGLRenderer.createWebGLBuffer();
                        }
                        var pIndexBuffer = WebGLVertexTexture._pWebGLBuffer1;
                        pWebGLRenderer.bindWebGLBuffer(0x8892, pIndexBuffer);
                        pWebGLContext.bufferData(0x8892, pIndexBufferData, 0x88E0);
                        pWebGLContext.vertexAttribPointer(iIndexAttribLocation, 1, 0x1406, false, 0, 0);
                        pWebGLContext.disable(0x0B71);
                        pWebGLContext.disable(0x0C11);
                        pWebGLContext.disable(0x0BE2);
                        pWebGLContext.disable(0x0B44);
                        pWebGLRenderer.activateWebGLTexture(0x84C0);
                        pWebGLRenderer.bindWebGLTexture(0x0DE1, this._pWebGLTexture);
                        pWebGLProgram.setInt("sourceTexture", 0);
                        pWebGLProgram.setVec2("v2fSrcTexSize", this._iWidth, this._iHeight);
                        pWebGLProgram.setVec2("v2fDstTexSize", pPOTSize[0], pPOTSize[1]);
                        pWebGLContext.viewport(0, 0, pPOTSize[0], pPOTSize[1]);
                        pWebGLContext.drawArrays(0x0000, 0, nPixels);
                        pWebGLContext.flush();
                        pWebGLContext.framebufferTexture2D(0x8D40, 0x8CE0, 0x0DE1, null, 0);
                        pWebGLContext.disableVertexAttribArray(iIndexAttribLocation);
                        pWebGLRenderer.bindWebGLBuffer(0x8892, null);
                        pWebGLRenderer.bindWebGLFramebuffer(0x8D40, pOldFrameBuffer);
                        pWebGLRenderer.deleteWebGLFramebuffer(pWebGLFramebuffer);
                        pWebGLRenderer.deleteWebGLTexture(this._pWebGLTexture);
                        this._pWebGLTexture = pTexture;
                        this._iWidth = pPOTSize[0];
                        this._iHeight = pPOTSize[1];
                    }
                }
                this._pHeader.setData(this._header());
                this.notifyAltered();
                return true;
            };
            WebGLVertexTexture.prototype.lockImpl = function (iOffset, iSize, iLockFlags) {
                var pRetData = new Uint8Array(iSize);
                this.readData(iOffset, iSize, pRetData);
                this._pLockData = pRetData;
                return pRetData;
            };
            WebGLVertexTexture.prototype.unlockImpl = function () {
                this.writeData(this._pLockData, this._iLockStart, this._iLockSize);
            };
            WebGLVertexTexture.prototype.copyBackupToRealImpl = function (pRealData, pBackupData, iLockFlags) {
                pRealData.set(pBackupData);
            };
            WebGLVertexTexture.prototype._header = function (iTextureSizeX, iTextureSizeY) {
                if (typeof iTextureSizeX === "undefined") { iTextureSizeX = this._iWidth; }
                if (typeof iTextureSizeY === "undefined") { iTextureSizeY = this._iHeight; }
                var pHeader = new Float32Array(8);
                pHeader[0] = iTextureSizeX;
                pHeader[1] = iTextureSizeY;
                pHeader[2] = 1 / iTextureSizeX;
                pHeader[3] = 1 / iTextureSizeY;
                pHeader[4] = iTextureSizeX * iTextureSizeY;
                pHeader[5] = pHeader[4] * akra.pixelUtil.getNumElemBytes(this._ePixelFormat);
                return pHeader;
            };
            WebGLVertexTexture._pWebGLBuffer1 = null;
            WebGLVertexTexture._pWebGLBuffer2 = null;
            WebGLVertexTexture._pWebGLBuffer3 = null;
            return WebGLVertexTexture;
        })(akra.core.pool.resources.VertexBuffer);
        webgl.WebGLVertexTexture = WebGLVertexTexture;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (data) {
        var IndexData = (function () {
            function IndexData(pIndexBuffer, id, iOffset, iCount, ePrimitiveType, eElementsType) {
                if (typeof ePrimitiveType === "undefined") { ePrimitiveType = akra.EPrimitiveTypes.TRIANGLELIST; }
                if (typeof eElementsType === "undefined") { eElementsType = akra.EDataTypes.UNSIGNED_SHORT; }
 {
                    akra.logger.setSourceLocation("data/IndexData.ts", 36);
                    akra.logger.assert(eElementsType == akra.EDataTypes.UNSIGNED_SHORT || eElementsType == akra.EDataTypes.UNSIGNED_BYTE || eElementsType == akra.EDataTypes.UNSIGNED_INT, "supported only short, byte, uint data types.");
                }
                ;
                this._pIndexBuffer = pIndexBuffer;
                this._iOffset = iOffset;
                this._iLength = iCount;
                this._iId = id;
                this._ePrimitiveType = ePrimitiveType;
                this._eElementsType = eElementsType;
 {
                    akra.logger.setSourceLocation("data/IndexData.ts", 46);
                    akra.logger.assert(pIndexBuffer.byteLength >= this.byteLength + this.byteOffset, "out of buffer limits.");
                }
                ;
            }
            Object.defineProperty(IndexData.prototype, "id", {
                get: function () {
                    return this._iId;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(IndexData.prototype, "type", {
                get: function () {
                    return this._eElementsType;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(IndexData.prototype, "length", {
                get: function () {
                    return this._iLength;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(IndexData.prototype, "bytesPerIndex", {
                get: function () {
                    return akra.getTypeSize(this._eElementsType);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(IndexData.prototype, "byteOffset", {
                get: function () {
                    return this._iOffset;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(IndexData.prototype, "byteLength", {
                get: function () {
                    return this._iLength * this.bytesPerIndex;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(IndexData.prototype, "buffer", {
                get: function () {
                    return this._pIndexBuffer;
                },
                enumerable: true,
                configurable: true
            });
            IndexData.prototype.getData = function (iOffset, iSize) {
 {
                    akra.logger.setSourceLocation("data/IndexData.ts", 51);
                    akra.logger.assert(iOffset + iSize <= this.byteLength, "out of buffer limits");
                }
                ;
                var pBuffer = new Uint8Array(iSize);
                if (this._pIndexBuffer.readData(this.byteOffset + iOffset, iSize, pBuffer)) {
                    return pBuffer.buffer;
                }
 {
                    akra.logger.setSourceLocation("data/IndexData.ts", 58);
                    akra.logger.error("cannot read data from index buffer");
                }
                ;
                return null;
            };
            IndexData.prototype.getTypedData = function (iStart, iCount) {
 {
                    akra.logger.setSourceLocation("data/IndexData.ts", 64);
                    akra.logger.assert((iStart + iCount) <= this._iLength, "out of buffer limits");
                }
                ;
                var iTypeSize = akra.getTypeSize(this._eElementsType);
                var iOffset = iStart * iTypeSize;
                var iSize = iCount * iTypeSize;
                var pBuffer = new Uint8Array(iSize);
                if (this._pIndexBuffer.readData(this.byteOffset + iOffset, iSize, pBuffer)) {
                    switch(this._eElementsType) {
                        case akra.EDataTypes.UNSIGNED_BYTE:
                            return pBuffer;
                        case akra.EDataTypes.UNSIGNED_SHORT:
                            return new Uint16Array(pBuffer.buffer);
                        case akra.EDataTypes.UNSIGNED_INT:
                            return new Uint32Array(pBuffer.buffer);
                        default:
                            return null;
                    }
                }
                return null;
            };
            IndexData.prototype.setData = function (pData, iOffset, iCount) {
                if (typeof iOffset === "undefined") { iOffset = 0; }
                if (typeof iCount === "undefined") { iCount = pData.byteLength / this.bytesPerIndex; }
 {
                    akra.logger.setSourceLocation("data/IndexData.ts", 90);
                    akra.logger.assert((iOffset + iCount) * this.bytesPerIndex <= this.byteLength, "out of buffer limits.");
                }
                ;
                return this._pIndexBuffer.writeData(pData, this.byteOffset + iOffset * this.bytesPerIndex, iCount * this.bytesPerIndex);
            };
            IndexData.prototype.destroy = function () {
                this._pIndexBuffer = null;
                this._iOffset = undefined;
                this._iLength = undefined;
                this._eElementsType = undefined;
                this._eElementsType = undefined;
            };
            IndexData.prototype.getPrimitiveType = function () {
                return this._ePrimitiveType;
            };
            IndexData.prototype.getPrimitiveCount = function (iIndexCount) {
                if (typeof iIndexCount === "undefined") { iIndexCount = this.length; }
                return IndexData.getPrimitiveCount(this._ePrimitiveType, iIndexCount);
            };
            IndexData.prototype.getBufferHandle = function () {
                return this._pIndexBuffer.resourceHandle;
            };
            IndexData.getPrimitiveCount = function getPrimitiveCount(eType, nVertices) {
                switch(eType) {
                    case akra.EPrimitiveTypes.POINTLIST:
                        return nVertices;
                    case akra.EPrimitiveTypes.LINELIST:
                        return nVertices / 2;
                    case akra.EPrimitiveTypes.LINESTRIP:
                        return nVertices - 1;
                    case akra.EPrimitiveTypes.LINELOOP:
                        return nVertices;
                    case akra.EPrimitiveTypes.TRIANGLELIST:
                        return nVertices / 3;
                    case akra.EPrimitiveTypes.TRIANGLEFAN:
                    case akra.EPrimitiveTypes.TRIANGLESTRIP:
                        return nVertices - 2;
                }
 {
                    akra.logger.setSourceLocation("data/IndexData.ts", 135);
                    akra.logger.error("unhandled case detected..");
                }
                ;
                return 0;
            };
            return IndexData;
        })();
        data.IndexData = IndexData;        
    })(akra.data || (akra.data = {}));
    var data = akra.data;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                var IndexBuffer = (function (_super) {
                    __extends(IndexBuffer, _super);
                    function IndexBuffer() {
                                        _super.call(this);
                        this._pIndexDataArray = [];
                        this._iDataCounter = 0;
                    }
                    Object.defineProperty(IndexBuffer.prototype, "length", {
                        get: function () {
                            return this._pIndexDataArray.length;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    IndexBuffer.prototype.create = function (iByteSize, iFlags, pData) {
                        _super.prototype.create.call(this, 0, iFlags || 0);
                        if ((((iFlags) & (akra.EHardwareBufferFlags.BACKUP_COPY)) != 0)) {
                            this._pBackupCopy = new resources.MemoryBuffer();
                            this._pBackupCopy.create(iByteSize);
                            this._pBackupCopy.writeData(pData, 0, iByteSize);
                        }
                        return true;
                    };
                    IndexBuffer.prototype.destroy = function () {
                        _super.prototype.destroy.call(this);
                        this._pBackupCopy.destroy();
                        this.freeIndexData();
                        this._iDataCounter = 0;
                    };
                    IndexBuffer.prototype.getIndexData = function (iOffset, iCount, ePrimitiveType, eElementsType) {
                        var pIndexData = new akra.data.IndexData(this, this._iDataCounter++, iOffset, iCount, ePrimitiveType, eElementsType);
                        this._pIndexDataArray.push(pIndexData);
                        return pIndexData;
                    };
                    IndexBuffer.prototype.getEmptyIndexData = function (iCount, ePrimitiveType, eElementsType) {
                        var pHole = new Array();
                        var i;
                        var pIndexData;
                        pHole[0] = {
                            start: 0,
                            end: this.byteLength
                        };
                        for(var k = 0; k < this._pIndexDataArray.length; ++k) {
                            pIndexData = this._pIndexDataArray[k];
                            for(i = 0; i < pHole.length; i++) {
                                if (pIndexData.byteOffset > pHole[i].start && pIndexData.byteOffset + pIndexData.byteLength < pHole[i].end) {
                                    var iTemp = pHole[i].end;
                                    pHole[i].end = pIndexData.byteOffset;
                                    pHole.splice(i + 1, 0, {
                                        start: pIndexData.byteOffset + pIndexData.byteLength,
                                        end: iTemp
                                    });
                                    i--;
                                } else if (pIndexData.byteOffset == pHole[i].start && pIndexData.byteOffset + pIndexData.byteLength < pHole[i].end) {
                                    pHole[i].start = pIndexData.byteOffset + pIndexData.byteLength;
                                } else if (pIndexData.byteOffset > pHole[i].start && pIndexData.byteOffset + pIndexData.byteLength == pHole[i].end) {
                                } else if (pIndexData.byteOffset == pHole[i].start && pIndexData.byteLength == (pHole[i].end - pHole[i].start)) {
                                    pHole.splice(i, 1);
                                    i--;
                                } else if (pIndexData.byteOffset < pHole[i].start && pIndexData.byteOffset + pIndexData.byteLength > pHole[i].start && pIndexData.byteOffset + pIndexData.byteLength < pHole[i].end) {
                                    pHole[i].start = pIndexData.byteOffset + pIndexData.byteLength;
                                } else if (pIndexData.byteOffset < pHole[i].start && pIndexData.byteOffset + pIndexData.byteLength > pHole[i].start && pIndexData.byteOffset + pIndexData.byteLength == pHole[i].end) {
                                    pHole.splice(i, 1);
                                    i--;
                                } else if (pIndexData.byteOffset + pIndexData.byteLength > pHole[i].end && pIndexData.byteOffset > pHole[i].start && pIndexData.byteOffset < pHole[i].end) {
                                    pHole[i].end = pIndexData.byteOffset;
                                } else if (pIndexData.byteOffset + pIndexData.byteLength > pHole[i].end && pIndexData.byteOffset == pHole[i].start && pIndexData.byteOffset < pHole[i].end) {
                                    pHole.splice(i, 1);
                                    i--;
                                } else if (pIndexData.byteOffset < pHole[i].start && pIndexData.byteOffset + pIndexData.byteLength > pHole[i].end) {
                                    i--;
                                }
                            }
                        }
                        pHole.sort(/** @inline */function (a, b) {
                            return ((a.end - a.start) - (b.end - b.start));
                        });
                        for(i = 0; i < pHole.length; i++) {
                            if ((pHole[i].end - pHole[i].start) >= iCount * akra.getTypeSize(eElementsType)) {
                                pIndexData = new akra.data.IndexData(this, this._iDataCounter++, pHole[i].start, iCount, ePrimitiveType, eElementsType);
                                this._pIndexDataArray.push(pIndexData);
                                return pIndexData;
                            }
                        }
                        return null;
                    };
                    IndexBuffer.prototype.freeIndexData = function (pIndexData) {
                        if (arguments.length == 0) {
                            for(var i = 0; i < this._pIndexDataArray.length; i++) {
                                this._pIndexDataArray[Number(i)].destroy();
                            }
                            this._pIndexDataArray = null;
                        } else {
                            for(var i = 0; i < this._pIndexDataArray.length; i++) {
                                if (this._pIndexDataArray[i] == pIndexData) {
                                    pIndexData.destroy();
                                    this._pIndexDataArray.splice(i, 1);
                                    this.notifyAltered();
                                    return true;
                                }
                            }
                            return false;
                        }
                        this.notifyAltered();
                        return true;
                    };
                    IndexBuffer.prototype.allocateData = function (ePrimitiveType, eElementsType, pData) {
                        var pIndexData;
                        var iCount = pData.byteLength / akra.getTypeSize(eElementsType);
 {
                            akra.logger.setSourceLocation("core/pool/resources/IndexBuffer.ts", 164);
                            akra.logger.assert(iCount === akra.math.floor(iCount), "data size should be a multiple of the vertex declaration");
                        }
                        ;
                        pIndexData = this.getEmptyIndexData(iCount, ePrimitiveType, eElementsType);
                        pIndexData.setData(pData);
                        return pIndexData;
                    };
                    return IndexBuffer;
                })(resources.HardwareBuffer);
                resources.IndexBuffer = IndexBuffer;                
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        var WebGLIndexBuffer = (function (_super) {
            __extends(WebGLIndexBuffer, _super);
            function WebGLIndexBuffer() {
                        _super.call(this);
                this._pLockData = null;
            }
            Object.defineProperty(WebGLIndexBuffer.prototype, "byteLength", {
                get: function () {
                    return this._iByteSize;
                },
                enumerable: true,
                configurable: true
            });
            WebGLIndexBuffer.prototype.create = function (iByteSize, iFlags, pData) {
                if (typeof iFlags === "undefined") { iFlags = akra.EHardwareBufferFlags.STATIC; }
                if (typeof pData === "undefined") { pData = null; }
                iByteSize = akra.math.max(iByteSize, 1024);
                if ((((iFlags) & (akra.EHardwareBufferFlags.READABLE)) != 0)) {
                    ((iFlags) |= (akra.EHardwareBufferFlags.BACKUP_COPY));
                }
                _super.prototype.create.call(this, iByteSize, iFlags, pData);
                var pWebGLRenderer = this.getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                var i;
 {
                    akra.logger.setSourceLocation("webgl/WebGLIndexBuffer.ts", 45);
                    akra.logger.assert(this._pWebGLBuffer == null, "webgl buffer already allocated");
                }
                ;
                this._iByteSize = iByteSize;
                this._iFlags = iFlags;
                pWebGLContext = pWebGLRenderer.getWebGLContext();
 {
                    akra.logger.setSourceLocation("webgl/WebGLIndexBuffer.ts", 51);
                    akra.logger.assert(pWebGLContext !== null, "cannot grab webgl context");
                }
                ;
 {
                    akra.logger.setSourceLocation("webgl/WebGLIndexBuffer.ts", 54);
                    akra.logger.assert(!this.isSoftware(), "no sftware rendering");
                }
                ;
                if (this.isBackupPresent()) {
                    ((this._iFlags) |= (akra.EHardwareBufferFlags.READABLE));
                }
 {
                    akra.logger.setSourceLocation("webgl/WebGLIndexBuffer.ts", 62);
                    akra.logger.assert(!pData || pData.byteLength <= iByteSize, "Размер переданного массива больше переданного размера буфера");
                }
                ;
                this._pWebGLBuffer = pWebGLRenderer.createWebGLBuffer();
                if (!this._pWebGLBuffer) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLIndexBuffer.ts", 68);
                        akra.logger.criticalError("cannot create WebGL index buffer");
                    }
                    ;
                    this.destroy();
                    return false;
                }
                pWebGLRenderer.bindWebGLBuffer(0x8893, this._pWebGLBuffer);
                pWebGLContext.bufferData(0x8893, this._iByteSize, webgl.getWebGLUsage(this._iFlags));
                if (pData) {
                    pWebGLContext.bufferSubData(0x8893, 0, (((pData) instanceof ArrayBuffer) ? pData : (pData).buffer));
                }
                return true;
            };
            WebGLIndexBuffer.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
                var pWebGLRenderer = this.getEngine().getRenderer();
                pWebGLRenderer.deleteWebGLBuffer(this._pWebGLBuffer);
                this._pWebGLBuffer = null;
                this._iByteSize = 0;
            };
            WebGLIndexBuffer.prototype.readData = function (iOffset, iSize, ppDest) {
 {
                    akra.logger.setSourceLocation("webgl/WebGLIndexBuffer.ts", 99);
                    akra.logger.assert(!((this._pWebGLBuffer) === null), "WebGL buffer not exists");
                }
                ;
                if (!this.isBackupPresent()) {
                    return false;
                }
                if (arguments.length === 1) {
                    this._pBackupCopy.readData(arguments[0]);
                } else {
                    this._pBackupCopy.readData(iOffset, iSize, ppDest);
                }
                return true;
            };
            WebGLIndexBuffer.prototype.writeData = function (pData, iOffset, iSize, bDiscardWholeBuffer) {
                if (typeof bDiscardWholeBuffer === "undefined") { bDiscardWholeBuffer = false; }
 {
                    akra.logger.setSourceLocation("webgl/WebGLIndexBuffer.ts", 119);
                    akra.logger.assert(!((this._pWebGLBuffer) === null), "WebGL buffer not exists");
                }
                ;
                var pWebGLRenderer = this.getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLRenderer.bindWebGLBuffer(0x8893, this._pWebGLBuffer);
 {
                    akra.logger.setSourceLocation("webgl/WebGLIndexBuffer.ts", 126);
                    akra.logger.assert(pData.byteLength <= iSize, "Размер переданного массива больше переданного размера");
                }
                ;
 {
                    akra.logger.setSourceLocation("webgl/WebGLIndexBuffer.ts", 127);
                    akra.logger.assert(this.byteLength >= iOffset + iSize, "Данные выйдут за предел буфера");
                }
                ;
                var pU8Data = null;
                if (((pData) instanceof ArrayBuffer)) {
                    pU8Data = new Uint8Array(pData);
                } else {
                    pU8Data = new Uint8Array(pData.buffer, pData.byteOffset, pData.byteLength);
                }
                pU8Data = pU8Data.subarray(0, iSize);
                pWebGLContext.bufferSubData(0x8893, iOffset, pU8Data);
                if (this.isBackupPresent()) {
                    this._pBackupCopy.writeData(pU8Data, iOffset);
                }
                this.notifyAltered();
                return true;
            };
            WebGLIndexBuffer.prototype.resize = function (iSize) {
                var eUsage;
                var pData;
                var iMax = 0;
                var pIndexData;
                var pWebGLRenderer = this.getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                if (this.isBackupPresent()) {
                    return false;
                }
                if (iSize < this.byteLength) {
                    for(var k = 0; k < this._pIndexDataArray.length; ++k) {
                        pIndexData = this._pIndexDataArray[k];
                        if (pIndexData.byteOffset + pIndexData.byteLength > iMax) {
                            iMax = pIndexData.byteOffset + pIndexData.byteLength;
                        }
                    }
 {
                        akra.logger.setSourceLocation("webgl/WebGLIndexBuffer.ts", 174);
                        akra.logger.assert(iMax <= iSize, "Уменьшение невозможно. Страая разметка не укладывается в новый размер");
                    }
                    ;
                }
                if (pWebGLContext.isBuffer(this._pWebGLBuffer)) {
                    pWebGLRenderer.deleteWebGLBuffer(this._pWebGLBuffer);
                }
                eUsage = webgl.getWebGLUsage(this._iFlags);
                this._pWebGLBuffer = pWebGLRenderer.createWebGLBuffer();
                if (!this._pWebGLBuffer) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLIndexBuffer.ts", 186);
                        akra.logger.criticalError("cannot create WebGL index buffer");
                    }
                    ;
                    this.destroy();
                    return false;
                }
                pWebGLRenderer.bindWebGLBuffer(0x8893, this._pWebGLBuffer);
                pWebGLContext.bufferData(0x8893, iSize, eUsage);
                pData = new Uint8Array(this._iByteSize);
                if (this.readData(pData)) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLIndexBuffer.ts", 199);
                        akra.logger.warning("cannot read data from buffer");
                    }
                    ;
                    return false;
                }
                this.writeData(pData, 0, this._iByteSize);
                this._pBackupCopy.resize(iSize);
                this._iByteSize = iSize;
                this.notifyAltered();
                return true;
            };
            WebGLIndexBuffer.prototype.getWebGLBuffer = function () {
                return this._pWebGLBuffer;
            };
            WebGLIndexBuffer.prototype.lockImpl = function (iOffset, iSize, iLockFlags) {
                var pRetData = new Uint8Array(iSize);
                this.readData(iOffset, iSize, pRetData);
                this._pLockData = pRetData;
                return pRetData;
            };
            WebGLIndexBuffer.prototype.unlockImpl = function () {
                this.writeData(this._pLockData, this._iLockStart, this._iLockSize);
            };
            WebGLIndexBuffer.prototype.copyBackupToRealImpl = function (pRealData, pBackupData, iLockFlags) {
                pRealData.set(pBackupData);
            };
            return WebGLIndexBuffer;
        })(akra.core.pool.resources.IndexBuffer);
        webgl.WebGLIndexBuffer = WebGLIndexBuffer;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        var WebGLInternalRenderBuffer = (function (_super) {
            __extends(WebGLInternalRenderBuffer, _super);
            function WebGLInternalRenderBuffer() {
                        _super.call(this);
                this._pWebGLRenderbuffer = null;
            }
            WebGLInternalRenderBuffer.prototype.create = function () {
                if (arguments.length !== 4) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLInternalRenderbuffer.ts", 20);
                        akra.logger.criticalError("Invalid number of arguments. For PixelBuffer it must be four");
                    }
                    ;
                }
                var iWebGLFormat = arguments[0];
                var iWidth = arguments[1];
                var iHeight = arguments[2];
                var bCreateStorage = arguments[3];
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                _super.prototype.create.call(this, iWidth, iHeight, 1, akra.webgl.getClosestAkraFormat(iWebGLFormat, akra.EPixelFormats.A8R8G8B8), 0);
                this._iWebGLInternalFormat = iWebGLFormat;
                this._pWebGLRenderbuffer = pWebGLRenderer.createWebGLRenderbuffer();
                pWebGLRenderer.bindWebGLRenderbuffer(0x8D41, this._pWebGLRenderbuffer);
                if (bCreateStorage) {
                    pWebGLContext.renderbufferStorage(0x8D41, iWebGLFormat, iWidth, iHeight);
                }
                this.notifyCreated();
                return true;
            };
            WebGLInternalRenderBuffer.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                pWebGLRenderer.deleteWebGLRenderbuffer(this._pWebGLRenderbuffer);
                this._pWebGLRenderbuffer = null;
            };
            WebGLInternalRenderBuffer.prototype._bindToFramebuffer = function (iAttachment, iZOffset) {
 {
                    akra.logger.setSourceLocation("webgl/WebGLInternalRenderbuffer.ts", 55);
                    akra.logger.assert(iZOffset < this._iDepth);
                }
                ;
                var pWebGLRenderer = this.getManager().getEngine().getRenderer();
                var pWebGLContext = pWebGLRenderer.getWebGLContext();
                pWebGLContext.framebufferRenderbuffer(0x8D40, iAttachment, 0x8D41, this._pWebGLRenderbuffer);
            };
            return WebGLInternalRenderBuffer;
        })(webgl.WebGLPixelBuffer);
        webgl.WebGLInternalRenderBuffer = WebGLInternalRenderBuffer;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            (function (resources) {
                var DepthBuffer = (function (_super) {
                    __extends(DepthBuffer, _super);
                    function DepthBuffer() {
                                        _super.call(this);
                        this._iBitDepth = 0;
                        this._iWidth = 0;
                        this._iHeight = 0;
                        this._isManual = false;
                        this._pAttachedRenderTargetsList = null;
                    }
                    Object.defineProperty(DepthBuffer.prototype, "bitDepth", {
                        get: function () {
                            return this._iBitDepth;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(DepthBuffer.prototype, "width", {
                        get: function () {
                            return this._iWidth;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    Object.defineProperty(DepthBuffer.prototype, "height", {
                        get: function () {
                            return this._iHeight;
                        },
                        enumerable: true,
                        configurable: true
                    });
                    DepthBuffer.prototype.create = function (iBitDepth, iWidth, iHeight, isManual) {
                        this._iBitDepth = iBitDepth;
                        this._iWidth = iWidth;
                        this._iHeight = iHeight;
                        this._isManual = isManual;
                        this._pAttachedRenderTargetsList = [];
                        this.notifyCreated();
                        return true;
                    };
                    DepthBuffer.prototype.destroy = function () {
                        this.detachFromAllRenderTargets();
                        this._pAttachedRenderTargetsList = null;
                    };
                    DepthBuffer.prototype.destroyResource = function () {
                        this.destroy();
                        this.notifyDestroyed();
                        return true;
                    };
                    DepthBuffer.prototype.isManual = function () {
                        return this._isManual;
                    };
                    DepthBuffer.prototype.isCompatible = function (pTarget) {
                        if (this._iWidth >= pTarget.width && this._iHeight >= pTarget.height) {
                            return true;
                        }
                        return false;
                    };
                    DepthBuffer.prototype._notifyRenderTargetAttached = function (pTarget) {
 {
                            akra.logger.setSourceLocation("core/pool/resources/DepthBuffer.ts", 70);
                            akra.logger.assert(this._pAttachedRenderTargetsList.indexOf(pTarget) === -1, "RenderTarget alrady has been attached to this DepthBuffer");
                        }
                        ;
                        this._pAttachedRenderTargetsList.push(pTarget);
                    };
                    DepthBuffer.prototype._notifyRenderTargetDetached = function (pTarget) {
                        var index = this._pAttachedRenderTargetsList.indexOf(pTarget);
 {
                            akra.logger.setSourceLocation("core/pool/resources/DepthBuffer.ts", 78);
                            akra.logger.assert(index !== -1, "Can not detach RenderTarget from DepthBuffer beacuse it hasn`t been attached to it");
                        }
                        ;
                        this._pAttachedRenderTargetsList.splice(index, 1);
                    };
                    DepthBuffer.prototype.detachFromAllRenderTargets = function () {
                        var i = 0;
                        for(i = 0; i < this._pAttachedRenderTargetsList.length; i++) {
                            this._pAttachedRenderTargetsList[i].detachDepthBuffer();
                        }
                        this._pAttachedRenderTargetsList.clear();
                    };
                    return DepthBuffer;
                })(pool.ResourcePoolItem);
                resources.DepthBuffer = DepthBuffer;                
            })(pool.resources || (pool.resources = {}));
            var resources = pool.resources;
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var RenderTexture = (function (_super) {
            __extends(RenderTexture, _super);
            function RenderTexture(pRenderer, pBuffer, iZOffset) {
                        _super.call(this, pRenderer);
                this._pBuffer = null;
                this._iZOffset = 0;
                this._pBuffer = pBuffer;
                this._iZOffset = iZOffset;
                this._iWidth = pBuffer.width;
                this._iHeight = pBuffer.height;
                this._iColorDepth = akra.pixelUtil.getNumElemBits(pBuffer.format);
            }
            RenderTexture.prototype.destroy = function () {
                this._pBuffer._clearRTT(this._iZOffset);
                this._pBuffer = null;
            };
            RenderTexture.prototype.suggestPixelFormat = function () {
                return this._pBuffer.format;
            };
            RenderTexture.prototype.copyContentsToMemory = function (pDest, eBuffer) {
                if (eBuffer === akra.EFramebuffer.AUTO) {
                    eBuffer = akra.EFramebuffer.FRONT;
                }
                if (eBuffer !== akra.EFramebuffer.FRONT) {
 {
                        akra.logger.setSourceLocation("render/RenderTexture.ts", 41);
                        akra.logger.criticalError("Invalid buffer.");
                    }
                    ;
                }
                this._pBuffer.blitToMemory(pDest);
            };
            return RenderTexture;
        })(render.RenderTarget);
        render.RenderTexture = RenderTexture;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        var WebGLRenderTexture = (function (_super) {
            __extends(WebGLRenderTexture, _super);
            function WebGLRenderTexture(pRenderer, pTarget) {
                        _super.call(this, pRenderer, pTarget, 0);
                this._pFrameBuffer = null;
                this._pFrameBuffer = new webgl.WebGLInternalFrameBuffer(pRenderer);
                this._pFrameBuffer.bindSurface(0x8CE0, pTarget);
                this._iWidth = this._pFrameBuffer.width;
                this._iHeight = this._pFrameBuffer.height;
            }
            Object.defineProperty(WebGLRenderTexture.prototype, "width", {
                get: function () {
                    return this._iWidth = this._pFrameBuffer.width;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(WebGLRenderTexture.prototype, "height", {
                get: function () {
                    return this._iHeight = this._pFrameBuffer.height;
                },
                enumerable: true,
                configurable: true
            });
            WebGLRenderTexture.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
            };
            WebGLRenderTexture.prototype.requiresTextureFlipping = function () {
                return true;
            };
            WebGLRenderTexture.prototype.getCustomAttribute = function (sName) {
                if (sName === "FBO") {
                    return this._pFrameBuffer;
                }
                return null;
            };
            WebGLRenderTexture.prototype.swapBuffers = function () {
                this._pFrameBuffer.swapBuffers();
            };
            WebGLRenderTexture.prototype.attachDepthBuffer = function (pDepthBuffer) {
                var bResult = false;
                bResult = _super.prototype.attachDepthBuffer.call(this, pDepthBuffer);
                if (bResult) {
                    this._pFrameBuffer.attachDepthBuffer(pDepthBuffer);
                }
                return bResult;
            };
            WebGLRenderTexture.prototype.attachDepthPixelBuffer = function (pBuffer) {
                var bResult = false;
                bResult = _super.prototype.attachDepthPixelBuffer.call(this, pBuffer);
                if (bResult) {
                    if (pBuffer.format !== akra.EPixelFormats.DEPTH8) {
                        this.detachDepthPixelBuffer();
                        return false;
                    }
                    this._pFrameBuffer.bindSurface(0x8D00, pBuffer);
                    (pBuffer).addRef();
                }
                return bResult;
            };
            WebGLRenderTexture.prototype.attachDepthTexture = function (pTexture) {
                this._pFrameBuffer.attachDepthTexture(pTexture);
                return true;
            };
            WebGLRenderTexture.prototype.detachDepthPixelBuffer = function () {
                this._pFrameBuffer.unbindSurface(0x8D00);
                (this._pDepthPixelBuffer).release();
                _super.prototype.detachDepthPixelBuffer.call(this);
            };
            WebGLRenderTexture.prototype.detachDepthBuffer = function () {
                this._pFrameBuffer.detachDepthBuffer();
                _super.prototype.detachDepthBuffer.call(this);
            };
            WebGLRenderTexture.prototype.detachDepthTexture = function () {
                this._pFrameBuffer.detachDepthTexture();
            };
            return WebGLRenderTexture;
        })(akra.render.RenderTexture);
        webgl.WebGLRenderTexture = WebGLRenderTexture;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        var WebGLInternalFrameBuffer = (function () {
            function WebGLInternalFrameBuffer(pWebGLRenderer) {
                this._pWebGLRenderer = null;
                this._pWebGLFramebuffer = null;
                this._pAttachments = null;
                this._iWebglActiveAttachment = 0;
                this._pWebGLRenderer = pWebGLRenderer;
                this._pWebGLFramebuffer = this._pWebGLRenderer.createWebGLFramebuffer();
                this._pAttachments = {};
                for(var i = 0; i < akra.webgl.maxColorAttachments; i++) {
                    this._pAttachments[0x8CE0 + i] = null;
                }
                this._pAttachments[0x8D00] = null;
                this._pAttachments[0x8D20] = null;
                this._pAttachments[0x821A] = null;
            }
            WebGLInternalFrameBuffer.prototype.destroy = function () {
                this._pWebGLRenderer.deleteWebGLFramebuffer(this._pWebGLFramebuffer);
                this._pWebGLFramebuffer = null;
            };
            Object.defineProperty(WebGLInternalFrameBuffer.prototype, "width", {
                get: function () {
                    return this._pAttachments[0x8CE0].width;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(WebGLInternalFrameBuffer.prototype, "height", {
                get: function () {
                    return this._pAttachments[0x8CE0].height;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(WebGLInternalFrameBuffer.prototype, "format", {
                get: function () {
                    return this._pAttachments[0x8CE0].format;
                },
                enumerable: true,
                configurable: true
            });
            WebGLInternalFrameBuffer.prototype.getColorAttachment = function (iAttachment) {
                return this._pAttachments[0x8CE0 + iAttachment];
            };
            WebGLInternalFrameBuffer.prototype.getAttachment = function (iWebGLAttachment) {
                return this._pAttachments[iWebGLAttachment];
            };
            WebGLInternalFrameBuffer.prototype.bindSurface = function (iWebGLAttachment, pSurface) {
                if (!((this._pAttachments[iWebGLAttachment]) !== undefined)) {
                    return;
                }
                this.releaseAttachment(iWebGLAttachment);
                this._pAttachments[iWebGLAttachment] = pSurface;
                if (this.checkAttachment(iWebGLAttachment)) {
                    this._bind();
                    (pSurface)._bindToFramebuffer(iWebGLAttachment, 0);
                    (pSurface).addRef();
                }
            };
            WebGLInternalFrameBuffer.prototype.unbindSurface = function (iWebGLAttachment) {
                if (!((this._pAttachments[iWebGLAttachment]) !== undefined)) {
                    return;
                }
                var pWebGLContext = this._pWebGLRenderer.getWebGLContext();
                this.releaseAttachment(iWebGLAttachment);
                this._pAttachments[iWebGLAttachment] = null;
                pWebGLContext.framebufferRenderbuffer(0x8D40, iWebGLAttachment, 0x8D41, null);
            };
            WebGLInternalFrameBuffer.prototype.bindColorSurface = function (iAttachment, pSurface) {
                this.bindSurface(0x8CE0 + iAttachment, pSurface);
            };
            WebGLInternalFrameBuffer.prototype._bind = function () {
                this._pWebGLRenderer.bindWebGLFramebuffer(0x8D40, this._pWebGLFramebuffer);
            };
            WebGLInternalFrameBuffer.prototype.attachDepthBuffer = function (pDepthBuffer) {
                var pWebGLContext = this._pWebGLRenderer.getWebGLContext();
                var pOldFramebuffer = pWebGLContext.getParameter(0x8CA6);
                this._pWebGLRenderer.bindWebGLFramebuffer(0x8D40, this._pWebGLFramebuffer);
                if (!((pDepthBuffer) === null)) {
                    var pDepthRenderBuffer = (pDepthBuffer).depthBuffer;
                    var pStencilRenderBuffer = (pDepthBuffer).stencilBuffer;
                    if (!((pDepthRenderBuffer) === null)) {
                        pDepthRenderBuffer._bindToFramebuffer(0x8D00, 0);
                        this.releaseAttachment(0x8D00);
                        this._pAttachments[0x8D00] = pDepthRenderBuffer;
                        pDepthRenderBuffer.addRef();
                    }
                    if (!((pStencilRenderBuffer) === null)) {
                        pStencilRenderBuffer._bindToFramebuffer(0x8D20, 0);
                        this.releaseAttachment(0x8D20);
                        this._pAttachments[0x8D20] = pStencilRenderBuffer;
                        pDepthRenderBuffer.addRef();
                    }
                    if (!this.checkAttachment(0x8D00) || !this.checkAttachment(0x8D20)) {
 {
                            akra.logger.setSourceLocation("webgl/WebGLInternalFrameBuffer.ts", 124);
                            akra.logger.error("Invalid frame buffer depthbuffer attachment. Wrong size.");
                        }
                        ;
                        return;
                    }
                } else {
                    pWebGLContext.framebufferRenderbuffer(0x8D40, 0x8D00, 0x8D41, null);
                    pWebGLContext.framebufferRenderbuffer(0x8D40, 0x8D20, 0x8D41, null);
                    this.releaseAttachment(0x8D00);
                    this.releaseAttachment(0x8D20);
                    this._pAttachments[0x8D00] = null;
                    this._pAttachments[0x8D20] = null;
                }
                this._pWebGLRenderer.bindWebGLFramebuffer(0x8D40, pOldFramebuffer);
            };
            WebGLInternalFrameBuffer.prototype.attachDepthTexture = function (pDepthTexture) {
                var pTextureBuffer = (pDepthTexture).getBuffer();
                this._bind();
                this.bindSurface(0x8D00, pTextureBuffer);
            };
            WebGLInternalFrameBuffer.prototype.detachDepthTexture = function () {
                this._bind();
                this.unbindSurface(0x8D00);
            };
            WebGLInternalFrameBuffer.prototype.detachDepthBuffer = function () {
                var pWebGLContext = this._pWebGLRenderer.getWebGLContext();
                var pOldFramebuffer = pWebGLContext.getParameter(0x8CA6);
                this._pWebGLRenderer.bindWebGLFramebuffer(0x8D40, this._pWebGLFramebuffer);
                pWebGLContext.framebufferRenderbuffer(0x8D40, 0x8D00, 0x8D41, null);
                pWebGLContext.framebufferRenderbuffer(0x8D40, 0x8D20, 0x8D41, null);
                this.releaseAttachment(0x8D00);
                this.releaseAttachment(0x8D20);
                this._pAttachments[0x8D00] = null;
                this._pAttachments[0x8D20] = null;
                this._pWebGLRenderer.bindWebGLFramebuffer(0x8D40, pOldFramebuffer);
            };
            WebGLInternalFrameBuffer.prototype.swapBuffers = function () {
            };
            WebGLInternalFrameBuffer.prototype.checkAttachment = function (iWebGLAttachment) {
                if (iWebGLAttachment === 0x8CE0) {
                    var isOk = true;
                    for(var i = 1; i < akra.webgl.maxColorAttachments; i++) {
                        isOk = this.checkAttachment(0x8CE0 + i);
                        if (!isOk) {
                            return false;
                        }
                    }
                    isOk = this.checkAttachment(0x8D00);
                    if (!isOk) {
                        return false;
                    }
                    isOk = this.checkAttachment(0x8D20);
                    if (!isOk) {
                        return false;
                    }
                    isOk = this.checkAttachment(0x821A);
                    if (!isOk) {
                        return false;
                    }
                    return true;
                } else {
                    var pBuffer = this._pAttachments[iWebGLAttachment];
                    if (((pBuffer) === null)) {
                        return true;
                    }
                    if (this.width === 0 && this.height === 0) {
                        return true;
                    }
                    if (this.width !== pBuffer.width && this.height !== pBuffer.height) {
                        return false;
                    }
                    if (iWebGLAttachment > 0x8CE0 && iWebGLAttachment < 0x8CE0 + akra.webgl.maxColorAttachments) {
                        if (!((this._pAttachments[0x8CE0]) === null) && this.format !== pBuffer.format) {
                            return false;
                        }
                    }
                    return true;
                }
            };
            WebGLInternalFrameBuffer.prototype.releaseAttachment = function (iWebGLAttachment) {
                if (!((this._pAttachments[iWebGLAttachment]) === null)) {
                    this._pAttachments[iWebGLAttachment].release();
                }
            };
            return WebGLInternalFrameBuffer;
        })();
        webgl.WebGLInternalFrameBuffer = WebGLInternalFrameBuffer;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (webgl) {
        var WebGLDepthBuffer = (function (_super) {
            __extends(WebGLDepthBuffer, _super);
            function WebGLDepthBuffer() {
                        _super.call(this);
                this._pDepthBuffer = null;
                this._pStencilBuffer = null;
            }
            Object.defineProperty(WebGLDepthBuffer.prototype, "depthBuffer", {
                get: function () {
                    return this._pDepthBuffer;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(WebGLDepthBuffer.prototype, "stencilBuffer", {
                get: function () {
                    return this._pStencilBuffer;
                },
                enumerable: true,
                configurable: true
            });
            WebGLDepthBuffer.prototype.create = function () {
                if (arguments.length !== 5) {
 {
                        akra.logger.setSourceLocation("webgl/WebGLDepthBuffer.ts", 30);
                        akra.logger.criticalError("Invalid number of arguments. For WebGLDepthBuffer it must be five");
                    }
                    ;
                }
                _super.prototype.create.call(this, 0, arguments[2], arguments[3], arguments[4]);
                var pDepth = arguments[0];
                var pStencil = arguments[1];
                this._pDepthBuffer = pDepth;
                this._pStencilBuffer = pStencil;
                if (!((pDepth) === null)) {
                    switch(pDepth._getWebGLFormat()) {
                        case 0x81A5:
                            this._iBitDepth = 16;
                            break;
                        case 0x81A6:
                        case 0x81A7:
                        case 0x88F0:
                            if (akra.webgl.hasExtension("OES_depth24") || akra.webgl.hasExtension("OES_depth32") || akra.webgl.hasExtension("OES_packed_depth_stencil")) {
                                this._iBitDepth = 32;
                            }
                            break;
                    }
                }
                return true;
            };
            WebGLDepthBuffer.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
                if (!((this._pStencilBuffer) === null) && this._pStencilBuffer !== this._pDepthBuffer) {
                    this._pStencilBuffer.release();
                }
                if (!((this._pDepthBuffer) === null)) {
                    this._pDepthBuffer.release();
                }
                this._pStencilBuffer = null;
                this._pDepthBuffer = null;
            };
            WebGLDepthBuffer.prototype.isCompatible = function (pTarget) {
                if (this._iWidth >= pTarget.width && this._iHeight >= pTarget.height) {
                    return true;
                }
                return false;
            };
            return WebGLDepthBuffer;
        })(akra.core.pool.resources.DepthBuffer);
        webgl.WebGLDepthBuffer = WebGLDepthBuffer;        
    })(akra.webgl || (akra.webgl = {}));
    var webgl = akra.webgl;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        (function (pool) {
            var ResourcePoolManager = (function () {
                function ResourcePoolManager(pEngine) {
                    this.pResourceFamilyList = null;
                    this.pResourceTypeMap = null;
                    this.pWaiterResource = null;
                    this.pEngine = pEngine;
                    this.pResourceFamilyList = new Array(akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES);
                    for(var i = 0; i < akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES; i++) {
                        this.pResourceFamilyList[i] = new Array();
                    }
                    this.pResourceTypeMap = new Array();
                    this.pWaiterResource = new core.pool.ResourcePoolItem();
                    this.createDeviceResource();
                }
                Object.defineProperty(ResourcePoolManager.prototype, "surfaceMaterialPool", {
                    get: function () {
                        return this.pSurfaceMaterialPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "effectPool", {
                    get: function () {
                        return this.pEffectPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "renderMethodPool", {
                    get: function () {
                        return this.pRenderMethodPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "vertexBufferPool", {
                    get: function () {
                        return this.pVertexBufferPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "indexBufferPool", {
                    get: function () {
                        return this.pIndexBufferPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "colladaPool", {
                    get: function () {
                        return this.pColladaPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "imagePool", {
                    get: function () {
                        return this.pImagePool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "texturePool", {
                    get: function () {
                        return this.pTexturePool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "videoBufferPool", {
                    get: function () {
                        return this.pVideoBufferPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "shaderProgramPool", {
                    get: function () {
                        return this.pShaderProgramPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "componentPool", {
                    get: function () {
                        return this.pComponentPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "textureBufferPool", {
                    get: function () {
                        return this.pTextureBufferPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "renderBufferPool", {
                    get: function () {
                        return this.pRenderBufferPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "depthBufferPool", {
                    get: function () {
                        return this.pDepthBufferPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ResourcePoolManager.prototype, "effectDataPool", {
                    get: function () {
                        return this.pEffectDataPool;
                    },
                    enumerable: true,
                    configurable: true
                });
                ResourcePoolManager.prototype.initialize = function () {
                    this.registerDeviceResources();
                    return true;
                };
                ResourcePoolManager.prototype.destroy = function () {
                    this.unregisterDeviceResources();
                };
                ResourcePoolManager.prototype.registerResourcePool = function (pCode, pPool) {
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 115);
                        akra.logger.assert(pCode.family >= 0 && pCode.family < akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES, "invalid code familyi index");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 117);
                        akra.logger.assert(!((this.pResourceTypeMap[pCode.toNumber()]) !== undefined), "Resource type code already registered");
                    }
                    ;
                    this.pResourceTypeMap[pCode.toNumber()] = pPool;
                    this.pResourceFamilyList[pCode.family].push(pPool);
                };
                ResourcePoolManager.prototype.unregisterResourcePool = function (pCode) {
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 124);
                        akra.logger.assert(pCode.family >= 0, "invalid family index");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 125);
                        akra.logger.assert(pCode.family < akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES, "invalid family index");
                    }
                    ;
                    var iCode = pCode.toNumber();
                    var pPool = null;
                    if (this.pResourceTypeMap[iCode] != undefined) {
                        pPool = this.pResourceTypeMap[iCode];
                        delete this.pResourceTypeMap[iCode];
                    }
                    if (pPool != null) {
                        for(var i in this.pResourceFamilyList[pCode.family]) {
                            if (this.pResourceFamilyList[pCode.family][i] == pPool) {
                                delete this.pResourceFamilyList[pCode.family][i];
                                return pPool;
                            }
                        }
                    }
                    return pPool;
                };
                ResourcePoolManager.prototype.destroyResourceFamily = function (eFamily) {
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 148);
                        akra.logger.assert(eFamily < akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES, "invalid family index");
                    }
                    ;
                    for(var i in this.pResourceFamilyList[eFamily]) {
                        this.pResourceFamilyList[eFamily][i].destroyAll();
                    }
                };
                ResourcePoolManager.prototype.restoreResourceFamily = function (eFamily) {
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 157);
                        akra.logger.assert(eFamily >= 0, "invalid family index");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 158);
                        akra.logger.assert(eFamily < akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES, "invalid family index");
                    }
                    ;
                    for(var i in this.pResourceFamilyList[eFamily]) {
                        this.pResourceFamilyList[eFamily][i].restoreAll();
                    }
                };
                ResourcePoolManager.prototype.disableResourceFamily = function (eFamily) {
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 166);
                        akra.logger.assert(eFamily >= 0, "invalid family index");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 167);
                        akra.logger.assert(eFamily < akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES, "invalid family index");
                    }
                    ;
                    for(var i in this.pResourceFamilyList[eFamily]) {
                        this.pResourceFamilyList[eFamily][i].disableAll();
                    }
                };
                ResourcePoolManager.prototype.cleanResourceFamily = function (eFamily) {
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 175);
                        akra.logger.assert(eFamily >= 0, "invalid family index");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 176);
                        akra.logger.assert(eFamily < akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES, "invalid family index");
                    }
                    ;
                    for(var i in this.pResourceFamilyList[eFamily]) {
                        this.pResourceFamilyList[eFamily][i].clean();
                    }
                };
                ResourcePoolManager.prototype.destroyResourceType = function (pCode) {
                    if (((this.pResourceTypeMap[pCode.toNumber()]) !== undefined)) {
                        this.pResourceTypeMap[pCode.toNumber()].destroyAll();
                    }
                };
                ResourcePoolManager.prototype.restoreResourceType = function (pCode) {
                    if (((this.pResourceTypeMap[pCode.toNumber()]) !== undefined)) {
                        this.pResourceTypeMap[pCode.toNumber()].restoreAll();
                    }
                };
                ResourcePoolManager.prototype.disableResourceType = function (pCode) {
                    if (((this.pResourceTypeMap[pCode.toNumber()]) !== undefined)) {
                        this.pResourceTypeMap[pCode.toNumber()].disableAll();
                    }
                };
                ResourcePoolManager.prototype.cleanResourceType = function (pCode) {
                    if (((this.pResourceTypeMap[pCode.toNumber()]) !== undefined)) {
                        this.pResourceTypeMap[pCode.toNumber()].clean();
                    }
                };
                ResourcePoolManager.prototype.findResourcePool = function (pCode) {
                    if (((this.pResourceTypeMap[pCode.toNumber()]) !== undefined)) {
                        return this.pResourceTypeMap[pCode.toNumber()];
                    }
                    return null;
                };
                ResourcePoolManager.prototype.findResourceHandle = function (pCode, sName) {
                    var pPool = this.findResourcePool(pCode);
                    var iHandle = akra.INVALID_INDEX;
                    if (!((pPool) === null)) {
                        iHandle = pPool.findResourceHandle(sName);
                    }
                    return iHandle;
                };
                ResourcePoolManager.prototype.findResource = function (pCode, sName) {
                    var pPool = this.findResourcePool(pCode);
                    var pResult = null;
                    var iHandle = 0;
                    if ((typeof (arguments[1]) === "string")) {
                        iHandle = pPool.findResourceHandle(sName);
                    } else if ((typeof (arguments[1]) === "number")) {
                        iHandle = arguments[1];
                    }
                    if (pPool != null && iHandle != akra.INVALID_INDEX) {
                        pResult = pPool.getResource(iHandle);
                    }
                    return pResult;
                };
                ResourcePoolManager.prototype.monitorInitResources = function (fnMonitor) {
                    var me = this;
                    this.pWaiterResource.setStateWatcher(akra.EResourceItemEvents.LOADED, function () {
                        fnMonitor.apply(me, arguments);
                    });
                };
                ResourcePoolManager.prototype.setLoadedAllRoutine = function (fnCallback) {
                    var pPool;
                    var pResource;
                    var iHandleResource;
                    var pWaiterResouse = this.pWaiterResource;
                    var fnResCallback = function (iFlagBit, iResourceFlags, isSetting) {
                        if (iFlagBit == akra.EResourceItemEvents.LOADED && isSetting) {
                            fnCallback();
                        }
                    };
                    pWaiterResouse.notifyLoaded();
                    for(var n = 0; n < akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES; n++) {
                        for(var i = 0; i < ResourcePoolManager.pTypedResourseTotal[n]; i++) {
                            pPool = this.findResourcePool(new pool.ResourceCode(n, i));
                            if (pPool) {
                                var pResources = pPool.getResources();
                                var pResource;
                                for(var i = 0; i < pResources.length; ++i) {
                                    pResource = pResources[i];
                                    pWaiterResouse.sync(pResource, akra.EResourceItemEvents.LOADED);
                                }
                            }
                        }
                    }
                    if (pWaiterResouse.isResourceLoaded()) {
                        fnCallback();
                    } else {
                        pWaiterResouse.setChangesNotifyRoutine(fnResCallback);
                    }
                };
                ResourcePoolManager.prototype.destroyAll = function () {
                    for(var i = 0; i < akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES; i++) {
                        this.destroyResourceFamily(i);
                    }
                };
                ResourcePoolManager.prototype.restoreAll = function () {
                    for(var i = 0; i < akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES; i++) {
                        this.restoreResourceFamily(i);
                    }
                };
                ResourcePoolManager.prototype.disableAll = function () {
                    for(var i = 0; i < akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES; i++) {
                        this.disableResourceFamily(i);
                    }
                };
                ResourcePoolManager.prototype.clean = function () {
                    for(var i = 0; i < akra.EResourceFamilies.TOTAL_RESOURCE_FAMILIES; i++) {
                        this.cleanResourceFamily(i);
                    }
                };
                ResourcePoolManager.prototype.createDeviceResources = function () {
                    return true;
                };
                ResourcePoolManager.prototype.destroyDeviceResources = function () {
                    this.disableDeviceResources();
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 327);
                        akra.logger.log("Destroying Video Device Resources\n");
                    }
                    ;
                    this.destroyResourceFamily(akra.EResourceFamilies.VIDEO_RESOURCE);
                    return true;
                };
                ResourcePoolManager.prototype.restoreDeviceResources = function () {
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 335);
                        akra.logger.log("Restoring Video Device Resources\n");
                    }
                    ;
                    this.restoreResourceFamily(akra.EResourceFamilies.VIDEO_RESOURCE);
                    return true;
                };
                ResourcePoolManager.prototype.disableDeviceResources = function () {
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 341);
                        akra.logger.log("Disabling Video Device Resources\n");
                    }
                    ;
                    this.disableResourceFamily(akra.EResourceFamilies.VIDEO_RESOURCE);
                    return true;
                };
                ResourcePoolManager.prototype.getEngine = function () {
                    return this.pEngine;
                };
                ResourcePoolManager.prototype.createRenderMethod = function (sResourceName) {
                    return this.renderMethodPool.createResource(sResourceName);
                };
                ResourcePoolManager.prototype.createTexture = function (sResourceName) {
                    return this.texturePool.createResource(sResourceName);
                };
                ResourcePoolManager.prototype.createEffect = function (sResourceName) {
                    return this.effectPool.createResource(sResourceName);
                };
                ResourcePoolManager.prototype.createSurfaceMaterial = function (sResourceName) {
                    return this.surfaceMaterialPool.createResource(sResourceName);
                };
                ResourcePoolManager.prototype.createVertexBuffer = function (sResourceName) {
                    return this.vertexBufferPool.createResource(sResourceName);
                };
                ResourcePoolManager.prototype.createVideoBuffer = function (sResourceName) {
                    return this.videoBufferPool.createResource(sResourceName);
                };
                ResourcePoolManager.prototype.createIndexBuffer = function (sResourceName) {
                    return this.indexBufferPool.createResource(sResourceName);
                };
                ResourcePoolManager.prototype.createShaderProgram = function (sResourceName) {
                    return this.shaderProgramPool.createResource(sResourceName);
                };
                ResourcePoolManager.prototype.createModel = function (sResourceName) {
                    return this.colladaPool.createResource(sResourceName);
                };
                ResourcePoolManager.prototype.createImg = function (sResourceName) {
                    return this.imagePool.createResource(sResourceName);
                };
                ResourcePoolManager.prototype.loadModel = function (sFilename, pOptions) {
                    if (typeof pOptions === "undefined") { pOptions = null; }
                    if (akra.util.pathinfo(sFilename).ext.toLowerCase() === "dae") {
                        var pCollada = this.colladaPool.findResource(sFilename);
                        if (((pCollada) === null)) {
                            pCollada = this.colladaPool.createResource(sFilename);
                        }
                        if (!pCollada.isResourceLoaded()) {
                            pCollada.loadResource(sFilename, pOptions);
                        }
                        return pCollada;
                    }
                    return null;
                };
                ResourcePoolManager.prototype.loadImage = function (sFilename) {
                    var pImg = this.imagePool.findResource(sFilename);
                    if (((pImg) === null)) {
                        pImg = this.imagePool.createResource(sFilename);
                        if (!pImg.isResourceLoaded()) {
                            pImg.loadResource(sFilename);
                        }
                    }
                    return pImg;
                };
                ResourcePoolManager.prototype.createDeviceResource = function () {
                    this.pSurfaceMaterialPool = new pool.ResourcePool(this, pool.resources.SurfaceMaterial);
                    this.pSurfaceMaterialPool.initialize(16);
                    this.pEffectPool = new pool.ResourcePool(this, pool.resources.Effect);
                    this.pEffectPool.initialize(16);
                    this.pRenderMethodPool = new pool.ResourcePool(this, pool.resources.RenderMethod);
                    this.pRenderMethodPool.initialize(16);
                    this.pColladaPool = new pool.ResourcePool(this, pool.resources.Collada);
                    this.pColladaPool.initialize(0);
                    this.pImagePool = new pool.ResourcePool(this, pool.resources.Img);
                    this.pImagePool.initialize(16);
                    this.pTexturePool = new pool.ResourcePool(this, akra.webgl.WebGLInternalTexture);
                    this.pTexturePool.initialize(16);
                    this.pIndexBufferPool = new pool.ResourcePool(this, akra.webgl.WebGLIndexBuffer);
                    this.pIndexBufferPool.initialize(16);
                    this.pVertexBufferPool = new pool.ResourcePool(this, akra.webgl.WebGLVertexBuffer);
                    this.pVertexBufferPool.initialize(16);
                    this.pVideoBufferPool = new pool.ResourcePool(this, akra.webgl.WebGLVertexTexture);
                    this.pVideoBufferPool.initialize(16);
                    this.pTextureBufferPool = new pool.ResourcePool(this, akra.webgl.WebGLTextureBuffer);
                    this.pTextureBufferPool.initialize(16);
                    this.pShaderProgramPool = new pool.ResourcePool(this, akra.webgl.WebGLShaderProgram);
                    this.pShaderProgramPool.initialize(16);
                    this.pRenderBufferPool = new pool.ResourcePool(this, akra.webgl.WebGLInternalRenderBuffer);
                    this.pRenderBufferPool.initialize(16);
                    this.pDepthBufferPool = new pool.ResourcePool(this, akra.webgl.WebGLDepthBuffer);
                    this.pDepthBufferPool.initialize(16);
                    this.pEffectDataPool = new pool.ResourcePool(this, pool.resources.EffectData);
                    this.pEffectDataPool.initialize(8);
                    this.pComponentPool = new pool.ResourcePool(this, pool.resources.Component);
                    this.pComponentPool.initialize(16);
                };
                ResourcePoolManager.prototype.registerDeviceResources = function () {
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 475);
                        akra.logger.log("Registering Video Device Resources\n");
                    }
                    ;
                    this.pTexturePool.registerResourcePool(new pool.ResourceCode(akra.EResourceFamilies.VIDEO_RESOURCE, akra.EVideoResources.TEXTURE_RESOURCE));
                    this.pVertexBufferPool.registerResourcePool(new pool.ResourceCode(akra.EResourceFamilies.VIDEO_RESOURCE, akra.EVideoResources.VERTEXBUFFER_RESOURCE));
                    this.pIndexBufferPool.registerResourcePool(new pool.ResourceCode(akra.EResourceFamilies.VIDEO_RESOURCE, akra.EVideoResources.INDEXBUFFER_RESOURCE));
                    this.pEffectPool.registerResourcePool(new pool.ResourceCode(akra.EResourceFamilies.VIDEO_RESOURCE, akra.EVideoResources.EFFECT_RESOURCE));
                    this.pRenderMethodPool.registerResourcePool(new pool.ResourceCode(akra.EResourceFamilies.VIDEO_RESOURCE, akra.EVideoResources.RENDERMETHOD_RESOURCE));
                    this.pColladaPool.registerResourcePool(new pool.ResourceCode(akra.EResourceFamilies.VIDEO_RESOURCE, akra.EVideoResources.MODEL_RESOURCE));
                    this.pImagePool.registerResourcePool(new pool.ResourceCode(akra.EResourceFamilies.VIDEO_RESOURCE, akra.EVideoResources.IMAGE_RESOURCE));
                    this.pSurfaceMaterialPool.registerResourcePool(new pool.ResourceCode(akra.EResourceFamilies.VIDEO_RESOURCE, akra.EVideoResources.SURFACEMATERIAL_RESOURCE));
                    this.pVideoBufferPool.registerResourcePool(new pool.ResourceCode(akra.EResourceFamilies.VIDEO_RESOURCE, akra.EVideoResources.VIDEOBUFFER_RESOURCE));
                    this.pShaderProgramPool.registerResourcePool(new pool.ResourceCode(akra.EResourceFamilies.VIDEO_RESOURCE, akra.EVideoResources.SHADERPROGRAM_RESOURCE));
                    this.pComponentPool.registerResourcePool(new pool.ResourceCode(akra.EResourceFamilies.VIDEO_RESOURCE, akra.EVideoResources.COMPONENT_RESOURCE));
                    this.pEffectDataPool.registerResourcePool(new pool.ResourceCode(akra.EResourceFamilies.VIDEO_RESOURCE, akra.EVideoResources.EFFECTDATA_RESOURCE));
                };
                ResourcePoolManager.prototype.unregisterDeviceResources = function () {
 {
                        akra.logger.setSourceLocation("pool/ResourcePoolManager.ts", 527);
                        akra.logger.log("Unregistering Video Device Resources");
                    }
                    ;
                    this.pTexturePool.unregisterResourcePool();
                    this.pVertexBufferPool.unregisterResourcePool();
                    this.pIndexBufferPool.unregisterResourcePool();
                    this.pEffectPool.unregisterResourcePool();
                    this.pRenderMethodPool.unregisterResourcePool();
                    this.pColladaPool.unregisterResourcePool();
                    this.pImagePool.unregisterResourcePool();
                    this.pSurfaceMaterialPool.unregisterResourcePool();
                    this.pVideoBufferPool.unregisterResourcePool();
                    this.pShaderProgramPool.unregisterResourcePool();
                    this.pComponentPool.unregisterResourcePool();
                };
                ResourcePoolManager.pTypedResourseTotal = [
                    akra.EVideoResources.TOTAL_VIDEO_RESOURCES, 
                    akra.EAudioResources.TOTAL_AUDIO_RESOURCES, 
                    akra.EGameResources.TOTAL_GAME_RESOURCES
                ];
                return ResourcePoolManager;
            })();
            pool.ResourcePoolManager = ResourcePoolManager;            
        })(core.pool || (core.pool = {}));
        var pool = core.pool;
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        (function (objects) {
            var ModelEntry = (function (_super) {
                __extends(ModelEntry, _super);
                function ModelEntry(pScene, pModel) {
                                _super.call(this, pScene, akra.EEntityTypes.MODEL_ENTRY);
                    this._pModelResource = null;
                    this._pController = null;
                    this._pModelResource = pModel;
                }
                Object.defineProperty(ModelEntry.prototype, "resource", {
                    get: function () {
                        return this._pModelResource;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ModelEntry.prototype, "controller", {
                    get: function () {
                        return this._pController;
                    },
                    set: function (pController) {
                        this._pController = pController;
                    },
                    enumerable: true,
                    configurable: true
                });
                return ModelEntry;
            })(scene.SceneNode);
            objects.ModelEntry = ModelEntry;            
            function isModelEntry(pEntity) {
                return !((pEntity) === null) && pEntity.type === akra.EEntityTypes.MODEL_ENTRY;
            }
            objects.isModelEntry = isModelEntry;
        })(scene.objects || (scene.objects = {}));
        var objects = scene.objects;
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        var DisplayList = (function () {
            function DisplayList() {
                this._pScene = null;
                this._sName = "";
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
            }
            Object.defineProperty(DisplayList.prototype, "name", {
                get: function () {
                    return this._sName;
                },
                set: function (sName) {
                    this._sName = sName;
                },
                enumerable: true,
                configurable: true
            });
            DisplayList.prototype._onNodeAttachment = function (pScene, pNode) {
                this.attachObject(pNode);
            };
            DisplayList.prototype._onNodeDetachment = function (pScene, pNode) {
                this.detachObject(pNode);
            };
            DisplayList.prototype.attachObject = function (pNode) {
 {
                    akra.logger.setSourceLocation("DisplayList.ts", 29);
                    akra.logger.error("pure virtual method DisplayList::attachObject()");
                }
                ;
            };
            DisplayList.prototype.detachObject = function (pNode) {
 {
                    akra.logger.setSourceLocation("DisplayList.ts", 33);
                    akra.logger.error("pure virtual method DisplayList::detachObject()");
                }
                ;
            };
            DisplayList.prototype._setup = function (pScene) {
                if (((this._pScene) != null)) {
 {
                        akra.logger.setSourceLocation("DisplayList.ts", 38);
                        akra.logger.criticalError("list movement from scene to another scene temprary unsupported!");
                    }
                    ;
                }
                this._pScene = pScene;
                this.connect(pScene, "nodeAttachment", "_onNodeAttachment");
                this.connect(pScene, "nodeDetachment", "_onNodeDetachment");
                var me = this;
                pScene.getRootNode().explore(function (pEntity) {
                    me._onNodeAttachment(pScene, pEntity);
                });
            };
            DisplayList.prototype._findObjects = function (pCamera, pResultArray, bQuickSearch) {
                if (typeof bQuickSearch === "undefined") { bQuickSearch = false; }
 {
                    akra.logger.setSourceLocation("DisplayList.ts", 54);
                    akra.logger.error("pure virtual method");
                }
                ;
                return null;
            };
            DisplayList.prototype.getGuid = function () {
                return this._iGuid;
            };
            DisplayList._pEventTable = new akra.events.EventTable();
            DisplayList.prototype.getEventTable = function () {
                return DisplayList._pEventTable;
            };
            DisplayList.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            DisplayList.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            DisplayList.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            DisplayList.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            DisplayList.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            return DisplayList;
        })();
        scene.DisplayList = DisplayList;        
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        ;
        var ObjectList = (function () {
            function ObjectList(pData) {
                this._pHead = null;
                this._pTail = null;
                this._pCurrent = null;
                this._iLength = 0;
                this._bLock = false;
                if (arguments.length) {
                    this.fromArray(pData);
                }
            }
            Object.defineProperty(ObjectList.prototype, "length", {
                get: function () {
                    return this._iLength;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ObjectList.prototype, "first", {
                get: function () {
                    this._pCurrent = this._pHead;
                    return (((this._pCurrent) != null)) ? this._pCurrent.data : null;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ObjectList.prototype, "last", {
                get: function () {
                    this._pCurrent = this._pTail;
                    return (((this._pCurrent) != null)) ? this._pCurrent.data : null;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ObjectList.prototype, "current", {
                get: function () {
                    return (((this._pCurrent) != null)) ? this._pCurrent.data : null;
                },
                enumerable: true,
                configurable: true
            });
            ObjectList.prototype.lock = function () {
                this._bLock = true;
            };
            ObjectList.prototype.unlock = function () {
                this._bLock = false;
            };
            ObjectList.prototype.isLocked = function () {
                return this._bLock;
            };
            ObjectList.prototype.value = function (n) {
                return this.find(n).data;
            };
            ObjectList.prototype.indexOf = function (pData, iFrom) {
                if (typeof iFrom === "undefined") { iFrom = 0.; }
                var pItem = this.find(iFrom);
                for(var i = iFrom; i < this._iLength; i++) {
                    if (pItem.data === pData) {
                        return i;
                    }
                    pItem = pItem.next;
                }
                return -1;
            };
            ObjectList.prototype.mid = function (iPos, iSize) {
                if (typeof iPos === "undefined") { iPos = 0; }
                if (typeof iSize === "undefined") { iSize = this._iLength; }
                iSize = Math.min(this._iLength - iPos, iSize);
                if (iPos > this._iLength - 1) {
                    return null;
                }
                var pNewList = new ObjectList();
                var pItem = this.find(iPos);
                for(var i = 0; i < iSize; ++i) {
                    pNewList.push(pItem.data);
                    pItem = pItem.next;
                }
                ;
                return pNewList;
            };
            ObjectList.prototype.slice = function (iStart, iEnd) {
                if (typeof iStart === "undefined") { iStart = 0; }
                if (typeof iEnd === "undefined") { iEnd = Math.max(this._iLength - iStart, 0); }
                return this.mid(iStart, iEnd - iStart);
            };
            ObjectList.prototype.move = function (iFrom, iTo) {
                return this.insert(iTo - 1, this.takeAt(iFrom));
            };
            ObjectList.prototype.replace = function (iPos, pData) {
 {
                    util.logger.setSourceLocation("util/ObjectList.ts", 102);
                    util.logger.assert(!this.isLocked(), "list locked.");
                }
                ;
                this.find(iPos).data = pData;
                return this;
            };
            ObjectList.prototype.erase = function (begin, end) {
                if (arguments.length < 2) {
                    this.takeAt(arguments[0]);
                } else {
                    end = Math.min(end, this._iLength);
                    for(var i = begin; i < end; i++) {
                        this.takeAt(i);
                    }
                }
                return this;
            };
            ObjectList.prototype.contains = function (pData) {
                return (this.indexOf(pData) >= 0);
            };
            ObjectList.prototype.removeAt = function (n) {
                this.takeAt(n);
            };
            ObjectList.prototype.removeOne = function (pData) {
                this.removeAt(this.indexOf(pData));
            };
            ObjectList.prototype.removeAll = function (pData) {
                var i;
                var n = this.length;
                while((i = this.indexOf(pData)) >= 0) {
                    this.removeAt(i);
                    i--;
                }
                return n;
            };
            ObjectList.prototype.swap = function (i, j) {
 {
                    util.logger.setSourceLocation("util/ObjectList.ts", 147);
                    util.logger.assert(!this.isLocked(), "list locked.");
                }
                ;
                i = Math.min(i, this._iLength - 1);
                j = Math.min(j, this._iLength - 1);
                if (i != j) {
                    var pItem1 = this.find(i);
                    var pItem2 = this.find(j);
                    var pTmp = pItem1.data;
                    pItem1.data = pItem2.data;
                    pItem2.data = pTmp;
                }
                return this;
            };
            ObjectList.prototype.add = function (pList) {
                pList.seek(0);
                if (pList.length > 1) {
                    this.push(pList.first());
                }
                for(var i = 1; i < pList.length; i++) {
                    this.push(pList.next());
                }
                return this;
            };
            ObjectList.prototype.seek = function (n) {
                if (typeof n === "undefined") { n = 0; }
                var pElement;
                n = Math.min(n, this._iLength - 1);
                if (n > this._iLength / 2) {
                    pElement = this._pTail;
                    for(var m = this._iLength - 1 - n; m > 0; --m) {
                        pElement = pElement.prev;
                    }
                } else {
                    pElement = this._pHead;
                    for(var i = 0; i < n; ++i) {
                        pElement = pElement.next;
                    }
                }
                this._pCurrent = pElement;
                return this;
            };
            ObjectList.prototype.next = function () {
                return (((this._pCurrent) != null) && ((this._pCurrent.next) != null)) ? (this._pCurrent = this._pCurrent.next).data : null;
            };
            ObjectList.prototype.prev = function () {
                return (((this._pCurrent) != null) && ((this._pCurrent.prev) != null)) ? (this._pCurrent = this._pCurrent.prev).data : null;
            };
            ObjectList.prototype.push = function (pElement) {
                return this.insert(this._iLength, pElement);
            };
            ObjectList.prototype.takeAt = function (n) {
 {
                    util.logger.setSourceLocation("util/ObjectList.ts", 217);
                    util.logger.assert(!this.isLocked(), "list locked.");
                }
                ;
                if (n < 0) {
                    return null;
                }
                return this.pullElement(this.find(n));
            };
            ObjectList.prototype.pullElement = function (pItem) {
                if (((pItem) === null)) {
                    return null;
                }
                if (((pItem.prev) === null)) {
                    this._pHead = pItem.next;
                } else {
                    pItem.prev.next = pItem.next;
                }
                if (((pItem.next) === null)) {
                    this._pTail = pItem.prev;
                } else {
                    pItem.next.prev = pItem.prev;
                }
                this._iLength--;
                if (((pItem.next) === null)) {
                    this._pCurrent = this._pTail;
                } else {
                    this._pCurrent = pItem.next;
                }
                return this.releaseItem(pItem);
            };
            ObjectList.prototype.takeFirst = function () {
                return this.takeAt(0);
            };
            ObjectList.prototype.takeLast = function () {
                return this.takeAt(this._iLength - 1);
            };
            ObjectList.prototype.takeCurrent = function (isPrev) {
                if (typeof isPrev === "undefined") { isPrev = false; }
                return this.pullElement(this._pCurrent);
            };
            ObjectList.prototype.pop = function () {
                return this.takeAt(this._iLength - 1);
            };
            ObjectList.prototype.prepend = function (pElement) {
                return this.insert(0, pElement);
            };
            ObjectList.prototype.find = function (n) {
                if (n < this._iLength) {
                    this.seek(n);
                    return this._pCurrent;
                }
                return null;
            };
            ObjectList.prototype.releaseItem = function (pItem) {
                var pData = pItem.data;
                pItem.next = null;
                pItem.prev = null;
                pItem.data = null;
                ObjectList.listItemPool.push(pItem);
                return pData;
            };
            ObjectList.prototype.createItem = function () {
                if (ObjectList.listItemPool.length == 0) {
                    return {
                        next: null,
                        prev: null,
                        data: null
                    };
                }
                return ObjectList.listItemPool.pop();
            };
            ObjectList.prototype.fromArray = function (elements, iOffset, iSize) {
                if (typeof iOffset === "undefined") { iOffset = 0; }
                if (typeof iSize === "undefined") { iSize = elements.length; }
                iOffset = Math.min(iOffset, this._iLength);
                for(var i = 0; i < iSize; i++) {
                    this.insert(iOffset + i, elements[i]);
                }
                return this;
            };
            ObjectList.prototype.insert = function (n, pData) {
 {
                    util.logger.setSourceLocation("util/ObjectList.ts", 321);
                    util.logger.assert(!this.isLocked(), "list locked.");
                }
                ;
                var pNew = this.createItem();
                var pItem;
                n = Math.min(n, this._iLength);
                pNew.data = pData;
                if (n == 0) {
                    if (((this._pHead) === null)) {
                        this._pTail = pNew;
                    }
                    pNew.next = this._pHead;
                    this._pHead = pNew;
                } else {
                    pItem = this.find(n - 1);
                    if (pItem == null) {
                        this._pHead = pNew;
                    } else {
                        if (pItem.next == null) {
                            this._pTail = pNew;
                        } else {
                            pNew.next = pItem.next;
                            pItem.next.prev = pNew;
                        }
                        pItem.next = pNew;
                        pNew.prev = pItem;
                    }
                }
                this._iLength++;
                this._pCurrent = pNew;
                return this;
            };
            ObjectList.prototype.isEqual = function (pList) {
                if (this._iLength == pList.length) {
                    if (this === pList) {
                        return true;
                    }
                    var l1 = this.first;
                    var l2 = pList.first;
                    for(var i = 0; i < this._iLength; ++i) {
                        if (l1 != l2) {
                            return false;
                        }
                        l1 = this.next();
                        l2 = pList.next();
                    }
                    return true;
                }
                return false;
            };
            ObjectList.prototype.clear = function () {
 {
                    util.logger.setSourceLocation("util/ObjectList.ts", 390);
                    util.logger.assert(!this.isLocked(), "list locked.");
                }
                ;
                var pPrev;
                var pNext;
                this._pCurrent = this._pHead;
                for(var i = 0; i < this._iLength; ++i) {
                    pPrev = this._pCurrent;
                    pNext = this._pCurrent = this._pCurrent.next;
                    this.releaseItem(pPrev);
                }
                this._pHead = this._pCurrent = this._pTail = null;
                this._iLength = 0;
                return this;
            };
            ObjectList.prototype.forEach = function (fn) {
                var pItem = this._pHead;
                var n = 0;
                do {
                    if (fn(pItem.data, n++) === false) {
                        return;
                    }
                } while((pItem = pItem.next));
            };
            ObjectList.listItemPool = new util.ObjectArray();
            return ObjectList;
        })();
        util.ObjectList = ObjectList;        
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    akra.ObjectList = akra.util.ObjectList;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        var OcTreeNode = (function () {
            function OcTreeNode(pTree) {
                this.level = 0;
                this.index = 0;
                this.rearNodeLink = null;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this.membersList = new akra.util.ObjectList();
                this.worldBounds = new akra.geometry.Rect3d();
                this.childrenList = new Array(8);
                for(var i = 0; i < 8; i++) {
                    this.childrenList[i] = new akra.util.ObjectList();
                }
                this.tree = pTree;
            }
            OcTreeNode.prototype.addMember = function (pObject) {
                this.membersList.push(pObject);
                this.connect(pObject, "worldBoundsUpdated", "OcTreeObjectMoved", akra.EEventTypes.UNICAST);
            };
            OcTreeNode.prototype.removeMember = function (pObject) {
                var i = this.membersList.indexOf(pObject);
 {
                    akra.logger.setSourceLocation("OcTreeNode.ts", 69);
                    akra.logger.assert(i >= 0, "error removing member cannot find member");
                }
                ;
                if (i >= 0) {
                    this.membersList.takeAt(i);
                    this.disconnect(pObject, "worldBoundsUpdated", "OcTreeObjectMoved", akra.EEventTypes.UNICAST);
                }
                if (this.membersList.length === 0) {
                    this.tree.deleteNodeFromTree(this);
                }
            };
            OcTreeNode.prototype.getGuid = function () {
                return this._iGuid;
            };
            OcTreeNode._pEventTable = new akra.events.EventTable();
            OcTreeNode.prototype.getEventTable = function () {
                return OcTreeNode._pEventTable;
            };
            OcTreeNode.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            OcTreeNode.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            OcTreeNode.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            OcTreeNode.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            OcTreeNode.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            OcTreeNode.prototype.OcTreeObjectMoved = function (pObject) {
                var pNode = this.tree.findTreeNode(pObject);
                if (pNode !== this) {
                    this.removeMember(pObject);
                    pNode.addMember(pObject);
                }
            };
            return OcTreeNode;
        })();
        scene.OcTreeNode = OcTreeNode;        
        ;
        var OcTreeRootNode = (function (_super) {
            __extends(OcTreeRootNode, _super);
            function OcTreeRootNode(pTree) {
                        _super.call(this, pTree);
                var iTmp = (1 << this.tree.depth);
                this._pBasicWorldBounds = new akra.geometry.Rect3d(0, iTmp, 0, iTmp, 0, iTmp);
                this._pBasicWorldBounds.divSelf(this.tree.worldScale);
                this._pBasicWorldBounds.subSelf(this.tree.worldOffset);
                this.worldBounds.set(this._pBasicWorldBounds);
            }
            OcTreeRootNode.prototype.addMember = function (pMember) {
                _super.prototype.addMember.call(this, pMember);
                this._updateNodeBoundingBox();
            };
            OcTreeRootNode.prototype.removeMember = function (pObject) {
                var i = this.membersList.indexOf(pObject);
 {
                    akra.logger.setSourceLocation("OcTreeNode.ts", 120);
                    akra.logger.assert(i >= 0, "error removing member cannot find member");
                }
                ;
                if (i >= 0) {
                    this.membersList.takeAt(i);
                    this.disconnect(pObject, "worldBoundsUpdated", "OcTreeObjectMoved", akra.EEventTypes.UNICAST);
                }
                this._updateNodeBoundingBox();
            };
            OcTreeRootNode.prototype._updateNodeBoundingBox = function () {
                var pNodeWorldBounds = this.worldBounds;
                pNodeWorldBounds.set(this._pBasicWorldBounds);
                var pObject = this.membersList.first;
                while(((pObject) != null)) {
                    pNodeWorldBounds.unionRect(pObject.worldBounds);
                    pObject = this.membersList.next();
                }
            };
            return OcTreeRootNode;
        })(OcTreeNode);
        scene.OcTreeRootNode = OcTreeRootNode;        
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (geometry) {
        var Ray2d = (function () {
            function Ray2d() {
                this.point = new akra.Vec2();
                this.normal = new akra.Vec2();
            }
            return Ray2d;
        })();
        geometry.Ray2d = Ray2d;        
        ;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (geometry) {
        var Ray3d = (function () {
            function Ray3d() {
                this.point = new akra.Vec3();
                this.normal = new akra.Vec3();
            }
            return Ray3d;
        })();
        geometry.Ray3d = Ray3d;        
        ;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (geometry) {
        function intersectPlane2dRay2d(pPlane, pRay) {
            var fDistance = pPlane.signedDistance(pRay.point);
            var fNdotV = pPlane.normal.dot(pRay.normal);
            if (fDistance == 0.) {
                return true;
            } else {
                if (fNdotV == 0.) {
                    return false;
                } else {
                    if (fDistance / fNdotV < 0.) {
                        return true;
                    } else {
                        return false;
                    }
                }
            }
        }
        geometry.intersectPlane2dRay2d = intersectPlane2dRay2d;
        ;
        function intersectPlane3dRay3d(pPlane, pRay) {
            var fDistance = pPlane.signedDistance(pRay.point);
            var fNdotV = pPlane.normal.dot(pRay.normal);
            if (fDistance == 0.) {
                return true;
            } else {
                if (fNdotV == 0.) {
                    return false;
                } else {
                    if (fDistance / fNdotV < 0.) {
                        return true;
                    } else {
                        return false;
                    }
                }
            }
        }
        geometry.intersectPlane3dRay3d = intersectPlane3dRay3d;
        ;
        function intersectCircleRay2d(pCircle, pRay) {
            var v2fCenterToPoint = pRay.point.subtract(pCircle.center, akra.vec2());
            var v2fNormal = pRay.normal;
            var fA = v2fNormal.lengthSquare();
            var fB = v2fCenterToPoint.dot(v2fNormal);
            var fC = v2fCenterToPoint.lengthSquare() - pCircle.radius * pCircle.radius;
            var fDiscriminant = fB * fB - fA * fC;
            if (fDiscriminant < 0.) {
                return false;
            }
            var fSqrtDiscriminant = akra.math.sqrt(fDiscriminant);
            var fT1 = (-fB + fSqrtDiscriminant) / fA;
            if (fT1 < 0.) {
                return false;
            } else {
                return true;
            }
        }
        geometry.intersectCircleRay2d = intersectCircleRay2d;
        ;
        function intersectSphereRay3d(pSphere, pRay) {
            var v3fCenterToPoint = pRay.point.subtract(pSphere.center, akra.vec3());
            var v3fNormal = pRay.normal;
            var fA = v3fNormal.lengthSquare();
            var fB = v3fCenterToPoint.dot(v3fNormal);
            var fC = v3fCenterToPoint.lengthSquare() - pSphere.radius * pSphere.radius;
            var fDiscriminant = fB * fB - fA * fC;
            if (fDiscriminant < 0.) {
                return false;
            }
            var fSqrtDiscriminant = akra.math.sqrt(fDiscriminant);
            var fT1 = (-fB + fSqrtDiscriminant) / fA;
            if (fT1 < 0.) {
                return false;
            } else {
                return true;
            }
        }
        geometry.intersectSphereRay3d = intersectSphereRay3d;
        ;
        function intersectRect2dRay2d(pRect, pRay) {
            var v2fNormal = pRay.normal;
            var v2fPoint = pRay.point;
            var fT1, fT2;
            var fX1, fX2;
            var fY1, fY2;
            if (v2fNormal.x != 0.) {
                fT1 = (pRect.x0 - v2fPoint.x) / v2fNormal.x;
                fT2 = (pRect.x1 - v2fPoint.x) / v2fNormal.x;
            } else {
                fT1 = (pRect.y0 - v2fPoint.y) / v2fNormal.y;
                fT2 = (pRect.y1 - v2fPoint.y) / v2fNormal.y;
            }
            if (fT1 < 0 && fT2 < 0) {
                return false;
            }
            fT1 = akra.math.max(fT1, 0.);
            fT2 = akra.math.max(fT2, 0.);
            fX1 = v2fPoint.x + fT1 * v2fNormal.x;
            fX2 = v2fPoint.x + fT2 * v2fNormal.x;
            fY1 = v2fPoint.y + fT1 * v2fNormal.y;
            fY2 = v2fPoint.y + fT2 * v2fNormal.y;
            if ((fX1 < pRect.x0 && fX2 < pRect.x0) || (fX1 > pRect.x1 && fX2 > pRect.x1) || (fY1 < pRect.y0 && fY2 < pRect.y0) || (fY1 > pRect.y1 && fY2 > pRect.y1)) {
                return false;
            }
            return true;
        }
        geometry.intersectRect2dRay2d = intersectRect2dRay2d;
        ;
        function intersectRect3dRay3d(pRect, pRay) {
            var v3fNormal = pRay.normal;
            var v3fPoint = pRay.point;
            var fT1, fT2;
            var fX1, fX2;
            var fY1, fY2;
            var fZ1, fZ2;
            if (v3fNormal.x != 0.) {
                fT1 = (pRect.x0 - v3fPoint.x) / v3fNormal.x;
                fT2 = (pRect.x1 - v3fPoint.x) / v3fNormal.x;
            } else if (v3fNormal.y != 0.) {
                fT1 = (pRect.y0 - v3fPoint.y) / v3fNormal.y;
                fT2 = (pRect.y1 - v3fPoint.y) / v3fNormal.y;
            } else {
                fT1 = (pRect.z0 - v3fPoint.z) / v3fNormal.z;
                fT2 = (pRect.z1 - v3fPoint.z) / v3fNormal.z;
            }
            if (fT1 < 0 && fT2 < 0) {
                return false;
            }
            fT1 = akra.math.max(fT1, 0.);
            fT2 = akra.math.max(fT2, 0.);
            fX1 = v3fPoint.x + fT1 * v3fNormal.x;
            fX2 = v3fPoint.x + fT2 * v3fNormal.x;
            fY1 = v3fPoint.y + fT1 * v3fNormal.y;
            fY2 = v3fPoint.y + fT2 * v3fNormal.y;
            fZ1 = v3fPoint.z + fT1 * v3fNormal.z;
            fZ2 = v3fPoint.z + fT2 * v3fNormal.z;
            if ((fX1 < pRect.x0 && fX2 < pRect.x0) || (fX1 > pRect.x1 && fX2 > pRect.x1) || (fY1 < pRect.y0 && fY2 < pRect.y0) || (fY1 > pRect.y1 && fY2 > pRect.y1) || (fZ1 < pRect.z0 && fZ2 < pRect.z0) || (fZ1 > pRect.z1 && fZ2 > pRect.z1)) {
                return false;
            }
            return true;
        }
        geometry.intersectRect3dRay3d = intersectRect3dRay3d;
        ;
        function intersectCircleCircle(pCircle1, pCircle2) {
            var v2fCenter1 = pCircle1.center;
            var v2fCenter2 = pCircle2.center;
            var fX = v2fCenter2.x - v2fCenter1.x;
            var fY = v2fCenter2.y - v2fCenter1.y;
            var fContactRadius = pCircle1.radius + pCircle2.radius;
            if ((fX * fX + fY * fY) > fContactRadius * fContactRadius) {
                return false;
            }
            return true;
        }
        geometry.intersectCircleCircle = intersectCircleCircle;
        ;
        function intersectSphereSphere(pSphere1, pSphere2) {
            var v3fCenter1 = pSphere1.center;
            var v3fCenter2 = pSphere2.center;
            var fX = v3fCenter2.x - v3fCenter1.x;
            var fY = v3fCenter2.y - v3fCenter1.y;
            var fZ = v3fCenter2.z - v3fCenter1.z;
            var fContactRadius = pSphere1.radius + pSphere2.radius;
            if ((fX * fX + fY * fY + fZ * fZ) > fContactRadius * fContactRadius) {
                return false;
            }
            return true;
        }
        geometry.intersectSphereSphere = intersectSphereSphere;
        ;
        function intersectRect2dCircle(pRect, pCircle) {
            var v2fCenter = pCircle.center;
            var fOffsetX = 0., fOffsetY = 0.;
            var nInside = 0;
            if (v2fCenter.x < pRect.x0) {
                fOffsetX = pRect.x0 - v2fCenter.x;
            } else if (v2fCenter.x > pRect.x1) {
                fOffsetX = v2fCenter.x - pRect.x1;
            } else {
                nInside++;
            }
            if (v2fCenter.y < pRect.y0) {
                fOffsetY = pRect.y0 - v2fCenter.y;
            } else if (v2fCenter.y > pRect.y1) {
                fOffsetY = v2fCenter.y - pRect.y1;
            } else {
                nInside++;
            }
            if (nInside === 2) {
                return true;
            }
            var fOffsetLengthSquare = fOffsetX * fOffsetX + fOffsetY * fOffsetY;
            var fRadius = pCircle.radius;
            if (fOffsetLengthSquare > fRadius * fRadius) {
                return false;
            }
            return true;
        }
        geometry.intersectRect2dCircle = intersectRect2dCircle;
        ;
        function intersectRect3dSphere(pRect, pSphere) {
            var v3fCenter = pSphere.center;
            var fOffsetX = 0., fOffsetY = 0., fOffsetZ = 0.;
            var nInside = 0;
            if (v3fCenter.x < pRect.x0) {
                fOffsetX = pRect.x0 - v3fCenter.x;
            } else if (v3fCenter.x > pRect.x1) {
                fOffsetX = v3fCenter.x - pRect.x1;
            } else {
                nInside++;
            }
            if (v3fCenter.y < pRect.y0) {
                fOffsetY = pRect.y0 - v3fCenter.y;
            } else if (v3fCenter.y > pRect.y1) {
                fOffsetY = v3fCenter.y - pRect.y1;
            } else {
                nInside++;
            }
            if (v3fCenter.z < pRect.z0) {
                fOffsetZ = pRect.z0 - v3fCenter.z;
            } else if (v3fCenter.z > pRect.z1) {
                fOffsetZ = v3fCenter.z - pRect.z1;
            } else {
                nInside++;
            }
            if (nInside === 3) {
                return true;
            }
            var fOffsetLengthSquare = fOffsetX * fOffsetX + fOffsetY * fOffsetY + fOffsetZ * fOffsetZ;
            var fRadius = pSphere.radius;
            if (fOffsetLengthSquare > fRadius * fRadius) {
                return false;
            }
            return true;
        }
        geometry.intersectRect3dSphere = intersectRect3dSphere;
        ;
        function intersectRect2dRect2d(pRect1, pRect2, pResult) {
            if (!((pResult) !== undefined)) {
                var fX0 = akra.math.max(pRect1.x0, pRect2.x0);
                var fX1 = akra.math.min(pRect1.x1, pRect2.x1);
                if (fX0 <= fX1) {
                    var fY0 = akra.math.max(pRect1.y0, pRect2.y0);
                    var fY1 = akra.math.min(pRect1.y1, pRect2.y1);
                    if (fY0 <= fY1) {
                        return true;
                    }
                }
                return false;
            } else {
                pResult.x0 = akra.math.max(pRect1.x0, pRect2.x0);
                pResult.x1 = akra.math.min(pRect1.x1, pRect2.x1);
                pResult.y0 = akra.math.max(pRect1.y0, pRect2.y0);
                pResult.y1 = akra.math.min(pRect1.y1, pRect2.y1);
                return pResult.isValid();
            }
        }
        geometry.intersectRect2dRect2d = intersectRect2dRect2d;
        ;
        function intersectRect3dRect3d(pRect1, pRect2, pResult) {
            if (!((pResult) !== undefined)) {
                var fX0 = akra.math.max(pRect1.x0, pRect2.x0);
                var fX1 = akra.math.min(pRect1.x1, pRect2.x1);
                if (fX0 <= fX1) {
                    var fY0 = akra.math.max(pRect1.y0, pRect2.y0);
                    var fY1 = akra.math.min(pRect1.y1, pRect2.y1);
                    if (fY0 <= fY1) {
                        var fZ0 = akra.math.max(pRect1.z0, pRect2.z0);
                        var fZ1 = akra.math.min(pRect1.z1, pRect2.z1);
                        if (fZ0 <= fZ1) {
                            return true;
                        }
                    }
                }
                return false;
            } else {
                pResult.x0 = akra.math.max(pRect1.x0, pRect2.x0);
                pResult.x1 = akra.math.min(pRect1.x1, pRect2.x1);
                pResult.y0 = akra.math.max(pRect1.y0, pRect2.y0);
                pResult.y1 = akra.math.min(pRect1.y1, pRect2.y1);
                pResult.z0 = akra.math.max(pRect1.z0, pRect2.z0);
                pResult.z1 = akra.math.min(pRect1.z1, pRect2.z1);
                return pResult.isValid();
            }
        }
        geometry.intersectRect3dRect3d = intersectRect3dRect3d;
        ;
                                                                                                        function intersect(pRect1, pRect2, pResult) {
            var nArgumentsLength = arguments.length;
            if (nArgumentsLength === 3) {
                if (arguments[2] instanceof geometry.Rect2d) {
                    return intersectRect2dRect2d(arguments[0], arguments[1], arguments[2]);
                } else {
                    return intersectRect3dRect3d(arguments[0], arguments[1], arguments[2]);
                }
            } else {
                var pArg0 = arguments[0];
                var pArg1 = arguments[1];
                if (pArg1 instanceof geometry.Ray2d) {
                    if (pArg0 instanceof geometry.Plane2d) {
                        return intersectPlane2dRay2d(pArg0, pArg1);
                    } else if (pArg0 instanceof geometry.Circle) {
                        return intersectCircleRay2d(pArg0, pArg1);
                    } else {
                        return intersectRect2dRay2d(pArg0, pArg1);
                    }
                } else if (pArg1 instanceof geometry.Ray3d) {
                    if (pArg0 instanceof geometry.Plane3d) {
                        return intersectPlane3dRay3d(pArg0, pArg1);
                    } else if (pArg0 instanceof geometry.Sphere) {
                        return intersectSphereRay3d(pArg0, pArg1);
                    } else {
                        return intersectRect3dRay3d(pArg0, pArg1);
                    }
                } else if (pArg1 instanceof geometry.Circle) {
                    if (pArg0 instanceof geometry.Circle) {
                        return intersectCircleCircle(pArg0, pArg1);
                    } else {
                        return intersectRect2dCircle(pArg0, pArg1);
                    }
                } else if (pArg1 instanceof geometry.Sphere) {
                    if (pArg0 instanceof geometry.Sphere) {
                        return intersectSphereSphere(pArg0, pArg1);
                    } else {
                        return intersectRect3dSphere(pArg0, pArg1);
                    }
                } else {
                    if (pArg0 instanceof geometry.Rect2d) {
                        return intersectRect2dRect2d(pArg0, pArg1);
                    } else {
                        return intersectRect3dRect3d(pArg0, pArg1);
                    }
                }
            }
        }
        geometry.intersect = intersect;
        ;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
;
var akra;
(function (akra) {
    (function (scene) {
        (function (EOcTreeConstants) {
            EOcTreeConstants._map = [];
            EOcTreeConstants.k_MinimumTreeDepth = 0;
            EOcTreeConstants.k_MaximumTreeDepth = 10;
        })(scene.EOcTreeConstants || (scene.EOcTreeConstants = {}));
        var EOcTreeConstants = scene.EOcTreeConstants;
        ;
        var OcTree = (function (_super) {
            __extends(OcTree, _super);
            function OcTree() {
                        _super.call(this);
                this._pHead = null;
                this._v3fWorldExtents = new akra.Vec3();
                this._v3fWorldScale = new akra.Vec3();
                this._v3fWorldOffset = new akra.Vec3();
                this._iDepth = 0;
                this._pFreeNodePool = null;
                this.name = "OcTree";
            }
            Object.defineProperty(OcTree.prototype, "depth", {
                get: function () {
                    return this._iDepth;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(OcTree.prototype, "worldScale", {
                get: function () {
                    return this._v3fWorldScale;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(OcTree.prototype, "worldOffset", {
                get: function () {
                    return this._v3fWorldOffset;
                },
                enumerable: true,
                configurable: true
            });
            OcTree.prototype.create = function (pWorldBoundingBox, iDepth, nNodes) {
                if (typeof nNodes === "undefined") { nNodes = 64; }
                var v3fTemp = akra.vec3();
                var i = 0;
 {
                    akra.logger.setSourceLocation("OcTree.ts", 72);
                    akra.logger.assert(!this.isReady(), "the Oc tree has already been created");
                }
                ;
 {
                    akra.logger.setSourceLocation("OcTree.ts", 74);
                    akra.logger.assert(iDepth >= EOcTreeConstants.k_MinimumTreeDepth && iDepth <= EOcTreeConstants.k_MaximumTreeDepth, "invalid tree depth");
                }
                ;
                this._iDepth = iDepth;
                this._v3fWorldExtents.set(pWorldBoundingBox.size(v3fTemp));
                this._v3fWorldOffset.set(pWorldBoundingBox.minPoint(v3fTemp).negate());
                var iSize = 1 << iDepth;
                this._v3fWorldScale.x = iSize / this._v3fWorldExtents.x;
                this._v3fWorldScale.y = iSize / this._v3fWorldExtents.y;
                this._v3fWorldScale.z = iSize / this._v3fWorldExtents.z;
                this._pHead = new scene.OcTreeRootNode(this);
                this._pHead.level = 0;
                this._pFreeNodePool = new Array();
                for(i = 0; i < nNodes; ++i) {
                    this._pFreeNodePool.push(new scene.OcTreeNode(this));
                }
            };
            OcTree.prototype.isReady = function () {
                if (this._iDepth > 0) {
                    return true;
                } else {
                    return false;
                }
            };
            OcTree.prototype.findTreeNode = function (pObject) {
                var pRect = pObject.worldBounds;
                var iX0 = pRect.x0, iX1 = pRect.x1, iY0 = pRect.y0, iY1 = pRect.y1, iZ0 = pRect.z0, iZ1 = pRect.z1;
                var v3fWorldOffset = this._v3fWorldOffset;
                var v3fWorldScale = this._v3fWorldScale;
                iX0 += v3fWorldOffset.x;
                iX1 += v3fWorldOffset.x;
                iY0 += v3fWorldOffset.y;
                iY1 += v3fWorldOffset.y;
                iZ0 += v3fWorldOffset.z;
                iZ1 += v3fWorldOffset.z;
                iX0 *= v3fWorldScale.x;
                iX1 *= v3fWorldScale.x;
                iY0 *= v3fWorldScale.y;
                iY1 *= v3fWorldScale.y;
                iZ0 *= v3fWorldScale.z;
                iZ1 *= v3fWorldScale.z;
                iX0 = akra.math.floor(iX0);
                iX1 = akra.math.ceil(iX1);
                iY0 = akra.math.floor(iY0);
                iY1 = akra.math.ceil(iY1);
                iZ0 = akra.math.floor(iZ0);
                iZ1 = akra.math.ceil(iZ1);
                iX1 = (iX1 === iX0) ? iX0 + 1 : iX1;
                iY1 = (iY1 === iY0) ? iY0 + 1 : iY1;
                iZ1 = (iZ1 === iZ0) ? iZ0 + 1 : iZ1;
                var pNode = this.findTreeNodeByRect(iX0, iX1, iY0, iY1, iZ0, iZ1);
                return pNode;
            };
            OcTree.prototype.findTreeNodeByRect = function (iX0, iX1, iY0, iY1, iZ0, iZ1) {
                var nMax = (1 << this._iDepth);
                if (iX0 < 0 || iX1 > nMax || iY0 < 0 || iY1 > nMax || iZ0 < 0 || iZ1 > nMax) {
                    return this._pHead;
                }
                var iDepth = this._iDepth;
                var iLevel;
                iLevel = this._findNodeLevel(iX0, iX1, iY0, iY1, iZ0, iZ1);
                if (iLevel == 0) {
                    return this._pHead;
                }
                var iComposedIndex;
                var iShift = iDepth - iLevel;
                iComposedIndex = (iX0 >> (iDepth - iLevel)) << (2 * iDepth + iShift);
                iComposedIndex += (iY0 >> (iDepth - iLevel)) << (iDepth + iShift);
                iComposedIndex += (iZ0 >> (iDepth - iLevel)) << (iShift);
                var iWay;
                var pParentNode, pNode;
                pParentNode = this._pHead;
                pNode = null;
                var iTmpX, iTmpY, iTmpZ;
                var iX, iY, iZ;
                var i = 0;
                while(i < iLevel) {
                    iTmpX = iX0;
                    iTmpY = iY0;
                    iTmpZ = iZ0;
                    iX = (iTmpX >> (iDepth - i - 1)) & 1;
                    iY = (iTmpY >> (iDepth - i - 1)) & 1;
                    iZ = (iTmpZ >> (iDepth - i - 1)) & 1;
                    iWay = 4 * iX + 2 * iY + iZ;
                    var pNodeList = pParentNode.childrenList[iWay];
                    if (pNodeList.length === 0) {
                        pNode = this.getAndSetFreeNode(iLevel, iComposedIndex, pParentNode);
                        pNodeList.push(pNode);
                        return pNode;
                    }
                    var iPosition = 0;
                    var pTestNode = pNodeList.first;
                    var iTestMask = (iDepth >= i + 2) ? 1 << (iDepth - i - 2) : 0;
                    var iMask = (iTestMask << (2 * iDepth)) + (iTestMask << iDepth) + iTestMask;
                    var pParentNodeOld = pParentNode;
                    while(((pTestNode) != null)) {
                        var iTest = pTestNode.index & iComposedIndex;
                        var iResult1 = pTestNode.index & iMask;
                        var iResult2 = iComposedIndex & iMask;
                        if (iResult1 === iResult2) {
                            if (pTestNode.level === iLevel) {
                                return pTestNode;
                            } else if (pTestNode.level < iLevel) {
                                pParentNode = pTestNode;
                                i = pTestNode.level;
                                break;
                            } else {
                                if (pNode === null) {
                                    pNode = this.getAndSetFreeNode(iLevel, iComposedIndex, pParentNode);
                                    pParentNode.childrenList[iWay].push(pNode);
                                    i = iLevel;
                                }
                                var iTestIndex = pTestNode.index;
                                var iShift = iDepth - i - 1;
                                iX = (iTestIndex >> (2 * iDepth + iShift)) & 1;
                                iY = (iTestIndex >> (iDepth + iShift)) & 1;
                                iZ = (iTestIndex >> iShift) & 1;
                                var iTestWay = 4 * iX + 2 * iY + iZ;
                                pNodeList.takeAt(iPosition);
                                pNodeList.seek(iPosition - 1);
                                iPosition--;
                                pNode.childrenList[iTestWay].push(pTestNode);
                                pTestNode.rearNodeLink = pNode;
                            }
                        }
                        pTestNode = pNodeList.next();
                        iPosition++;
                    }
                    if (pNode === null && pParentNodeOld === pParentNode) {
                        pNode = this.getAndSetFreeNode(iLevel, iComposedIndex, pParentNode);
                        pParentNode.childrenList[iWay].push(pNode);
                        break;
                    }
                }
                return pNode;
            };
            OcTree.prototype._findNodeLevel = function (iX0, iX1, iY0, iY1, iZ0, iZ1) {
                var iLengthX = iX1 - iX0;
                var iLengthY = iY1 - iY0;
                var iLengthZ = iZ1 - iZ0;
                var iLength = akra.math.max(iLengthX, akra.math.max(iLengthY, iLengthZ));
                var iLevel = this._iDepth - akra.math.floor(akra.math.log(iLength) / akra.math.LN2);
                while(iLevel > 0) {
                    var iPitch = 1 << (this._iDepth - iLevel);
                    var iTest1, iTest2;
                    var i;
                    for(i = 0; i < 3; i++) {
                        iTest1 = akra.math.floor(arguments[2 * i] / iPitch);
                        iTest2 = akra.math.floor(arguments[2 * i + 1] / iPitch);
                        if (iTest1 != iTest2) {
                            if ((iTest1 + 1) == iTest2) {
                                if ((arguments[2 * i + 1] % iPitch) != 0) {
                                    break;
                                }
                            } else {
                                break;
                            }
                        }
                    }
                    if (i != 3) {
                        iLevel--;
                    } else {
                        break;
                    }
                }
                return iLevel;
            };
            OcTree.prototype.getAndSetFreeNode = function (iLevel, iComposedIndex, pParentNode) {
                var pNode = this._pFreeNodePool.pop();
                if (!((pNode) != null)) {
                    pNode = new scene.OcTreeNode(this);
                }
                var iDepth = this._iDepth;
                var iMask = (1 << this._iDepth) - 1;
                var iIndexX = (iComposedIndex >> (2 * iDepth)) & iMask;
                var iIndexY = (iComposedIndex >> (iDepth)) & iMask;
                var iIndexZ = iComposedIndex & iMask;
                var iSize = 1 << (this._iDepth - iLevel);
                pNode.level = iLevel;
                pNode.index = iComposedIndex;
                pNode.rearNodeLink = pParentNode;
                pNode.worldBounds.set(iIndexX, iIndexX + iSize, iIndexY, iIndexY + iSize, iIndexZ, iIndexZ + iSize);
                pNode.worldBounds.divSelf(this._v3fWorldScale);
                pNode.worldBounds.subSelf(this._v3fWorldOffset);
                return pNode;
            };
            OcTree.prototype.deleteNodeFromTree = function (pNode) {
                var pParentNode = pNode.rearNodeLink;
 {
                    akra.logger.setSourceLocation("OcTree.ts", 413);
                    akra.logger.assert(pNode.membersList.length == 0, "list members of node don't empty");
                }
                ;
                var iDepth = this._iDepth;
                var iParentLevel = pParentNode.level;
                var iIndex = pNode.index;
                var iShift = iDepth - iParentLevel - 1;
                var iX = (iIndex >> (2 * iDepth + iShift)) & 1;
                var iY = (iIndex >> (iDepth + iShift)) & 1;
                var iZ = (iIndex >> iShift) & 1;
                var iWay = 4 * iX + 2 * iY + iZ;
                var pParentBranch = pParentNode.childrenList[iWay];
                var iNode = pParentBranch.indexOf(pNode);
 {
                    akra.logger.setSourceLocation("OcTree.ts", 432);
                    akra.logger.assert(iNode != -1, "can't remove node from parent, node not found");
                }
                ;
                pParentBranch.takeAt(iNode);
                for(var i = 0; i < 8; i++) {
                    var pChildrens = pNode.childrenList[i];
                    while(pChildrens.length) {
                        var pChildNode = pChildrens.pop();
                        pChildNode.rearNodeLink = pParentNode;
                        pParentBranch.push(pChildNode);
                    }
                }
                pNode.level = 0;
                pNode.rearNodeLink = null;
                pNode.worldBounds.clear();
                this._pFreeNodePool.push(pNode);
            };
            OcTree.prototype._findObjects = function (pCamera, pResultArray, bFastSearch) {
                if (typeof pResultArray === "undefined") { pResultArray = new akra.util.ObjectArray(); }
                if (typeof bFastSearch === "undefined") { bFastSearch = false; }
                pResultArray.clear();
                if (!((pCamera.frustum) !== undefined)) {
                    this._buildSearchResultsByRect(pCamera.searchRect, this._pHead, pResultArray);
                } else {
                    this._buildSearchResultsByRectAndFrustum(pCamera.searchRect, pCamera.frustum, this._pHead, pResultArray);
                }
                return pResultArray;
            };
            OcTree.prototype._buildSearchResultsByRect = function (pSearchRect, pNode, pResultList) {
                var pNodeRect = pNode.worldBounds;
                var kResult = akra.geometry.classifyRect3d(pSearchRect, pNodeRect);
                if (kResult == akra.EVolumeClassifications.B_CONTAINS_A || kResult == akra.EVolumeClassifications.INTERSECTING) {
                    var pMemberList = pNode.membersList;
                    var pObject = pMemberList.first;
                    while(((pObject) != null)) {
                        if (akra.geometry.intersectRect3dRect3d(pSearchRect, pObject.worldBounds)) {
                            pResultList.push(pObject);
                        }
                        pObject = pMemberList.next();
                    }
                    for(var i = 0; i < 8; i++) {
                        var pChildrenList = pNode.childrenList[i];
                        var pChildNode = pChildrenList.first;
                        while(((pChildNode) != null)) {
                            this._buildSearchResultsByRect(pSearchRect, pChildNode, pResultList);
                            pChildNode = pChildrenList.next();
                        }
                    }
                } else if (kResult != akra.EVolumeClassifications.NO_RELATION) {
                    this._includeAllTreeSubbranch(pNode, pResultList);
                }
            };
            OcTree.prototype._buildSearchResultsByRectAndFrustum = function (pSearchRect, pFrustum, pNode, pResultList) {
                var pNodeRect = pNode.worldBounds;
                if (akra.geometry.intersectRect3dRect3d(pSearchRect, pNodeRect)) {
                    var kTestResult = akra.geometry.classifyFrustumRect3d(pFrustum, pNodeRect);
                    if (kTestResult == akra.EVolumeClassifications.A_CONTAINS_B) {
                        this._includeAllTreeSubbranch(pNode, pResultList);
                    } else if (kTestResult == akra.EVolumeClassifications.INTERSECTING) {
                        var pMemberList = pNode.membersList;
                        var pObject = pMemberList.first;
                        while(((pObject) != null)) {
                            if (pFrustum.testRect(pObject.worldBounds)) {
                                pResultList.push(pObject);
                            }
                            pObject = pMemberList.next();
                        }
                        for(var i = 0; i < 8; i++) {
                            var pChildrenList = pNode.childrenList[i];
                            var pChildNode = pChildrenList.first;
                            while(((pChildNode) != null)) {
                                this._buildSearchResultsByRectAndFrustum(pSearchRect, pFrustum, pChildNode, pResultList);
                                pChildNode = pChildrenList.next();
                            }
                        }
                    }
                }
            };
            OcTree.prototype._includeAllTreeSubbranch = function (pNode, pResultList) {
                var pMemberList = pNode.membersList;
                var pObject = pMemberList.first;
                while(((pObject) != null)) {
                    pResultList.push(pObject);
                    pObject = pMemberList.next();
                }
                for(var i = 0; i < 8; i++) {
                    var pChildrenList = pNode.childrenList[i];
                    var pChildNode = pChildrenList.first;
                    while(((pChildNode) != null)) {
                        this._includeAllTreeSubbranch(pChildNode, pResultList);
                        pChildNode = pChildrenList.next();
                    }
                }
            };
            OcTree.prototype.attachObject = function (pNode) {
                if (scene.isSceneObject(pNode)) {
                    var pOcTreeNode = this.findTreeNode(pNode);
                    pOcTreeNode.addMember(pNode);
                }
            };
            OcTree.prototype.detachObject = function (pNode) {
                if (scene.isSceneObject(pNode)) {
                    var pOcTreeNode = this.findTreeNode(pNode);
                    pOcTreeNode.removeMember(pNode);
                }
            };
            OcTree.prototype._toSimpleObject = function (pNode) {
                if (typeof pNode === "undefined") { pNode = this._pHead; }
                var pResult = {};
                pResult.members = [];
                pResult.childrens = new Array(8);
                for(var i = 0; i < 8; i++) {
                    pResult.childrens[i] = [];
                }
                pResult.level = pNode.level;
                pResult.index = pNode.index;
                pResult.worldBounds = pNode.worldBounds;
                var pMemberList = pNode.membersList;
                var pObject = pMemberList.first;
                while(((pObject) != null)) {
                    pResult.members.push(pObject.worldBounds);
                    pObject = pMemberList.next();
                }
                for(var i = 0; i < 8; i++) {
                    var pList = pNode.childrenList[i];
                    var pChildNode = pList.first;
                    while(((pChildNode) != null)) {
                        pResult.childrens[i].push(this._toSimpleObject(pChildNode));
                        pChildNode = pList.next();
                    }
                }
                return pResult;
            };
            return OcTree;
        })(scene.DisplayList);
        scene.OcTree = OcTree;        
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
;
var akra;
(function (akra) {
    (function (scene) {
        (function (light) {
            var LightParameters = (function () {
                function LightParameters() {
                    this.ambient = new akra.Color();
                    this.diffuse = new akra.Color();
                    this.specular = new akra.Color();
                    this.attenuation = new akra.Vec3();
                }
                return LightParameters;
            })();
            light.LightParameters = LightParameters;            
            var LightPoint = (function (_super) {
                __extends(LightPoint, _super);
                function LightPoint(pScene, eType) {
                    if (typeof eType === "undefined") { eType = akra.ELightTypes.UNKNOWN; }
                                _super.call(this, pScene, akra.EEntityTypes.LIGHT);
                    this._isShadowCaster = false;
                    this._isEnabled = true;
                    this._iMaxShadowResolution = 256;
                    this._pLightParameters = new LightParameters();
                    this._eLightType = eType;
                }
                Object.defineProperty(LightPoint.prototype, "lightType", {
                    get: function () {
                        return this._eLightType;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(LightPoint.prototype, "enabled", {
                    get: function () {
                        return this._isEnabled;
                    },
                    set: function (bValue) {
                        this._isEnabled = bValue;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(LightPoint.prototype, "params", {
                    get: function () {
                        return this._pLightParameters;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(LightPoint.prototype, "isShadowCaster", {
                    get: function () {
                        return this._isShadowCaster;
                    },
                    set: function (bValue) {
                        this._isShadowCaster = bValue;
                    },
                    enumerable: true,
                    configurable: true
                });
                LightPoint.prototype.create = function (isShadowCaster, iMaxShadowResolution) {
                    if (typeof isShadowCaster === "undefined") { isShadowCaster = true; }
                    if (typeof iMaxShadowResolution === "undefined") { iMaxShadowResolution = 256; }
                    var isOk = _super.prototype.create.call(this);
                    this._isShadowCaster = isShadowCaster;
                    this._iMaxShadowResolution = iMaxShadowResolution;
                    return isOk;
                };
                LightPoint.prototype._prepareForLighting = function (pCamera) {
 {
                        akra.logger.setSourceLocation("light/LightPoint.ts", 66);
                        akra.logger.warning("pure virtual method");
                    }
                    ;
                    return false;
                };
                LightPoint.prototype._calculateShadows = function () {
 {
                        akra.logger.setSourceLocation("light/LightPoint.ts", 71);
                        akra.logger.criticalError("NOT IMPLEMENTED!");
                    }
                    ;
                };
                return LightPoint;
            })(scene.SceneNode);
            light.LightPoint = LightPoint;            
            function isLightPoint(pNode) {
                return pNode.type === akra.EEntityTypes.LIGHT;
            }
            light.isLightPoint = isLightPoint;
        })(scene.light || (scene.light = {}));
        var light = scene.light;
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        var LightGraph = (function (_super) {
            __extends(LightGraph, _super);
            function LightGraph() {
                        _super.call(this);
                this._pLightPoints = new akra.util.ObjectList();
                this.name = "LightGraph";
            }
            LightGraph.prototype._findObjects = function (pCamera, pResultArray, bFastSearch) {
                if (typeof pResultArray === "undefined") { pResultArray = new akra.util.ObjectArray(); }
                if (typeof bFastSearch === "undefined") { bFastSearch = false; }
                pResultArray.clear();
                var pList = this._pLightPoints;
                var pLightPoint = pList.first;
                while(((pLightPoint) != null)) {
                    if (pLightPoint._prepareForLighting(pCamera)) {
                        pResultArray.push(pLightPoint);
                    }
                    pLightPoint = pList.next();
                }
                return pResultArray;
            };
            LightGraph.prototype.attachObject = function (pNode) {
                if (scene.light.isLightPoint(pNode)) {
                    this._pLightPoints.push(pNode);
                }
            };
            LightGraph.prototype.detachObject = function (pNode) {
                if (scene.light.isLightPoint(pNode)) {
                    var iPosition = this._pLightPoints.indexOf(pNode);
                    if (iPosition != -1) {
                        this._pLightPoints.takeAt(iPosition);
                    } else {
 {
                            akra.logger.setSourceLocation("LightGraph.ts", 58);
                            akra.logger.assert(false, "cannot find light point");
                        }
                        ;
                    }
                }
            };
            return LightGraph;
        })(scene.DisplayList);
        scene.LightGraph = LightGraph;        
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (model) {
        var Skin = (function () {
            function Skin(pMesh) {
                this._pSkeleton = null;
                this._pNodeNames = null;
                this._m4fBindMatrix = new akra.Mat4(1);
                this._pBoneTransformMatrices = null;
                this._pBoneOffsetMatrixBuffer = null;
                this._pBoneOffsetMatrices = null;
                this._pAffectingNodes = null;
                this._pInfMetaData = null;
                this._pInfData = null;
                this._pBoneTransformMatrixData = null;
                this._pWeights = null;
                this._pTiedData = [];
 {
                    akra.logger.setSourceLocation("Skin.ts", 101);
                    akra.logger.assert(((pMesh) != null), "you must specify mesh for skin");
                }
                ;
                this._pMesh = pMesh;
            }
            Object.defineProperty(Skin.prototype, "data", {
                get: function () {
                    return this._pMesh.data;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Skin.prototype, "skeleton", {
                get: function () {
                    return this._pSkeleton;
                },
                set: function (pSkeleton) {
                    if (((pSkeleton) === null) || pSkeleton.totalBones < this.totalBones) {
 {
                            akra.logger.setSourceLocation("Skin.ts", 83);
                            akra.logger.warning("cannnot set skeletonm because skeleton has to little bones");
                        }
                        ;
                        return;
                    }
                    for(var i = 0, nMatrices = this.totalBones; i < nMatrices; i++) {
                        this._pAffectingNodes[i] = pSkeleton.findJoint(this._pNodeNames[i]);
 {
                            akra.logger.setSourceLocation("Skin.ts", 89);
                            akra.logger.assert(((this._pAffectingNodes[i]) != null), "joint<" + this._pNodeNames[i] + "> must exists...");
                        }
                        ;
                    }
                    this._pSkeleton = pSkeleton;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Skin.prototype, "totalBones", {
                get: function () {
                    return this._pNodeNames.length;
                },
                enumerable: true,
                configurable: true
            });
            Skin.prototype.setBindMatrix = function (m4fMatrix) {
                this._m4fBindMatrix.set(m4fMatrix);
            };
            Skin.prototype.getBindMatrix = function () {
                return this._m4fBindMatrix;
            };
            Skin.prototype.getBoneOffsetMatrices = function () {
                return this._pBoneOffsetMatrices;
            };
            Skin.prototype.getBoneOffsetMatrix = function (sBoneName) {
                var pBoneNames = this._pNodeNames;
                for(var i = 0; i < pBoneNames.length; i++) {
                    if (pBoneNames[i] === sBoneName) {
                        return this._pBoneOffsetMatrices[i];
                    }
                }
                ;
                return null;
            };
            Skin.prototype.setSkeleton = function (pSkeleton) {
                if (!pSkeleton || pSkeleton.totalBones < this.totalBones) {
 {
                        akra.logger.setSourceLocation("Skin.ts", 133);
                        akra.logger.warning("number of bones in skeleton (" + pSkeleton.totalBones + ") less then number of bones in skin (" + this.totalBones + ").");
                    }
                    ;
                    return false;
                }
                for(var i = 0, nMatrices = this.totalBones; i < nMatrices; i++) {
                    this._pAffectingNodes[i] = pSkeleton.findJoint(this._pNodeNames[i]);
 {
                        akra.logger.setSourceLocation("Skin.ts", 139);
                        akra.logger.assert(!((this._pAffectingNodes[i]) === null), "joint<" + this._pNodeNames[i] + "> must exists...");
                    }
                    ;
                }
                this._pSkeleton = pSkeleton;
                return true;
            };
            Skin.prototype.attachToScene = function (pRootNode) {
                for(var i = 0, nMatrices = this.totalBones; i < nMatrices; i++) {
                    this._pAffectingNodes[i] = pRootNode.findEntity(this._pNodeNames[i]);
 {
                        akra.logger.setSourceLocation("Skin.ts", 150);
                        akra.logger.assert(((this._pAffectingNodes[i]) != null), "node<" + this._pNodeNames[i] + "> must exists...");
                    }
                    ;
                }
                return true;
            };
            Skin.prototype.setBoneNames = function (pNames) {
                if (((pNames) === null)) {
                    return false;
                }
                this._pNodeNames = pNames;
                this._pAffectingNodes = new Array(pNames.length);
                return true;
            };
            Skin.prototype.setBoneOffsetMatrices = function (pMatrices) {
                var pMatrixNames = this._pNodeNames;
 {
                    akra.logger.setSourceLocation("Skin.ts", 173);
                    akra.logger.assert(((pMatrices) != null) && ((pMatrixNames) != null) && pMatrixNames.length === pMatrices.length, "number of matrix names must equal matrices data length:\n" + pMatrixNames.length + " / " + pMatrices.length);
                }
                ;
                var nMatrices = pMatrixNames.length;
                var pData = this.data;
                var pMatrixData = new Float32Array(nMatrices * 16);
                this._pBoneOffsetMatrices = pMatrices;
                this._pBoneTransformMatrixData = pData._allocateData([
                    akra.VE_MAT4("BONE_MATRIX")
                ], pMatrixData);
                this._pBoneTransformMatrices = new Array(nMatrices);
                for(var i = 0; i < nMatrices; i++) {
                    this._pBoneTransformMatrices[i] = new akra.Mat4(pMatrixData.subarray(i * 16, (i + 1) * 16), true);
                }
                this._pBoneOffsetMatrixBuffer = pMatrixData;
            };
            Skin.prototype.setWeights = function (pWeights) {
                this._pWeights = pWeights;
                return true;
            };
            Skin.prototype.getInfluenceMetaData = function () {
                return this._pInfMetaData;
            };
            Skin.prototype.getInfluences = function () {
                return this._pInfData;
            };
            Skin.prototype.setInfluences = function (pInfluencesCount, pInfluences) {
 {
                    akra.logger.setSourceLocation("Skin.ts", 206);
                    akra.logger.assert(this._pInfMetaData == null && this._pInfData == null, "vertex weights already setuped.");
                }
                ;
 {
                    akra.logger.setSourceLocation("Skin.ts", 207);
                    akra.logger.assert(!((this._pWeights) === null), "you must set weight data before setup influences");
                }
                ;
                var pData = this.data;
                var pInfluencesMeta = new Float32Array(pInfluencesCount.length * 2);
                var pWeights = this._pWeights;
                var iInfLoc = 0;
                var iTransformLoc = 0;
                pInfluences = new Float32Array(pInfluences);
                iTransformLoc = this._pBoneTransformMatrixData.byteOffset / akra.EDataTypeSizes.BYTES_PER_FLOAT;
                for(var i = 0, n = pInfluences.length; i < n; i += 2) {
                    pInfluences[i] = pInfluences[i] * 16 + iTransformLoc;
                    pInfluences[i + 1] = pWeights[pInfluences[i + 1]];
                }
                this._pInfData = pData._allocateData([
                    akra.VE_FLOAT('BONE_INF_DATA'), 
                    akra.VE_FLOAT('BONE_WEIGHT')
                ], pInfluences);
                iInfLoc = this._pInfData.byteOffset / akra.EDataTypeSizes.BYTES_PER_FLOAT;
                for(var i = 0, j = 0, n = iInfLoc; i < pInfluencesMeta.length; i += 2) {
                    var iCount = pInfluencesCount[j++];
                    pInfluencesMeta[i] = iCount;
                    pInfluencesMeta[i + 1] = n;
                    n += 2 * iCount;
                }
                this._pInfMetaData = pData._allocateData([
                    akra.VE_FLOAT('BONE_INF_COUNT'), 
                    akra.VE_FLOAT('BONE_INF_LOC'), 
                    
                ], pInfluencesMeta);
                return this._pInfMetaData !== null && this._pInfData !== null;
            };
            Skin.prototype.setVertexWeights = function (pInfluencesCount, pInfluences, pWeights) {
 {
                    akra.logger.setSourceLocation("Skin.ts", 257);
                    akra.logger.assert(arguments.length > 1, 'you must specify all parameters');
                }
                ;
                if (pWeights) {
                    this.setWeights(pWeights);
                }
                return this.setInfluences(pInfluencesCount, pInfluences);
            };
            Skin.prototype.applyBoneMatrices = function (bForce) {
                if (typeof bForce === "undefined") { bForce = false; }
                var pData;
                var bResult;
                var pNode;
                var isUpdated = false;
                for(var i = 0, nMatrices = this.totalBones; i < nMatrices; ++i) {
                    pNode = this._pAffectingNodes[i];
                    if (pNode.isWorldMatrixNew() || bForce) {
                        pNode.worldMatrix.multiply(this._pBoneOffsetMatrices[i], this._pBoneTransformMatrices[i]);
                        isUpdated = true;
                    }
                }
                if (isUpdated) {
                    pData = this._pBoneOffsetMatrixBuffer;
                    return this._pBoneTransformMatrixData.setData(pData, 0, pData.byteLength);
                }
                return false;
            };
            Skin.prototype.isReady = function () {
                return !(((this._pInfMetaData) === null) || ((this._pInfData) === null) || ((this._pWeights) === null) || ((this._pBoneOffsetMatrixBuffer) === null) || ((this._pBoneOffsetMatrices) === null) || ((this._pNodeNames) === null) || ((this._m4fBindMatrix) === null));
            };
            Skin.prototype.getBoneTransforms = function () {
                return this._pBoneTransformMatrixData;
            };
            Skin.prototype.isAffect = function (pData) {
                if (((pData) != null)) {
                    for(var i = 0; i < this._pTiedData.length; i++) {
                        if (this._pTiedData[i] === pData) {
                            return true;
                        }
                    }
                }
                return false;
            };
            Skin.prototype.attach = function (pData) {
 {
                    akra.logger.setSourceLocation("Skin.ts", 315);
                    akra.logger.assert(pData.stride === 16, "you cannot add skin to mesh with POSITION: {x, y, z}" + "\nyou need POSITION: {x, y, z, w}");
                }
                ;
                pData.getVertexDeclaration().append(akra.VE_FLOAT(akra.DeclUsages.BLENDMETA, 12));
                this._pTiedData.push(pData);
            };
            return Skin;
        })();
        model.Skin = Skin;        
        function createSkin(pMesh) {
            return new Skin(pMesh);
        }
        model.createSkin = createSkin;
    })(akra.model || (akra.model = {}));
    var model = akra.model;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (geometry) {
        var Segment2d = (function () {
            function Segment2d() {
                this.ray = new geometry.Ray2d();
                this.distance = 0.;
            }
            Object.defineProperty(Segment2d.prototype, "point", {
                get: function () {
                    return this.ray.point;
                },
                set: function (v2fPoint) {
                    this.ray.point.set(v2fPoint);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Segment2d.prototype, "normal", {
                get: function () {
                    return this.ray.normal;
                },
                set: function (v2fNormal) {
                    this.ray.normal.set(v2fNormal);
                },
                enumerable: true,
                configurable: true
            });
            return Segment2d;
        })();
        geometry.Segment2d = Segment2d;        
        ;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (geometry) {
        var Segment3d = (function () {
            function Segment3d() {
                this.ray = new geometry.Ray3d();
                this.distance = 0.;
            }
            Object.defineProperty(Segment3d.prototype, "point", {
                get: function () {
                    return this.ray.point;
                },
                set: function (v3fPoint) {
                    this.ray.point.set(v3fPoint);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Segment3d.prototype, "normal", {
                get: function () {
                    return this.ray.normal;
                },
                set: function (v3fNormal) {
                    this.ray.normal.set(v3fNormal);
                },
                enumerable: true,
                configurable: true
            });
            return Segment3d;
        })();
        geometry.Segment3d = Segment3d;        
        ;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (geometry) {
                                                                function computeBoundingBox(pVertexData, pBoundingBox) {
            var fX0 = 0, fY0 = 0, fZ0 = 0, fX1 = 0, fY1 = 0, fZ1 = 0;
            var fTemp, pTempData;
            var i = 0;
            var pVertexDeclaration, pVertexElement, pData;
            var nStride, nCount;
            pVertexDeclaration = pVertexData.getVertexDeclaration();
            if (((pVertexDeclaration) === null)) {
                return false;
            }
            pVertexElement = pVertexDeclaration.findElement(akra.DeclUsages.POSITION, 3);
            if (((pVertexElement) === null)) {
                return false;
            }
            nCount = pVertexData.length;
            nStride = pVertexElement.size;
            pData = pVertexData.getData(pVertexElement.offset, pVertexElement.size);
            if (((pData) === null)) {
                return false;
            }
            pTempData = new Float32Array(pData, 0, 3);
            fX0 = fX1 = pTempData[0];
            fY0 = fY1 = pTempData[1];
            fZ0 = fZ1 = pTempData[2];
            for(i = nStride; i < nStride * nCount; i += nStride) {
                pTempData = new Float32Array(pData, i, 3);
                fTemp = pTempData[0];
                fX0 = fX0 > fTemp ? fTemp : fX0;
                fX1 = fX1 > fTemp ? fX1 : fTemp;
                fTemp = pTempData[1];
                fY0 = fY0 > fTemp ? fTemp : fY0;
                fY1 = fY1 > fTemp ? fY1 : fTemp;
                fTemp = pTempData[2];
                fZ0 = fZ0 > fTemp ? fTemp : fZ0;
                fZ1 = fZ1 > fTemp ? fZ1 : fTemp;
            }
            pBoundingBox.set(fX0, fX1, fY0, fY1, fZ0, fZ1);
            return true;
        }
        geometry.computeBoundingBox = computeBoundingBox;
        ;
        function computeDataForCascadeBoundingBox(pBoundingBox, ppVertexes, ppIndexes, fMinSize) {
            if (typeof fMinSize === "undefined") { fMinSize = .25; }
            var pInd;
            var pPoints;
            var i, j, k;
            pPoints = new Array(8);
            for(i = 0; i < 8; i++) {
                pPoints[i] = new Array(4);
                for(j = 0; j < 4; j++) {
                    pPoints[i][j] = new akra.Vec3(0);
                }
            }
            pPoints[0][0].set([
                pBoundingBox.x0, 
                pBoundingBox.y0, 
                pBoundingBox.z0
            ]);
            pPoints[1][0].set([
                pBoundingBox.x0, 
                pBoundingBox.y1, 
                pBoundingBox.z0
            ]);
            pPoints[2][0].set([
                pBoundingBox.x0, 
                pBoundingBox.y0, 
                pBoundingBox.z1
            ]);
            pPoints[3][0].set([
                pBoundingBox.x0, 
                pBoundingBox.y1, 
                pBoundingBox.z1
            ]);
            pPoints[4][0].set([
                pBoundingBox.x1, 
                pBoundingBox.y0, 
                pBoundingBox.z0
            ]);
            pPoints[5][0].set([
                pBoundingBox.x1, 
                pBoundingBox.y1, 
                pBoundingBox.z0
            ]);
            pPoints[6][0].set([
                pBoundingBox.x1, 
                pBoundingBox.y0, 
                pBoundingBox.z1
            ]);
            pPoints[7][0].set([
                pBoundingBox.x1, 
                pBoundingBox.y1, 
                pBoundingBox.z1
            ]);
            var fTempFunc = function (pPoints, iPoint, iToPoint1, iToPoint2, iToPoint3) {
                for(var i = 0; i < 3; i++) {
                    pPoints[arguments[i + 2]][0].subtract(pPoints[iPoint][0], pPoints[iPoint][i + 1]);
                    if (pPoints[iPoint][i + 1].length() > fMinSize) {
                        pPoints[iPoint][i + 1].scale(0.1);
                    }
                    pPoints[iPoint][i + 1].add(pPoints[iPoint][0]);
                }
            };
            fTempFunc(pPoints, 0, 1, 2, 4);
            fTempFunc(pPoints, 1, 0, 3, 5);
            fTempFunc(pPoints, 2, 0, 3, 6);
            fTempFunc(pPoints, 3, 1, 2, 7);
            fTempFunc(pPoints, 4, 0, 5, 6);
            fTempFunc(pPoints, 5, 1, 4, 7);
            fTempFunc(pPoints, 6, 2, 4, 7);
            fTempFunc(pPoints, 7, 3, 5, 6);
            for(i = 0; i < 8; i++) {
                for(j = 0; j < 4; j++) {
                    ppVertexes[i * 12 + j * 3 + 0] = pPoints[i][j].x;
                    ppVertexes[i * 12 + j * 3 + 1] = pPoints[i][j].y;
                    ppVertexes[i * 12 + j * 3 + 2] = pPoints[i][j].z;
                }
            }
            pInd = [
                0, 
                1, 
                0, 
                2, 
                0, 
                3, 
                4, 
                5, 
                4, 
                6, 
                4, 
                7, 
                8, 
                9, 
                8, 
                10, 
                8, 
                11, 
                12, 
                13, 
                12, 
                14, 
                12, 
                15, 
                16, 
                17, 
                16, 
                18, 
                16, 
                19, 
                20, 
                21, 
                20, 
                22, 
                20, 
                23, 
                24, 
                25, 
                24, 
                26, 
                24, 
                27, 
                28, 
                29, 
                28, 
                30, 
                28, 
                31
            ];
            for(var i = 0; i < pInd.length; ++i) {
                ppIndexes[i] = pInd[i];
            }
            return true;
        }
        geometry.computeDataForCascadeBoundingBox = computeDataForCascadeBoundingBox;
        function computeGeneralizingSphere(pSphereA, pSphereB, pSphereDest) {
            if (!((pSphereDest) !== undefined)) {
                pSphereDest = pSphereA;
            }
            var fR1 = pSphereA.radius;
            var fR2 = pSphereB.radius;
            var v3fC1 = pSphereA.center;
            var v3fC2 = pSphereB.center;
            var v3fD = new akra.Vec3();
            v3fC1.subtract(v3fC2, v3fD);
            var fD = v3fD.length();
            if (fD < fR1 && fR1 > fR2) {
                pSphereDest.set(pSphereA);
                return false;
            }
            if (fD < fR2) {
                pSphereDest.set(pSphereB);
                return false;
            }
            var v3fN = new akra.Vec3();
            v3fD.normalize(v3fN);
            pSphereDest.radius = v3fD.add(v3fN.scale(fR1 + fR2)).length() / 2.0;
            var v3fTemp = v3fD;
            pSphereDest.center = v3fC1.add(v3fC2, v3fTemp).add(v3fN.scale((fR1 - fR2) / (fR1 + fR2))).scale(.5);
            return true;
        }
        geometry.computeGeneralizingSphere = computeGeneralizingSphere;
        function computeDataForCascadeBoundingSphere(pBoundingSphere, ppVertexes, ppIndexes, fMinSize) {
            if (typeof fMinSize === "undefined") { fMinSize = 0.25; }
            var fTheta, fDelta, fAlpha;
            var nCount = 10;
            var i, j, k, a;
            fDelta = 2 * Math.PI / nCount;
            for(i = 0; i <= nCount / 2; i++) {
                fTheta = -Math.PI + (i * fDelta);
                for(j = 0; j <= nCount; j++) {
                    fAlpha = j * fDelta;
                    ppVertexes[(i * (nCount + 1) + j) * 3 + 0] = pBoundingSphere.center.x + pBoundingSphere.radius * Math.sin(fTheta) * Math.cos(fAlpha);
                    ppVertexes[(i * (nCount + 1) + j) * 3 + 1] = pBoundingSphere.center.y + pBoundingSphere.radius * Math.sin(fTheta) * Math.sin(fAlpha);
                    ppVertexes[(i * (nCount + 1) + j) * 3 + 2] = pBoundingSphere.center.z + pBoundingSphere.radius * Math.cos(fTheta);
                }
            }
            for(i = 0; i < nCount / 2; i++) {
                for(j = 0; j < nCount; j++) {
                    ppIndexes[(i * (nCount) + j) * 12 + 0] = i * (nCount + 1) + j;
                    ppIndexes[(i * (nCount) + j) * 12 + 1] = i * (nCount + 1) + j + 1;
                    ppIndexes[(i * (nCount) + j) * 12 + 2] = i * (nCount + 1) + j + 2 + nCount;
                    ppIndexes[(i * (nCount) + j) * 12 + 3] = i * (nCount + 1) + j;
                    ppIndexes[(i * (nCount) + j) * 12 + 4] = i * (nCount + 1) + j + 1;
                    ppIndexes[(i * (nCount) + j) * 12 + 5] = i * (nCount + 1) + j + 2 + nCount;
                    ppIndexes[(i * (nCount) + j) * 12 + 6] = i * (nCount + 1) + j;
                    ppIndexes[(i * (nCount) + j) * 12 + 7] = i * (nCount + 1) + j + 1 + nCount;
                    ppIndexes[(i * (nCount) + j) * 12 + 8] = i * (nCount + 1) + j + 2 + nCount;
                    ppIndexes[(i * (nCount) + j) * 12 + 9] = i * (nCount + 1) + j + 1 + nCount;
                    ppIndexes[(i * (nCount) + j) * 12 + 10] = i * (nCount + 1) + j + 2 + nCount;
                    ppIndexes[(i * (nCount) + j) * 12 + 11] = i * (nCount + 1) + j;
                }
            }
            return true;
        }
        geometry.computeDataForCascadeBoundingSphere = computeDataForCascadeBoundingSphere;
        function computeBoundingSphere(pVertexData, pSphere, bFastMethod, pBoundingBox) {
            if (typeof bFastMethod === "undefined") { bFastMethod = true; }
            if (typeof pBoundingBox === "undefined") { pBoundingBox = null; }
            if (bFastMethod) {
                return computeBoundingSphereFast(pVertexData, pSphere, pBoundingBox);
            } else {
                return computeBoundingSphereMinimal(pVertexData, pSphere);
            }
        }
        geometry.computeBoundingSphere = computeBoundingSphere;
        function computeBoundingSphereFast(pVertexData, pSphere, pBoundingBox) {
            if (typeof pBoundingBox === "undefined") { pBoundingBox = null; }
            var i;
            var pVertexDeclaration, pVertexElement;
            var nCount, nStride;
            var pData, pTempData;
            pVertexDeclaration = pVertexData.getVertexDeclaration();
            if (((pVertexDeclaration) === null)) {
                return false;
            }
            pVertexElement = pVertexDeclaration.findElement(akra.DeclUsages.POSITION, 3);
            if (((pVertexElement) === null)) {
                return false;
            }
            nCount = pVertexData.length;
            nStride = pVertexElement.size;
            pData = pVertexData.getData(pVertexElement.offset, pVertexElement.size);
            if (((pData) === null)) {
                return false;
            }
            if (((pBoundingBox) === null)) {
                pBoundingBox = geometry.Rect3d.stackCeil;
            }
            if (pBoundingBox.isClear()) {
                if (!computeBoundingBox(pVertexData, pBoundingBox)) {
                    return false;
                }
            }
            var fCenterX = (pBoundingBox.x0 + pBoundingBox.x1) / 2;
            var fCenterY = (pBoundingBox.y0 + pBoundingBox.y1) / 2;
            var fCenterZ = (pBoundingBox.z0 + pBoundingBox.z1) / 2;
            var fRadius = 0;
            var fDistance = 0;
            for(i = 0; i < nStride * nCount; i += nStride) {
                pTempData = new Float32Array(pData, i, 3);
                fDistance = (pTempData[0] - fCenterX) * (pTempData[0] - fCenterX) + (pTempData[1] - fCenterY) * (pTempData[1] - fCenterY) + (pTempData[2] - fCenterZ) * (pTempData[2] - fCenterZ);
                fRadius = fDistance > fRadius ? fDistance : fRadius;
            }
            pSphere.set(fCenterX, fCenterY, fCenterZ, Math.sqrt(fRadius));
            return true;
        }
        geometry.computeBoundingSphereFast = computeBoundingSphereFast;
        function computeBoundingSphereMinimal(pVertexData, pSphere) {
            var i = 0, j = 0, k = 0;
            var points = [];
            var length = 0;
            var isAdd = false;
            var isNew = true;
            var fDiametr = 0;
            var fDistance = 0;
            var pVertexDeclaration, pVertexElement;
            var nCount, nStride;
            var pData, pTempData1, pTempData2;
            pVertexDeclaration = pVertexData.getVertexDeclaration();
            if (((pVertexData) === null)) {
                return false;
            }
            if (((pVertexDeclaration) === null)) {
                return false;
            }
            pVertexElement = pVertexDeclaration.findElement(akra.DeclUsages.POSITION, 3);
            if (((pVertexElement) === null)) {
                return false;
            }
            nCount = pVertexData.length;
            nStride = pVertexElement.size;
            pData = pVertexData.getData(pVertexElement.offset, pVertexElement.size);
            if (!pData) {
                return false;
            }
            for(i = 0; i < nStride * nCount; i += nStride) {
                isNew = true;
                isAdd = false;
                pTempData1 = new Float32Array(pData, i, 3);
                for(k = 0; k < points.length; k += 3) {
                    if (points[k] == pTempData1[0] && points[k + 1] == pTempData1[1] && points[k + 2] == pTempData1[2]) {
                        isNew = false;
                        break;
                    }
                }
                if (isNew) {
                    for(j = i + nStride; j < nStride * nCount; j += nStride) {
                        pTempData2 = new Float32Array(pData, j, 3);
                        fDistance = (pTempData1[0] - pTempData2[0]) * (pTempData1[0] - pTempData2[0]) + (pTempData1[1] - pTempData2[1]) * (pTempData1[1] - pTempData2[1]) + (pTempData1[2] - pTempData2[2]) * (pTempData1[2] - pTempData2[2]);
                        if (fDistance > fDiametr) {
                            fDiametr = fDistance;
                            isAdd = true;
                            points[0] = pTempData2[0];
                            points[1] = pTempData2[1];
                            points[2] = pTempData2[2];
                            length = 3;
                        } else if (fDistance.toFixed(7) == fDiametr.toFixed(7)) {
                            isAdd = true;
                            for(k = 0; k < points.length; k += 3) {
                                if (points[k] == pTempData2[0] && points[k + 1] == pTempData2[1] && points[k + 2] == pTempData2[2]) {
                                    isNew = false;
                                    break;
                                }
                            }
                            if (isNew) {
                                points[length] = pTempData2[0];
                                points[length + 1] = pTempData2[1];
                                points[length + 2] = pTempData2[2];
                                length += 3;
                            }
                        }
                    }
                    if (isAdd) {
                        points[length] = pTempData1[0];
                        points[length + 1] = pTempData1[1];
                        points[length + 2] = pTempData1[2];
                        length += 3;
                    }
                }
            }
            var fX = 0, fY = 0, fZ = 0;
            for(i = 0; i < points.length; i += 3) {
                fX += points[i];
                fY += points[i + 1];
                fZ += points[i + 2];
            }
            var x = pSphere.center.x = fX / points.length * 3;
            var y = pSphere.center.y = fY / points.length * 3;
            var z = pSphere.center.z = fZ / points.length * 3;
            pSphere.radius = Math.sqrt((points[0] - x) * (points[0] - x) + (points[1] - y) * (points[1] - y) + (points[2] - z) * (points[2] - z));
            return true;
        }
        geometry.computeBoundingSphereMinimal = computeBoundingSphereMinimal;
    })(akra.geometry || (akra.geometry = {}));
    var geometry = akra.geometry;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (model) {
        var MeshSubset = (function (_super) {
            __extends(MeshSubset, _super);
            function MeshSubset(pMesh, pRenderData, sName) {
                if (typeof sName === "undefined") { sName = null; }
                        _super.call(this, akra.ERenderDataTypes.MESH_SUBSET);
                this._sName = null;
                this._pMesh = null;
                this._pSkin = null;
                this._pBoundingBox = null;
                this._pBoundingSphere = null;
                this.setup(pMesh, pRenderData, sName);
            }
            Object.defineProperty(MeshSubset.prototype, "boundingBox", {
                get: function () {
                    return this._pBoundingBox;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(MeshSubset.prototype, "boundingSphere", {
                get: function () {
                    return this._pBoundingSphere;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(MeshSubset.prototype, "skin", {
                get: function () {
                    return this._pSkin;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(MeshSubset.prototype, "name", {
                get: function () {
                    return this._sName;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(MeshSubset.prototype, "mesh", {
                get: function () {
                    return this._pMesh;
                },
                enumerable: true,
                configurable: true
            });
            MeshSubset.prototype.setup = function (pMesh, pRenderData, sName) {
 {
                    akra.logger.setSourceLocation("MeshSubset.ts", 36);
                    akra.logger.assert(this._pMesh === null, "mesh subset already prepared");
                }
                ;
                this._pMesh = pMesh;
                this._pRenderData = pRenderData;
                this._sName = sName;
                _super.prototype._setup.call(this, pMesh.getEngine().getRenderer());
            };
            MeshSubset.prototype.createBoundingBox = function () {
                var pVertexData;
                var pNewBoundingBox;
                pNewBoundingBox = new akra.geometry.Rect3d();
                pVertexData = this.data._getData(akra.DeclUsages.POSITION);
                if (((pVertexData) === null)) {
                    return false;
                }
                if (akra.geometry.computeBoundingBox(pVertexData, pNewBoundingBox) == false) {
                    return false;
                }
                this._pBoundingBox = pNewBoundingBox;
                return true;
            };
            MeshSubset.prototype.deleteBoundingBox = function () {
                this._pBoundingBox = null;
                return true;
            };
            MeshSubset.prototype.showBoundingBox = function () {
                var pMaterial;
                var iData;
                var iCurrentIndexSet;
                var pPoints, pIndexes;
                if (((this._pBoundingBox) === null)) {
                    return false;
                }
                pPoints = new Array();
                pIndexes = new Array();
                akra.geometry.computeDataForCascadeBoundingBox(this._pBoundingBox, pPoints, pIndexes, 10.0);
                iCurrentIndexSet = this.data.getIndexSet();
                if (!this.data.selectIndexSet(".BoundingBox")) {
                    if (this.data.addIndexSet(true, akra.EPrimitiveTypes.LINELIST, ".BoundingBox") == -1) {
 {
                            akra.logger.setSourceLocation("MeshSubset.ts", 89);
                            akra.logger.error("could not add index set '.BoundingBox'");
                        }
                        ;
                        return false;
                    }
                    iData = this.data.allocateData([
                        akra.VE_FLOAT3(akra.DeclUsages.POSITION)
                    ], new Float32Array(pPoints));
                    this.data.allocateIndex([
                        akra.VE_FLOAT(akra.DeclUsages.INDEX0)
                    ], new Float32Array(pIndexes));
                    this.data.index(iData, akra.DeclUsages.INDEX0);
                    this.applyFlexMaterial(".MaterialBoundingBox");
                    pMaterial = this.getFlexMaterial(".MaterialBoundingBox");
                    pMaterial.emissive = new akra.Color(0.0, 0.0, 1.0, 1.0);
                    pMaterial.diffuse = new akra.Color(0.0, 0.0, 1.0, 1.0);
                } else {
                    this.data._getData(akra.DeclUsages.POSITION).setData(new Float32Array(pPoints), akra.DeclUsages.POSITION);
                }
                this.data.setRenderable(this.data.getIndexSet(), true);
                this.data.selectIndexSet(iCurrentIndexSet);
                return true;
            };
            MeshSubset.prototype.hideBoundingBox = function () {
                var iCurrentIndexSet;
                iCurrentIndexSet = this.data.getIndexSet();
                if (!this.data.selectIndexSet(".BoundingBox")) {
                    return false;
                } else {
                    this.data.setRenderable(this.data.getIndexSet(), false);
                }
                return this.data.selectIndexSet(iCurrentIndexSet);
            };
            MeshSubset.prototype.createBoundingSphere = function () {
                var pVertexData;
                var pNewBoundingSphere;
                pNewBoundingSphere = new akra.geometry.Sphere();
                pVertexData = this.data._getData(akra.DeclUsages.POSITION);
                if (!pVertexData) {
                    return false;
                }
                if (!akra.geometry.computeBoundingSphere(pVertexData, pNewBoundingSphere, false, this._pBoundingBox)) {
                    return false;
                }
                this._pBoundingSphere = pNewBoundingSphere;
                return true;
            };
            MeshSubset.prototype.deleteBoundingSphere = function () {
                this._pBoundingSphere = null;
                return true;
            };
            MeshSubset.prototype.showBoundingSphere = function () {
                var pMaterial;
                var iData;
                var iCurrentIndexSet;
                var pPoints, pIndexes;
                if (((this._pBoundingSphere) === null)) {
                    return false;
                }
                pPoints = new Array();
                pIndexes = new Array();
                akra.geometry.computeDataForCascadeBoundingSphere(this._pBoundingSphere, pPoints, pIndexes);
                iCurrentIndexSet = this.data.getIndexSet();
                if (!this.data.selectIndexSet(".BoundingSphere")) {
                    this.data.addIndexSet(false, akra.EPrimitiveTypes.LINELIST, ".BoundingSphere");
                    iData = this.data.allocateData([
                        akra.VE_FLOAT3(akra.DeclUsages.POSITION)
                    ], new Float32Array(pPoints));
                    this.data.allocateIndex([
                        akra.VE_FLOAT(akra.DeclUsages.INDEX0)
                    ], new Float32Array(pIndexes));
                    this.data.index(iData, akra.DeclUsages.INDEX0);
                    this.applyFlexMaterial(".MaterialBoundingSphere");
                    pMaterial = this.getFlexMaterial(".MaterialBoundingSphere");
                    pMaterial.emissive = new akra.Color(0.0, 0.0, 1.0, 1.0);
                    pMaterial.diffuse = new akra.Color(0.0, 0.0, 1.0, 1.0);
                } else {
                    this.data._getData(akra.DeclUsages.POSITION).setData(new Float32Array(pPoints), akra.DeclUsages.POSITION);
                }
                this.data.setRenderable(this.data.getIndexSet(), true);
                this.data.selectIndexSet(iCurrentIndexSet);
                return true;
            };
            MeshSubset.prototype.hideBoundingSphere = function () {
                var iCurrentIndexSet = this.data.getIndexSet();
                if (!this.data.selectIndexSet(".BoundingSphere")) {
                    return false;
                } else {
                    this.data.setRenderable(this.data.getIndexSet(), false);
                }
                return this.data.selectIndexSet(iCurrentIndexSet);
            };
            MeshSubset.prototype.computeNormals = function () {
            };
            MeshSubset.prototype.computeTangents = function () {
            };
            MeshSubset.prototype.computeBinormals = function () {
            };
            MeshSubset.prototype.isSkinned = function () {
                return this._pSkin !== null;
            };
            MeshSubset.prototype.getSkin = function () {
                return this._pSkin;
            };
            MeshSubset.prototype.applyFlexMaterial = function (sMaterial, pMaterialData) {
                if (typeof pMaterialData === "undefined") { pMaterialData = null; }
                if (this._pMesh.addFlexMaterial(sMaterial, pMaterialData)) {
                    return this.setFlexMaterial(sMaterial);
                }
                return false;
            };
            MeshSubset.prototype.getFlexMaterial = function (iMaterial) {
                return this._pMesh.getFlexMaterial(iMaterial);
            };
            MeshSubset.prototype.hasFlexMaterial = function () {
                return this._pRenderData.hasSemantics(akra.DeclUsages.MATERIAL);
            };
            MeshSubset.prototype.setFlexMaterial = function (iMaterial) {
                var pMaterial = this._pMesh.getFlexMaterial(iMaterial);
                if (((pMaterial) === null)) {
 {
                        akra.logger.setSourceLocation("MeshSubset.ts", 255);
                        akra.logger.warning("could not find material <" + iMaterial + "> in sub mesh <" + this.name + ">");
                    }
                    ;
                    return false;
                }
                var pRenderData = this._pRenderData;
                var pIndexData = pRenderData.getIndices();
                var pMatFlow = pRenderData._getFlow(akra.DeclUsages.MATERIAL);
                var eSemantics = akra.DeclUsages.INDEX10;
                var pIndexDecl, pFloatArray;
                var iMatFlow;
                var iMat = (pMaterial).data.byteOffset;
                if (pMatFlow) {
                    iMatFlow = pMatFlow.flow;
                    eSemantics = pMatFlow.mapper.semantics;
                    pIndexData = pMatFlow.mapper.data;
                    pRenderData._addData((pMaterial).data, iMatFlow);
                    return pRenderData.index(iMat, eSemantics, true);
                }
                pIndexDecl = akra.createVertexDeclaration([
                    akra.VE_FLOAT(eSemantics)
                ]);
                pFloatArray = new Float32Array((pIndexData).length);
                iMatFlow = pRenderData._addData((pMaterial).data);
 {
                    akra.logger.setSourceLocation("MeshSubset.ts", 281);
                    akra.logger.assert(iMatFlow >= 0, "cannot add data flow with material for mesh subsset");
                }
                ;
                if (!pRenderData.allocateIndex(pIndexDecl, pFloatArray)) {
 {
                        akra.logger.setSourceLocation("MeshSubset.ts", 284);
                        akra.logger.warning("cannot allocate index for material!!!");
                    }
                    ;
                    return false;
                }
                return pRenderData.index(iMat, eSemantics, true);
            };
            MeshSubset.prototype._draw = function () {
 {
                    akra.logger.setSourceLocation("MeshSubset.ts", 293);
                    akra.logger.criticalError("Need to do.");
                }
                ;
            };
            MeshSubset.prototype.show = function () {
                this.data.setRenderable(true);
            };
            MeshSubset.prototype.hide = function () {
                this.data.setRenderable(false);
            };
            MeshSubset.prototype.setSkin = function (pSkin) {
                var pPosData;
                var pPositionFlow;
                var pMetaData;
                var pInfMetaData;
                var iInfMetaDataLoc;
                var iInfMetaDataStride;
                pPositionFlow = this.data._getFlow(akra.DeclUsages.POSITION);
 {
                    akra.logger.setSourceLocation("MeshSubset.ts", 324);
                    akra.logger.assert(((pPositionFlow) != null), "skin require position with indices in mesh subset");
                }
                ;
                pPosData = pPositionFlow.data;
                if (pPosData.hasSemantics(akra.DeclUsages.BLENDMETA)) {
                    if (pSkin.isAffect(pPosData)) {
                        this._pSkin = pSkin;
                        return true;
                    }
 {
                        akra.logger.setSourceLocation("MeshSubset.ts", 336);
                        akra.logger.error("mesh subset already has another skin");
                    }
                    ;
                    return false;
                }
 {
                    akra.logger.setSourceLocation("MeshSubset.ts", 343);
                    akra.logger.assert(this.data.buffer == pSkin.data, "can not bind to skin mesh subset that does not belong skin's mesh.");
                }
                pSkin.attach(pPosData);
                var pDeclaration = pPosData.getVertexDeclaration();
                var pVEMeta = pDeclaration.findElement(akra.DeclUsages.BLENDMETA);
 {
                    akra.logger.setSourceLocation("MeshSubset.ts", 374);
                    akra.logger.assert(((pVEMeta) != null), "you must specify location for storage blending data");
                }
                ;
                pMetaData = new Float32Array(pPosData.getData(0, pDeclaration.stride));
                pInfMetaData = pSkin.getInfluenceMetaData();
                iInfMetaDataLoc = pInfMetaData.byteOffset / akra.EDataTypeSizes.BYTES_PER_FLOAT;
                iInfMetaDataStride = pInfMetaData.stride / akra.EDataTypeSizes.BYTES_PER_FLOAT;
                var iCount = pMetaData.byteLength / pDeclaration.stride;
                var iOffset = pVEMeta.offset / akra.EDataTypeSizes.BYTES_PER_FLOAT;
                var iStride = pDeclaration.stride / akra.EDataTypeSizes.BYTES_PER_FLOAT;
                for(var i = 0; i < iCount; ++i) {
                    pMetaData[iOffset + i * iStride] = iInfMetaDataLoc + i * iInfMetaDataStride;
                }
                pPosData.setData(pMetaData, 0, pDeclaration.stride);
                this._pSkin = pSkin;
                return true;
            };
            MeshSubset.prototype.update = function () {
                return this.isSkinned() ? this.skin.applyBoneMatrices() : false;
            };
            return MeshSubset;
        })(akra.render.RenderableObject);
        model.MeshSubset = MeshSubset;        
    })(akra.model || (akra.model = {}));
    var model = akra.model;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (model) {
        var Mesh = (function (_super) {
            __extends(Mesh, _super);
            function Mesh(pEngine, eOptions, sName, pDataBuffer) {
                        _super.call(this);
                this._pFlexMaterials = null;
                this._pBuffer = null;
                this._eOptions = 0;
                this._pSkeleton = null;
                this._pBoundingBox = null;
                this._pBoundingSphere = null;
                this._pSubMeshes = [];
                this._bShadow = true;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._sName = sName || null;
                this._pEngine = pEngine;
                this.setup(sName, eOptions, pDataBuffer);
            }
            Object.defineProperty(Mesh.prototype, "length", {
                get: function () {
                    return this._pSubMeshes.length;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Mesh.prototype, "flexMaterials", {
                get: function () {
                    return this._pFlexMaterials;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Mesh.prototype, "name", {
                get: function () {
                    return this._sName;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Mesh.prototype, "data", {
                get: function () {
                    return this._pBuffer;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Mesh.prototype, "skeleton", {
                get: function () {
                    return this._pSkeleton;
                },
                set: function (pSkeleton) {
                    this._pSkeleton = pSkeleton;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Mesh.prototype, "boundingBox", {
                get: function () {
                    if (((this._pBoundingBox) === null)) {
                        if (!this.createBoundingBox()) {
 {
                                akra.logger.setSourceLocation("model/Mesh.ts", 66);
                                akra.logger.warning("could not compute bounding box fo mesh");
                            }
                            ;
                        }
                    }
                    return this._pBoundingBox;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Mesh.prototype, "boundingSphere", {
                get: function () {
                    if (((this._pBoundingSphere) === null)) {
                        if (!this.createBoundingSphere()) {
 {
                                akra.logger.setSourceLocation("model/Mesh.ts", 76);
                                akra.logger.warning("could not compute bounding sphere for mesh");
                            }
                            ;
                        }
                    }
                    return this._pBoundingSphere;
                },
                enumerable: true,
                configurable: true
            });
            Mesh.prototype.setSkeleton = function (pSkeleton) {
                this.skeleton = pSkeleton;
            };
            Mesh.prototype.getOptions = function () {
                return this._eOptions;
            };
            Mesh.prototype.getEngine = function () {
                return this._pEngine;
            };
            Mesh.prototype._drawSubset = function (iSubset) {
                this._pBuffer._draw(iSubset);
            };
            Mesh.prototype._draw = function () {
                for(var i = 0; i < this.length; i++) {
                    this._pSubMeshes[i]._draw();
                }
                ;
            };
            Mesh.prototype.isReadyForRender = function () {
                for(var i = 0; i < this._pSubMeshes.length; ++i) {
                    if (!this._pSubMeshes[i].isReadyForRender()) {
                        return false;
                    }
                }
                return true;
            };
            Mesh.prototype.setup = function (sName, eOptions, pDataCollection) {
 {
                    akra.logger.setSourceLocation("model/Mesh.ts", 124);
                    akra.logger.assert(this._pBuffer === null, "mesh already setuped.");
                }
                ;
                if (((pDataCollection) === null)) {
                    this._pBuffer = this._pEngine.createRenderDataCollection(eOptions);
                } else {
 {
                        akra.logger.setSourceLocation("model/Mesh.ts", 131);
                        akra.logger.assert(pDataCollection.getEngine() === this.getEngine(), "you can not use a buffer with a different context");
                    }
                    ;
                    this._pBuffer = pDataCollection;
                    eOptions |= pDataCollection.getOptions();
                }
                this._pBuffer.addRef();
                this._eOptions = eOptions || 0;
                this._sName = sName || "unknown";
                return true;
            };
            Mesh.prototype.createSubset = function (sName, ePrimType, eOptions) {
                if (typeof eOptions === "undefined") { eOptions = 0; }
                var pData;
                pData = this._pBuffer.getEmptyRenderData(ePrimType, eOptions);
                pData.addRef();
                if (((pData) === null)) {
                    return null;
                }
                return this.appendSubset(sName, pData);
            };
            Mesh.prototype.appendSubset = function (sName, pData) {
 {
                    akra.logger.setSourceLocation("model/Mesh.ts", 158);
                    akra.logger.assert(pData.buffer === this._pBuffer, "invalid data used");
                }
                ;
                var pSubMesh = new model.MeshSubset(this, pData, sName);
                this._pSubMeshes.push(pSubMesh);
                this.connect(pSubMesh, "shadow", "shadow", akra.EEventTypes.UNICAST);
                return pSubMesh;
            };
            Mesh.prototype.replaceFlexMaterials = function (pFlexMaterials) {
                this._pFlexMaterials = pFlexMaterials;
            };
            Mesh.prototype.freeSubset = function (sName) {
 {
                    akra.logger.setSourceLocation("model/Mesh.ts", 174);
                    akra.logger.error("Метод freeSubset не реализован");
                }
                ;
                return false;
            };
            Mesh.prototype.getFlexMaterial = function (arg) {
                if (!this._pFlexMaterials) {
                    return null;
                }
                if (typeof arguments[0] === 'number') {
                    return this._pFlexMaterials[arguments[0]] || null;
                } else {
                    for(var i = 0, pMaterials = this._pFlexMaterials; i < pMaterials.length; ++i) {
                        if (pMaterials[i].name === arguments[0]) {
                            return pMaterials[i];
                        }
                    }
                }
                return null;
            };
            Mesh.prototype.addFlexMaterial = function (sName, pMaterialData) {
                if (typeof sName === "undefined") { sName = 'unknown'; }
                if (typeof pMaterialData === "undefined") { pMaterialData = null; }
                var pMaterial;
                var pMaterialId;
 {
                    akra.logger.setSourceLocation("model/Mesh.ts", 203);
                    akra.logger.assert(arguments.length < 7, "only base material supported now...");
                }
                ;
                pMaterial = this.getFlexMaterial(sName);
                if (pMaterial) {
                    if (pMaterialData) {
                        pMaterial.set(pMaterialData);
                    }
                    return true;
                }
                if (!this._pFlexMaterials) {
                    this._pFlexMaterials = [];
                }
                pMaterialId = this._pFlexMaterials.length;
                pMaterial = akra.material._createFlex(sName, this._pBuffer._allocateData(akra.material.VERTEX_DECL, null));
                if (!pMaterialData) {
                    pMaterialData = akra.material.create(null, akra.material.DEFAULT);
                }
                pMaterial.set(pMaterialData);
                this._pFlexMaterials.push(pMaterial);
                return true;
            };
            Mesh.prototype.setFlexMaterial = function (iMaterial) {
                var bResult = true;
                for(var i = 0; i < this.length; ++i) {
                    if (!this._pSubMeshes[i].setFlexMaterial(iMaterial)) {
 {
                            akra.logger.setSourceLocation("model/Mesh.ts", 243);
                            akra.logger.warning("cannot set material<" + iMaterial + "> for mesh<" + this.name + "> subset<" + this._pSubMeshes[i].name + ">");
                        }
                        ;
                        bResult = false;
                    }
                }
                return bResult;
            };
            Mesh.prototype.destroy = function () {
                this._pFlexMaterials = null;
                this._pSubMeshes = null;
                this._pBuffer.destroy();
            };
            Mesh.prototype.getSubset = function (i) {
                if ((typeof (arguments[0]) === "number")) {
                    return this._pSubMeshes[arguments[0]];
                } else {
                    for(var i = 0; i < this.length; ++i) {
                        if (this._pSubMeshes[i].name === arguments[0]) {
                            return this._pSubMeshes[i];
                        }
                    }
                }
                return null;
            };
            Mesh.prototype.setSkin = function (pSkin) {
                for(var i = 0; i < this.length; ++i) {
                    this._pSubMeshes[i].setSkin(pSkin);
                }
                ;
            };
            Mesh.prototype.createSkin = function () {
                var pSkin = model.createSkin(this);
                return pSkin;
            };
            Mesh.prototype.clone = function (iCloneOptions) {
                var pClone = null;
                var pRenderData;
                var pSubMesh;
                if (iCloneOptions & akra.EMeshCloneOptions.SHARED_GEOMETRY) {
                    pClone = this.getEngine().createMesh(this.name, this.getOptions(), this.data);
                    for(var i = 0; i < this.length; ++i) {
                        pRenderData = this._pSubMeshes[i].data;
                        pRenderData.addRef();
                        pClone.appendSubset(this._pSubMeshes[i].name, pRenderData);
                    }
                    pClone.replaceFlexMaterials(this.flexMaterials);
                } else {
                }
                if (iCloneOptions & akra.EMeshCloneOptions.GEOMETRY_ONLY) {
                    return pClone;
                } else {
                }
                return pClone;
            };
            Mesh.prototype.createAndShowSubBoundingBox = function () {
                for(var i = 0; i < this.length; i++) {
                    var pSubMesh = this.getSubset(i);
                    if (pSubMesh.createBoundingBox()) {
                        if (!pSubMesh.showBoundingBox()) {
 {
                                akra.logger.setSourceLocation("model/Mesh.ts", 321);
                                akra.logger.error("could not show sub bounding box");
                            }
                            ;
                        }
                    } else {
 {
                            akra.logger.setSourceLocation("model/Mesh.ts", 325);
                            akra.logger.error("could not create sub bounding box.");
                        }
                        ;
                    }
                }
            };
            Mesh.prototype.createAndShowSubBoundingSphere = function () {
                for(var i = 0; i < this.length; i++) {
                    var pSubMesh = this.getSubset(i);
                    pSubMesh.createBoundingSphere();
                    pSubMesh.showBoundingSphere();
                }
            };
            Mesh.prototype.createBoundingBox = function () {
                var pVertexData;
                var pSubMesh;
                var pNewBoundingBox;
                var pTempBoundingBox;
                var i;
                pNewBoundingBox = new akra.geometry.Rect3d();
                pTempBoundingBox = new akra.geometry.Rect3d();
                pSubMesh = this.getSubset(0);
                pVertexData = pSubMesh.data._getData(akra.DeclUsages.POSITION);
                if (((pVertexData) === null)) {
                    return false;
                }
                if (akra.geometry.computeBoundingBox(pVertexData, pNewBoundingBox) == false) {
                    return false;
                }
                if (pSubMesh.isSkinned()) {
                    pNewBoundingBox.transform(pSubMesh.skin.getBindMatrix());
                    pNewBoundingBox.transform(pSubMesh.skin.getBoneOffsetMatrix(pSubMesh.skin.skeleton.root.boneName));
                }
                for(i = 1; i < this.length; i++) {
                    pSubMesh = this.getSubset(i);
                    pVertexData = pSubMesh.data._getData(akra.DeclUsages.POSITION);
                    if (!pVertexData) {
                        return false;
                    }
                    if (akra.geometry.computeBoundingBox(pVertexData, pTempBoundingBox) == false) {
                        return false;
                    }
                    if (pSubMesh.isSkinned()) {
                        pTempBoundingBox.transform(pSubMesh.skin.getBindMatrix());
                        pTempBoundingBox.transform(pSubMesh.skin.getBoneOffsetMatrix(pSubMesh.skin.skeleton.root.boneName));
                    }
                    pNewBoundingBox.x0 = Math.min(pNewBoundingBox.x0, pTempBoundingBox.x0);
                    pNewBoundingBox.y0 = Math.min(pNewBoundingBox.y0, pTempBoundingBox.y0);
                    pNewBoundingBox.z0 = Math.min(pNewBoundingBox.z0, pTempBoundingBox.z0);
                    pNewBoundingBox.x1 = Math.max(pNewBoundingBox.x1, pTempBoundingBox.x1);
                    pNewBoundingBox.y1 = Math.max(pNewBoundingBox.y1, pTempBoundingBox.y1);
                    pNewBoundingBox.z1 = Math.max(pNewBoundingBox.z1, pTempBoundingBox.z1);
                }
                this._pBoundingBox = pNewBoundingBox;
                return true;
            };
            Mesh.prototype.deleteBoundingBox = function () {
                this._pBoundingBox = null;
                return true;
            };
            Mesh.prototype.showBoundingBox = function () {
                var pSubMesh;
                var pMaterial;
                var iData;
                var pPoints, pIndexes;
                if (((this._pBoundingBox) === null)) {
                    return false;
                }
                pPoints = new Array();
                pIndexes = new Array();
                akra.geometry.computeDataForCascadeBoundingBox(this._pBoundingBox, pPoints, pIndexes, 0.1);
                pSubMesh = this.getSubset(".BoundingBox");
                if (!pSubMesh) {
                    pSubMesh = this.createSubset(".BoundingBox", akra.EPrimitiveTypes.LINELIST, akra.EHardwareBufferFlags.STATIC);
                    if (((pSubMesh) === null)) {
                        return false;
                    }
                    iData = pSubMesh.data.allocateData([
                        akra.VE_FLOAT3(akra.DeclUsages.POSITION)
                    ], new Float32Array(pPoints));
                    pSubMesh.data.allocateIndex([
                        akra.VE_FLOAT(akra.DeclUsages.INDEX0)
                    ], new Float32Array(pIndexes));
                    pSubMesh.data.index(iData, akra.DeclUsages.INDEX0);
                    pMaterial = pSubMesh.material;
                    pMaterial.emissive = new akra.Color(1.0, 1.0, 1.0, 1.0);
                    pMaterial.diffuse = new akra.Color(1.0, 1.0, 1.0, 1.0);
                    pMaterial.ambient = new akra.Color(1.0, 1.0, 1.0, 1.0);
                    pMaterial.specular = new akra.Color(1.0, 1.0, 1.0, 1.0);
                    pSubMesh.effect.addComponent("akra.system.mesh_texture");
                    pSubMesh.effect.addComponent("akra.system.prepareForDeferredShading");
                } else {
                    pSubMesh.data._getData(akra.DeclUsages.POSITION).setData(new Float32Array(pPoints), akra.DeclUsages.POSITION);
                }
                pSubMesh.data.setRenderable(pSubMesh.data.getIndexSet(), true);
                return true;
            };
            Mesh.prototype.hideBoundingBox = function () {
                var pSubMesh = this.getSubset(".BoundingBox");
                if (!pSubMesh) {
                    return false;
                }
                return false;
            };
            Mesh.prototype.createBoundingSphere = function () {
                var pVertexData;
                var pSubMesh;
                var pNewBoundingSphere, pTempBoundingSphere;
                var i;
                pNewBoundingSphere = new akra.geometry.Sphere();
                pTempBoundingSphere = new akra.geometry.Sphere();
                pSubMesh = this.getSubset(0);
                pVertexData = pSubMesh.data._getData(akra.DeclUsages.POSITION);
                if (!pVertexData) {
                    return false;
                }
                if (akra.geometry.computeBoundingSphere(pVertexData, pNewBoundingSphere) == false) {
                    return false;
                }
                if (pSubMesh.isSkinned()) {
                    pNewBoundingSphere.transform(pSubMesh.skin.getBindMatrix());
                    pNewBoundingSphere.transform(pSubMesh.skin.getBoneOffsetMatrix(pSubMesh.skin.skeleton.root.boneName));
                }
                for(i = 1; i < this.length; i++) {
                    pSubMesh = this.getSubset(i);
                    pVertexData = pSubMesh.data._getData(akra.DeclUsages.POSITION);
                    if (((pVertexData) === null)) {
                        return false;
                    }
                    if (akra.geometry.computeBoundingSphere(pVertexData, pTempBoundingSphere) == false) {
                        return false;
                    }
                    if (pSubMesh.isSkinned()) {
                        pTempBoundingSphere.transform(pSubMesh.skin.getBindMatrix());
                        pTempBoundingSphere.transform(pSubMesh.skin.getBoneOffsetMatrix(pSubMesh.skin.skeleton.root.boneName));
                    }
                    akra.geometry.computeGeneralizingSphere(pNewBoundingSphere, pTempBoundingSphere);
                }
                this._pBoundingSphere = pNewBoundingSphere;
                return true;
            };
            Mesh.prototype.deleteBoundingSphere = function () {
                this._pBoundingSphere = null;
                return true;
            };
            Mesh.prototype.showBoundingSphere = function () {
                var pSubMesh, pMaterial;
                var iData;
                var pPoints, pIndexes;
                if (!this._pBoundingSphere) {
                    return false;
                }
                pPoints = new Array();
                pIndexes = new Array();
                akra.geometry.computeDataForCascadeBoundingSphere(this._pBoundingSphere, pPoints, pIndexes);
                pSubMesh = this.getSubset(".BoundingSphere");
                if (!pSubMesh) {
                    pSubMesh = this.createSubset(".BoundingSphere", akra.EPrimitiveTypes.LINELIST, akra.EHardwareBufferFlags.STATIC);
                    if (((pSubMesh) === null)) {
                        return false;
                    }
                    iData = pSubMesh.data.allocateData([
                        akra.VE_FLOAT3(akra.DeclUsages.POSITION)
                    ], new Float32Array(pPoints));
                    pSubMesh.data.allocateIndex([
                        akra.VE_FLOAT(akra.DeclUsages.INDEX0)
                    ], new Float32Array(pIndexes));
                    pSubMesh.data.index(iData, akra.DeclUsages.INDEX0);
                    pMaterial = pSubMesh.material;
                    pMaterial.emissive = new akra.Color(1.0, 0.0, 0.0, 1.0);
                    pMaterial.diffuse = new akra.Color(1.0, 0.0, 0.0, 1.0);
                    pMaterial.ambient = new akra.Color(1.0, 0.0, 0.0, 1.0);
                    pMaterial.specular = new akra.Color(1.0, 0.0, 0.0, 1.0);
                } else {
                    pSubMesh.data._getData(akra.DeclUsages.POSITION).setData(new Float32Array(pPoints), akra.DeclUsages.POSITION);
                }
                pSubMesh.data.setRenderable(pSubMesh.data.getIndexSet(), true);
                return true;
            };
            Mesh.prototype.hideBoundingSphere = function () {
                var pSubMesh;
                pSubMesh = this.getSubset(".BoundingSphere");
                if (!pSubMesh) {
                    return false;
                }
                return false;
            };
            Object.defineProperty(Mesh.prototype, "hasShadow", {
                get: function () {
                    return this._bShadow;
                },
                set: function (bValue) {
                    for(var i = 0; i < this._pSubMeshes.length; ++i) {
                        this._pSubMeshes[i].hasShadow = bValue;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Mesh.prototype.toSceneModel = function (pParent, sName) {
                if (typeof sName === "undefined") { sName = null; }
                if (((pParent) === null)) {
                    return null;
                }
                var pSceneModel = pParent.scene.createModel(sName);
                if (!pSceneModel.create()) {
                    return null;
                }
                pSceneModel.mesh = this;
                pSceneModel.attachToParent(pParent);
                return pSceneModel;
            };
            Mesh.prototype.update = function () {
                var isOk = false;
                for(var i = 0; i < this.length; ++i) {
                    isOk = this._pSubMeshes[i].update() ? true : isOk;
                }
                return isOk;
            };
            Mesh.prototype.getGuid = function () {
                return this._iGuid;
            };
            Mesh._pEventTable = new akra.events.EventTable();
            Mesh.prototype.getEventTable = function () {
                return Mesh._pEventTable;
            };
            Mesh.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Mesh.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Mesh.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Mesh.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Mesh.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            Mesh.prototype.shadow = function (pSubMesh, bShadow) {
                this._bShadow = bShadow;
                if (!bShadow) {
                    for(var i = 0; i < this._pSubMeshes.length; ++i) {
                        if (this._pSubMeshes[i].hasShadow) {
                            this._bShadow = true;
                            break;
                        }
                    }
                }
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).shadow;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pSubMesh, bShadow) : _broadcast[i].listener(_recivier, pSubMesh, bShadow);
                    }
                }
                ;
            };
            return Mesh;
        })(akra.util.ReferenceCounter);        
        function createMesh(pEngine, sName, eOptions, pDataBuffer) {
            if (typeof sName === "undefined") { sName = null; }
            if (typeof eOptions === "undefined") { eOptions = 0; }
            if (typeof pDataBuffer === "undefined") { pDataBuffer = null; }
            return new Mesh(pEngine, eOptions, sName, pDataBuffer);
        }
        model.createMesh = createMesh;
    })(akra.model || (akra.model = {}));
    var model = akra.model;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        var SceneModel = (function (_super) {
            __extends(SceneModel, _super);
            function SceneModel(pScene) {
                        _super.call(this, pScene, akra.EEntityTypes.MODEL);
                this._pMesh = null;
            }
            Object.defineProperty(SceneModel.prototype, "mesh", {
                get: function () {
                    return this._pMesh;
                },
                set: function (pMesh) {
                    if (!((this._pMesh) === null)) {
                        this.accessLocalBounds().set(0.01, 0.01, 0.01);
                        this._pMesh.disconnect(this.scene, "preUpdate", "update");
                        this._pMesh = null;
                    }
                    if (!((pMesh) === null)) {
                        this.accessLocalBounds().set(pMesh.boundingBox);
                        this._pMesh = pMesh;
                        pMesh.connect(this.scene, "preUpdate", "update");
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(SceneModel.prototype, "totalRenderable", {
                get: function () {
                    return ((this._pMesh) === null) ? 0 : this._pMesh.length;
                },
                enumerable: true,
                configurable: true
            });
            SceneModel.prototype.getRenderable = function (i) {
                if (typeof i === "undefined") { i = 0; }
                if (((this._pMesh) === null)) {
 {
                        akra.logger.setSourceLocation("SceneModel.ts", 43);
                        akra.logger.warning(this);
                    }
                    ;
                }
                return this._pMesh.getSubset(i);
            };
            Object.defineProperty(SceneModel.prototype, "hasShadow", {
                get: function () {
                    return this._pMesh.hasShadow;
                },
                set: function (bValue) {
                    this._pMesh.hasShadow = bValue;
                },
                enumerable: true,
                configurable: true
            });
            SceneModel.prototype.toString = function (isRecursive, iDepth) {
                if (typeof isRecursive === "undefined") { isRecursive = false; }
                if (typeof iDepth === "undefined") { iDepth = 0; }
                if (!isRecursive) {
                    var sData = "<model" + (this.name ? " " + this.name : "") + "(" + (((this._pMesh) === null) ? 0 : this._pMesh.length) + ")" + '>';
                    if (!((this._pMesh) === null)) {
                        sData += "( " + this._pMesh.name + " )";
                    }
                    return sData;
                }
                return _super.prototype.toString.call(this, isRecursive, iDepth);
            };
            return SceneModel;
        })(scene.SceneObject);
        scene.SceneModel = SceneModel;        
        var iUpdatedOnce = 0;
        function isModel(pEntity) {
            return pEntity.type === akra.EEntityTypes.MODEL;
        }
        scene.isModel = isModel;
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        ;
        var RenderData = (function (_super) {
            __extends(RenderData, _super);
            function RenderData(pCollection) {
                if (typeof pCollection === "undefined") { pCollection = null; }
                        _super.call(this);
                this._eOptions = 0;
                this._pBuffer = null;
                this._iId = -1;
                this._pIndexBuffer = null;
                this._pAttribBuffer = null;
                this._pIndexData = null;
                this._pAttribData = null;
                this._pMap = null;
                this._pIndicesArray = [];
                this._iIndexSet = 0;
                this._iRenderable = 1;
                this._pComposer = null;
                this._pBuffer = pCollection;
                this._pComposer = pCollection.getEngine().getComposer();
            }
            Object.defineProperty(RenderData.prototype, "buffer", {
                get: function () {
                    return this._pBuffer;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderData.prototype, "indexSet", {
                get: function () {
                    return this._pIndicesArray[this._iIndexSet];
                },
                enumerable: true,
                configurable: true
            });
            RenderData.prototype.allocateData = function (pDecl, pData, hasIndex) {
                if (typeof hasIndex === "undefined") { hasIndex = true; }
                var pDataDecl = akra.createVertexDeclaration(pDecl);
                var eType = akra.ERenderDataTypes.INDEXED;
                if (!hasIndex || this.useSingleIndex()) {
                    eType = akra.ERenderDataTypes.DIRECT;
                } else if (this.useAdvancedIndex()) {
                    eType = akra.ERenderDataTypes.I2I;
                }
                return this._allocateData(pDataDecl, pData, eType);
            };
            RenderData.prototype.releaseData = function (iDataLocation) {
            };
            RenderData.prototype.allocateAttribute = function (pAttrDecl, pData) {
                var pIndexData = this._pIndexData;
                var pAttribData = this._pAttribData;
                var pAttribBuffer = this._pAttribBuffer;
                var pBuffer = this._pBuffer;
                if (!pAttribData) {
                    if (!pAttribBuffer) {
                        pAttribBuffer = pBuffer.getEngine().getResourceManager().createVertexBuffer('render_data_attrs_' + ((++/*checked (origin: akra)>>*/akra._total)));
                        pAttribBuffer.create((pData).byteLength, akra.EHardwareBufferFlags.BACKUP_COPY);
                        this._pAttribBuffer = pAttribBuffer;
                    }
                    this._pAttribData = this._pAttribBuffer.allocateData(pAttrDecl, pData);
                    this._pIndicesArray[this._iIndexSet].pAttribData = this._pAttribData;
                    this._pMap.flow(this._pAttribData);
                    return this._pAttribData !== null;
                }
                if (!pAttribData.extend(pAttrDecl, pData)) {
 {
                        akra.logger.setSourceLocation("RenderData.ts", 139);
                        akra.logger.log('invalid data for allocation:', arguments);
                    }
                    ;
 {
                        akra.logger.setSourceLocation("RenderData.ts", 140);
                        akra.logger.warning('cannot allocate attribute in data subset..');
                    }
                    ;
                    return false;
                }
                return true;
            };
            RenderData.prototype.allocateIndex = function (pDecl, pData) {
                var pAttrDecl = akra.createVertexDeclaration(pDecl);
                if (this.useAdvancedIndex()) {
                    return this._allocateAdvancedIndex(pAttrDecl, pData);
                }
                return this._allocateIndex(pAttrDecl, pData);
            };
            RenderData.prototype.getAdvancedIndexData = function (sSemantics) {
                return this._getData(sSemantics, true);
            };
            RenderData.prototype.addIndexSet = function (usePreviousDataSet, ePrimType, sName) {
                if (typeof usePreviousDataSet === "undefined") { usePreviousDataSet = true; }
                if (typeof ePrimType === "undefined") { ePrimType = akra.EPrimitiveTypes.TRIANGLELIST; }
                if (typeof sName === "undefined") { sName = null; }
                if (usePreviousDataSet) {
                    this._pMap = this._pMap.clone(false);
                    if (!this._pMap) {
 {
                            akra.logger.setSourceLocation("RenderData.ts", 181);
                            akra.logger.warning("could not clone buffer map");
                        }
                        ;
                        return -1;
                    }
                } else {
                    this._pMap = this._pBuffer.getEngine().createBufferMap();
                    this._pAttribData = null;
                }
                this._pMap.primType = ePrimType;
                this._pIndexData = null;
                this._iIndexSet = this._pIndicesArray.length;
                this._pIndicesArray.push({
                    pMap: this._pMap,
                    pIndexData: this._pIndexData,
                    pAttribData: this._pAttribData,
                    sName: sName,
                    pI2IDataCache: null,
                    pAdditionCache: null
                });
                return this._iIndexSet;
            };
            RenderData.prototype.getNumIndexSet = function () {
                return this._pIndicesArray.length;
            };
            RenderData.prototype.getIndexSetName = function (iSet) {
                if (typeof iSet === "undefined") { iSet = this._iIndexSet; }
                return this._pIndicesArray[iSet].sName;
            };
            RenderData.prototype.selectIndexSet = function (a) {
                var iSet = -1;
                if ((typeof (arguments[0]) === "string")) {
                    for(var i = 0; i < this._pIndicesArray.length; ++i) {
                        if (this._pIndicesArray[i].sName === arguments[0]) {
                            iSet = i;
                            break;
                        }
                    }
                    ;
                    if (iSet < 0) {
                        return false;
                    }
                }
                var pIndexSet = this._pIndicesArray[iSet];
                if (pIndexSet) {
                    this._pMap = pIndexSet.pMap;
                    this._pIndexData = pIndexSet.pIndexData;
                    this._pAttribData = pIndexSet.pAttribData;
                    this._iIndexSet = iSet;
                    return true;
                }
                return false;
            };
            RenderData.prototype.getIndexSet = function () {
                return this._iIndexSet;
            };
            RenderData.prototype.hasAttributes = function () {
                return !((this._pAttribData) === null);
            };
            RenderData.prototype.useAdvancedIndex = function () {
                return (this._eOptions & akra.ERenderDataOptions.ADVANCED_INDEX) != 0;
            };
            RenderData.prototype.useSingleIndex = function () {
                return (this._eOptions & akra.ERenderDataOptions.SINGLE_INDEX) != 0;
            };
            RenderData.prototype.useMultiIndex = function () {
                return (this._eOptions & akra.ERenderDataOptions.SINGLE_INDEX) == 0;
            };
            RenderData.prototype.setRenderable = function (iIndexSet, bValue) {
                if (typeof bValue === "undefined") { bValue = true; }
                if (arguments.length < 2) {
                    if (arguments[0]) {
                        ((this._eOptions) |= (akra.ERenderDataOptions.RENDERABLE));
                    } else {
                        ((this._eOptions) &= ~(akra.ERenderDataOptions.RENDERABLE));
                    }
                }
                (bValue ? ((this._iRenderable) |= (1 << (iIndexSet))) : ((this._iRenderable) &= ~(1 << (iIndexSet))));
            };
            RenderData.prototype.isRenderable = function (iIndexSet) {
                if (arguments.length > 0) {
                    return ((this._iRenderable & (1 << (iIndexSet))) != 0);
                }
                return this._eOptions & akra.ERenderDataOptions.RENDERABLE ? true : false;
            };
            RenderData.prototype.hasSemantics = function (sSemantics, bSearchComplete) {
                if (typeof bSearchComplete === "undefined") { bSearchComplete = true; }
                return this._getFlow(sSemantics, bSearchComplete) !== null;
            };
            RenderData.prototype.getDataLocation = function (sSemantics) {
                var pData = this._getData(sSemantics);
                return pData ? pData.byteOffset : -1;
            };
            RenderData.prototype.getIndices = function () {
                return this._pIndexData;
            };
            RenderData.prototype.getPrimitiveCount = function () {
                return this._pMap.primCount;
            };
            RenderData.prototype.index = function (data, sSemantics, useSame, iBeginWith) {
                if (typeof useSame === "undefined") { useSame = false; }
                if (typeof iBeginWith === "undefined") { iBeginWith = 0; }
                var iData = arguments[0];
                var iFlow = -1;
                var iAddition, iRealAddition, iPrevAddition;
                var pFlow;
                var pData, pRealData;
                var pFloat32Array;
                var iIndexOffset;
                var pIndexData = this._pIndexData;
                var sData;
                var iStride;
                var iTypeSize = akra.EDataTypeSizes.BYTES_PER_FLOAT;
                if (this.useAdvancedIndex()) {
                    pRealData = this._getData(arguments[0]);
                    iAddition = pRealData.byteOffset;
                    iStride = pRealData.stride;
                    pData = this._getData(sSemantics, true);
                    pData.applyModifier(sSemantics, function (pTypedData) {
                        for(var i = 0; i < pTypedData.length; i++) {
                            pTypedData[i] = (pTypedData[i] * iStride + iAddition) / iTypeSize;
                        }
                    });
                    iData = pData.byteOffset;
                    sSemantics = "INDEX_" + sSemantics;
                } else if ((typeof (arguments[0]) === "string")) {
                    if (arguments[0] === "TEXCOORD") {
                        iData = this.getDataLocation("TEXCOORD0");
                    } else {
                        iData = this.getDataLocation(arguments[0]);
                    }
 {
                        akra.logger.setSourceLocation("RenderData.ts", 376);
                        akra.logger.assert(iData >= 0, "cannot find data with semantics: " + arguments[0]);
                    }
                    ;
                }
                pFlow = this._getFlow(iData);
                if (pFlow === null) {
 {
                        akra.logger.setSourceLocation("RenderData.ts", 382);
                        akra.logger.warning("Could not find data flow <" + iData + "> int buffer map: " + this._pMap.toString(true));
                    }
                    ;
                    return false;
                }
                iFlow = pFlow.flow;
                iIndexOffset = (pIndexData).getVertexDeclaration().findElement(sSemantics).offset;
                pFloat32Array = (pIndexData).getTypedData(sSemantics);
                iAddition = iData;
                if (!pFloat32Array) {
                    return false;
                }
                iStride = pFlow.data.stride;
                if (this.indexSet.pAdditionCache[iIndexOffset] !== iAddition) {
                    if (!useSame) {
                        iPrevAddition = this.indexSet.pAdditionCache[iIndexOffset] || 0;
                        iRealAddition = iAddition - iPrevAddition;
                        for(var i = 0; i < pFloat32Array.length; i++) {
                            pFloat32Array[i] = (pFloat32Array[i] * iStride + iRealAddition) / iTypeSize;
                        }
                        ;
                    } else {
                        iRealAddition = iAddition;
                        for(var i = 0; i < pFloat32Array.length; i++) {
                            pFloat32Array[i] = (iBeginWith + iRealAddition) / iTypeSize;
                        }
                        ;
                    }
                    this.indexSet.pAdditionCache[iIndexOffset] = iAddition;
                    if (!(pIndexData).setData(pFloat32Array, sSemantics)) {
                        return false;
                    }
                }
                return this._pMap.mapping(iFlow, pIndexData, sSemantics);
            };
            RenderData.prototype._setup = function (pCollection, iId, ePrimType, eOptions) {
                if (typeof ePrimType === "undefined") { ePrimType = akra.EPrimitiveTypes.TRIANGLELIST; }
                if (typeof eOptions === "undefined") { eOptions = 0; }
                if (this._pBuffer === null && arguments.length < 2) {
                    return false;
                }
                this.setRenderable(true);
                this._eOptions |= eOptions;
                this._pBuffer = pCollection;
                this._iId = iId;
                this._pMap = pCollection.getEngine().createBufferMap();
                this._pMap.primType = ePrimType;
                this._pIndicesArray.push({
                    sName: ".main",
                    pMap: this._pMap,
                    pIndexData: null,
                    pAttribData: null,
                    pI2IDataCache: {},
                    pAdditionCache: null
                });
 {
                    akra.logger.setSourceLocation("RenderData.ts", 454);
                    akra.logger.assert(this.useSingleIndex() === false, "single indexed data not implimented");
                }
                ;
                return true;
            };
            RenderData.prototype._allocateData = function (pDataDecl, pData, eType) {
                if (eType === akra.ERenderDataTypes.DIRECT) {
                    return this.allocateAttribute(pDataDecl, pData) ? 0 : -1;
                }
                var iFlow;
                var pVertexData = this._pBuffer._allocateData(pDataDecl, pData);
                var iOffset = pVertexData.byteOffset;
                iFlow = this._addData(pVertexData, undefined, eType);
                if (iFlow < 0) {
 {
                        akra.logger.setSourceLocation("RenderData.ts", 474);
                        akra.logger.log("invalid data", pDataDecl, pData);
                    }
                    ;
 {
                        akra.logger.setSourceLocation("RenderData.ts", 475);
                        akra.logger.error("cannot allocate data for submesh");
                    }
                    ;
                    return -1;
                }
                return iOffset;
            };
            RenderData.prototype._addData = function (pVertexData, iFlow, eType) {
                if (typeof eType === "undefined") { eType = akra.ERenderDataTypes.DIRECT; }
                if ((arguments.length < 3 && this.useAdvancedIndex()) || arguments[2] === akra.ERenderDataTypes.I2I) {
                    return this._registerData(pVertexData);
                }
                return (!((iFlow) !== undefined) ? this._pMap.flow(pVertexData) : this._pMap.flow(iFlow, pVertexData));
            };
            RenderData.prototype._registerData = function (pVertexData) {
                'use strict';
                var iOffset = pVertexData.byteOffset;
                var pDataDecl = pVertexData.getVertexDeclaration();
                for(var i = 0; i < pDataDecl.length; i++) {
                    this.indexSet.pI2IDataCache[pDataDecl.element(i).usage] = iOffset;
                }
                return 0;
            };
            RenderData.prototype._allocateAdvancedIndex = function (pAttrDecl, pData) {
                var pDecl = akra.createVertexDeclaration(pAttrDecl);
                var nCount = pData.byteLength / pDecl.stride;
                var iIndLoc = this._allocateData(pAttrDecl, pData, akra.ERenderDataTypes.INDEXED);
                var pI2IData = new Float32Array(nCount);
                var pI2IDecl = [];
                for(var i = 0; i < pDecl.length; i++) {
                    pI2IDecl.push(akra.VE_FLOAT('INDEX_' + pDecl.element(i).usage, 0));
                }
                for(var i = 0; i < pI2IData.length; i++) {
                    pI2IData[i] = i;
                }
                if (!this._allocateIndex(pI2IDecl, pI2IData)) {
                    this.releaseData(iIndLoc);
                    pI2IData = null;
                    pI2IDecl = null;
 {
                        akra.logger.setSourceLocation("RenderData.ts", 547);
                        akra.logger.warning('cannot allocate index for index in render data subset');
                    }
                    ;
                    return false;
                }
                return true;
            };
            RenderData.prototype._createIndex = function (pAttrDecl, pData) {
                'use strict';
                if (!this._pIndexBuffer) {
                    if (this.useMultiIndex()) {
                        this._pIndexBuffer = this._pBuffer.getEngine().getResourceManager().createVertexBuffer('subset_' + ((++/*checked (origin: akra)>>*/akra._total)));
                        this._pIndexBuffer.create(((pData).byteLength), akra.EHardwareBufferFlags.BACKUP_COPY);
                    } else {
                    }
                }
                this._pIndexData = (this._pIndexBuffer).allocateData(pAttrDecl, pData);
                this.indexSet.pIndexData = this._pIndexData;
                this.indexSet.pAdditionCache = {};
                return this._pIndexData !== null;
            };
            RenderData.prototype._allocateIndex = function (pDecl, pData) {
                'use strict';
                var pAttrDecl = akra.createVertexDeclaration(pDecl);
                var pIndexData = this._pIndexData;
                var pIndexBuffer = this._pIndexBuffer;
                var pBuffer = this._pBuffer;
                for(var i = 0; i < pAttrDecl.length; i++) {
                    if (pAttrDecl.element(i).type !== akra.EDataTypes.FLOAT) {
                        return false;
                    }
                }
                if (!this._pIndexData) {
                    return this._createIndex(pAttrDecl, pData);
                }
                if (!(this._pIndexData).extend(pAttrDecl, pData)) {
 {
                        akra.logger.setSourceLocation("RenderData.ts", 608);
                        akra.logger.log('invalid data for allocation:', arguments);
                    }
                    ;
 {
                        akra.logger.setSourceLocation("RenderData.ts", 609);
                        akra.logger.warning('cannot allocate index in data subset..');
                    }
                    ;
                    return false;
                }
                return true;
            };
            RenderData.prototype._setIndexLength = function (iLength) {
                var bResult = (this._pIndexData).resize(iLength);
                if (bResult) {
                    this._pMap._length = iLength;
                }
                return bResult;
            };
            RenderData.prototype._getFlow = function (a, b) {
                if (typeof arguments[0] === 'string') {
                    return this._pMap.getFlow(arguments[0], arguments[1]);
                }
                for(var i = 0, n = this._pMap.limit; i < n; ++i) {
                    var pFlow = this._pMap.getFlow(i, false);
                    if (pFlow.data && pFlow.data.byteOffset === arguments[0]) {
                        return pFlow;
                    }
                }
                return null;
            };
            RenderData.prototype._getData = function (a, b) {
                var pFlow;
                if (this.useAdvancedIndex() && arguments.length < 2) {
                    if (typeof arguments[0] === 'string') {
                        return this._getData(this.indexSet.pI2IDataCache[arguments[0]]);
                    }
                    return this._pBuffer.getData(arguments[0]);
                }
                if (typeof arguments[0] === 'string') {
                    for(var i = 0, n = this._pMap.limit; i < n; ++i) {
                        pFlow = this._pMap.getFlow(i, false);
                        if (pFlow.data != null && pFlow.data.hasSemantics(arguments[0])) {
                            return pFlow.data;
                        }
                    }
                }
                pFlow = this._getFlow(arguments[0]);
                return pFlow === null ? null : pFlow.data;
            };
            RenderData.prototype._draw = function (pTechnique, pViewport, pRenderable, pSceneObject) {
                for(var i = 0; i < this._pIndicesArray.length; i++) {
                    if (this.isRenderable(i)) {
                        this._pComposer.applyBufferMap(this._pIndicesArray[i].pMap);
                        pTechnique._renderTechnique(pViewport, pRenderable, pSceneObject);
                    }
                }
            };
            RenderData.prototype.toString = function () {
                var s;
                s = "\nRENDER DATA SUBSET: #" + this._iId + "\n";
                s += "        ATTRIBUTES: " + (this._pAttribData ? "TRUE" : "FALSE") + "\n";
                s += "----------------------------------------------------------------\n";
                s += this._pMap.toString();
                return s;
            };
            return RenderData;
        })(akra.util.ReferenceCounter);
        render.RenderData = RenderData;        
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (render) {
        var RenderDataCollection = (function (_super) {
            __extends(RenderDataCollection, _super);
            function RenderDataCollection(pEngine, eOptions) {
                if (typeof eOptions === "undefined") { eOptions = 0; }
                        _super.call(this);
                this._pDataBuffer = null;
                this._pEngine = null;
                this._eDataOptions = 0;
                this._pDataArray = [];
                this._pEngine = pEngine;
                this.setup(eOptions);
            }
            Object.defineProperty(RenderDataCollection.prototype, "buffer", {
                get: function () {
                    return this._pDataBuffer;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderDataCollection.prototype, "length", {
                get: function () {
                    return this._pDataArray.length;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderDataCollection.prototype, "byteLength", {
                get: function () {
                    return this._pDataBuffer.byteLength;
                },
                enumerable: true,
                configurable: true
            });
            RenderDataCollection.prototype.clone = function (pSrc) {
 {
                    akra.logger.setSourceLocation("render/RenderDataCollection.ts", 37);
                    akra.logger.criticalError("TODO: RenderDataCollection::clone();");
                }
                ;
                return false;
            };
            RenderDataCollection.prototype.getEngine = function () {
                return this._pEngine;
            };
            RenderDataCollection.prototype.getOptions = function () {
                return this._eDataOptions;
            };
            RenderDataCollection.prototype.getData = function (a) {
                var pBuffer = this._pDataBuffer;
                var pData;
                var n;
                if (!((pBuffer) === null)) {
                    n = this._pDataBuffer.length;
                    if ((typeof (arguments[0]) === "string")) {
                        for(var i = 0; i < n; i++) {
                            pData = pBuffer.getVertexData(i);
                            if (pData.hasSemantics(arguments[0])) {
                                return pData;
                            }
                        }
                        ;
                    } else {
                        for(var i = 0; i < n; i++) {
                            pData = pBuffer.getVertexData(i);
                            if (pData.byteOffset === arguments[0]) {
                                return pData;
                            }
                        }
                        ;
                    }
                }
                return null;
            };
            RenderDataCollection.prototype._allocateData = function (pDecl, pData) {
                if (!this._pDataBuffer) {
                    this.createDataBuffer();
                }
                var pVertexDecl = akra.createVertexDeclaration(pDecl);
                var pVertexData;
                if ((arguments.length < 2) || (typeof (arguments[1]) === "number") || ((arguments[1]) === null)) {
                    pVertexData = this._pDataBuffer.getEmptyVertexData(pData || 1, pVertexDecl);
                } else {
                    pVertexData = this._pDataBuffer.allocateData(pVertexDecl, pData);
                }
 {
                    akra.logger.setSourceLocation("render/RenderDataCollection.ts", 108);
                    akra.logger.assert(pVertexData !== null, "cannot allocate data:\n" + pVertexDecl.toString());
                }
                ;
                return pVertexData;
            };
            RenderDataCollection.prototype.allocateData = function (pDecl, pData, isCommon) {
                if (typeof isCommon === "undefined") { isCommon = true; }
                var pVertexData;
                var pDataDecl = akra.createVertexDeclaration(pDecl);
                for(var i = 0; i < pDataDecl.length; i++) {
                    if (this.getData(pDataDecl.element(i).usage) !== null && pDataDecl.element(i).count !== 0) {
 {
                            akra.logger.setSourceLocation("render/RenderDataCollection.ts", 127);
                            akra.logger.warning("data buffer already contains data with similar vertex decloration <" + pDataDecl.element(i).usage + ">.");
                        }
                        ;
                    }
                }
                ;
                pVertexData = this._allocateData(pDataDecl, pData);
                if (isCommon) {
                    for(var i = 0; i < this._pDataArray.length; ++i) {
                        this._pDataArray[i]._addData(pVertexData);
                    }
                }
                return pVertexData.byteOffset;
            };
            RenderDataCollection.prototype.getDataLocation = function (sSemantics) {
                if (this._pDataBuffer) {
                    var pData;
                    for(var i = 0, n = this._pDataBuffer.length; i < n; i++) {
                        pData = this._pDataBuffer.getVertexData(i);
                        if (pData.hasSemantics(sSemantics)) {
                            return pData.byteOffset;
                        }
                    }
                    ;
                }
                return -1;
            };
            RenderDataCollection.prototype.createDataBuffer = function () {
                var iVbOption = 0;
                var eOptions = this._eDataOptions;
                if (eOptions & akra.ERenderDataBufferOptions.VB_READABLE) {
                    iVbOption = akra.ERenderDataBufferOptions.VB_READABLE;
                }
                this._pDataBuffer = this._pEngine.getResourceManager().createVideoBuffer("render_data_buffer" + "_" + ((++/*checked (origin: akra)>>*/akra._total)));
                this._pDataBuffer.create(0, iVbOption);
                this._pDataBuffer.addRef();
                return this._pDataBuffer !== null;
            };
            RenderDataCollection.prototype.getRenderData = function (iSubset) {
                return this._pDataArray[iSubset];
            };
            RenderDataCollection.prototype.getEmptyRenderData = function (ePrimType, eOptions) {
                if (typeof eOptions === "undefined") { eOptions = 0; }
                var iSubsetId = this._pDataArray.length;
                var pDataset = new render.RenderData(this);
                eOptions |= this._eDataOptions;
                if (!pDataset._setup(this, iSubsetId, ePrimType, eOptions)) {
 {
                        akra.logger.setSourceLocation("render/RenderDataCollection.ts", 187);
                        akra.logger.error("cannot setup submesh...");
                    }
                    ;
                }
                this._pDataArray.push(pDataset);
                return pDataset;
            };
            RenderDataCollection.prototype._draw = function (iSubset) {
 {
                    akra.logger.setSourceLocation("render/RenderDataCollection.ts", 205);
                    akra.logger.criticalError("TODO");
                }
                ;
            };
            RenderDataCollection.prototype.destroy = function () {
                this._pDataArray = null;
                if (this._pDataBuffer) {
                    this._pDataBuffer.destroy();
                    this._pDataBuffer = null;
                }
                this._pEngine = null;
                this._eDataOptions = 0;
            };
            RenderDataCollection.prototype.setup = function (eOptions) {
                if (typeof eOptions === "undefined") { eOptions = 0; }
                this._eDataOptions = eOptions;
            };
            return RenderDataCollection;
        })(akra.util.ReferenceCounter);
        render.RenderDataCollection = RenderDataCollection;        
        function createRenderDataCollection(pEngine, eOptions) {
            if (typeof eOptions === "undefined") { eOptions = 0; }
            return new RenderDataCollection(pEngine, eOptions);
        }
        render.createRenderDataCollection = createRenderDataCollection;
    })(akra.render || (akra.render = {}));
    var render = akra.render;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ERPCPacketTypes) {
        ERPCPacketTypes._map = [];
        ERPCPacketTypes._map[0] = "FAILURE";
        ERPCPacketTypes.FAILURE = 0;
        ERPCPacketTypes._map[1] = "REQUEST";
        ERPCPacketTypes.REQUEST = 1;
        ERPCPacketTypes._map[2] = "RESPONSE";
        ERPCPacketTypes.RESPONSE = 2;
    })(akra.ERPCPacketTypes || (akra.ERPCPacketTypes = {}));
    var ERPCPacketTypes = akra.ERPCPacketTypes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EPipeTypes) {
        EPipeTypes._map = [];
        EPipeTypes._map[0] = "UNKNOWN";
        EPipeTypes.UNKNOWN = 0;
        EPipeTypes._map[1] = "WEBSOCKET";
        EPipeTypes.WEBSOCKET = 1;
        EPipeTypes._map[2] = "WEBWORKER";
        EPipeTypes.WEBWORKER = 2;
    })(akra.EPipeTypes || (akra.EPipeTypes = {}));
    var EPipeTypes = akra.EPipeTypes;
    (function (EPipeDataTypes) {
        EPipeDataTypes._map = [];
        EPipeDataTypes._map[0] = "BINARY";
        EPipeDataTypes.BINARY = 0;
        EPipeDataTypes._map[1] = "STRING";
        EPipeDataTypes.STRING = 1;
    })(akra.EPipeDataTypes || (akra.EPipeDataTypes = {}));
    var EPipeDataTypes = akra.EPipeDataTypes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (net) {
        net.WEBSOCKET_PORT = 1337;
        var Pipe = (function () {
            function Pipe(sAddr) {
                if (typeof sAddr === "undefined") { sAddr = null; }
                this._pAddr = null;
                this._nMesg = 0;
                this._eType = akra.EPipeTypes.UNKNOWN;
                this._pConnect = null;
                this._bSetupComplete = false;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                if (!((sAddr) === null)) {
                    this.open(sAddr);
                }
            }
            Object.defineProperty(Pipe.prototype, "uri", {
                get: function () {
                    return (new /*checked (origin: akra)>>*/akra.util.URI((this._pAddr.toString())));
                },
                enumerable: true,
                configurable: true
            });
            Pipe.prototype.open = function (sAddr) {
                if (typeof sAddr === "undefined") { sAddr = null; }
                var pAddr;
                var eType;
                var pSocket = null;
                var pWorker = null;
                var pPipe = this;
                if (!((sAddr) === null)) {
                    pAddr = (new /*checked (origin: akra)>>*/akra.util.URI((sAddr)));
                } else {
                    if (this.isCreated()) {
                        this.close();
                    }
                    pAddr = this.uri;
                }
                if (pAddr.protocol.toLowerCase() === "ws") {
                    if (!(pAddr.port > 0)) {
                        pAddr.port = net.WEBSOCKET_PORT;
                    }
                    if (!((WebSocket) != null)) {
 {
                            akra.logger.setSourceLocation("Pipe.ts", 64);
                            akra.logger.error("Your browser does not support websocket api.");
                        }
                        ;
                        return false;
                    }
                    pSocket = new WebSocket(pAddr.toString());
                    pSocket.binaryType = "arraybuffer";
                    eType = akra.EPipeTypes.WEBSOCKET;
                } else if (akra.util.pathinfo(pAddr.path).ext.toLowerCase() === "js") {
                    if (!((Worker) != null)) {
 {
                            akra.logger.setSourceLocation("Pipe.ts", 76);
                            akra.logger.error("Your browser does not support webworker api.");
                        }
                        ;
                        return false;
                    }
                    pWorker = new Worker(pAddr.toString());
                    eType = akra.EPipeTypes.WEBWORKER;
                } else {
 {
                        akra.logger.setSourceLocation("Pipe.ts", 84);
                        akra.logger.error("Pipe supported only websockets/webworkers.");
                    }
                    ;
                    return false;
                }
                this._pConnect = pWorker || pSocket;
                this._pAddr = pAddr;
                this._eType = eType;
                if (((window) != null)) {
                    window.onunload = function () {
                        pPipe.close();
                    };
                }
                if (!((this._pConnect) === null)) {
                    this.setupConnect();
                    return true;
                }
                return false;
            };
            Pipe.prototype.setupConnect = function () {
                var pConnect = this._pConnect;
                var pPipe = this;
                var pAddr = this._pAddr;
                if (this._bSetupComplete) {
                    return;
                }
                pConnect.onmessage = function (pMessage) {
                    if (((pMessage.data) instanceof ArrayBuffer)) {
                        pPipe.message(pMessage.data, akra.EPipeDataTypes.BINARY);
                    } else {
                        pPipe.message(pMessage.data, akra.EPipeDataTypes.STRING);
                    }
                };
                pConnect.onopen = function (pEvent) {
 {
                        akra.logger.setSourceLocation("Pipe.ts", 126);
                        akra.logger.log("created connect to: " + pAddr.toString());
                    }
                    ;
                    pPipe.opened(pEvent);
                };
                pConnect.onerror = function (pErr) {
 {
                        akra.logger.setSourceLocation("Pipe.ts", 132);
                        akra.logger.warning("pipe error detected: " + pErr.message);
                    }
                    ;
                    pPipe.error(pErr);
                };
                pConnect.onclose = function (pEvent) {
 {
                        akra.logger.setSourceLocation("Pipe.ts", 137);
                        akra.logger.log("connection to " + pAddr.toString() + " closed");
                    }
                    ;
                    pPipe.closed(pEvent);
                };
                this._bSetupComplete = true;
            };
            Pipe.prototype.close = function () {
                var pSocket;
                var pWorker;
                if (this.isOpened()) {
                    switch(this._eType) {
                        case akra.EPipeTypes.WEBSOCKET:
                            pSocket = this._pConnect;
                            pSocket.onmessage = null;
                            pSocket.onerror = null;
                            pSocket.onopen = null;
                            pSocket.close();
                            break;
                        case akra.EPipeTypes.WEBWORKER:
                            pWorker = this._pConnect;
                            pWorker.terminate();
                    }
                }
                this._pConnect = null;
                this._bSetupComplete = false;
            };
            Pipe.prototype.write = function (pValue) {
                var pSocket;
                var pWorker;
                if (this.isOpened()) {
                    this._nMesg++;
                    switch(this._eType) {
                        case akra.EPipeTypes.WEBSOCKET:
                            pSocket = this._pConnect;
                            if (akra.isObject(pValue)) {
                                pValue = JSON.stringify(pValue);
                            }
                            pSocket.send(pValue);
                            return true;
                        case akra.EPipeTypes.WEBWORKER:
                            pWorker = this._pConnect;
                            if (((pValue.byteLength) !== undefined)) {
                                pWorker.postMessage(pValue, [
                                    pValue
                                ]);
                            } else {
                                pWorker.postMessage(pValue);
                            }
                            return true;
                    }
                }
                return false;
            };
            Pipe.prototype.isClosed = function () {
                switch(this._eType) {
                    case akra.EPipeTypes.WEBSOCKET:
                        return ((this._pConnect) === null) || ((this._pConnect).readyState === WebSocket.CLOSED);
                }
                return ((this._pConnect) === null);
            };
            Pipe.prototype.isOpened = function () {
                switch(this._eType) {
                    case akra.EPipeTypes.WEBSOCKET:
                        return !((this._pConnect) === null) && (this._pConnect).readyState === WebSocket.OPEN;
                }
                return !((this._pConnect) === null);
            };
            Pipe.prototype.isCreated = function () {
                return !((this._pConnect) === null);
            };
            Pipe.prototype.getGuid = function () {
                return this._iGuid;
            };
            Pipe._pEventTable = new akra.events.EventTable();
            Pipe.prototype.getEventTable = function () {
                return Pipe._pEventTable;
            };
            Pipe.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Pipe.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Pipe.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Pipe.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Pipe.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            Pipe.prototype.opened = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).opened;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            Pipe.prototype.closed = function (ev) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).closed;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, ev) : _broadcast[i].listener(_recivier, ev);
                    }
                }
            };
            Pipe.prototype.error = function (err) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).error;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, err) : _broadcast[i].listener(_recivier, err);
                    }
                }
            };
            Pipe.prototype.message = function (data, type) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).message;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, data, type) : _broadcast[i].listener(_recivier, data, type);
                    }
                }
            };
            return Pipe;
        })();        
        function createPipe(sAddr) {
            if (typeof sAddr === "undefined") { sAddr = null; }
            return new Pipe(sAddr);
        }
        net.createPipe = createPipe;
    })(akra.net || (akra.net = {}));
    var net = akra.net;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (net) {
        var ERpcStates;
        (function (ERpcStates) {
            ERpcStates._map = [];
            ERpcStates._map[0] = "k_Deteached";
            ERpcStates.k_Deteached = 0;
            ERpcStates._map[1] = "k_Joined";
            ERpcStates.k_Joined = 1;
            ERpcStates._map[2] = "k_Closing";
            ERpcStates.k_Closing = 2;
        })(ERpcStates || (ERpcStates = {}));
        var RPC = (function () {
            function RPC(pAddr, pContext) {
                if (typeof pAddr === "undefined") { pAddr = null; }
                if (typeof pContext === "undefined") { pContext = null; }
                this._pPipe = null;
                this._pDefferedRequests = new akra.ObjectList();
                this._pCallbacks = new akra.ObjectList();
                this._nCalls = 0;
                this._iReconnect = -1;
                this._pRemoteAPI = {};
                this._pContext = null;
                this._eState = ERpcStates.k_Deteached;
                this._iSystemRoutine = -1;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                if (!((pAddr) === null)) {
                    this.join(pAddr);
                }
            }
            Object.defineProperty(RPC.prototype, "remote", {
                get: function () {
                    return this._pRemoteAPI;
                },
                enumerable: true,
                configurable: true
            });
            RPC.prototype.join = function (sAddr) {
                if (typeof sAddr === "undefined") { sAddr = null; }
                var pPipe = this._pPipe;
                var pRPC = this;
                var pDeffered = this._pDefferedRequests;
                if (((pPipe) === null)) {
                    pPipe = akra.net.createPipe();
                    pPipe.bind("message", function (pPipe, pMessage, eType) {
                        if (eType !== akra.EPipeDataTypes.BINARY) {
                            pRPC.parse(JSON.parse(pMessage));
                        } else {
                            pRPC.parseBinary(pMessage);
                        }
                    });
                    pPipe.bind("opened", function (pPipe, pEvent) {
                        pRPC._startSystemRoutine();
                        if (pDeffered.length) {
                            pDeffered.seek(0);
                            while(pDeffered.length > 0) {
                                pPipe.write(pDeffered.current);
                                pRPC._releaseRequest(pDeffered.takeCurrent());
                            }
 {
                                akra.logger.setSourceLocation("net/RPC.ts", 94);
                                akra.logger.assert(pDeffered.length === 0, "something going wrong. length is: " + pDeffered.length);
                            }
                            ;
                        }
                        pRPC.proc(RPC.PROC_LIST, function (pError, pList) {
                            if (!((pError) === null)) {
 {
                                    akra.logger.setSourceLocation("net/RPC.ts", 100);
                                    akra.logger.criticalError("could not get proc. list");
                                }
                                ;
                            }
                            if (!((pList) === null) && akra.isArray(pList)) {
                                for(var i = 0; i < pList.length; ++i) {
                                    (function (sMethod) {
                                        pRPC.remote[sMethod] = function () {
                                            var pArguments = [
                                                sMethod
                                            ];
                                            for(var j = 0; j < arguments.length; ++j) {
                                                pArguments.push(arguments[j]);
                                            }
                                            return pRPC.proc.apply(pRPC, pArguments);
                                        };
                                    })(String(pList[i]));
                                }
                            }
                            pRPC.joined();
                        });
                    });
                    pPipe.bind("error", function (pPipe, pError) {
 {
                            akra.logger.setSourceLocation("net/RPC.ts", 129);
                            akra.logger.error("pipe error occured...");
                        }
                        ;
                    });
                    pPipe.bind("closed", function (pPipe, pEvent) {
                        pRPC._stopSystemRoutine();
                        pRPC.rejoin();
                    });
                }
                pPipe.open(sAddr);
                this._pPipe = pPipe;
                this._eState = ERpcStates.k_Joined;
            };
            RPC.prototype.rejoin = function () {
                var pRPC = this;
                clearTimeout(this._iReconnect);
                if (this._pPipe.isOpened()) {
                    this._eState = ERpcStates.k_Joined;
                    return;
                }
                if (this._eState == ERpcStates.k_Closing) {
                    this._eState = ERpcStates.k_Deteached;
                    return;
                }
                if (this._pPipe.isClosed()) {
                    this.freeCallbacks();
                    this._iReconnect = setTimeout(/** @inline */function () {
                        pRPC.join();
                    }, RPC.OPTIONS.RECONNECT_TIMEOUT);
                }
            };
            RPC.prototype.parse = function (pRes) {
                if (!((pRes.n) !== undefined)) {
 {
                        akra.logger.setSourceLocation("net/RPC.ts", 177);
                        akra.logger.log(pRes);
                    }
                    ;
 {
                        akra.logger.setSourceLocation("net/RPC.ts", 178);
                        akra.logger.warning("message droped, because seriial not recognized.");
                    }
                    ;
                }
                ;
                this.response(pRes.n, pRes.type, pRes.res);
            };
            RPC.prototype.parseBinary = function (pBuffer) {
                var pHeader = new Uint32Array(pBuffer, 0, 2);
                var nMsg = pHeader[0];
                var eType = pHeader[1];
                var pResult = new Uint8Array(pBuffer, 8);
                this.response(nMsg, eType, pResult);
            };
            RPC.prototype.response = function (nSerial, eType, pResult) {
                var pStack = this._pCallbacks;
                var fn = null;
                if (eType === akra.ERPCPacketTypes.RESPONSE) {
                    var pCallback = pStack.last;
                    do {
                        if (pCallback.n === nSerial) {
                            fn = pCallback.fn;
                            this._releaseCallback(pStack.takeCurrent());
                            if (!((fn) === null)) {
                                fn(null, pResult);
                            }
                            return;
                        }
                    } while(pCallback = pStack.prev());
 {
                        akra.logger.setSourceLocation("net/RPC.ts", 218);
                        akra.logger.warning("package droped, invalid serial: " + nSerial);
                    }
                    ;
                } else if (eType === akra.ERPCPacketTypes.REQUEST) {
 {
                        akra.logger.setSourceLocation("net/RPC.ts", 221);
                        akra.logger.error("TODO: REQUEST package type temprary unsupported.");
                    }
                    ;
                } else if (eType === akra.ERPCPacketTypes.FAILURE) {
 {
                        akra.logger.setSourceLocation("net/RPC.ts", 224);
                        akra.logger.error("detected FAILURE on " + nSerial + " package");
                    }
                    ;
 {
                        akra.logger.setSourceLocation("net/RPC.ts", 225);
                        akra.logger.log(pResult);
                    }
                    ;
                } else {
 {
                        akra.logger.setSourceLocation("net/RPC.ts", 228);
                        akra.logger.error("unsupported response type detected: " + eType);
                    }
                    ;
                }
            };
            RPC.prototype.freeRequests = function () {
                var pStack = this._pDefferedRequests;
                var pReq = pStack.first;
                if (pReq) {
                    do {
                        this._releaseRequest(pReq);
                    } while(pReq = pStack.next());
                    pStack.clear();
                }
            };
            RPC.prototype.freeCallbacks = function () {
                var pStack = this._pCallbacks;
                var pCallback = pStack.first;
                if (pCallback) {
                    do {
                        this._releaseCallback(pCallback);
                    } while(pCallback = pStack.next());
                    pStack.clear();
                }
            };
            RPC.prototype.free = function () {
                this.freeRequests();
                this.freeCallbacks();
            };
            RPC.prototype.detach = function () {
                this._eState = ERpcStates.k_Closing;
                if (!((this._pPipe) === null) && this._pPipe.isOpened()) {
                    this._pPipe.close();
                }
                this.free();
            };
            RPC.prototype.proc = function () {
                var argv = [];
                for (var _i = 0; _i < (arguments.length - 0); _i++) {
                    argv[_i] = arguments[_i + 0];
                }
                var IRPCCallback = arguments.length - 1;
                var fnCallback = (/*checked (origin: akra)>>*/akra.typeOf((arguments[IRPCCallback])) === "function") ? arguments[IRPCCallback] : null;
                var nArg = arguments.length - (fnCallback ? 2 : 1);
                var pArgv = new Array(nArg);
                var pPipe = this._pPipe;
                var pCallback = null;
                var bResult;
                for(var i = 0; i < nArg; ++i) {
                    pArgv[i] = arguments[i + 1];
                }
                var pProc = this._createRequest();
                pProc.n = this._nCalls++;
                pProc.type = akra.ERPCPacketTypes.REQUEST;
                pProc.proc = String(arguments[0]);
                pProc.argv = pArgv;
                pCallback = this._createCallback();
                pCallback.n = pProc.n;
                pCallback.fn = fnCallback;
                pCallback.timestamp = akra.now();
                if (((pPipe) === null) || !pPipe.isOpened()) {
                    if (this._pDefferedRequests.length <= RPC.OPTIONS.DEFFERED_CALLS_LIMIT) {
                        this._pDefferedRequests.push(pProc);
                        this._pCallbacks.push(pCallback);
                    } else {
                        pCallback.fn(RPC.ERRORS.STACK_SIZE_EXCEEDED);
 {
                            akra.logger.setSourceLocation("net/RPC.ts", 307);
                            akra.logger.warning(RPC.ERRORS.STACK_SIZE_EXCEEDED);
                        }
                        ;
                        this._releaseCallback(pCallback);
                        this._releaseRequest(pProc);
                    }
                    return false;
                }
                this._pCallbacks.push(pCallback);
                bResult = pPipe.write(pProc);
                this._releaseRequest(pProc);
                return bResult;
            };
            RPC.prototype._systemRoutine = function () {
                this._removeExpiredCallbacks();
            };
            RPC.prototype._startSystemRoutine = function () {
                var pRPC = this;
                this._iSystemRoutine = setInterval(/** @inline */function () {
                    pRPC._systemRoutine();
                }, RPC.OPTIONS.SYSTEM_ROUTINE_INTERVAL);
            };
            RPC.prototype._stopSystemRoutine = function () {
                clearInterval(this._iSystemRoutine);
                this._systemRoutine();
            };
            RPC.prototype._removeExpiredCallbacks = function () {
                var pCallbacks = this._pCallbacks;
                var pCallback = pCallbacks.first;
                var iNow = akra.now();
                var fn = null;
                while(!((pCallback) === null)) {
                    if ((iNow - pCallback.timestamp) >= RPC.OPTIONS.CALLBACK_LIFETIME) {
                        fn = pCallback.fn;
                        this._releaseCallback(pCallbacks.takeCurrent());
                        pCallback = pCallbacks.current;
                        if (!((fn) === null)) {
                            fn(RPC.ERRORS.CALLBACK_LIFETIME_EXPIRED, null);
                        }
                    } else {
                        pCallback = pCallbacks.next();
                    }
                }
            };
            RPC.prototype._releaseRequest = function (pReq) {
                pReq.n = 0;
                pReq.proc = null;
                pReq.argv = null;
                RPC.requestPool.push(pReq);
            };
            RPC.prototype._createRequest = function () {
                if (RPC.requestPool.length == 0) {
                    return {
                        n: 0,
                        type: akra.ERPCPacketTypes.REQUEST,
                        proc: null,
                        argv: null
                    };
                }
                return RPC.requestPool.pop();
            };
            RPC.prototype._releaseCallback = function (pCallback) {
                pCallback.n = 0;
                pCallback.fn = null;
                pCallback.timestamp = 0;
                RPC.callbackPool.push(pCallback);
            };
            RPC.prototype._createCallback = function () {
                if (RPC.callbackPool.length == 0) {
                    return {
                        n: 0,
                        fn: null,
                        timestamp: 0
                    };
                }
                return RPC.callbackPool.pop();
            };
            RPC.prototype.getGuid = function () {
                return this._iGuid;
            };
            RPC._pEventTable = new akra.events.EventTable();
            RPC.prototype.getEventTable = function () {
                return RPC._pEventTable;
            };
            RPC.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            RPC.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            RPC.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            RPC.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            RPC.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            RPC.prototype.joined = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).joined;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            RPC.requestPool = new akra.ObjectArray();
            RPC.callbackPool = new akra.ObjectArray();
            RPC.OPTIONS = {
                DEFFERED_CALLS_LIMIT: 1024 * 100,
                RECONNECT_TIMEOUT: 2500,
                SYSTEM_ROUTINE_INTERVAL: 10000,
                CALLBACK_LIFETIME: 999999
            };
            RPC.ERRORS = {
                STACK_SIZE_EXCEEDED: new Error("stack size exceeded"),
                CALLBACK_LIFETIME_EXPIRED: new Error("procedure life time expired")
            };
            RPC.PROC_LIST = "proc_list";
            return RPC;
        })();        
        function createRpc() {
            return new RPC();
        }
        net.createRpc = createRpc;
    })(akra.net || (akra.net = {}));
    var net = akra.net;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (terrain) {
        var MegaTexture = (function () {
            function MegaTexture(pEngine, pObject, sSurfaceTextures) {
                this._pEngine = null;
                this._pObject = null;
                this._pWorldExtents = null;
                this._v2fCameraCoord = new akra.Vec2(0, 0);
                this._sSurfaceTextures = "";
                this._iOriginalTextureMaxSize = 8192;
                this._iBlockSize = 32;
                this._eTextureFormat = akra.EPixelFormats.BYTE_BGR;
                this._iTextureHeight = 1024;
                this._iTextureWidth = 1024;
                this._pTextures = null;
                this._iBufferHeight = 0;
                this._iBufferWidth = 0;
                this._pBuffer = null;
                this._pBufferMap = null;
                this._pXY = null;
                this._pDataFor = null;
                this._pMapDataFor = null;
                this._pMapDataNULL = null;
                this._pRPC = null;
                this._fTexCourdXOld = undefined;
                this._fTexCourdYOld = undefined;
                this._nCountRender = 0;
                this._pTmpBox1 = new akra.geometry.Box();
                this._pTmpBox2 = new akra.geometry.Box();
                this._pTmpPixelBox = new akra.pixelUtil.PixelBox();
                this._pEngine = pEngine;
                this._pObject = pObject;
                this._pWorldExtents = pObject.localBounds;
                this._sSurfaceTextures = sSurfaceTextures;
                var iCountTex = (/*checked (origin: math)>>*/akra.math.log((this._iOriginalTextureMaxSize / /*checked (origin: akra)>>*/akra.math.max(this._iTextureHeight, this._iTextureWidth))) / /*checked (origin: math)>>*/akra.math.LN2) + 1;
                this._pTextures = new Array(iCountTex);
                this._pBuffer = new Array(iCountTex);
                this._pBufferMap = new Array(iCountTex);
                this._pXY = new Array(iCountTex);
                this._iBufferHeight = this._iTextureHeight * 2;
                this._iBufferWidth = this._iTextureWidth * 2;
                this._pDataFor = new akra.pixelUtil.PixelBox(this._iBufferWidth, this._iBufferHeight, 1, this._eTextureFormat, new Uint8Array(akra.pixelUtil.getMemorySize(this._iBufferWidth, this._iBufferHeight, 1, this._eTextureFormat)));
                this._pMapDataFor = new Uint32Array(this._iBufferHeight * this._iBufferWidth / (this._iBlockSize * this._iBlockSize));
                this._pMapDataNULL = new Uint32Array(this._iBufferHeight * this._iBufferWidth / (this._iBlockSize * this._iBlockSize));
                for(var i = 0; i < this._pMapDataNULL.length; i++) {
                    this._pMapDataNULL[i] = 0;
                }
                this.setBufferMapNULL(this._pMapDataFor);
                var pRmgr = this._pEngine.getResourceManager();
                var pInitData = null;
                for(var i = 0; i < this._pTextures.length; i++) {
                    this._pTextures[i] = pRmgr.createTexture(".texture-for-mega-" + i + ((++/*checked (origin: akra)>>*/akra._total)));
                    this._pTextures[i].create(this._iTextureWidth, this._iTextureHeight, 1, null, akra.ETextureFlags.DYNAMIC, 0, 1, akra.ETextureTypes.TEXTURE_2D, this._eTextureFormat);
                    this._pTextures[i].setWrapMode(akra.ETextureParameters.WRAP_S, akra.ETextureWrapModes.CLAMP_TO_EDGE);
                    this._pTextures[i].setWrapMode(akra.ETextureParameters.WRAP_T, akra.ETextureWrapModes.CLAMP_TO_EDGE);
                    if (i == 0) {
                        pInitData = new Uint8Array(akra.pixelUtil.getMemorySize(this._iTextureWidth, this._iTextureHeight, 1, this._eTextureFormat));
                        this._pBuffer[i] = new akra.pixelUtil.PixelBox(this._iTextureWidth, this._iTextureHeight, 1, this._eTextureFormat, pInitData);
                        this._pBufferMap[i] = new Uint32Array(this._iBufferHeight * this._iBufferWidth / (this._iBlockSize * this._iBlockSize));
                        this.setBufferMapNULL(this._pBufferMap[i]);
                    } else {
                        pInitData = new Uint8Array(akra.pixelUtil.getMemorySize(this._iBufferWidth, this._iBufferHeight, 1, this._eTextureFormat));
                        this._pBuffer[i] = new akra.pixelUtil.PixelBox(this._iBufferWidth, this._iBufferHeight, 1, this._eTextureFormat, pInitData);
                        this._pBufferMap[i] = new Uint32Array(this._iBufferHeight * this._iBufferWidth / (this._iBlockSize * this._iBlockSize));
                        this.setBufferMapNULL(this._pBufferMap[i]);
                    }
                    this._pXY[i] = {
                        iX: 0,
                        iY: 0,
                        iTexX: 0,
                        iTexY: 0,
                        isUpdated: true,
                        isLoaded: false
                    };
                }
                this._pRPC = akra.net.createRpc();
                this._pRPC.join("ws://localhost:6112");
                this.getDataFromServer(0, 0, 0, this._iTextureWidth, this._iTextureHeight);
            }
            MegaTexture.prototype.prepareForRender = function (pViewport) {
                var pCamera = pViewport.getCamera();
                var v4fCameraCoord = akra.vec4(pCamera.targetPos, 1.);
                var m4fTransposeInverse = this._pObject.inverseWorldMatrix.transpose(akra.mat4());
                v4fCameraCoord = m4fTransposeInverse.multiplyVec4(v4fCameraCoord);
                var fTexCourdX = (v4fCameraCoord.x - this._pWorldExtents.x0) / akra.math.abs(this._pWorldExtents.x1 - this._pWorldExtents.x0);
                var fTexCourdY = (v4fCameraCoord.y - this._pWorldExtents.y0) / akra.math.abs(this._pWorldExtents.y1 - this._pWorldExtents.y0);
                this._v2fCameraCoord.set(fTexCourdX, fTexCourdY);
                var iX, iX1, iX2;
                var iY, iY1, iY2;
                var iWidth, iHeight;
                iX = akra.math.round(fTexCourdX * (this.getWidthOrig(this._pTextures.length - 1)) - this._iTextureWidth / 2);
                iY = akra.math.round(fTexCourdY * (this.getHeightOrig(this._pTextures.length - 1)) - this._iTextureHeight / 2);
                iWidth = this._iTextureWidth;
                iHeight = this._iTextureHeight;
                if (akra.math.floor((iX - this._pXY[this._pTextures.length - 1].iX) / this._iBlockSize) < 8 || akra.math.floor((iY - this._pXY[this._pTextures.length - 1].iY) / this._iBlockSize) < 8 || akra.math.floor((this._pXY[this._pTextures.length - 1].iX + this._iBufferWidth - (iX + iWidth)) / this._iBlockSize) < 8 || akra.math.floor((this._pXY[this._pTextures.length - 1].iY + this._iBufferHeight - (iY + iHeight)) / this._iBlockSize) < 8) {
 {
                        akra.logger.setSourceLocation("terrain/MegaTexture.ts", 186);
                        akra.logger.log("Да");
                    }
                    for(i = 1; i < this._pTextures.length; i++) {
 {
                            akra.logger.setSourceLocation("terrain/MegaTexture.ts", 190);
                            akra.logger.log("Уровень", i);
                        }
                        var iXnew = akra.math.round(fTexCourdX * this.getWidthOrig(i) - this._iTextureWidth / 2);
                        var iYnew = akra.math.round(fTexCourdY * this.getHeightOrig(i) - this._iTextureHeight / 2);
                        iXnew -= (this._iBufferWidth - this._iTextureWidth) / 2;
                        iYnew -= (this._iBufferHeight - this._iTextureHeight) / 2;
                        iXnew = akra.math.round((iXnew / this._iBlockSize)) * this._iBlockSize;
                        iYnew = akra.math.round((iYnew / this._iBlockSize)) * this._iBlockSize;
                        var iXOverlappingBlockInOldBuf = iXnew - this._pXY[i].iX;
                        var iYOverlappingBlockInOldBuf = iYnew - this._pXY[i].iY;
                        var iXOverlappingBlockInNewBuf = -iXOverlappingBlockInOldBuf;
                        var iYOverlappingBlockInNewBuf = -iYOverlappingBlockInOldBuf;
                        iXOverlappingBlockInOldBuf = akra.math.max(0, iXOverlappingBlockInOldBuf);
                        iYOverlappingBlockInOldBuf = akra.math.max(0, iYOverlappingBlockInOldBuf);
                        iXOverlappingBlockInNewBuf = akra.math.max(0, iXOverlappingBlockInNewBuf);
                        iYOverlappingBlockInNewBuf = akra.math.max(0, iYOverlappingBlockInNewBuf);
                        if (iXOverlappingBlockInOldBuf < this._iBufferWidth && iYOverlappingBlockInOldBuf < this._iBufferHeight && iXOverlappingBlockInNewBuf < this._iBufferWidth && iYOverlappingBlockInNewBuf < this._iBufferHeight) {
                            var iOverlappingBlockWidth = this._iBufferWidth - akra.math.abs(iXnew - this._pXY[i].iX);
                            var iOverlappingBlockHeight = this._iBufferHeight - akra.math.abs(iYnew - this._pXY[i].iY);
 {
                                akra.logger.setSourceLocation("terrain/MegaTexture.ts", 225);
                                akra.logger.log("Копированеи совпадающей части");
                            }
                            ;
                            this._pTmpBox1.setPosition(iXOverlappingBlockInNewBuf, iYOverlappingBlockInNewBuf, iOverlappingBlockWidth, iOverlappingBlockHeight);
                            this._pTmpBox2.setPosition(iXOverlappingBlockInOldBuf, iYOverlappingBlockInOldBuf, iOverlappingBlockWidth, iOverlappingBlockHeight);
                            var pPixelBox1 = this._pDataFor.getSubBox(this._pTmpBox1);
                            var pPixelBox2 = this._pBuffer[i].getSubBox(this._pTmpBox2);
                            this.setBufferMapNULL(this._pMapDataFor);
                            this._setDataBetweenBufferMap(this._pMapDataFor, iXOverlappingBlockInNewBuf / this._iBlockSize, iYOverlappingBlockInNewBuf / this._iBlockSize, this._pBufferMap[i], iXOverlappingBlockInOldBuf / this._iBlockSize, iYOverlappingBlockInOldBuf / this._iBlockSize, iOverlappingBlockWidth / this._iBlockSize, iOverlappingBlockHeight / this._iBlockSize);
                            var t = this._pBuffer[i];
                            this._pBuffer[i] = this._pDataFor;
                            this._pDataFor = t;
                            var s = this._pBufferMap[i];
                            this._pBufferMap[i] = this._pMapDataFor;
                            this._pMapDataFor = s;
                        } else {
                            this.setBufferMapNULL(this._pBufferMap[i]);
                        }
                        console.log(this._pXY[i].iX, this._pXY[i].iY, "==>", iXnew, iYnew);
                        this._pXY[i].iX = iXnew;
                        this._pXY[i].iY = iYnew;
                        this._pXY[i].isUpdated = true;
                        console.log(this._pXY[i].iX, this._pXY[i].iY);
                    }
                }
                for(var i = 0; i < this._pTextures.length; i++) {
                    if (i != 0) {
                        iX = akra.math.round(fTexCourdX * this.getWidthOrig(i) - this._iTextureWidth / 2);
                        iY = akra.math.round(fTexCourdY * this.getHeightOrig(i) - this._iTextureHeight / 2);
                        iWidth = this._iTextureWidth;
                        iHeight = this._iTextureHeight;
                        var iAreaX1 = iX;
                        var iAreaY1 = iY;
                        var iAreaX2 = iX + iWidth;
                        var iAreaY2 = iY + iHeight;
                        if (iX >= this._pXY[i].iX && iY >= this._pXY[i].iY && iX + this._iTextureWidth < this._pXY[i].iX + this._iBufferWidth && iY + this._iTextureHeight < this._pXY[i].iY + this._iBufferHeight) {
                            iX -= this._iBlockSize * 8;
                            iY -= this._iBlockSize * 8;
                            iWidth += this._iBlockSize * 16;
                            iHeight += this._iBlockSize * 16;
                            iX1 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iX), (this.getWidthOrig(i)))));
                            iY1 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iY), (this.getHeightOrig(i)))));
                            iX2 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iX + iWidth), (this.getWidthOrig(i)))));
                            iY2 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iY + iHeight), (this.getHeightOrig(i)))));
                            var iAreaX1 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iAreaX1), (this.getWidthOrig(i)))));
                            var iAreaY1 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iAreaY1), (this.getHeightOrig(i)))));
                            var iAreaX2 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iAreaX2), (this.getWidthOrig(i)))));
                            var iAreaY2 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iAreaY2), (this.getHeightOrig(i)))));
                            this.getDataFromServer(i, iX1, iY1, iX2 - iX1, iY2 - iY1, iAreaX1, iAreaY1, iAreaX2 - iAreaX1, iAreaY2 - iAreaY1);
                        } else {
 {
                                akra.logger.setSourceLocation("terrain/MegaTexture.ts", 324);
                                akra.logger.error("Не может такого быть чтобы буфер не попал под текстуру");
                            }
                            ;
                        }
                    } else {
                        if (!this._pXY[0].isLoaded) {
                            this.getDataFromServer(0, 0, 0, this._iTextureWidth, this._iTextureHeight);
                        }
                    }
                }
                if (((this._nCountRender++) % 10) == 0) {
                    var iTexInBufX = 0;
                    var iTexInBufY = 0;
                    i = (akra.math.round(this._nCountRender / 10)) % this._pBuffer.length;
                    if (i == 0) {
                        if (this._pXY[i].isUpdated == true) {
                            this._pTextures[i].getBuffer(0, 0).blitFromMemory(this._pBuffer[0]);
                        }
                    } else {
                        if (this._pXY[i].isLoaded == true && (this._pXY[i].isUpdated == true || this._fTexCourdXOld != fTexCourdX || this._fTexCourdYOld != fTexCourdY)) {
                            iTexInBufX = akra.math.round(fTexCourdX * this.getWidthOrig(i) - this._iTextureWidth / 2);
                            iTexInBufY = akra.math.round(fTexCourdY * this.getHeightOrig(i) - this._iTextureHeight / 2);
                            this._pXY[i].iTexX = iTexInBufX / this.getWidthOrig(i);
                            this._pXY[i].iTexY = iTexInBufY / this.getHeightOrig(i);
                            iTexInBufX -= this._pXY[i].iX;
                            iTexInBufY -= this._pXY[i].iY;
                            this._pTmpBox1.setPosition(iTexInBufX, iTexInBufY, this._iTextureWidth, this._iTextureHeight);
                            var pPixelBox = this._pBuffer[i].getSubBox(this._pTmpBox1);
 {
                                akra.logger.setSourceLocation("terrain/MegaTexture.ts", 374);
                                akra.logger.log("Level #" + i + " write data:\n", pPixelBox.toString(), "\nOne Color: ", pPixelBox.data[0], pPixelBox.data[1], pPixelBox.data[2]);
                            }
                            ;
                            this._pTextures[i].getBuffer(0, 0).blitFromMemory(pPixelBox);
                        }
                    }
                    this._pXY[i].isUpdated = false;
                }
                this._fTexCourdXOld = fTexCourdX;
                this._fTexCourdYOld = fTexCourdY;
            };
            MegaTexture.prototype.applyForRender = function (pRenderPass) {
                pRenderPass.setUniform("CAMERA_COORD", this._v2fCameraCoord);
                for(var i = 0; i < this._pTextures.length; i++) {
                    pRenderPass.setUniform("textureCoord" + i, akra.vec2(this._pXY[i].iTexX, this._pXY[i].iTexY));
                    pRenderPass.setUniform("textureTerrainIsLoaded" + i, this._pXY[i].isLoaded);
                    pRenderPass.setTexture("TEXTURE" + i, this._pTextures[i]);
                    pRenderPass.setSamplerTexture("S_TERRAIN" + i, "TEXTURE" + i);
                }
            };
            MegaTexture.prototype.setBufferMapNULL = function (pBuffer) {
                pBuffer.set(this._pMapDataNULL, 0);
            };
            MegaTexture.prototype.setData = function (pBuffer, iX, iY, iWidth, iHeight, pBufferIn, iInX, iInY, iInWidth, iInHeight, iBlockWidth, iBlockHeight, iComponents) {
                iBlockHeight = akra.math.max(0, iBlockHeight);
                iBlockWidth = akra.math.max(0, iBlockWidth);
                iBlockHeight = akra.math.min(iBlockHeight, iHeight - iY, iInHeight - iInY);
                iBlockWidth = akra.math.min(iBlockWidth, iWidth - iX, iInWidth - iInX);
                if (pBuffer.length < ((iY + iBlockHeight - 1) * iWidth + iX + iBlockWidth) * iComponents) {
 {
                        akra.logger.setSourceLocation("terrain/MegaTexture.ts", 555);
                        akra.logger.error("Выход за предел массива 1");
                    }
                    ;
                }
                if (pBufferIn.length < ((iInY + iBlockHeight - 1) * iInWidth + iInX + iBlockWidth) * iComponents) {
 {
                        akra.logger.setSourceLocation("terrain/MegaTexture.ts", 559);
                        akra.logger.error("Выход за предел массива 2");
                    }
                    ;
                }
                for(var i = 0; i < iBlockHeight; i++) {
                    for(var j = 0; j < iBlockWidth; j++) {
                        for(var k = 0; k < iComponents; k++) {
                            pBuffer[((iY + i) * iWidth + iX + j) * iComponents + k] = pBufferIn[((iInY + i) * iInWidth + iInX + j) * iComponents + k];
                        }
                    }
                }
            };
            MegaTexture.prototype.setDataT = function (pBuffer, iX, iY, iWidth, iHeight, pBufferIn, iInX, iInY, iInWidth, iInHeight, iBlockWidth, iBlockHeight, iComponents) {
                iBlockHeight = akra.math.max(0, iBlockHeight);
                iBlockWidth = akra.math.max(0, iBlockWidth);
                iBlockHeight = akra.math.min(iBlockHeight, iHeight - iY, iInHeight - iInY);
                iBlockWidth = akra.math.min(iBlockWidth, iWidth - iX, iInWidth - iInX);
                if (pBuffer.length < ((iY + iBlockHeight - 1) * iWidth + iX + iBlockWidth) * iComponents) {
 {
                        akra.logger.setSourceLocation("terrain/MegaTexture.ts", 581);
                        akra.logger.error("Выход за предел массива 1");
                    }
                    ;
                }
                if (pBufferIn.length < ((iInY + iBlockHeight - 1) * iInWidth + iInX + iBlockWidth) * iComponents) {
 {
                        akra.logger.setSourceLocation("terrain/MegaTexture.ts", 584);
                        akra.logger.error("Выход за предел массива 2");
                    }
                    ;
                }
                var iLenStr = iBlockWidth * iComponents;
                var iStartIn = 0;
                var iStartOut = 0;
                for(var i = 0; i < iBlockHeight; i++) {
                    iStartIn = ((iInY + i) * iInWidth + iInX) * iComponents;
                    iStartOut = ((iY + i) * iWidth + iX) * iComponents;
                    if (pBufferIn.BYTES_PER_ELEMENT == 8) {
                        pBuffer.set(new Float64Array(pBufferIn.buffer.slice(iStartIn * 8, (iStartIn + iLenStr) * 8)), iStartOut);
                    } else if (pBufferIn.BYTES_PER_ELEMENT == 4) {
                        pBuffer.set(new Uint32Array(pBufferIn.buffer.slice(iStartIn * 4, (iStartIn + iLenStr) * 4)), iStartOut);
                    } else if (pBufferIn.BYTES_PER_ELEMENT == 2) {
                        pBuffer.set(new Uint16Array(pBufferIn.buffer.slice(iStartIn * 2, (iStartIn + iLenStr) * 2)), iStartOut);
                    } else {
                        pBuffer.set(new Uint8Array(pBufferIn.buffer.slice(iStartIn, iStartIn + iLenStr)), iStartOut);
                    }
                }
            };
            MegaTexture.prototype._setData = function (pBuffer, iX, iY, iWidth, iHeight, pBufferIn, iInX, iInY, iInWidth, iInHeight, iBlockWidth, iBlockHeight, iComponents) {
                this.setDataT(pBuffer, iX, iY, iWidth, iHeight, pBufferIn, iInX, iInY, iInWidth, iInHeight, iBlockWidth, iBlockHeight, iComponents);
            };
            MegaTexture.prototype._setDataBetweenBuffer = function (pBuffer, iX, iY, pBufferIn, iInX, iInY, iBlockWidth, iBlockHeight) {
                var iInWidth = this._iBufferWidth;
                var iInHeight = this._iBufferHeight;
                var iComponents = akra.pixelUtil.getNumElemBytes(this._eTextureFormat);
                var iWidth = this._iBufferWidth;
                var iHeight = this._iBufferHeight;
                this.setDataT(pBuffer, iX, iY, iWidth, iHeight, pBufferIn, iInX, iInY, iInWidth, iInHeight, iBlockWidth, iBlockHeight, iComponents);
            };
            MegaTexture.prototype._setDataBetweenBufferMap = function (pBuffer, iX, iY, pBufferIn, iInX, iInY, iBlockWidth, iBlockHeight) {
                var iInWidth = this._iBufferWidth / this._iBlockSize;
                var iInHeight = this._iBufferHeight / this._iBlockSize;
                var iComponents = 1;
                var iWidth = this._iBufferWidth / this._iBlockSize;
                var iHeight = this._iBufferHeight / this._iBlockSize;
                this.setDataT(pBuffer, iX, iY, iWidth, iHeight, pBufferIn, iInX, iInY, iInWidth, iInHeight, iBlockWidth, iBlockHeight, iComponents);
            };
            MegaTexture.prototype._setDataFromBlock = function (pBuffer, iX, iY, pBufferIn) {
                var iInX = 0;
                var iInY = 0;
                var iInWidth = this._iBlockSize;
                var iInHeight = this._iBlockSize;
                var iBlockWidth = this._iBlockSize;
                var iBlockHeight = this._iBlockSize;
                var iComponents = akra.pixelUtil.getNumElemBytes(this._eTextureFormat);
                var iWidth = 0;
                var iHeight = 0;
                if (pBuffer.length == this._iBufferWidth * this._iBufferHeight * iComponents) {
                    iWidth = this._iBufferWidth;
                    iHeight = this._iBufferHeight;
                } else if (pBuffer.length == this._iBufferWidth * this._iBufferHeight * iComponents / 4) {
                    iWidth = this._iBufferWidth / 2;
                    iHeight = this._iBufferHeight / 2;
                } else {
                    console.log("Странный размер массива", pBuffer, pBuffer.length, this._iBufferWidth * this._iBufferHeight * iComponents, this._iBufferWidth * this._iBufferHeight * iComponents / 4);
                }
                this.setDataT(pBuffer, iX, iY, iWidth, iHeight, pBufferIn, iInX, iInY, iInWidth, iInHeight, iBlockWidth, iBlockHeight, iComponents);
            };
            MegaTexture.prototype.getWidthOrig = function (iLevel) {
                return this._iTextureWidth << iLevel;
            };
            MegaTexture.prototype.getHeightOrig = function (iLevel) {
                return this._iTextureHeight << iLevel;
            };
            MegaTexture.prototype.getDataFromServer = function (iLevelTex, iOrigTexX, iOrigTexY, iWidth, iHeight, iAreaX, iAreaY, iAreaWidth, iAreaHeight) {
                var iOrigTexEndX = akra.math.ceil((iOrigTexX + iWidth) / this._iBlockSize) * this._iBlockSize;
                var iOrigTexEndY = akra.math.ceil((iOrigTexY + iHeight) / this._iBlockSize) * this._iBlockSize;
                iOrigTexX = akra.math.max(0, iOrigTexX);
                iOrigTexY = akra.math.max(0, iOrigTexY);
                iOrigTexX = akra.math.floor(iOrigTexX / this._iBlockSize) * this._iBlockSize;
                iOrigTexY = akra.math.floor(iOrigTexY / this._iBlockSize) * this._iBlockSize;
                iOrigTexEndX = akra.math.min(iOrigTexEndX, this.getWidthOrig(iLevelTex));
                iOrigTexEndY = akra.math.min(iOrigTexEndY, this.getHeightOrig(iLevelTex));
                var iAreaEndX = iAreaX + iAreaWidth;
                var iAreaEndY = iAreaY + iAreaHeight;
                iAreaX = akra.math.max(0, iAreaX);
                iAreaY = akra.math.max(0, iAreaY);
                iAreaEndX = akra.math.min(iAreaEndX, this.getWidthOrig(iLevelTex));
                iAreaEndY = akra.math.min(iAreaEndY, this.getHeightOrig(iLevelTex));
                var isLoaded = true;
                var me = this;
                var tCurrentTime = (me._pEngine.getTimer().absoluteTime * 1000) >>> 0;
                for(var i = iOrigTexY; i < iOrigTexEndY; i += this._iBlockSize) {
                    for(var j = iOrigTexX; j < iOrigTexEndX; j += this._iBlockSize) {
                        if (iLevelTex == 0) {
                            if (me._pBufferMap[iLevelTex][(i - me._pXY[iLevelTex].iY) / me._iBlockSize * (me._iTextureWidth / me._iBlockSize) + (j - me._pXY[iLevelTex].iX) / me._iBlockSize] != 0xFFFFFFFF) {
                                isLoaded = false;
                            }
                            if (tCurrentTime != 0 && tCurrentTime - me._pBufferMap[iLevelTex][(i - me._pXY[iLevelTex].iY) / me._iBlockSize * (me._iTextureWidth / me._iBlockSize) + (j - me._pXY[iLevelTex].iX) / me._iBlockSize] < 5000) {
                                continue;
                            }
                            if (me._pBufferMap[iLevelTex][(i - me._pXY[iLevelTex].iY) / me._iBlockSize * (me._iTextureWidth / me._iBlockSize) + (j - me._pXY[iLevelTex].iX) / me._iBlockSize] == 0xFFFFFFFF) {
                                continue;
                            }
                            me._pBufferMap[iLevelTex][(i - me._pXY[iLevelTex].iY) / me._iBlockSize * (me._iTextureWidth / me._iBlockSize) + (j - me._pXY[iLevelTex].iX) / me._iBlockSize] = tCurrentTime;
                        } else {
                            if (j >= iAreaX && j < iAreaEndX && i >= iAreaY && i < iAreaEndY && me._pBufferMap[iLevelTex][(i - me._pXY[iLevelTex].iY) / me._iBlockSize * (me._iBufferWidth / me._iBlockSize) + (j - me._pXY[iLevelTex].iX) / me._iBlockSize] != 0xFFFFFFFF) {
                                isLoaded = false;
                            }
                            if (tCurrentTime - me._pBufferMap[iLevelTex][(i - me._pXY[iLevelTex].iY) / me._iBlockSize * (me._iBufferWidth / me._iBlockSize) + (j - me._pXY[iLevelTex].iX) / me._iBlockSize] < 5000) {
                                continue;
                            }
                            if (me._pBufferMap[iLevelTex][(i - me._pXY[iLevelTex].iY) / me._iBlockSize * (me._iBufferWidth / me._iBlockSize) + (j - me._pXY[iLevelTex].iX) / me._iBlockSize] == 0xFFFFFFFF) {
                                continue;
                            }
                            me._pBufferMap[iLevelTex][(i - me._pXY[iLevelTex].iY) / me._iBlockSize * (me._iBufferWidth / me._iBlockSize) + (j - me._pXY[iLevelTex].iX) / me._iBlockSize] = tCurrentTime;
                        }
                        (function (iLev, iX, iY) {
                            var sPiecePath = me._sSurfaceTextures;
                            me._pRPC.proc('getMegaTexture', me._sSurfaceTextures, me.getWidthOrig(iLev), me.getHeightOrig(iLev), iX, iY, me._iBlockSize, me._iBlockSize, me._eTextureFormat, function (pError, pData) {
                                if (!((pError) === null)) {
 {
                                        akra.logger.setSourceLocation("terrain/MegaTexture.ts", 775);
                                        akra.logger.log(pError.message);
                                    }
                                    ;
                                    return;
                                }
                                var iXBuf;
                                var iYBuf;
                                if (iLev == 0) {
                                    iXBuf = iX - me._pXY[iLev].iX;
                                    iYBuf = iY - me._pXY[iLev].iY;
                                    if (iXBuf < 0 || iXBuf > me._iBufferWidth / 2 - me._iBlockSize || iYBuf < 0 || iYBuf > me._iBufferHeight / 2 - me._iBlockSize) {
                                        return;
                                    }
                                    me._pBufferMap[iLev][iYBuf / me._iBlockSize * (me._iTextureWidth / me._iBlockSize) + iXBuf / me._iBlockSize] = 0xFFFFFFFF;
                                } else {
                                    iXBuf = iX - me._pXY[iLev].iX;
                                    iYBuf = iY - me._pXY[iLev].iY;
                                    if (iLev == 2 && iY == 0) {
                                    }
                                    if (iXBuf < 0 || iXBuf > me._iBufferWidth - me._iBlockSize || iYBuf < 0 || iYBuf > me._iBufferHeight - me._iBlockSize) {
                                        return;
                                    }
                                    me._pBufferMap[iLev][iYBuf / me._iBlockSize * (me._iBufferWidth / me._iBlockSize) + iXBuf / me._iBlockSize] = 0xFFFFFFFF;
                                }
                                me._pTmpBox1.setPosition(0, 0, me._iBlockSize, me._iBlockSize);
                                me._pTmpPixelBox.refresh(me._pTmpBox1, me._eTextureFormat, pData);
                                me._pTmpBox1.setPosition(iXBuf, iYBuf, me._iBlockSize, me._iBlockSize);
                                var pSubBox = me._pBuffer[iLev].getSubBox(me._pTmpBox1);
                                akra.pixelUtil.bulkPixelConversion(me._pTmpPixelBox, pSubBox);
                                me._pXY[iLev].isUpdated = true;
                            });
                        })(iLevelTex, j, i);
                    }
                }
                me._pXY[iLevelTex].isLoaded = isLoaded;
            };
            return MegaTexture;
        })();
        terrain.MegaTexture = MegaTexture;        
    })(akra.terrain || (akra.terrain = {}));
    var terrain = akra.terrain;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    ;
    ;
    function createSingleStripGrid(pIndexValues, iXVerts, iYVerts, iXStep, iYStep, iSride, iFlags) {
        var iTotalStrips = iYVerts - 1;
        var iTotalIndexesPerStrip = iXVerts << 1;
        var iTotalIndexes = (iTotalStrips * iTotalIndexesPerStrip) + (iTotalStrips << 1) - 2;
        if (pIndexValues.length < iTotalIndexes) {
            return 0;
        }
        var iIndex = 0;
        var iStartVert = 0;
        var iLineStep = iYStep * iSride;
        for(var j = 0; j < iTotalStrips; ++j) {
            var k = 0;
            var iVert = iStartVert;
            for(k = 0; k < iXVerts; ++k) {
                pIndexValues[iIndex++] = iVert;
                pIndexValues[iIndex++] = iVert + iLineStep;
                iVert += iXStep;
            }
            iStartVert += iLineStep;
            if (j + 1 < iTotalStrips) {
                pIndexValues[iIndex++] = (iVert - iXStep) + iLineStep;
                pIndexValues[iIndex++] = iStartVert;
            }
        }
        return iTotalIndexes;
    }
    akra.createSingleStripGrid = createSingleStripGrid;
    function getCountIndexForStripGrid(iXVerts, iYVerts) {
        var iTotalStrips = iYVerts - 1;
        var iTotalIndexesPerStrip = iXVerts << 1;
        var iTotalIndexes = (iTotalStrips * iTotalIndexesPerStrip) + (iTotalStrips << 1) - 2;
        return iTotalIndexes;
    }
    akra.getCountIndexForStripGrid = getCountIndexForStripGrid;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (terrain) {
        var TerrainSection = (function (_super) {
            __extends(TerrainSection, _super);
            function TerrainSection(pScene, eType) {
                if (typeof eType === "undefined") { eType = akra.EEntityTypes.TERRAIN_SECTION; }
                        _super.call(this, pScene, eType);
                this._pTerrainSystem = null;
                this._iVertexID = 0;
                this._iHeightMapX = 0;
                this._iHeightMapY = 0;
                this._iSectorX = 0;
                this._iSectorY = 0;
                this._iXVerts = 0;
                this._iYVerts = 0;
                this._pWorldRect = new akra.geometry.Rect3d();
                this._pRenderableObject = null;
                this._pVertexDescription = [
                    akra.VE_FLOAT3(akra.DeclarationUsages.POSITION), 
                    akra.VE_FLOAT2(akra.DeclarationUsages.TEXCOORD)
                ];
            }
            Object.defineProperty(TerrainSection.prototype, "sectorX", {
                get: function () {
                    return this._iSectorX;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainSection.prototype, "sectorY", {
                get: function () {
                    return this._iSectorY;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainSection.prototype, "terrainSystem", {
                get: function () {
                    return this._pTerrainSystem;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainSection.prototype, "sectionIndex", {
                get: function () {
                    return (this._iSectorY * this._pTerrainSystem.sectorCountX + this._iSectorX);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainSection.prototype, "heightX", {
                get: function () {
                    return akra.math.abs(this._pWorldRect.x1 - this._pWorldRect.x0);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainSection.prototype, "heightY", {
                get: function () {
                    return akra.math.abs(this._pWorldRect.y1 - this._pWorldRect.y0);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainSection.prototype, "vertexDescription", {
                get: function () {
                    return this._pVertexDescription;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainSection.prototype, "totalRenderable", {
                get: function () {
                    return !((this._pRenderableObject) === null) ? 1 : 0;
                },
                enumerable: true,
                configurable: true
            });
            TerrainSection.prototype.getRenderable = function (i) {
                return this._pRenderableObject;
            };
            TerrainSection.prototype._internalCreate = function (pParentSystem, iSectorX, iSectorY, iHeightMapX, iHeightMapY, iXVerts, iYVerts, pWorldRect) {
                var bResult = false;
                this._pTerrainSystem = pParentSystem;
                this._iXVerts = iXVerts;
                this._iYVerts = iYVerts;
                this._iSectorX = iSectorX;
                this._iSectorY = iSectorY;
                this._pWorldRect.x0 = pWorldRect.x0;
                this._pWorldRect.x1 = pWorldRect.x1;
                this._pWorldRect.y0 = pWorldRect.y0;
                this._pWorldRect.y1 = pWorldRect.y1;
                this._iHeightMapX = iHeightMapX;
                this._iHeightMapY = iHeightMapY;
                bResult = this._createRenderDataForVertexAndIndex();
                bResult = bResult && this._buildVertexBuffer();
                bResult = bResult && this._buildIndexBuffer();
                this.accessLocalBounds().set(this._pWorldRect.x0, this._pWorldRect.x1, this._pWorldRect.y0, this._pWorldRect.y1, this._pWorldRect.z0, this._pWorldRect.z1);
                if (bResult) {
                    this.attachToParent(this._pTerrainSystem);
                    this.setInheritance(akra.ENodeInheritance.ALL);
                    return true;
                } else {
                    return false;
                }
            };
            TerrainSection.prototype._createRenderable = function () {
                if (((this._pRenderableObject) === null)) {
                    this._pRenderableObject = new akra.render.RenderableObject();
                    this._pRenderableObject._setup(this.scene.getManager().getEngine().getRenderer());
                }
            };
            TerrainSection.prototype._createRenderDataForVertexAndIndex = function () {
                var pRenderable = this.getRenderable();
                if (((pRenderable) === null)) {
                    return true;
                }
 {
                    akra.logger.setSourceLocation("terrain/TerrainSection.ts", 128);
                    akra.logger.assert(pRenderable.data === null, "У терраин сектиона уже созданы данные");
                }
                ;
                pRenderable._setRenderData(this.terrainSystem.dataFactory.getEmptyRenderData(akra.EPrimitiveTypes.TRIANGLESTRIP, 0));
                if (((pRenderable.data) === null)) {
                    return false;
                }
                return true;
            };
            TerrainSection.prototype._buildVertexBuffer = function () {
                this._pWorldRect.z0 = akra.MAX_FLOAT64;
                this._pWorldRect.z1 = akra.MIN_FLOAT64;
                if (!((this.getRenderable()) === null)) {
                    var pVerts = new Array(this._iXVerts * this._iYVerts * (3 + 3 + 2));
                    var v3fNormal = new akra.Vec3();
                    var v2fCellSize = new akra.Vec2();
                    v2fCellSize.set(this.heightX / (this._iXVerts - 1), this.heightY / (this._iYVerts - 1));
                    var v2fVert = new akra.Vec2();
                    v2fVert.set(0.0, 0.0);
                    for(var y = 0; y < this._iYVerts; ++y) {
                        v2fVert.set(this._pWorldRect.x0, y * v2fCellSize.y + this._pWorldRect.y0);
                        for(var x = 0; x < this._iXVerts; ++x) {
                            var fHeight = this.terrainSystem.readWorldHeight(this._iHeightMapX + x, this._iHeightMapY + y);
                            pVerts[((y * this._iXVerts) + x) * 5 + 0] = v2fVert.x;
                            pVerts[((y * this._iXVerts) + x) * 5 + 1] = v2fVert.y;
                            pVerts[((y * this._iXVerts) + x) * 5 + 2] = fHeight;
                            pVerts[((y * this._iXVerts) + x) * 5 + 3] = (this._iSectorX + x / (this._iXVerts - 1)) / this.terrainSystem.sectorCountX;
                            pVerts[((y * this._iXVerts) + x) * 5 + 4] = (this._iSectorY + y / (this._iYVerts - 1)) / this.terrainSystem.sectorCountY;
                            this._pWorldRect.z0 = akra.math.min(this._pWorldRect.z0, fHeight);
                            this._pWorldRect.z1 = akra.math.max(this._pWorldRect.z1, fHeight);
                            v2fVert.x += v2fCellSize.x;
                        }
                    }
                    this._iVertexID = this.getRenderable().data.allocateData(this.vertexDescription, new Float32Array(pVerts));
                } else {
                    for(var y = 0; y < this._iYVerts; ++y) {
                        for(var x = 0; x < this._iXVerts; ++x) {
                            var fHeight = this.terrainSystem.readWorldHeight(this._iHeightMapX + x, this._iHeightMapY + y);
                            this._pWorldRect.z0 = akra.math.min(this._pWorldRect.z0, fHeight);
                            this._pWorldRect.z1 = akra.math.max(this._pWorldRect.z1, fHeight);
                        }
                    }
                }
                return true;
            };
            TerrainSection.prototype._buildIndexBuffer = function () {
                if (!((this.getRenderable()) === null)) {
                    var pIndexList = new Float32Array(akra.getCountIndexForStripGrid(this._iXVerts, this._iYVerts));
                    akra.createSingleStripGrid(pIndexList, this._iXVerts, this._iYVerts, 1, 1, this._iYVerts, 0);
                    this.getRenderable().data.allocateIndex(([
                        akra.VE_FLOAT(akra.DeclarationUsages.INDEX0)
                    ]), pIndexList);
                    this.getRenderable().data.index(this._iVertexID, akra.DeclarationUsages.INDEX0);
                }
                return true;
            };
            return TerrainSection;
        })(akra.scene.SceneObject);
        terrain.TerrainSection = TerrainSection;        
    })(akra.terrain || (akra.terrain = {}));
    var terrain = akra.terrain;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (terrain) {
        var Terrain = (function (_super) {
            __extends(Terrain, _super);
            function Terrain(pScene, eType) {
                if (typeof eType === "undefined") { eType = akra.EEntityTypes.TERRAIN; }
                        _super.call(this, pScene, eType);
                this._pEngine = null;
                this._pWorldExtents = new akra.geometry.Rect3d();
                this._v3fWorldSize = new akra.Vec3();
                this._v3fMapScale = new akra.Vec3();
                this._pSectorArray = null;
                this._pDataFactory = null;
                this._v2fSectorSize = new akra.Vec2();
                this._pHeightTable = null;
                this._pNormalMap = null;
                this._pNormalImage = null;
                this._pTempNormalColor = new akra.Color();
                this._pMegaTexures = null;
                this._fScale = 0.0;
                this._fLimit = 0.0;
                this._pDefaultRenderMethod = null;
                this._pRenderMethod = null;
                this._pEngine = pScene.getManager().getEngine();
                this._pDataFactory = akra.render.createRenderDataCollection(this._pEngine, akra.ERenderDataBufferOptions.VB_READABLE);
            }
            Object.defineProperty(Terrain.prototype, "dataFactory", {
                get: function () {
                    return this._pDataFactory;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Terrain.prototype, "tessellationScale", {
                get: function () {
                    return this._fScale;
                },
                set: function (fScale) {
                    this._fScale = fScale;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Terrain.prototype, "tessellationLimit", {
                get: function () {
                    return this._fLimit;
                },
                set: function (fLimit) {
                    this._fLimit = fLimit;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Terrain.prototype, "worldExtents", {
                get: function () {
                    return this._pWorldExtents;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Terrain.prototype, "worldSize", {
                get: function () {
                    return this._v3fWorldSize;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Terrain.prototype, "mapScale", {
                get: function () {
                    return this._v3fMapScale;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Terrain.prototype, "sectorCountX", {
                get: function () {
                    return this._iSectorCountX;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Terrain.prototype, "sectorCountY", {
                get: function () {
                    return this._iSectorCountY;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Terrain.prototype, "sectorSize", {
                get: function () {
                    return this._v2fSectorSize;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Terrain.prototype, "tableWidth", {
                get: function () {
                    return this._iTableWidth;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Terrain.prototype, "tableHeight", {
                get: function () {
                    return this._iTableHeight;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Terrain.prototype, "sectorShift", {
                get: function () {
                    return this._iSectorShift;
                },
                enumerable: true,
                configurable: true
            });
            Terrain.prototype._initSystemData = function () {
                if (((this._pDefaultRenderMethod) === null)) {
                    var pMethod = null, pEffect = null;
                    var pEngine = this._pEngine, pRmgr = pEngine.getResourceManager();
                    pMethod = pRmgr.renderMethodPool.findResource(".terrain_render");
                    if (!((pMethod) === null)) {
                        this._pDefaultRenderMethod = pMethod;
                        return true;
                    }
                    pEffect = pRmgr.createEffect(".terrain_render");
                    pEffect.addComponent("akra.system.terrain");
                    pMethod = pRmgr.createRenderMethod(".terrain_render");
                    pMethod.effect = pEffect;
                    this._pDefaultRenderMethod = pMethod;
                }
                return true;
            };
            Terrain.prototype.init = function (pMap, worldExtents, iShift, iShiftX, iShiftY, sSurfaceTextures, pRootNode) {
                if (typeof pRootNode === "undefined") { pRootNode = null; }
                if (!((pRootNode) === null)) {
                    if (!this.attachToParent(pRootNode)) {
                        return false;
                    }
                }
                this._initSystemData();
                this._iSectorShift = iShift;
                this._iSectorUnits = 1 << iShift;
                this._iSectorVerts = this._iSectorUnits + 1;
                this._pWorldExtents = new akra.geometry.Rect3d(worldExtents.x0, worldExtents.x1, worldExtents.y0, worldExtents.y1, worldExtents.z0, worldExtents.z1);
                this._pWorldExtents.normalize();
                this._v3fWorldSize = this._pWorldExtents.size(this._v3fWorldSize);
                this._iSectorCountX = 1 << iShiftX;
                this._iSectorCountY = 1 << iShiftY;
                this._iTableWidth = this._iSectorCountX * this._iSectorUnits + 1;
                this._iTableHeight = this._iSectorCountY * this._iSectorUnits + 1;
                this._v2fSectorSize.set(this._v3fWorldSize.x / this._iSectorCountX, this._v3fWorldSize.y / this._iSectorCountY);
                this._v3fMapScale.x = this._v3fWorldSize.x / this._iTableWidth;
                this._v3fMapScale.y = this._v3fWorldSize.y / this._iTableHeight;
                this._v3fMapScale.z = this._v3fWorldSize.z;
                this._buildHeightAndNormalTables(pMap["height"], pMap["normal"]);
                for(var sImgMap in pMap) {
                    if (pMap[sImgMap].destroyResource) {
                        pMap[sImgMap].destroyResource();
                    }
                }
                if (!this._allocateSectors()) {
 {
                        akra.logger.setSourceLocation("terrain/Terrain.ts", 194);
                        akra.logger.error("Can not alloacte terrain sections");
                    }
                    ;
                    return false;
                }
                this.computeBoundingBox();
                this._pMegaTexures = new terrain.MegaTexture(this._pEngine, this, sSurfaceTextures);
                return true;
            };
            Terrain.prototype.findSection = function (iX, iY) {
                var pSection = null;
                if (iX >= 0 && iX < this._iSectorCountX && iY >= 0 && iY < this._iSectorCountY) {
                    pSection = this._pSectorArray[(iY * this._iSectorCountX) + iX];
                } else {
                }
                return pSection;
            };
            Terrain.prototype._allocateSectors = function () {
                var v2fSectorPos = new akra.Vec2();
                var r2fSectorRect = new akra.geometry.Rect2d();
                this._pSectorArray = new Array(this._iSectorCountX * this._iSectorCountY);
                for(var y = 0; y < this._iSectorCountY; ++y) {
                    for(var x = 0; x < this._iSectorCountX; ++x) {
                        v2fSectorPos.set(this._pWorldExtents.x0 + (x * this._v2fSectorSize.x), this._pWorldExtents.y0 + (y * this._v2fSectorSize.y));
                        r2fSectorRect.set(v2fSectorPos.x, v2fSectorPos.x + this._v2fSectorSize.x, v2fSectorPos.y, v2fSectorPos.y + this._v2fSectorSize.y);
                        var iXPixel = x << this._iSectorShift;
                        var iYPixel = y << this._iSectorShift;
                        var iIndex = (y * this._iSectorCountX) + x;
                        this._pSectorArray[iIndex] = this.scene.createTerrainSection();
                        if (!this._pSectorArray[iIndex]._internalCreate(this, x, y, iXPixel, iYPixel, this._iSectorVerts, this._iSectorVerts, r2fSectorRect)) {
                            return false;
                        }
                    }
                }
                this._setRenderMethod(this._pDefaultRenderMethod);
                return true;
            };
            Terrain.prototype._setRenderMethod = function (pRenderMethod) {
                this._pRenderMethod = pRenderMethod;
                if (this._pRenderMethod) {
                    this._pRenderMethod.addRef();
                }
                var pSection = null;
                for(var i = 0; i < this._pSectorArray.length; i++) {
                    pSection = this._pSectorArray[i];
                    pSection._createRenderable();
                    pSection.getRenderable().renderMethod = pRenderMethod;
                    this.connect(pSection.getRenderable().getTechnique(), "render", "_onRender", akra.EEventTypes.UNICAST);
                }
            };
            Terrain.prototype._buildHeightAndNormalTables = function (pImageHightMap, pImageNormalMap) {
                var fHeight = 0;
                var iComponents = 4;
                this._pHeightTable = null;
                var iMaxY = this._iTableHeight;
                var iMaxX = this._iTableWidth;
                var pColorData = new Uint8Array(4 * iMaxY * iMaxX);
                this._pHeightTable = new Array(iMaxX * iMaxY);
                if (pImageHightMap.isResourceLoaded()) {
                    if (pImageHightMap.width !== iMaxX && pImageHightMap.height !== iMaxY) {
 {
                            akra.logger.setSourceLocation("terrain/Terrain.ts", 299);
                            akra.logger.warning("Размеры карты высот не совпадают с другими размерами. Нужно: " + iMaxX + "x" + iMaxY + ". Есть: " + pImageHightMap.width + "x" + pImageHightMap.height);
                        }
                        ;
                        return;
                    }
                    for(var iY = 0; iY < iMaxY; iY++) {
                        for(var iX = 0; iX < iMaxX; iX++) {
                            fHeight = pImageHightMap.getColorAt(this._pTempNormalColor, iX, iY).r;
                            fHeight = (fHeight * this._v3fMapScale.z) + this._pWorldExtents.z0;
                            this._pHeightTable[iY * iMaxX + iX] = fHeight;
                        }
                    }
                } else {
 {
                        akra.logger.setSourceLocation("terrain/Terrain.ts", 311);
                        akra.logger.warning("Карта высот не загружена");
                    }
                }
                if (pImageNormalMap.isResourceLoaded()) {
                    this._pNormalMap = this._pEngine.getResourceManager().createTexture(".terrain-normal-texture" + ((++/*checked (origin: akra)>>*/akra._total)));
                    this._pNormalMap.loadImage(pImageNormalMap);
                    this._pNormalImage = pImageNormalMap;
                } else {
 {
                        akra.logger.setSourceLocation("terrain/Terrain.ts", 320);
                        akra.logger.warning("Карта нормалей не загружена");
                    }
                }
            };
            Terrain.prototype.readWorldHeight = function (iMapX, iMapY) {
                if (arguments.length == 2) {
                    if (iMapX >= this._iTableWidth) {
                        iMapX = this._iTableWidth - 1;
                    }
                    if (iMapY >= this._iTableHeight) {
                        iMapY = this._iTableHeight - 1;
                    }
                    return this._pHeightTable[(iMapY * this._iTableWidth) + iMapX];
                } else {
                    var iMapIndex = iMapX;
 {
                        akra.logger.setSourceLocation("terrain/Terrain.ts", 339);
                        akra.logger.assert(iMapIndex < this._iTableWidth * this._iTableHeight, "invalid index");
                    }
                    ;
                    return this._pHeightTable[iMapIndex];
                }
            };
            Terrain.prototype._tableIndex = function (iMapX, iMapY) {
                if (iMapX >= this._iTableWidth) {
                    iMapX = this._iTableWidth - 1;
                }
                if (iMapY >= this._iTableHeight) {
                    iMapY = this._iTableHeight - 1;
                }
                return (iMapY * this._iTableWidth) + iMapX;
            };
            Terrain.prototype.readWorldNormal = function (v3fNormal, iMapX, iMapY) {
                if (iMapX >= this._pNormalImage.width) {
                    iMapX = this._pNormalImage.width - 1;
                }
                if (iMapY >= this._pNormalImage.height) {
                    iMapY = this._pNormalImage.height - 1;
                }
                this._pNormalImage.getColorAt(this._pTempNormalColor, iMapX, iMapY);
                v3fNormal.set(this._pTempNormalColor.r, this._pTempNormalColor.g, this._pTempNormalColor.b);
                return v3fNormal;
            };
            Terrain.prototype.calcWorldHeight = function (fWorldX, fWorldY) {
                var fMapX = (fWorldX - this._pWorldExtents.x0) / this._pWorldExtents.sizeX();
                var fMapY = (fWorldY - this._pWorldExtents.y0) / this._pWorldExtents.sizeY();
                return this._calcMapHeight(fMapX, fMapY);
            };
            Terrain.prototype.calcWorldNormal = function (v3fNormal, fWorldX, fWorldY) {
                var fMapX = (fWorldX - this._pWorldExtents.x0) / this._pWorldExtents.sizeX();
                var fMapY = (fWorldY - this._pWorldExtents.y0) / this._pWorldExtents.sizeY();
                return this._calcMapNormal(v3fNormal, fMapX, fMapY);
            };
            Terrain.prototype._calcMapHeight = function (fMapX, fMapY) {
                var fTempMapX = fMapX * (this._iTableWidth - 1);
                var fTempMapY = fMapY * (this._iTableHeight - 1);
                var iMapX0 = akra.math.floor(fTempMapX);
                var iMapY0 = akra.math.floor(fTempMapY);
                fTempMapX -= iMapX0;
                fTempMapY -= iMapY0;
                iMapX0 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iMapX0), (this._iTableWidth - 1))));
                iMapY0 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iMapY0), (this._iTableHeight - 1))));
                var iMapX1 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iMapX0 + 1), (this._iTableWidth - 1))));
                var iMapY1 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iMapY0 + 1), (this._iTableHeight - 1))));
                var fH0 = this.readWorldHeight(iMapX0, iMapY0);
                var fH1 = this.readWorldHeight(iMapX1, iMapY0);
                var fH2 = this.readWorldHeight(iMapX0, iMapY1);
                var fH3 = this.readWorldHeight(iMapX1, iMapY1);
                var fAvgLo = (fH1 * fTempMapX) + (fH0 * (1.0 - fTempMapX));
                var fAvgHi = (fH3 * fTempMapX) + (fH2 * (1.0 - fTempMapX));
                return (fAvgHi * fTempMapY) + (fAvgLo * (1.0 - fTempMapY));
            };
            Terrain.prototype._calcMapNormal = function (v3fNormal, fMapX, fMapY) {
                var fTempMapX = fMapX * (this._pNormalMap.width - 1);
                var fTempMapY = fMapY * (this._pNormalMap.height - 1);
                var iMapX0 = akra.math.floor(fTempMapX);
                var iMapY0 = akra.math.floor(fTempMapY);
                fTempMapX -= iMapX0;
                fTempMapY -= iMapY0;
                iMapX0 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iMapX0), (this._pNormalMap.width - 1))));
                iMapY0 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iMapY0), (this._pNormalMap.height - 1))));
                var iMapX1 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iMapX0 + 1), (this._pNormalMap.width - 1))));
                var iMapY1 = (/*checked (origin: math)>>*/akra.math.max((0), /*checked (origin: math)>>*/akra.math.min((iMapY0 + 1), (this._pNormalMap.height - 1))));
                var v3fH0 = akra.math.vec3();
                this.readWorldNormal(v3fH0, iMapX0, iMapY0);
                var v3fH1 = akra.math.vec3();
                this.readWorldNormal(v3fH1, iMapX1, iMapY0);
                var v3fH2 = akra.math.vec3();
                this.readWorldNormal(v3fH2, iMapX0, iMapY1);
                var v3fH3 = akra.math.vec3();
                this.readWorldNormal(v3fH3, iMapX1, iMapY1);
                var v3fAvgLo = akra.math.vec3();
                v3fAvgLo.set(v3fH1.scale(fTempMapX));
                v3fAvgLo.add(v3fH0.scale(1.0 - fTempMapX));
                var v3fAvgHi = akra.math.vec3();
                v3fAvgHi.set(v3fH3.scale(fTempMapX));
                v3fAvgHi.add(v3fH2.scale(1.0 - fTempMapX));
                v3fNormal.set(v3fAvgHi.scale(fTempMapY));
                v3fNormal.add(v3fAvgLo.scale(1.0 - fTempMapY));
                v3fNormal.normalize();
                return v3fNormal;
            };
            Terrain.prototype._generateTerrainImage = function (pTerrainImage, pTextureList, iTextureCount) {
 {
                    akra.logger.setSourceLocation("terrain/Terrain.ts", 468);
                    akra.logger.criticalError("нехуй");
                }
                ;
                var bSuccess = false;
                var x, y, i;
                var iImage_width = pTerrainImage.width;
                var iImage_height = pTerrainImage.height;
                var fUStep = 1.0 / (iImage_width - 1);
                var fVStep = 1.0 / (iImage_height - 1);
                var pSamples = new Array(iTextureCount);
                for(y = 0; y < iImage_height; ++y) {
                    for(x = 0; x < iImage_width; ++x) {
                        var fU = x * fUStep;
                        var fV = y * fVStep;
                        var fTotalBlend = 0.0;
                        var fMap_height = this._calcMapHeight(fU, fV);
                        var v3fNormal = new akra.Vec3();
                        this._calcMapNormal(v3fNormal, fU, fV);
                        for(i = 0; i < iTextureCount; ++i) {
                            var fElevationScale = 0.0;
                            var fSlopeScale = 0.0;
                            if (fMap_height >= pTextureList[i].elevation.minElevation && fMap_height <= pTextureList[i].elevation.maxElevation) {
                                var fSpan = pTextureList[i].elevation.maxElevation - pTextureList[i].elevation.minElevation;
                                fElevationScale = fMap_height - pTextureList[i].elevation.minElevation;
                                fElevationScale *= 1.0 / fSpan;
                                fElevationScale -= 0.5;
                                fElevationScale *= 2.0;
                                fElevationScale *= fElevationScale;
                                fElevationScale = 1.0 - fElevationScale;
                            }
                            if (v3fNormal.z >= pTextureList[i].elevation.minNormalZ && v3fNormal.z <= pTextureList[i].elevation.maxNormalZ) {
                                var fSpan = pTextureList[i].elevation.maxNormalZ - pTextureList[i].elevation.minNormalZ;
                                fSlopeScale = v3fNormal.z - pTextureList[i].elevation.minNormalZ;
                                fSlopeScale *= 1.0 / fSpan;
                                fSlopeScale -= 0.5;
                                fSlopeScale *= 2.0;
                                fSlopeScale *= fSlopeScale;
                                fSlopeScale = 1.0 - fSlopeScale;
                            }
                            pSamples[i] = {
                                fScale: 0,
                                iColor: 0
                            };
                            pSamples[i].fScale = pTextureList[i].elevation.strength * fElevationScale * fSlopeScale;
                            fTotalBlend += pSamples[i].fScale;
                            pTextureList[i].pImage.sampleColor(fU * pTextureList[i].fUvScale, fV * pTextureList[i].fUvScale, pSamples[i].iColor);
                        }
                        var fBlendScale = 1.0 / fTotalBlend;
                        var fRed = 0.0;
                        var fGreen = 0.0;
                        var fBlue = 0.0;
                        var fAlpha = 0.0;
                        for(i = 0; i < iTextureCount; ++i) {
                            var fScale = pSamples[i].fScale * fBlendScale;
                            fBlue += (pSamples[i].iColor & 0xff) * fScale;
                            fGreen += ((pSamples[i].iColor >> 8) & 0xff) * fScale;
                            fRed += ((pSamples[i].iColor >> 16) & 0xff) * fScale;
                            fAlpha += ((pSamples[i].iColor >> 24) & 0xff) * fScale;
                        }
                        var fR = (/*checked (origin: math)>>*/akra.math.max((0.0), /*checked (origin: math)>>*/akra.math.min((fRed), (255.0)))) / 255.;
                        var fG = (/*checked (origin: math)>>*/akra.math.max((0.0), /*checked (origin: math)>>*/akra.math.min((fGreen), (255.0)))) / 255.;
                        var fB = (/*checked (origin: math)>>*/akra.math.max((0.0), /*checked (origin: math)>>*/akra.math.min((fBlue), (255.0)))) / 255.;
                        var fA = (/*checked (origin: math)>>*/akra.math.max((0.0), /*checked (origin: math)>>*/akra.math.min((fAlpha), (255.0)))) / 255.;
                        this._pTempNormalColor.set(fR, fG, fB, fA);
                        pTerrainImage.setColorAt(this._pTempNormalColor, x, y);
                    }
                }
            };
            Terrain.prototype._computeWeight = function (fValue, fMinExtent, fMaxExtent) {
 {
                    akra.logger.setSourceLocation("terrain/Terrain.ts", 576);
                    akra.logger.criticalError("нехуй");
                }
                ;
                var fWeight = 0.0;
                if (fValue >= fMinExtent && fValue <= fMaxExtent) {
                    var fSpan = fMaxExtent - fMinExtent;
                    fWeight = fValue - fMinExtent;
                    fWeight *= 1.0 / fSpan;
                    fWeight -= 0.5;
                    fWeight *= 2.0;
                    fWeight *= fWeight;
                    fWeight = 1.0 - akra.math.absoluteValue(fWeight);
                    fWeight = (/*checked (origin: math)>>*/akra.math.max((0.001), /*checked (origin: math)>>*/akra.math.min((fWeight), (1.0))));
                }
                return fWeight;
            };
            Terrain.prototype._generateBlendImage = function (pBlendImage, pElevationData, iElevationDataCount, fnCallback) {
 {
                    akra.logger.setSourceLocation("terrain/Terrain.ts", 621);
                    akra.logger.criticalError("нехуй");
                }
                ;
                var bSuccess = false;
                var x, y, i;
                var pColor = new Uint8Array(4);
 {
                    akra.logger.setSourceLocation("terrain/Terrain.ts", 627);
                    akra.logger.assert(pBlendImage != null, "pBlendImage is not valid");
                }
                ;
                iElevationDataCount = akra.math.min(iElevationDataCount, 4);
                var iImg_width = pBlendImage.getWidth();
                var iImg_height = pBlendImage.getHeight();
                var fUStep = 1.0 / (iImg_width - 1);
                var fVStep = 1.0 / (iImg_height - 1);
                var v4fMask = new Array(4);
                v4fMask[0] = new akra.Vec4();
                v4fMask[0].set(1.0, 0.0, 0.0, 0.0);
                v4fMask[1] = new akra.Vec4();
                v4fMask[1].set(0.0, 1.0, 0.0, 0.0);
                v4fMask[2] = new akra.Vec4();
                v4fMask[2].set(0.0, 0.0, 1.0, 0.0);
                v4fMask[3] = new akra.Vec4();
                v4fMask[3].set(0.0, 0.0, 0.0, 1.0);
                for(y = 0; y < iImg_height; y++) {
                    for(x = 0; x < iImg_width; x++) {
                        var fTotalBlend = 0.0;
                        var v4fBlendFactors = new akra.Vec4();
                        v4fBlendFactors.set(0.0, 0.0, 0.0, 0.0);
                        if (iElevationDataCount == 3) {
                            v4fBlendFactors.w = 255;
                        }
                        var fU = x * fUStep;
                        var fV = y * fVStep;
                        var fMap_height = this._calcMapHeight(fU, fV);
                        var v3fNormal = new akra.Vec3();
                        var v4fTemp = new akra.Vec4();
                        this._calcMapNormal(v3fNormal, fU, fV);
                        for(i = 0; i < iElevationDataCount; ++i) {
                            var fElevationScale = this._computeWeight(fMap_height, pElevationData[i].fMinElevation, pElevationData[i].fMaxElevation);
                            var fSlopeScale = this._computeWeight(v3fNormal.z, pElevationData[i].fMinNormalZ, pElevationData[i].fMaxNormalZ);
                            var fScale = pElevationData[i].fStrength * fElevationScale * fSlopeScale;
                            v4fTemp.set(v4fMask[i]);
                            v4fTemp.scale(fScale);
                            v4fBlendFactors.add(v4fTemp);
                            fTotalBlend += fScale;
                        }
                        var fBlendScale = 255.0 / fTotalBlend;
                        v4fBlendFactors.scale(fBlendScale);
                        pColor[0] = (/*checked (origin: math)>>*/akra.math.max((0.0), /*checked (origin: math)>>*/akra.math.min((v4fBlendFactors.x), (255.0))));
                        pColor[1] = (/*checked (origin: math)>>*/akra.math.max((0.0), /*checked (origin: math)>>*/akra.math.min((v4fBlendFactors.y), (255.0))));
                        pColor[2] = (/*checked (origin: math)>>*/akra.math.max((0.0), /*checked (origin: math)>>*/akra.math.min((v4fBlendFactors.z), (255.0))));
                        pColor[3] = (/*checked (origin: math)>>*/akra.math.max((0.0), /*checked (origin: math)>>*/akra.math.min((v4fBlendFactors.w), (255.0))));
                        pBlendImage.setPixelRGBA(x, iImg_height - y - 1, pColor);
                    }
                }
            };
            Terrain.prototype._setTessellationParameters = function (fScale, fLimit) {
                this._fScale = fScale;
                this._fLimit = fLimit;
            };
            Terrain.prototype.prepareForRender = function (pViewport) {
                this._pMegaTexures.prepareForRender(pViewport);
            };
            Terrain.prototype.reset = function () {
            };
            Terrain.prototype.readUserInput = function () {
                if (this._fLimit < 0.001) {
                    this._fLimit = 0.001;
                }
                if (this._fScale < 0.001) {
                    this._fScale = 0.001;
                }
                document.getElementById('setinfo4').innerHTML = "fScale1 " + this._fScale;
                document.getElementById('setinfo5').innerHTML = "fLimit1 " + this._fLimit;
            };
            Terrain.prototype.computeBoundingBox = function () {
                var fX0, fY0, fZ0, fX1, fY1, fZ1;
                fX0 = fY0 = fZ0 = akra.MAX_FLOAT64;
                fX1 = fY1 = fZ1 = akra.MIN_FLOAT64;
                for(var i = 0; i < this._pSectorArray.length; i++) {
                    var pSectionBox = this._pSectorArray[i].localBounds;
                    fX0 = akra.math.min(fX0, pSectionBox.x0);
                    fY0 = akra.math.min(fY0, pSectionBox.y0);
                    fZ0 = akra.math.min(fZ0, pSectionBox.z0);
                    fX1 = akra.math.max(fX1, pSectionBox.x1);
                    fY1 = akra.math.max(fY1, pSectionBox.y1);
                    fZ1 = akra.math.max(fZ1, pSectionBox.z1);
                }
                this.accessLocalBounds().set(fX0, fX1, fY0, fY1, fZ0, fZ1);
            };
            Terrain.prototype._onRender = function (pTechnique, iPass) {
                var pPass = pTechnique.getPass(iPass);
                pPass.setTexture("TEXTURE6", this._pNormalMap);
                pPass.setSamplerTexture("S_NORMAL", "TEXTURE6");
                this._pMegaTexures.applyForRender(pPass);
            };
            return Terrain;
        })(akra.scene.SceneObject);
        terrain.Terrain = Terrain;        
    })(akra.terrain || (akra.terrain = {}));
    var terrain = akra.terrain;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (terrain) {
        var TerrainSectionROAM = (function (_super) {
            __extends(TerrainSectionROAM, _super);
            function TerrainSectionROAM(pScene, eType) {
                if (typeof eType === "undefined") { eType = akra.EEntityTypes.TERRAIN_SECTION_ROAM; }
                        _super.call(this, pScene, eType);
                this._pRootTriangleA = new terrain.TriTreeNode();
                this._pRootTriangleB = new terrain.TriTreeNode();
                this._pVarianceTreeA = null;
                this._pVarianceTreeB = null;
                this._v3fDistance0 = new akra.Vec3();
                this._v3fDistance1 = new akra.Vec3();
                this._v3fDistance2 = new akra.Vec3();
                this._v3fDistance3 = new akra.Vec3();
                this._leftNeighborOfA = null;
                this._rightNeighborOfA = null;
                this._leftNeighborOfB = null;
                this._rightNeighborOfB = null;
                this._iStartIndex = undefined;
                this._pTerrainSystem = null;
                this._iTempTotalIndices = undefined;
                this._pTempIndexList = undefined;
                this._iMaxIndices = undefined;
            }
            Object.defineProperty(TerrainSectionROAM.prototype, "terrainSystem", {
                get: function () {
                    return this._pTerrainSystem;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainSectionROAM.prototype, "triangleA", {
                get: function () {
                    return this._pRootTriangleA;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainSectionROAM.prototype, "triangleB", {
                get: function () {
                    return this._pRootTriangleA;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainSectionROAM.prototype, "queueSortValue", {
                get: function () {
                    return this._fQueueSortValue;
                },
                enumerable: true,
                configurable: true
            });
            TerrainSectionROAM.prototype._internalCreate = function (pParentSystem, iSectorX, iSectorY, iHeightMapX, iHeightMapY, iXVerts, iYVerts, pWorldRect, iStartIndex) {
 {
                    akra.logger.setSourceLocation("terrain/TerrainSectionROAM.ts", 74);
                    akra.logger.assert(arguments.length === 9, "Not valid arguments count.");
                }
                ;
                var iVerts = akra.math.max(iXVerts, iYVerts);
                this._iStartIndex = iStartIndex;
                var bResult = _super.prototype._internalCreate.call(this, pParentSystem, iSectorX, iSectorY, iHeightMapX, iHeightMapY, iVerts, iVerts, pWorldRect);
                if (!bResult) {
                    return false;
                }
                this._iTotalDetailLevels = akra.math.ceil(akra.math.log(iVerts) / akra.math.LN2) * 2 - 1;
                this._iTotalVariances = 1 << this._iTotalDetailLevels;
                this._pVarianceTreeA = new Array(this._iTotalVariances);
                this._pVarianceTreeB = new Array(this._iTotalVariances);
                for(var i = 0; i < this._iTotalVariances; i++) {
                    this._pVarianceTreeA[i] = 0;
                    this._pVarianceTreeB[i] = 0;
                }
                var pRoamTerrain = this.terrainSystem;
                var pNorthSection = pRoamTerrain.findSection(iSectorX, iSectorY - 1);
                var pSouthSection = pRoamTerrain.findSection(iSectorX, iSectorY + 1);
                var pEastSection = pRoamTerrain.findSection(iSectorX + 1, iSectorY);
                var pWestSection = pRoamTerrain.findSection(iSectorX - 1, iSectorY);
                if (pNorthSection) {
                    this._leftNeighborOfA = pNorthSection.triangleB;
                }
                if (pSouthSection) {
                    this._leftNeighborOfB = pSouthSection.triangleA;
                }
                if (pEastSection) {
                    this._rightNeighborOfB = pEastSection.triangleA;
                }
                if (pWestSection) {
                    this._rightNeighborOfA = pWestSection.triangleB;
                }
                this.reset();
                this.computeVariance();
                return bResult;
            };
            TerrainSectionROAM.prototype.prepareForRender = function (pViewport) {
                _super.prototype.prepareForRender.call(this, pViewport);
                var pCamera = pViewport.getCamera();
                var v3fViewPoint = pCamera.worldPosition;
                var fHeight0 = this.terrainSystem.readWorldHeight(akra.math.ceil(this._iHeightMapX), akra.math.ceil(this._iHeightMapY));
                var fHeight1 = this.terrainSystem.readWorldHeight(akra.math.ceil(this._iHeightMapX), akra.math.ceil(this._iHeightMapY + this._iYVerts));
                var fHeight2 = this.terrainSystem.readWorldHeight(akra.math.ceil(this._iHeightMapX + this._iXVerts), akra.math.ceil(this._iHeightMapY));
                var fHeight3 = this.terrainSystem.readWorldHeight(akra.math.ceil(this._iHeightMapX + this._iXVerts), akra.math.ceil(this._iHeightMapY + this._iYVerts));
                this._v3fDistance0.set(v3fViewPoint.x - this._pWorldRect.x0, v3fViewPoint.y - this._pWorldRect.y0, v3fViewPoint.z - fHeight0);
                this._v3fDistance1.set(v3fViewPoint.x - this._pWorldRect.x0, v3fViewPoint.y - this._pWorldRect.y1, v3fViewPoint.z - fHeight1);
                this._v3fDistance2.set(v3fViewPoint.x - this._pWorldRect.x1, v3fViewPoint.y - this._pWorldRect.y1, v3fViewPoint.z - fHeight2);
                this._v3fDistance3.set(v3fViewPoint.x - this._pWorldRect.x1, v3fViewPoint.y - this._pWorldRect.y0, v3fViewPoint.z - fHeight3);
                this._fDistance0 = this._v3fDistance0.length();
                this._fDistance1 = this._v3fDistance1.length();
                this._fDistance2 = this._v3fDistance2.length();
                this._fDistance3 = this._v3fDistance3.length();
                this._fQueueSortValue = akra.math.min(this._v3fDistance0.length(), this._v3fDistance1.length());
                this._fQueueSortValue = akra.math.min(this._fQueueSortValue, this._v3fDistance2.length());
                this._fQueueSortValue = akra.math.min(this._fQueueSortValue, this._v3fDistance3.length());
                this.terrainSystem.addToTessellationQueue(this);
            };
            TerrainSectionROAM.prototype.reset = function () {
                this._pRootTriangleA.leftChild = null;
                this._pRootTriangleA.rightChild = null;
                this._pRootTriangleB.leftChild = null;
                this._pRootTriangleB.rightChild = null;
                this._pRootTriangleA.baseNeighbor = this._pRootTriangleB;
                this._pRootTriangleB.baseNeighbor = this._pRootTriangleA;
                this._pRootTriangleA.leftNeighbor = this._leftNeighborOfA;
                this._pRootTriangleA.rightNeighbor = this._rightNeighborOfA;
                this._pRootTriangleB.leftNeighbor = this._leftNeighborOfB;
                this._pRootTriangleB.rightNeighbor = this._rightNeighborOfB;
            };
            TerrainSectionROAM.prototype.tessellate = function (fScale, fLimit) {
                this.recursiveTessellate(this._pRootTriangleA, this._fDistance1, this._fDistance2, this._fDistance0, this._pVarianceTreeA, 1, fScale, fLimit);
                this.recursiveTessellate(this._pRootTriangleB, this._fDistance3, this._fDistance0, this._fDistance2, this._pVarianceTreeB, 1, fScale, fLimit);
            };
            TerrainSectionROAM.prototype.recursiveTessellate = function (pTri, fDistA, fDistB, fDistC, pVTree, iIndex, fScale, fLimit) {
                if ((iIndex << 1) + 1 < this._iTotalVariances) {
                    var fMidDist = (fDistB + fDistC) * 0.5;
                    if (!pTri.leftChild) {
                        var fRatio = (pVTree[iIndex] * fScale) / (fMidDist + 0.0001);
                        if (fRatio > 1) {
                            this.split(pTri);
                        }
                    }
                    if (pTri.leftChild) {
                        this.recursiveTessellate(pTri.leftChild, fMidDist, fDistA, fDistB, pVTree, iIndex << 1, fScale, fLimit);
                        this.recursiveTessellate(pTri.rightChild, fMidDist, fDistC, fDistA, pVTree, (iIndex << 1) + 1, fScale, fLimit);
                    }
                }
            };
            TerrainSectionROAM.prototype.split = function (pTri) {
                if (pTri.leftChild) {
                    return;
                }
                if (pTri.baseNeighbor && (pTri.baseNeighbor.baseNeighbor != pTri)) {
                    this.split(pTri.baseNeighbor);
                }
                pTri.leftChild = this.terrainSystem.requestTriNode();
                pTri.rightChild = this.terrainSystem.requestTriNode();
                if ((!pTri.leftChild) || (!pTri.rightChild)) {
                    pTri.leftChild = null;
                    pTri.rightChild = null;
                    return;
                }
                pTri.leftChild.baseNeighbor = pTri.leftNeighbor;
                pTri.leftChild.leftNeighbor = pTri.rightChild;
                pTri.rightChild.baseNeighbor = pTri.rightNeighbor;
                pTri.rightChild.rightNeighbor = pTri.leftChild;
                if (pTri.leftNeighbor) {
                    if (pTri.leftNeighbor.baseNeighbor == pTri) {
                        pTri.leftNeighbor.baseNeighbor = pTri.leftChild;
                    } else if (pTri.leftNeighbor.leftNeighbor == pTri) {
                        pTri.leftNeighbor.leftNeighbor = pTri.leftChild;
                    } else if (pTri.leftNeighbor.rightNeighbor == pTri) {
                        pTri.leftNeighbor.rightNeighbor = pTri.leftChild;
                    } else {
                        console.log(pTri);
 {
                            akra.logger.setSourceLocation("terrain/TerrainSectionROAM.ts", 272);
                            akra.logger.warning("Invalid Left Neighbor!");
                        }
                        ;
                        debugger;

                    }
                }
                if (pTri.rightNeighbor) {
                    if (pTri.rightNeighbor.baseNeighbor == pTri) {
                        pTri.rightNeighbor.baseNeighbor = pTri.rightChild;
                    } else if (pTri.rightNeighbor.rightNeighbor == pTri) {
                        pTri.rightNeighbor.rightNeighbor = pTri.rightChild;
                    } else if (pTri.rightNeighbor.leftNeighbor == pTri) {
                        pTri.rightNeighbor.leftNeighbor = pTri.rightChild;
                    } else {
 {
                            akra.logger.setSourceLocation("terrain/TerrainSectionROAM.ts", 286);
                            akra.logger.warning("Invalid Right Neighbor!");
                        }
                        ;
                    }
                }
                if (pTri.baseNeighbor) {
                    if (pTri.baseNeighbor.leftChild) {
                        pTri.baseNeighbor.leftChild.rightNeighbor = pTri.rightChild;
                        pTri.baseNeighbor.rightChild.leftNeighbor = pTri.leftChild;
                        pTri.leftChild.rightNeighbor = pTri.baseNeighbor.rightChild;
                        pTri.rightChild.leftNeighbor = pTri.baseNeighbor.leftChild;
                    } else {
                        this.split(pTri.baseNeighbor);
                    }
                } else {
                    pTri.leftChild.rightNeighbor = null;
                    pTri.rightChild.leftNeighbor = null;
                }
            };
            TerrainSectionROAM.prototype._createRenderDataForVertexAndIndex = function () {
                return true;
            };
            TerrainSectionROAM.prototype._buildIndexBuffer = function () {
                this._iMaxIndices = this.terrainSystem.maxTriTreeNodes * 3;
                return true;
            };
            TerrainSectionROAM.prototype._buildVertexBuffer = function () {
                this._pWorldRect.z0 = akra.MAX_FLOAT64;
                this._pWorldRect.z1 = akra.MIN_FLOAT64;
                var pVerts = this.terrainSystem.verts;
                var v3fNormal = new akra.Vec3();
                var v2fCellSize = new akra.Vec2();
                v2fCellSize.set(this.heightX / (this._iXVerts - 1), this.heightY / (this._iYVerts - 1));
                var v2fVert = new akra.Vec2();
                v2fVert.set(0.0, 0.0);
                for(var y = 0; y < this._iYVerts; ++y) {
                    v2fVert.set(this._pWorldRect.x0, y * v2fCellSize.y + this._pWorldRect.y0);
                    for(var x = 0; x < this._iXVerts; ++x) {
                        var fHeight = this.terrainSystem.readWorldHeight(this._iHeightMapX + x, this._iHeightMapY + y);
                        pVerts[((y * this._iXVerts) + x) * 5 + 0 + this._iStartIndex * 5] = v2fVert.x;
                        pVerts[((y * this._iXVerts) + x) * 5 + 1 + this._iStartIndex * 5] = v2fVert.y;
                        pVerts[((y * this._iXVerts) + x) * 5 + 2 + this._iStartIndex * 5] = fHeight;
                        pVerts[((y * this._iXVerts) + x) * 5 + 3 + this._iStartIndex * 5] = (this._iSectorX + x / (this._iXVerts - 1)) / this.terrainSystem.sectorCountX;
                        pVerts[((y * this._iXVerts) + x) * 5 + 4 + this._iStartIndex * 5] = (this._iSectorY + y / (this._iYVerts - 1)) / this.terrainSystem.sectorCountY;
                        this._pWorldRect.z0 = akra.math.min(this._pWorldRect.z0, fHeight);
                        this._pWorldRect.z1 = akra.math.max(this._pWorldRect.z1, fHeight);
                        v2fVert.x += v2fCellSize.x;
                    }
                }
                return true;
            };
            TerrainSectionROAM.prototype.buildTriangleList = function () {
                this._iTempTotalIndices = this.terrainSystem.totalIndex;
                this._pTempIndexList = this.terrainSystem.index;
                this._iVertexID = this.terrainSystem.vertexId;
                this.recursiveBuildTriangleList(this._pRootTriangleA, 0, this._iXVerts - 1, (this._iYVerts - 1) * this._iXVerts);
                this.recursiveBuildTriangleList(this._pRootTriangleB, (this._iYVerts * this._iXVerts) - 1, (this._iYVerts - 1) * this._iXVerts, this._iXVerts - 1);
                this.terrainSystem.totalIndex = this._iTempTotalIndices;
                this._iTempTotalIndices = undefined;
                this._iVertexID = undefined;
                this._pTempIndexList = null;
            };
            TerrainSectionROAM.prototype.recursiveBuildTriangleList = function (pTri, iPointBase, iPointLeft, iPointRight) {
                if (pTri.leftChild) {
                    if (!pTri.rightChild) {
 {
                            akra.logger.setSourceLocation("terrain/TerrainSectionROAM.ts", 398);
                            akra.logger.warning("invalid triangle node");
                        }
                        ;
                    }
                    var iPointMid = (iPointLeft + iPointRight) * 0.5;
                    this.recursiveBuildTriangleList(pTri.leftChild, iPointMid, iPointBase, iPointLeft);
                    this.recursiveBuildTriangleList(pTri.rightChild, iPointMid, iPointRight, iPointBase);
                } else if (this._iTempTotalIndices + 3 < this._iMaxIndices) {
                    this._pTempIndexList[this._iTempTotalIndices++] = ((iPointRight + this._iStartIndex) * 20 + this._iVertexID) / 4;
                    this._pTempIndexList[this._iTempTotalIndices++] = ((iPointLeft + this._iStartIndex) * 20 + this._iVertexID) / 4;
                    this._pTempIndexList[this._iTempTotalIndices++] = ((iPointBase + this._iStartIndex) * 20 + this._iVertexID) / 4;
                } else {
 {
                        akra.logger.setSourceLocation("terrain/TerrainSectionROAM.ts", 416);
                        akra.logger.log("else", this._iTempTotalIndices, this._iMaxIndices);
                    }
                }
            };
            TerrainSectionROAM.prototype.computeVariance = function () {
                var iTableWidth = this.terrainSystem.tableWidth;
                var iTableHeight = this.terrainSystem.tableHeight;
                var iIndex0 = this.terrainSystem._tableIndex(this._iHeightMapX, this._iHeightMapY);
                var iIndex1 = this.terrainSystem._tableIndex(this._iHeightMapX, this._iHeightMapY + this._iYVerts - 1);
                var iIndex2 = this.terrainSystem._tableIndex(this._iHeightMapX + this._iXVerts - 1, this._iHeightMapY + this._iYVerts - 1);
                var iIndex3 = this.terrainSystem._tableIndex(this._iHeightMapX + this._iXVerts - 1, this._iHeightMapY);
                var fHeight0 = this.terrainSystem.readWorldHeight(iIndex0);
                var fHeight1 = this.terrainSystem.readWorldHeight(iIndex1);
                var fHeight2 = this.terrainSystem.readWorldHeight(iIndex2);
                var fHeight3 = this.terrainSystem.readWorldHeight(iIndex3);
                this.recursiveComputeVariance(iIndex1, iIndex2, iIndex0, fHeight1, fHeight2, fHeight0, this._pVarianceTreeA, 1);
                this.recursiveComputeVariance(iIndex3, iIndex0, iIndex2, fHeight3, fHeight0, fHeight2, this._pVarianceTreeB, 1);
            };
            TerrainSectionROAM.prototype.recursiveComputeVariance = function (iCornerA, iCornerB, iCornerC, fHeightA, fHeightB, fHeightC, pVTree, iIndex) {
                if (iIndex < pVTree.length) {
                    var iMidpoint = (iCornerB + iCornerC) >> 1;
                    var fMidHeight = this.terrainSystem.readWorldHeight(iMidpoint);
                    var iTW = this.terrainSystem.tableWidth;
                    var iTH = this.terrainSystem.tableHeight;
                    var iXB = iCornerB % iTW;
                    var iYB = akra.math.floor(iCornerB / iTW);
                    var iXC = iCornerC % iTW;
                    var iYC = akra.math.floor(iCornerC / iTW);
                    var pWorldSize = this.terrainSystem.worldSize;
                    var fLX = akra.math.abs(iXB - iXC) / iTW * pWorldSize.x;
                    var fLY = akra.math.abs(iYB - iYC) / iTH * pWorldSize.y;
                    var fX = akra.math.sqrt(fLY * fLY + fLX * fLX);
                    var fY = akra.math.abs(fHeightB - fHeightC);
                    var fInterpolatedHeight = (fHeightB + fHeightC) * 0.5;
                    var fVariance = akra.math.abs(fMidHeight - fInterpolatedHeight);
                    if (fX < fY) {
                        fVariance = fInterpolatedHeight * fX / fY;
                    }
                    var fLeft = this.recursiveComputeVariance(iMidpoint, iCornerA, iCornerB, fMidHeight, fHeightA, fHeightB, pVTree, iIndex << 1);
                    var fRight = this.recursiveComputeVariance(iMidpoint, iCornerC, iCornerA, fMidHeight, fHeightC, fHeightA, pVTree, 1 + (iIndex << 1));
                    fVariance = akra.math.max(fVariance, fLeft);
                    fVariance = akra.math.max(fVariance, fRight);
                    pVTree[iIndex] = fVariance;
                    return fVariance;
                }
                return 0;
            };
            TerrainSectionROAM.prototype.drawVariance = function (iIndex, iCornerA, iCornerB, iCornerC, pVTree) {
                var iLevel = akra.math.floor(akra.math.log(iIndex) / akra.math.LN2);
                var iStart = 0;
                if (iLevel >= iStart && iLevel < iStart + 4) {
                    var pCanvas = document.getElementById("variance" + (iLevel - iStart));
                    var p2D = pCanvas.getContext("2d");
                    p2D.fillStyle = "rgb(0," + akra.math.floor(pVTree[iIndex]) + ",0)";
                    p2D.strokeStyle = "#f00";
                    p2D.lineWidth = 1;
                    p2D.beginPath();
                    var iTW = this.terrainSystem.tableWidth;
                    var iTH = this.terrainSystem.tableHeight;
                    var iXA = iCornerA % iTW;
                    var iYA = akra.math.floor(iCornerA / iTW);
                    var iXB = iCornerB % iTW;
                    var iYB = akra.math.floor(iCornerB / iTW);
                    var iXC = iCornerC % iTW;
                    var iYC = akra.math.floor(iCornerC / iTW);
                    var iXMid = akra.math.floor((iXA + iXB + iXC) / 3);
                    var iYMid = akra.math.floor((iYA + iYB + iYC) / 3);
                    p2D.arc(akra.math.floor(iXMid / iTW * pCanvas.width), akra.math.floor(iYMid / iTH * pCanvas.height), 5, 0, akra.math.PI * 2, false);
                    p2D.fill();
                }
            };
            return TerrainSectionROAM;
        })(terrain.TerrainSection);
        terrain.TerrainSectionROAM = TerrainSectionROAM;        
    })(akra.terrain || (akra.terrain = {}));
    var terrain = akra.terrain;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (terrain) {
        var TriTreeNode = (function () {
            function TriTreeNode() {
                this._pBaseNeighbor = null;
                this._pLeftNeighbor = null;
                this._pRightNeighbor = null;
                this._pLeftChild = null;
                this._pRightChild = null;
            }
            Object.defineProperty(TriTreeNode.prototype, "baseNeighbor", {
                get: function () {
                    return this._pBaseNeighbor;
                },
                set: function (pBaseNeighbor) {
                    this._pBaseNeighbor = pBaseNeighbor;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TriTreeNode.prototype, "leftNeighbor", {
                get: function () {
                    return this._pLeftNeighbor;
                },
                set: function (pLeftNeighbor) {
                    this._pLeftNeighbor = pLeftNeighbor;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TriTreeNode.prototype, "rightNeighbor", {
                get: function () {
                    return this._pRightNeighbor;
                },
                set: function (pRightNeighbor) {
                    this._pRightNeighbor = pRightNeighbor;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TriTreeNode.prototype, "leftChild", {
                get: function () {
                    return this._pLeftChild;
                },
                set: function (pLeftChild) {
                    this._pLeftChild = pLeftChild;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TriTreeNode.prototype, "rightChild", {
                get: function () {
                    return this._pRightChild;
                },
                set: function (pRightChild) {
                    this._pRightChild = pRightChild;
                },
                enumerable: true,
                configurable: true
            });
            return TriTreeNode;
        })();
        terrain.TriTreeNode = TriTreeNode;        
        var TriangleNodePool = (function () {
            function TriangleNodePool(iCount) {
                this._iNextTriNode = 0;
                this._iMaxCount = undefined;
                this._pPool = null;
                this._iMaxCount = iCount;
                this.pool = Array(iCount);
                console.log("TriangleNodePool", this.maxCount);
                for(var i = 0; i < this.maxCount; i++) {
                    this.pool[i] = new TriTreeNode();
                }
            }
            Object.defineProperty(TriangleNodePool.prototype, "nextTriNode", {
                get: function () {
                    return this._iNextTriNode;
                },
                set: function (iNextTriNode) {
                    this._iNextTriNode = iNextTriNode;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TriangleNodePool.prototype, "maxCount", {
                get: function () {
                    return this._iMaxCount;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TriangleNodePool.prototype, "pool", {
                get: function () {
                    return this._pPool;
                },
                set: function (pPool) {
                    this._pPool = pPool;
                },
                enumerable: true,
                configurable: true
            });
            TriangleNodePool.prototype.request = function () {
                var pNode = null;
                if (this.nextTriNode < this.maxCount) {
                    pNode = this.pool[this.nextTriNode];
                    pNode.baseNeighbor = null;
                    pNode.leftNeighbor = null;
                    pNode.rightNeighbor = null;
                    pNode.leftChild = null;
                    pNode.rightChild = null;
                    this.nextTriNode++;
                }
                return pNode;
            };
            TriangleNodePool.prototype.reset = function () {
                this.nextTriNode = 0;
            };
            return TriangleNodePool;
        })();
        terrain.TriangleNodePool = TriangleNodePool;        
    })(akra.terrain || (akra.terrain = {}));
    var terrain = akra.terrain;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (terrain) {
        var TerrainROAM = (function (_super) {
            __extends(TerrainROAM, _super);
            function TerrainROAM(pScene, eType) {
                if (typeof eType === "undefined") { eType = akra.EEntityTypes.TERRAIN_ROAM; }
                        _super.call(this, pScene, eType);
                this._pRenderableObject = null;
                this._pRenderData = null;
                this._pDataIndex = null;
                this._pIndexList = null;
                this._pNodePool = null;
                this._pThistessellationQueue = null;
                this._iTessellationQueueCount = 0;
                this._isCreat = false;
                this._isRenderInThisFrame = false;
                this._iMaxTriTreeNodes = (1024 * 64);
                this._iTessellationQueueSize = undefined;
                this._isCreate = false;
                this._pSectorArray = null;
                this._iTessellationQueueCountOld = undefined;
                this._nCountRender = 0;
                this._pRenderData = this._pDataFactory.getEmptyRenderData(akra.EPrimitiveTypes.TRIANGLELIST, akra.ERenderDataBufferOptions.RD_ADVANCED_INDEX);
                this._pRenderableObject = new akra.render.RenderableObject();
                this._pRenderableObject._setup(this._pEngine.getRenderer());
                this._pRenderableObject._setRenderData(this._pRenderData);
                this.connect(this._pRenderableObject, "beforeRender", "_onBeforeRender", akra.EEventTypes.UNICAST);
            }
            Object.defineProperty(TerrainROAM.prototype, "maxTriTreeNodes", {
                get: function () {
                    return this._iMaxTriTreeNodes;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainROAM.prototype, "verts", {
                get: function () {
                    return this._pVerts;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainROAM.prototype, "index", {
                get: function () {
                    return this._pIndexList;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainROAM.prototype, "totalIndex", {
                get: function () {
                    return this._iTotalIndices;
                },
                set: function (iTotalIndices) {
                    this._iTotalIndices = iTotalIndices;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainROAM.prototype, "vertexId", {
                get: function () {
                    return this._iVertexID;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TerrainROAM.prototype, "totalRenderable", {
                get: function () {
                    return !((this._pRenderableObject) === null) ? 1 : 0;
                },
                enumerable: true,
                configurable: true
            });
            TerrainROAM.prototype.getRenderable = function (i) {
                return this._pRenderableObject;
            };
            TerrainROAM.prototype.init = function (pImgMap, worldExtents, iShift, iShiftX, iShiftY, sSurfaceTextures, pRootNode) {
                if (typeof pRootNode === "undefined") { pRootNode = null; }
                var bResult = _super.prototype.init.call(this, pImgMap, worldExtents, iShift, iShiftX, iShiftY, sSurfaceTextures, pRootNode);
                if (bResult) {
                    this._iTessellationQueueSize = this.sectorCountX * this.sectorCountY;
                    this._pNodePool = new terrain.TriangleNodePool(this._iMaxTriTreeNodes);
                    this._pThistessellationQueue = new Array(this._iTessellationQueueSize);
                    this._iTessellationQueueCount = 0;
                    this._isCreate = true;
                    this._iTotalIndicesMax = 0;
                    this._pRenderableObject.getTechnique().setMethod(this._pDefaultRenderMethod);
                    this.connect(this._pRenderableObject.getTechnique(), "render", "_onRender", akra.EEventTypes.UNICAST);
                    this.reset();
                }
                return bResult;
            };
            TerrainROAM.prototype.destroy = function () {
                delete this._pNodePool;
                delete this._pThistessellationQueue;
                this._iTessellationQueueCount = 0;
                this._fScale = 0;
                this._fLimit = 0;
            };
            TerrainROAM.prototype._allocateSectors = function () {
                this._pSectorArray = new Array(this._iSectorCountX * this._iSectorCountY);
                this._pVerts = new Array((this._iSectorCountX * this._iSectorCountY) * (this._iSectorVerts * this._iSectorVerts) * (3 + 2));
                for(var i = 0; i < this._pSectorArray.length; i++) {
                    this._pSectorArray[i] = this.scene.createTerrainSectionROAM();
                }
                for(var y = 0; y < this._iSectorCountY; ++y) {
                    for(var x = 0; x < this._iSectorCountX; ++x) {
                        var v2fSectorPos = new akra.Vec2();
                        v2fSectorPos.set(this._pWorldExtents.x0 + (x * this._v2fSectorSize.x), this._pWorldExtents.y0 + (y * this._v2fSectorSize.y));
                        var r2fSectorRect = new akra.geometry.Rect2d();
                        r2fSectorRect.set(v2fSectorPos.x, v2fSectorPos.x + this._v2fSectorSize.x, v2fSectorPos.y, v2fSectorPos.y + this._v2fSectorSize.y);
                        var iXPixel = x << this._iSectorShift;
                        var iYPixel = y << this._iSectorShift;
                        var iIndex = (y * this._iSectorCountX) + x;
                        if (!this._pSectorArray[iIndex]._internalCreate(this, x, y, iXPixel, iYPixel, this._iSectorVerts, this._iSectorVerts, r2fSectorRect, iIndex * (this._iSectorVerts * this._iSectorVerts))) {
                            return false;
                        }
                    }
                }
                var pVertexDescription = [
                    akra.VE_FLOAT3(akra.DeclarationUsages.POSITION), 
                    akra.VE_FLOAT2(akra.DeclarationUsages.TEXCOORD)
                ];
                this._iVertexID = this._pRenderData.allocateData(pVertexDescription, new Float32Array(this._pVerts));
                this._iTotalIndices = 0;
                this._pIndexList = new Float32Array(this._iMaxTriTreeNodes * 3);
                this._pRenderData.allocateIndex([
                    akra.VE_FLOAT(akra.DeclarationUsages.INDEX0)
                ], this._pIndexList);
                this._pRenderData.index(this._iVertexID, akra.DeclarationUsages.INDEX0);
                this._pDataIndex = this._pRenderData.getAdvancedIndexData(akra.DeclarationUsages.INDEX0);
                return true;
            };
            TerrainROAM.prototype.reset = function () {
                this._isRenderInThisFrame = false;
                if (this._isCreate) {
                    _super.prototype.reset.call(this);
                    this._iTessellationQueueCount = 0;
                    this._pThistessellationQueue.length = this._iTessellationQueueSize;
                    this._pNodePool.reset();
                    for(var i in this._pSectorArray) {
                        this._pSectorArray[i].reset();
                    }
                }
            };
            TerrainROAM.prototype.requestTriNode = function () {
                return this._pNodePool.request();
            };
            TerrainROAM.prototype.addToTessellationQueue = function (pSection) {
                if (this._iTessellationQueueCount < this._iTessellationQueueSize) {
                    this._pThistessellationQueue[this._iTessellationQueueCount] = pSection;
                    this._iTessellationQueueCount++;
                    return true;
                }
 {
                    akra.logger.setSourceLocation("terrain/TerrainROAM.ts", 208);
                    akra.logger.warning("increase the size of the ROAM tessellation queue");
                }
                ;
                return false;
            };
            TerrainROAM.prototype.processTessellationQueue = function () {
                this._pThistessellationQueue.length = this._iTessellationQueueCount;
                function fnSortSection(a, b) {
                    return a.queueSortValue - b.queueSortValue;
                }
                this._pThistessellationQueue.sort(fnSortSection);
                for(var i = 0; i < this._iTessellationQueueCount; ++i) {
                    this._pThistessellationQueue[i].tessellate(this._fScale, this._fLimit);
                }
                this._iTotalIndices = 0;
                for(var i = 0; i < this._iTessellationQueueCount; ++i) {
                    this._pThistessellationQueue[i].buildTriangleList();
                }
                if (this._iTotalIndicesOld == this._iTotalIndices && this._iTotalIndices != this._iTotalIndicesMax) {
                    return;
                }
                this._pRenderData._setIndexLength(this._iTotalIndices);
                this._pDataIndex.setData(this._pIndexList, 0, akra.getTypeSize(akra.EDataTypes.FLOAT), 0, this._iTotalIndices);
                this._iTotalIndicesOld = this._iTotalIndices;
                this._iTotalIndicesMax = akra.math.max(this._iTotalIndicesMax, this._iTotalIndices);
            };
            TerrainROAM.prototype._onBeforeRender = function (pRenderableObject, pViewport) {
                if (this._isCreate) {
                    if (((this._nCountRender++) % 30) === 0) {
                        if (this._iTessellationQueueCount !== this._iTessellationQueueCountOld) {
                            this.processTessellationQueue();
                            this._iTessellationQueueCountOld = this._iTessellationQueueCount;
                        }
                    }
                    this.reset();
                }
            };
            return TerrainROAM;
        })(terrain.Terrain);
        terrain.TerrainROAM = TerrainROAM;        
    })(akra.terrain || (akra.terrain = {}));
    var terrain = akra.terrain;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        (function (light) {
            var ProjectLight = (function (_super) {
                __extends(ProjectLight, _super);
                function ProjectLight(pScene) {
                                _super.call(this, pScene, akra.ELightTypes.PROJECT);
                    this._pDepthTexture = null;
                    this._pColorTexture = null;
                    this._pShadowCaster = pScene._createShadowCaster(this);
                }
                ProjectLight.prototype.create = function (isShadowCaster, iMaxShadowResolution) {
                    if (typeof isShadowCaster === "undefined") { isShadowCaster = true; }
                    if (typeof iMaxShadowResolution === "undefined") { iMaxShadowResolution = 256; }
                    var isOk = _super.prototype.create.call(this, isShadowCaster, iMaxShadowResolution);
                    var pCaster = this._pShadowCaster;
                    pCaster.setParameter(akra.ECameraParameters.CONST_ASPECT, true);
                    pCaster.setInheritance(akra.ENodeInheritance.ALL);
                    pCaster.attachToParent(this);
                    if (this.isShadowCaster) {
                        this.initializeTextures();
                    }
                    return isOk;
                };
                ProjectLight.prototype.getDepthTexture = function () {
                    return this._pDepthTexture;
                };
                ProjectLight.prototype.getRenderTarget = function () {
                    return this._pColorTexture.getBuffer().getRenderTarget();
                };
                ProjectLight.prototype.getShadowCaster = function () {
                    return this._pShadowCaster;
                };
                Object.defineProperty(ProjectLight.prototype, "isShadowCaster", {
                    get: function () {
                        return this._isShadowCaster;
                    },
                    set: function (bValue) {
                        this._isShadowCaster = bValue;
                        if (bValue && ((this._pDepthTexture) === null)) {
                            this.initializeTextures();
                        }
                    },
                    enumerable: true,
                    configurable: true
                });
                ProjectLight.prototype.initializeTextures = function () {
                    var pEngine = this.scene.getManager().getEngine();
                    var pResMgr = pEngine.getResourceManager();
                    var iSize = this._iMaxShadowResolution;
                    var pDepthTexture = this._pDepthTexture = pResMgr.createTexture("depth_texture_" + this.getGuid());
                    pDepthTexture.create(iSize, iSize, 1, null, 0, 0, 0, akra.ETextureTypes.TEXTURE_2D, akra.EPixelFormats.DEPTH32);
                    pDepthTexture.setWrapMode(akra.ETextureParameters.WRAP_S, akra.ETextureWrapModes.CLAMP_TO_EDGE);
                    pDepthTexture.setWrapMode(akra.ETextureParameters.WRAP_T, akra.ETextureWrapModes.CLAMP_TO_EDGE);
                    pDepthTexture.setFilter(akra.ETextureParameters.MAG_FILTER, akra.ETextureFilters.LINEAR);
                    pDepthTexture.setFilter(akra.ETextureParameters.MIN_FILTER, akra.ETextureFilters.LINEAR);
                    var pColorTexture = pResMgr.createTexture("light_color_texture_" + this.getGuid());
                    pColorTexture.create(iSize, iSize, 1, null, akra.ETextureFlags.RENDERTARGET, 0, 0, akra.ETextureTypes.TEXTURE_2D, akra.EPixelFormats.R8G8B8A8);
                    this._pColorTexture = pColorTexture;
                    this.getRenderTarget().attachDepthTexture(pDepthTexture);
                    this.getRenderTarget().setAutoUpdated(false);
                    this.getRenderTarget().addViewport(this._pShadowCaster, akra.EViewportTypes.SHADOWVIEWPORT);
                };
                ProjectLight.prototype._calculateShadows = function () {
                    if (this.enabled && this.isShadowCaster) {
                        this.getRenderTarget().update();
                    }
                };
                ProjectLight.prototype._prepareForLighting = function (pCamera) {
                    if (!this.enabled) {
                        return false;
                    } else {
                        if (!this.isShadowCaster) {
                            var pResult = this._defineLightingInfluence(pCamera);
                            return (pResult.length == 0) ? false : true;
                        } else {
                            var pResult = this._defineShadowInfluence(pCamera);
                            return (pResult.length == 0) ? false : true;
                        }
                    }
                };
                ProjectLight.prototype._defineLightingInfluence = function (pCamera) {
                    var pShadowCaster = this._pShadowCaster;
                    var pCameraFrustum = pCamera.frustum;
                    var pResult = pShadowCaster.affectedObjects;
                    pResult.clear();
                    if (!pCameraFrustum.testFrustum(pShadowCaster.frustum)) {
                        return pResult;
                    }
                    var pRawResult = pShadowCaster.display(0);
                    for(var i = 0; i < pRawResult.length; i++) {
                        var pObject = pRawResult.value(i);
                        if (pCameraFrustum.testRect(pObject.worldBounds)) {
                            pResult.push(pObject);
                        }
                    }
                    return pResult;
                };
                ProjectLight.prototype._defineShadowInfluence = function (pCamera) {
                    var pShadowCaster = this._pShadowCaster;
                    var pCameraFrustum = pCamera.frustum;
                    var pResult = pShadowCaster.affectedObjects;
                    pResult.clear();
                    if (!pCameraFrustum.testFrustum(pShadowCaster.frustum)) {
                        return pResult;
                    }
                    var pRawResult = pShadowCaster.display(0);
                    var pTestArray = ProjectLight._pFrustumPlanes;
                    var pFrustumPlanesKeys = akra.geometry.Frustum.frustumPlanesKeys;
                    var nAdditionalTestLength = 0;
                    if (pShadowCaster.projectionMatrix.isOrthogonalProjection()) {
                        var pLightFrustumVertices = pShadowCaster.frustum.frustumVertices;
                        var v3fDirection1 = akra.vec3(0.);
                        var v3fDirection2 = akra.vec3(0.);
                        var v3fDirection = akra.vec3(0.);
                        for(var i = 0; i < 4; i++) {
                            v3fDirection1.add(pLightFrustumVertices[i]);
                        }
                        for(var i = 4; i < 8; i++) {
                            v3fDirection2.add(pLightFrustumVertices[i]);
                        }
                        v3fDirection2.subtract(v3fDirection1, v3fDirection);
                        v3fDirection.normalize();
                        for(var i = 0; i < 6; i++) {
                            var sKey = pFrustumPlanesKeys[i];
                            var pPlane = pCameraFrustum[sKey];
                            if (v3fDirection.dot(pPlane.normal) >= 0.) {
                                pTestArray[nAdditionalTestLength].set(pPlane);
                                nAdditionalTestLength++;
                            } else {
                                var pPlanePoints = [
                                    new akra.Vec3(), 
                                    new akra.Vec3(), 
                                    new akra.Vec3(), 
                                    new akra.Vec3()
                                ];
                                pCameraFrustum.getPlanePoints(sKey, pPlanePoints);
                                var pDirections = new Array(4);
                                for(var j = 0; j < 4; j++) {
                                    pDirections[j] = new akra.Vec3();
                                    pPlanePoints[j].subtract(this.worldPosition, pDirections[j]);
                                }
                                var fLength1 = pDirections[0].length();
                                var fLength2 = pDirections[1].length();
                                var fLength3 = pDirections[2].length();
                                var fLength4 = pDirections[3].length();
                                var pTmp1 = [
                                    fLength1, 
                                    fLength2, 
                                    fLength3, 
                                    fLength4
                                ];
                                var pIndex = [
                                    -1, 
                                    -1, 
                                    -1, 
                                    -1
                                ];
                                for(var j = 0; j < 4; j++) {
                                    var iTest = 3;
                                    for(var k = 0; k < 4; k++) {
                                        if (k == j) {
                                            continue;
                                        }
                                        if (pTmp1[j] >= pTmp1[k]) {
                                            iTest--;
                                        }
                                    }
                                    for(var k = 0; k < 4; k++) {
                                        if (pIndex[iTest] == -1) {
                                            pIndex[iTest] = j;
                                            break;
                                        } else {
                                            iTest++;
                                        }
                                    }
                                }
                                var pPoint1 = pPlanePoints[pIndex[0]];
                                var pPoint2 = pPlanePoints[pIndex[1]];
                                var pTestPoint1 = pPlanePoints[pIndex[2]];
                                var pTestPoint2 = pPlanePoints[pIndex[3]];
                                var v3fDir = pPoint2.subtract(pPoint1, akra.vec3());
                                var v3fNormal = v3fDir.cross(v3fDirection, akra.vec3()).normalize();
                                var pTestPlane = pTestArray[nAdditionalTestLength];
                                pTestPlane.set(v3fNormal, -v3fNormal.dot(pPoint1));
                                var pVertices = pCamera.frustum.frustumVertices;
                                var iTest = 0;
                                for(var k = 0; k < 8; k++) {
                                    if (pTestPlane.signedDistance(pVertices[k]) > 0.1) {
                                        iTest++;
                                    }
                                }
                                if (iTest == 6) {
                                    pTestPlane.negate();
                                } else if (iTest != 0) {
                                    continue;
                                }
                                nAdditionalTestLength++;
                            }
                        }
                    } else {
                        var v3fLightPosition = this.worldPosition;
                        for(var i = 0; i < 6; i++) {
                            var sKey = pFrustumPlanesKeys[i];
                            var pPlane = pCameraFrustum[sKey];
                            var v3fNormal = akra.vec3().set(pPlane.normal);
                            var fDistance = pPlane.distance;
                            if (pPlane.signedDistance(v3fLightPosition) > 0) {
                                var pPlanePoints = [
                                    new akra.Vec3(), 
                                    new akra.Vec3(), 
                                    new akra.Vec3(), 
                                    new akra.Vec3()
                                ];
                                pCameraFrustum.getPlanePoints(sKey, pPlanePoints);
                                var pDirections = new Array(4);
                                for(var j = 0; j < 4; j++) {
                                    pDirections[j] = new akra.Vec3();
                                    pPlanePoints[j].subtract(v3fLightPosition, pDirections[j]);
                                }
                                var fLength1 = pDirections[0].length();
                                var fLength2 = pDirections[1].length();
                                var fLength3 = pDirections[2].length();
                                var fLength4 = pDirections[3].length();
                                var pTmp1 = [
                                    fLength1, 
                                    fLength2, 
                                    fLength3, 
                                    fLength4
                                ];
                                var pIndex = [
                                    -1, 
                                    -1, 
                                    -1, 
                                    -1
                                ];
                                for(var j = 0; j < 4; j++) {
                                    var iTest = 3;
                                    for(var k = 0; k < 4; k++) {
                                        if (k == j) {
                                            continue;
                                        }
                                        if (pTmp1[j] >= pTmp1[k]) {
                                            iTest--;
                                        }
                                    }
                                    for(var k = 0; k < 4; k++) {
                                        if (pIndex[iTest] == -1) {
                                            pIndex[iTest] = j;
                                            break;
                                        } else {
                                            iTest++;
                                        }
                                    }
                                }
                                var pDir1 = pDirections[pIndex[0]];
                                var pDir2 = pDirections[pIndex[1]];
                                var pTestPoint1 = pPlanePoints[pIndex[2]];
                                var pTestPoint2 = pPlanePoints[pIndex[3]];
                                pDir1.cross(pDir2, v3fNormal).normalize();
                                var pTestPlane = pTestArray[i];
                                pTestPlane.set(v3fNormal, -v3fNormal.dot(v3fLightPosition));
                                var fThreshold = 0.1;
                                if (akra.math.abs(pTestPlane.signedDistance(pTestPoint1)) <= fThreshold && akra.math.abs(pTestPlane.signedDistance(pTestPoint2)) <= fThreshold) {
                                    pTestPlane.set(pPlane.normal, -pPlane.normal.dot(v3fLightPosition));
                                } else if (pTestPlane.signedDistance(pTestPoint1) > 0 && akra.math.abs(pTestPlane.signedDistance(pTestPoint2)) > 0) {
                                    pTestPlane.negate();
                                }
                            } else {
                                pTestArray[i].set(v3fNormal, fDistance);
                            }
                        }
                        nAdditionalTestLength = 6;
                    }
                    for(var i = 0; i < pRawResult.length; i++) {
                        var pObject = pRawResult.value(i);
                        var pWorldBounds = pObject.worldBounds;
                        if (pObject.hasShadow) {
                            var j = 0;
                            for(j = 0; j < nAdditionalTestLength; j++) {
                                var pPlane = pTestArray[j];
                                if (akra.geometry.planeClassifyRect3d(pPlane, pWorldBounds) == akra.EPlaneClassifications.PLANE_FRONT) {
                                    break;
                                }
                            }
                            if (j == nAdditionalTestLength) {
                                pResult.push(pObject);
                            }
                        } else {
                            if (pCameraFrustum.testRect(pWorldBounds)) {
                                pResult.push(pObject);
                            }
                        }
                    }
                    pShadowCaster._optimizeProjectionMatrix();
                    return pResult;
                };
                ProjectLight._pFrustumPlanes = new Array(6);
                return ProjectLight;
            })(light.LightPoint);
            light.ProjectLight = ProjectLight;            
            for(var i = 0; i < 6; i++) {
                ProjectLight._pFrustumPlanes[i] = new akra.geometry.Plane3d();
            }
        })(scene.light || (scene.light = {}));
        var light = scene.light;
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        (function (light) {
            var OmniLight = (function (_super) {
                __extends(OmniLight, _super);
                function OmniLight(pScene) {
                                _super.call(this, pScene, akra.ELightTypes.OMNI);
                    this._pDepthTextureCube = null;
                    this._pColorTextureCube = null;
                    this._pShadowCasterCube = null;
                    this._pShadowCasterCube = new Array(6);
                    for(var i = 0; i < 6; i++) {
                        this._pShadowCasterCube[i] = pScene._createShadowCaster(this, i);
                    }
                }
                OmniLight.prototype.create = function (isShadowCaster, iMaxShadowResolution) {
                    if (typeof isShadowCaster === "undefined") { isShadowCaster = true; }
                    if (typeof iMaxShadowResolution === "undefined") { iMaxShadowResolution = 256; }
                    var isOk = _super.prototype.create.call(this, isShadowCaster, iMaxShadowResolution);
                    var pCasterCube = this._pShadowCasterCube;
                    var pCaster;
                    for(var i = 0; i < 6; i++) {
                        pCaster = pCasterCube[i];
                        pCaster.setInheritance(akra.ENodeInheritance.ALL);
                        pCaster.attachToParent(this);
                        pCaster.setProjParams(akra.math.PI / 2, 1, 0.01, 1000);
                        pCaster.setParameter(akra.ECameraParameters.CONST_ASPECT, true);
                    }
                    pCasterCube[0].localMatrix = akra.mat4([
                        0, 
                        0, 
                        1, 
                        0, 
                        0, 
                        1, 
                        0, 
                        0, 
                        -1, 
                        0, 
                        0, 
                        0, 
                        0, 
                        0, 
                        0, 
                        1
                    ]);
                    pCasterCube[1].localMatrix = akra.mat4([
                        0, 
                        0, 
                        -1, 
                        0, 
                        0, 
                        1, 
                        0, 
                        0, 
                        1, 
                        0, 
                        0, 
                        0, 
                        0, 
                        0, 
                        0, 
                        1
                    ]);
                    pCasterCube[2].localMatrix = akra.mat4([
                        1, 
                        0, 
                        0, 
                        0, 
                        0, 
                        0, 
                        1, 
                        0, 
                        0, 
                        -1, 
                        0, 
                        0, 
                        0, 
                        0, 
                        0, 
                        1
                    ]);
                    pCasterCube[3].localMatrix = akra.mat4([
                        1, 
                        0, 
                        0, 
                        0, 
                        0, 
                        0, 
                        -1, 
                        0, 
                        0, 
                        1, 
                        0, 
                        0, 
                        0, 
                        0, 
                        0, 
                        1
                    ]);
                    pCasterCube[4].localMatrix = akra.mat4([
                        -1, 
                        0, 
                        0, 
                        0, 
                        0, 
                        1, 
                        0, 
                        0, 
                        0, 
                        0, 
                        -1, 
                        0, 
                        0, 
                        0, 
                        0, 
                        1
                    ]);
                    pCasterCube[5].localMatrix = akra.mat4([
                        1, 
                        0, 
                        0, 
                        0, 
                        0, 
                        1, 
                        0, 
                        0, 
                        0, 
                        0, 
                        1, 
                        0, 
                        0, 
                        0, 
                        0, 
                        1
                    ]);
                    if (this.isShadowCaster) {
                        this.initializeTextures();
                    }
                    return isOk;
                };
                OmniLight.prototype.getDepthTextureCube = function () {
                    return this._pDepthTextureCube;
                };
                OmniLight.prototype.getRenderTarget = function (iFace) {
                    return this._pColorTextureCube[iFace].getBuffer().getRenderTarget();
                };
                OmniLight.prototype.getShadowCaster = function () {
                    return this._pShadowCasterCube;
                };
                Object.defineProperty(OmniLight.prototype, "isShadowCaster", {
                    get: function () {
                        return this._isShadowCaster;
                    },
                    set: function (bValue) {
                        this._isShadowCaster = bValue;
                        if (bValue && ((this._pDepthTextureCube) === null)) {
                            this.initializeTextures();
                        }
                    },
                    enumerable: true,
                    configurable: true
                });
                OmniLight.prototype.initializeTextures = function () {
                    var pEngine = this.scene.getManager().getEngine();
                    var pResMgr = pEngine.getResourceManager();
                    var iSize = this._iMaxShadowResolution;
                    this._pDepthTextureCube = new Array(6);
                    this._pColorTextureCube = new Array(6);
                    for(var i = 0; i < 6; ++i) {
                        var pDepthTexture = this._pDepthTextureCube[i] = pResMgr.createTexture("depth_texture_" + i + "_" + this.getGuid());
                        pDepthTexture.create(iSize, iSize, 1, null, 0, 0, 0, akra.ETextureTypes.TEXTURE_2D, akra.EPixelFormats.DEPTH32);
                        pDepthTexture.setWrapMode(akra.ETextureParameters.WRAP_S, akra.ETextureWrapModes.CLAMP_TO_EDGE);
                        pDepthTexture.setWrapMode(akra.ETextureParameters.WRAP_T, akra.ETextureWrapModes.CLAMP_TO_EDGE);
                        pDepthTexture.setFilter(akra.ETextureParameters.MAG_FILTER, akra.ETextureFilters.LINEAR);
                        pDepthTexture.setFilter(akra.ETextureParameters.MIN_FILTER, akra.ETextureFilters.LINEAR);
                        var pColorTexture = this._pColorTextureCube[i] = pResMgr.createTexture("light_color_texture_" + i + "_" + this.getGuid());
                        pColorTexture.create(iSize, iSize, 1, null, akra.ETextureFlags.RENDERTARGET, 0, 0, akra.ETextureTypes.TEXTURE_2D, akra.EPixelFormats.R8G8B8A8);
                        this.getRenderTarget(i).attachDepthTexture(pDepthTexture);
                        this.getRenderTarget(i).addViewport(this._pShadowCasterCube[i], akra.EViewportTypes.SHADOWVIEWPORT);
                        this.getRenderTarget(i).setAutoUpdated(false);
                    }
                };
                OmniLight.prototype._calculateShadows = function () {
                    if (this.enabled && this.isShadowCaster) {
                        for(var i = 0; i < 6; i++) {
                            this.getRenderTarget(i).update();
                        }
                    }
                };
                OmniLight.prototype._prepareForLighting = function (pCamera) {
                    if (!this.enabled) {
                        return false;
                    } else {
                        var haveInfluence = false;
                        if (!this.isShadowCaster) {
                            for(var i = 0; i < 6; i++) {
                                var pResult = this._defineLightingInfluence(pCamera, i);
                                if (pResult.length != 0) {
                                    haveInfluence = true;
                                }
                            }
                            return haveInfluence;
                        } else {
                            for(var i = 0; i < 6; i++) {
                                var pResult = this._defineShadowInfluence(pCamera, i);
                                if (pResult.length != 0) {
                                    haveInfluence = true;
                                }
                            }
                            return haveInfluence;
                        }
                    }
                };
                OmniLight.prototype._defineLightingInfluence = function (pCamera, iFace) {
                    var pShadowCaster = this._pShadowCasterCube[iFace];
                    var pCameraFrustum = pCamera.frustum;
                    var pResult = pShadowCaster.affectedObjects;
                    pResult.clear();
                    if (!pCameraFrustum.testFrustum(pShadowCaster.frustum)) {
                        return pResult;
                    }
                    var pRawResult = pShadowCaster.display(0);
                    for(var i = 0; i < pRawResult.length; i++) {
                        var pObject = pRawResult.value(i);
                        if (pCameraFrustum.testRect(pObject.worldBounds)) {
                            pResult.push(pObject);
                        }
                    }
                    return pResult;
                };
                OmniLight.prototype._defineShadowInfluence = function (pCamera, iFace) {
                    var pShadowCaster = this._pShadowCasterCube[iFace];
                    var pCameraFrustum = pCamera.frustum;
                    var pResult = pShadowCaster.affectedObjects;
                    pResult.clear();
                    if (!pCameraFrustum.testFrustum(pShadowCaster.frustum)) {
                        return pResult;
                    }
                    var pRawResult = pShadowCaster.display(0);
                    var v3fLightPosition = this.worldPosition;
                    var pTestArray = OmniLight._pFrustumPlanes;
                    var pFrustumPlanesKeys = akra.geometry.Frustum.frustumPlanesKeys;
                    for(var i = 0; i < 6; i++) {
                        var sKey = pFrustumPlanesKeys[i];
                        var pPlane = pCameraFrustum[sKey];
                        var v3fNormal = pPlane.normal;
                        var fDistance = pPlane.distance;
                        if (pPlane.signedDistance(v3fLightPosition) > 0) {
                            fDistance = -v3fNormal.dot(v3fLightPosition);
                        }
                        pTestArray[i].set(v3fNormal, fDistance);
                    }
                    for(var i = 0; i < pRawResult.length; i++) {
                        var pObject = pRawResult.value(i);
                        var pWorldBounds = pObject.worldBounds;
                        if (pObject.hasShadow) {
                            var j = 0;
                            for(j = 0; j < 6; j++) {
                                var pPlane = pTestArray[j];
                                if (akra.geometry.planeClassifyRect3d(pPlane, pWorldBounds) == akra.EPlaneClassifications.PLANE_FRONT) {
                                    break;
                                }
                            }
                            if (j == 6) {
                                pResult.push(pObject);
                            }
                        } else {
                            if (pCameraFrustum.testRect(pWorldBounds)) {
                                pResult.push(pObject);
                            }
                        }
                    }
                    pShadowCaster._optimizeProjectionMatrix();
                    return pResult;
                };
                OmniLight._pFrustumPlanes = new Array(6);
                return OmniLight;
            })(light.LightPoint);
            light.OmniLight = OmniLight;            
            for(var i = 0; i < 6; i++) {
                OmniLight._pFrustumPlanes[i] = new akra.geometry.Plane3d();
            }
        })(scene.light || (scene.light = {}));
        var light = scene.light;
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        var Scene3d = (function () {
            function Scene3d(pSceneManager) {
                this._pDisplayLists = [];
                this._pDisplayListsCount = 0;
                this._isUpdated = false;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._pSceneManager = pSceneManager;
                this._pRootNode = this.createNode("root-node");
                this._pRootNode.create();
                var i;
                var pOctree = new akra.scene.OcTree();
                pOctree.create(new akra.geometry.Rect3d(1024, 1024, 1024), 5, 100);
                var i = this.addDisplayList(pOctree);
 {
                    akra.logger.setSourceLocation("Scene3d.ts", 61);
                    akra.logger.assert(i == 0, "invalid default list index");
                }
                ;
                var pLightGraph = new akra.scene.LightGraph();
                i = this.addDisplayList(pLightGraph);
 {
                    akra.logger.setSourceLocation("Scene3d.ts", 66);
                    akra.logger.assert(i == 1, "invalid default list index");
                }
                ;
            }
            Object.defineProperty(Scene3d.prototype, "type", {
                get: function () {
                    return akra.ESceneTypes.TYPE_3D;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Scene3d.prototype, "totalDL", {
                get: function () {
                    return this._pDisplayListsCount;
                },
                enumerable: true,
                configurable: true
            });
            Scene3d.prototype.getManager = function () {
                return this._pSceneManager;
            };
            Scene3d.prototype.isUpdated = function () {
                return this._isUpdated;
            };
            Scene3d.prototype.getRootNode = function () {
                return this._pRootNode;
            };
            Scene3d.prototype.recursivePreUpdate = function () {
                this._isUpdated = false;
                this.preUpdate();
                this._pRootNode.recursivePreUpdate();
            };
            Scene3d.prototype.recursiveUpdate = function () {
                this.beforeUpdate();
                this._isUpdated = this._pRootNode.recursiveUpdate();
                this.postUpdate();
            };
            Scene3d.prototype.updateCamera = function () {
                return false;
            };
            Scene3d.prototype.updateScene = function () {
                return false;
            };
            Scene3d.prototype.createObject = function (sName) {
                if (typeof sName === "undefined") { sName = null; }
                var pNode = new scene.SceneObject(this);
                if (!pNode.create()) {
 {
                        akra.logger.setSourceLocation("Scene3d.ts", 122);
                        akra.logger.error("cannot create scene node..");
                    }
                    ;
                    return null;
                }
                return this.setupNode(pNode, sName);
            };
            Scene3d.prototype.createNode = function (sName) {
                if (typeof sName === "undefined") { sName = null; }
                var pNode = new scene.SceneNode(this);
                if (!pNode.create()) {
 {
                        akra.logger.setSourceLocation("Scene3d.ts", 135);
                        akra.logger.error("cannot create scene node..");
                    }
                    ;
                    return null;
                }
                return this.setupNode(pNode, sName);
            };
            Scene3d.prototype.createModel = function (sName) {
                if (typeof sName === "undefined") { sName = null; }
                var pNode = new scene.SceneModel(this);
                if (!pNode.create()) {
 {
                        akra.logger.setSourceLocation("Scene3d.ts", 146);
                        akra.logger.error("cannot create model..");
                    }
                    ;
                    return null;
                }
                return this.setupNode(pNode, sName);
            };
            Scene3d.prototype.createCamera = function (sName) {
                if (typeof sName === "undefined") { sName = null; }
                var pCamera = new scene.objects.Camera(this);
                if (!pCamera.create()) {
 {
                        akra.logger.setSourceLocation("Scene3d.ts", 157);
                        akra.logger.error("cannot create camera..");
                    }
                    ;
                    return null;
                }
                return this.setupNode(pCamera, sName);
            };
            Scene3d.prototype.createLightPoint = function (eType, isShadowCaster, iMaxShadowResolution, sName) {
                if (typeof eType === "undefined") { eType = akra.ELightTypes.UNKNOWN; }
                if (typeof isShadowCaster === "undefined") { isShadowCaster = true; }
                if (typeof iMaxShadowResolution === "undefined") { iMaxShadowResolution = 256; }
                if (typeof sName === "undefined") { sName = null; }
                var pLight;
                switch(eType) {
                    case akra.ELightTypes.PROJECT:
                        pLight = (new scene.light.ProjectLight(this));
                        break;
                    case akra.ELightTypes.OMNI:
                        pLight = (new scene.light.OmniLight(this));
                        break;
                    default:
                        return null;
                }
                if (!pLight.create(isShadowCaster, iMaxShadowResolution)) {
 {
                        akra.logger.setSourceLocation("Scene3d.ts", 180);
                        akra.logger.error("cannot create light");
                    }
                    ;
                    return null;
                }
                return this.setupNode(pLight, sName);
            };
            Scene3d.prototype.createSprite = function (sName) {
                if (typeof sName === "undefined") { sName = null; }
                return null;
            };
            Scene3d.prototype.createJoint = function (sName) {
                if (typeof sName === "undefined") { sName = null; }
                return this.setupNode(new scene.Joint(this), sName);
            };
            Scene3d.prototype._createModelEntry = function (pModel) {
                return this.setupNode(new scene.objects.ModelEntry(this, pModel));
            };
            Scene3d.prototype.createText3d = function (sName) {
                if (typeof sName === "undefined") { sName = null; }
                return null;
            };
            Scene3d.prototype.createTerrain = function (sName) {
                var pTerrain = new akra.terrain.Terrain(this);
                if (!pTerrain.create()) {
 {
                        akra.logger.setSourceLocation("Scene3d.ts", 207);
                        akra.logger.error("cannot create terrain..");
                    }
                    ;
                    return null;
                }
                return this.setupNode(pTerrain, sName);
            };
            Scene3d.prototype.createTerrainROAM = function (sName) {
                var pTerrainROAM = new akra.terrain.TerrainROAM(this);
                if (!pTerrainROAM.create()) {
 {
                        akra.logger.setSourceLocation("Scene3d.ts", 218);
                        akra.logger.error("cannot create terrain..");
                    }
                    ;
                    return null;
                }
                return this.setupNode(pTerrainROAM, sName);
            };
            Scene3d.prototype.createTerrainSection = function (sName) {
                var pNode = new akra.terrain.TerrainSection(this);
                if (!pNode.create()) {
 {
                        akra.logger.setSourceLocation("Scene3d.ts", 229);
                        akra.logger.error("cannot create terrain section..");
                    }
                    ;
                    return null;
                }
                return this.setupNode(pNode, sName);
            };
            Scene3d.prototype.createTerrainSectionROAM = function (sName) {
                var pNode = new akra.terrain.TerrainSectionROAM(this);
                if (!pNode.create()) {
 {
                        akra.logger.setSourceLocation("Scene3d.ts", 240);
                        akra.logger.error("cannot create terrain section roam..");
                    }
                    ;
                    return null;
                }
                return this.setupNode(pNode, sName);
            };
            Scene3d.prototype._createShadowCaster = function (pLightPoint, iFace, sName) {
                if (typeof iFace === "undefined") { iFace = akra.ECubeFace.POSITIVE_X; }
                if (typeof sName === "undefined") { sName = null; }
                var pShadowCaster = new scene.light.ShadowCaster(pLightPoint, iFace);
                if (!pShadowCaster.create()) {
 {
                        akra.logger.setSourceLocation("Scene3d.ts", 251);
                        akra.logger.error("cannot create shadow caster..");
                    }
                    ;
                    return null;
                }
                return this.setupNode(pShadowCaster, sName);
            };
            Scene3d.prototype.getDisplayList = function (i) {
 {
                    akra.logger.setSourceLocation("Scene3d.ts", 268);
                    akra.logger.assert(((this._pDisplayLists[i]) != null), "display list not defined");
                }
                ;
                return this._pDisplayLists[i];
            };
            Scene3d.prototype.getDisplayListByName = function (csName) {
                for(var i = 0; i < this._pDisplayLists.length; ++i) {
                    if (this._pDisplayLists[i].name === csName) {
                        return i;
                    }
                }
                return -1;
            };
            Scene3d.prototype._render = function (pCamera, pViewport) {
            };
            Scene3d.prototype.setupNode = function (pNode, sName) {
                if (typeof sName === "undefined") { sName = null; }
                pNode.name = sName;
                this.connect(pNode, "attached", "nodeAttachment", akra.EEventTypes.UNICAST);
                this.connect(pNode, "detached", "nodeDetachment", akra.EEventTypes.UNICAST);
                return pNode;
            };
            Scene3d.prototype.delDisplayList = function (index) {
                var pLists = this._pDisplayLists;
                for(var i = 0; i < pLists.length; ++i) {
                    if (i === index && ((pLists[i]) != null)) {
                        pLists[i] = null;
                        this._pDisplayListsCount--;
                        this.displayListRemoved(pLists[i], i);
                        return true;
                    }
                }
                ;
                return false;
            };
            Scene3d.prototype.addDisplayList = function (pList) {
 {
                    akra.logger.setSourceLocation("Scene3d.ts", 323);
                    akra.logger.assert(((this.getDisplayListByName(pList.name)) != null), "DL with name <" + pList.name + "> already exists");
                }
                ;
                var pLists = this._pDisplayLists;
                var iIndex = this._pDisplayLists.length;
                for(var i = 0; i < pLists.length; ++i) {
                    if (pLists[i] === null) {
                        pLists[i] = pList;
                        iIndex = i;
                        break;
                    }
                }
                ;
                if (iIndex == this._pDisplayLists.length) {
                    this._pDisplayLists.push(pList);
                }
                pList._setup(this);
                this.displayListAdded(pList, iIndex);
                this._pDisplayListsCount++;
                return iIndex;
            };
            Scene3d.prototype.getGuid = function () {
                return this._iGuid;
            };
            Scene3d._pEventTable = new akra.events.EventTable();
            Scene3d.prototype.getEventTable = function () {
                return Scene3d._pEventTable;
            };
            Scene3d.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Scene3d.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Scene3d.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Scene3d.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Scene3d.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            Scene3d.prototype.nodeAttachment = function (pNode) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).nodeAttachment;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pNode) : _broadcast[i].listener(_recivier, pNode);
                    }
                }
                ;
            };
            Scene3d.prototype.nodeDetachment = function (pNode) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).nodeDetachment;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pNode) : _broadcast[i].listener(_recivier, pNode);
                    }
                }
                ;
            };
            Scene3d.prototype.displayListAdded = function (list, index) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).displayListAdded;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, list, index) : _broadcast[i].listener(_recivier, list, index);
                    }
                }
            };
            Scene3d.prototype.displayListRemoved = function (list, index) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).displayListRemoved;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, list, index) : _broadcast[i].listener(_recivier, list, index);
                    }
                }
            };
            Scene3d.prototype.beforeUpdate = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).beforeUpdate;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            Scene3d.prototype.postUpdate = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).postUpdate;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            Scene3d.prototype.preUpdate = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).preUpdate;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            return Scene3d;
        })();
        scene.Scene3d = Scene3d;        
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (scene) {
        var SceneManager = (function () {
            function SceneManager(pEngine) {
                this._pEngine = null;
                this._pSceneList = [];
                this._fUpdateTimeCount = 0.;
                this._fMillisecondsPerTick = 0.01666;
                this._pEngine = pEngine;
            }
            SceneManager.prototype.getEngine = function () {
                return this._pEngine;
            };
            SceneManager.prototype.update = function () {
                var isSceneUpdated = false;
                this._fUpdateTimeCount += this._pEngine.elapsedTime;
                var fUpdateTime = this._fUpdateTimeCount;
                while(this._fUpdateTimeCount > this._fMillisecondsPerTick) {
                    this.notifyUpdateScene();
                    this._fUpdateTimeCount -= this._fMillisecondsPerTick;
                }
                if (fUpdateTime !== this._fUpdateTimeCount) {
                    this.notifyPreUpdateScene();
                }
            };
            SceneManager.prototype.notifyUpdateScene = function () {
                for(var i = 0; i < this._pSceneList.length; ++i) {
                    var pScene = this._pSceneList[i];
                    if (pScene.type != akra.ESceneTypes.TYPE_3D) {
                        continue;
                    }
                    (pScene).recursiveUpdate();
                }
            };
            SceneManager.prototype.notifyPreUpdateScene = function () {
                for(var i = 0; i < this._pSceneList.length; ++i) {
                    var pScene = this._pSceneList[i];
                    if (pScene.type != akra.ESceneTypes.TYPE_3D) {
                        continue;
                    }
                    (pScene).recursivePreUpdate();
                }
            };
            SceneManager.prototype.createScene3D = function () {
                var pScene = new scene.Scene3d(this);
                this._pSceneList.push(pScene);
                return pScene;
            };
            SceneManager.prototype.createScene2D = function () {
                return null;
            };
            SceneManager.prototype.createUI = function () {
                var pUI = new akra.ui.UI(this);
                return pUI;
            };
            SceneManager.prototype.getScene3D = function (iScene) {
                if (typeof iScene === "undefined") { iScene = 0; }
                var pScene;
                if (iScene === 0 && this._pSceneList.length === 0) {
                    this.createScene3D();
 {
                        akra.logger.setSourceLocation("scene/SceneManager.ts", 109);
                        akra.logger.log("Default scene automatically created.");
                    }
                    ;
                }
                pScene = this._pSceneList[iScene];
                if (pScene && pScene.type === akra.ESceneTypes.TYPE_3D) {
                    return pScene;
                }
                return null;
            };
            SceneManager.prototype.getScene2D = function (IScene) {
                var pScene = this._pSceneList[IScene];
                if (pScene && pScene.type === akra.ESceneTypes.TYPE_2D) {
                    return pScene;
                }
                return null;
            };
            SceneManager.prototype.getScene = function (IScene, eType) {
                return this._pSceneList[IScene] || null;
            };
            SceneManager.prototype.initialize = function () {
                return true;
            };
            SceneManager.prototype.destroy = function () {
            };
            return SceneManager;
        })();
        scene.SceneManager = SceneManager;        
    })(akra.scene || (akra.scene = {}));
    var scene = akra.scene;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        akra.logger.registerCode(2201, "You trying to redefine system type: {typeName}. In line: {line}. In column: {column}");
        akra.logger.registerCode(2202, "You trying to redefine type: {typeName}. In line: {line}. In column: {column}");
        akra.logger.registerCode(2203, "You try to use unssuported type declaration. We implement it soon. In line: {line}.");
        akra.logger.registerCode(2204, "You try to use unssuported expr: {exprName}. We implement it soon. In line: {line}.");
        akra.logger.registerCode(2205, "Unknown variable name: {varName}. In line: {line}. In column: {column}");
        akra.logger.registerCode(2206, "Invalid arithmetic operation!. There no operator '{operator}'" + " for left-type '{leftTypeName}' " + " and right-type '{rightTypeName}'. In line: {line}.");
        akra.logger.registerCode(2207, "Invalid arithmetic-assignment operation!. " + " There no operator {operator} for left-type '{leftTypeName}' " + " and right-type '{rightTypeName}'. In line: {line}.");
        akra.logger.registerCode(2208, "Invalid assignment operation!. It`s no possible to do assignment " + " between left-type '{leftTypeName}' " + " and right-type '{rightTypeName}'. In line: {line}.");
        akra.logger.registerCode(2209, "Invalid relational operation!. There no operator {operator} " + " for left-type '{leftTypeName}' " + " and right-type '{rightTypeName}'. In line: {line}.");
        akra.logger.registerCode(2210, "Invalid logical operation!. In operator: {operator}. " + " Cannot convert type '{typeName}' to 'bool'. In line: {line}.");
        akra.logger.registerCode(2211, "Invalid conditional expression!. Cannot convert type '{typeName}' to 'bool'. " + " In line: {line}.");
        akra.logger.registerCode(2212, "Invalid conditional expression!. Type '{leftTypeName}' and type '{rightTypeName}'" + " are not equal. In line: {line}.");
        akra.logger.registerCode(2213, "Invalid type cast!. Bad type casting. Only base types without usages are supported. " + " WebGL don`t support so casting. In line: {line}.");
        akra.logger.registerCode(2214, "Invalid type cast!. Bad type for casting '{typeName}'. " + " WebGL support only base-type casting. In line: {line}.");
        akra.logger.registerCode(2216, "Invalid unary expression!. Bad type: '{typeName}' " + " for operator '{opeator}'. In line: {line}.");
        akra.logger.registerCode(2217, "Invalid postfix-array expression!. " + " Type of expression is not array: '{typeName}'. In line: {line}.");
        akra.logger.registerCode(2218, "Invalid postfix-array expression!. Bad type of index: '{typeName}'. " + "Must be 'int'. In line: {line}.");
        akra.logger.registerCode(2219, "Invalid postfix-point expression!. Type '{typeName}' has no field '{fieldName}'. " + "In line: {line}.");
        akra.logger.registerCode(2220, "Invalid postfix-point expression!. Type '{typeName}' is not pointer. " + "In line: {line}.");
        akra.logger.registerCode(2221, "Invalid postfix-arithmetic expression!. Bad type '{typeName}' " + "for operator {operator}. In line: {line}.");
        akra.logger.registerCode(2222, "Invalid primary expression!. Bad type '{typeName}'." + "It`s not pointer. In line: {line}.");
        akra.logger.registerCode(2223, "Invalid function call expression!. Could not find function-signature " + "with name {funcName} and so types. In line: {line}.");
        akra.logger.registerCode(2224, "Invalid constructor call!. There are not so type. In line: {line}.");
        akra.logger.registerCode(2225, "Invalid constructor call!. Could not find constructor-signature " + "with name {typeName} and so types. In line: {line}.");
        akra.logger.registerCode(2226, "Invalid compile expression!. Could not find function-signature " + "with name {funcName} and so types. In line: {line}.");
        akra.logger.registerCode(2227, "You try to redefine function. With name {funcName}. In line: {line}.");
        akra.logger.registerCode(2228, "Bad type of while-condition. Must be 'bool' but it is '{typeName}'. " + "In line: {line}.");
        akra.logger.registerCode(2229, "Bad type of do-while-condition. Must be 'bool' but it is '{typeName}'. " + "In line: {line}.");
        akra.logger.registerCode(2230, "Bad type of if-condition. Must be 'bool' but it is '{typeName}'. " + "In line: {line}.");
        akra.logger.registerCode(2231, "Bad for-init expression. WebGL support only VariableDecl as for-init expression, " + "like \"int i = 0;\" or \"float i = 0.0;\". " + "In line: {line}.");
        akra.logger.registerCode(2232, "Bad for-init expression. WebGL support only VariableDecl as for-init expression, " + "like \"int i = 0;\" or \"float i = 0.0;\". " + "In line: {line}.");
        akra.logger.registerCode(2233, "Bad for-cond expression. WebGL does not support empty conditional expression in for-loop. " + "In line: {line}.");
        akra.logger.registerCode(2238, "Bad for-cond expression. WebGL support only relational expression for condition in for-loop. " + "In line: {line}.");
        akra.logger.registerCode(2239, "Bad for-step expression. WebGL does not support empty step expression. " + "In line: {line}.");
        akra.logger.registerCode(2240, "Bad for-step expression. WebGL does not support operator '{operator}' in step expression. " + "In line: {line}.");
        akra.logger.registerCode(2241, "Bad for-step expression. WebGL support only unary and assignment expression in for-step. " + "In line: {line}.");
        akra.logger.registerCode(2235, "You trying to redefine system variable: {varName}. In line: {line}. In column: {column}");
        akra.logger.registerCode(2234, "You trying to redefine variable: {varName}. In line: {line}. In column: {column}");
        akra.logger.registerCode(2237, "You trying to redefine system function: {funcName}. In line: {line}. In column: {column}");
        akra.logger.registerCode(2236, "You trying to redefine function: {funcName}. In line: {line}. In column: {column}");
        akra.logger.registerCode(2242, "You trying to add field to struct with name '{varName}', but it`s already in it. " + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2243, "You trying to add field to struct with semantic '{semanticName}'," + "but struct already has this semantic." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2244, "Bad variable name '{varName}'. Annotation already has variable with that name." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2245, "Bad parameter '{varName}' in function '{funcName}'. Need default value." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2246, "Bad function call. There are two or more call signatures for function '{funcName}'." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2247, "Bad function definition. There are two or more different retturn type signatures for function '{funcName}'." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2248, "Bad system function '{funcName}'. Already have this function.");
        akra.logger.registerCode(2250, "Bad type. Could not find type with name '{typeName}'." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2251, "Bad type. We don`t support vector and matrix typename." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2252, "Bad technique name '{techName}'. Effect already have technique with that name." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2253, "Bad 'memof'-operator argument. Literal for its argument is bad idea." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2254, "Bad 'memof'-operator argument. No buffer for argument." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2255, "Bad function '{funcDef}'. It is recursion.");
        akra.logger.registerCode(2256, "Bad function '{funcDef}'. It use bad-function with recursion.");
        akra.logger.registerCode(2257, "Bad function '{funcDef}'. Can not use in vertex-shader.");
        akra.logger.registerCode(2258, "Bad function '{funcDef}'. Can not use in pixel-shader.");
        akra.logger.registerCode(2259, "Bad function with defenition '{funcDef}'. Can not be used as vertex-shader.");
        akra.logger.registerCode(2260, "Bad function with defenition '{funcDef}'. Can not be used as pixel-shader.");
        akra.logger.registerCode(2261, "Bad return stmt. You try to return something in void-function." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2262, "Bad return stmt. You can not call empty return in non-void-function." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2263, "Bad return stmt. Types of return expression and return type of function are not equal." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2264, "Bad return type for '{funcName}'. Return type for function can not contain or be sampler/pointer." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2265, "Bad parameter '{varName}' in function '{funcName}'. Bad usage." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2266, "Bad variable with name 'Out'. It is sytem for used like return variable in shaders." + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2267, "Variable type is not writable. " + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2268, "Variable type is not readable. " + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2269, "Bad init expr for variable '{varName}'. " + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2270, "Don`t supported construction '[uint]' in sampler_state. " + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2271, "Incorrect texture setup for sampler. " + "In line: {line}. In column: {column}");
        akra.logger.registerCode(2272, "Can not calculate padding for type '{typeName}'.");
        akra.logger.registerCode(2273, "Can not extract type '{typeName}'.");
        akra.logger.registerCode(2274, "Bad extract exrpression.");
        akra.logger.registerCode(2275, "Bad imports in technique '{techniqueName}'.");
        akra.logger.registerCode(2276, "You try use 'engine' variable in out of pass." + "In line: {line}. In column: {column}.");
        akra.logger.registerCode(2277, "You try to import not exuisted component '{componentName}'");
        akra.logger.registerCode(2300, "We don`t support array of pinters now. Only pointe to array.                              In line: {line}. In column: {column}");
        akra.logger.registerCode(2301, "We don`t support using complex shader input like functions params.                             Shader: '{funcName}'");
        akra.logger.registerCode(2302, "We don`t support using complex shader output like functions params.                             Shader: '{funcName}'");
        akra.logger.registerCode(2303, "We don`t support 'provide ... as' operator now.");
        function sourceLocationToString(pLocation) {
            var sLocation = "[" + pLocation.file + ":" + pLocation.line.toString() + "]: ";
            return sLocation;
        }
        function syntaxErrorLogRoutine(pLogEntity) {
            var sPosition = sourceLocationToString(pLogEntity.location);
            var sError = "Code: " + pLogEntity.code.toString() + ". ";
            var pParseMessage = pLogEntity.message.split(/\{(\w+)\}/);
            var pInfo = pLogEntity.info;
            for(var i = 0; i < pParseMessage.length; i++) {
                if (((pInfo[pParseMessage[i]]) !== undefined)) {
                    pParseMessage[i] = pInfo[pParseMessage[i]];
                }
            }
            var sMessage = sPosition + sError + pParseMessage.join("");
            console["error"].call(console, sMessage);
        }
        akra.logger.setCodeFamilyRoutine("EffectSyntaxErrors", syntaxErrorLogRoutine, akra.ELogLevel.ERROR);
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        (function (EScopeType) {
            EScopeType._map = [];
            EScopeType._map[0] = "k_Default";
            EScopeType.k_Default = 0;
            EScopeType._map[1] = "k_Struct";
            EScopeType.k_Struct = 1;
            EScopeType._map[2] = "k_Annotation";
            EScopeType.k_Annotation = 2;
        })(fx.EScopeType || (fx.EScopeType = {}));
        var EScopeType = fx.EScopeType;
        var ProgramScope = (function () {
            function ProgramScope() {
                this._pScopeMap = {};
                this._iCurrentScope = null;
                this._nScope = 0;
            }
            ProgramScope.prototype.isStrictMode = function (iScope) {
                if (typeof iScope === "undefined") { iScope = this._iCurrentScope; }
                var pScope = this._pScopeMap[iScope];
                while(!((pScope) === null)) {
                    if (pScope.isStrictMode) {
                        return true;
                    }
                    pScope = pScope.parent;
                }
                return false;
            };
            ProgramScope.prototype.setStrictModeOn = function (iScope) {
                if (typeof iScope === "undefined") { iScope = this._iCurrentScope; }
                this._pScopeMap[iScope].isStrictMode = true;
            };
            ProgramScope.prototype.newScope = function (eType) {
                var isFirstScope = false;
                var pParentScope;
                if (((this._iCurrentScope) === null)) {
                    pParentScope = null;
                } else {
                    pParentScope = this._pScopeMap[this._iCurrentScope];
                }
                this._iCurrentScope = this._nScope++;
                var pNewScope = {
                    parent: pParentScope,
                    index: this._iCurrentScope,
                    type: eType,
                    isStrictMode: false,
                    variableMap: null,
                    typeMap: null,
                    functionMap: null
                };
                this._pScopeMap[this._iCurrentScope] = pNewScope;
            };
            ProgramScope.prototype.resumeScope = function () {
                if (this._nScope === 0) {
                    return;
                }
                this._iCurrentScope = this._nScope - 1;
            };
            ProgramScope.prototype.setScope = function (iScope) {
                this._iCurrentScope = iScope;
            };
            ProgramScope.prototype.getScope = function () {
                return this._iCurrentScope;
            };
            ProgramScope.prototype.endScope = function () {
                if (((this._iCurrentScope) === null)) {
                    return;
                }
                var pOldScope = this._pScopeMap[this._iCurrentScope];
                var pNewScope = pOldScope.parent;
                if (((pNewScope) === null)) {
                    this._iCurrentScope = null;
                } else {
                    this._iCurrentScope = pNewScope.index;
                }
            };
            ProgramScope.prototype.getScopeType = function () {
                return this._pScopeMap[this._iCurrentScope].type;
            };
            ProgramScope.prototype.getVariable = function (sVariableName, iScope) {
                if (typeof iScope === "undefined") { iScope = this._iCurrentScope; }
                if (((iScope) === null)) {
                    return null;
                }
                var pScope = this._pScopeMap[iScope];
                while(!((pScope) === null)) {
                    var pVariableMap = pScope.variableMap;
                    if (!((pVariableMap) === null)) {
                        var pVariable = pVariableMap[sVariableName];
                        if (((pVariable) !== undefined)) {
                            return pVariable;
                        }
                    }
                    pScope = pScope.parent;
                }
                return null;
            };
            ProgramScope.prototype.getType = function (sTypeName, iScope) {
                if (typeof iScope === "undefined") { iScope = this._iCurrentScope; }
                var pTypeDecl = this.getTypeDecl(sTypeName, iScope);
                if (!((pTypeDecl) === null)) {
                    return pTypeDecl.getType();
                } else {
                    return null;
                }
            };
            ProgramScope.prototype.getTypeDecl = function (sTypeName, iScope) {
                if (typeof iScope === "undefined") { iScope = this._iCurrentScope; }
                if (((iScope) === null)) {
                    return null;
                }
                var pScope = this._pScopeMap[iScope];
                while(!((pScope) === null)) {
                    var pTypeMap = pScope.typeMap;
                    if (!((pTypeMap) === null)) {
                        var pType = pTypeMap[sTypeName];
                        if (((pType) !== undefined)) {
                            return pType;
                        }
                    }
                    pScope = pScope.parent;
                }
                return null;
            };
            ProgramScope.prototype.getFunction = function (sFuncName, pArgumentTypes, iScope) {
                if (typeof iScope === "undefined") { iScope = 0; }
                if (((iScope) === null)) {
                    return null;
                }
                var pScope = this._pScopeMap[iScope];
                var pFunction = null;
                while(!((pScope) === null)) {
                    var pFunctionListMap = pScope.functionMap;
                    if (!((pFunctionListMap) === null)) {
                        var pFunctionList = pFunctionListMap[sFuncName];
                        if (((pFunctionList) !== undefined)) {
                            for(var i = 0; i < pFunctionList.length; i++) {
                                var pTestedFunction = pFunctionList[i];
                                var pTestedArguments = pTestedFunction.getArguments();
                                if (pArgumentTypes.length > pTestedArguments.length || pArgumentTypes.length < pTestedFunction.getNumNeededArguments()) {
                                    continue;
                                }
                                var isParamsEqual = true;
                                for(var j = 0; j < pArgumentTypes.length; j++) {
                                    isParamsEqual = false;
                                    if (!pArgumentTypes[j].getType().isEqual(pTestedArguments[j].getType())) {
                                        break;
                                    }
                                    isParamsEqual = true;
                                }
                                if (isParamsEqual) {
                                    if (!((pFunction) === null)) {
                                        return undefined;
                                    }
                                    pFunction = pTestedFunction;
                                }
                            }
                        }
                    }
                    pScope = pScope.parent;
                }
                return pFunction;
            };
            ProgramScope.prototype.getShaderFunction = function (sFuncName, pArgumentTypes, iScope) {
                if (typeof iScope === "undefined") { iScope = 0; }
                if (((iScope) === null)) {
                    return null;
                }
                var pScope = this._pScopeMap[iScope];
                var pFunction = null;
                while(!((pScope) === null)) {
                    var pFunctionListMap = pScope.functionMap;
                    if (!((pFunctionListMap) === null)) {
                        var pFunctionList = pFunctionListMap[sFuncName];
                        if (((pFunctionList) !== undefined)) {
                            for(var i = 0; i < pFunctionList.length; i++) {
                                var pTestedFunction = pFunctionList[i];
                                var pTestedArguments = pTestedFunction.getArguments();
                                if (pArgumentTypes.length > pTestedArguments.length) {
                                    continue;
                                }
                                var isParamsEqual = true;
                                var iArg = 0;
                                if (pArgumentTypes.length === 0) {
                                    if (!((pFunction) === null)) {
                                        return undefined;
                                    }
                                    pFunction = pTestedFunction;
                                    continue;
                                }
                                for(var j = 0; j < pTestedArguments.length; j++) {
                                    isParamsEqual = false;
                                    if (iArg >= pArgumentTypes.length) {
                                        if (pTestedArguments[j].isUniform()) {
                                            break;
                                        } else {
                                            isParamsEqual = true;
                                        }
                                    } else if (pTestedArguments[j].isUniform()) {
                                        if (!pArgumentTypes[iArg].getType().isEqual(pTestedArguments[j].getType())) {
                                            break;
                                        } else {
                                            iArg++;
                                            isParamsEqual = true;
                                        }
                                    }
                                }
                                if (isParamsEqual) {
                                    if (!((pFunction) === null)) {
                                        return undefined;
                                    }
                                    pFunction = pTestedFunction;
                                }
                            }
                        }
                    }
                    pScope = pScope.parent;
                }
                return pFunction;
            };
            ProgramScope.prototype.addVariable = function (pVariable, iScope) {
                if (typeof iScope === "undefined") { iScope = this._iCurrentScope; }
                if (((iScope) === null)) {
                    return false;
                }
                var pScope = this._pScopeMap[iScope];
                var pVariableMap = pScope.variableMap;
                if (((pVariableMap) === null)) {
                    pVariableMap = pScope.variableMap = {};
                }
                var sVariableName = pVariable.getName();
                if (!pVariable.getType().isShared()) {
                    if (this.hasVariableInScope(sVariableName, iScope)) {
                        return false;
                    }
                    pVariableMap[sVariableName] = pVariable;
                    pVariable._setScope(iScope);
                } else {
                    if (!this.hasVariableInScope(sVariableName, iScope)) {
                        pVariableMap[sVariableName] = pVariable;
                        pVariable._setScope(iScope);
                    } else {
                        var pBlendVariable = pVariableMap[sVariableName].blend(pVariable, akra.EAFXBlendMode.k_Shared);
                        if (((pBlendVariable) === null)) {
                            return false;
                        }
                        pVariableMap[sVariableName] = pBlendVariable;
                        pBlendVariable._setScope(iScope);
                    }
                }
                return true;
            };
            ProgramScope.prototype.addType = function (pType, iScope) {
                if (typeof iScope === "undefined") { iScope = this._iCurrentScope; }
                if (((iScope) === null)) {
                    return false;
                }
                var pScope = this._pScopeMap[iScope];
                var pTypeMap = pScope.typeMap;
                if (((pTypeMap) === null)) {
                    pTypeMap = pScope.typeMap = {};
                }
                var sTypeName = pType.getName();
                if (this.hasTypeInScope(sTypeName, iScope)) {
                    return false;
                }
                pTypeMap[sTypeName] = pType;
                pType._setScope(iScope);
                return true;
            };
            ProgramScope.prototype.addFunction = function (pFunction, iScope) {
                if (typeof iScope === "undefined") { iScope = 0; }
                if (((iScope) === null)) {
                    return false;
                }
                var pScope = this._pScopeMap[iScope];
                var pFunctionMap = pScope.functionMap;
                if (((pFunctionMap) === null)) {
                    pFunctionMap = pScope.functionMap = {};
                }
                var sFuncName = pFunction.getName();
                if (this.hasFunctionInScope(pFunction, iScope)) {
                    return false;
                }
                if (!((pFunctionMap[sFuncName]) !== undefined)) {
                    pFunctionMap[sFuncName] = [];
                }
                pFunctionMap[sFuncName].push(pFunction);
                pFunction._setScope(iScope);
                return true;
            };
            ProgramScope.prototype.hasVariable = function (sVariableName, iScope) {
                if (typeof iScope === "undefined") { iScope = this._iCurrentScope; }
                if (((iScope) === null)) {
                    return false;
                }
                var pScope = this._pScopeMap[iScope];
                while(!((pScope) === null)) {
                    var pVariableMap = pScope.variableMap;
                    if (!((pVariableMap) === null)) {
                        var pVariable = pVariableMap[sVariableName];
                        if (((pVariable) !== undefined)) {
                            return true;
                        }
                    }
                    pScope = pScope.parent;
                }
                return false;
            };
            ProgramScope.prototype.hasType = function (sTypeName, iScope) {
                if (typeof iScope === "undefined") { iScope = this._iCurrentScope; }
                if (((iScope) === null)) {
                    return false;
                }
                var pScope = this._pScopeMap[iScope];
                while(!((pScope) === null)) {
                    var pTypeMap = pScope.typeMap;
                    if (!((pTypeMap) === null)) {
                        var pType = pTypeMap[sTypeName];
                        if (((pType) !== undefined)) {
                            return true;
                        }
                    }
                    pScope = pScope.parent;
                }
                return false;
            };
            ProgramScope.prototype.hasFunction = function (sFuncName, pArgumentTypes, iScope) {
                if (typeof iScope === "undefined") { iScope = 0; }
                if (((iScope) === null)) {
                    return false;
                }
                var pScope = this._pScopeMap[iScope];
                while(!((pScope) === null)) {
                    var pFunctionListMap = pScope.functionMap;
                    if (!((pFunctionListMap) === null)) {
                        var pFunctionList = pFunctionListMap[sFuncName];
                        if (((pFunctionList) !== undefined)) {
                            var pFunction = null;
                            for(var i = 0; i < pFunctionList.length; i++) {
                                var pTestedFunction = pFunctionList[i];
                                var pTestedArguments = pTestedFunction.getArguments();
                                if (pArgumentTypes.length > pTestedArguments.length || pArgumentTypes.length < pTestedFunction.getNumNeededArguments()) {
                                    continue;
                                }
                                var isParamsEqual = true;
                                for(var j = 0; j < pArgumentTypes.length; j++) {
                                    isParamsEqual = false;
                                    if (!pArgumentTypes[j].getType().isEqual(pTestedArguments[j].getType())) {
                                        break;
                                    }
                                    isParamsEqual = true;
                                }
                                if (isParamsEqual) {
                                    return true;
                                }
                            }
                        }
                    }
                    pScope = pScope.parent;
                }
                return false;
            };
            ProgramScope.prototype.hasVariableInScope = function (sVariableName, iScope) {
                return ((this._pScopeMap[iScope].variableMap[sVariableName]) !== undefined);
            };
            ProgramScope.prototype.hasTypeInScope = function (sTypeName, iScope) {
                return ((this._pScopeMap[iScope].typeMap[sTypeName]) !== undefined);
            };
            ProgramScope.prototype.hasFunctionInScope = function (pFunction, iScope) {
                if (((iScope) === null)) {
                    return false;
                }
                var pScope = this._pScopeMap[iScope];
                var pFunctionListMap = pScope.functionMap;
                var pFunctionList = pFunctionListMap[pFunction.getName()];
                if (!((pFunctionList) !== undefined)) {
                    return false;
                }
                var pFunctionArguments = pFunction.getArguments();
                var hasFunction = false;
                for(var i = 0; i < pFunctionList.length; i++) {
                    var pTestedArguments = pFunctionList[i].getArguments();
                    if (pTestedArguments.length !== pFunctionArguments.length) {
                        continue;
                    }
                    var isParamsEqual = true;
                    for(var j = 0; j < pFunctionArguments.length; j++) {
                        isParamsEqual = false;
                        if (!pTestedArguments[j].getType().isEqual(pFunctionArguments[j].getType())) {
                            break;
                        }
                        isParamsEqual = true;
                    }
                    if (isParamsEqual) {
                        hasFunction = true;
                        break;
                    }
                }
                return hasFunction;
            };
            return ProgramScope;
        })();
        fx.ProgramScope = ProgramScope;        
        var ExprTemplateTranslator = (function () {
            function ExprTemplateTranslator(sExprTemplate) {
                this._pInToOutArgsMap = null;
                this._pExprPart = null;
                this._pInToOutArgsMap = {};
                this._pExprPart = [];
                var pSplitTemplate = sExprTemplate.split(/(\$\d+)/);
                for(var i = 0; i < pSplitTemplate.length; i++) {
                    if (pSplitTemplate[i]) {
                        if (pSplitTemplate[i][0] !== '$') {
                            this._pExprPart.push(new fx.SimpleInstruction(pSplitTemplate[i]));
                        } else {
                            this._pExprPart.push(null);
                            this._pInToOutArgsMap[this._pExprPart.length - 1] = (((pSplitTemplate[i].substr(1))) * 1 - 1);
                        }
                    }
                }
            }
            ExprTemplateTranslator.prototype.toInstructionList = function (pArguments) {
                var pOutputInstructionList = [];
                for(var i = 0; i < this._pExprPart.length; i++) {
                    if (((this._pExprPart[i]) === null)) {
                        pOutputInstructionList.push(pArguments[this._pInToOutArgsMap[i]]);
                    } else {
                        pOutputInstructionList.push(this._pExprPart[i]);
                    }
                }
                return pOutputInstructionList;
            };
            return ExprTemplateTranslator;
        })();
        fx.ExprTemplateTranslator = ExprTemplateTranslator;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        function getEffectBaseType(sTypeName) {
            return !((/*checked (origin: fx)>>*/akra.fx.Effect.pSystemTypes[sTypeName]) === null) ? (fx.Effect.pSystemTypes[sTypeName] || null) : null;
        }
        fx.getEffectBaseType = getEffectBaseType;
        function isSamplerType(pType) {
            return pType.isEqual(getEffectBaseType("sampler")) || pType.isEqual(getEffectBaseType("sampler2D")) || pType.isEqual(getEffectBaseType("samplerCUBE")) || pType.isEqual(getEffectBaseType("video_buffer"));
        }
        fx.isSamplerType = isSamplerType;
        var Instruction = (function () {
            function Instruction() {
                this._pParentInstruction = null;
                this._sOperatorName = null;
                this._pInstructionList = null;
                this._nInstructions = 0;
                this._eInstructionType = 0;
                this._pLastError = null;
                this._bErrorOccured = false;
                this._iInstructionID = 0;
                this._iScope = 0xffffff;
                this._isVisible = true;
                this._iInstructionID = Instruction._nInstructionCounter++;
                this._pParentInstruction = null;
                this._sOperatorName = null;
                this._pInstructionList = null;
                this._nInstructions = 0;
                this._eInstructionType = akra.EAFXInstructionTypes.k_Instruction;
                this._pLastError = {
                    code: 0,
                    info: null
                };
            }
            Instruction._nInstructionCounter = 0;
            Instruction.prototype.getGuid = function () {
                return this._getInstructionID();
            };
            Instruction.prototype.getParent = function () {
                return this._pParentInstruction;
            };
            Instruction.prototype.setParent = function (pParentInstruction) {
                this._pParentInstruction = pParentInstruction;
            };
            Instruction.prototype.getOperator = function () {
                return this._sOperatorName;
            };
            Instruction.prototype.setOperator = function (sOperator) {
                this._sOperatorName = sOperator;
            };
            Instruction.prototype.getInstructions = function () {
                return this._pInstructionList;
            };
            Instruction.prototype.setInstructions = function (pInstructionList) {
                this._pInstructionList = pInstructionList;
            };
            Instruction.prototype._getInstructionType = function () {
                return this._eInstructionType;
            };
            Instruction.prototype._getInstructionID = function () {
                return this._iInstructionID;
            };
            Instruction.prototype._getScope = function () {
                return this._iScope !== 0xffffff ? this._iScope : !((this.getParent()) === null) ? this.getParent()._getScope() : 0xffffff;
            };
            Instruction.prototype._setScope = function (iScope) {
                this._iScope = iScope;
            };
            Instruction.prototype._isInGlobalScope = function () {
                return this._getScope() === 0;
            };
            Instruction.prototype.getLastError = function () {
                return this._pLastError;
            };
            Instruction.prototype.setError = function (eCode, pInfo) {
                if (typeof pInfo === "undefined") { pInfo = null; }
                this._pLastError.code = eCode;
                this._pLastError.info = pInfo;
                this._bErrorOccured = true;
            };
            Instruction.prototype.clearError = function () {
                this._bErrorOccured = false;
                this._pLastError.code = 0;
                this._pLastError.info = null;
            };
            Instruction.prototype.isErrorOccured = function () {
                return this._bErrorOccured;
            };
            Instruction.prototype.setVisible = function (isVisible) {
                this._isVisible = isVisible;
            };
            Instruction.prototype.isVisible = function () {
                return this._isVisible;
            };
            Instruction.prototype.initEmptyInstructions = function () {
                this._pInstructionList = [];
            };
            Instruction.prototype.push = function (pInstruction, isSetParent) {
                if (typeof isSetParent === "undefined") { isSetParent = false; }
                if (!((this._pInstructionList) === null)) {
                    this._pInstructionList[this._nInstructions] = pInstruction;
                    this._nInstructions += 1;
                }
                if (isSetParent && !((pInstruction) === null)) {
                    pInstruction.setParent(this);
                }
            };
            Instruction.prototype.addRoutine = function (fnRoutine, iPriority) {
            };
            Instruction.prototype.prepareFor = function (eUsedType) {
                if (!((this._pInstructionList) === null) && this._nInstructions > 0) {
                    for(var i = 0; i < this._nInstructions; i++) {
                        this._pInstructionList[i].prepareFor(eUsedType);
                    }
                }
            };
            Instruction.prototype.check = function (eStage, pInfo) {
                if (typeof pInfo === "undefined") { pInfo = null; }
                if (this._bErrorOccured) {
                    return false;
                } else {
                    return true;
                }
            };
            Instruction.prototype.prepare = function () {
                return true;
            };
            Instruction.prototype.toString = function () {
                return null;
            };
            Instruction.prototype.toFinalCode = function () {
                return "";
            };
            Instruction.prototype.clone = function (pRelationMap) {
                if (typeof pRelationMap === "undefined") { pRelationMap = {}; }
                if (((pRelationMap[this._getInstructionID()]) !== undefined)) {
                    return pRelationMap[this._getInstructionID()];
                }
                var pNewInstruction = new this["constructor"]();
                var pParent = this.getParent() || null;
                if (!((pParent) === null) && ((pRelationMap[pParent._getInstructionID()]) !== undefined)) {
                    pParent = pRelationMap[pParent._getInstructionID()];
                }
                pNewInstruction.setParent(pParent);
                pRelationMap[this._getInstructionID()] = pNewInstruction;
                if (!((this._pInstructionList) === null) && ((pNewInstruction.getInstructions()) === null)) {
                    pNewInstruction.initEmptyInstructions();
                }
                for(var i = 0; i < this._nInstructions; i++) {
                    pNewInstruction.push(this._pInstructionList[i].clone(pRelationMap));
                }
                pNewInstruction.setOperator(this.getOperator());
                return pNewInstruction;
            };
            return Instruction;
        })();
        fx.Instruction = Instruction;        
        var InstructionCollector = (function (_super) {
            __extends(InstructionCollector, _super);
            function InstructionCollector() {
                        _super.call(this);
                this._pInstructionList = [];
                this._eInstructionType = akra.EAFXInstructionTypes.k_InstructionCollector;
            }
            InstructionCollector.prototype.toFinalCode = function () {
                var sCode = "";
                for(var i = 0; i < this._nInstructions; i++) {
                    sCode += this.getInstructions()[i].toFinalCode();
                }
                return sCode;
            };
            return InstructionCollector;
        })(Instruction);
        fx.InstructionCollector = InstructionCollector;        
        var SimpleInstruction = (function (_super) {
            __extends(SimpleInstruction, _super);
            function SimpleInstruction(sValue) {
                        _super.call(this);
                this._sValue = "";
                this._pInstructionList = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_SimpleInstruction;
                this._sValue = sValue;
            }
            SimpleInstruction.prototype.setValue = function (sValue) {
                this._sValue = sValue;
            };
            SimpleInstruction.prototype.isValue = function (sValue) {
                return (this._sValue === sValue);
            };
            SimpleInstruction.prototype.toString = function () {
                return this._sValue;
            };
            SimpleInstruction.prototype.toFinalCode = function () {
                return this._sValue;
            };
            SimpleInstruction.prototype.clone = function (pRelationMap) {
                var pClone = _super.prototype.clone.call(this, pRelationMap);
                pClone.setValue(this._sValue);
                return pClone;
            };
            return SimpleInstruction;
        })(Instruction);
        fx.SimpleInstruction = SimpleInstruction;        
        var TypedInstruction = (function (_super) {
            __extends(TypedInstruction, _super);
            function TypedInstruction() {
                        _super.call(this);
                this._pType = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_TypedInstruction;
            }
            TypedInstruction.prototype.getType = function () {
                return this._pType;
            };
            TypedInstruction.prototype.setType = function (pType) {
                this._pType = pType;
            };
            TypedInstruction.prototype.clone = function (pRelationMap) {
                if (typeof pRelationMap === "undefined") { pRelationMap = {}; }
                var pClonedInstruction = (_super.prototype.clone.call(this, pRelationMap));
                if (!((this.getType()) === null)) {
                    pClonedInstruction.setType(this.getType().clone(pRelationMap));
                }
                return pClonedInstruction;
            };
            return TypedInstruction;
        })(Instruction);
        fx.TypedInstruction = TypedInstruction;        
        var DeclInstruction = (function (_super) {
            __extends(DeclInstruction, _super);
            function DeclInstruction() {
                        _super.call(this);
                this._sSemantic = "";
                this._pAnnotation = null;
                this._bForPixel = true;
                this._bForVertex = true;
                this._isBuiltIn = false;
                this._eInstructionType = akra.EAFXInstructionTypes.k_DeclInstruction;
            }
            DeclInstruction.prototype.setSemantic = function (sSemantic) {
                this._sSemantic = sSemantic;
            };
            DeclInstruction.prototype.setAnnotation = function (pAnnotation) {
                this._pAnnotation = pAnnotation;
            };
            DeclInstruction.prototype.getName = function () {
                return "";
            };
            DeclInstruction.prototype.getRealName = function () {
                return "";
            };
            DeclInstruction.prototype.getNameId = function () {
                return null;
            };
            DeclInstruction.prototype.getSemantic = function () {
                return this._sSemantic;
            };
            DeclInstruction.prototype.isBuiltIn = function () {
                return this._isBuiltIn;
            };
            DeclInstruction.prototype.setBuiltIn = function (isBuiltIn) {
                this._isBuiltIn = isBuiltIn;
            };
            DeclInstruction.prototype._isForAll = function () {
                return this._bForVertex && this._bForPixel;
            };
            DeclInstruction.prototype._isForPixel = function () {
                return this._bForPixel;
            };
            DeclInstruction.prototype._isForVertex = function () {
                return this._bForVertex;
            };
            DeclInstruction.prototype._setForAll = function (canUse) {
                this._bForVertex = canUse;
                this._bForPixel = canUse;
            };
            DeclInstruction.prototype._setForPixel = function (canUse) {
                this._bForPixel = canUse;
            };
            DeclInstruction.prototype._setForVertex = function (canUse) {
                this._bForVertex = canUse;
            };
            DeclInstruction.prototype.clone = function (pRelationMap) {
                if (typeof pRelationMap === "undefined") { pRelationMap = {}; }
                var pClonedInstruction = (_super.prototype.clone.call(this, pRelationMap));
                pClonedInstruction.setSemantic(this._sSemantic);
                pClonedInstruction.setAnnotation(this._pAnnotation);
                return pClonedInstruction;
            };
            return DeclInstruction;
        })(TypedInstruction);
        fx.DeclInstruction = DeclInstruction;        
        var IdInstruction = (function (_super) {
            __extends(IdInstruction, _super);
            function IdInstruction() {
                        _super.call(this);
                this._isForVarying = false;
                this._sName = "";
                this._sRealName = "";
                this._eInstructionType = akra.EAFXInstructionTypes.k_IdInstruction;
            }
            IdInstruction.prototype.isVisible = function () {
                return this.getParent().isVisible();
            };
            IdInstruction.prototype.getName = function () {
                return this._sName;
            };
            IdInstruction.prototype.getRealName = function () {
                if (this._isForVarying) {
                    return "V_" + this._sRealName;
                } else {
                    return this._sRealName;
                }
            };
            IdInstruction.prototype.setName = function (sName) {
                this._sName = sName;
                this._sRealName = sName;
            };
            IdInstruction.prototype.setRealName = function (sRealName) {
                this._sRealName = sRealName;
            };
            IdInstruction.prototype._markAsVarying = function (bValue) {
                this._isForVarying = bValue;
            };
            IdInstruction.prototype.toString = function () {
                return this._sRealName;
            };
            IdInstruction.prototype.toFinalCode = function () {
                return this.getRealName();
            };
            IdInstruction.prototype.clone = function (pRelationMap) {
                var pClonedInstruction = (_super.prototype.clone.call(this, pRelationMap));
                pClonedInstruction.setName(this._sName);
                pClonedInstruction.setRealName(this._sRealName);
                return pClonedInstruction;
            };
            return IdInstruction;
        })(Instruction);
        fx.IdInstruction = IdInstruction;        
        var KeywordInstruction = (function (_super) {
            __extends(KeywordInstruction, _super);
            function KeywordInstruction() {
                        _super.call(this);
                this._sValue = "";
                this._eInstructionType = akra.EAFXInstructionTypes.k_KeywordInstruction;
            }
            KeywordInstruction.prototype.setValue = function (sValue) {
                this._sValue = sValue;
            };
            KeywordInstruction.prototype.isValue = function (sTestValue) {
                return this._sValue === sTestValue;
            };
            KeywordInstruction.prototype.toString = function () {
                return this._sValue;
            };
            KeywordInstruction.prototype.toFinalCode = function () {
                return this._sValue;
            };
            return KeywordInstruction;
        })(Instruction);
        fx.KeywordInstruction = KeywordInstruction;        
        var AnnotationInstruction = (function (_super) {
            __extends(AnnotationInstruction, _super);
            function AnnotationInstruction() {
                        _super.call(this);
                this._eInstructionType = akra.EAFXInstructionTypes.k_AnnotationInstruction;
            }
            return AnnotationInstruction;
        })(Instruction);
        fx.AnnotationInstruction = AnnotationInstruction;        
        var PassInstruction = (function (_super) {
            __extends(PassInstruction, _super);
            function PassInstruction() {
                        _super.call(this);
                this._pTempNodeList = null;
                this._pTempFoundedFuncList = null;
                this._pTempFoundedFuncTypeList = null;
                this._pParseNode = null;
                this._sFunctionCode = "";
                this._isComlexPass = false;
                this._pShadersMap = null;
                this._fnPassFunction = null;
                this._pVertexShader = null;
                this._pPixelShader = null;
                this._pPassStateMap = null;
                this._pSharedVariableMapV = null;
                this._pGlobalVariableMapV = null;
                this._pUniformVariableMapV = null;
                this._pForeignVariableMapV = null;
                this._pTextureVariableMapV = null;
                this._pUsedComplexTypeMapV = null;
                this._pSharedVariableMapP = null;
                this._pGlobalVariableMapP = null;
                this._pUniformVariableMapP = null;
                this._pForeignVariableMapP = null;
                this._pTextureVariableMapP = null;
                this._pUsedComplexTypeMapP = null;
                this._pFullUniformVariableMap = null;
                this._pFullForeignVariableMap = null;
                this._pFullTextureVariableMap = null;
                this._pInstructionList = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_PassInstruction;
            }
            PassInstruction.prototype._addFoundFunction = function (pNode, pShader, eType) {
                if (((this._pTempNodeList) === null)) {
                    this._pTempNodeList = [];
                    this._pTempFoundedFuncList = [];
                    this._pTempFoundedFuncTypeList = [];
                }
                this._pTempNodeList.push(pNode);
                this._pTempFoundedFuncList.push(pShader);
                this._pTempFoundedFuncTypeList.push(eType);
            };
            PassInstruction.prototype._getFoundedFunction = function (pNode) {
                if (((this._pTempNodeList) === null)) {
                    return null;
                }
                for(var i = 0; i < this._pTempNodeList.length; i++) {
                    if (this._pTempNodeList[i] === pNode) {
                        return this._pTempFoundedFuncList[i];
                    }
                }
                return null;
            };
            PassInstruction.prototype._getFoundedFunctionType = function (pNode) {
                if (((this._pTempNodeList) === null)) {
                    return null;
                }
                for(var i = 0; i < this._pTempNodeList.length; i++) {
                    if (this._pTempNodeList[i] === pNode) {
                        return this._pTempFoundedFuncTypeList[i];
                    }
                }
                return null;
            };
            PassInstruction.prototype._setParseNode = function (pNode) {
                this._pParseNode = pNode;
            };
            PassInstruction.prototype._getParseNode = function () {
                return this._pParseNode;
            };
            PassInstruction.prototype._addCodeFragment = function (sCode) {
                if (this.isComplexPass()) {
                    this._sFunctionCode += sCode;
                }
            };
            PassInstruction.prototype._markAsComplex = function (isComplex) {
                this._isComlexPass = isComplex;
            };
            PassInstruction.prototype._getSharedVariableMapV = function () {
                return this._pSharedVariableMapV;
            };
            PassInstruction.prototype._getGlobalVariableMapV = function () {
                return this._pGlobalVariableMapV;
            };
            PassInstruction.prototype._getUniformVariableMapV = function () {
                return this._pUniformVariableMapV;
            };
            PassInstruction.prototype._getForeignVariableMapV = function () {
                return this._pForeignVariableMapV;
            };
            PassInstruction.prototype._getTextureVariableMapV = function () {
                return this._pTextureVariableMapV;
            };
            PassInstruction.prototype._getUsedComplexTypeMapV = function () {
                return this._pUsedComplexTypeMapV;
            };
            PassInstruction.prototype._getSharedVariableMapP = function () {
                return this._pSharedVariableMapP;
            };
            PassInstruction.prototype._getGlobalVariableMapP = function () {
                return this._pGlobalVariableMapP;
            };
            PassInstruction.prototype._getUniformVariableMapP = function () {
                return this._pUniformVariableMapP;
            };
            PassInstruction.prototype._getForeignVariableMapP = function () {
                return this._pForeignVariableMapP;
            };
            PassInstruction.prototype._getTextureVariableMapP = function () {
                return this._pTextureVariableMapP;
            };
            PassInstruction.prototype._getUsedComplexTypeMapP = function () {
                return this._pUsedComplexTypeMapP;
            };
            PassInstruction.prototype._getFullUniformMap = function () {
                return this._pFullUniformVariableMap;
            };
            PassInstruction.prototype._getFullForeignMap = function () {
                return this._pFullForeignVariableMap;
            };
            PassInstruction.prototype._getFullTextureMap = function () {
                return this._pFullTextureVariableMap;
            };
            PassInstruction.prototype.isComplexPass = function () {
                return this._isComlexPass;
            };
            PassInstruction.prototype.getVertexShader = function () {
                return this._pVertexShader;
            };
            PassInstruction.prototype.getPixelShader = function () {
                return this._pPixelShader;
            };
            PassInstruction.prototype.addShader = function (pShader) {
                var isVertex = pShader.getFunctionType() === akra.EFunctionType.k_Vertex;
                if (this.isComplexPass()) {
                    if (((this._pShadersMap) === null)) {
                        this._pShadersMap = {};
                    }
                    var iShader = pShader._getInstructionID();
                    this._pShadersMap[iShader] = pShader;
                    var sCode = isVertex ? "this._pVertexShader=" : "this._pPixelShader=";
                    sCode += "this._pShadersMap[" + iShader.toString() + "];";
                    this._addCodeFragment(sCode);
                } else {
                    if (isVertex) {
                        this._pVertexShader = pShader;
                    } else {
                        this._pPixelShader = pShader;
                    }
                }
            };
            PassInstruction.prototype.setState = function (sType, sValue) {
                if (((this._pPassStateMap) === null)) {
                    this._pPassStateMap = {};
                }
                if (this.isComplexPass()) {
                    this._addCodeFragment("this._pPassStateMap[" + sType + "]=" + sValue + ";");
                } else {
                    this._pPassStateMap[sType] = sValue;
                }
            };
            PassInstruction.prototype.finalizePass = function () {
                if (this.isComplexPass()) {
                    this._fnPassFunction = (new Function("engine", "foreigns", "uniforms", this._sFunctionCode));
                }
                this.generateInfoAboutUsedVaraibles();
                this._pTempNodeList = null;
                this._pTempFoundedFuncList = null;
                this._pTempFoundedFuncTypeList = null;
                this._pParseNode = null;
                this._sFunctionCode = "";
            };
            PassInstruction.prototype.evaluate = function (pEngineStates, pForeigns, pUniforms) {
                if (this.isComplexPass()) {
                    this._pVertexShader = null;
                    this._pPixelShader = null;
                    this._fnPassFunction.call(this, pEngineStates, pForeigns, pUniforms);
                }
                return true;
            };
            PassInstruction.prototype.generateInfoAboutUsedVaraibles = function () {
                if (((this._pSharedVariableMapV) === null)) {
                    this._pSharedVariableMapV = {};
                    this._pGlobalVariableMapV = {};
                    this._pUniformVariableMapV = {};
                    this._pForeignVariableMapV = {};
                    this._pTextureVariableMapV = {};
                    this._pUsedComplexTypeMapV = {};
                    this._pSharedVariableMapP = {};
                    this._pGlobalVariableMapP = {};
                    this._pUniformVariableMapP = {};
                    this._pForeignVariableMapP = {};
                    this._pTextureVariableMapP = {};
                    this._pUsedComplexTypeMapP = {};
                    this._pFullUniformVariableMap = {};
                    this._pFullForeignVariableMap = {};
                    this._pFullTextureVariableMap = {};
                }
                if (this.isComplexPass()) {
                    for(var i in this._pShadersMap) {
                        this.addInfoAbouUsedVariablesFromFunction(this._pShadersMap[i]);
                    }
                } else {
                    if (!((this._pVertexShader) === null)) {
                        this.addInfoAbouUsedVariablesFromFunction(this._pVertexShader);
                    }
                    if (!((this._pPixelShader) === null)) {
                        this.addInfoAbouUsedVariablesFromFunction(this._pPixelShader);
                    }
                }
            };
            PassInstruction.prototype.addInfoAbouUsedVariablesFromFunction = function (pFunction) {
                var pSharedVars = pFunction._getSharedVariableMap();
                var pGlobalVars = pFunction._getGlobalVariableMap();
                var pUniformVars = pFunction._getUniformVariableMap();
                var pForeignVars = pFunction._getForeignVariableMap();
                var pTextureVars = pFunction._getTextureVariableMap();
                var pTypes = pFunction._getUsedComplexTypeMap();
                var pSharedVarsTo = null;
                var pGlobalVarsTo = null;
                var pUniformVarsTo = null;
                var pForeignVarsTo = null;
                var pTextureVarsTo = null;
                var pTypesTo = null;
                if (pFunction.getFunctionType() === akra.EFunctionType.k_Vertex) {
                    pSharedVarsTo = this._pSharedVariableMapV;
                    pGlobalVarsTo = this._pGlobalVariableMapV;
                    pUniformVarsTo = this._pUniformVariableMapV;
                    pForeignVarsTo = this._pForeignVariableMapV;
                    pTextureVarsTo = this._pTextureVariableMapV;
                    pTypesTo = this._pUsedComplexTypeMapV;
                } else {
                    pSharedVarsTo = this._pSharedVariableMapP;
                    pGlobalVarsTo = this._pGlobalVariableMapP;
                    pUniformVarsTo = this._pUniformVariableMapP;
                    pForeignVarsTo = this._pForeignVariableMapP;
                    pTextureVarsTo = this._pTextureVariableMapP;
                    pTypesTo = this._pUsedComplexTypeMapP;
                }
                for(var i in pSharedVars) {
                    if (!((pSharedVars[i]) === null) && !pSharedVars[i].isField()) {
                        pSharedVarsTo[i] = pSharedVars[i];
                    }
                }
                for(var i in pGlobalVars) {
                    if (!((pGlobalVars[i]) === null)) {
                        pGlobalVarsTo[i] = pGlobalVars[i];
                    }
                }
                for(var i in pUniformVars) {
                    if (!((pUniformVars[i]) === null)) {
                        pUniformVarsTo[i] = pUniformVars[i];
                        this._pFullUniformVariableMap[i] = pUniformVars[i];
                    }
                }
                for(var i in pForeignVars) {
                    if (!((pForeignVars[i]) === null)) {
                        pForeignVarsTo[i] = pForeignVars[i];
                        this._pFullForeignVariableMap[i] = pForeignVars[i];
                    }
                }
                for(var i in pTextureVars) {
                    if (!((pTextureVars[i]) === null)) {
                        pTextureVarsTo[i] = pTextureVars[i];
                        this._pFullTextureVariableMap[i] = pTextureVars[i];
                    }
                }
                for(var i in pTypes) {
                    if (!((pTypes[i]) === null)) {
                        pTypesTo[i] = pTypes[i];
                    }
                }
            };
            return PassInstruction;
        })(DeclInstruction);
        fx.PassInstruction = PassInstruction;        
        var TechniqueInstruction = (function (_super) {
            __extends(TechniqueInstruction, _super);
            function TechniqueInstruction() {
                        _super.call(this);
                this._sName = "";
                this._hasComplexName = false;
                this._pParseNode = null;
                this._pSharedVariableListV = null;
                this._pSharedVariableListP = null;
                this._pPassList = null;
                this._pComponentList = null;
                this._pComponentShiftList = null;
                this._pFullComponentList = null;
                this._pFullComponentShiftList = null;
                this._nTotalPasses = 0;
                this._pInstructionList = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_TechniqueInstruction;
            }
            TechniqueInstruction.prototype.setName = function (sName, isComplexName) {
                this._sName = sName;
                this._hasComplexName = isComplexName;
            };
            TechniqueInstruction.prototype.getName = function () {
                return this._sName;
            };
            TechniqueInstruction.prototype.hasComplexName = function () {
                return this._hasComplexName;
            };
            TechniqueInstruction.prototype.getSharedVariablesForVertex = function () {
                return this._pSharedVariableListV;
            };
            TechniqueInstruction.prototype.getSharedVariablesForPixel = function () {
                return this._pSharedVariableListP;
            };
            TechniqueInstruction.prototype.addPass = function (pPass) {
                if (((this._pPassList) === null)) {
                    this._pPassList = [];
                }
                this._pPassList.push(pPass);
            };
            TechniqueInstruction.prototype.getPassList = function () {
                return this._pPassList;
            };
            TechniqueInstruction.prototype.getPass = function (iPass) {
                return iPass < this._pPassList.length ? this._pPassList[iPass] : null;
            };
            TechniqueInstruction.prototype.totalOwnPasses = function () {
                return this._pPassList.length;
            };
            TechniqueInstruction.prototype.totalPasses = function () {
                return this._nTotalPasses;
            };
            TechniqueInstruction.prototype.addComponent = function (pComponent, iShift) {
                if (((this._pComponentList) === null)) {
                    this._pComponentList = [];
                    this._pComponentShiftList = [];
                }
                this._pComponentList.push(pComponent);
                this._pComponentShiftList.push(iShift);
            };
            TechniqueInstruction.prototype.getComponentList = function () {
                return this._pComponentList;
            };
            TechniqueInstruction.prototype.getComponentListShift = function () {
                return this._pComponentShiftList;
            };
            TechniqueInstruction.prototype.getFullComponentList = function () {
                return this._pFullComponentList;
            };
            TechniqueInstruction.prototype.getFullComponentShiftList = function () {
                return this._pFullComponentShiftList;
            };
            TechniqueInstruction.prototype.checkForCorrectImports = function () {
                return true;
            };
            TechniqueInstruction.prototype.finalizeTechnique = function (sProvideNameSpace, pGloabalComponentList, pGloabalComponentShiftList) {
                this.generateListOfSharedVariables();
                if (!this.hasComplexName() && sProvideNameSpace !== "") {
                    this._sName = sProvideNameSpace + "." + this._sName;
                }
                if (!((pGloabalComponentList) === null)) {
                    if (!((this._pComponentList) === null)) {
                        this._pComponentList = pGloabalComponentList.concat(this._pComponentList);
                        this._pComponentShiftList = pGloabalComponentShiftList.concat(this._pComponentShiftList);
                    } else {
                        this._pComponentList = pGloabalComponentList.concat();
                        this._pComponentShiftList = pGloabalComponentShiftList.concat();
                    }
                }
                this.generateFullListOfComponent();
            };
            TechniqueInstruction.prototype.generateListOfSharedVariables = function () {
                this._pSharedVariableListV = [];
                this._pSharedVariableListP = [];
                for(var i = 0; i < this._pPassList.length; i++) {
                    var pSharedV = this._pPassList[i]._getSharedVariableMapV();
                    var pSharedP = this._pPassList[i]._getSharedVariableMapP();
                    for(var j in pSharedV) {
                        this.addSharedVariable(pSharedV[j], akra.EFunctionType.k_Vertex);
                    }
                    for(var j in pSharedP) {
                        this.addSharedVariable(pSharedP[j], akra.EFunctionType.k_Pixel);
                    }
                }
            };
            TechniqueInstruction.prototype.addSharedVariable = function (pVar, eType) {
                var pAddTo = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pAddTo = this._pSharedVariableListV;
                } else {
                    pAddTo = this._pSharedVariableListP;
                }
                for(var i = 0; i < pAddTo.length; i++) {
                    if (pAddTo[i] === pVar) {
                        return;
                    }
                }
                pAddTo.push(pVar);
            };
            TechniqueInstruction.prototype.generateFullListOfComponent = function () {
                this._nTotalPasses = this.totalOwnPasses();
                if (((this._pComponentList) === null)) {
                    return;
                }
                this._pFullComponentList = [];
                this._pFullComponentShiftList = [];
                for(var i = 0; i < this._pComponentList.length; i++) {
                    var pTechnique = this._pComponentList[i].getTechnique();
                    var iMainShift = this._pComponentShiftList[i];
                    var pAddComponentList = pTechnique.getFullComponentList();
                    var pAddComponentShiftList = pTechnique.getFullComponentShiftList();
                    if (!((pAddComponentList) === null)) {
                        for(var j = 0; j < pAddComponentList.length; i++) {
                            this._pFullComponentList.push(pAddComponentList[j]);
                            this._pFullComponentShiftList.push(pAddComponentShiftList[j] + iMainShift);
                        }
                    }
                    this._pFullComponentList.push(this._pComponentList[i]);
                    this._pFullComponentShiftList.push(iMainShift);
                    if (this._nTotalPasses < iMainShift + pTechnique.totalPasses()) {
                        this._nTotalPasses = iMainShift + pTechnique.totalPasses();
                    }
                }
            };
            return TechniqueInstruction;
        })(DeclInstruction);
        fx.TechniqueInstruction = TechniqueInstruction;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var TypeDeclInstruction = (function (_super) {
            __extends(TypeDeclInstruction, _super);
            function TypeDeclInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_TypeDeclInstruction;
            }
            TypeDeclInstruction.prototype.getType = function () {
                return this._pInstructionList[0];
            };
            TypeDeclInstruction.prototype.clone = function (pRelationMap) {
                return _super.prototype.clone.call(this, pRelationMap);
            };
            TypeDeclInstruction.prototype.toFinalCode = function () {
                return this.getType()._toDeclString() + ";";
            };
            TypeDeclInstruction.prototype.getName = function () {
                return this.getType().getName();
            };
            TypeDeclInstruction.prototype.getRealName = function () {
                return this.getType().getRealName();
            };
            TypeDeclInstruction.prototype.blend = function (pDecl, eBlendMode) {
                if (pDecl !== this) {
                    return null;
                }
                return this;
            };
            return TypeDeclInstruction;
        })(fx.DeclInstruction);
        fx.TypeDeclInstruction = TypeDeclInstruction;        
        var VariableTypeInstruction = (function (_super) {
            __extends(VariableTypeInstruction, _super);
            function VariableTypeInstruction() {
                        _super.call(this);
                this._pSubType = null;
                this._pUsageList = null;
                this._sName = "";
                this._isWritable = null;
                this._isReadable = null;
                this._bUsedForWrite = false;
                this._bUsedForRead = false;
                this._sHash = "";
                this._sStrongHash = "";
                this._isArray = false;
                this._isPointer = false;
                this._isStrictPointer = false;
                this._isPointIndex = null;
                this._isUniform = null;
                this._isGlobal = null;
                this._isConst = null;
                this._isShared = null;
                this._isForeign = null;
                this._iLength = 0xffffff;
                this._isNeedToUpdateLength = false;
                this._isFromVariableDecl = null;
                this._isFromTypeDecl = null;
                this._isField = false;
                this._pArrayIndexExpr = null;
                this._pArrayElementType = null;
                this._pFieldDeclMap = null;
                this._pFieldDeclBySemanticMap = null;
                this._pFieldIdMap = null;
                this._pUsedFieldMap = null;
                this._pVideoBuffer = null;
                this._pMainPointIndex = null;
                this._pUpPointIndex = null;
                this._pDownPointIndex = null;
                this._nPointDim = 0;
                this._pPointerList = null;
                this._iPadding = 0xffffff;
                this._pSubDeclList = null;
                this._pAttrOffset = null;
                this._bUnverifiable = false;
                this._bCollapsed = false;
                this._pInstructionList = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_VariableTypeInstruction;
            }
            VariableTypeInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                if (!((this._pUsageList) === null)) {
                    if (!this.isShared()) {
                        for(var i = 0; i < this._pUsageList.length; i++) {
                            sCode += this._pUsageList[i] + " ";
                        }
                    }
                }
                sCode += this.getSubType().toFinalCode();
                return sCode;
            };
            VariableTypeInstruction.prototype._toDeclString = function () {
                return this.getSubType()._toDeclString();
            };
            VariableTypeInstruction.prototype.isBuiltIn = function () {
                return false;
            };
            VariableTypeInstruction.prototype.setBuiltIn = function (isBuiltIn) {
            };
            VariableTypeInstruction.prototype._setCollapsed = function (bValue) {
                this._bCollapsed = bValue;
            };
            VariableTypeInstruction.prototype._isCollapsed = function () {
                return this._bCollapsed;
            };
            VariableTypeInstruction.prototype.isBase = function () {
                return this.getSubType().isBase() && this._isArray === false;
            };
            VariableTypeInstruction.prototype.isArray = function () {
                return this._isArray || (this.getSubType().isArray());
            };
            VariableTypeInstruction.prototype.isNotBaseArray = function () {
                return this._isArray || (this.getSubType().isNotBaseArray());
            };
            VariableTypeInstruction.prototype.isComplex = function () {
                return this.getSubType().isComplex();
            };
            VariableTypeInstruction.prototype.isEqual = function (pType) {
                if (this._isUnverifiable()) {
                    return true;
                }
                if (this.isNotBaseArray() && pType.isNotBaseArray() && (this.getLength() !== pType.getLength() || this.getLength() === 0xffffff || pType.getLength() === 0xffffff)) {
                    return false;
                }
                if (this.getHash() !== pType.getHash()) {
                    return false;
                }
                return true;
            };
            VariableTypeInstruction.prototype.isStrongEqual = function (pType) {
                if (!this.isEqual(pType) || this.getStrongHash() !== pType.getStrongHash()) {
                    return false;
                }
                return true;
            };
            VariableTypeInstruction.prototype.isSampler = function () {
                return this.getSubType().isSampler();
            };
            VariableTypeInstruction.prototype.isSamplerCube = function () {
                return this.getSubType().isSamplerCube();
            };
            VariableTypeInstruction.prototype.isSampler2D = function () {
                return this.getSubType().isSampler2D();
            };
            VariableTypeInstruction.prototype.isWritable = function () {
                if (!((this._isWritable) === null)) {
                    return this._isWritable;
                }
                if ((this.isArray() && !this.isBase()) || this.isForeign() || this.isUniform()) {
                    this._isWritable = false;
                } else {
                    this._isWritable = this.getSubType().isWritable();
                }
                return this._isWritable;
            };
            VariableTypeInstruction.prototype.isReadable = function () {
                if (!((this._isReadable) === null)) {
                    return this._isReadable;
                }
                if (this.hasUsage("out")) {
                    this._isReadable = false;
                } else {
                    this._isReadable = this.getSubType().isReadable();
                }
                return this._isReadable;
            };
            VariableTypeInstruction.prototype._containArray = function () {
                return this.getSubType()._containArray();
            };
            VariableTypeInstruction.prototype._containSampler = function () {
                return this.getSubType()._containSampler();
            };
            VariableTypeInstruction.prototype._containPointer = function () {
                return this.getSubType()._containPointer();
            };
            VariableTypeInstruction.prototype._containComplexType = function () {
                return this.getSubType()._containComplexType();
            };
            VariableTypeInstruction.prototype.isPointer = function () {
                return this._isPointer || (this.getSubType()._getInstructionType() === akra.EAFXInstructionTypes.k_VariableTypeInstruction && (this.getSubType()).isPointer());
            };
            VariableTypeInstruction.prototype.isStrictPointer = function () {
                return this._isStrictPointer || (this.getSubType()._getInstructionType() === akra.EAFXInstructionTypes.k_VariableTypeInstruction && (this.getSubType()).isStrictPointer());
            };
            VariableTypeInstruction.prototype.isPointIndex = function () {
                if (((this._isPointIndex) === null)) {
                    this._isPointIndex = this.isStrongEqual(fx.getEffectBaseType("ptr"));
                }
                return this._isPointIndex;
            };
            VariableTypeInstruction.prototype.isFromVariableDecl = function () {
                if (!((this._isFromVariableDecl) === null)) {
                    return this._isFromVariableDecl;
                }
                if (((this.getParent()) === null)) {
                    this._isFromVariableDecl = false;
                } else {
                    var eParentType = this.getParent()._getInstructionType();
                    if (eParentType === akra.EAFXInstructionTypes.k_VariableDeclInstruction) {
                        this._isFromVariableDecl = true;
                    } else if (eParentType === akra.EAFXInstructionTypes.k_VariableTypeInstruction) {
                        this._isFromVariableDecl = (this.getParent()).isFromVariableDecl();
                    } else {
                        this._isFromVariableDecl = false;
                    }
                }
                return this._isFromVariableDecl;
            };
            VariableTypeInstruction.prototype.isFromTypeDecl = function () {
                if (!((this._isFromTypeDecl) === null)) {
                    return this._isFromTypeDecl;
                }
                if (((this.getParent()) === null)) {
                    this._isFromTypeDecl = false;
                } else {
                    var eParentType = this.getParent()._getInstructionType();
                    if (eParentType === akra.EAFXInstructionTypes.k_TypeDeclInstruction) {
                        this._isFromTypeDecl = true;
                    } else if (eParentType === akra.EAFXInstructionTypes.k_VariableTypeInstruction) {
                        this._isFromTypeDecl = (this.getParent()).isFromVariableDecl();
                    } else {
                        this._isFromTypeDecl = false;
                    }
                }
                return this._isFromTypeDecl;
            };
            VariableTypeInstruction.prototype.isUniform = function () {
                if (((this._isUniform) === null)) {
                    this._isUniform = this.hasUsage("uniform");
                }
                return this._isUniform;
            };
            VariableTypeInstruction.prototype.isGlobal = function () {
                if (((this._isGlobal) === null)) {
                    this._isGlobal = this._getScope() === 0;
                }
                return this._isGlobal;
            };
            VariableTypeInstruction.prototype.isConst = function () {
                if (((this._isConst) === null)) {
                    this._isConst = this.hasUsage("const");
                }
                return this._isConst;
            };
            VariableTypeInstruction.prototype.isShared = function () {
                if (((this._isShared) === null)) {
                    this._isShared = this.hasUsage("shared");
                }
                return this._isShared;
            };
            VariableTypeInstruction.prototype.isForeign = function () {
                if (((this._isForeign) === null)) {
                    this._isForeign = this.hasUsage("foreign");
                }
                return this._isForeign;
            };
            VariableTypeInstruction.prototype._isTypeOfField = function () {
                if (((this.getParent()) === null)) {
                    return false;
                }
                if (this.getParent()._getInstructionType() === akra.EAFXInstructionTypes.k_VariableDeclInstruction) {
                    var pParentDecl = this.getParent();
                    return pParentDecl.isField();
                }
                return false;
            };
            VariableTypeInstruction.prototype._isUnverifiable = function () {
                return this._bUnverifiable;
            };
            VariableTypeInstruction.prototype.setName = function (sName) {
                this._sName = sName;
            };
            VariableTypeInstruction.prototype._canWrite = function (isWritable) {
                this._isWritable = isWritable;
            };
            VariableTypeInstruction.prototype._canRead = function (isReadable) {
                this._isReadable = isReadable;
            };
            VariableTypeInstruction.prototype.setPadding = function (iPadding) {
                this._iPadding = iPadding;
            };
            VariableTypeInstruction.prototype.pushType = function (pType) {
                var eType = pType._getInstructionType();
                if (eType === akra.EAFXInstructionTypes.k_SystemTypeInstruction || eType === akra.EAFXInstructionTypes.k_ComplexTypeInstruction) {
                    this._pSubType = pType;
                } else {
                    var pVarType = pType;
                    if (!pVarType.isNotBaseArray() && !pVarType.isPointer()) {
                        var pUsageList = pVarType.getUsageList();
                        if (!((pUsageList) === null)) {
                            for(var i = 0; i < pUsageList.length; i++) {
                                this.addUsage(pUsageList[i]);
                            }
                        }
                        this._pSubType = pVarType.getSubType();
                    } else {
                        this._pSubType = pType;
                    }
                }
            };
            VariableTypeInstruction.prototype.addUsage = function (sUsage) {
                if (((this._pUsageList) === null)) {
                    this._pUsageList = [];
                }
                if (!this.hasUsage(sUsage)) {
                    this._pUsageList.push(sUsage);
                }
            };
            VariableTypeInstruction.prototype.addArrayIndex = function (pExpr) {
                this._pArrayElementType = new VariableTypeInstruction();
                this._pArrayElementType.pushType(this.getSubType());
                if (!((this._pUsageList) === null)) {
                    for(var i = 0; i < this._pUsageList.length; i++) {
                        this._pArrayElementType.addUsage(this._pUsageList[i]);
                    }
                }
                this._pArrayElementType.setParent(this);
                this._pArrayIndexExpr = pExpr;
                this._iLength = this._pArrayIndexExpr.evaluate() ? this._pArrayIndexExpr.getEvalValue() : 0xffffff;
                this._isArray = true;
                if (this._iLength === 0xffffff) {
                    this._isNeedToUpdateLength = true;
                }
            };
            VariableTypeInstruction.prototype.addPointIndex = function (isStrict) {
                if (typeof isStrict === "undefined") { isStrict = true; }
                this._nPointDim++;
                this._isPointer = true;
                if (isStrict) {
                    this._isStrictPointer = true;
                }
            };
            VariableTypeInstruction.prototype.setVideoBuffer = function (pBuffer) {
                if (this.isPointIndex()) {
                    (this.getParent().getParent()).getType().setVideoBuffer(pBuffer);
                    return;
                }
                this._pVideoBuffer = pBuffer;
                if (!this.isComplex()) {
                    return;
                }
                var pFieldNameList = this.getFieldNameList();
                for(var i = 0; i < pFieldNameList.length; i++) {
                    var pFieldType = this.getFieldType(pFieldNameList[i]);
                    if (pFieldType.isPointer()) {
                        pFieldType.setVideoBuffer(pBuffer);
                    }
                }
            };
            VariableTypeInstruction.prototype.initializePointers = function () {
                this._pPointerList = [];
                var pDownPointer = this._getParentVarDecl();
                for(var i = 0; i < this.getPointDim(); i++) {
                    var pPointer = new fx.VariableDeclInstruction();
                    var pPointerType = new VariableTypeInstruction();
                    var pPointerId = new fx.IdInstruction();
                    pPointer.push(pPointerType, true);
                    pPointer.push(pPointerId, true);
                    pPointerType.pushType(fx.getEffectBaseType("ptr"));
                    pPointerId.setName("undef");
                    pPointerId.setName(this._getParentVarDecl().getName() + "_pointer_" + i.toString());
                    if (i > 0) {
                        (this._pPointerList[i - 1].getType())._setUpDownPointers(pPointer, pDownPointer);
                        pDownPointer = this._pPointerList[i - 1];
                    } else {
                        pPointerType._setUpDownPointers(null, pDownPointer);
                    }
                    pPointer.setParent(this._getParentVarDecl());
                    this._pPointerList.push(pPointer);
                }
                this._pPointerList[this._pPointerList.length - 1].getType()._setUpDownPointers(null, pDownPointer);
                this._pUpPointIndex = this._pPointerList[0];
                this._pMainPointIndex = this._pPointerList[this._pPointerList.length - 1];
            };
            VariableTypeInstruction.prototype._setPointerToStrict = function () {
                this._isStrictPointer = true;
            };
            VariableTypeInstruction.prototype._addPointIndexInDepth = function () {
                if (!this.isComplex()) {
                    return;
                }
                var pFieldNameList = this.getFieldNameList();
                for(var i = 0; i < pFieldNameList.length; i++) {
                    var pFieldType = this.getFieldType(pFieldNameList[i]);
                    if (!pFieldType.isPointer()) {
                        pFieldType.addPointIndex(false);
                        pFieldType._setVideoBufferInDepth();
                    }
                }
            };
            VariableTypeInstruction.prototype._setVideoBufferInDepth = function () {
                if (this.isPointer()) {
                    this.setVideoBuffer(fx.Effect.createVideoBufferVariable());
                } else if (this.isComplex() && this._containPointer()) {
                    var pFieldNameList = this.getFieldNameList();
                    for(var i = 0; i < pFieldNameList.length; i++) {
                        var pFieldType = this.getFieldType(pFieldNameList[i]);
                        pFieldType._setVideoBufferInDepth();
                    }
                }
            };
            VariableTypeInstruction.prototype._markAsUnverifiable = function (isUnverifiable) {
                this._bUnverifiable = true;
            };
            VariableTypeInstruction.prototype._addAttrOffset = function (pOffset) {
                this._pAttrOffset = pOffset;
            };
            VariableTypeInstruction.prototype.getName = function () {
                return this._sName;
            };
            VariableTypeInstruction.prototype.getRealName = function () {
                return this.getBaseType().getRealName();
            };
            VariableTypeInstruction.prototype.getHash = function () {
                if (this._sHash === "") {
                    this.calcHash();
                }
                return this._sHash;
            };
            VariableTypeInstruction.prototype.getStrongHash = function () {
                if (this._sStrongHash === "") {
                    this.calcStrongHash();
                }
                return this._sStrongHash;
            };
            VariableTypeInstruction.prototype.getSize = function () {
                if (this.isPointer() || this.isPointIndex()) {
                    return 1;
                }
                if (this._isArray) {
                    var iSize = this._pArrayElementType.getSize();
                    if (this._iLength === 0xffffff || iSize === 0xffffff) {
                        return 0xffffff;
                    } else {
                        return iSize * this._iLength;
                    }
                } else {
                    return this.getSubType().getSize();
                }
            };
            VariableTypeInstruction.prototype.getBaseType = function () {
                return this.getSubType().getBaseType();
            };
            VariableTypeInstruction.prototype.getLength = function () {
                if (!this.isNotBaseArray()) {
                    this._iLength = 0;
                    return 0;
                }
                if (this.isNotBaseArray() && !this._isArray) {
                    this._iLength = this.getSubType().getLength();
                } else if (this._iLength === 0xffffff || this._isNeedToUpdateLength) {
                    var isEval = this._pArrayIndexExpr.evaluate();
                    if (isEval) {
                        var iValue = this._pArrayIndexExpr.getEvalValue();
                        this._iLength = (typeof (iValue) === "number") ? iValue : 0xffffff;
                    }
                }
                return this._iLength;
            };
            VariableTypeInstruction.prototype.getPadding = function () {
                return this.isPointIndex() ? this._getDownPointer().getType().getPadding() : this._iPadding;
            };
            VariableTypeInstruction.prototype.getArrayElementType = function () {
                if (this._isUnverifiable()) {
                    return this;
                }
                if (!this.isArray()) {
                    return null;
                }
                if (((this._pArrayElementType) === null)) {
                    this._pArrayElementType = new VariableTypeInstruction();
                    this._pArrayElementType.pushType(this.getSubType().getArrayElementType());
                    if (!((this._pUsageList) === null)) {
                        for(var i = 0; i < this._pUsageList.length; i++) {
                            this._pArrayElementType.addUsage(this._pUsageList[i]);
                        }
                    }
                    this._pArrayElementType.setParent(this);
                }
                return this._pArrayElementType;
            };
            VariableTypeInstruction.prototype.getTypeDecl = function () {
                if (!this.isFromTypeDecl()) {
                    return null;
                }
                var eParentType = this.getParent()._getInstructionType();
                if (eParentType === akra.EAFXInstructionTypes.k_TypeDeclInstruction) {
                    return this.getParent();
                } else {
                    return (this.getParent()).getTypeDecl();
                }
            };
            VariableTypeInstruction.prototype.hasField = function (sFieldName) {
                return this._isUnverifiable() ? true : this.getSubType().hasField(sFieldName);
            };
            VariableTypeInstruction.prototype.hasFieldWithSematic = function (sSemantic) {
                if (!this.isComplex()) {
                    return false;
                }
                return this.getSubType().hasFieldWithSematic(sSemantic);
            };
            VariableTypeInstruction.prototype.hasAllUniqueSemantics = function () {
                if (!this.isComplex()) {
                    return false;
                }
                return this.getSubType().hasAllUniqueSemantics();
            };
            VariableTypeInstruction.prototype.hasFieldWithoutSemantic = function () {
                if (!this.isComplex()) {
                    return false;
                }
                return this.getSubType().hasFieldWithoutSemantic();
            };
            VariableTypeInstruction.prototype.getField = function (sFieldName) {
                if (!this.hasField(sFieldName)) {
                    return null;
                }
                if (((this._pFieldDeclMap) === null)) {
                    this._pFieldDeclMap = {};
                }
                if (((this._pFieldDeclMap[sFieldName]) !== undefined)) {
                    return this._pFieldDeclMap[sFieldName];
                }
                var pField = new fx.VariableDeclInstruction();
                if (!this._isUnverifiable()) {
                    var pSubField = this.getSubType().getField(sFieldName);
                    var pFieldType = new VariableTypeInstruction();
                    pFieldType.pushType(pSubField.getType());
                    pFieldType.setPadding(pSubField.getType().getPadding());
                    pField.push(pFieldType, true);
                    pField.push(pSubField.getNameId(), false);
                    pField.setSemantic(pSubField.getSemantic());
                } else {
                    var pFieldName = new fx.IdInstruction();
                    pFieldName.setName(sFieldName);
                    pFieldName.setRealName(sFieldName);
                    pField.push(this, false);
                    pField.push(pFieldName, true);
                }
                pField.setParent(this);
                this._pFieldDeclMap[sFieldName] = pField;
                return pField;
            };
            VariableTypeInstruction.prototype.getFieldBySemantic = function (sSemantic) {
                if (this.hasFieldWithSematic(sSemantic)) {
                    return null;
                }
                if (((this._pFieldDeclBySemanticMap) === null)) {
                    this._pFieldDeclBySemanticMap = {};
                }
                if (((this._pFieldDeclBySemanticMap[sSemantic]) !== undefined)) {
                    return this._pFieldDeclBySemanticMap[sSemantic];
                }
                var pField = new fx.VariableDeclInstruction();
                var pSubField = this.getSubType().getFieldBySemantic(sSemantic);
                var pFieldType = new VariableTypeInstruction();
                pFieldType.pushType(pSubField.getType());
                pFieldType.setPadding(pSubField.getType().getPadding());
                pField.push(pFieldType, true);
                pField.push(pSubField.getNameId(), false);
                pField.setParent(this);
                this._pFieldDeclBySemanticMap[sSemantic] = pField;
                return pField;
            };
            VariableTypeInstruction.prototype.getFieldType = function (sFieldName) {
                return this.getField(sFieldName).getType();
            };
            VariableTypeInstruction.prototype.getFieldNameList = function () {
                return this.getSubType().getFieldNameList();
            };
            VariableTypeInstruction.prototype.getUsageList = function () {
                return this._pUsageList;
            };
            VariableTypeInstruction.prototype.getSubType = function () {
                return this._pSubType;
            };
            VariableTypeInstruction.prototype.hasUsage = function (sUsageName) {
                if (((this._pUsageList) === null)) {
                    return false;
                }
                for(var i = 0; i < this._pUsageList.length; i++) {
                    if (this._pUsageList[i] === sUsageName) {
                        return true;
                    }
                }
                if (!((this.getSubType()) === null) && this.getSubType()._getInstructionType() === akra.EAFXInstructionTypes.k_VariableTypeInstruction) {
                    return (this.getSubType()).hasUsage(sUsageName);
                }
                return false;
            };
            VariableTypeInstruction.prototype.hasVideoBuffer = function () {
                return !((this.getVideoBuffer()) === null);
            };
            VariableTypeInstruction.prototype.getPointDim = function () {
                return this._nPointDim || ((this.getSubType()._getInstructionType() === akra.EAFXInstructionTypes.k_VariableTypeInstruction) ? (this.getSubType()).getPointDim() : 0);
            };
            VariableTypeInstruction.prototype.getPointer = function () {
                if (!this.isFromVariableDecl() || !(this.isPointer() || this.isPointIndex()) || !this.hasVideoBuffer()) {
                    return null;
                }
                if (!((this._pUpPointIndex) === null)) {
                    return this._pUpPointIndex;
                }
                if (this.isPointIndex()) {
                    return null;
                }
                this.initializePointers();
                return this._pUpPointIndex;
            };
            VariableTypeInstruction.prototype.getVideoBuffer = function () {
                if (this.isPointIndex()) {
                    return (this.getParent().getParent()).getType().getVideoBuffer();
                }
                return this._pVideoBuffer;
            };
            VariableTypeInstruction.prototype.getFieldExpr = function (sFieldName) {
                if (!this.hasField(sFieldName)) {
                    return null;
                }
                var pField = this.getField(sFieldName);
                var pExpr = new fx.IdExprInstruction();
                pExpr.push(pField.getNameId(), false);
                pExpr.setType(pField.getType());
                return pExpr;
            };
            VariableTypeInstruction.prototype.getFieldIfExist = function (sFieldName) {
                if (((this._pFieldDeclMap) === null) && ((this._pFieldDeclMap[sFieldName]) !== undefined)) {
                    return this._pFieldDeclMap[sFieldName];
                } else {
                    return null;
                }
            };
            VariableTypeInstruction.prototype.getSubVarDecls = function () {
                if (!this.canHaveSubDecls()) {
                    return null;
                }
                if (((this._pSubDeclList) === null)) {
                    this.generateSubDeclList();
                }
                return this._pSubDeclList;
            };
            VariableTypeInstruction.prototype._getFullName = function () {
                if (!this.isFromVariableDecl()) {
                    return "Not from variable decl";
                }
                var eParentType = this.getParent()._getInstructionType();
                if (eParentType === akra.EAFXInstructionTypes.k_VariableDeclInstruction) {
                    return (this.getParent())._getFullName();
                } else {
                    return (this.getParent())._getFullName();
                }
            };
            VariableTypeInstruction.prototype._getVarDeclName = function () {
                if (!this.isFromVariableDecl()) {
                    return "";
                }
                var eParentType = this.getParent()._getInstructionType();
                if (eParentType === akra.EAFXInstructionTypes.k_VariableDeclInstruction) {
                    return (this.getParent()).getName();
                } else {
                    return (this.getParent())._getVarDeclName();
                }
            };
            VariableTypeInstruction.prototype._getTypeDeclName = function () {
                if (!this.isFromVariableDecl()) {
                    return "";
                }
                var eParentType = this.getParent()._getInstructionType();
                if (eParentType === akra.EAFXInstructionTypes.k_VariableDeclInstruction) {
                    return (this.getParent()).getName();
                } else {
                    return (this.getParent())._getTypeDeclName();
                }
            };
            VariableTypeInstruction.prototype._getParentVarDecl = function () {
                if (!this.isFromVariableDecl()) {
                    return null;
                }
                var eParentType = this.getParent()._getInstructionType();
                if (eParentType === akra.EAFXInstructionTypes.k_VariableDeclInstruction) {
                    return this.getParent();
                } else {
                    return (this.getParent())._getParentVarDecl();
                }
            };
            VariableTypeInstruction.prototype._getParentContainer = function () {
                if (!this.isFromVariableDecl() || !this._isTypeOfField()) {
                    return null;
                }
                var pContainerType = this._getParentVarDecl().getParent();
                if (!pContainerType.isFromVariableDecl()) {
                    return null;
                }
                return pContainerType._getParentVarDecl();
            };
            VariableTypeInstruction.prototype._getMainVariable = function () {
                if (!this.isFromVariableDecl()) {
                    return null;
                }
                if (this._isTypeOfField()) {
                    return (this.getParent().getParent())._getMainVariable();
                } else {
                    return (this._getParentVarDecl());
                }
            };
            VariableTypeInstruction.prototype._getMainPointer = function () {
                if (((this._pMainPointIndex) === null)) {
                    if (((this.getPointer()) === null)) {
                        this._pMainPointIndex = this._getParentVarDecl();
                    } else {
                        this._pMainPointIndex = this._getUpPointer().getType()._getMainPointer();
                    }
                }
                return this._pMainPointIndex;
            };
            VariableTypeInstruction.prototype._getUpPointer = function () {
                return this._pUpPointIndex;
            };
            VariableTypeInstruction.prototype._getDownPointer = function () {
                return this._pDownPointIndex;
            };
            VariableTypeInstruction.prototype._getAttrOffset = function () {
                return this._pAttrOffset;
            };
            VariableTypeInstruction.prototype.wrap = function () {
                var pCloneType = new VariableTypeInstruction();
                pCloneType.pushType(this);
                return pCloneType;
            };
            VariableTypeInstruction.prototype.clone = function (pRelationMap) {
                if (typeof pRelationMap === "undefined") { pRelationMap = {}; }
                if (((pRelationMap[this._getInstructionID()]) !== undefined)) {
                    return pRelationMap[this._getInstructionID()];
                }
                if (this._pParentInstruction === null || !((pRelationMap[this._pParentInstruction._getInstructionID()]) !== undefined) || pRelationMap[this._pParentInstruction._getInstructionID()] === this._pParentInstruction) {
                    return this;
                }
                var pClone = _super.prototype.clone.call(this, pRelationMap);
                pClone.pushType(this._pSubType.clone(pRelationMap));
                if (!((this._pUsageList) === null)) {
                    for(var i = 0; i < this._pUsageList.length; i++) {
                        pClone.addUsage(this._pUsageList[i]);
                    }
                }
                pClone._canWrite(this._isWritable);
                pClone._canRead(this._isReadable);
                pClone._setCloneHash(this._sHash, this._sStrongHash);
                pClone.setPadding(this.getPadding());
                if (this._isArray) {
                    this._setCloneArrayIndex(this._pArrayElementType.clone(pRelationMap), this._pArrayIndexExpr.clone(pRelationMap), this._iLength);
                }
                if (this._isPointer) {
                    var pClonePointerList = null;
                    if (!((this._pPointerList) === null)) {
                        pClonePointerList = new Array(this._pPointerList.length);
                        var pDownPointer = pClone._getParentVarDecl();
                        for(var i = 0; i < this._pPointerList.length; i++) {
                            pClonePointerList[i] = this._pPointerList[i].clone(pRelationMap);
                            if (i > 0) {
                                (pClonePointerList[i - 1].getType())._setUpDownPointers(pClonePointerList[i], pDownPointer);
                                pDownPointer = pClonePointerList[i - 1];
                            } else {
                                pClonePointerList[0].getType()._setUpDownPointers(null, pDownPointer);
                            }
                        }
                        pClonePointerList[pClonePointerList.length - 1].getType()._setUpDownPointers(null, pDownPointer);
                    }
                    this._setClonePointeIndexes(this.getPointDim(), pClonePointerList);
                }
                if (!((this._pFieldDeclMap) === null)) {
                    var sFieldName = "";
                    var pCloneFieldMap = {};
                    for(sFieldName in this._pFieldDeclMap) {
                        pCloneFieldMap[sFieldName] = this._pFieldDeclMap[sFieldName].clone(pRelationMap);
                    }
                    this._setCloneFields(pCloneFieldMap);
                }
                return pClone;
            };
            VariableTypeInstruction.prototype.blend = function (pType, eMode) {
                if (this === pType) {
                    return this;
                }
                if (eMode === akra.EAFXBlendMode.k_Global) {
                    return null;
                }
                if (this.isComplex() !== pType.isComplex() || (this.isNotBaseArray() !== pType.isNotBaseArray()) || (this.isPointer() !== pType.isPointer())) {
                    return null;
                }
                if (this.isNotBaseArray() || this.getLength() === 0xffffff || this.getLength() !== pType.getLength()) {
                    return null;
                }
                var pBlendBaseType = this.getBaseType().blend(pType.getBaseType(), eMode);
                if (((pBlendBaseType) === null)) {
                    return null;
                }
                var pBlendType = new VariableTypeInstruction();
                pBlendType.pushType(pBlendBaseType);
                if (this.isNotBaseArray()) {
                    var iLength = this.getLength();
                    var pLengthExpr = new fx.IntInstruction();
                    pLengthExpr.setValue(iLength);
                    pBlendType.addArrayIndex(pLengthExpr);
                }
                return pBlendType;
            };
            VariableTypeInstruction.prototype._setCloneHash = function (sHash, sStrongHash) {
                this._sHash = sHash;
                this._sStrongHash = sStrongHash;
            };
            VariableTypeInstruction.prototype._setCloneArrayIndex = function (pElementType, pIndexExpr, iLength) {
                this._isArray = true;
                this._pArrayElementType = pElementType;
                this._pArrayIndexExpr = pIndexExpr;
                this._iLength = iLength;
            };
            VariableTypeInstruction.prototype._setClonePointeIndexes = function (nDim, pPointerList) {
                this._isPointer = true;
                this._nPointDim = nDim;
                this._pPointerList = pPointerList;
                if (!((this._pPointerList) === null)) {
                    this._pUpPointIndex = this._pPointerList[0];
                }
            };
            VariableTypeInstruction.prototype._setCloneFields = function (pFieldMap) {
                this._pFieldDeclMap = pFieldMap;
            };
            VariableTypeInstruction.prototype._setUpDownPointers = function (pUpPointIndex, pDownPointIndex) {
                this._pUpPointIndex = pUpPointIndex;
                this._pDownPointIndex = pDownPointIndex;
            };
            VariableTypeInstruction.prototype.calcHash = function () {
                var sHash = this.getSubType().getHash();
                if (this._isArray) {
                    sHash += "[";
                    var iLength = this.getLength();
                    if (iLength === 0xffffff) {
                        sHash += "undef";
                    } else {
                        sHash += iLength.toString();
                    }
                    sHash += "]";
                }
                this._sHash = sHash;
            };
            VariableTypeInstruction.prototype.calcStrongHash = function () {
                var sStrongHash = this.getSubType().getStrongHash();
                if (this._isArray) {
                    sStrongHash += "[";
                    var iLength = this.getLength();
                    if (iLength === 0xffffff) {
                        sStrongHash += "undef";
                    } else {
                        sStrongHash += iLength.toString();
                    }
                    sStrongHash += "]";
                }
                if (this.isPointer()) {
                    for(var i = 0; i < this.getPointDim(); i++) {
                        sStrongHash = "@" + sStrongHash;
                    }
                }
                this._sStrongHash = sStrongHash;
            };
            VariableTypeInstruction.prototype.generateSubDeclList = function () {
                if (!this.canHaveSubDecls()) {
                    return;
                }
                var pDeclList = [];
                var i = 0;
                if (!((this._pAttrOffset) === null)) {
                    pDeclList.push(this._pAttrOffset);
                }
                if (this.isPointer()) {
                    if (((this._getUpPointer()) === null)) {
                        this.initializePointers();
                    }
                    for(i = 0; i < this._pPointerList.length; i++) {
                        pDeclList.push(this._pPointerList[i]);
                    }
                }
                if (this.isComplex()) {
                    var pFieldNameList = this.getFieldNameList();
                    for(i = 0; i < pFieldNameList.length; i++) {
                        var pField = this.getField(pFieldNameList[i]);
                        var pFieldSubDeclList = pField.getSubVarDecls();
                        if (!((pFieldSubDeclList) === null)) {
                            for(var j = 0; j < pFieldSubDeclList.length; j++) {
                                pDeclList.push(pFieldSubDeclList[j]);
                            }
                        }
                    }
                }
                this._pSubDeclList = pDeclList;
            };
            VariableTypeInstruction.prototype.canHaveSubDecls = function () {
                return this.isComplex() || this.isPointer() || !((this._pAttrOffset) === null);
            };
            return VariableTypeInstruction;
        })(fx.Instruction);
        fx.VariableTypeInstruction = VariableTypeInstruction;        
        var SystemTypeInstruction = (function (_super) {
            __extends(SystemTypeInstruction, _super);
            function SystemTypeInstruction() {
                        _super.call(this);
                this._sName = "";
                this._sRealName = "";
                this._pElementType = null;
                this._iLength = 1;
                this._iSize = null;
                this._pFieldDeclMap = null;
                this._isArray = false;
                this._isWritable = true;
                this._isReadable = true;
                this._pFieldNameList = null;
                this._pWrapVariableType = null;
                this._isBuiltIn = true;
                this._sDeclString = "";
                this._eInstructionType = akra.EAFXInstructionTypes.k_SystemTypeInstruction;
                this._pWrapVariableType = new VariableTypeInstruction();
                this._pWrapVariableType.pushType(this);
            }
            SystemTypeInstruction.prototype._toDeclString = function () {
                return this._sDeclString;
            };
            SystemTypeInstruction.prototype.toFinalCode = function () {
                return this._sRealName;
            };
            SystemTypeInstruction.prototype.isBuiltIn = function () {
                return this._isBuiltIn;
            };
            SystemTypeInstruction.prototype.setBuiltIn = function (isBuiltIn) {
                this._isBuiltIn = isBuiltIn;
            };
            SystemTypeInstruction.prototype.setDeclString = function (sDecl) {
                this._sDeclString = sDecl;
            };
            SystemTypeInstruction.prototype.isBase = function () {
                return true;
            };
            SystemTypeInstruction.prototype.isArray = function () {
                return this._isArray;
            };
            SystemTypeInstruction.prototype.isNotBaseArray = function () {
                return false;
            };
            SystemTypeInstruction.prototype.isComplex = function () {
                return false;
            };
            SystemTypeInstruction.prototype.isEqual = function (pType) {
                return this.getHash() === pType.getHash();
            };
            SystemTypeInstruction.prototype.isStrongEqual = function (pType) {
                return this.getStrongHash() === pType.getStrongHash();
            };
            SystemTypeInstruction.prototype.isConst = function () {
                return false;
            };
            SystemTypeInstruction.prototype.isSampler = function () {
                return this.getName() === "sampler" || this.getName() === "sampler2D" || this.getName() === "samplerCUBE";
            };
            SystemTypeInstruction.prototype.isSamplerCube = function () {
                return this.getName() === "samplerCUBE";
            };
            SystemTypeInstruction.prototype.isSampler2D = function () {
                return this.getName() === "sampler" || this.getName() === "sampler2D";
            };
            SystemTypeInstruction.prototype.isWritable = function () {
                return this._isWritable;
            };
            SystemTypeInstruction.prototype.isReadable = function () {
                return this._isReadable;
            };
            SystemTypeInstruction.prototype._containArray = function () {
                return false;
            };
            SystemTypeInstruction.prototype._containSampler = function () {
                return false;
            };
            SystemTypeInstruction.prototype._containPointer = function () {
                return false;
            };
            SystemTypeInstruction.prototype._containComplexType = function () {
                return false;
            };
            SystemTypeInstruction.prototype.setName = function (sName) {
                this._sName = sName;
            };
            SystemTypeInstruction.prototype.setRealName = function (sRealName) {
                this._sRealName = sRealName;
            };
            SystemTypeInstruction.prototype.setSize = function (iSize) {
                this._iSize = iSize;
            };
            SystemTypeInstruction.prototype._canWrite = function (isWritable) {
                this._isWritable = isWritable;
            };
            SystemTypeInstruction.prototype._canRead = function (isReadable) {
                this._isReadable = isReadable;
            };
            SystemTypeInstruction.prototype.addIndex = function (pType, iLength) {
                this._pElementType = pType;
                this._iLength = iLength;
                this._iSize = iLength * pType.getSize();
                this._isArray = true;
            };
            SystemTypeInstruction.prototype.addField = function (sFieldName, pType, isWrite, sRealFieldName) {
                if (typeof isWrite === "undefined") { isWrite = true; }
                if (typeof sRealFieldName === "undefined") { sRealFieldName = sFieldName; }
                var pField = new fx.VariableDeclInstruction();
                var pFieldType = new VariableTypeInstruction();
                var pFieldId = new fx.IdInstruction();
                pFieldType.pushType(pType);
                pFieldType._canWrite(isWrite);
                pFieldId.setName(sFieldName);
                pFieldId.setRealName(sRealFieldName);
                pField.push(pFieldType, true);
                pField.push(pFieldId, true);
                if (((this._pFieldDeclMap) === null)) {
                    this._pFieldDeclMap = {};
                }
                this._pFieldDeclMap[sFieldName] = pField;
                if (((this._pFieldNameList) === null)) {
                    this._pFieldNameList = [];
                }
                this._pFieldNameList.push(sFieldName);
            };
            SystemTypeInstruction.prototype.getName = function () {
                return this._sName;
            };
            SystemTypeInstruction.prototype.getRealName = function () {
                return this._sRealName;
            };
            SystemTypeInstruction.prototype.getHash = function () {
                return this._sRealName;
            };
            SystemTypeInstruction.prototype.getStrongHash = function () {
                return this._sName;
            };
            SystemTypeInstruction.prototype.getSize = function () {
                return this._iSize;
            };
            SystemTypeInstruction.prototype.getBaseType = function () {
                return this;
            };
            SystemTypeInstruction.prototype.getVariableType = function () {
                return this._pWrapVariableType;
            };
            SystemTypeInstruction.prototype.getArrayElementType = function () {
                return this._pElementType;
            };
            SystemTypeInstruction.prototype.getTypeDecl = function () {
                if (this.isBuiltIn()) {
                    return null;
                }
                return this.getParent();
            };
            SystemTypeInstruction.prototype.getLength = function () {
                return this._iLength;
            };
            SystemTypeInstruction.prototype.hasField = function (sFieldName) {
                return ((this._pFieldDeclMap[sFieldName]) !== undefined);
            };
            SystemTypeInstruction.prototype.hasFieldWithSematic = function (sSemantic) {
                return false;
            };
            SystemTypeInstruction.prototype.hasAllUniqueSemantics = function () {
                return false;
            };
            SystemTypeInstruction.prototype.hasFieldWithoutSemantic = function () {
                return false;
            };
            SystemTypeInstruction.prototype.getField = function (sFieldName) {
                return ((this._pFieldDeclMap[sFieldName]) !== undefined) ? this._pFieldDeclMap[sFieldName] : null;
            };
            SystemTypeInstruction.prototype.getFieldBySemantic = function (sSemantic) {
                return null;
            };
            SystemTypeInstruction.prototype.getFieldType = function (sFieldName) {
                return ((this._pFieldDeclMap[sFieldName]) !== undefined) ? this._pFieldDeclMap[sFieldName].getType() : null;
            };
            SystemTypeInstruction.prototype.getFieldNameList = function () {
                return this._pFieldNameList;
            };
            SystemTypeInstruction.prototype.clone = function (pRelationMap) {
                return this;
            };
            SystemTypeInstruction.prototype.blend = function (pType, eMode) {
                if (this.isStrongEqual(pType)) {
                    return this;
                }
                return null;
            };
            return SystemTypeInstruction;
        })(fx.Instruction);
        fx.SystemTypeInstruction = SystemTypeInstruction;        
        var ComplexTypeInstruction = (function (_super) {
            __extends(ComplexTypeInstruction, _super);
            function ComplexTypeInstruction() {
                        _super.call(this);
                this._sName = "";
                this._sRealName = "";
                this._sHash = "";
                this._sStrongHash = "";
                this._iSize = 0;
                this._pFieldDeclMap = null;
                this._pFieldDeclList = null;
                this._pFieldNameList = null;
                this._pFieldDeclBySemanticMap = null;
                this._hasAllUniqueSemantics = true;
                this._hasFieldWithoutSemantic = false;
                this._isContainArray = false;
                this._isContainSampler = false;
                this._isContainPointer = false;
                this._isContainComplexType = false;
                this._pInstructionList = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_ComplexTypeInstruction;
            }
            ComplexTypeInstruction.prototype._toDeclString = function () {
                var sCode = "struct " + this._sRealName + "{";
                for(var i = 0; i < this._pFieldDeclList.length; i++) {
                    sCode += "\t" + this._pFieldDeclList[i].toFinalCode() + ";\n";
                }
                sCode += "}";
                return sCode;
            };
            ComplexTypeInstruction.prototype.toFinalCode = function () {
                return this._sRealName;
            };
            ComplexTypeInstruction.prototype.isBuiltIn = function () {
                return false;
            };
            ComplexTypeInstruction.prototype.setBuiltIn = function (isBuiltIn) {
            };
            ComplexTypeInstruction.prototype.isBase = function () {
                return false;
            };
            ComplexTypeInstruction.prototype.isArray = function () {
                return false;
            };
            ComplexTypeInstruction.prototype.isNotBaseArray = function () {
                return false;
            };
            ComplexTypeInstruction.prototype.isComplex = function () {
                return true;
            };
            ComplexTypeInstruction.prototype.isEqual = function (pType) {
                return this.getHash() === pType.getHash();
            };
            ComplexTypeInstruction.prototype.isStrongEqual = function (pType) {
                return this.getStrongHash() === pType.getStrongHash();
            };
            ComplexTypeInstruction.prototype.isConst = function () {
                return false;
            };
            ComplexTypeInstruction.prototype.isSampler = function () {
                return false;
            };
            ComplexTypeInstruction.prototype.isSamplerCube = function () {
                return false;
            };
            ComplexTypeInstruction.prototype.isSampler2D = function () {
                return false;
            };
            ComplexTypeInstruction.prototype.isWritable = function () {
                return true;
            };
            ComplexTypeInstruction.prototype.isReadable = function () {
                return true;
            };
            ComplexTypeInstruction.prototype._containArray = function () {
                return this._isContainArray;
            };
            ComplexTypeInstruction.prototype._containSampler = function () {
                return this._isContainSampler;
            };
            ComplexTypeInstruction.prototype._containPointer = function () {
                return this._isContainPointer;
            };
            ComplexTypeInstruction.prototype._containComplexType = function () {
                return this._isContainComplexType;
            };
            ComplexTypeInstruction.prototype.setName = function (sName) {
                this._sName = sName;
                this._sRealName = sName;
            };
            ComplexTypeInstruction.prototype.setRealName = function (sRealName) {
                this._sRealName = sRealName;
            };
            ComplexTypeInstruction.prototype.setSize = function (iSize) {
                this._iSize = iSize;
            };
            ComplexTypeInstruction.prototype._canWrite = function (isWritable) {
            };
            ComplexTypeInstruction.prototype._canRead = function (isWritable) {
            };
            ComplexTypeInstruction.prototype.addField = function (pVariable) {
                if (((this._pFieldDeclMap) === null)) {
                    this._pFieldDeclMap = {};
                    this._pFieldNameList = [];
                }
                if (((this._pFieldDeclList) === null)) {
                    this._pFieldDeclList = [];
                }
                var sVarName = pVariable.getName();
                this._pFieldDeclMap[sVarName] = pVariable;
                if (this._iSize !== 0xffffff) {
                    var iSize = pVariable.getType().getSize();
                    if (iSize !== 0xffffff) {
                        this._iSize += iSize;
                    } else {
                        this._iSize = 0xffffff;
                    }
                }
                this._pFieldNameList.push(sVarName);
                if (this._pFieldDeclList.length < this._pFieldNameList.length) {
                    this._pFieldDeclList.push(pVariable);
                }
                var pType = pVariable.getType();
                if (pType.isNotBaseArray() || pType._containArray()) {
                    this._isContainArray = true;
                }
                if (fx.isSamplerType(pType) || pType._containSampler()) {
                    this._isContainSampler = true;
                }
                if (pType.isPointer() || pType._containPointer()) {
                    this._isContainPointer = true;
                }
                if (pType.isComplex()) {
                    this._isContainComplexType = true;
                }
            };
            ComplexTypeInstruction.prototype.addFields = function (pFieldCollector, isSetParent) {
                if (typeof isSetParent === "undefined") { isSetParent = true; }
                this._pFieldDeclList = (pFieldCollector.getInstructions());
                for(var i = 0; i < this._pFieldDeclList.length; i++) {
                    this.addField(this._pFieldDeclList[i]);
                    this._pFieldDeclList[i].setParent(this);
                }
                this.calculatePaddings();
            };
            ComplexTypeInstruction.prototype.getName = function () {
                return this._sName;
            };
            ComplexTypeInstruction.prototype.getRealName = function () {
                return this._sRealName;
            };
            ComplexTypeInstruction.prototype.getHash = function () {
                if (this._sHash === "") {
                    this.calcHash();
                }
                return this._sHash;
            };
            ComplexTypeInstruction.prototype.getStrongHash = function () {
                if (this._sStrongHash === "") {
                    this.calcStrongHash();
                }
                return this._sStrongHash;
            };
            ComplexTypeInstruction.prototype.hasField = function (sFieldName) {
                return ((this._pFieldDeclMap[sFieldName]) !== undefined);
            };
            ComplexTypeInstruction.prototype.hasFieldWithSematic = function (sSemantic) {
                if (((this._pFieldDeclBySemanticMap) === null)) {
                    this.analyzeSemantics();
                }
                return ((this._pFieldDeclBySemanticMap[sSemantic]) !== undefined);
            };
            ComplexTypeInstruction.prototype.hasAllUniqueSemantics = function () {
                if (((this._pFieldDeclBySemanticMap) === null)) {
                    this.analyzeSemantics();
                }
                return this._hasAllUniqueSemantics;
            };
            ComplexTypeInstruction.prototype.hasFieldWithoutSemantic = function () {
                if (((this._pFieldDeclBySemanticMap) === null)) {
                    this.analyzeSemantics();
                }
                return this._hasFieldWithoutSemantic;
            };
            ComplexTypeInstruction.prototype.getField = function (sFieldName) {
                if (!this.hasField(sFieldName)) {
                    return null;
                }
                return this._pFieldDeclMap[sFieldName];
            };
            ComplexTypeInstruction.prototype.getFieldBySemantic = function (sSemantic) {
                if (!this.hasFieldWithSematic(sSemantic)) {
                    return null;
                }
                return this._pFieldDeclBySemanticMap[sSemantic];
            };
            ComplexTypeInstruction.prototype.getFieldType = function (sFieldName) {
                return ((this._pFieldDeclMap[sFieldName]) !== undefined) ? this._pFieldDeclMap[sFieldName].getType() : null;
            };
            ComplexTypeInstruction.prototype.getFieldNameList = function () {
                return this._pFieldNameList;
            };
            ComplexTypeInstruction.prototype.getSize = function () {
                if (this._iSize === 0xffffff) {
                    this._iSize = this._calcSize();
                }
                return this._iSize;
            };
            ComplexTypeInstruction.prototype.getBaseType = function () {
                return this;
            };
            ComplexTypeInstruction.prototype.getArrayElementType = function () {
                return null;
            };
            ComplexTypeInstruction.prototype.getTypeDecl = function () {
                return this.getParent();
            };
            ComplexTypeInstruction.prototype.getLength = function () {
                return 0;
            };
            ComplexTypeInstruction.prototype._getFieldDeclList = function () {
                return this._pFieldDeclList;
            };
            ComplexTypeInstruction.prototype.clone = function (pRelationMap) {
                if (typeof pRelationMap === "undefined") { pRelationMap = {}; }
                if (this._pParentInstruction === null || !((pRelationMap[this._pParentInstruction._getInstructionID()]) !== undefined) || pRelationMap[this._pParentInstruction._getInstructionID()] === this._pParentInstruction) {
                    return this;
                }
                var pClone = _super.prototype.clone.call(this, pRelationMap);
                pClone._setCloneName(this._sName, this._sRealName);
                pClone._setCloneHash(this._sHash, this._sStrongHash);
                pClone._setCloneContain(this._isContainArray, this._isContainSampler);
                var pFieldDeclList = new Array(this._pFieldDeclList.length);
                var pFieldNameList = new Array(this._pFieldNameList.length);
                var pFieldDeclMap = {};
                for(var i = 0; i < this._pFieldDeclList.length; i++) {
                    var pCloneVar = this._pFieldDeclList[i].clone(pRelationMap);
                    var sVarName = pCloneVar.getName();
                    pFieldDeclList[i] = pCloneVar;
                    pFieldNameList[i] = sVarName;
                    pFieldDeclMap[sVarName] = pCloneVar;
                }
                pClone._setCloneFields(pFieldDeclList, pFieldNameList, pFieldDeclMap);
                pClone.setSize(this._iSize);
                return pClone;
            };
            ComplexTypeInstruction.prototype.blend = function (pType, eMode) {
                if (pType === this) {
                    return this;
                }
                if (eMode === akra.EAFXBlendMode.k_TypeDecl) {
                    return null;
                }
                if (eMode === akra.EAFXBlendMode.k_Uniform || eMode === akra.EAFXBlendMode.k_Attribute) {
                    if (this.hasFieldWithoutSemantic() || pType.hasFieldWithoutSemantic()) {
                        return null;
                    }
                }
                var pFieldList = this._pFieldDeclList;
                var pBlendType = new ComplexTypeInstruction();
                var pRelationMap = {};
                if (((pFieldList) === null)) {
 {
                        akra.logger.setSourceLocation("fx/TypeInstruction.ts", 1899);
                        akra.logger.log(this, pType);
                    }
                    ;
                }
                for(var i = 0; i < pFieldList.length; i++) {
                    var pField = pFieldList[i];
                    var pBlendField = null;
                    var sFieldName = pField.getName();
                    var sFieldSemantic = pField.getSemantic();
                    if (eMode === akra.EAFXBlendMode.k_Shared) {
                        if (pType.hasField(sFieldName)) {
                            pBlendField = pField.blend(pType.getField(sFieldName), eMode);
                        } else {
                            pBlendField = pField.clone(pRelationMap);
                        }
                    } else if (eMode === akra.EAFXBlendMode.k_Attribute || eMode === akra.EAFXBlendMode.k_Uniform || eMode === akra.EAFXBlendMode.k_VertexOut) {
                        if (pType.hasFieldWithSematic(sFieldSemantic)) {
                            pBlendField = pField.blend(pType.getFieldBySemantic(sFieldSemantic), eMode);
                        } else {
                            pBlendField = pField.clone(pRelationMap);
                        }
                        if (!((pBlendField) === null)) {
                            pBlendField.getNameId().setName(sFieldSemantic);
                            pBlendField.getNameId().setRealName(sFieldSemantic);
                        }
                    }
                    if (((pBlendField) === null)) {
                        return null;
                    }
                    pBlendType.addField(pBlendField);
                }
                pFieldList = (pType)._getFieldDeclList();
                for(var i = 0; i < pFieldList.length; i++) {
                    var pField = pFieldList[i];
                    var pBlendField = null;
                    var sFieldName = pField.getName();
                    var sFieldSemantic = pField.getSemantic();
                    if (eMode === akra.EAFXBlendMode.k_Shared) {
                        if (!this.hasField(sFieldName)) {
                            pBlendField = pField.clone(pRelationMap);
                        }
                    } else if (eMode === akra.EAFXBlendMode.k_Attribute || eMode === akra.EAFXBlendMode.k_Uniform || eMode === akra.EAFXBlendMode.k_VertexOut) {
                        if (!this.hasFieldWithSematic(sFieldSemantic)) {
                            pBlendField = pField.clone(pRelationMap);
                            pBlendField.getNameId().setName(sFieldSemantic);
                            pBlendField.getNameId().setRealName(sFieldSemantic);
                        }
                    }
                    if (!((pBlendField) === null)) {
                        pBlendType.addField(pBlendField);
                    }
                }
                pBlendType.setName(this.getName());
                pBlendType.setRealName(this.getRealName());
                return pBlendType;
            };
            ComplexTypeInstruction.prototype._setCloneName = function (sName, sRealName) {
                this._sName = sName;
                this._sRealName = sRealName;
            };
            ComplexTypeInstruction.prototype._setCloneHash = function (sHash, sStrongHash) {
                this._sHash = sHash;
                this._sStrongHash = sStrongHash;
            };
            ComplexTypeInstruction.prototype._setCloneContain = function (isContainArray, isContainSampler) {
                this._isContainArray = isContainArray;
                this._isContainSampler = isContainSampler;
            };
            ComplexTypeInstruction.prototype._setCloneFields = function (pFieldDeclList, pFieldNameList, pFieldDeclMap) {
                this._pFieldDeclList = pFieldDeclList;
                this._pFieldNameList = pFieldNameList;
                this._pFieldDeclMap = pFieldDeclMap;
            };
            ComplexTypeInstruction.prototype._calcSize = function () {
                var iSize = 0;
                for(var i = 0; i < this._pFieldDeclList.length; i++) {
                    var iFieldSize = this._pFieldDeclList[i].getType().getSize();
                    if (iFieldSize === 0xffffff) {
                        iSize = 0xffffff;
                        break;
                    } else {
                        iSize += iFieldSize;
                    }
                }
                return iSize;
            };
            ComplexTypeInstruction.prototype.calcHash = function () {
                var sHash = "{";
                for(var i = 0; i < this._pFieldDeclList.length; i++) {
                    sHash += this._pFieldDeclList[i].getType().getHash() + ";";
                }
                sHash += "}";
                this._sHash = sHash;
            };
            ComplexTypeInstruction.prototype.calcStrongHash = function () {
                var sStrongHash = "{";
                for(var i = 0; i < this._pFieldDeclList.length; i++) {
                    sStrongHash += this._pFieldDeclList[i].getType().getStrongHash() + ";";
                }
                sStrongHash += "}";
                this._sStrongHash = sStrongHash;
            };
            ComplexTypeInstruction.prototype.analyzeSemantics = function () {
                this._pFieldDeclBySemanticMap = {};
                for(var i = 0; i < this._pFieldDeclList.length; i++) {
                    var pVar = this._pFieldDeclList[i];
                    var sSemantic = pVar.getSemantic();
                    if (sSemantic === "") {
                        this._hasFieldWithoutSemantic = true;
                    }
                    if (((this._pFieldDeclBySemanticMap[sSemantic]) !== undefined)) {
                        this._hasAllUniqueSemantics = false;
                    }
                    this._pFieldDeclBySemanticMap[sSemantic] = pVar;
                    this._hasFieldWithoutSemantic = this._hasFieldWithoutSemantic || pVar.getType().hasFieldWithoutSemantic();
                    if (this._hasAllUniqueSemantics && pVar.getType().isComplex()) {
                        this._hasAllUniqueSemantics = pVar.getType().hasAllUniqueSemantics();
                    }
                }
            };
            ComplexTypeInstruction.prototype.calculatePaddings = function () {
                var iPadding = 0;
                for(var i = 0; i < this._pFieldDeclList.length; i++) {
                    var pVarType = this._pFieldDeclList[i].getType();
                    var iVarSize = pVarType.getSize();
                    if (iVarSize === 0xffffff) {
                        this.setError(2272, {
                            typeName: this.getName()
                        });
                        return;
                    }
                    pVarType.setPadding(iPadding);
                    iPadding += iVarSize;
                }
            };
            return ComplexTypeInstruction;
        })(fx.Instruction);
        fx.ComplexTypeInstruction = ComplexTypeInstruction;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var ExprInstruction = (function (_super) {
            __extends(ExprInstruction, _super);
            function ExprInstruction() {
                        _super.call(this);
                this._pLastEvalResult = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_ExprInstruction;
            }
            ExprInstruction.prototype.evaluate = function () {
                return false;
            };
            ExprInstruction.prototype.simplify = function () {
                return false;
            };
            ExprInstruction.prototype.getEvalValue = function () {
                return this._pLastEvalResult;
            };
            ExprInstruction.prototype.isConst = function () {
                return false;
            };
            ExprInstruction.prototype.getType = function () {
                return _super.prototype.getType.call(this);
            };
            ExprInstruction.prototype.clone = function (pRelationMap) {
                return _super.prototype.clone.call(this, pRelationMap);
            };
            ExprInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pInstructionList = this.getInstructions();
                if (((pInstructionList) === null)) {
                    return;
                }
                for(var i = 0; i < this._nInstructions; i++) {
                    pInstructionList[i].addUsedData(pUsedDataCollector, eUsedMode);
                }
            };
            return ExprInstruction;
        })(fx.TypedInstruction);
        fx.ExprInstruction = ExprInstruction;        
        var IntInstruction = (function (_super) {
            __extends(IntInstruction, _super);
            function IntInstruction() {
                        _super.call(this);
                this._iValue = 0;
                this._pType = fx.getEffectBaseType("int").getVariableType();
                this._eInstructionType = akra.EAFXInstructionTypes.k_IntInstruction;
            }
            IntInstruction.prototype.setValue = function (iValue) {
                this._iValue = iValue;
            };
            IntInstruction.prototype.toString = function () {
                return this._iValue;
            };
            IntInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this._iValue.toString();
                return sCode;
            };
            IntInstruction.prototype.evaluate = function () {
                this._pLastEvalResult = this._iValue;
                return true;
            };
            IntInstruction.prototype.isConst = function () {
                return true;
            };
            IntInstruction.prototype.clone = function (pRelationMap) {
                var pClonedInstruction = (_super.prototype.clone.call(this, pRelationMap));
                pClonedInstruction.setValue(this._iValue);
                return pClonedInstruction;
            };
            return IntInstruction;
        })(ExprInstruction);
        fx.IntInstruction = IntInstruction;        
        var FloatInstruction = (function (_super) {
            __extends(FloatInstruction, _super);
            function FloatInstruction() {
                        _super.call(this);
                this._fValue = 0.0;
                this._pType = fx.getEffectBaseType("float").getVariableType();
                this._eInstructionType = akra.EAFXInstructionTypes.k_FloatInstruction;
            }
            FloatInstruction.prototype.setValue = function (fValue) {
                this._fValue = fValue;
            };
            FloatInstruction.prototype.toString = function () {
                return this._fValue;
            };
            FloatInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this._fValue.toString();
                if (this._fValue % 1 === 0) {
                    sCode += ".";
                }
                return sCode;
            };
            FloatInstruction.prototype.evaluate = function () {
                this._pLastEvalResult = this._fValue;
                return true;
            };
            FloatInstruction.prototype.isConst = function () {
                return true;
            };
            FloatInstruction.prototype.clone = function (pRelationMap) {
                var pClonedInstruction = (_super.prototype.clone.call(this, pRelationMap));
                pClonedInstruction.setValue(this._fValue);
                return pClonedInstruction;
            };
            return FloatInstruction;
        })(ExprInstruction);
        fx.FloatInstruction = FloatInstruction;        
        var BoolInstruction = (function (_super) {
            __extends(BoolInstruction, _super);
            function BoolInstruction() {
                        _super.call(this);
                this._bValue = true;
                this._pType = fx.getEffectBaseType("bool").getVariableType();
                this._eInstructionType = akra.EAFXInstructionTypes.k_BoolInstruction;
            }
            BoolInstruction._pBoolType = null;
            BoolInstruction.prototype.setValue = function (bValue) {
                this._bValue = bValue;
            };
            BoolInstruction.prototype.toString = function () {
                return this._bValue;
            };
            BoolInstruction.prototype.toFinalCode = function () {
                if (this._bValue) {
                    return "true";
                } else {
                    return "false";
                }
            };
            BoolInstruction.prototype.evaluate = function () {
                this._pLastEvalResult = this._bValue;
                return true;
            };
            BoolInstruction.prototype.isConst = function () {
                return true;
            };
            BoolInstruction.prototype.clone = function (pRelationMap) {
                var pClonedInstruction = (_super.prototype.clone.call(this, pRelationMap));
                pClonedInstruction.setValue(this._bValue);
                return pClonedInstruction;
            };
            return BoolInstruction;
        })(ExprInstruction);
        fx.BoolInstruction = BoolInstruction;        
        var StringInstruction = (function (_super) {
            __extends(StringInstruction, _super);
            function StringInstruction() {
                        _super.call(this);
                this._sValue = "";
                this._pType = fx.getEffectBaseType("string").getVariableType();
                this._eInstructionType = akra.EAFXInstructionTypes.k_StringInstruction;
            }
            StringInstruction._pStringType = null;
            StringInstruction.prototype.setValue = function (sValue) {
                this._sValue = sValue;
            };
            StringInstruction.prototype.toString = function () {
                return this._sValue;
            };
            StringInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this._sValue;
                return sCode;
            };
            StringInstruction.prototype.evaluate = function () {
                this._pLastEvalResult = this._sValue;
                return true;
            };
            StringInstruction.prototype.isConst = function () {
                return true;
            };
            StringInstruction.prototype.clone = function (pRelationMap) {
                var pClonedInstruction = (_super.prototype.clone.call(this, pRelationMap));
                pClonedInstruction.setValue(this._sValue);
                return pClonedInstruction;
            };
            return StringInstruction;
        })(ExprInstruction);
        fx.StringInstruction = StringInstruction;        
        var IdExprInstruction = (function (_super) {
            __extends(IdExprInstruction, _super);
            function IdExprInstruction() {
                        _super.call(this);
                this._pType = null;
                this._bToFinalCode = true;
                this._isInPassUnifoms = false;
                this._isInPassForeigns = false;
                this._pInstructionList = [
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_IdExprInstruction;
            }
            IdExprInstruction.prototype.isVisible = function () {
                return this._pInstructionList[0].isVisible();
            };
            IdExprInstruction.prototype.getType = function () {
                if (!((this._pType) === null)) {
                    return this._pType;
                } else {
                    var pVar = this._pInstructionList[0];
                    this._pType = (pVar.getParent()).getType();
                    return this._pType;
                }
            };
            IdExprInstruction.prototype.isConst = function () {
                return this.getType().isConst();
            };
            IdExprInstruction.prototype.evaluate = function () {
                if (this.getType().isForeign()) {
                    var pVal = this.getType()._getParentVarDecl().getValue();
                    if (!((pVal) === null)) {
                        this._pLastEvalResult = pVal;
                        return true;
                    }
                }
                return false;
            };
            IdExprInstruction.prototype.prepareFor = function (eUsedMode) {
                if (!this.isVisible()) {
                    this._bToFinalCode = false;
                }
                if (eUsedMode === akra.EFunctionType.k_PassFunction) {
                    var pVarDecl = this.getInstructions()[0].getParent();
                    if (!this.getType()._isUnverifiable() && ((pVarDecl.getParent()) === null)) {
                        if (pVarDecl.getType().isForeign()) {
                            this._isInPassForeigns = true;
                        } else {
                            this._isInPassUnifoms = true;
                        }
                    }
                }
            };
            IdExprInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                if (this._bToFinalCode) {
                    if (this._isInPassForeigns) {
                        sCode += "foreigns[\"" + this.getInstructions()[0].toFinalCode() + "\"]";
                    } else if (this._isInPassUnifoms) {
                        sCode += "uniforms[\"" + this.getInstructions()[0].toFinalCode() + "\"]";
                    } else {
                        sCode += this.getInstructions()[0].toFinalCode();
                    }
                }
                return sCode;
            };
            IdExprInstruction.prototype.clone = function (pRelationMap) {
                return _super.prototype.clone.call(this, pRelationMap);
            };
            IdExprInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                if (!this.getType().isFromVariableDecl()) {
                    return;
                }
                var pInfo = null;
                pInfo = pUsedDataCollector[this.getType()._getInstructionID()];
                if (!((pInfo) !== undefined)) {
                    pInfo = {
                        type: this.getType(),
                        isRead: false,
                        isWrite: false,
                        numRead: 0,
                        numWrite: 0,
                        numUsed: 0
                    };
                    pUsedDataCollector[this.getType()._getInstructionID()] = pInfo;
                }
                if (eUsedMode !== akra.EVarUsedMode.k_Write && eUsedMode !== akra.EVarUsedMode.k_Undefined) {
                    pInfo.isRead = true;
                    pInfo.numRead++;
                }
                if (eUsedMode === akra.EVarUsedMode.k_Write || eUsedMode === akra.EVarUsedMode.k_ReadWrite) {
                    pInfo.isWrite = true;
                    pInfo.numWrite++;
                }
                pInfo.numUsed++;
            };
            return IdExprInstruction;
        })(ExprInstruction);
        fx.IdExprInstruction = IdExprInstruction;        
        var ArithmeticExprInstruction = (function (_super) {
            __extends(ArithmeticExprInstruction, _super);
            function ArithmeticExprInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_ArithmeticExprInstruction;
            }
            ArithmeticExprInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                _super.prototype.addUsedData.call(this, pUsedDataCollector, akra.EVarUsedMode.k_Read);
            };
            ArithmeticExprInstruction.prototype.evaluate = function () {
                var pOperands = this.getInstructions();
                var pValL = pOperands[0].evaluate() ? pOperands[0].getEvalValue() : null;
                var pValR = pOperands[1].evaluate() ? pOperands[1].getEvalValue() : null;
                if (((pValL) === null) || ((pValR) === null)) {
                    return false;
                }
                try  {
                    switch(this.getOperator()) {
                        case "+":
                            this._pLastEvalResult = pValL + pValR;
                            break;
                        case "-":
                            this._pLastEvalResult = pValL - pValR;
                            break;
                        case "*":
                            this._pLastEvalResult = pValL * pValR;
                            break;
                        case "/":
                            this._pLastEvalResult = pValL / pValR;
                            break;
                        case "%":
                            this._pLastEvalResult = pValL % pValR;
                            break;
                    }
                    return true;
                } catch (e) {
                    return false;
                }
            };
            ArithmeticExprInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this.getInstructions()[0].toFinalCode();
                sCode += this.getOperator();
                sCode += this.getInstructions()[1].toFinalCode();
                return sCode;
            };
            return ArithmeticExprInstruction;
        })(ExprInstruction);
        fx.ArithmeticExprInstruction = ArithmeticExprInstruction;        
        var AssignmentExprInstruction = (function (_super) {
            __extends(AssignmentExprInstruction, _super);
            function AssignmentExprInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_AssignmentExprInstruction;
            }
            AssignmentExprInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this.getInstructions()[0].toFinalCode();
                sCode += this.getOperator();
                sCode += this.getInstructions()[1].toFinalCode();
                return sCode;
            };
            AssignmentExprInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var sOperator = this.getOperator();
                var pSubExprLeft = this.getInstructions()[0];
                var pSubExprRight = this.getInstructions()[1];
                if (eUsedMode === akra.EVarUsedMode.k_Read || sOperator !== "=") {
                    pSubExprLeft.addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_ReadWrite);
                } else {
                    pSubExprLeft.addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Write);
                }
                pSubExprRight.addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Read);
            };
            return AssignmentExprInstruction;
        })(ExprInstruction);
        fx.AssignmentExprInstruction = AssignmentExprInstruction;        
        var RelationalExprInstruction = (function (_super) {
            __extends(RelationalExprInstruction, _super);
            function RelationalExprInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_RelationalExprInstruction;
            }
            RelationalExprInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this.getInstructions()[0].toFinalCode();
                sCode += this.getOperator();
                sCode += this.getInstructions()[1].toFinalCode();
                return sCode;
            };
            RelationalExprInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                _super.prototype.addUsedData.call(this, pUsedDataCollector, akra.EVarUsedMode.k_Read);
            };
            return RelationalExprInstruction;
        })(ExprInstruction);
        fx.RelationalExprInstruction = RelationalExprInstruction;        
        var LogicalExprInstruction = (function (_super) {
            __extends(LogicalExprInstruction, _super);
            function LogicalExprInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_LogicalExprInstruction;
            }
            LogicalExprInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this.getInstructions()[0].toFinalCode();
                sCode += this.getOperator();
                sCode += this.getInstructions()[1].toFinalCode();
                return sCode;
            };
            LogicalExprInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                _super.prototype.addUsedData.call(this, pUsedDataCollector, akra.EVarUsedMode.k_Read);
            };
            return LogicalExprInstruction;
        })(ExprInstruction);
        fx.LogicalExprInstruction = LogicalExprInstruction;        
        var ConditionalExprInstruction = (function (_super) {
            __extends(ConditionalExprInstruction, _super);
            function ConditionalExprInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null, 
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_ConditionalExprInstruction;
            }
            ConditionalExprInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this.getInstructions()[0].toFinalCode();
                sCode += "?";
                sCode += this.getInstructions()[1].toFinalCode();
                sCode += ":";
                sCode += this.getInstructions()[2].toFinalCode();
                return sCode;
            };
            ConditionalExprInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                _super.prototype.addUsedData.call(this, pUsedDataCollector, akra.EVarUsedMode.k_Read);
            };
            return ConditionalExprInstruction;
        })(ExprInstruction);
        fx.ConditionalExprInstruction = ConditionalExprInstruction;        
        var CastExprInstruction = (function (_super) {
            __extends(CastExprInstruction, _super);
            function CastExprInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_CastExprInstruction;
            }
            CastExprInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this.getInstructions()[0].toFinalCode();
                sCode += "(";
                sCode += this.getInstructions()[1].toFinalCode();
                sCode += ")";
                return sCode;
            };
            CastExprInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pSubExpr = this.getInstructions()[1];
                pSubExpr.addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Read);
            };
            return CastExprInstruction;
        })(ExprInstruction);
        fx.CastExprInstruction = CastExprInstruction;        
        var UnaryExprInstruction = (function (_super) {
            __extends(UnaryExprInstruction, _super);
            function UnaryExprInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_UnaryExprInstruction;
            }
            UnaryExprInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this.getOperator();
                sCode += this.getInstructions()[0].toFinalCode();
                return sCode;
            };
            UnaryExprInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                if (this.getOperator() === "++" || this.getOperator() === "--") {
                    (this.getInstructions()[0]).addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_ReadWrite);
                } else {
                    (this.getInstructions()[0]).addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Read);
                }
            };
            return UnaryExprInstruction;
        })(ExprInstruction);
        fx.UnaryExprInstruction = UnaryExprInstruction;        
        var PostfixIndexInstruction = (function (_super) {
            __extends(PostfixIndexInstruction, _super);
            function PostfixIndexInstruction() {
                        _super.call(this);
                this._pSamplerArrayDecl = null;
                this._pInstructionList = [
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_PostfixIndexInstruction;
            }
            PostfixIndexInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                if (!((this._pSamplerArrayDecl) === null) && this._pSamplerArrayDecl.isDefinedByZero()) {
                    sCode += this.getInstructions()[0].toFinalCode();
                } else {
                    sCode += this.getInstructions()[0].toFinalCode();
                    if (!(this.getInstructions()[0]).getType()._isCollapsed()) {
                        sCode += "[" + this.getInstructions()[1].toFinalCode() + "]";
                    }
                }
                return sCode;
            };
            PostfixIndexInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pSubExpr = this.getInstructions()[0];
                var pIndex = this.getInstructions()[1];
                pSubExpr.addUsedData(pUsedDataCollector, eUsedMode);
                pIndex.addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Read);
                if (pSubExpr.getType().isFromVariableDecl() && pSubExpr.getType().isSampler()) {
                    this._pSamplerArrayDecl = pSubExpr.getType()._getParentVarDecl();
                }
            };
            return PostfixIndexInstruction;
        })(ExprInstruction);
        fx.PostfixIndexInstruction = PostfixIndexInstruction;        
        var PostfixPointInstruction = (function (_super) {
            __extends(PostfixPointInstruction, _super);
            function PostfixPointInstruction() {
                        _super.call(this);
                this._bToFinalFirst = true;
                this._bToFinalSecond = true;
                this._pInstructionList = [
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_PostfixPointInstruction;
            }
            PostfixPointInstruction.prototype.prepareFor = function (eUsedMode) {
                if (!this.getInstructions()[0].isVisible()) {
                    this._bToFinalFirst = false;
                }
                if (!this.getInstructions()[1].isVisible()) {
                    this._bToFinalSecond = false;
                }
                this.getInstructions()[0].prepareFor(eUsedMode);
                this.getInstructions()[1].prepareFor(eUsedMode);
            };
            PostfixPointInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this._bToFinalFirst ? this.getInstructions()[0].toFinalCode() : "";
                sCode += this._bToFinalFirst ? "." : "";
                sCode += this._bToFinalSecond ? this.getInstructions()[1].toFinalCode() : "";
                return sCode;
            };
            PostfixPointInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pSubExpr = this.getInstructions()[0];
                var pPoint = this.getInstructions()[1];
                pSubExpr.addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Undefined);
                pPoint.addUsedData(pUsedDataCollector, eUsedMode);
            };
            return PostfixPointInstruction;
        })(ExprInstruction);
        fx.PostfixPointInstruction = PostfixPointInstruction;        
        var PostfixArithmeticInstruction = (function (_super) {
            __extends(PostfixArithmeticInstruction, _super);
            function PostfixArithmeticInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_PostfixArithmeticInstruction;
            }
            PostfixArithmeticInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this.getInstructions()[0].toFinalCode();
                sCode += this.getOperator();
                return sCode;
            };
            PostfixArithmeticInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pSubExpr = this.getInstructions()[0];
                pSubExpr.addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_ReadWrite);
            };
            return PostfixArithmeticInstruction;
        })(ExprInstruction);
        fx.PostfixArithmeticInstruction = PostfixArithmeticInstruction;        
        var PrimaryExprInstruction = (function (_super) {
            __extends(PrimaryExprInstruction, _super);
            function PrimaryExprInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_PrimaryExprInstruction;
            }
            PrimaryExprInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this.getInstructions()[0].toFinalCode();
                return sCode;
            };
            PrimaryExprInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pPointerType = this.getType();
                var pInfo = pUsedDataCollector[pPointerType._getInstructionID()];
                if (!((pInfo) !== undefined)) {
                    pInfo = {
                        type: pPointerType,
                        isRead: false,
                        isWrite: false,
                        numRead: 0,
                        numWrite: 0,
                        numUsed: 0
                    };
                    pUsedDataCollector[pPointerType._getInstructionID()] = pInfo;
                }
                if (eUsedMode === akra.EVarUsedMode.k_Read) {
                    pInfo.isRead = true;
                    pInfo.numRead++;
                } else if (eUsedMode === akra.EVarUsedMode.k_Write) {
                    pInfo.isWrite = true;
                    pInfo.numWrite++;
                } else if (eUsedMode === akra.EVarUsedMode.k_ReadWrite) {
                    pInfo.isRead = true;
                    pInfo.isWrite = true;
                    pInfo.numRead++;
                    pInfo.numWrite++;
                }
                pInfo.numUsed++;
            };
            return PrimaryExprInstruction;
        })(ExprInstruction);
        fx.PrimaryExprInstruction = PrimaryExprInstruction;        
        var ComplexExprInstruction = (function (_super) {
            __extends(ComplexExprInstruction, _super);
            function ComplexExprInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_ComplexExprInstruction;
            }
            ComplexExprInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += "(" + this.getInstructions()[0].toFinalCode() + ")";
                return sCode;
            };
            return ComplexExprInstruction;
        })(ExprInstruction);
        fx.ComplexExprInstruction = ComplexExprInstruction;        
        var FunctionCallInstruction = (function (_super) {
            __extends(FunctionCallInstruction, _super);
            function FunctionCallInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_FunctionCallInstruction;
            }
            FunctionCallInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this.getInstructions()[0].toFinalCode();
                sCode += "(";
                for(var i = 1; i < this._nInstructions; i++) {
                    sCode += this.getInstructions()[i].toFinalCode();
                    if (i !== this._nInstructions - 1) {
                        sCode += ",";
                    }
                }
                sCode += ")";
                return sCode;
            };
            FunctionCallInstruction.prototype.getFunction = function () {
                return (this._pInstructionList[0]).getType().getParent().getParent();
            };
            FunctionCallInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pExprList = this.getInstructions();
                var pFunction = this.getFunction();
                var pArguments = pFunction.getArguments();
                pExprList[0].addUsedData(pUsedDataCollector, eUsedMode);
                for(var i = 0; i < pArguments.length; i++) {
                    if (pArguments[i].getType().hasUsage("out")) {
                        pExprList[i + 1].addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Write);
                    } else if (pArguments[i].getType().hasUsage("inout")) {
                        pExprList[i + 1].addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_ReadWrite);
                    } else {
                        pExprList[i + 1].addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Read);
                    }
                }
            };
            return FunctionCallInstruction;
        })(ExprInstruction);
        fx.FunctionCallInstruction = FunctionCallInstruction;        
        var SystemCallInstruction = (function (_super) {
            __extends(SystemCallInstruction, _super);
            function SystemCallInstruction() {
                        _super.call(this);
                this._pSystemFunction = null;
                this._pSamplerDecl = null;
                this._pInstructionList = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_SystemCallInstruction;
            }
            SystemCallInstruction.prototype.toFinalCode = function () {
                if (!((this._pSamplerDecl) === null) && this._pSamplerDecl.isDefinedByZero()) {
                    return "vec4(0.)";
                }
                var sCode = "";
                for(var i = 0; i < this.getInstructions().length; i++) {
                    sCode += this.getInstructions()[i].toFinalCode();
                }
                return sCode;
            };
            SystemCallInstruction.prototype.setSystemCallFunction = function (pFunction) {
                this._pSystemFunction = pFunction;
                this.setType(pFunction.getType());
            };
            SystemCallInstruction.prototype.setInstructions = function (pInstructionList) {
                this._pInstructionList = pInstructionList;
                this._nInstructions = pInstructionList.length;
                for(var i = 0; i < pInstructionList.length; i++) {
                    pInstructionList[i].setParent(this);
                }
            };
            SystemCallInstruction.prototype.fillByArguments = function (pArguments) {
                this.setInstructions(this._pSystemFunction.closeArguments(pArguments));
            };
            SystemCallInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pInstructionList = this.getInstructions();
                for(var i = 0; i < this._nInstructions; i++) {
                    if (pInstructionList[i]._getInstructionType() !== akra.EAFXInstructionTypes.k_SimpleInstruction) {
                        pInstructionList[i].addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Read);
                        if ((pInstructionList[i]).getType().isSampler()) {
                            this._pSamplerDecl = (pInstructionList[i]).getType()._getParentVarDecl();
                        }
                    }
                }
            };
            SystemCallInstruction.prototype.clone = function (pRelationMap) {
                var pClone = _super.prototype.clone.call(this, pRelationMap);
                pClone.setSystemCallFunction(this._pSystemFunction);
                return pClone;
            };
            return SystemCallInstruction;
        })(ExprInstruction);
        fx.SystemCallInstruction = SystemCallInstruction;        
        var ConstructorCallInstruction = (function (_super) {
            __extends(ConstructorCallInstruction, _super);
            function ConstructorCallInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_ConstructorCallInstruction;
            }
            ConstructorCallInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this.getInstructions()[0].toFinalCode();
                sCode += "(";
                for(var i = 1; i < this._nInstructions; i++) {
                    sCode += this.getInstructions()[i].toFinalCode();
                    if (i !== this._nInstructions - 1) {
                        sCode += ",";
                    }
                }
                sCode += ")";
                return sCode;
            };
            ConstructorCallInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pInstructionList = this.getInstructions();
                for(var i = 1; i < this._nInstructions; i++) {
                    pInstructionList[i].addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Read);
                }
            };
            return ConstructorCallInstruction;
        })(ExprInstruction);
        fx.ConstructorCallInstruction = ConstructorCallInstruction;        
        var CompileExprInstruction = (function (_super) {
            __extends(CompileExprInstruction, _super);
            function CompileExprInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_CompileExprInstruction;
            }
            CompileExprInstruction.prototype.getFunction = function () {
                return this._pInstructionList[0].getParent().getParent();
            };
            return CompileExprInstruction;
        })(ExprInstruction);
        fx.CompileExprInstruction = CompileExprInstruction;        
        var MemExprInstruction = (function (_super) {
            __extends(MemExprInstruction, _super);
            function MemExprInstruction() {
                        _super.call(this);
                this._pBuffer = null;
                this._pInstructionList = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_MemExprInstruction;
            }
            MemExprInstruction.prototype.getBuffer = function () {
                return this._pBuffer;
            };
            MemExprInstruction.prototype.setBuffer = function (pBuffer) {
                this._pBuffer = pBuffer;
                this.setType(pBuffer.getType());
            };
            MemExprInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pBufferType = this.getBuffer().getType();
                var pInfo = pUsedDataCollector[pBufferType._getInstructionID()];
                if (!((pInfo) !== undefined)) {
                    pInfo = {
                        type: pBufferType,
                        isRead: false,
                        isWrite: false,
                        numRead: 0,
                        numWrite: 0,
                        numUsed: 0
                    };
                    pUsedDataCollector[pBufferType._getInstructionID()] = pInfo;
                }
                if (eUsedMode !== akra.EVarUsedMode.k_Undefined) {
                    pInfo.isRead = true;
                    pInfo.numRead++;
                }
                pInfo.numUsed++;
            };
            return MemExprInstruction;
        })(ExprInstruction);
        fx.MemExprInstruction = MemExprInstruction;        
        var InitExprInstruction = (function (_super) {
            __extends(InitExprInstruction, _super);
            function InitExprInstruction() {
                        _super.call(this);
                this._pConstructorType = null;
                this._pInstructionList = [];
                this._eInstructionType = akra.EAFXInstructionTypes.k_InitExprInstruction;
            }
            InitExprInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                if (!((this._pConstructorType) === null)) {
                    sCode += this._pConstructorType.toFinalCode();
                }
                sCode += "(";
                for(var i = 0; i < this._nInstructions; i++) {
                    sCode += this.getInstructions()[i].toFinalCode();
                    if (i !== this._nInstructions - 1) {
                        sCode += ",";
                    }
                }
                sCode += ")";
                return sCode;
            };
            InitExprInstruction.prototype.optimizeForVariableType = function (pType) {
                if ((pType.isNotBaseArray() && pType._getScope() === 0) || (pType.isArray() && this._nInstructions > 1)) {
                    if (pType.getLength() === 0xffffff || this._nInstructions !== pType.getLength()) {
                        return false;
                    }
                    var pArrayElementType = pType.getArrayElementType();
                    var pTestedInstruction = null;
                    var isOk = false;
                    for(var i = 0; i < this._nInstructions; i++) {
                        pTestedInstruction = (this.getInstructions()[i]);
                        if (pTestedInstruction._getInstructionType() === akra.EAFXInstructionTypes.k_InitExprInstruction) {
                            isOk = (pTestedInstruction).optimizeForVariableType(pArrayElementType);
                            if (!isOk) {
                                return false;
                            }
                        } else {
                            if (fx.isSamplerType(pArrayElementType)) {
                                if (pTestedInstruction._getInstructionType() !== akra.EAFXInstructionTypes.k_SamplerStateBlockInstruction) {
                                    return false;
                                }
                            } else {
                                isOk = pTestedInstruction.getType().isEqual(pArrayElementType);
                                if (!isOk) {
                                    return false;
                                }
                            }
                        }
                    }
                    this._pConstructorType = pType.getBaseType();
                    return true;
                } else {
                    var pFirstInstruction = this.getInstructions()[0];
                    if (this._nInstructions === 1 && pFirstInstruction._getInstructionType() !== akra.EAFXInstructionTypes.k_InitExprInstruction) {
                        if (fx.isSamplerType(pType)) {
                            if (pFirstInstruction._getInstructionType() === akra.EAFXInstructionTypes.k_SamplerStateBlockInstruction) {
                                return true;
                            } else {
                                return false;
                            }
                        }
                        if (pFirstInstruction.getType().isEqual(pType)) {
                            return true;
                        } else {
                            return false;
                        }
                    }
                    var pInstructionList = this.getInstructions();
                    var pFieldNameList = pType.getFieldNameList();
                    for(var i = 0; i < pInstructionList.length; i++) {
                        var pFieldType = pType.getFieldType(pFieldNameList[i]);
                        if (pInstructionList[i].optimizeForVariableType(pFieldType)) {
                            ;
                        }
                    }
                    this._pConstructorType = pType.getBaseType();
                    return true;
                }
            };
            return InitExprInstruction;
        })(ExprInstruction);
        fx.InitExprInstruction = InitExprInstruction;        
        var SamplerStateBlockInstruction = (function (_super) {
            __extends(SamplerStateBlockInstruction, _super);
            function SamplerStateBlockInstruction() {
                        _super.call(this);
                this._pTexture = null;
                this._pSamplerParams = null;
                this._pInstructionList = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_SamplerStateBlockInstruction;
            }
            SamplerStateBlockInstruction.prototype.addState = function (sStateType, sStateValue) {
                if (((this._pSamplerParams) === null)) {
                    this._pSamplerParams = {};
                }
                this._pSamplerParams[sStateType] = sStateValue;
                return;
            };
            SamplerStateBlockInstruction.prototype.setTexture = function (pTexture) {
                this._pTexture = pTexture;
            };
            SamplerStateBlockInstruction.prototype.getTexture = function () {
                return this._pTexture;
            };
            return SamplerStateBlockInstruction;
        })(ExprInstruction);
        fx.SamplerStateBlockInstruction = SamplerStateBlockInstruction;        
        var ExtractExprInstruction = (function (_super) {
            __extends(ExtractExprInstruction, _super);
            function ExtractExprInstruction() {
                        _super.call(this);
                this._eExtractExprType = 0;
                this._pPointer = null;
                this._pBuffer = null;
                this._pOffsetVar = null;
                this._sPaddingExpr = "";
                this._sExtractFunction = "";
                this._bNeedSecondBracket = false;
                this._pInstructionList = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_ExtractExprInstruction;
            }
            ExtractExprInstruction.prototype.getExtractFunction = function () {
                var pFunction = null;
                switch(this._eExtractExprType) {
                    case akra.EExtractExprType.k_Header:
                        pFunction = fx.Effect.findSystemFunction("extractHeader", null);
                        break;
                    case akra.EExtractExprType.k_Float:
                    case akra.EExtractExprType.k_Int:
                    case akra.EExtractExprType.k_Bool:
                        pFunction = fx.Effect.findSystemFunction("extractFloat", null);
                        break;
                    case akra.EExtractExprType.k_Float2:
                    case akra.EExtractExprType.k_Int2:
                    case akra.EExtractExprType.k_Bool2:
                        pFunction = fx.Effect.findSystemFunction("extractFloat2", null);
                        break;
                    case akra.EExtractExprType.k_Float3:
                    case akra.EExtractExprType.k_Int3:
                    case akra.EExtractExprType.k_Bool3:
                        pFunction = fx.Effect.findSystemFunction("extractFloat3", null);
                        break;
                    case akra.EExtractExprType.k_Float4:
                    case akra.EExtractExprType.k_Int4:
                    case akra.EExtractExprType.k_Bool4:
                        pFunction = fx.Effect.findSystemFunction("extractFloat4", null);
                        break;
                    case akra.EExtractExprType.k_Float4x4:
                        pFunction = fx.Effect.findSystemFunction("extractFloat4x4", null);
                        break;
                }
                return pFunction;
            };
            ExtractExprInstruction.prototype.initExtractExpr = function (pExtractType, pPointer, pBuffer, sPaddingExpr, pOffsetVar) {
                this._pPointer = pPointer;
                this._pBuffer = pBuffer;
                this._sPaddingExpr = sPaddingExpr;
                this._pOffsetVar = pOffsetVar;
                this.setType(pExtractType);
                if (pExtractType.isEqual(fx.Effect.getSystemType("float"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Float;
                    this._sExtractFunction += "A_extractFloat(";
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("ptr"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Float;
                    this._sExtractFunction += "A_extractFloat(";
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("video_buffer_header"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Header;
                    this._sExtractFunction += "A_extractTextureHeader(";
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("bool"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Bool;
                    this._sExtractFunction += "bool(A_extractFloat(";
                    this._bNeedSecondBracket = true;
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("int"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Int;
                    this._sExtractFunction += ("int(A_extractFloat(");
                    this._bNeedSecondBracket = true;
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("float2"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Float2;
                    this._sExtractFunction += ("A_extractVec2(");
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("float3"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Float3;
                    this._sExtractFunction += ("A_extractVec3(");
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("float4"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Float4;
                    this._sExtractFunction += ("A_extractVec4(");
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("int2"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Int2;
                    this._sExtractFunction += ("ivec2(A_extractVec2(");
                    this._bNeedSecondBracket = true;
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("int3"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Int3;
                    this._sExtractFunction += ("ivec3(A_extractVec3(");
                    this._bNeedSecondBracket = true;
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("int4"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Int4;
                    this._sExtractFunction += ("ivec4(A_extractVec4(");
                    this._bNeedSecondBracket = true;
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("bool2"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Bool2;
                    this._sExtractFunction += ("bvec2(A_extractVec2(");
                    this._bNeedSecondBracket = true;
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("bool3"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Bool3;
                    this._sExtractFunction += ("bvec3(A_extractVec3(");
                    this._bNeedSecondBracket = true;
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("bool4"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Bool4;
                    this._sExtractFunction += ("bvec4(A_extractVec4(");
                    this._bNeedSecondBracket = true;
                } else if (pExtractType.isEqual(fx.Effect.getSystemType("float4x4"))) {
                    this._eExtractExprType = akra.EExtractExprType.k_Float4x4;
                    this._sExtractFunction += ("A_extractMat4(");
                } else {
                    this.setError(2273, {
                        typeName: pExtractType.getHash()
                    });
                }
            };
            ExtractExprInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pPointerType = this._pPointer.getType();
                var pBufferType = this._pBuffer.getType();
                var pInfo = pUsedDataCollector[pPointerType._getInstructionID()];
                if (!((pInfo) !== undefined)) {
                    pInfo = {
                        type: pPointerType,
                        isRead: false,
                        isWrite: false,
                        numRead: 0,
                        numWrite: 0,
                        numUsed: 0
                    };
                    pUsedDataCollector[pPointerType._getInstructionID()] = pInfo;
                }
                pInfo.isRead = true;
                pInfo.numRead++;
                pInfo.numUsed++;
                pInfo = pUsedDataCollector[pBufferType._getInstructionID()];
                if (!((pInfo) !== undefined)) {
                    pInfo = {
                        type: pBufferType,
                        isRead: false,
                        isWrite: false,
                        numRead: 0,
                        numWrite: 0,
                        numUsed: 0
                    };
                    pUsedDataCollector[pBufferType._getInstructionID()] = pInfo;
                }
                pInfo.isRead = true;
                pInfo.numRead++;
                pInfo.numUsed++;
            };
            ExtractExprInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                if (this._pBuffer.isDefinedByZero()) {
                    switch(this._eExtractExprType) {
                        case akra.EExtractExprType.k_Header:
                            sCode = "A_TextureHeader(0.,0.,0.,0.)";
                            break;
                        case akra.EExtractExprType.k_Float:
                            sCode = "0.";
                            break;
                        case akra.EExtractExprType.k_Int:
                            sCode = "0";
                            break;
                        case akra.EExtractExprType.k_Bool:
                            sCode = "false";
                            break;
                        case akra.EExtractExprType.k_Float2:
                            sCode = "vec2(0.)";
                            break;
                        case akra.EExtractExprType.k_Int2:
                            sCode = "ivec2(0)";
                            break;
                        case akra.EExtractExprType.k_Bool2:
                            sCode = "bvec2(false)";
                            break;
                        case akra.EExtractExprType.k_Float3:
                            sCode = "vec3(0.)";
                            break;
                        case akra.EExtractExprType.k_Int3:
                            sCode = "ivec3(0)";
                            break;
                        case akra.EExtractExprType.k_Bool3:
                            sCode = "bvec3(false)";
                            break;
                        case akra.EExtractExprType.k_Float4:
                            sCode = "vec4(0.)";
                            break;
                        case akra.EExtractExprType.k_Int4:
                            sCode = "ivec4(0)";
                            break;
                        case akra.EExtractExprType.k_Bool4:
                            sCode = "bvec4(false)";
                            break;
                        case akra.EExtractExprType.k_Float4x4:
                            sCode = "mat4(0.)";
                            break;
                    }
                } else {
                    sCode = this._sExtractFunction;
                    sCode += this._pBuffer._getVideoBufferSampler().getNameId().toFinalCode();
                    sCode += "," + this._pBuffer._getVideoBufferHeader().getNameId().toFinalCode();
                    if (this._eExtractExprType !== akra.EExtractExprType.k_Header) {
                        sCode += "," + this._pPointer.getNameId().toFinalCode() + this._sPaddingExpr;
                        if (!((this._pOffsetVar) === null)) {
                            sCode += "+" + this._pOffsetVar.getNameId().toFinalCode();
                        }
                    }
                    sCode += ")";
                    if (this._bNeedSecondBracket) {
                        sCode += ")";
                    }
                }
                return sCode;
            };
            ExtractExprInstruction.prototype.clone = function (pRelationMap) {
                var pClone = _super.prototype.clone.call(this, pRelationMap);
                pClone._setCloneParams(this._pPointer.clone(pRelationMap), this._pBuffer, this._eExtractExprType, this._sPaddingExpr, this._sExtractFunction, this._bNeedSecondBracket);
                return pClone;
            };
            ExtractExprInstruction.prototype._setCloneParams = function (pPointer, pBuffer, eExtractExprType, sPaddingExpr, sExtractFunction, bNeedSecondBracket) {
                this._pPointer = pPointer;
                this._pBuffer = pBuffer;
                this._eExtractExprType = eExtractExprType;
                this._sPaddingExpr = sPaddingExpr;
                this._sExtractFunction = sExtractFunction;
                this._bNeedSecondBracket = bNeedSecondBracket;
            };
            return ExtractExprInstruction;
        })(ExprInstruction);
        fx.ExtractExprInstruction = ExtractExprInstruction;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var VariableDeclInstruction = (function (_super) {
            __extends(VariableDeclInstruction, _super);
            function VariableDeclInstruction() {
                        _super.call(this);
                this._isVideoBuffer = null;
                this._pVideoBufferSampler = null;
                this._pVideoBufferHeader = null;
                this._pFullNameExpr = null;
                this._bDefineByZero = false;
                this._pSubDeclList = null;
                this._bShaderOutput = false;
                this._pAttrOffset = null;
                this._pAttrExtractionBlock = null;
                this._pValue = null;
                this._bLockInitializer = false;
                this._pInstructionList = [
                    null, 
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_VariableDeclInstruction;
            }
            VariableDeclInstruction.prototype.hasInitializer = function () {
                return this._nInstructions === 3 && !((this.getInitializeExpr()) === null);
            };
            VariableDeclInstruction.prototype.getInitializeExpr = function () {
                return this.getInstructions()[2];
            };
            VariableDeclInstruction.prototype.lockInitializer = function () {
                this._bLockInitializer = true;
            };
            VariableDeclInstruction.prototype.unlockInitializer = function () {
                this._bLockInitializer = false;
            };
            VariableDeclInstruction.prototype.getDefaultValue = function () {
                return null;
            };
            VariableDeclInstruction.prototype.getValue = function () {
                return this._pValue;
            };
            VariableDeclInstruction.prototype.setValue = function (pValue) {
                this._pValue = pValue;
                if (this.getType().isForeign()) {
                    this.setRealName(pValue);
                }
            };
            VariableDeclInstruction.prototype.getType = function () {
                return this._pInstructionList[0];
            };
            VariableDeclInstruction.prototype.setType = function (pType) {
                this._pInstructionList[0] = pType;
                pType.setParent(this);
                if (this._nInstructions === 0) {
                    this._nInstructions = 1;
                }
            };
            VariableDeclInstruction.prototype.setName = function (sName) {
                var pName = new fx.IdInstruction();
                pName.setName(sName);
                pName.setParent(this);
                this._pInstructionList[1] = pName;
                if (this._nInstructions < 2) {
                    this._nInstructions = 2;
                }
            };
            VariableDeclInstruction.prototype.setRealName = function (sRealName) {
                this.getNameId().setRealName(sRealName);
            };
            VariableDeclInstruction.prototype.setVideoBufferRealName = function (sSampler, sHeader) {
                if (!this.isVideoBuffer()) {
                    return;
                }
                this._getVideoBufferSampler().setRealName(sSampler);
                this._getVideoBufferHeader().setRealName(sHeader);
            };
            VariableDeclInstruction.prototype.getName = function () {
                return (this._pInstructionList[1]).getName();
            };
            VariableDeclInstruction.prototype.getRealName = function () {
                return (this._pInstructionList[1]).getRealName();
            };
            VariableDeclInstruction.prototype.getNameId = function () {
                return this._pInstructionList[1];
            };
            VariableDeclInstruction.prototype.isUniform = function () {
                return this.getType().hasUsage("uniform");
            };
            VariableDeclInstruction.prototype.isField = function () {
                if (((this.getParent()) === null)) {
                    return false;
                }
                var eParentType = this.getParent()._getInstructionType();
                if (eParentType === akra.EAFXInstructionTypes.k_VariableTypeInstruction || eParentType === akra.EAFXInstructionTypes.k_ComplexTypeInstruction || eParentType === akra.EAFXInstructionTypes.k_SystemTypeInstruction) {
                    return true;
                }
                return false;
            };
            VariableDeclInstruction.prototype.isPointer = function () {
                return this.getType().isPointer();
            };
            VariableDeclInstruction.prototype.isVideoBuffer = function () {
                if (((this._isVideoBuffer) === null)) {
                    this._isVideoBuffer = this.getType().isStrongEqual(fx.getEffectBaseType("video_buffer"));
                }
                return this._isVideoBuffer;
            };
            VariableDeclInstruction.prototype.isSampler = function () {
                return this.getType().isSampler();
            };
            VariableDeclInstruction.prototype.getSubVarDecls = function () {
                return this.getType().getSubVarDecls();
            };
            VariableDeclInstruction.prototype.isDefinedByZero = function () {
                return this._bDefineByZero;
            };
            VariableDeclInstruction.prototype.defineByZero = function (isDefine) {
                this._bDefineByZero = isDefine;
            };
            VariableDeclInstruction.prototype.toFinalCode = function () {
                if (this._isShaderOutput()) {
                    return "";
                }
                var sCode = "";
                if (this.isVideoBuffer()) {
                    this._getVideoBufferHeader().lockInitializer();
                    sCode = this._getVideoBufferHeader().toFinalCode();
                    sCode += ";\n";
                    sCode += this._getVideoBufferSampler().toFinalCode();
                    this._getVideoBufferHeader().unlockInitializer();
                } else {
                    sCode = this.getType().toFinalCode();
                    sCode += " " + this.getNameId().toFinalCode();
                    if (this.getType().isNotBaseArray()) {
                        var iLength = this.getType().getLength();
                        if (akra.webgl.isANGLE && iLength === 1 && this.getType().isComplex()) {
                            sCode += "[" + 2 + "]";
                        } else {
                            sCode += "[" + iLength + "]";
                        }
                    }
                    if (this.hasInitializer() && !this.isSampler() && !this.isUniform() && !this._bLockInitializer) {
                        sCode += "=" + this.getInitializeExpr().toFinalCode();
                    }
                }
                return sCode;
            };
            VariableDeclInstruction.prototype._markAsVarying = function (bValue) {
                this.getNameId()._markAsVarying(bValue);
            };
            VariableDeclInstruction.prototype._markAsShaderOutput = function (isShaderOutput) {
                this._bShaderOutput = isShaderOutput;
            };
            VariableDeclInstruction.prototype._isShaderOutput = function () {
                return this._bShaderOutput;
            };
            VariableDeclInstruction.prototype._setAttrExtractionBlock = function (pCodeBlock) {
                this._pAttrExtractionBlock = pCodeBlock;
            };
            VariableDeclInstruction.prototype._getAttrExtractionBlock = function () {
                return this._pAttrExtractionBlock;
            };
            VariableDeclInstruction.prototype._getFullNameExpr = function () {
                if (!((this._pFullNameExpr) === null)) {
                    return this._pFullNameExpr;
                }
                if (!this.isField() || !(this.getParent())._getParentVarDecl().isVisible()) {
                    this._pFullNameExpr = new fx.IdExprInstruction();
                    this._pFullNameExpr.push(this.getNameId(), false);
                } else {
                    var pMainVar = this.getType()._getParentContainer();
                    if (((pMainVar) === null)) {
                        return null;
                    }
                    var pMainExpr = pMainVar._getFullNameExpr();
                    if (((pMainExpr) === null)) {
                        return null;
                    }
                    var pFieldExpr = new fx.IdExprInstruction();
                    pFieldExpr.push(this.getNameId(), false);
                    this._pFullNameExpr = new fx.PostfixPointInstruction();
                    this._pFullNameExpr.push(pMainExpr, false);
                    this._pFullNameExpr.push(pFieldExpr, false);
                    this._pFullNameExpr.setType(this.getType());
                }
                return this._pFullNameExpr;
            };
            VariableDeclInstruction.prototype._getFullName = function () {
                if (this.isField() && (this.getParent())._getParentVarDecl().isVisible()) {
                    var sName = "";
                    var eParentType = this.getParent()._getInstructionType();
                    if (eParentType === akra.EAFXInstructionTypes.k_VariableTypeInstruction) {
                        sName = (this.getParent())._getFullName();
                    }
                    sName += "." + this.getName();
                    return sName;
                } else {
                    return this.getName();
                }
            };
            VariableDeclInstruction.prototype._getVideoBufferSampler = function () {
                if (!this.isVideoBuffer()) {
                    return null;
                }
                if (((this._pVideoBufferSampler) === null)) {
                    this._pVideoBufferSampler = new VariableDeclInstruction();
                    var pType = new fx.VariableTypeInstruction();
                    var pId = new fx.IdInstruction();
                    pType.pushType(fx.getEffectBaseType("sampler2D"));
                    pType.addUsage("uniform");
                    pId.setName(this.getName() + "_sampler");
                    this._pVideoBufferSampler.push(pType, true);
                    this._pVideoBufferSampler.push(pId, true);
                }
                return this._pVideoBufferSampler;
            };
            VariableDeclInstruction.prototype._getVideoBufferHeader = function () {
                if (!this.isVideoBuffer()) {
                    return null;
                }
                if (((this._pVideoBufferHeader) === null)) {
                    this._pVideoBufferHeader = new VariableDeclInstruction();
                    var pType = new fx.VariableTypeInstruction();
                    var pId = new fx.IdInstruction();
                    var pExtarctExpr = new fx.ExtractExprInstruction();
                    pType.pushType(fx.getEffectBaseType("video_buffer_header"));
                    pId.setName(this.getName() + "_header");
                    this._pVideoBufferHeader.push(pType, true);
                    this._pVideoBufferHeader.push(pId, true);
                    this._pVideoBufferHeader.push(pExtarctExpr, true);
                    pExtarctExpr.initExtractExpr(pType, null, this, "", null);
                }
                return this._pVideoBufferHeader;
            };
            VariableDeclInstruction.prototype._getVideoBufferInitExpr = function () {
                if (!this.isVideoBuffer()) {
                    return null;
                }
                return this._getVideoBufferHeader().getInitializeExpr();
            };
            VariableDeclInstruction.prototype._setCollapsed = function (bValue) {
                this.getType()._setCollapsed(bValue);
            };
            VariableDeclInstruction.prototype._isCollapsed = function () {
                return this.getType()._isCollapsed();
            };
            VariableDeclInstruction.prototype.clone = function (pRelationMap) {
                return _super.prototype.clone.call(this, pRelationMap);
            };
            VariableDeclInstruction.prototype.blend = function (pVariableDecl, eMode) {
                var pBlendType = this.getType().blend(pVariableDecl.getType(), eMode);
                if (((pBlendType) === null)) {
                    return null;
                }
                var pBlendVar = new VariableDeclInstruction();
                var pId = new fx.IdInstruction();
                pId.setName(this.getNameId().getName());
                pId.setRealName(this.getNameId().getRealName());
                pBlendVar.setSemantic(this.getSemantic());
                pBlendVar.push(pBlendType, true);
                pBlendVar.push(pId, true);
                return pBlendVar;
            };
            return VariableDeclInstruction;
        })(fx.DeclInstruction);
        fx.VariableDeclInstruction = VariableDeclInstruction;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var StmtInstruction = (function (_super) {
            __extends(StmtInstruction, _super);
            function StmtInstruction() {
                        _super.call(this);
                this._eInstructionType = akra.EAFXInstructionTypes.k_StmtInstruction;
            }
            StmtInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pInstructionList = this.getInstructions();
                if (!((pUsedDataCollector) === null)) {
                    for(var i = 0; i < this._nInstructions; i++) {
                        pInstructionList[i].addUsedData(pUsedDataCollector, eUsedMode);
                    }
                }
            };
            return StmtInstruction;
        })(fx.Instruction);
        fx.StmtInstruction = StmtInstruction;        
        var StmtBlockInstruction = (function (_super) {
            __extends(StmtBlockInstruction, _super);
            function StmtBlockInstruction() {
                        _super.call(this);
                this._pInstructionList = [];
                this._eInstructionType = akra.EAFXInstructionTypes.k_StmtBlockInstruction;
            }
            StmtBlockInstruction.prototype.toFinalCode = function () {
                var sCode = "{" + "\n";
                for(var i = 0; i < this._nInstructions; i++) {
                    sCode += "\t" + this._pInstructionList[i].toFinalCode() + "\n";
                }
                sCode += "}";
                return sCode;
            };
            return StmtBlockInstruction;
        })(StmtInstruction);
        fx.StmtBlockInstruction = StmtBlockInstruction;        
        var ExprStmtInstruction = (function (_super) {
            __extends(ExprStmtInstruction, _super);
            function ExprStmtInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_ExprStmtInstruction;
            }
            ExprStmtInstruction.prototype.toFinalCode = function () {
                return this.getInstructions()[0].toFinalCode() + ";";
            };
            return ExprStmtInstruction;
        })(StmtInstruction);
        fx.ExprStmtInstruction = ExprStmtInstruction;        
        var BreakStmtInstruction = (function (_super) {
            __extends(BreakStmtInstruction, _super);
            function BreakStmtInstruction() {
                        _super.call(this);
                this._pInstructionList = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_BreakStmtInstruction;
            }
            BreakStmtInstruction.prototype.toFinalCode = function () {
                return this.getOperator() + ";";
            };
            return BreakStmtInstruction;
        })(StmtInstruction);
        fx.BreakStmtInstruction = BreakStmtInstruction;        
        var WhileStmtInstruction = (function (_super) {
            __extends(WhileStmtInstruction, _super);
            function WhileStmtInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_WhileStmtInstruction;
            }
            WhileStmtInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                if (this.getOperator() === "while") {
                    sCode += "while(";
                    sCode += this.getInstructions()[0].toFinalCode();
                    sCode += ")";
                    sCode += this.getInstructions()[1].toFinalCode();
                } else {
                    sCode += "do";
                    sCode += this.getInstructions()[1].toFinalCode();
                    sCode += "while(";
                    sCode += this.getInstructions()[0].toFinalCode();
                    sCode += ");";
                }
                return sCode;
            };
            return WhileStmtInstruction;
        })(StmtInstruction);
        fx.WhileStmtInstruction = WhileStmtInstruction;        
        var ForStmtInstruction = (function (_super) {
            __extends(ForStmtInstruction, _super);
            function ForStmtInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null, 
                    null, 
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_ForStmtInstruction;
            }
            ForStmtInstruction.prototype.toFinalCode = function () {
                var sCode = "for(";
                sCode += this.getInstructions()[0].toFinalCode() + ";";
                sCode += this.getInstructions()[1].toFinalCode() + ";";
                sCode += this.getInstructions()[2].toFinalCode() + ")";
                sCode += this.getInstructions()[3].toFinalCode();
                return sCode;
            };
            ForStmtInstruction.prototype.check = function (eStage, pInfo) {
                if (typeof pInfo === "undefined") { pInfo = null; }
                var pInstructionList = this.getInstructions();
                if (this._nInstructions !== 4) {
                    this.setError(2239);
                    return false;
                }
                if (((pInstructionList[0]) === null)) {
                    this.setError(2232);
                    return false;
                }
                if (pInstructionList[0]._getInstructionType() !== akra.EAFXInstructionTypes.k_VariableDeclInstruction) {
                    this.setError(2231);
                    return false;
                }
                if (((pInstructionList[1]) === null)) {
                    this.setError(2233);
                    return false;
                }
                if (pInstructionList[1]._getInstructionType() !== akra.EAFXInstructionTypes.k_RelationalExprInstruction) {
                    this.setError(2238);
                    return false;
                }
                if (pInstructionList[2]._getInstructionType() === akra.EAFXInstructionTypes.k_UnaryExprInstruction || pInstructionList[2]._getInstructionType() === akra.EAFXInstructionTypes.k_AssignmentExprInstruction || pInstructionList[2]._getInstructionType() === akra.EAFXInstructionTypes.k_PostfixArithmeticInstruction) {
                    var sOperator = pInstructionList[2].getOperator();
                    if (sOperator !== "++" && sOperator !== "--" && sOperator !== "+=" && sOperator !== "-=") {
                        this.setError(2240, {
                            operator: sOperator
                        });
                        return false;
                    }
                } else {
                    this.setError(2241);
                    return false;
                }
                return true;
            };
            ForStmtInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                var pForInit = this.getInstructions()[0];
                var pForCondition = this.getInstructions()[1];
                var pForStep = this.getInstructions()[2];
                var pForStmt = this.getInstructions()[3];
                var pIteratorType = pForInit.getType();
                pUsedDataCollector[pIteratorType._getInstructionID()] = {
                    type: pIteratorType,
                    isRead: false,
                    isWrite: true,
                    numRead: 0,
                    numWrite: 1,
                    numUsed: 1
                };
                pForCondition.addUsedData(pUsedDataCollector, eUsedMode);
                pForStep.addUsedData(pUsedDataCollector, eUsedMode);
                pForStmt.addUsedData(pUsedDataCollector, eUsedMode);
            };
            return ForStmtInstruction;
        })(StmtInstruction);
        fx.ForStmtInstruction = ForStmtInstruction;        
        var IfStmtInstruction = (function (_super) {
            __extends(IfStmtInstruction, _super);
            function IfStmtInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null, 
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_IfStmtInstruction;
            }
            IfStmtInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                if (this.getOperator() === "if") {
                    sCode += "if(";
                    sCode += this.getInstructions()[0].toFinalCode() + ")";
                    sCode += this.getInstructions()[1].toFinalCode();
                } else {
                    sCode += "if(";
                    sCode += this.getInstructions()[0].toFinalCode() + ") ";
                    sCode += this.getInstructions()[1].toFinalCode();
                    sCode += "else ";
                    sCode += this.getInstructions()[2].toFinalCode();
                }
                return sCode;
            };
            return IfStmtInstruction;
        })(StmtInstruction);
        fx.IfStmtInstruction = IfStmtInstruction;        
        var DeclStmtInstruction = (function (_super) {
            __extends(DeclStmtInstruction, _super);
            function DeclStmtInstruction() {
                        _super.call(this);
                this._pInstructionList = [
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_DeclStmtInstruction;
            }
            DeclStmtInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                var pVariableList = this.getInstructions();
                for(var i = 0; i < this._nInstructions; i++) {
                    sCode += pVariableList[i].toFinalCode() + ";\n";
                }
                return sCode;
            };
            DeclStmtInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                if (((this.getInstructions()) === null) || this._nInstructions === 0) {
                    return;
                }
                if (this.getInstructions()[0]._getInstructionType() === akra.EAFXInstructionTypes.k_TypeDeclInstruction) {
                    return;
                }
                var pVariableList = this.getInstructions();
                for(var i = 0; i < this._nInstructions; i++) {
                    var pVarType = pVariableList[i].getType();
                    pUsedDataCollector[pVarType._getInstructionID()] = {
                        type: pVarType,
                        isRead: false,
                        isWrite: true,
                        numRead: 0,
                        numWrite: 1,
                        numUsed: 1
                    };
                    if (pVariableList[i].hasInitializer()) {
                        pVariableList[i].getInitializeExpr().addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Read);
                    }
                }
            };
            return DeclStmtInstruction;
        })(StmtInstruction);
        fx.DeclStmtInstruction = DeclStmtInstruction;        
        var ReturnStmtInstruction = (function (_super) {
            __extends(ReturnStmtInstruction, _super);
            function ReturnStmtInstruction() {
                        _super.call(this);
                this._pPreparedCode = "";
                this._isPositionReturn = false;
                this._isColorReturn = false;
                this._isOnlyReturn = false;
                this._pInstructionList = [
                    null
                ];
                this._sOperatorName = "return";
                this._eInstructionType = akra.EAFXInstructionTypes.k_ReturnStmtInstruction;
            }
            ReturnStmtInstruction.prototype.prepareFor = function (eUsedMode) {
                var pReturn = this.getInstructions()[0];
                if (((pReturn) === null)) {
                    return;
                }
                if (eUsedMode === akra.EFunctionType.k_Vertex) {
                    if (pReturn.getType().isBase()) {
                        this._isPositionReturn = true;
                    } else {
                        this._isOnlyReturn = true;
                    }
                } else if (eUsedMode === akra.EFunctionType.k_Pixel) {
                    this._isColorReturn = true;
                }
                for(var i = 0; i < this._nInstructions; i++) {
                    this._pInstructionList[i].prepareFor(eUsedMode);
                }
            };
            ReturnStmtInstruction.prototype.toFinalCode = function () {
                if (this._isPositionReturn) {
                    return "Out.POSITION=" + this._pInstructionList[0].toFinalCode() + "; return;";
                }
                if (this._isColorReturn) {
                    return "gl_FragColor=" + this._pInstructionList[0].toFinalCode() + "; return;";
                }
                if (this._isOnlyReturn) {
                    return "return;";
                }
                if (this._nInstructions > 0) {
                    return "return " + this._pInstructionList[0].toFinalCode() + ";";
                } else {
                    return "return;";
                }
            };
            return ReturnStmtInstruction;
        })(StmtInstruction);
        fx.ReturnStmtInstruction = ReturnStmtInstruction;        
        var ExtractStmtInstruction = (function (_super) {
            __extends(ExtractStmtInstruction, _super);
            function ExtractStmtInstruction() {
                        _super.call(this);
                this._pExtractInVar = null;
                this._pExtractInExpr = null;
                this._pExtactExpr = null;
                this._pInstructionList = [];
                this._eInstructionType = akra.EAFXInstructionTypes.k_ExtractStmtInstruction;
            }
            ExtractStmtInstruction.prototype.generateStmtForBaseType = function (pVarDecl, pPointer, pBuffer, iPadding, pOffset) {
                if (typeof pOffset === "undefined") { pOffset = null; }
                var pVarType = pVarDecl.getType();
                var pVarNameExpr = pVarDecl._getFullNameExpr();
                if (pVarType.isComplex() || ((pVarNameExpr) === null) || pVarType.getSize() === 0xffffff) {
                    this.setError(2274);
                    return;
                }
                var pBufferSampler = pBuffer._getVideoBufferSampler();
                var pBufferHeader = pBuffer._getVideoBufferHeader();
                var isArray = pVarType.isNotBaseArray();
                var iLength = pVarType.getLength();
                var sCodeFragment = "";
                var pExtractType = isArray ? pVarType.getArrayElementType() : pVarType;
                if (isArray) {
                    if (iLength === 0xffffff) {
                        this.setError(2274);
                        return;
                    }
                    sCodeFragment = "for(int i=0;i<" + iLength.toString() + ";i++){";
                    this.push(new fx.SimpleInstruction(sCodeFragment), true);
                }
                this.push(pVarNameExpr, false);
                if (isArray) {
                    sCodeFragment = "[i]=";
                } else {
                    sCodeFragment = "=";
                }
                this.push(new fx.SimpleInstruction(sCodeFragment), true);
                var pExtractType = isArray ? pVarType.getArrayElementType() : pVarType;
                var pExtractExpr = new fx.ExtractExprInstruction();
                var sPaddingExpr = "";
                if (iPadding > 0) {
                    sPaddingExpr = "+" + iPadding.toString() + ".0";
                } else {
                    sPaddingExpr = "";
                }
                if (isArray) {
                    sPaddingExpr += "+float(i*" + pExtractType.getSize().toString() + ")";
                }
                pExtractExpr.initExtractExpr(pExtractType, pPointer, pBuffer, sPaddingExpr, pOffset);
                if (pExtractExpr.isErrorOccured()) {
                    this.setError(pExtractExpr.getLastError().code, pExtractExpr.getLastError().info);
                    return;
                }
                this.push(pExtractExpr, true);
                sCodeFragment = ";";
                if (isArray) {
                    sCodeFragment += "}";
                }
                this.push(new fx.SimpleInstruction(sCodeFragment), true);
                this._pExtactExpr = pExtractExpr;
                this._pExtractInVar = pVarDecl;
                this._pExtractInExpr = pVarNameExpr;
            };
            ExtractStmtInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                for(var i = 0; i < this._nInstructions; i++) {
                    sCode += this.getInstructions()[i].toFinalCode();
                }
                return sCode;
            };
            ExtractStmtInstruction.prototype.addUsedData = function (pUsedDataCollector, eUsedMode) {
                if (typeof eUsedMode === "undefined") { eUsedMode = akra.EVarUsedMode.k_Undefined; }
                this._pExtractInExpr.addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Write);
                this._pExtactExpr.addUsedData(pUsedDataCollector, akra.EVarUsedMode.k_Read);
            };
            ExtractStmtInstruction.prototype.getExtractFunction = function () {
                return this._pExtactExpr.getExtractFunction();
            };
            return ExtractStmtInstruction;
        })(fx.ExprInstruction);
        fx.ExtractStmtInstruction = ExtractStmtInstruction;        
        var SemicolonStmtInstruction = (function (_super) {
            __extends(SemicolonStmtInstruction, _super);
            function SemicolonStmtInstruction() {
                        _super.call(this);
                this._pInstructionList = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_SemicolonStmtInstruction;
            }
            SemicolonStmtInstruction.prototype.toFinalCode = function () {
                return ";";
            };
            return SemicolonStmtInstruction;
        })(StmtInstruction);
        fx.SemicolonStmtInstruction = SemicolonStmtInstruction;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var FunctionDeclInstruction = (function (_super) {
            __extends(FunctionDeclInstruction, _super);
            function FunctionDeclInstruction() {
                        _super.call(this);
                this._pFunctionDefenition = null;
                this._pImplementation = null;
                this._eFunctionType = akra.EFunctionType.k_Function;
                this._bUsedAsFunction = false;
                this._bUsedAsVertex = false;
                this._bUsedAsPixel = false;
                this._bCanUsedAsFunction = true;
                this._bUsedInVertex = false;
                this._bUsedInPixel = false;
                this._pParseNode = null;
                this._iImplementationScope = 0xffffff;
                this._isInBlackList = false;
                this._pOutVariable = null;
                this._pUsedFunctionMap = null;
                this._pUsedFunctionList = null;
                this._pAttributeVariableMap = null;
                this._pVaryingVariableMap = null;
                this._pUsedVarTypeMap = null;
                this._pSharedVariableMap = null;
                this._pGlobalVariableMap = null;
                this._pUniformVariableMap = null;
                this._pForeignVariableMap = null;
                this._pTextureVariableMap = null;
                this._pUsedComplexTypeMap = null;
                this._pAttributeVariableKeys = null;
                this._pVaryingVariableKeys = null;
                this._pSharedVariableKeys = null;
                this._pUniformVariableKeys = null;
                this._pForeignVariableKeys = null;
                this._pGlobalVariableKeys = null;
                this._pTextureVariableKeys = null;
                this._pUsedComplexTypeKeys = null;
                this._pVertexShader = null;
                this._pPixelShader = null;
                this._pExtSystemTypeList = null;
                this._pExtSystemFunctionList = null;
                this._pExtSystemMacrosList = null;
                this._pInstructionList = [
                    null, 
                    null
                ];
                this._eInstructionType = akra.EAFXInstructionTypes.k_FunctionDeclInstruction;
            }
            FunctionDeclInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                sCode += this._pFunctionDefenition.toFinalCode();
                sCode += this._pImplementation.toFinalCode();
                return sCode;
            };
            FunctionDeclInstruction.prototype.toFinalDefCode = function () {
                return this._pFunctionDefenition.toFinalCode();
            };
            FunctionDeclInstruction.prototype.getType = function () {
                return this.getReturnType();
            };
            FunctionDeclInstruction.prototype.getName = function () {
                return this._pFunctionDefenition.getName();
            };
            FunctionDeclInstruction.prototype.getRealName = function () {
                return this._pFunctionDefenition.getRealName();
            };
            FunctionDeclInstruction.prototype.getNameId = function () {
                return this._pFunctionDefenition.getNameId();
            };
            FunctionDeclInstruction.prototype.getArguments = function () {
                return this._pFunctionDefenition.getArguments();
            };
            FunctionDeclInstruction.prototype.getNumNeededArguments = function () {
                return this._pFunctionDefenition.getNumNeededArguments();
            };
            FunctionDeclInstruction.prototype.hasImplementation = function () {
                return !((this._pImplementation) === null) || !((this._pParseNode) === null);
            };
            FunctionDeclInstruction.prototype.getReturnType = function () {
                return this._pFunctionDefenition.getReturnType();
            };
            FunctionDeclInstruction.prototype.getFunctionType = function () {
                return this._eFunctionType;
            };
            FunctionDeclInstruction.prototype.setFunctionType = function (eFunctionType) {
                this._eFunctionType = eFunctionType;
            };
            FunctionDeclInstruction.prototype._setImplementationScope = function (iScope) {
                this._iImplementationScope = iScope;
            };
            FunctionDeclInstruction.prototype._getImplementationScope = function () {
                return this._iImplementationScope;
            };
            FunctionDeclInstruction.prototype._setParseNode = function (pNode) {
                this._pParseNode = pNode;
            };
            FunctionDeclInstruction.prototype._getParseNode = function () {
                return this._pParseNode;
            };
            FunctionDeclInstruction.prototype.setFunctionDef = function (pFunctionDef) {
                this._pFunctionDefenition = pFunctionDef;
                this._pInstructionList[0] = pFunctionDef;
                pFunctionDef.setParent(this);
                this._nInstructions = this._nInstructions === 0 ? 1 : this._nInstructions;
            };
            FunctionDeclInstruction.prototype.setImplementation = function (pImplementation) {
                this._pImplementation = pImplementation;
                this._pInstructionList[1] = pImplementation;
                pImplementation.setParent(pImplementation);
                this._nInstructions = 2;
                this._pParseNode = null;
            };
            FunctionDeclInstruction.prototype.clone = function (pRelationMap) {
                if (typeof pRelationMap === "undefined") { pRelationMap = {}; }
                var pClone = _super.prototype.clone.call(this, pRelationMap);
                if (!((this._pOutVariable) === null)) {
                    pClone._setOutVariable(pRelationMap[this._pOutVariable._getInstructionID()]);
                }
                var pUsedVarTypeMap = this.cloneVarTypeUsedMap(this._pUsedVarTypeMap, pRelationMap);
                var pSharedVariableMap = this.cloneVarDeclMap(this._pSharedVariableMap, pRelationMap);
                var pGlobalVariableMap = this.cloneVarDeclMap(this._pGlobalVariableMap, pRelationMap);
                var pUniformVariableMap = this.cloneVarDeclMap(this._pUniformVariableMap, pRelationMap);
                var pForeignVariableMap = this.cloneVarDeclMap(this._pForeignVariableMap, pRelationMap);
                var pTextureVariableMap = this.cloneVarDeclMap(this._pTextureVariableMap, pRelationMap);
                var pUsedComplexTypeMap = this.cloneTypeMap(this._pUsedComplexTypeMap, pRelationMap);
                pClone._setUsedFunctions(this._pUsedFunctionMap, this._pUsedFunctionList);
                pClone._setUsedVariableData(pUsedVarTypeMap, pSharedVariableMap, pGlobalVariableMap, pUniformVariableMap, pForeignVariableMap, pTextureVariableMap, pUsedComplexTypeMap);
                pClone._initAfterClone();
                return pClone;
            };
            FunctionDeclInstruction.prototype._addOutVariable = function (pVariable) {
                if (!((this._pOutVariable) === null)) {
                    return false;
                }
                if (!pVariable.getType().isEqual(this.getReturnType())) {
                    return false;
                }
                this._pOutVariable = pVariable;
                return true;
            };
            FunctionDeclInstruction.prototype._getOutVariable = function () {
                return this._pOutVariable;
            };
            FunctionDeclInstruction.prototype._getVertexShader = function () {
                return this._pVertexShader;
            };
            FunctionDeclInstruction.prototype._getPixelShader = function () {
                return this._pPixelShader;
            };
            FunctionDeclInstruction.prototype._markUsedAs = function (eUsedType) {
                switch(eUsedType) {
                    case akra.EFunctionType.k_Vertex:
                        this._bUsedInVertex = true;
                        this._bUsedAsVertex = true;
                        break;
                    case akra.EFunctionType.k_Pixel:
                        this._bUsedInPixel = true;
                        this._bUsedAsPixel = true;
                        break;
                    case akra.EFunctionType.k_Function:
                        this._bUsedAsFunction = true;
                        break;
                }
            };
            FunctionDeclInstruction.prototype._isUsedAs = function (eUsedType) {
                switch(eUsedType) {
                    case akra.EFunctionType.k_Vertex:
                        return this._bUsedAsVertex;
                    case akra.EFunctionType.k_Pixel:
                        return this._bUsedAsPixel;
                    case akra.EFunctionType.k_Function:
                        return this._bUsedAsFunction;
                }
            };
            FunctionDeclInstruction.prototype._isUsedAsFunction = function () {
                return this._bUsedAsFunction;
            };
            FunctionDeclInstruction.prototype._isUsedAsVertex = function () {
                return this._bUsedAsVertex;
            };
            FunctionDeclInstruction.prototype._isUsedAsPixel = function () {
                return this._bUsedAsPixel;
            };
            FunctionDeclInstruction.prototype._markUsedInVertex = function () {
                this._bUsedInVertex = true;
            };
            FunctionDeclInstruction.prototype._markUsedInPixel = function () {
                this._bUsedInPixel = true;
            };
            FunctionDeclInstruction.prototype._isUsedInVertex = function () {
                return this._bUsedInVertex;
            };
            FunctionDeclInstruction.prototype._isUsedInPixel = function () {
                return this._bUsedInPixel;
            };
            FunctionDeclInstruction.prototype._isUsed = function () {
                return this._bUsedAsFunction || this._bUsedAsVertex || this._bUsedAsPixel;
            };
            FunctionDeclInstruction.prototype._checkVertexUsage = function () {
                return this._isUsedInVertex() ? this._isForVertex() : true;
            };
            FunctionDeclInstruction.prototype._checkPixelUsage = function () {
                return this._isUsedInPixel() ? this._isForPixel() : true;
            };
            FunctionDeclInstruction.prototype._checkDefenitionForVertexUsage = function () {
                return this._pFunctionDefenition._checkForVertexUsage();
            };
            FunctionDeclInstruction.prototype._checkDefenitionForPixelUsage = function () {
                return this._pFunctionDefenition._checkForPixelUsage();
            };
            FunctionDeclInstruction.prototype._canUsedAsFunction = function () {
                return this._bCanUsedAsFunction && this._pFunctionDefenition._canUsedAsFunction();
            };
            FunctionDeclInstruction.prototype._notCanUsedAsFunction = function () {
                this._bCanUsedAsFunction = false;
            };
            FunctionDeclInstruction.prototype._addUsedFunction = function (pFunction) {
                if (pFunction._getInstructionType() === akra.EAFXInstructionTypes.k_SystemFunctionInstruction && !pFunction.isBuiltIn()) {
                    this.addExtSystemFunction(pFunction);
                    return true;
                }
                if (((this._pUsedFunctionMap) === null)) {
                    this._pUsedFunctionMap = {};
                    this._pUsedFunctionList = [];
                }
                var iFuncId = pFunction._getInstructionID();
                if (!((this._pUsedFunctionMap[iFuncId]) !== undefined)) {
                    this._pUsedFunctionMap[iFuncId] = pFunction;
                    this._pUsedFunctionList.push(pFunction);
                    return true;
                }
                return false;
            };
            FunctionDeclInstruction.prototype._addUsedVariable = function (pVariable) {
            };
            FunctionDeclInstruction.prototype._getUsedFunctionList = function () {
                return this._pUsedFunctionList;
            };
            FunctionDeclInstruction.prototype._isBlackListFunction = function () {
                return this._isInBlackList;
            };
            FunctionDeclInstruction.prototype._addToBlackList = function () {
                this._isInBlackList = true;
            };
            FunctionDeclInstruction.prototype._getStringDef = function () {
                return this._pFunctionDefenition._getStringDef();
            };
            FunctionDeclInstruction.prototype._convertToVertexShader = function () {
                var pShader = null;
                if ((!this._canUsedAsFunction() || !this._isUsedAsFunction()) && (!this._isUsedInPixel())) {
                    pShader = this;
                } else {
                    pShader = this.clone();
                }
                pShader._prepareForVertex();
                this._pVertexShader = pShader;
                return pShader;
            };
            FunctionDeclInstruction.prototype._convertToPixelShader = function () {
                var pShader = null;
                if ((!this._canUsedAsFunction() || !this._isUsedAsFunction()) && (!this._isUsedInVertex())) {
                    pShader = this;
                } else {
                    pShader = this.clone();
                }
                pShader._prepareForPixel();
                this._pPixelShader = pShader;
                return pShader;
            };
            FunctionDeclInstruction.prototype._prepareForVertex = function () {
                this.setFunctionType(akra.EFunctionType.k_Vertex);
                var pShaderInputParamList = this._pFunctionDefenition.getParameListForShaderInput();
                for(var i = 0; i < pShaderInputParamList.length; i++) {
                    var pParamType = pShaderInputParamList[i].getType();
                    if (pParamType.isComplex() && ((this._pUsedVarTypeMap[pParamType._getInstructionID()]) !== undefined) && this._pUsedVarTypeMap[pParamType._getInstructionID()].isRead) {
                        this.setError(2301, {
                            funcName: this.getName()
                        });
                        return;
                    }
                }
                var pOutVariable = this._getOutVariable();
                if (!((pOutVariable) === null)) {
                    if (((this._pUsedVarTypeMap[pOutVariable.getType()._getInstructionID()]) !== undefined) && this._pUsedVarTypeMap[pOutVariable.getType()._getInstructionID()].isRead) {
                        this.setError(2302, {
                            funcName: this.getName()
                        });
                        return;
                    }
                    pOutVariable._markAsShaderOutput(true);
                }
                if (this._pFunctionDefenition.isComplexShaderInput()) {
                    pShaderInputParamList[0].setVisible(false);
                }
                this._pImplementation.prepareFor(akra.EFunctionType.k_Vertex);
                this._pFunctionDefenition.markAsShaderDef(true);
                this.generatesVertexAttrubutes();
                this.generateVertexVaryings();
            };
            FunctionDeclInstruction.prototype._prepareForPixel = function () {
                this.setFunctionType(akra.EFunctionType.k_Pixel);
                var pShaderInputParamList = this._pFunctionDefenition.getParameListForShaderInput();
                for(var i = 0; i < pShaderInputParamList.length; i++) {
                    var pParamType = pShaderInputParamList[i].getType();
                    if (pParamType.isComplex() && ((this._pUsedVarTypeMap[pParamType._getInstructionID()]) !== undefined) && this._pUsedVarTypeMap[pParamType._getInstructionID()].isRead) {
                        this.setError(2301, {
                            funcName: this.getName()
                        });
                        return;
                    }
                }
                if (this._pFunctionDefenition.isComplexShaderInput()) {
                    pShaderInputParamList[0].setVisible(false);
                }
                this._pImplementation.prepareFor(akra.EFunctionType.k_Pixel);
                this._pFunctionDefenition.markAsShaderDef(true);
                this.generatePixelVaryings();
            };
            FunctionDeclInstruction.prototype._setOutVariable = function (pVar) {
                this._pOutVariable = pVar;
            };
            FunctionDeclInstruction.prototype._setUsedFunctions = function (pUsedFunctionMap, pUsedFunctionList) {
                this._pUsedFunctionMap = pUsedFunctionMap;
                this._pUsedFunctionList = pUsedFunctionList;
            };
            FunctionDeclInstruction.prototype._setUsedVariableData = function (pUsedVarTypeMap, pSharedVariableMap, pGlobalVariableMap, pUniformVariableMap, pForeignVariableMap, pTextureVariableMap, pUsedComplexTypeMap) {
                this._pUsedVarTypeMap = pUsedVarTypeMap;
                this._pSharedVariableMap = pSharedVariableMap;
                this._pGlobalVariableMap = pGlobalVariableMap;
                this._pUniformVariableMap = pUniformVariableMap;
                this._pForeignVariableMap = pForeignVariableMap;
                this._pTextureVariableMap = pTextureVariableMap;
                this._pUsedComplexTypeMap = pUsedComplexTypeMap;
            };
            FunctionDeclInstruction.prototype._initAfterClone = function () {
                this._pFunctionDefenition = this._pInstructionList[0];
                this._pImplementation = this._pInstructionList[1];
            };
            FunctionDeclInstruction.prototype._generateInfoAboutUsedData = function () {
                if (!((this._pUsedVarTypeMap) === null)) {
                    return;
                }
                var pUsedData = {};
                this._pImplementation.addUsedData(pUsedData);
                this._pUsedVarTypeMap = pUsedData;
                if (((this._pUsedComplexTypeMap) === null)) {
                    this._pSharedVariableMap = {};
                    this._pGlobalVariableMap = {};
                    this._pUniformVariableMap = {};
                    this._pForeignVariableMap = {};
                    this._pTextureVariableMap = {};
                    this._pUsedComplexTypeMap = {};
                }
                for(var i in pUsedData) {
                    var pAnalyzedInfo = pUsedData[i];
                    var pAnalyzedType = pAnalyzedInfo.type;
                    if (pAnalyzedType._isInGlobalScope()) {
                        this.addGlobalVariableType(pAnalyzedType, pAnalyzedInfo.isWrite, pAnalyzedInfo.isRead);
                    } else if (pAnalyzedType.isUniform()) {
                        this.addUniformParameter(pAnalyzedType);
                    } else if (pAnalyzedType._getScope() < this._getImplementationScope()) {
                        if (!this._isUsedAsFunction()) {
                            if (!((this._getOutVariable()) === null) && this._getOutVariable().getType() !== pAnalyzedType) {
                                this.addUsedComplexType(pAnalyzedType.getBaseType());
                            }
                        }
                    }
                }
                if (!((this._pUsedFunctionList) === null)) {
                    for(var j = 0; j < this._pUsedFunctionList.length; j++) {
                        this.addUsedInfoFromFunction(this._pUsedFunctionList[j]);
                    }
                }
            };
            FunctionDeclInstruction.prototype._getAttributeVariableMap = function () {
                return this._pAttributeVariableMap;
            };
            FunctionDeclInstruction.prototype._getVaryingVariableMap = function () {
                return this._pVaryingVariableMap;
            };
            FunctionDeclInstruction.prototype._getSharedVariableMap = function () {
                return this._pSharedVariableMap;
            };
            FunctionDeclInstruction.prototype._getGlobalVariableMap = function () {
                return this._pGlobalVariableMap;
            };
            FunctionDeclInstruction.prototype._getUniformVariableMap = function () {
                return this._pUniformVariableMap;
            };
            FunctionDeclInstruction.prototype._getForeignVariableMap = function () {
                return this._pForeignVariableMap;
            };
            FunctionDeclInstruction.prototype._getTextureVariableMap = function () {
                return this._pTextureVariableMap;
            };
            FunctionDeclInstruction.prototype._getUsedComplexTypeMap = function () {
                return this._pUsedComplexTypeMap;
            };
            FunctionDeclInstruction.prototype._getAttributeVariableKeys = function () {
                if (((this._pAttributeVariableKeys) === null) && !((this._pAttributeVariableMap) === null)) {
                    this._pAttributeVariableKeys = Object.keys(this._pAttributeVariableMap);
                }
                return this._pAttributeVariableKeys;
            };
            FunctionDeclInstruction.prototype._getVaryingVariableKeys = function () {
                if (((this._pVaryingVariableKeys) === null) && !((this._pVaryingVariableMap) === null)) {
                    this._pVaryingVariableKeys = Object.keys(this._pVaryingVariableMap);
                }
                return this._pVaryingVariableKeys;
            };
            FunctionDeclInstruction.prototype._getSharedVariableKeys = function () {
                if (((this._pSharedVariableKeys) === null) && !((this._pSharedVariableMap) === null)) {
                    this._pSharedVariableKeys = Object.keys(this._pSharedVariableMap);
                }
                return this._pSharedVariableKeys;
            };
            FunctionDeclInstruction.prototype._getUniformVariableKeys = function () {
                if (((this._pUniformVariableKeys) === null) && !((this._pUniformVariableMap) === null)) {
                    this._pUniformVariableKeys = Object.keys(this._pUniformVariableMap);
                }
                return this._pUniformVariableKeys;
            };
            FunctionDeclInstruction.prototype._getForeignVariableKeys = function () {
                if (((this._pForeignVariableKeys) === null) && !((this._pForeignVariableMap) === null)) {
                    this._pForeignVariableKeys = Object.keys(this._pForeignVariableMap);
                }
                return this._pForeignVariableKeys;
            };
            FunctionDeclInstruction.prototype._getGlobalVariableKeys = function () {
                if (((this._pGlobalVariableKeys) === null) && !((this._pGlobalVariableMap) === null)) {
                    this._pGlobalVariableKeys = Object.keys(this._pGlobalVariableMap);
                }
                return this._pGlobalVariableKeys;
            };
            FunctionDeclInstruction.prototype._getTextureVariableKeys = function () {
                if (((this._pTextureVariableKeys) === null) && !((this._pTextureVariableMap) === null)) {
                    this._pTextureVariableKeys = Object.keys(this._pTextureVariableMap);
                }
                return this._pTextureVariableKeys;
            };
            FunctionDeclInstruction.prototype._getUsedComplexTypeKeys = function () {
                if (((this._pUsedComplexTypeKeys) === null)) {
                    this._pUsedComplexTypeKeys = Object.keys(this._pUsedComplexTypeMap);
                }
                return this._pUsedComplexTypeKeys;
            };
            FunctionDeclInstruction.prototype._getExtSystemFunctionList = function () {
                return this._pExtSystemFunctionList;
            };
            FunctionDeclInstruction.prototype._getExtSystemMacrosList = function () {
                return this._pExtSystemMacrosList;
            };
            FunctionDeclInstruction.prototype._getExtSystemTypeList = function () {
                return this._pExtSystemTypeList;
            };
            FunctionDeclInstruction.prototype.generatesVertexAttrubutes = function () {
                var pShaderInputParamList = this._pFunctionDefenition.getParameListForShaderInput();
                var isComplexInput = this._pFunctionDefenition.isComplexShaderInput();
                this._pAttributeVariableMap = {};
                if (isComplexInput) {
                    var pContainerVariable = pShaderInputParamList[0];
                    var pContainerType = pContainerVariable.getType();
                    var pAttributeNames = pContainerType.getFieldNameList();
                    for(var i = 0; i < pAttributeNames.length; i++) {
                        var pAttr = pContainerType.getField(pAttributeNames[i]);
                        if (!this.isVariableTypeUse(pAttr.getType())) {
                            continue;
                        }
                        this._pAttributeVariableMap[pAttr._getInstructionID()] = pAttr;
                        this.generateExtractBlockForAttribute(pAttr);
                    }
                } else {
                    for(var i = 0; i < pShaderInputParamList.length; i++) {
                        var pAttr = pShaderInputParamList[i];
                        if (!this.isVariableTypeUse(pAttr.getType())) {
                            continue;
                        }
                        this._pAttributeVariableMap[pAttr._getInstructionID()] = pAttr;
                        this.generateExtractBlockForAttribute(pAttr);
                    }
                }
                this._pAttributeVariableKeys = this._getAttributeVariableKeys();
            };
            FunctionDeclInstruction.prototype.generateVertexVaryings = function () {
                if (((this._getOutVariable()) === null)) {
                    return;
                }
                this._pVaryingVariableMap = {};
                var pContainerVariable = this._getOutVariable();
                var pContainerType = pContainerVariable.getType();
                var pVaryingNames = pContainerType.getFieldNameList();
                for(var i = 0; i < pVaryingNames.length; i++) {
                    var pVarying = pContainerType.getField(pVaryingNames[i]);
                    if (!this.isVariableTypeUse(pVarying.getType())) {
                        continue;
                    }
                    this._pVaryingVariableMap[pVarying._getInstructionID()] = pVarying;
                }
                this._pVaryingVariableKeys = this._getVaryingVariableKeys();
            };
            FunctionDeclInstruction.prototype.generatePixelVaryings = function () {
                var pShaderInputParamList = this._pFunctionDefenition.getParameListForShaderInput();
                var isComplexInput = this._pFunctionDefenition.isComplexShaderInput();
                this._pVaryingVariableMap = {};
                if (isComplexInput) {
                    var pContainerVariable = pShaderInputParamList[0];
                    var pContainerType = pContainerVariable.getType();
                    var pVaryingNames = pContainerType.getFieldNameList();
                    for(var i = 0; i < pVaryingNames.length; i++) {
                        var pVarying = pContainerType.getField(pVaryingNames[i]);
                        if (!this.isVariableTypeUse(pVarying.getType())) {
                            continue;
                        }
                        this._pVaryingVariableMap[pVarying._getInstructionID()] = pVarying;
                    }
                } else {
                    for(var i = 0; i < pShaderInputParamList.length; i++) {
                        var pVarying = pShaderInputParamList[i];
                        if (!this.isVariableTypeUse(pVarying.getType())) {
                            continue;
                        }
                        this._pVaryingVariableMap[pVarying._getInstructionID()] = pVarying;
                    }
                }
                this._pVaryingVariableKeys = this._getVaryingVariableKeys();
            };
            FunctionDeclInstruction.prototype.cloneVarTypeUsedMap = function (pMap, pRelationMap) {
                var pCloneMap = {};
                for(var j in pMap) {
                    var pType = ((pRelationMap[j]) !== undefined) ? pRelationMap[j] : pMap[j].type;
                    var id = pType._getInstructionID();
                    pCloneMap[id] = {
                        type: pType,
                        isRead: pMap[j].isRead,
                        isWrite: pMap[j].isWrite,
                        numRead: pMap[j].numRead,
                        numWrite: pMap[j].numWrite,
                        numUsed: pMap[j].numUsed
                    };
                }
                return pCloneMap;
            };
            FunctionDeclInstruction.prototype.cloneVarDeclMap = function (pMap, pRelationMap) {
                var pCloneMap = {};
                for(var i in pMap) {
                    var pVar = ((pRelationMap[i]) !== undefined) ? pRelationMap[i] : pMap[i];
                    if (!((pVar) === null)) {
                        var id = pVar._getInstructionID();
                        pCloneMap[id] = pVar;
                    }
                }
                return pCloneMap;
            };
            FunctionDeclInstruction.prototype.cloneTypeMap = function (pMap, pRelationMap) {
                var pCloneMap = {};
                for(var i in pMap) {
                    var pVar = (((pRelationMap[i]) !== undefined) ? pRelationMap[i] : pMap[i]);
                    var id = pVar._getInstructionID();
                    pCloneMap[id] = pVar;
                }
                return pCloneMap;
            };
            FunctionDeclInstruction.prototype.addGlobalVariableType = function (pVariableType, isWrite, isRead) {
                if (!pVariableType.isFromVariableDecl()) {
                    return;
                }
                var pVariable = pVariableType._getParentVarDecl();
                var pMainVariable = pVariableType._getMainVariable();
                var iMainVar = pMainVariable._getInstructionID();
                var iVar = pVariable._getInstructionID();
                if (pMainVariable.getType().isShared()) {
                    this._pSharedVariableMap[iMainVar] = pMainVariable;
                } else if (pMainVariable.getType().isForeign()) {
                    this._pForeignVariableMap[iMainVar] = pMainVariable;
                } else if (isWrite) {
                    this._pGlobalVariableMap[iMainVar] = pMainVariable;
                    if (((this._pUniformVariableMap[iMainVar]) != null)) {
                        this._pUniformVariableMap[iMainVar] = null;
                    }
                } else {
                    if (!((this._pGlobalVariableMap[iMainVar]) !== undefined)) {
                        this._pUniformVariableMap[iMainVar] = pMainVariable;
                    }
                }
                if (pVariable.isSampler() && pVariable.hasInitializer()) {
                    var pInitExpr = pVariable.getInitializeExpr();
                    var pTexture = null;
                    var pSamplerStates = null;
                    if (pVariableType.isArray()) {
                        var pList = pInitExpr.getInstructions();
                        for(var i = 0; i < pList.length; i++) {
                            pSamplerStates = pList[i].getInstructions()[0];
                            pTexture = pSamplerStates.getTexture();
                            this._pTextureVariableMap[pTexture._getInstructionID()] = pTexture;
                        }
                    } else {
                        pSamplerStates = pInitExpr.getInstructions()[0];
                        pTexture = pSamplerStates.getTexture();
                        this._pTextureVariableMap[pTexture._getInstructionID()] = pTexture;
                    }
                }
            };
            FunctionDeclInstruction.prototype.addUniformParameter = function (pType) {
                var pMainVariable = pType._getMainVariable();
                var iMainVar = pMainVariable._getInstructionID();
                if (((this._pGlobalVariableMap[iMainVar]) !== undefined)) {
 {
                        akra.logger.setSourceLocation("fx/FunctionInstruction.ts", 839);
                        akra.logger.error("UNEXPECTED ERROR WITH UNIFORM_PARAMETER");
                    }
                    ;
                }
                this._pUniformVariableMap[iMainVar] = pMainVariable;
                this.addUsedComplexType(pMainVariable.getType().getBaseType());
            };
            FunctionDeclInstruction.prototype.addUsedComplexType = function (pType) {
                if (pType.isBase() || ((this._pUsedComplexTypeMap[pType._getInstructionID()]) !== undefined)) {
                    return;
                }
                this._pUsedComplexTypeMap[pType._getInstructionID()] = pType;
                var pFieldNameList = pType.getFieldNameList();
                for(var i = 0; i < pFieldNameList.length; i++) {
                    this.addUsedComplexType(pType.getFieldType(pFieldNameList[i]).getBaseType());
                }
            };
            FunctionDeclInstruction.prototype.addUsedInfoFromFunction = function (pFunction) {
                pFunction._generateInfoAboutUsedData();
                var pSharedVarMap = pFunction._getSharedVariableMap();
                var pGlobalVarMap = pFunction._getGlobalVariableMap();
                var pUniformVarMap = pFunction._getUniformVariableMap();
                var pForeignVarMap = pFunction._getForeignVariableMap();
                var pTextureVarMap = pFunction._getTextureVariableMap();
                var pUsedComplexTypeMap = pFunction._getUsedComplexTypeMap();
                for(var j in pSharedVarMap) {
                    this._pSharedVariableMap[pSharedVarMap[j]._getInstructionID()] = pSharedVarMap[j];
                }
                for(var j in pForeignVarMap) {
                    this._pForeignVariableMap[pForeignVarMap[j]._getInstructionID()] = pForeignVarMap[j];
                }
                for(var j in pTextureVarMap) {
                    this._pTextureVariableMap[pTextureVarMap[j]._getInstructionID()] = pTextureVarMap[j];
                }
                for(var j in pGlobalVarMap) {
                    this._pGlobalVariableMap[pGlobalVarMap[j]._getInstructionID()] = pGlobalVarMap[j];
                    if (((this._pUniformVariableMap[pGlobalVarMap[j]._getInstructionID()]) != null)) {
                        this._pUniformVariableMap[pGlobalVarMap[j]._getInstructionID()] = null;
                    }
                }
                for(var j in pUniformVarMap) {
                    if (!((this._pGlobalVariableMap[pUniformVarMap[j]._getInstructionID()]) !== undefined)) {
                        this._pUniformVariableMap[pUniformVarMap[j]._getInstructionID()] = pUniformVarMap[j];
                    }
                }
                for(var j in pUsedComplexTypeMap) {
                    this._pUsedComplexTypeMap[pUsedComplexTypeMap[j]._getInstructionID()] = pUsedComplexTypeMap[j];
                }
                this.addExtSystemFunction(pFunction);
            };
            FunctionDeclInstruction.prototype.addExtSystemFunction = function (pFunction) {
                if (((this._pExtSystemFunctionList) === null)) {
                    this._pExtSystemFunctionList = [];
                    this._pExtSystemTypeList = [];
                    this._pExtSystemMacrosList = [];
                }
                if (pFunction._getInstructionType() === akra.EAFXInstructionTypes.k_SystemFunctionInstruction) {
                    if (this._pExtSystemFunctionList.indexOf(pFunction) !== -1) {
                        return;
                    }
                    this._pExtSystemFunctionList.push(pFunction);
                }
                var pTypes = pFunction._getExtSystemTypeList();
                var pMacroses = pFunction._getExtSystemMacrosList();
                var pFunctions = pFunction._getExtSystemFunctionList();
                if (!((pTypes) === null)) {
                    for(var j = 0; j < pTypes.length; j++) {
                        if (this._pExtSystemTypeList.indexOf(pTypes[j]) === -1) {
                            this._pExtSystemTypeList.push(pTypes[j]);
                        }
                    }
                }
                if (!((pMacroses) === null)) {
                    for(var j = 0; j < pMacroses.length; j++) {
                        if (this._pExtSystemMacrosList.indexOf(pMacroses[j]) === -1) {
                            this._pExtSystemMacrosList.push(pMacroses[j]);
                        }
                    }
                }
                if (!((pFunctions) === null)) {
                    for(var j = 0; j < pFunctions.length; j++) {
                        if (this._pExtSystemFunctionList.indexOf(pFunctions[j]) === -1) {
                            this._pExtSystemFunctionList.unshift(pFunctions[j]);
                        }
                    }
                }
            };
            FunctionDeclInstruction.prototype.isVariableTypeUse = function (pVariableType) {
                var id = pVariableType._getInstructionID();
                if (!((this._pUsedVarTypeMap[id]) !== undefined)) {
                    return false;
                }
                if (this._pUsedVarTypeMap[id].numUsed === 0) {
                    return false;
                }
                return true;
            };
            FunctionDeclInstruction.prototype.generateExtractBlockForAttribute = function (pAttr) {
                if (!pAttr.getType().isPointer()) {
                    return null;
                }
                var pExtractCollector = new fx.InstructionCollector();
                var pMainPointer = pAttr.getType()._getMainPointer();
                pAttr._setAttrExtractionBlock(pExtractCollector);
                this.generateExtractStmtFromPointer(pMainPointer, null, 0, pExtractCollector);
                pAttr.getType().getSubVarDecls();
                return pExtractCollector;
            };
            FunctionDeclInstruction.prototype.generateExtractStmtFromPointer = function (pPointer, pOffset, iDepth, pCollector) {
                var pPointerType = pPointer.getType();
                var pWhatExtracted = pPointerType._getDownPointer();
                var pWhatExtractedType = null;
                while(!((pWhatExtracted) === null)) {
                    pWhatExtractedType = pWhatExtracted.getType();
                    if (!pWhatExtractedType.isPointIndex() && iDepth === 0) {
                        pOffset = this.createOffsetForAttr(pWhatExtracted);
                    }
                    if (!pWhatExtractedType.isComplex()) {
                        var pSingleExtract = new fx.ExtractStmtInstruction();
                        pSingleExtract.generateStmtForBaseType(pWhatExtracted, pWhatExtractedType.getPointer(), pWhatExtractedType.getVideoBuffer(), 0, pWhatExtractedType.isPointIndex() ? null : pOffset);
                        this._addUsedFunction(pSingleExtract.getExtractFunction());
                        pCollector.push(pSingleExtract, true);
                    } else {
                        iDepth++;
                        this.generateExtractStmtForComplexVar(pWhatExtracted, iDepth <= 1 ? pOffset : null, iDepth, pCollector, pWhatExtractedType.getPointer(), pWhatExtractedType.getVideoBuffer(), 0);
                    }
                    pWhatExtracted = pWhatExtractedType._getDownPointer();
                }
            };
            FunctionDeclInstruction.prototype.generateExtractStmtForComplexVar = function (pVarDecl, pOffset, iDepth, pCollector, pPointer, pBuffer, iPadding) {
                var pVarType = pVarDecl.getType();
                var pFieldNameList = pVarType.getFieldNameList();
                var pField = null;
                var pFieldType = null;
                var pSingleExtract = null;
                var isNeedPadding = false;
                for(var i = 0; i < pFieldNameList.length; i++) {
                    pField = pVarType.getField(pFieldNameList[i]);
                    if (((pField) === null)) {
                        continue;
                    }
                    pFieldType = pField.getType();
                    if (iDepth <= 1) {
                        pOffset = this.createOffsetForAttr(pField);
                        isNeedPadding = false;
                    } else {
                        isNeedPadding = true;
                    }
                    if (pFieldType.isPointer()) {
                        var pFieldPointer = pFieldType._getMainPointer();
                        pSingleExtract = new fx.ExtractStmtInstruction();
                        pSingleExtract.generateStmtForBaseType(pFieldPointer, pPointer, pFieldType.getVideoBuffer(), isNeedPadding ? (iPadding + pFieldType.getPadding()) : 0, pOffset);
                        this._addUsedFunction(pSingleExtract.getExtractFunction());
                        pCollector.push(pSingleExtract, true);
                        this.generateExtractStmtFromPointer(pFieldPointer, pOffset, iDepth, pCollector);
                    } else if (pFieldType.isComplex()) {
                        iDepth++;
                        this.generateExtractStmtForComplexVar(pField, pOffset, iDepth, pCollector, pPointer, pBuffer, isNeedPadding ? (iPadding + pFieldType.getPadding()) : 0);
                    } else {
                        pSingleExtract = new fx.ExtractStmtInstruction();
                        pSingleExtract.generateStmtForBaseType(pField, pPointer, pBuffer, isNeedPadding ? (iPadding + pFieldType.getPadding()) : 0, pOffset);
                        this._addUsedFunction(pSingleExtract.getExtractFunction());
                        pCollector.push(pSingleExtract, true);
                    }
                }
            };
            FunctionDeclInstruction.prototype.createOffsetForAttr = function (pAttr) {
                var pOffset = new fx.VariableDeclInstruction();
                var pOffsetType = new fx.VariableTypeInstruction();
                var pOffsetId = new fx.IdInstruction();
                pOffsetType.pushType(fx.Effect.getSystemType("float"));
                pOffsetType.addUsage("uniform");
                pOffsetId.setName("offset");
                pOffsetId.setRealName(pAttr.getRealName() + "_o");
                pOffset.push(pOffsetType, true);
                pOffset.push(pOffsetId, true);
                pOffset.setParent(pAttr);
                pOffset.setSemantic(pAttr.getSemantic());
                pAttr.getType()._addAttrOffset(pOffset);
                return pOffset;
            };
            return FunctionDeclInstruction;
        })(fx.DeclInstruction);
        fx.FunctionDeclInstruction = FunctionDeclInstruction;        
        var SystemFunctionInstruction = (function (_super) {
            __extends(SystemFunctionInstruction, _super);
            function SystemFunctionInstruction(sName, pReturnType, pExprTranslator, pArgumentTypes) {
                        _super.call(this);
                this._pExprTranslator = null;
                this._pName = null;
                this._pReturnType = null;
                this._pArguments = null;
                this._sDefinition = "";
                this._sImplementation = "";
                this._pExtSystemTypeList = null;
                this._pExtSystemFunctionList = null;
                this._pExtSystemMacrosList = null;
                this._eInstructionType = akra.EAFXInstructionTypes.k_SystemFunctionInstruction;
                this._pName = new fx.IdInstruction();
                this._pName.setName(sName);
                this._pName.setParent(this);
                this._pReturnType = new fx.VariableTypeInstruction();
                this._pReturnType.pushType(pReturnType);
                this._pReturnType.setParent(this);
                this._pArguments = [];
                if (!((pArgumentTypes) === null)) {
                    for(var i = 0; i < pArgumentTypes.length; i++) {
                        var pArgument = new fx.TypedInstruction();
                        pArgument.setType(pArgumentTypes[i]);
                        pArgument.setParent(this);
                        this._pArguments.push(pArgument);
                    }
                }
                this._pExprTranslator = pExprTranslator;
            }
            SystemFunctionInstruction.prototype.setDeclCode = function (sDefenition, sImplementation) {
                this._sDefinition = sDefenition;
                this._sImplementation = sImplementation;
            };
            SystemFunctionInstruction.prototype.toFinalCode = function () {
                return this._sDefinition + this._sImplementation;
            };
            SystemFunctionInstruction.prototype.toFinalDefCode = function () {
                return this._sDefinition;
            };
            SystemFunctionInstruction.prototype.setUsedSystemData = function (pTypeList, pFunctionList, pMacrosList) {
                this._pExtSystemTypeList = pTypeList;
                this._pExtSystemFunctionList = pFunctionList;
                this._pExtSystemMacrosList = pMacrosList;
            };
            SystemFunctionInstruction.prototype.closeSystemDataInfo = function () {
                for(var i = 0; i < this._pExtSystemFunctionList.length; i++) {
                    var pFunction = this._pExtSystemFunctionList[i];
                    var pTypes = pFunction._getExtSystemTypeList();
                    var pMacroses = pFunction._getExtSystemMacrosList();
                    var pFunctions = pFunction._getExtSystemFunctionList();
                    for(var j = 0; j < pTypes.length; j++) {
                        if (this._pExtSystemTypeList.indexOf(pTypes[j]) === -1) {
                            this._pExtSystemTypeList.push(pTypes[j]);
                        }
                    }
                    for(var j = 0; j < pMacroses.length; j++) {
                        if (this._pExtSystemMacrosList.indexOf(pMacroses[j]) === -1) {
                            this._pExtSystemMacrosList.push(pMacroses[j]);
                        }
                    }
                    for(var j = 0; j < pFunctions.length; j++) {
                        if (this._pExtSystemFunctionList.indexOf(pFunctions[j]) === -1) {
                            this._pExtSystemFunctionList.unshift(pFunctions[j]);
                        }
                    }
                }
            };
            SystemFunctionInstruction.prototype.setExprTranslator = function (pExprTranslator) {
                this._pExprTranslator = pExprTranslator;
            };
            SystemFunctionInstruction.prototype.getNameId = function () {
                return this._pName;
            };
            SystemFunctionInstruction.prototype.getArguments = function () {
                return this._pArguments;
            };
            SystemFunctionInstruction.prototype.getNumNeededArguments = function () {
                return this._pArguments.length;
            };
            SystemFunctionInstruction.prototype.hasImplementation = function () {
                return true;
            };
            SystemFunctionInstruction.prototype.getType = function () {
                return this.getReturnType();
            };
            SystemFunctionInstruction.prototype.getReturnType = function () {
                return this._pReturnType;
            };
            SystemFunctionInstruction.prototype.getFunctionType = function () {
                return akra.EFunctionType.k_Function;
            };
            SystemFunctionInstruction.prototype.setFunctionType = function (eFunctionType) {
            };
            SystemFunctionInstruction.prototype.closeArguments = function (pArguments) {
                return this._pExprTranslator.toInstructionList(pArguments);
            };
            SystemFunctionInstruction.prototype.setFunctionDef = function (pFunctionDef) {
            };
            SystemFunctionInstruction.prototype.setImplementation = function (pImplementation) {
            };
            SystemFunctionInstruction.prototype.clone = function (pRelationMap) {
                return this;
            };
            SystemFunctionInstruction.prototype._addOutVariable = function (pVariable) {
                return false;
            };
            SystemFunctionInstruction.prototype._getOutVariable = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getVertexShader = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getPixelShader = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._markUsedAs = function (eUsedType) {
            };
            SystemFunctionInstruction.prototype._isUsedAs = function (eUsedType) {
                return true;
            };
            SystemFunctionInstruction.prototype._isUsedAsFunction = function () {
                return true;
            };
            SystemFunctionInstruction.prototype._isUsedAsVertex = function () {
                return true;
            };
            SystemFunctionInstruction.prototype._isUsedAsPixel = function () {
                return true;
            };
            SystemFunctionInstruction.prototype._markUsedInVertex = function () {
            };
            SystemFunctionInstruction.prototype._markUsedInPixel = function () {
            };
            SystemFunctionInstruction.prototype._isUsedInVertex = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._isUsedInPixel = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._isUsed = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._checkVertexUsage = function () {
                return this._isForVertex();
            };
            SystemFunctionInstruction.prototype._checkPixelUsage = function () {
                return this._isForPixel();
            };
            SystemFunctionInstruction.prototype._checkDefenitionForVertexUsage = function () {
                return false;
            };
            SystemFunctionInstruction.prototype._checkDefenitionForPixelUsage = function () {
                return false;
            };
            SystemFunctionInstruction.prototype._canUsedAsFunction = function () {
                return true;
            };
            SystemFunctionInstruction.prototype._notCanUsedAsFunction = function () {
            };
            SystemFunctionInstruction.prototype._addUsedFunction = function (pFunction) {
                return false;
            };
            SystemFunctionInstruction.prototype._addUsedVariable = function (pVariable) {
            };
            SystemFunctionInstruction.prototype._getUsedFunctionList = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._isBlackListFunction = function () {
                return false;
            };
            SystemFunctionInstruction.prototype._addToBlackList = function () {
            };
            SystemFunctionInstruction.prototype._getStringDef = function () {
                return "system_func";
            };
            SystemFunctionInstruction.prototype._convertToVertexShader = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._convertToPixelShader = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._prepareForVertex = function () {
            };
            SystemFunctionInstruction.prototype._prepareForPixel = function () {
            };
            SystemFunctionInstruction.prototype.addUsedVariableType = function (pType, eUsedMode) {
                return false;
            };
            SystemFunctionInstruction.prototype._generateInfoAboutUsedData = function () {
            };
            SystemFunctionInstruction.prototype._getAttributeVariableMap = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getVaryingVariableMap = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getSharedVariableMap = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getGlobalVariableMap = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getUniformVariableMap = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getForeignVariableMap = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getTextureVariableMap = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getUsedComplexTypeMap = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getAttributeVariableKeys = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getVaryingVariableKeys = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getSharedVariableKeys = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getUniformVariableKeys = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getForeignVariableKeys = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getGlobalVariableKeys = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getTextureVariableKeys = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getUsedComplexTypeKeys = function () {
                return null;
            };
            SystemFunctionInstruction.prototype._getExtSystemFunctionList = function () {
                return this._pExtSystemFunctionList;
            };
            SystemFunctionInstruction.prototype._getExtSystemMacrosList = function () {
                return this._pExtSystemMacrosList;
            };
            SystemFunctionInstruction.prototype._getExtSystemTypeList = function () {
                return this._pExtSystemTypeList;
            };
            return SystemFunctionInstruction;
        })(fx.DeclInstruction);
        fx.SystemFunctionInstruction = SystemFunctionInstruction;        
        var FunctionDefInstruction = (function (_super) {
            __extends(FunctionDefInstruction, _super);
            function FunctionDefInstruction() {
                        _super.call(this);
                this._pParameterList = null;
                this._pParamListForShaderCompile = null;
                this._pParamListForShaderInput = null;
                this._isComplexShaderInput = false;
                this._pReturnType = null;
                this._pFunctionName = null;
                this._nParamsNeeded = 0;
                this._sDefinition = "";
                this._isAnalyzedForVertexUsage = false;
                this._isAnalyzedForPixelUsage = false;
                this._bCanUsedAsFunction = true;
                this._bShaderDef = false;
                this._pInstructionList = null;
                this._pParameterList = [];
                this._eInstructionType = akra.EAFXInstructionTypes.k_FunctionDefInstruction;
            }
            FunctionDefInstruction.prototype.toFinalCode = function () {
                var sCode = "";
                if (!this.isShaderDef()) {
                    sCode += this._pReturnType.toFinalCode();
                    sCode += " " + this._pFunctionName.toFinalCode();
                    sCode += "(";
                    for(var i = 0; i < this._pParameterList.length; i++) {
                        sCode += this._pParameterList[i].toFinalCode();
                        if (i !== this._pParameterList.length - 1) {
                            sCode += ",";
                        }
                    }
                    sCode += ")";
                } else {
                    sCode = "void " + this._pFunctionName.toFinalCode() + "()";
                }
                return sCode;
            };
            FunctionDefInstruction.prototype.setType = function (pType) {
                this.setReturnType(pType);
            };
            FunctionDefInstruction.prototype.getType = function () {
                return this.getReturnType();
            };
            FunctionDefInstruction.prototype.setReturnType = function (pReturnType) {
                this._pReturnType = pReturnType;
                pReturnType.setParent(this);
                return true;
            };
            FunctionDefInstruction.prototype.getReturnType = function () {
                return this._pReturnType;
            };
            FunctionDefInstruction.prototype.setFunctionName = function (pNameId) {
                this._pFunctionName = pNameId;
                pNameId.setParent(this);
                return true;
            };
            FunctionDefInstruction.prototype.getName = function () {
                return this._pFunctionName.getName();
            };
            FunctionDefInstruction.prototype.getRealName = function () {
                return this._pFunctionName.getRealName();
            };
            FunctionDefInstruction.prototype.getNameId = function () {
                return this._pFunctionName;
            };
            FunctionDefInstruction.prototype.getArguments = function () {
                return this._pParameterList;
            };
            FunctionDefInstruction.prototype.getNumNeededArguments = function () {
                return this._nParamsNeeded;
            };
            FunctionDefInstruction.prototype.markAsShaderDef = function (isShaderDef) {
                this._bShaderDef = isShaderDef;
            };
            FunctionDefInstruction.prototype.isShaderDef = function () {
                return this._bShaderDef;
            };
            FunctionDefInstruction.prototype.addParameter = function (pParameter, isStrictModeOn) {
                if (this._pParameterList.length > this._nParamsNeeded && !pParameter.hasInitializer()) {
                    this.setError(2245, {
                        funcName: this._pFunctionName.getName(),
                        varName: pParameter.getName()
                    });
                    return false;
                }
                var pParameterType = pParameter.getType();
                if (pParameterType.isPointer() || pParameterType._containPointer()) {
                    if (pParameterType.hasUsage("uniform") || pParameterType.hasUsage("out") || pParameterType.hasUsage("inout")) {
                        this.setError(2265, {
                            funcName: this._pFunctionName.getName(),
                            varName: pParameter.getName()
                        });
                        return false;
                    }
                    this._isAnalyzedForVertexUsage = false;
                    this._isAnalyzedForPixelUsage = true;
                    this._setForPixel(false);
                    this._bCanUsedAsFunction = false;
                    pParameterType._setVideoBufferInDepth();
                } else if (!isStrictModeOn) {
                    if (pParameterType.isComplex() && !pParameterType.hasFieldWithoutSemantic() && pParameterType.hasAllUniqueSemantics()) {
                        if (pParameter.getSemantic() === "" && pParameterType.hasAllUniqueSemantics() && !pParameterType.hasFieldWithoutSemantic()) {
                            pParameterType._addPointIndexInDepth();
                        } else {
                            pParameterType.addPointIndex(false);
                            pParameterType._setVideoBufferInDepth();
                        }
                    } else if (pParameter.getSemantic() !== "") {
                        pParameterType.addPointIndex(false);
                        pParameterType._setVideoBufferInDepth();
                    }
                }
                this._pParameterList.push(pParameter);
                pParameter.setParent(this);
                if (!pParameter.hasInitializer()) {
                    this._nParamsNeeded++;
                }
                return true;
            };
            FunctionDefInstruction.prototype.getParameListForShaderInput = function () {
                return this._pParamListForShaderInput;
            };
            FunctionDefInstruction.prototype.isComplexShaderInput = function () {
                return this._isComplexShaderInput;
            };
            FunctionDefInstruction.prototype.clone = function (pRelationMap) {
                if (typeof pRelationMap === "undefined") { pRelationMap = {}; }
                var pClone = _super.prototype.clone.call(this, pRelationMap);
                pClone.setFunctionName(this._pFunctionName.clone(pRelationMap));
                pClone.setReturnType(this.getReturnType().clone(pRelationMap));
                for(var i = 0; i < this._pParameterList.length; i++) {
                    pClone.addParameter(this._pParameterList[i].clone(pRelationMap));
                }
                var pShaderParams = [];
                for(var i = 0; i < this._pParamListForShaderInput.length; i++) {
                    pShaderParams.push(this._pParamListForShaderInput[i].clone(pRelationMap));
                }
                pClone._setShaderParams(pShaderParams, this._isComplexShaderInput);
                pClone._setAnalyzedInfo(this._isAnalyzedForVertexUsage, this._isAnalyzedForPixelUsage, this._bCanUsedAsFunction);
                return pClone;
            };
            FunctionDefInstruction.prototype._setShaderParams = function (pParamList, isComplexInput) {
                this._pParamListForShaderInput = pParamList;
                this._isComplexShaderInput = isComplexInput;
            };
            FunctionDefInstruction.prototype._setAnalyzedInfo = function (isAnalyzedForVertexUsage, isAnalyzedForPixelUsage, bCanUsedAsFunction) {
                this._isAnalyzedForVertexUsage = isAnalyzedForVertexUsage;
                this._isAnalyzedForPixelUsage = isAnalyzedForPixelUsage;
                this._bCanUsedAsFunction = bCanUsedAsFunction;
            };
            FunctionDefInstruction.prototype._getStringDef = function () {
                if (this._sDefinition === "") {
                    this._sDefinition = this._pReturnType.getHash() + " " + this.getName() + "(";
                    for(var i = 0; i < this._pParameterList.length; i++) {
                        this._sDefinition += this._pParameterList[i].getType().getHash() + ",";
                    }
                    this._sDefinition += ")";
                }
                return this._sDefinition;
            };
            FunctionDefInstruction.prototype._canUsedAsFunction = function () {
                return this._bCanUsedAsFunction;
            };
            FunctionDefInstruction.prototype._checkForVertexUsage = function () {
                if (this._isAnalyzedForVertexUsage) {
                    return this._isForVertex();
                }
                this._isAnalyzedForVertexUsage = true;
                var isGood = true;
                isGood = this.checkReturnTypeForVertexUsage();
                if (!isGood) {
                    this._setForVertex(false);
                    return false;
                }
                isGood = this.checkArgumentsForVertexUsage();
                if (!isGood) {
                    this._setForVertex(false);
                    return false;
                }
                this._setForVertex(true);
                return true;
            };
            FunctionDefInstruction.prototype._checkForPixelUsage = function () {
                if (this._isAnalyzedForPixelUsage) {
                    return this._isForPixel();
                }
                this._isAnalyzedForPixelUsage = true;
                var isGood = true;
                isGood = this.checkReturnTypeForPixelUsage();
                if (!isGood) {
                    this._setForPixel(false);
                    return false;
                }
                isGood = this.checkArgumentsForPixelUsage();
                if (!isGood) {
                    this._setForPixel(false);
                    return false;
                }
                this._setForPixel(true);
                return true;
            };
            FunctionDefInstruction.prototype.checkReturnTypeForVertexUsage = function () {
                var pReturnType = this._pReturnType;
                var isGood = true;
                if (pReturnType.isEqual(fx.getEffectBaseType("void"))) {
                    return true;
                }
                if (pReturnType.isComplex()) {
                    isGood = !pReturnType.hasFieldWithoutSemantic();
                    if (!isGood) {
                        return false;
                    }
                    isGood = pReturnType.hasAllUniqueSemantics();
                    if (!isGood) {
                        return false;
                    }
                    isGood = !pReturnType._containSampler();
                    if (!isGood) {
                        return false;
                    }
                    isGood = !pReturnType._containPointer() && !pReturnType.isPointer();
                    if (!isGood) {
                        return false;
                    }
                    isGood = !pReturnType._containComplexType();
                    if (!isGood) {
                        return false;
                    }
                    return true;
                } else {
                    isGood = pReturnType.isEqual(fx.getEffectBaseType("float4"));
                    if (!isGood) {
                        return false;
                    }
                    isGood = (this.getSemantic() === "POSITION");
                    if (!isGood) {
                        return false;
                    }
                    return true;
                }
            };
            FunctionDefInstruction.prototype.checkReturnTypeForPixelUsage = function () {
                var pReturnType = this._pReturnType;
                var isGood = true;
                if (pReturnType.isEqual(fx.getEffectBaseType("void"))) {
                    return true;
                }
                isGood = pReturnType.isBase();
                if (!isGood) {
                    return false;
                }
                isGood = pReturnType.isEqual(fx.getEffectBaseType("float4"));
                if (!isGood) {
                    return false;
                }
                isGood = this.getSemantic() === "COLOR";
                if (!isGood) {
                    return false;
                }
                return true;
            };
            FunctionDefInstruction.prototype.checkArgumentsForVertexUsage = function () {
                var pArguments = this._pParameterList;
                var isAttributeByStruct = false;
                var isAttributeByParams = false;
                var isStartAnalyze = false;
                this._pParamListForShaderInput = [];
                this._pParamListForShaderCompile = [];
                for(var i = 0; i < pArguments.length; i++) {
                    var pParam = pArguments[i];
                    if (pParam.isUniform()) {
                        this._pParamListForShaderCompile.push(pParam);
                        continue;
                    }
                    if (!isStartAnalyze) {
                        if (pParam.getSemantic() === "") {
                            if (pParam.getType().isBase() || pParam.getType().hasFieldWithoutSemantic() || !pParam.getType().hasAllUniqueSemantics()) {
                                return false;
                            }
                            isAttributeByStruct = true;
                        } else if (pParam.getSemantic() !== "") {
                            if (pParam.getType().isComplex() && (pParam.getType().hasFieldWithoutSemantic() || !pParam.getType().hasAllUniqueSemantics())) {
                                return false;
                            }
                            isAttributeByParams = true;
                        }
                        isStartAnalyze = true;
                    } else if (isAttributeByStruct) {
                        return false;
                    } else if (isAttributeByParams) {
                        if (pParam.getSemantic() === "") {
                            return false;
                        }
                        if (pParam.getType().isComplex() && (pParam.getType().hasFieldWithoutSemantic() || !pParam.getType().hasAllUniqueSemantics())) {
                            return false;
                        }
                    }
                    this._pParamListForShaderInput.push(pParam);
                }
                if (isAttributeByStruct) {
                    this._isComplexShaderInput = true;
                }
                return true;
            };
            FunctionDefInstruction.prototype.checkArgumentsForPixelUsage = function () {
                var pArguments = this._pParameterList;
                var isVaryingsByStruct = false;
                var isVaryingsByParams = false;
                var isStartAnalyze = false;
                this._pParamListForShaderInput = [];
                this._pParamListForShaderCompile = [];
                for(var i = 0; i < pArguments.length; i++) {
                    var pParam = pArguments[i];
                    if (pParam.isUniform()) {
                        this._pParamListForShaderCompile.push(pParam);
                        continue;
                    }
                    if (!isStartAnalyze) {
                        if (pParam.getSemantic() === "") {
                            if (pParam.getType().isBase() || pParam.getType().hasFieldWithoutSemantic() || !pParam.getType().hasAllUniqueSemantics() || pParam.getType()._containSampler() || pParam.getType()._containPointer() || pParam.getType().isPointer()) {
                                return false;
                            }
                            isVaryingsByStruct = true;
                        } else if (pParam.getSemantic() !== "") {
                            if (pParam.getType().isPointer() || pParam.getType()._containPointer() || pParam.getType()._containSampler() || fx.isSamplerType(pParam.getType())) {
                                return false;
                            }
                            if (pParam.getType().isComplex() && (pParam.getType().hasFieldWithoutSemantic() || !pParam.getType().hasAllUniqueSemantics())) {
                                return false;
                            }
                            isVaryingsByParams = true;
                        }
                        isStartAnalyze = true;
                    } else if (isVaryingsByStruct) {
                        return false;
                    } else if (isVaryingsByParams) {
                        if (pParam.getSemantic() === "") {
                            return false;
                        }
                        if (pParam.getType().isPointer() || pParam.getType()._containPointer() || pParam.getType()._containSampler() || fx.isSamplerType(pParam.getType())) {
                            return false;
                        }
                        if (pParam.getType().isComplex() && (pParam.getType().hasFieldWithoutSemantic() || !pParam.getType().hasAllUniqueSemantics())) {
                            return false;
                        }
                    }
                    this._pParamListForShaderInput.push(pParam);
                }
                if (isVaryingsByStruct) {
                    this._isComplexShaderInput = true;
                }
                return true;
            };
            return FunctionDefInstruction;
        })(fx.DeclInstruction);
        fx.FunctionDefInstruction = FunctionDefInstruction;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var Effect = (function () {
            function Effect(pComposer) {
                this._pComposer = null;
                this._pParseTree = null;
                this._pAnalyzedNode = null;
                this._pEffectScope = null;
                this._pCurrentInstruction = null;
                this._pCurrentFunction = null;
                this._pStatistics = null;
                this._sAnalyzedFileName = "";
                this._pSystemMacros = null;
                this._pSystemTypes = null;
                this._pSystemFunctionsMap = null;
                this._pSystemFunctionHashMap = null;
                this._pSystemVariables = null;
                this._pPointerForExtractionList = null;
                this._pFunctionWithImplementationList = null;
                this._pTechniqueList = null;
                this._pTechniqueMap = null;
                this._isAnalyzeInPass = false;
                this._sProvideNameSpace = "";
                this._pGlobalComponentList = null;
                this._pGlobalComponetShiftList = null;
                this._pAddedTechniqueList = null;
                this._pComposer = pComposer;
                this._pParseTree = null;
                this._pAnalyzedNode = null;
                this._pEffectScope = new fx.ProgramScope();
                this._pCurrentInstruction = null;
                this._pStatistics = null;
                this._sAnalyzedFileName = "";
                this._pPointerForExtractionList = [];
                this._pFunctionWithImplementationList = [];
                this._pTechniqueList = [];
                this._pTechniqueMap = {};
                this.initSystemMacros();
                this.initSystemTypes();
                this.initSystemFunctions();
                this.initSystemVariables();
            }
            Effect.pSystemMacros = null;
            Effect.pSystemTypes = null;
            Effect.pSystemFunctions = null;
            Effect.pSystemVariables = null;
            Effect.pSystemVertexOut = null;
            Effect.prototype.analyze = function (pTree) {
                var pRootNode = pTree.root;
                var iParseTime = akra.now();
                this._pParseTree = pTree;
                this._pStatistics = {
                    time: 0
                };
                try  {
                    this.newScope();
                    this.analyzeGlobalUseDecls();
                    this.analyzeGlobalProvideDecls();
                    this.analyzeGlobalTypeDecls();
                    this.analyzeFunctionDefinitions();
                    this.analyzeGlobalImports();
                    this.analyzeTechniqueImports();
                    this.analyzeVariableDecls();
                    this.analyzeFunctionDecls();
                    this.analyzeTechniques();
                    this.endScope();
                } catch (e) {
                    throw e;
                }
                iParseTime = akra.now() - iParseTime;
                this._pStatistics.time = iParseTime;
                return true;
            };
            Effect.prototype.getStats = function () {
                return this._pStatistics;
            };
            Effect.prototype.setAnalyzedFileName = function (sFileName) {
                this._sAnalyzedFileName = sFileName;
            };
            Effect.prototype.clear = function () {
            };
            Effect.prototype.getTechniqueList = function () {
                return this._pTechniqueList;
            };
            Effect.getBaseVertexOutType = function getBaseVertexOutType() {
                return Effect.pSystemVertexOut;
            };
            Effect.getSystemType = function getSystemType(sTypeName) {
                return ((Effect.pSystemTypes[sTypeName]) !== undefined) ? Effect.pSystemTypes[sTypeName] : null;
            };
            Effect.getSystemVariable = function getSystemVariable(sName) {
                return ((Effect.pSystemVariables[sName]) !== undefined) ? Effect.pSystemVariables[sName] : null;
            };
            Effect.getSystemMacros = function getSystemMacros(sName) {
                return ((Effect.pSystemMacros[sName]) !== undefined) ? Effect.pSystemMacros[sName] : null;
            };
            Effect.findSystemFunction = function findSystemFunction(sFunctionName, pArguments) {
                var pSystemFunctions = Effect.pSystemFunctions[sFunctionName];
                if (!((pSystemFunctions) !== undefined)) {
                    return null;
                }
                if (((pArguments) === null)) {
                    for(var i = 0; i < pSystemFunctions.length; i++) {
                        if (pSystemFunctions[i].getNumNeededArguments() === 0) {
                            return pSystemFunctions[i];
                        }
                    }
                }
                for(var i = 0; i < pSystemFunctions.length; i++) {
                    if (pArguments.length !== pSystemFunctions[i].getNumNeededArguments()) {
                        continue;
                    }
                    var pTestedArguments = pSystemFunctions[i].getArguments();
                    var isOk = true;
                    for(var j = 0; j < pArguments.length; j++) {
                        isOk = false;
                        if (!pArguments[j].getType().isEqual(pTestedArguments[j].getType())) {
                            break;
                        }
                        isOk = true;
                    }
                    if (isOk) {
                        return pSystemFunctions[i];
                    }
                }
            };
            Effect.createVideoBufferVariable = function createVideoBufferVariable() {
                var pBuffer = new fx.VariableDeclInstruction();
                var pBufferType = new fx.VariableTypeInstruction();
                var pBufferName = new fx.IdInstruction();
                pBufferType.pushType(Effect.getSystemType("video_buffer"));
                pBuffer.push(pBufferType, true);
                pBuffer.push(pBufferName, true);
                return pBuffer;
            };
            Effect.prototype.generateSuffixLiterals = function (pLiterals, pOutput, iDepth) {
                if (typeof iDepth === "undefined") { iDepth = 0; }
                if (iDepth >= pLiterals.length) {
                    return;
                }
                if (iDepth === 0) {
                    for(var i = 0; i < pLiterals.length; i++) {
                        pOutput[pLiterals[i]] = true;
                    }
                    iDepth = 1;
                }
                var pOutputKeys = Object.keys(pOutput);
                for(var i = 0; i < pLiterals.length; i++) {
                    for(var j = 0; j < pOutputKeys.length; j++) {
                        if (pOutputKeys[j].indexOf(pLiterals[i]) !== -1) {
                            pOutput[pOutputKeys[j] + pLiterals[i]] = false;
                        } else {
                            pOutput[pOutputKeys[j] + pLiterals[i]] = (pOutput[pOutputKeys[j]] === false) ? false : true;
                        }
                    }
                }
                iDepth++;
                this.generateSuffixLiterals(pLiterals, pOutput, iDepth);
            };
            Effect.prototype.initSystemMacros = function () {
                if (((Effect.pSystemMacros) === null)) {
                    this._pSystemMacros = Effect.pSystemMacros = {};
                    this.addSystemMacros();
                }
                this._pSystemMacros = Effect.pSystemMacros;
            };
            Effect.prototype.initSystemTypes = function () {
                if (((Effect.pSystemTypes) === null)) {
                    this._pSystemTypes = Effect.pSystemTypes = {};
                    this.addSystemTypeScalar();
                    this.addSystemTypeVector();
                    this.addSystemTypeMatrix();
                    this.generateBaseVertexOutput();
                }
                this._pSystemTypes = Effect.pSystemTypes;
            };
            Effect.prototype.initSystemFunctions = function () {
                if (((Effect.pSystemFunctions) === null)) {
                    this._pSystemFunctionsMap = Effect.pSystemFunctions = {};
                    this.addSystemFunctions();
                }
                this._pSystemFunctionsMap = Effect.pSystemFunctions;
            };
            Effect.prototype.initSystemVariables = function () {
                if (((Effect.pSystemVariables) === null)) {
                    this._pSystemVariables = Effect.pSystemVariables = {};
                    this.addSystemVariables();
                }
                this._pSystemVariables = Effect.pSystemVariables;
            };
            Effect.prototype.addSystemMacros = function () {
                this.generateSystemMacros("ExtractMacros", "\n#ifdef AKRA_FRAGMENT\n" + "//#define texture2D(sampler, ) texture2D\n" + "#else\n" + "#define texture2D(A, B) texture2DLod(A, B, 0.)\n" + "#endif\n" + "#ifndef A_VB_COMPONENT3\n" + "#define A_VB_COMPONENT4\n" + "#endif\n" + "#ifdef A_VB_COMPONENT4\n" + "#define A_VB_ELEMENT_SIZE 4.\n" + "#endif\n" + "#ifdef A_VB_COMPONENT3\n" + "#define A_VB_ELEMENT_SIZE 3.\n" + "#endif\n" + "#define A_tex2D(S, H, X, Y) texture2D(S, vec2(H.stepX * X , H.stepY * Y))\n" + "#define A_tex2Dv(S, H, V) texture2D(S, V)\n");
            };
            Effect.prototype.addSystemVariables = function () {
                this.generateSystemVariable("fragCoord", "gl_FragCoord", "float4", false, true, true);
                this.generateSystemVariable("frontFacing", "gl_FrontFacing", "bool", false, true, true);
                this.generateSystemVariable("pointCoord", "gl_PointCoord", "float2", false, true, true);
                this.generatePassEngineVariable();
            };
            Effect.prototype.generateSystemVariable = function (sName, sRealName, sTypeName, isForVertex, isForPixel, isOnlyRead) {
                if (((this._pSystemVariables[sName]) !== undefined)) {
                    return;
                }
                var pVariableDecl = new fx.VariableDeclInstruction();
                var pName = new fx.IdInstruction();
                var pType = new fx.VariableTypeInstruction();
                pName.setName(sName);
                pName.setRealName(sRealName);
                pType.pushType(Effect.getSystemType(sTypeName));
                if (isOnlyRead) {
                    pType._canWrite(false);
                }
                pVariableDecl._setForVertex(isForVertex);
                pVariableDecl._setForPixel(isForPixel);
                pVariableDecl.push(pType, true);
                pVariableDecl.push(pName, true);
                this._pSystemVariables[sName] = pVariableDecl;
                pVariableDecl.setBuiltIn(true);
            };
            Effect.prototype.generatePassEngineVariable = function () {
                var pVariableDecl = new fx.VariableDeclInstruction();
                var pName = new fx.IdInstruction();
                var pType = new fx.VariableTypeInstruction();
                pType._canWrite(false);
                pType._markAsUnverifiable(true);
                pName.setName("engine");
                pName.setRealName("engine");
                pVariableDecl.push(pType, true);
                pVariableDecl.push(pName, true);
                this._pSystemVariables["engine"] = pVariableDecl;
            };
            Effect.prototype.generateBaseVertexOutput = function () {
                var pOutBasetype = new fx.ComplexTypeInstruction();
                var pPosition = new fx.VariableDeclInstruction();
                var pPointSize = new fx.VariableDeclInstruction();
                var pPositionType = new fx.VariableTypeInstruction();
                var pPointSizeType = new fx.VariableTypeInstruction();
                var pPositionId = new fx.IdInstruction();
                var pPointSizeId = new fx.IdInstruction();
                pPositionType.pushType(Effect.getSystemType("float4"));
                pPointSizeType.pushType(Effect.getSystemType("float"));
                pPositionId.setName("pos");
                pPositionId.setRealName("POSITION");
                pPointSizeId.setName("psize");
                pPointSizeId.setRealName("PSIZE");
                pPosition.push(pPositionType, true);
                pPosition.push(pPositionId, true);
                pPointSize.push(pPointSizeType, true);
                pPointSize.push(pPointSizeId, true);
                pPosition.setSemantic("POSITION");
                pPointSize.setSemantic("PSIZE");
                var pFieldCollector = new fx.InstructionCollector();
                pFieldCollector.push(pPosition, false);
                pFieldCollector.push(pPointSize, false);
                pOutBasetype.addFields(pFieldCollector, true);
                pOutBasetype.setName("VS_OUT");
                pOutBasetype.setRealName("VS_OUT_S");
                Effect.pSystemVertexOut = pOutBasetype;
            };
            Effect.prototype.addSystemFunctions = function () {
                this._pSystemFunctionHashMap = {};
                this.generateSystemFunction("dot", "dot($1,$2)", "float", [
                    "template", 
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("mul", "$1*$2", "template", [
                    "template", 
                    "template"
                ], [
                    "float", 
                    "int", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("mod", "mod($1,$2)", "float", [
                    "float", 
                    "float"
                ], null);
                this.generateSystemFunction("floor", "floor($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("ceil", "ceil($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("fract", "fract($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("abs", "abs($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("normalize", "normalize($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("length", "length($1)", "float", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("cross", "cross($1, $2)", "float3", [
                    "float3", 
                    "float3"
                ], null);
                this.generateSystemFunction("reflect", "reflect($1,$2)", "template", [
                    "template", 
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("max", "max($1,$2)", "template", [
                    "template", 
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("max", "max($1,$2)", "template", [
                    "template", 
                    "float"
                ], [
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("min", "min($1,$2)", "template", [
                    "template", 
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("min", "min($1,$2)", "template", [
                    "template", 
                    "float"
                ], [
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("clamp", "clamp($1,$2,$3)", "template", [
                    "template", 
                    "template", 
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("clamp", "clamp($1,$2,$3)", "template", [
                    "template", 
                    "float", 
                    "float"
                ], [
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("pow", "pow($1,$2)", "template", [
                    "template", 
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("mod", "mod($1,$2)", "template", [
                    "template", 
                    "template"
                ], [
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("mod", "mod($1,$2)", "template", [
                    "template", 
                    "float"
                ], [
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("exp", "exp($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("exp2", "exp2($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("log", "log($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("log2", "log2($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("inversesqrt", "inversesqrt($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("sqrt", "sqrt($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("all", "all($1)", "bool", [
                    "template"
                ], [
                    "bool2", 
                    "bool3", 
                    "bool4"
                ]);
                this.generateSystemFunction("any", "any($1)", "bool", [
                    "template"
                ], [
                    "bool2", 
                    "bool3", 
                    "bool4"
                ]);
                this.generateSystemFunction("not", "not($1)", "template", [
                    "template"
                ], [
                    "bool2", 
                    "bool3", 
                    "bool4"
                ]);
                this.generateSystemFunction("lessThan", "lessThan($1,$2)", "bool2", [
                    "template", 
                    "template"
                ], [
                    "float2", 
                    "int2"
                ]);
                this.generateSystemFunction("lessThan", "lessThan($1,$2)", "bool3", [
                    "template", 
                    "template"
                ], [
                    "float3", 
                    "int3"
                ]);
                this.generateSystemFunction("lessThan", "lessThan($1,$2)", "bool4", [
                    "template", 
                    "template"
                ], [
                    "float4", 
                    "int4"
                ]);
                this.generateSystemFunction("lessThanEqual", "lessThanEqual($1,$2)", "bool2", [
                    "template", 
                    "template"
                ], [
                    "float2", 
                    "int2"
                ]);
                this.generateSystemFunction("lessThanEqual", "lessThanEqual($1,$2)", "bool3", [
                    "template", 
                    "template"
                ], [
                    "float3", 
                    "int3"
                ]);
                this.generateSystemFunction("lessThanEqual", "lessThanEqual($1,$2)", "bool4", [
                    "template", 
                    "template"
                ], [
                    "float4", 
                    "int4"
                ]);
                this.generateSystemFunction("equal", "equal($1,$2)", "bool2", [
                    "template", 
                    "template"
                ], [
                    "float2", 
                    "int2"
                ]);
                this.generateSystemFunction("equal", "equal($1,$2)", "bool3", [
                    "template", 
                    "template"
                ], [
                    "float3", 
                    "int3"
                ]);
                this.generateSystemFunction("equal", "equal($1,$2)", "bool4", [
                    "template", 
                    "template"
                ], [
                    "float4", 
                    "int4"
                ]);
                this.generateSystemFunction("equal", "equal($1,$2)", "template", [
                    "template", 
                    "template"
                ], [
                    "bool2", 
                    "bool3", 
                    "bool4"
                ]);
                this.generateSystemFunction("notEqual", "notEqual($1,$2)", "bool2", [
                    "template", 
                    "template"
                ], [
                    "float2", 
                    "int2"
                ]);
                this.generateSystemFunction("notEqual", "notEqual($1,$2)", "bool3", [
                    "template", 
                    "template"
                ], [
                    "float3", 
                    "int3"
                ]);
                this.generateSystemFunction("notEqual", "notEqual($1,$2)", "bool4", [
                    "template", 
                    "template"
                ], [
                    "float4", 
                    "int4"
                ]);
                this.generateSystemFunction("notEqual", "notEqual($1,$2)", "template", [
                    "template", 
                    "template"
                ], [
                    "bool2", 
                    "bool3", 
                    "bool4"
                ]);
                this.generateSystemFunction("greaterThan", "greaterThan($1,$2)", "bool2", [
                    "template", 
                    "template"
                ], [
                    "float2", 
                    "int2"
                ]);
                this.generateSystemFunction("greaterThan", "greaterThan($1,$2)", "bool3", [
                    "template", 
                    "template"
                ], [
                    "float3", 
                    "int3"
                ]);
                this.generateSystemFunction("greaterThan", "greaterThan($1,$2)", "bool4", [
                    "template", 
                    "template"
                ], [
                    "float4", 
                    "int4"
                ]);
                this.generateSystemFunction("greaterThanEqual", "greaterThanEqual($1,$2)", "bool2", [
                    "template", 
                    "template"
                ], [
                    "float2", 
                    "int2"
                ]);
                this.generateSystemFunction("greaterThanEqual", "greaterThanEqual($1,$2)", "bool3", [
                    "template", 
                    "template"
                ], [
                    "float3", 
                    "int3"
                ]);
                this.generateSystemFunction("greaterThanEqual", "greaterThanEqual($1,$2)", "bool4", [
                    "template", 
                    "template"
                ], [
                    "float4", 
                    "int4"
                ]);
                this.generateSystemFunction("radians", "radians($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("degrees", "degrees($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("sin", "sin($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("cos", "cos($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("tan", "tan($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("asin", "asin($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("acos", "acos($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("atan", "atan($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("atan", "atan($1, $2)", "template", [
                    "template", 
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("tex2D", "texture2D($1,$2)", "float4", [
                    "sampler", 
                    "float2"
                ], null);
                this.generateSystemFunction("tex2D", "texture2D($1,$2)", "float4", [
                    "sampler2D", 
                    "float2"
                ], null);
                this.generateSystemFunction("tex2DProj", "texture2DProj($1,$2)", "float4", [
                    "sampler", 
                    "float3"
                ], null);
                this.generateSystemFunction("tex2DProj", "texture2DProj($1,$2)", "float4", [
                    "sampler2D", 
                    "float3"
                ], null);
                this.generateSystemFunction("tex2DProj", "texture2DProj($1,$2)", "float4", [
                    "sampler", 
                    "float4"
                ], null);
                this.generateSystemFunction("tex2DProj", "texture2DProj($1,$2)", "float4", [
                    "sampler2D", 
                    "float4"
                ], null);
                this.generateSystemFunction("texCUBE", "textureCube($1,$2)", "float4", [
                    "sampler", 
                    "float3"
                ], null);
                this.generateSystemFunction("texCUBE", "textureCube($1,$2)", "float4", [
                    "samplerCUBE", 
                    "float3"
                ], null);
                this.generateSystemFunction("tex2D", "texture2D($1,$2,$3)", "float4", [
                    "sampler", 
                    "float2", 
                    "float"
                ], null, false, true);
                this.generateSystemFunction("tex2D", "texture2D($1,$2,$3)", "float4", [
                    "sampler2D", 
                    "float2", 
                    "float"
                ], null, false, true);
                this.generateSystemFunction("tex2DProj", "texture2DProj($1,$2,$3)", "float4", [
                    "sampler", 
                    "float3", 
                    "float"
                ], null, false, true);
                this.generateSystemFunction("tex2DProj", "texture2DProj($1,$2,$3)", "float4", [
                    "sampler2D", 
                    "float3", 
                    "float"
                ], null, false, true);
                this.generateSystemFunction("tex2DProj", "texture2DProj($1,$2,$3)", "float4", [
                    "sampler", 
                    "float4", 
                    "float"
                ], null, false, true);
                this.generateSystemFunction("tex2DProj", "texture2DProj($1,$2,$3)", "float4", [
                    "sampler2D", 
                    "float4", 
                    "float"
                ], null, false, true);
                this.generateSystemFunction("texCUBE", "textureCube($1,$2,$3)", "float4", [
                    "sampler", 
                    "float3", 
                    "float"
                ], null, false, true);
                this.generateSystemFunction("texCUBE", "textureCube($1,$2,$3)", "float4", [
                    "samplerCUBE", 
                    "float3", 
                    "float"
                ], null, false, true);
                this.generateSystemFunction("tex2DLod", "texture2DLod($1,$2,$3)", "float4", [
                    "sampler", 
                    "float2", 
                    "float"
                ], null, true, false);
                this.generateSystemFunction("tex2DLod", "texture2DLod($1,$2,$3)", "float4", [
                    "sampler2D", 
                    "float2", 
                    "float"
                ], null, true, false);
                this.generateSystemFunction("tex2DProjLod", "texture2DProjLod($1,$2,$3)", "float4", [
                    "sampler", 
                    "float3", 
                    "float"
                ], null, true, false);
                this.generateSystemFunction("tex2DProjLod", "texture2DProjLod($1,$2,$3)", "float4", [
                    "sampler2D", 
                    "float3", 
                    "float"
                ], null, true, false);
                this.generateSystemFunction("tex2DProjLod", "texture2DProjLod($1,$2,$3)", "float4", [
                    "sampler", 
                    "float4", 
                    "float"
                ], null, true, false);
                this.generateSystemFunction("tex2DProjLod", "texture2DProjLod($1,$2,$3)", "float4", [
                    "sampler2D", 
                    "float4", 
                    "float"
                ], null, true, false);
                this.generateSystemFunction("texCUBELod", "textureCubeLod($1,$2,$3)", "float4", [
                    "sampler", 
                    "float3", 
                    "float"
                ], null, true, false);
                this.generateSystemFunction("texCUBELod", "textureCubeLod($1,$2,$3)", "float4", [
                    "samplerCUBE", 
                    "float3", 
                    "float"
                ], null, true, false);
                this.generateSystemFunction("dFdx", "dFdx($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("dFdy", "dFdy($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateSystemFunction("width", "width($1)", "template", [
                    "template"
                ], [
                    "float", 
                    "float2", 
                    "float3", 
                    "float4"
                ]);
                this.generateNotBuiltInSystemFuction("extractHeader", "void A_extractTextureHeader(const sampler2D src, out A_TextureHeader texture)", "{vec4 v = texture2D(src, vec2(0.00001)); " + "texture = A_TextureHeader(v.r, v.g, v.b, v.a);}", "void", [
                    "video_buffer_header"
                ], null, [
                    "ExtractMacros"
                ]);
                this.generateNotBuiltInSystemFuction("extractFloat", "float A_extractFloat(const sampler2D sampler, const A_TextureHeader header, const float offset)", "{float pixelNumber = floor(offset / A_VB_ELEMENT_SIZE); " + "float y = floor(pixelNumber / header.width) + .5; " + "float x = mod(pixelNumber, header.width) + .5; " + "int shift = int(mod(offset, A_VB_ELEMENT_SIZE)); " + "\n#ifdef A_VB_COMPONENT4\n" + "if(shift == 0) return A_tex2D(sampler, header, x, y).r; " + "else if(shift == 1) return A_tex2D(sampler, header, x, y).g; " + "else if(shift == 2) return A_tex2D(sampler, header, x, y).b; " + "else if(shift == 3) return A_tex2D(sampler, header, x, y).a; " + "\n#endif\n" + "return 0.;}", "float", [
                    "video_buffer_header"
                ], [
                    "extractHeader"
                ], [
                    "ExtractMacros"
                ]);
                this.generateNotBuiltInSystemFuction("extractFloat2", "vec2 A_extractVec2(const sampler2D sampler, const A_TextureHeader header, const float offset)", "{float pixelNumber = floor(offset / A_VB_ELEMENT_SIZE); " + "float y = floor(pixelNumber / header.width) + .5; " + "float x = mod(pixelNumber, header.width) + .5; " + "int shift = int(mod(offset, A_VB_ELEMENT_SIZE)); " + "\n#ifdef A_VB_COMPONENT4\n" + "if(shift == 0) return A_tex2D(sampler, header, x, y).rg; " + "else if(shift == 1) return A_tex2D(sampler, header, x, y).gb; " + "else if(shift == 2) return A_tex2D(sampler, header, x, y).ba; " + "else if(shift == 3) { " + "if(int(x) == int(header.width - 1.)) " + "return vec2(A_tex2D(sampler, header, x, y).a, A_tex2D(sampler, header, 0., (y + 1.)).r); " + "else " + "return vec2(A_tex2D(sampler, header, x, y).a, A_tex2D(sampler, header, (x + 1.), y).r); " + "} " + "\n#endif\n" + "return vec2(0.);}", "float2", [
                    "video_buffer_header"
                ], [
                    "extractHeader"
                ], [
                    "ExtractMacros"
                ]);
                this.generateNotBuiltInSystemFuction("extractFloat3", "vec3 A_extractVec3(const sampler2D sampler, const A_TextureHeader header, const float offset)", "{float pixelNumber = floor(offset / A_VB_ELEMENT_SIZE); " + "float y = floor(pixelNumber / header.width) + .5; " + "float x = mod(pixelNumber, header.width) + .5; " + "int shift = int(mod(offset, A_VB_ELEMENT_SIZE)); " + "\n#ifdef A_VB_COMPONENT4\n" + "if(shift == 0) return A_tex2D(sampler, header, x, y).rgb; " + "else if(shift == 1) return A_tex2D(sampler, header, x, y).gba; " + "else if(shift == 2){ " + "if(int(x) == int(header.width - 1.))  return vec3(A_tex2D(sampler, header, x, y).ba, A_tex2D(sampler, header, 0., (y + 1.)).r); " + "else return vec3(A_tex2D(sampler, header, x, y).ba, A_tex2D(sampler, header, (x + 1.), y).r);} " + "else if(shift == 3){ " + "if(int(x) == int(header.width - 1.))  return vec3(A_tex2D(sampler, header, x, y).a, A_tex2D(sampler, header, 0., (y + 1.)).rg); " + "else return vec3(A_tex2D(sampler, header, x, y).a, A_tex2D(sampler, header, (x + 1.), y).rg);} " + "\n#endif\n" + "\n#ifdef A_VB_COMPONENT3\n" + "if(shift == 0) return A_tex2D(sampler, header,vec2(x,header.stepY*y)).rgb; " + "else if(shift == 1){ " + "if(x == header.width - 1.) return vec3(A_tex2D(sampler, header, x, y).gb, A_tex2D(sampler, header, 0., (y + 1.)).r); " + "else return vec3(A_tex2D(sampler, header, x, y).gb, A_tex2D(sampler, header, (x + 1.), y).r);} " + "else if(shift == 3){ " + "if(x == header.width - 1.) return vec3(A_tex2D(sampler, header, x, y).b, A_tex2D(sampler, header, 0., (y + 1.)).rg); " + "else return vec3(A_tex2D(sampler, header, x, y).b, A_tex2D(sampler, header, (x + 1)., y).rg);} " + "\n#endif\n" + "return vec3(0);}", "float3", [
                    "video_buffer_header"
                ], [
                    "extractHeader"
                ], [
                    "ExtractMacros"
                ]);
                this.generateNotBuiltInSystemFuction("extractFloat4", "vec4 A_extractVec4(const sampler2D sampler, const A_TextureHeader header, const float offset)", "{float pixelNumber = floor(offset / A_VB_ELEMENT_SIZE); " + "float y = floor(pixelNumber / header.width) + .5; " + "float x = mod(pixelNumber, header.width) + .5; " + "int shift = int(mod(offset, A_VB_ELEMENT_SIZE)); " + "\n#ifdef A_VB_COMPONENT4\n" + "if(shift == 0) return A_tex2D(sampler, header, x, y); " + "else if(shift == 1){ " + "if(int(x) == int(header.width - 1.)) " + "return vec4(A_tex2D(sampler, header, x, y).gba, A_tex2D(sampler, header, 0., (y + 1.)).r); " + "else " + "return vec4(A_tex2D(sampler, header, x, y).gba, A_tex2D(sampler, header, (x + 1.), y).r);} " + "else if(shift == 2){ " + "if(int(x) == int(header.width - 1.)) " + "return vec4(A_tex2D(sampler, header, x, y).ba, A_tex2D(sampler, header, 0., (y + 1.)).rg); " + "else " + "return vec4(A_tex2D(sampler, header, x, y).ba, A_tex2D(sampler, header, (x + 1.), y).rg);} " + "else if(shift == 3){ " + "if(int(x) == int(header.width - 1.)) " + "return vec4(A_tex2D(sampler, header, x, y).a, A_tex2D(sampler, header, 0., (y + 1.)).rgb); " + "else return vec4(A_tex2D(sampler, header, x, y).a, A_tex2D(sampler, header, (x + 1.), y).rgb);} " + "\n#endif\n" + "\n#ifdef A_VB_COMPONENT3\n" + "\n#endif\n" + "return vec4(0);}", "float4", [
                    "video_buffer_header"
                ], [
                    "extractHeader"
                ], [
                    "ExtractMacros"
                ]);
                this.generateNotBuiltInSystemFuction("findPixel", "vec2 A_findPixel(const A_TextureHeader header, const float offset)", "{float pixelNumber = floor(offset / A_VB_ELEMENT_SIZE); " + "return vec2(header.stepX * (mod(pixelNumber, header.width) + .5), header.stepY * (floor(pixelNumber / header.width) + .5));}", "float2", [
                    "video_buffer_header"
                ], [
                    "extractHeader"
                ], [
                    "ExtractMacros"
                ]);
                this.generateNotBuiltInSystemFuction("extractFloat4x4", "mat4 A_extractMat4(const sampler2D sampler, const A_TextureHeader header, const float offset)", "{return mat4(A_tex2Dv(sampler, header, A_findPixel(header, offset))," + "A_tex2Dv(sampler, header, A_findPixel(header, offset + 4.))," + "A_tex2Dv(sampler, header, A_findPixel(header, offset + 8.))," + "A_tex2Dv(sampler, header, A_findPixel(header, offset + 12.)));}", "float4x4", [
                    "video_buffer_header"
                ], [
                    "findPixel"
                ], [
                    "ExtractMacros"
                ]);
            };
            Effect.prototype.generateSystemFunction = function (sName, sTranslationExpr, sReturnTypeName, pArgumentsTypes, pTemplateTypes, isForVertex, isForPixel) {
                if (typeof isForVertex === "undefined") { isForVertex = true; }
                if (typeof isForPixel === "undefined") { isForPixel = true; }
                var pExprTranslator = new fx.ExprTemplateTranslator(sTranslationExpr);
                var pSystemFunctions = this._pSystemFunctionsMap;
                var pTypes = null;
                var sFunctionHash = "";
                var pReturnType = null;
                var pFunction = null;
                if (!((pTemplateTypes) === null)) {
                    for(var i = 0; i < pTemplateTypes.length; i++) {
                        pTypes = [];
                        sFunctionHash = sName + "(";
                        pReturnType = (sReturnTypeName === "template") ? Effect.getSystemType(pTemplateTypes[i]) : Effect.getSystemType(sReturnTypeName);
                        for(var j = 0; j < pArgumentsTypes.length; j++) {
                            if (pArgumentsTypes[j] === "template") {
                                pTypes.push(Effect.getSystemType(pTemplateTypes[i]));
                                sFunctionHash += pTemplateTypes[i] + ",";
                            } else {
                                pTypes.push(Effect.getSystemType(pArgumentsTypes[j]));
                                sFunctionHash += pArgumentsTypes[j] + ",";
                            }
                        }
                        sFunctionHash += ")";
                        if (this._pSystemFunctionHashMap[sFunctionHash]) {
                            this._error(2248, {
                                funcName: sFunctionHash
                            });
                        }
                        pFunction = new fx.SystemFunctionInstruction(sName, pReturnType, pExprTranslator, pTypes);
                        if (!((pSystemFunctions[sName]) !== undefined)) {
                            pSystemFunctions[sName] = [];
                        }
                        pFunction._setForVertex(isForVertex);
                        pFunction._setForPixel(isForPixel);
                        pSystemFunctions[sName].push(pFunction);
                        pFunction.setBuiltIn(true);
                    }
                } else {
                    if (sReturnTypeName === "template") {
                        akra.logger.criticalError("Bad return type(TEMPLATE_TYPE) for system function '" + sName + "'.");
                    }
                    pReturnType = Effect.getSystemType(sReturnTypeName);
                    pTypes = [];
                    sFunctionHash = sName + "(";
                    for(var i = 0; i < pArgumentsTypes.length; i++) {
                        if (pArgumentsTypes[i] === "template") {
                            akra.logger.criticalError("Bad argument type(TEMPLATE_TYPE) for system function '" + sName + "'.");
                        } else {
                            pTypes.push(Effect.getSystemType(pArgumentsTypes[i]));
                            sFunctionHash += pArgumentsTypes[i] + ",";
                        }
                    }
                    sFunctionHash += ")";
                    if (this._pSystemFunctionHashMap[sFunctionHash]) {
                        this._error(2248, {
                            funcName: sFunctionHash
                        });
                    }
                    pFunction = new fx.SystemFunctionInstruction(sName, pReturnType, pExprTranslator, pTypes);
                    pFunction._setForVertex(isForVertex);
                    pFunction._setForPixel(isForPixel);
                    if (!((pSystemFunctions[sName]) !== undefined)) {
                        pSystemFunctions[sName] = [];
                    }
                    pSystemFunctions[sName].push(pFunction);
                    pFunction.setBuiltIn(true);
                }
            };
            Effect.prototype.generateSystemMacros = function (sMacrosName, sMacrosCode) {
                if (((this._pSystemMacros[sMacrosName]) !== undefined)) {
                    return;
                }
                var pMacros = new fx.SimpleInstruction(sMacrosCode);
                this._pSystemMacros[sMacrosName] = pMacros;
            };
            Effect.prototype.generateNotBuiltInSystemFuction = function (sName, sDefenition, sImplementation, sReturnType, pUsedTypes, pUsedFunctions, pUsedMacros) {
                if (((this._pSystemFunctionsMap[sName]) !== undefined)) {
                    return;
                }
                var pReturnType = Effect.getSystemType(sReturnType);
                var pFunction = new fx.SystemFunctionInstruction(sName, pReturnType, null, null);
                pFunction.setDeclCode(sDefenition, sImplementation);
                var pUsedExtSystemTypes = [];
                var pUsedExtSystemFunctions = [];
                var pUsedExtSystemMacros = [];
                if (!((pUsedTypes) === null)) {
                    for(var i = 0; i < pUsedTypes.length; i++) {
                        var pTypeDecl = Effect.getSystemType(pUsedTypes[i]).getParent();
                        if (!((pTypeDecl) === null)) {
                            pUsedExtSystemTypes.push(pTypeDecl);
                        }
                    }
                }
                if (!((pUsedMacros) === null)) {
                    for(var i = 0; i < pUsedMacros.length; i++) {
                        pUsedExtSystemMacros.push(Effect.getSystemMacros(pUsedMacros[i]));
                    }
                }
                if (!((pUsedFunctions) === null)) {
                    for(var i = 0; i < pUsedFunctions.length; i++) {
                        var pFindFunction = Effect.findSystemFunction(pUsedFunctions[i], null);
                        pUsedExtSystemFunctions.push(pFindFunction);
                    }
                }
                pFunction.setUsedSystemData(pUsedExtSystemTypes, pUsedExtSystemFunctions, pUsedExtSystemMacros);
                pFunction.closeSystemDataInfo();
                pFunction.setBuiltIn(false);
                this._pSystemFunctionsMap[sName] = [
                    pFunction
                ];
            };
            Effect.prototype.generateSystemType = function (sName, sRealName, iSize, isArray, pElementType, iLength) {
                if (typeof iSize === "undefined") { iSize = 1; }
                if (typeof isArray === "undefined") { isArray = false; }
                if (typeof pElementType === "undefined") { pElementType = null; }
                if (typeof iLength === "undefined") { iLength = 1; }
                if (((this._pSystemTypes[sName]) !== undefined)) {
                    return null;
                }
                var pSystemType = new fx.SystemTypeInstruction();
                pSystemType.setName(sName);
                pSystemType.setRealName(sRealName);
                pSystemType.setSize(iSize);
                if (isArray) {
                    pSystemType.addIndex(pElementType, iLength);
                }
                this._pSystemTypes[sName] = pSystemType;
                pSystemType.setBuiltIn(true);
                return pSystemType;
            };
            Effect.prototype.generateNotBuildtInSystemType = function (sName, sRealName, sDeclString, iSize, isArray, pElementType, iLength) {
                if (typeof iSize === "undefined") { iSize = 1; }
                if (typeof isArray === "undefined") { isArray = false; }
                if (typeof pElementType === "undefined") { pElementType = null; }
                if (typeof iLength === "undefined") { iLength = 1; }
                if (((this._pSystemTypes[sName]) !== undefined)) {
                    return null;
                }
                var pSystemType = new fx.SystemTypeInstruction();
                pSystemType.setName(sName);
                pSystemType.setRealName(sRealName);
                pSystemType.setSize(iSize);
                pSystemType.setDeclString(sDeclString);
                if (isArray) {
                    pSystemType.addIndex(pElementType, iLength);
                }
                this._pSystemTypes[sName] = pSystemType;
                pSystemType.setBuiltIn(false);
                var pSystemTypeDecl = new fx.TypeDeclInstruction();
                pSystemTypeDecl.push(pSystemType, true);
                pSystemTypeDecl.setBuiltIn(false);
                return pSystemType;
            };
            Effect.prototype.addSystemTypeScalar = function () {
                this.generateSystemType("void", "void", 0);
                this.generateSystemType("int", "int", 1);
                this.generateSystemType("bool", "bool", 1);
                this.generateSystemType("float", "float", 1);
                this.generateSystemType("ptr", "float", 1);
                this.generateSystemType("string", "", 0);
                this.generateSystemType("texture", "", 0);
                this.generateSystemType("sampler", "sampler2D", 1);
                this.generateSystemType("sampler2D", "sampler2D", 1);
                this.generateSystemType("samplerCUBE", "samplerCube", 1);
                this.generateSystemType("video_buffer", "sampler2D", 1);
                this.generateNotBuildtInSystemType("video_buffer_header", "A_TextureHeader", "struct A_TextureHeader { float width; float height; float stepX; float stepY; }");
            };
            Effect.prototype.addSystemTypeVector = function () {
                var pXYSuffix = {};
                var pXYZSuffix = {};
                var pXYZWSuffix = {};
                var pRGSuffix = {};
                var pRGBSuffix = {};
                var pRGBASuffix = {};
                var pSTSuffix = {};
                var pSTPSuffix = {};
                var pSTPQSuffix = {};
                this.generateSuffixLiterals([
                    "x", 
                    "y"
                ], pXYSuffix);
                this.generateSuffixLiterals([
                    "x", 
                    "y", 
                    "z"
                ], pXYZSuffix);
                this.generateSuffixLiterals([
                    "x", 
                    "y", 
                    "z", 
                    "w"
                ], pXYZWSuffix);
                this.generateSuffixLiterals([
                    "r", 
                    "g"
                ], pRGSuffix);
                this.generateSuffixLiterals([
                    "r", 
                    "g", 
                    "b"
                ], pRGBSuffix);
                this.generateSuffixLiterals([
                    "r", 
                    "g", 
                    "b", 
                    "a"
                ], pRGBASuffix);
                this.generateSuffixLiterals([
                    "s", 
                    "t"
                ], pSTSuffix);
                this.generateSuffixLiterals([
                    "s", 
                    "t", 
                    "p"
                ], pSTPSuffix);
                this.generateSuffixLiterals([
                    "s", 
                    "t", 
                    "p", 
                    "q"
                ], pSTPQSuffix);
                var pFloat = Effect.getSystemType("float");
                var pInt = Effect.getSystemType("int");
                var pBool = Effect.getSystemType("bool");
                var pFloat2 = this.generateSystemType("float2", "vec2", 0, true, pFloat, 2);
                var pFloat3 = this.generateSystemType("float3", "vec3", 0, true, pFloat, 3);
                var pFloat4 = this.generateSystemType("float4", "vec4", 0, true, pFloat, 4);
                var pInt2 = this.generateSystemType("int2", "ivec2", 0, true, pInt, 2);
                var pInt3 = this.generateSystemType("int3", "ivec3", 0, true, pInt, 3);
                var pInt4 = this.generateSystemType("int4", "ivec4", 0, true, pInt, 4);
                var pBool2 = this.generateSystemType("bool2", "bvec2", 0, true, pBool, 2);
                var pBool3 = this.generateSystemType("bool3", "bvec3", 0, true, pBool, 3);
                var pBool4 = this.generateSystemType("bool4", "bvec4", 0, true, pBool, 4);
                this.addFieldsToVectorFromSuffixObject(pXYSuffix, pFloat2, "float");
                this.addFieldsToVectorFromSuffixObject(pRGSuffix, pFloat2, "float");
                this.addFieldsToVectorFromSuffixObject(pSTSuffix, pFloat2, "float");
                this.addFieldsToVectorFromSuffixObject(pXYZSuffix, pFloat3, "float");
                this.addFieldsToVectorFromSuffixObject(pRGBSuffix, pFloat3, "float");
                this.addFieldsToVectorFromSuffixObject(pSTPSuffix, pFloat3, "float");
                this.addFieldsToVectorFromSuffixObject(pXYZWSuffix, pFloat4, "float");
                this.addFieldsToVectorFromSuffixObject(pRGBASuffix, pFloat4, "float");
                this.addFieldsToVectorFromSuffixObject(pSTPQSuffix, pFloat4, "float");
                this.addFieldsToVectorFromSuffixObject(pXYSuffix, pInt2, "int");
                this.addFieldsToVectorFromSuffixObject(pRGSuffix, pInt2, "int");
                this.addFieldsToVectorFromSuffixObject(pSTSuffix, pInt2, "int");
                this.addFieldsToVectorFromSuffixObject(pXYZSuffix, pInt3, "int");
                this.addFieldsToVectorFromSuffixObject(pRGBSuffix, pInt3, "int");
                this.addFieldsToVectorFromSuffixObject(pSTPSuffix, pInt3, "int");
                this.addFieldsToVectorFromSuffixObject(pXYZWSuffix, pInt4, "int");
                this.addFieldsToVectorFromSuffixObject(pRGBASuffix, pInt4, "int");
                this.addFieldsToVectorFromSuffixObject(pSTPQSuffix, pInt4, "int");
                this.addFieldsToVectorFromSuffixObject(pXYSuffix, pBool2, "bool");
                this.addFieldsToVectorFromSuffixObject(pRGSuffix, pBool2, "bool");
                this.addFieldsToVectorFromSuffixObject(pSTSuffix, pBool2, "bool");
                this.addFieldsToVectorFromSuffixObject(pXYZSuffix, pBool3, "bool");
                this.addFieldsToVectorFromSuffixObject(pRGBSuffix, pBool3, "bool");
                this.addFieldsToVectorFromSuffixObject(pSTPSuffix, pBool3, "bool");
                this.addFieldsToVectorFromSuffixObject(pXYZWSuffix, pBool4, "bool");
                this.addFieldsToVectorFromSuffixObject(pRGBASuffix, pBool4, "bool");
                this.addFieldsToVectorFromSuffixObject(pSTPQSuffix, pBool4, "bool");
            };
            Effect.prototype.addSystemTypeMatrix = function () {
                var pFloat2 = Effect.getSystemType("float2");
                var pFloat3 = Effect.getSystemType("float3");
                var pFloat4 = Effect.getSystemType("float4");
                var pInt2 = Effect.getSystemType("int2");
                var pInt3 = Effect.getSystemType("int3");
                var pInt4 = Effect.getSystemType("int4");
                var pBool2 = Effect.getSystemType("bool2");
                var pBool3 = Effect.getSystemType("bool3");
                var pBool4 = Effect.getSystemType("bool4");
                this.generateSystemType("float2x2", "mat2", 0, true, pFloat2, 2);
                this.generateSystemType("float2x3", "mat2x3", 0, true, pFloat2, 3);
                this.generateSystemType("float2x4", "mat2x4", 0, true, pFloat2, 4);
                this.generateSystemType("float3x2", "mat3x2", 0, true, pFloat3, 2);
                this.generateSystemType("float3x3", "mat3", 0, true, pFloat3, 3);
                this.generateSystemType("float3x4", "mat3x4", 0, true, pFloat3, 4);
                this.generateSystemType("float4x2", "mat4x2", 0, true, pFloat4, 2);
                this.generateSystemType("float4x3", "mat4x3", 0, true, pFloat4, 3);
                this.generateSystemType("float4x4", "mat4", 0, true, pFloat4, 4);
                this.generateSystemType("int2x2", "imat2", 0, true, pInt2, 2);
                this.generateSystemType("int2x3", "imat2x3", 0, true, pInt2, 3);
                this.generateSystemType("int2x4", "imat2x4", 0, true, pInt2, 4);
                this.generateSystemType("int3x2", "imat3x2", 0, true, pInt3, 2);
                this.generateSystemType("int3x3", "imat3", 0, true, pInt3, 3);
                this.generateSystemType("int3x4", "imat3x4", 0, true, pInt3, 4);
                this.generateSystemType("int4x2", "imat4x2", 0, true, pInt4, 2);
                this.generateSystemType("int4x3", "imat4x3", 0, true, pInt4, 3);
                this.generateSystemType("int4x4", "imat4", 0, true, pInt4, 4);
                this.generateSystemType("bool2x2", "bmat2", 0, true, pBool2, 2);
                this.generateSystemType("bool2x3", "bmat2x3", 0, true, pBool2, 3);
                this.generateSystemType("bool2x4", "bmat2x4", 0, true, pBool2, 4);
                this.generateSystemType("bool3x2", "bmat3x2", 0, true, pBool3, 2);
                this.generateSystemType("bool3x3", "bmat3", 0, true, pBool3, 3);
                this.generateSystemType("bool3x4", "bmat3x4", 0, true, pBool3, 4);
                this.generateSystemType("bool4x2", "bmat4x2", 0, true, pBool4, 2);
                this.generateSystemType("bool4x3", "bmat4x3", 0, true, pBool4, 3);
                this.generateSystemType("bool4x4", "bmat4", 0, true, pBool4, 4);
            };
            Effect.prototype.addFieldsToVectorFromSuffixObject = function (pSuffixMap, pType, sBaseType) {
                var sSuffix = null;
                for(sSuffix in pSuffixMap) {
                    var sFieldTypeName = sBaseType + ((sSuffix.length > 1) ? sSuffix.length.toString() : "");
                    var pFieldType = Effect.getSystemType(sFieldTypeName);
                    (pType).addField(sSuffix, pFieldType, pSuffixMap[sSuffix]);
                }
            };
            Effect.prototype.getVariable = function (sName) {
                return Effect.getSystemVariable(sName) || this._pEffectScope.getVariable(sName);
            };
            Effect.prototype.hasVariable = function (sName) {
                return this._pEffectScope.hasVariable(sName);
            };
            Effect.prototype.getType = function (sTypeName) {
                return Effect.getSystemType(sTypeName) || this._pEffectScope.getType(sTypeName);
            };
            Effect.prototype.isSystemFunction = function (pFunction) {
                return false;
            };
            Effect.prototype.isSystemVariable = function (pVariable) {
                return false;
            };
            Effect.prototype.isSystemType = function (pType) {
                return false;
            };
            Effect.prototype._errorFromInstruction = function (pError) {
                this._error(pError.code, ((pError.info) === null) ? {} : pError.info);
            };
            Effect.prototype._error = function (eCode, pInfo) {
                if (typeof pInfo === "undefined") { pInfo = {}; }
                var sFileName = this._sAnalyzedFileName;
                var pLocation = {
                    file: this._sAnalyzedFileName,
                    line: 0
                };
                var pLineColumn = this.getNodeSourceLocation(this.getAnalyzedNode());
                switch(eCode) {
                    default:
                        pInfo.line = pLineColumn.line + 1;
                        pInfo.column = pLineColumn.column + 1;
                        pLocation.line = pLineColumn.line + 1;
                        break;
                }
                var pLogEntity = {
                    code: eCode,
                    info: pInfo,
                    location: pLocation
                };
                akra.logger["error"](pLogEntity);
                throw new Error(eCode.toString());
            };
            Effect.prototype.setAnalyzedNode = function (pNode) {
                this._pAnalyzedNode = pNode;
            };
            Effect.prototype.getAnalyzedNode = function () {
                return this._pAnalyzedNode;
            };
            Effect.prototype.isStrictMode = function () {
                return this._pEffectScope.isStrictMode();
            };
            Effect.prototype.setStrictModeOn = function () {
                return this._pEffectScope.setStrictModeOn();
            };
            Effect.prototype.newScope = function (eScopeType) {
                if (typeof eScopeType === "undefined") { eScopeType = fx.EScopeType.k_Default; }
                this._pEffectScope.newScope(eScopeType);
            };
            Effect.prototype.resumeScope = function () {
                this._pEffectScope.resumeScope();
            };
            Effect.prototype.getScope = function () {
                return this._pEffectScope.getScope();
            };
            Effect.prototype.setScope = function (iScope) {
                this._pEffectScope.setScope(iScope);
            };
            Effect.prototype.endScope = function () {
                this._pEffectScope.endScope();
            };
            Effect.prototype.getScopeType = function () {
                return this._pEffectScope.getScopeType();
            };
            Effect.prototype.setCurrentAnalyzedFunction = function (pFunction) {
                this._pCurrentFunction = pFunction;
            };
            Effect.prototype.getCurrentAnalyzedFunction = function () {
                return this._pCurrentFunction;
            };
            Effect.prototype.isAnalzeInPass = function () {
                return this._isAnalyzeInPass;
            };
            Effect.prototype.setAnalyzeInPass = function (isInPass) {
                this._isAnalyzeInPass = isInPass;
            };
            Effect.prototype.setOperator = function (sOperator) {
                if (!((this._pCurrentInstruction) === null)) {
                    this._pCurrentInstruction.setOperator(sOperator);
                }
            };
            Effect.prototype.clearPointersForExtract = function () {
                this._pPointerForExtractionList.length = 0;
            };
            Effect.prototype.addPointerForExtract = function (pPointer) {
                this._pPointerForExtractionList.push(pPointer);
            };
            Effect.prototype.getPointerForExtractList = function () {
                return this._pPointerForExtractionList;
            };
            Effect.prototype.findFunction = function (sFunctionName, pArguments) {
                return Effect.findSystemFunction(sFunctionName, pArguments) || this._pEffectScope.getFunction(sFunctionName, pArguments);
            };
            Effect.prototype.findConstructor = function (pType, pArguments) {
                var pVariableType = new fx.VariableTypeInstruction();
                pVariableType.pushType(pType);
                return pVariableType;
            };
            Effect.prototype.findShaderFunction = function (sFunctionName, pArguments) {
                return this._pEffectScope.getShaderFunction(sFunctionName, pArguments);
            };
            Effect.prototype.findFunctionByDef = function (pDef) {
                return this.findFunction(pDef.getName(), pDef.getArguments());
            };
            Effect.prototype.addVariableDecl = function (pVariable) {
                if (this.isSystemVariable(pVariable)) {
                    this._error(2235, {
                        varName: pVariable.getName()
                    });
                }
                var isVarAdded = this._pEffectScope.addVariable(pVariable);
                if (!isVarAdded) {
                    var eScopeType = this.getScopeType();
                    switch(eScopeType) {
                        case fx.EScopeType.k_Default:
                            this._error(2234, {
                                varName: pVariable.getName()
                            });
                            break;
                        case fx.EScopeType.k_Struct:
                            this._error(2242, {
                                fieldName: pVariable.getName()
                            });
                            break;
                        case fx.EScopeType.k_Annotation:
                            this._error(2244, {
                                varName: pVariable.getName()
                            });
                            break;
                    }
                }
                if (pVariable.getName() === "Out" && !((this.getCurrentAnalyzedFunction()) === null)) {
                    var isOk = this.getCurrentAnalyzedFunction()._addOutVariable(pVariable);
                    if (!isOk) {
                        this._error(2266);
                    }
                }
            };
            Effect.prototype.addTypeDecl = function (pType) {
                if (this.isSystemType(pType)) {
                    this._error(2201, {
                        typeName: pType.getName()
                    });
                }
                var isTypeAdded = this._pEffectScope.addType(pType);
                if (!isTypeAdded) {
                    this._error(2202, {
                        typeName: pType.getName()
                    });
                }
            };
            Effect.prototype.addFunctionDecl = function (pFunction) {
                if (this.isSystemFunction(pFunction)) {
                    this._error(2237, {
                        funcName: pFunction.getName()
                    });
                }
                var isFunctionAdded = this._pEffectScope.addFunction(pFunction);
                if (!isFunctionAdded) {
                    this._error(2236, {
                        funcName: pFunction.getName()
                    });
                }
            };
            Effect.prototype.addTechnique = function (pTechnique) {
                var sName = pTechnique.getName();
                if (((this._pTechniqueMap[sName]) !== undefined)) {
                    this._error(2252, {
                        techName: sName
                    });
                    return;
                }
                this._pTechniqueMap[sName] = pTechnique;
                this._pTechniqueList.push(pTechnique);
            };
            Effect.prototype.addExternalSharedVariable = function (pVariable, eShaderType) {
                var isVarAdded = this._pEffectScope.addVariable(pVariable);
                if (!isVarAdded) {
                    this._error(2278, {
                        varName: pVariable.getName()
                    });
                    return;
                }
            };
            Effect.prototype.analyzeGlobalUseDecls = function () {
                var pChildren = this._pParseTree.root.children;
                var i = 0;
                for(i = pChildren.length - 1; i >= 0; i--) {
                    if (pChildren[i].name === "UseDecl") {
                        this.analyzeUseDecl(pChildren[i]);
                    }
                }
            };
            Effect.prototype.analyzeGlobalProvideDecls = function () {
                var pChildren = this._pParseTree.root.children;
                var i = 0;
                for(i = pChildren.length - 1; i >= 0; i--) {
                    if (pChildren[i].name === "ProvideDecl") {
                        this.analyzeProvideDecl(pChildren[i]);
                    }
                }
            };
            Effect.prototype.analyzeGlobalTypeDecls = function () {
                var pChildren = this._pParseTree.root.children;
                var i = 0;
                for(i = pChildren.length - 1; i >= 0; i--) {
                    if (pChildren[i].name === "TypeDecl") {
                        this.analyzeTypeDecl(pChildren[i]);
                    }
                }
            };
            Effect.prototype.analyzeFunctionDefinitions = function () {
                var pChildren = this._pParseTree.root.children;
                var i = 0;
                for(i = pChildren.length - 1; i >= 0; i--) {
                    if (pChildren[i].name === "FunctionDecl") {
                        this.analyzeFunctionDeclOnlyDefinition(pChildren[i]);
                    }
                }
            };
            Effect.prototype.analyzeGlobalImports = function () {
                var pChildren = this._pParseTree.root.children;
                var i = 0;
                for(i = pChildren.length - 1; i >= 0; i--) {
                    if (pChildren[i].name === "ImportDecl") {
                        this.analyzeImportDecl(pChildren[i], null);
                    }
                }
            };
            Effect.prototype.analyzeTechniqueImports = function () {
                var pChildren = this._pParseTree.root.children;
                var i = 0;
                for(i = pChildren.length - 1; i >= 0; i--) {
                    if (pChildren[i].name === "TechniqueDecl") {
                        this.analyzeTechniqueForImport(pChildren[i]);
                    }
                }
            };
            Effect.prototype.analyzeVariableDecls = function () {
                var pChildren = this._pParseTree.root.children;
                var i = 0;
                for(i = pChildren.length - 1; i >= 0; i--) {
                    if (pChildren[i].name === "VariableDecl") {
                        this.analyzeVariableDecl(pChildren[i]);
                    } else if (pChildren[i].name === "VarStructDecl") {
                        this.analyzeVarStructDecl(pChildren[i]);
                    }
                }
            };
            Effect.prototype.analyzeFunctionDecls = function () {
                for(var i = 0; i < this._pFunctionWithImplementationList.length; i++) {
                    this.resumeFunctionAnalysis(this._pFunctionWithImplementationList[i]);
                }
                this.checkFunctionsForRecursion();
                this.checkFunctionForCorrectUsage();
                this.generateInfoAboutUsedData();
                this.generateShadersFromFunctions();
            };
            Effect.prototype.analyzeTechniques = function () {
                for(var i = 0; i < this._pTechniqueList.length; i++) {
                    this.resumeTechniqueAnalysis(this._pTechniqueList[i]);
                }
            };
            Effect.prototype.checkFunctionsForRecursion = function () {
                var pFunctionList = this._pFunctionWithImplementationList;
                var isNewAdd = true;
                var isNewDelete = true;
                while(isNewAdd || isNewDelete) {
                    isNewAdd = false;
                    isNewDelete = false;
                    mainFor:
for(var i = 0; i < pFunctionList.length; i++) {
                        var pTestedFunction = pFunctionList[i];
                        var pUsedFunctionList = pTestedFunction._getUsedFunctionList();
                        if (!pTestedFunction._isUsed()) {
                            continue mainFor;
                        }
                        if (pTestedFunction._isBlackListFunction()) {
                            continue mainFor;
                        }
                        if (((pUsedFunctionList) === null)) {
                            continue mainFor;
                        }
                        for(var j = 0; j < pUsedFunctionList.length; j++) {
                            var pAddedUsedFunctionList = pUsedFunctionList[j]._getUsedFunctionList();
                            if (((pAddedUsedFunctionList) === null)) {
                                continue;
                            }
                            for(var k = 0; k < pAddedUsedFunctionList.length; k++) {
                                var pAddedFunction = pAddedUsedFunctionList[k];
                                if (pTestedFunction === pAddedFunction) {
                                    pTestedFunction._addToBlackList();
                                    isNewDelete = true;
                                    this._error(2255, {
                                        funcDef: pTestedFunction._getStringDef()
                                    });
                                    continue mainFor;
                                }
                                if (pAddedFunction._isBlackListFunction() || !pAddedFunction._canUsedAsFunction()) {
                                    pTestedFunction._addToBlackList();
                                    this._error(2256, {
                                        funcDef: pTestedFunction._getStringDef()
                                    });
                                    isNewDelete = true;
                                    continue mainFor;
                                }
                                if (pTestedFunction._addUsedFunction(pAddedFunction)) {
                                    isNewAdd = true;
                                }
                            }
                        }
                    }
                }
            };
            Effect.prototype.checkFunctionForCorrectUsage = function () {
                var pFunctionList = this._pFunctionWithImplementationList;
                var isNewUsageSet = true;
                var isNewDelete = true;
                while(isNewUsageSet || isNewDelete) {
                    isNewUsageSet = false;
                    isNewDelete = false;
                    mainFor:
for(var i = 0; i < pFunctionList.length; i++) {
                        var pTestedFunction = pFunctionList[i];
                        var pUsedFunctionList = pTestedFunction._getUsedFunctionList();
                        if (!pTestedFunction._isUsed()) {
                            continue mainFor;
                        }
                        if (pTestedFunction._isBlackListFunction()) {
                            continue mainFor;
                        }
                        if (!pTestedFunction._checkVertexUsage()) {
                            this._error(2257, {
                                funcDef: pTestedFunction._getStringDef()
                            });
                            pTestedFunction._addToBlackList();
                            isNewDelete = true;
                            continue mainFor;
                        }
                        if (!pTestedFunction._checkPixelUsage()) {
                            this._error(2258, {
                                funcDef: pTestedFunction._getStringDef()
                            });
                            pTestedFunction._addToBlackList();
                            isNewDelete = true;
                            continue mainFor;
                        }
                        if (((pUsedFunctionList) === null)) {
                            continue mainFor;
                        }
                        for(var j = 0; j < pUsedFunctionList.length; j++) {
                            var pUsedFunction = pUsedFunctionList[j];
                            if (pTestedFunction._isUsedInVertex()) {
                                if (!pUsedFunction._isForVertex()) {
                                    this._error(2257, {
                                        funcDef: pTestedFunction._getStringDef()
                                    });
                                    pTestedFunction._addToBlackList();
                                    isNewDelete = true;
                                    continue mainFor;
                                }
                                if (!pUsedFunction._isUsedInVertex()) {
                                    pUsedFunction._markUsedInVertex();
                                    isNewUsageSet = true;
                                }
                            }
                            if (pTestedFunction._isUsedInPixel()) {
                                if (!pUsedFunction._isForPixel()) {
                                    this._error(2258, {
                                        funcDef: pTestedFunction._getStringDef()
                                    });
                                    pTestedFunction._addToBlackList();
                                    isNewDelete = true;
                                    continue mainFor;
                                }
                                if (!pUsedFunction._isUsedInPixel()) {
                                    pUsedFunction._markUsedInPixel();
                                    isNewUsageSet = true;
                                }
                            }
                        }
                    }
                }
                return;
            };
            Effect.prototype.generateInfoAboutUsedData = function () {
                var pFunctionList = this._pFunctionWithImplementationList;
                for(var i = 0; i < pFunctionList.length; i++) {
                    pFunctionList[i]._generateInfoAboutUsedData();
                }
            };
            Effect.prototype.generateShadersFromFunctions = function () {
                var pFunctionList = this._pFunctionWithImplementationList;
                for(var i = 0; i < pFunctionList.length; i++) {
                    var pShader = null;
                    if (pFunctionList[i]._isUsedAsVertex()) {
                        pShader = pFunctionList[i]._convertToVertexShader();
                    }
                    if (pFunctionList[i]._isUsedAsPixel()) {
                        pShader = pFunctionList[i]._convertToPixelShader();
                    }
                }
            };
            Effect.prototype.analyzeVariableDecl = function (pNode, pInstruction) {
                if (typeof pInstruction === "undefined") { pInstruction = null; }
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pGeneralType = null;
                var pVariable = null;
                var i = 0;
                pGeneralType = this.analyzeUsageType(pChildren[pChildren.length - 1]);
                for(i = pChildren.length - 2; i >= 1; i--) {
                    if (pChildren[i].name === "Variable") {
                        pVariable = this.analyzeVariable(pChildren[i], pGeneralType);
                        if (!((pInstruction) === null)) {
                            pInstruction.push(pVariable, true);
                            if (pInstruction._getInstructionType() === akra.EAFXInstructionTypes.k_DeclStmtInstruction) {
                                var pVariableSubDecls = pVariable.getSubVarDecls();
                                if (!((pVariableSubDecls) === null)) {
                                    for(var j = 0; j < pVariableSubDecls.length; j++) {
                                        pInstruction.push(pVariableSubDecls[j], false);
                                    }
                                }
                            }
                        }
                    }
                }
            };
            Effect.prototype.analyzeUsageType = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var i = 0;
                var pType = new fx.VariableTypeInstruction();
                for(i = pChildren.length - 1; i >= 0; i--) {
                    if (pChildren[i].name === "Type") {
                        var pMainType = this.analyzeType(pChildren[i]);
                        pType.pushType(pMainType);
                    } else if (pChildren[i].name === "Usage") {
                        var sUsage = this.analyzeUsage(pChildren[i]);
                        pType.addUsage(sUsage);
                    }
                }
                if (!pType.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pType.getLastError());
                }
                ;
                return pType;
            };
            Effect.prototype.analyzeType = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pType = null;
                switch(pNode.name) {
                    case "T_TYPE_ID":
                        pType = this.getType(pNode.value);
                        if (((pType) === null)) {
                            this._error(2250, {
                                typeName: pNode.value
                            });
                        }
                        break;
                    case "Struct":
                        pType = this.analyzeStruct(pNode);
                        break;
                    case "T_KW_VOID":
                        pType = Effect.getSystemType("void");
                        break;
                    case "ScalarType":
                    case "ObjectType":
                        pType = this.getType(pChildren[pChildren.length - 1].value);
                        if (((pType) === null)) {
                            this._error(2250, {
                                typeName: pChildren[pChildren.length - 1].value
                            });
                        }
                        break;
                    case "VectorType":
                    case "MatrixType":
                        this._error(2251);
                        break;
                    case "BaseType":
                    case "Type":
                        return this.analyzeType(pChildren[0]);
                }
                return pType;
            };
            Effect.prototype.analyzeUsage = function (pNode) {
                this.setAnalyzedNode(pNode);
                pNode = pNode.children[0];
                return pNode.value;
            };
            Effect.prototype.analyzeVariable = function (pNode, pGeneralType) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pVarDecl = new fx.VariableDeclInstruction();
                var pVariableType = new fx.VariableTypeInstruction();
                var pAnnotation = null;
                var sSemantic = "";
                var pInitExpr = null;
                pVarDecl.push(pVariableType, true);
                pVariableType.pushType(pGeneralType);
                this.analyzeVariableDim(pChildren[pChildren.length - 1], pVarDecl);
                var i = 0;
                for(i = pChildren.length - 2; i >= 0; i--) {
                    if (pChildren[i].name === "Annotation") {
                        pAnnotation = this.analyzeAnnotation(pChildren[i]);
                        pVarDecl.setAnnotation(pAnnotation);
                    } else if (pChildren[i].name === "Semantic") {
                        sSemantic = this.analyzeSemantic(pChildren[i]);
                        pVarDecl.setSemantic(sSemantic);
                        pVarDecl.getNameId().setRealName(sSemantic);
                    } else if (pChildren[i].name === "Initializer") {
                        pInitExpr = this.analyzeInitializer(pChildren[i]);
                        if (!pInitExpr.optimizeForVariableType(pVariableType)) {
                            this._error(2269, {
                                varName: pVarDecl.getName()
                            });
                            return null;
                        }
                        pVarDecl.push(pInitExpr, true);
                    }
                }
                if (!pVarDecl.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pVarDecl.getLastError());
                }
                ;
                this.addVariableDecl(pVarDecl);
                return pVarDecl;
            };
            Effect.prototype.analyzeVariableDim = function (pNode, pVariableDecl) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pVariableType = pVariableDecl.getType();
                if (pChildren.length === 1) {
                    var pName = new fx.IdInstruction();
                    pName.setName(pChildren[0].value);
                    pVariableDecl.push(pName, true);
                    return;
                }
                this.analyzeVariableDim(pChildren[pChildren.length - 1], pVariableDecl);
                if (pChildren.length === 3) {
                    pVariableType.addPointIndex(true);
                } else if (pChildren.length === 4 && pChildren[0].name === "FromExpr") {
                    var pBuffer = this.analyzeFromExpr(pChildren[0]);
                    pVariableType.addPointIndex(true);
                    pVariableType.setVideoBuffer(pBuffer);
                } else {
                    if (pVariableType.isPointer()) {
                        this._error(2300);
                    }
                    var pIndexExpr = this.analyzeExpr(pChildren[pChildren.length - 3]);
                    pVariableType.addArrayIndex(pIndexExpr);
                }
            };
            Effect.prototype.analyzeAnnotation = function (pNode) {
                this.setAnalyzedNode(pNode);
                return null;
            };
            Effect.prototype.analyzeSemantic = function (pNode) {
                this.setAnalyzedNode(pNode);
                var sSemantic = pNode.children[0].value;
                return sSemantic;
            };
            Effect.prototype.analyzeInitializer = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pInitExpr = new fx.InitExprInstruction();
                if (pChildren.length === 2) {
                    pInitExpr.push(this.analyzeExpr(pChildren[0]), true);
                } else {
                    for(var i = pChildren.length - 3; i >= 1; i--) {
                        if (pChildren[i].name === "InitExpr") {
                            pInitExpr.push(this.analyzeInitExpr(pChildren[i]), true);
                        }
                    }
                }
                return pInitExpr;
            };
            Effect.prototype.analyzeFromExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pBuffer = null;
                if (pChildren[1].name === "T_NON_TYPE_ID") {
                    pBuffer = this.getVariable(pChildren[1].value);
                } else {
                    pBuffer = (this.analyzeMemExpr(pChildren[1])).getBuffer();
                }
                return pBuffer;
            };
            Effect.prototype.analyzeInitExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pInitExpr = new fx.InitExprInstruction();
                if (pChildren.length === 1) {
                    pInitExpr.push(this.analyzeExpr(pChildren[0]), true);
                } else {
                    for(var i = 0; i < pChildren.length; i++) {
                        if (pChildren[i].name === "InitExpr") {
                            pInitExpr.push(this.analyzeInitExpr(pChildren[i]), true);
                        }
                    }
                }
                return pInitExpr;
            };
            Effect.prototype.analyzeExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var sName = pNode.name;
                switch(sName) {
                    case "ObjectExpr":
                        return this.analyzeObjectExpr(pNode);
                    case "ComplexExpr":
                        return this.analyzeComplexExpr(pNode);
                    case "PrimaryExpr":
                        return this.analyzePrimaryExpr(pNode);
                    case "PostfixExpr":
                        return this.analyzePostfixExpr(pNode);
                    case "UnaryExpr":
                        return this.analyzeUnaryExpr(pNode);
                    case "CastExpr":
                        return this.analyzeCastExpr(pNode);
                    case "ConditionalExpr":
                        return this.analyzeConditionalExpr(pNode);
                    case "MulExpr":
                    case "AddExpr":
                        return this.analyzeArithmeticExpr(pNode);
                    case "RelationalExpr":
                    case "EqualityExpr":
                        return this.analyzeRelationExpr(pNode);
                    case "AndExpr":
                    case "OrExpr":
                        return this.analyzeLogicalExpr(pNode);
                    case "AssignmentExpr":
                        return this.analyzeAssignmentExpr(pNode);
                    case "T_NON_TYPE_ID":
                        return this.analyzeIdExpr(pNode);
                    case "T_STRING":
                    case "T_UINT":
                    case "T_FLOAT":
                    case "T_KW_TRUE":
                    case "T_KW_FALSE":
                        return this.analyzeSimpleExpr(pNode);
                    case "MemExpr":
                        return this.analyzeMemExpr(pNode);
                    default:
                        this._error(2204, {
                            exprName: sName
                        });
                        break;
                }
                return null;
            };
            Effect.prototype.analyzeObjectExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var sName = pNode.children[pNode.children.length - 1].name;
                switch(sName) {
                    case "T_KW_COMPILE":
                        return this.analyzeCompileExpr(pNode);
                    case "T_KW_SAMPLER_STATE":
                        return this.analyzeSamplerStateBlock(pNode);
                }
            };
            Effect.prototype.analyzeCompileExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pExpr = new fx.CompileExprInstruction();
                var pExprType;
                var pArguments = null;
                var sShaderFuncName = pChildren[pChildren.length - 2].value;
                var pShaderFunc = null;
                var i = 0;
                pArguments = [];
                if (pChildren.length > 4) {
                    var pArgumentExpr;
                    for(i = pChildren.length - 3; i > 0; i--) {
                        if (pChildren[i].value !== ",") {
                            pArgumentExpr = this.analyzeExpr(pChildren[i]);
                            pArguments.push(pArgumentExpr);
                        }
                    }
                }
                pShaderFunc = this.findShaderFunction(sShaderFuncName, pArguments);
                if (((pShaderFunc) === null)) {
                    this._error(2226, {
                        funcName: sShaderFuncName
                    });
                    return null;
                }
                pExprType = (pShaderFunc.getType()).wrap();
                pExpr.setType(pExprType);
                pExpr.setOperator("complile");
                pExpr.push(pShaderFunc.getNameId(), false);
                if (!((pArguments) === null)) {
                    for(i = 0; i < pArguments.length; i++) {
                        pExpr.push(pArguments[i], true);
                    }
                }
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzeSamplerStateBlock = function (pNode) {
                pNode = pNode.children[0];
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pExpr = new fx.SamplerStateBlockInstruction();
                var i = 0;
                pExpr.setOperator("sample_state");
                for(i = pChildren.length - 2; i >= 1; i--) {
                    this.analyzeSamplerState(pChildren[i], pExpr);
                }
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzeSamplerState = function (pNode, pSamplerStates) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                if (pChildren[pChildren.length - 2].name === "StateIndex") {
                    this._error(2270);
                    return;
                }
                var pStateExprNode = pChildren[pChildren.length - 3];
                var pSubStateExprNode = pStateExprNode.children[pStateExprNode.children.length - 1];
                var sStateType = pChildren[pChildren.length - 1].value.toUpperCase();
                var sStateValue = "";
                var isTexture = false;
                if (((pSubStateExprNode.value) === null)) {
                    this._error(2271);
                    return;
                }
                var pTexture = null;
                switch(sStateType) {
                    case "TEXTURE":
                        var pTexture = null;
                        if (pStateExprNode.children.length !== 3 || pSubStateExprNode.value === "{") {
                            this._error(2271);
                            return;
                        }
                        var sTextureName = pStateExprNode.children[1].value;
                        if (((sTextureName) === null) || !this.hasVariable(sTextureName)) {
                            this._error(2271);
                            return;
                        }
                        pTexture = this.getVariable(sTextureName);
                        sStateValue = sTextureName;
                        break;
                    case "ADDRESSU":
                    case "ADDRESSV":
                        sStateValue = pSubStateExprNode.value.toUpperCase();
                        switch(sStateValue) {
                            case "WRAP":
                            case "CLAMP":
                            case "MIRROR":
                                break;
                            default:
 {
                                    akra.logger.setSourceLocation("fx/Effect.ts", 1959);
                                    akra.logger.warning("Webgl don`t support this wrapmode: " + sStateValue);
                                }
                                ;
                                return;
                        }
                        break;
                    case "MAGFILTER":
                    case "MINFILTER":
                        sStateValue = pSubStateExprNode.value.toUpperCase();
                        switch(sStateValue) {
                            case "NEAREST":
                            case "LINEAR":
                            case "NEAREST_MIPMAP_NEAREST":
                            case "LINEAR_MIPMAP_NEAREST":
                            case "NEAREST_MIPMAP_LINEAR":
                            case "LINEAR_MIPMAP_LINEAR":
                                break;
                            default:
 {
                                    akra.logger.setSourceLocation("fx/Effect.ts", 1976);
                                    akra.logger.warning("Webgl don`t support this texture filter: " + sStateValue);
                                }
                                ;
                                return;
                        }
                        break;
                    default:
 {
                            akra.logger.setSourceLocation("fx/Effect.ts", 1982);
                            akra.logger.warning("Don`t support this texture param: " + sStateType);
                        }
                        ;
                        return;
                }
                if (sStateType !== "TEXTURE") {
                    pSamplerStates.addState(sStateType, sStateValue);
                } else {
                    pSamplerStates.setTexture(pTexture);
                }
            };
            Effect.prototype.analyzeComplexExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sFirstNodeName = pChildren[pChildren.length - 1].name;
                switch(sFirstNodeName) {
                    case "T_NON_TYPE_ID":
                        return this.analyzeFunctionCallExpr(pNode);
                    case "BaseType":
                    case "T_TYPE_ID":
                        return this.analyzeConstructorCallExpr(pNode);
                    default:
                        return this.analyzeSimpleComplexExpr(pNode);
                }
            };
            Effect.prototype.analyzeFunctionCallExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pExpr = null;
                var pExprType = null;
                var pArguments = null;
                var sFuncName = pChildren[pChildren.length - 1].value;
                var pFunction = null;
                var pFunctionId = null;
                var i = 0;
                var pCurrentAnalyzedFunction = this.getCurrentAnalyzedFunction();
                if (pChildren.length > 3) {
                    var pArgumentExpr;
                    pArguments = [];
                    for(i = pChildren.length - 3; i > 0; i--) {
                        if (pChildren[i].value !== ",") {
                            pArgumentExpr = this.analyzeExpr(pChildren[i]);
                            pArguments.push(pArgumentExpr);
                        }
                    }
                }
                pFunction = this.findFunction(sFuncName, pArguments);
                if (((pFunction) === null)) {
                    this._error(2223, {
                        funcName: sFuncName
                    });
                    return null;
                }
                if (!((pFunction) !== undefined)) {
                    this._error(2246, {
                        funcName: sFuncName
                    });
                    return null;
                }
                if (!((pCurrentAnalyzedFunction) === null)) {
                    if (!pFunction._isForPixel()) {
                        pCurrentAnalyzedFunction._setForPixel(false);
                    }
                    if (!pFunction._isForVertex()) {
                        pCurrentAnalyzedFunction._setForVertex(false);
                    }
                }
                if (pFunction._getInstructionType() === akra.EAFXInstructionTypes.k_FunctionDeclInstruction) {
                    var pFunctionCallExpr = new fx.FunctionCallInstruction();
                    pFunctionId = new fx.IdExprInstruction();
                    pFunctionId.push(pFunction.getNameId(), false);
                    pExprType = (pFunction.getType()).wrap();
                    pFunctionCallExpr.setType(pExprType);
                    pFunctionCallExpr.push(pFunctionId, true);
                    if (!((pArguments) === null)) {
                        for(i = 0; i < pArguments.length; i++) {
                            pFunctionCallExpr.push(pArguments[i], true);
                        }
                        var pFunctionArguments = (pFunction).getArguments();
                        for(i = 0; i < pArguments.length; i++) {
                            if (pFunctionArguments[i].getType().hasUsage("out")) {
                                if (!pArguments[i].getType().isWritable()) {
                                    this._error(2267);
                                    return null;
                                }
                                if (pArguments[i].getType().isStrongEqual(Effect.getSystemType("ptr"))) {
                                    this.addPointerForExtract(pArguments[i].getType()._getParentVarDecl());
                                }
                            } else if (pFunctionArguments[i].getType().hasUsage("inout")) {
                                if (!pArguments[i].getType().isWritable()) {
                                    this._error(2267);
                                    return null;
                                }
                                if (!pArguments[i].getType().isReadable()) {
                                    this._error(2268);
                                    return null;
                                }
                                if (pArguments[i].getType().isStrongEqual(Effect.getSystemType("ptr"))) {
                                    this.addPointerForExtract(pArguments[i].getType()._getParentVarDecl());
                                }
                            } else {
                                if (!pArguments[i].getType().isReadable()) {
                                    this._error(2268);
                                    return null;
                                }
                            }
                        }
                        for(i = pArguments.length; i < pFunctionArguments.length; i++) {
                            pFunctionCallExpr.push(pFunctionArguments[i].getInitializeExpr(), false);
                        }
                    }
                    if (!((pCurrentAnalyzedFunction) === null)) {
                        pCurrentAnalyzedFunction._addUsedFunction(pFunction);
                    }
                    pFunction._markUsedAs(akra.EFunctionType.k_Function);
                    pExpr = pFunctionCallExpr;
                } else {
                    var pSystemCallExpr = new fx.SystemCallInstruction();
                    pSystemCallExpr.setSystemCallFunction(pFunction);
                    pSystemCallExpr.fillByArguments(pArguments);
                    if (!((pCurrentAnalyzedFunction) === null)) {
                        for(i = 0; i < pArguments.length; i++) {
                            if (!pArguments[i].getType().isReadable()) {
                                this._error(2268);
                                return null;
                            }
                        }
                    }
                    pExpr = pSystemCallExpr;
                    if (!pFunction.isBuiltIn() && !((pCurrentAnalyzedFunction) === null)) {
                        pCurrentAnalyzedFunction._addUsedFunction(pFunction);
                    }
                }
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzeConstructorCallExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pExpr = new fx.ConstructorCallInstruction();
                var pExprType = null;
                var pArguments = null;
                var pConstructorType = null;
                var i = 0;
                pConstructorType = this.analyzeType(pChildren[pChildren.length - 1]);
                if (((pConstructorType) === null)) {
                    this._error(2224);
                    return null;
                }
                if (pChildren.length > 3) {
                    var pArgumentExpr = null;
                    pArguments = [];
                    for(i = pChildren.length - 3; i > 0; i--) {
                        if (pChildren[i].value !== ",") {
                            pArgumentExpr = this.analyzeExpr(pChildren[i]);
                            pArguments.push(pArgumentExpr);
                        }
                    }
                }
                pExprType = this.findConstructor(pConstructorType, pArguments);
                if (((pExprType) === null)) {
                    this._error(2225, {
                        typeName: pConstructorType.toString()
                    });
                    return null;
                }
                pExpr.setType(pExprType);
                pExpr.push(pConstructorType, false);
                if (!((pArguments) === null)) {
                    for(i = 0; i < pArguments.length; i++) {
                        if (!pArguments[i].getType().isReadable()) {
                            this._error(2268);
                            return null;
                        }
                        pExpr.push(pArguments[i], true);
                    }
                }
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzeSimpleComplexExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pExpr = new fx.ComplexExprInstruction();
                var pComplexExpr;
                var pExprType;
                pComplexExpr = this.analyzeExpr(pChildren[1]);
                pExprType = pComplexExpr.getType();
                pExpr.setType(pExprType);
                pExpr.push(pComplexExpr, true);
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzePrimaryExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pExpr = new fx.PrimaryExprInstruction();
                var pPrimaryExpr;
                var pPointer = null;
                var pPrimaryExprType;
                pPrimaryExpr = this.analyzeExpr(pChildren[0]);
                pPrimaryExprType = pPrimaryExpr.getType();
                pPointer = pPrimaryExprType.getPointer();
                if (((pPointer) === null)) {
                    this._error(2222, {
                        typeName: pPrimaryExprType.getHash()
                    });
                    return null;
                }
                var pPointerVarType = pPrimaryExprType.getParent();
                if (!pPrimaryExprType.isStrictPointer()) {
                    this.getCurrentAnalyzedFunction()._setForPixel(false);
                    this.getCurrentAnalyzedFunction()._notCanUsedAsFunction();
                    pPrimaryExprType._setPointerToStrict();
                }
                pExpr.setType(pPointer.getType());
                pExpr.setOperator("@");
                pExpr.push(pPointer.getNameId(), false);
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzePostfixExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sSymbol = pChildren[pChildren.length - 2].value;
                switch(sSymbol) {
                    case "[":
                        return this.analyzePostfixIndex(pNode);
                    case ".":
                        return this.analyzePostfixPoint(pNode);
                    case "++":
                    case "--":
                        return this.analyzePostfixArithmetic(pNode);
                }
            };
            Effect.prototype.analyzePostfixIndex = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pExpr = new fx.PostfixIndexInstruction();
                var pPostfixExpr = null;
                var pIndexExpr = null;
                var pExprType = null;
                var pPostfixExprType = null;
                var pIndexExprType = null;
                var pIntType = null;
                pPostfixExpr = this.analyzeExpr(pChildren[pChildren.length - 1]);
                pPostfixExprType = pPostfixExpr.getType();
                if (!pPostfixExprType.isArray()) {
                    this._error(2217, {
                        typeName: pPostfixExprType.toString()
                    });
                    return null;
                }
                pIndexExpr = this.analyzeExpr(pChildren[pChildren.length - 3]);
                pIndexExprType = pIndexExpr.getType();
                pIntType = Effect.getSystemType("int");
                if (!pIndexExprType.isEqual(pIntType)) {
                    this._error(2218, {
                        typeName: pIndexExprType.toString()
                    });
                    return null;
                }
                pExprType = (pPostfixExprType.getArrayElementType());
                pExpr.setType(pExprType);
                pExpr.push(pPostfixExpr, true);
                pExpr.push(pIndexExpr, true);
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzePostfixPoint = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pExpr = new fx.PostfixPointInstruction();
                var pPostfixExpr = null;
                var sFieldName = "";
                var pFieldNameExpr = null;
                var pExprType = null;
                var pPostfixExprType = null;
                pPostfixExpr = this.analyzeExpr(pChildren[pChildren.length - 1]);
                pPostfixExprType = pPostfixExpr.getType();
                sFieldName = pChildren[pChildren.length - 3].value;
                pFieldNameExpr = pPostfixExprType.getFieldExpr(sFieldName);
                if (((pFieldNameExpr) === null)) {
                    this._error(2219, {
                        typeName: pPostfixExprType.toString(),
                        fieldName: sFieldName
                    });
                    return null;
                }
                pExprType = pFieldNameExpr.getType();
                if (pChildren.length === 4) {
                    if (!pExprType.isPointer()) {
                        this._error(2220, {
                            typeName: pExprType.toString()
                        });
                        return null;
                    }
                    var pBuffer = this.analyzeFromExpr(pChildren[0]);
                    pExprType.setVideoBuffer(pBuffer);
                }
                pExpr.setType(pExprType);
                pExpr.push(pPostfixExpr, true);
                pExpr.push(pFieldNameExpr, true);
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzePostfixArithmetic = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sOperator = pChildren[0].value;
                var pExpr = new fx.PostfixArithmeticInstruction();
                var pPostfixExpr;
                var pExprType;
                var pPostfixExprType;
                pPostfixExpr = this.analyzeExpr(pChildren[1]);
                pPostfixExprType = pPostfixExpr.getType();
                pExprType = this.checkOneOperandExprType(sOperator, pPostfixExprType);
                if (((pExprType) === null)) {
                    this._error(2221, {
                        operator: sOperator,
                        typeName: pPostfixExprType.toString()
                    });
                    return null;
                }
                pExpr.setType(pExprType);
                pExpr.setOperator(sOperator);
                pExpr.push(pPostfixExpr, true);
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzeUnaryExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sOperator = pChildren[1].value;
                var pExpr = new fx.UnaryExprInstruction();
                var pUnaryExpr;
                var pExprType;
                var pUnaryExprType;
                pUnaryExpr = this.analyzeExpr(pChildren[0]);
                pUnaryExprType = pUnaryExpr.getType();
                pExprType = this.checkOneOperandExprType(sOperator, pUnaryExprType);
                if (((pExprType) === null)) {
                    this._error(2216, {
                        operator: sOperator,
                        tyepName: pUnaryExprType.toString()
                    });
                    return null;
                }
                pExpr.setOperator(sOperator);
                pExpr.setType(pExprType);
                pExpr.push(pUnaryExpr, true);
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzeCastExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pExpr = new fx.CastExprInstruction();
                var pExprType;
                var pCastedExpr;
                pExprType = this.analyzeConstTypeDim(pChildren[2]);
                pCastedExpr = this.analyzeExpr(pChildren[0]);
                if (!(pCastedExpr.getType()).isReadable()) {
                    this._error(2268);
                    return null;
                }
                pExpr.setType(pExprType);
                pExpr.push(pExprType, true);
                pExpr.push(pCastedExpr, true);
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzeConditionalExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pExpr = new fx.ConditionalExprInstruction();
                var pConditionExpr;
                var pTrueExpr;
                var pFalseExpr;
                var pConditionType;
                var pTrueExprType;
                var pFalseExprType;
                var pExprType;
                var pBoolType;
                pConditionExpr = this.analyzeExpr(pChildren[pChildren.length - 1]);
                pTrueExpr = this.analyzeExpr(pChildren[pChildren.length - 3]);
                pFalseExpr = this.analyzeExpr(pChildren[0]);
                pConditionType = pConditionExpr.getType();
                pTrueExprType = pTrueExpr.getType();
                pFalseExprType = pFalseExpr.getType();
                pBoolType = Effect.getSystemType("bool");
                if (!pConditionType.isEqual(pBoolType)) {
                    this._error(2211, {
                        typeName: pConditionType.toString()
                    });
                    return null;
                }
                if (!pTrueExprType.isEqual(pFalseExprType)) {
                    this._error(2212, {
                        leftTypeName: pTrueExprType.toString(),
                        rightTypeName: pFalseExprType.toString()
                    });
                    return null;
                }
                if (!pConditionType.isReadable()) {
                    this._error(2268);
                    return null;
                }
                if (!pTrueExprType.isReadable()) {
                    this._error(2268);
                    return null;
                }
                if (!pFalseExprType.isReadable()) {
                    this._error(2268);
                    return null;
                }
                pExpr.setType(pTrueExprType);
                pExpr.push(pConditionExpr, true);
                pExpr.push(pTrueExpr, true);
                pExpr.push(pFalseExpr, true);
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzeArithmeticExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sOperator = pNode.children[1].value;
                var pExpr = new fx.ArithmeticExprInstruction();
                var pLeftExpr = null;
                var pRightExpr = null;
                var pLeftType = null;
                var pRightType = null;
                var pExprType = null;
                pLeftExpr = this.analyzeExpr(pChildren[pChildren.length - 1]);
                pRightExpr = this.analyzeExpr(pChildren[0]);
                pLeftType = pLeftExpr.getType();
                pRightType = pRightExpr.getType();
                pExprType = this.checkTwoOperandExprTypes(sOperator, pLeftType, pRightType);
                if (((pExprType) === null)) {
                    this._error(2206, {
                        operator: sOperator,
                        leftTypeName: pLeftType.toString(),
                        rightTypeName: pRightType.toString()
                    });
                    return null;
                }
                pExpr.setOperator(sOperator);
                pExpr.setType(pExprType);
                pExpr.push(pLeftExpr, true);
                pExpr.push(pRightExpr, true);
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzeRelationExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sOperator = pNode.children[1].value;
                var pExpr = new fx.RelationalExprInstruction();
                var pLeftExpr;
                var pRightExpr;
                var pLeftType;
                var pRightType;
                var pExprType;
                pLeftExpr = this.analyzeExpr(pChildren[pChildren.length - 1]);
                pRightExpr = this.analyzeExpr(pChildren[0]);
                pLeftType = pLeftExpr.getType();
                pRightType = pRightExpr.getType();
                pExprType = this.checkTwoOperandExprTypes(sOperator, pLeftType, pRightType);
                if (((pExprType) === null)) {
                    this._error(2209, {
                        operator: sOperator,
                        leftTypeName: pLeftType.getHash(),
                        rightTypeName: pRightType.getHash()
                    });
                    return null;
                }
                pExpr.setOperator(sOperator);
                pExpr.setType(pExprType);
                pExpr.push(pLeftExpr, true);
                pExpr.push(pRightExpr, true);
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzeLogicalExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sOperator = pNode.children[1].value;
                var pExpr = new fx.LogicalExprInstruction();
                var pLeftExpr;
                var pRightExpr;
                var pLeftType;
                var pRightType;
                var pBoolType;
                pLeftExpr = this.analyzeExpr(pChildren[pChildren.length - 1]);
                pRightExpr = this.analyzeExpr(pChildren[0]);
                pLeftType = pLeftExpr.getType();
                pRightType = pRightExpr.getType();
                pBoolType = Effect.getSystemType("bool");
                if (!pLeftType.isEqual(pBoolType)) {
                    this._error(2210, {
                        operator: sOperator,
                        typeName: pLeftType.toString()
                    });
                    return null;
                }
                if (!pRightType.isEqual(pBoolType)) {
                    this._error(2210, {
                        operator: sOperator,
                        typeName: pRightType.toString()
                    });
                    return null;
                }
                if (!pLeftType.isReadable()) {
                    this._error(2268);
                    return null;
                }
                if (!pRightType.isReadable()) {
                    this._error(2268);
                    return null;
                }
                pExpr.setOperator(sOperator);
                pExpr.setType(pBoolType);
                pExpr.push(pLeftExpr, true);
                pExpr.push(pRightExpr, true);
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzeAssignmentExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sOperator = pChildren[1].value;
                var pExpr = new fx.AssignmentExprInstruction();
                var pLeftExpr;
                var pRightExpr;
                var pLeftType;
                var pRightType;
                var pExprType;
                pLeftExpr = this.analyzeExpr(pChildren[pChildren.length - 1]);
                pRightExpr = this.analyzeExpr(pChildren[0]);
                pLeftType = pLeftExpr.getType();
                pRightType = pRightExpr.getType();
                if (sOperator !== "=") {
                    pExprType = this.checkTwoOperandExprTypes(sOperator, pLeftType, pRightType);
                    if (((pExprType) === null)) {
                        this._error(2207, {
                            operator: sOperator,
                            leftTypeName: pLeftType.getHash(),
                            rightTypeName: pRightType.getHash()
                        });
                    }
                } else {
                    pExprType = pRightType;
                }
                pExprType = this.checkTwoOperandExprTypes("=", pLeftType, pExprType);
                if (((pExprType) === null)) {
                    this._error(2208, {
                        leftTypeName: pLeftType.getHash(),
                        rightTypeName: pRightType.getHash()
                    });
                }
                pExpr.setOperator(sOperator);
                pExpr.setType(pExprType);
                pExpr.push(pLeftExpr, true);
                pExpr.push(pRightExpr, true);
                if (!pExpr.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExpr.getLastError());
                }
                ;
                return pExpr;
            };
            Effect.prototype.analyzeIdExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var sName = pNode.value;
                var pVariable = this.getVariable(sName);
                if (((pVariable) === null)) {
                    this._error(2205, {
                        varName: sName
                    });
                    return null;
                }
                if (pVariable.getType()._isUnverifiable() && !this.isAnalzeInPass()) {
                    this._error(2276);
                    return null;
                }
                if (!((this.getCurrentAnalyzedFunction()) === null)) {
                    if (!pVariable._isForPixel()) {
                        this.getCurrentAnalyzedFunction()._setForPixel(false);
                    }
                    if (!pVariable._isForVertex()) {
                        this.getCurrentAnalyzedFunction()._setForVertex(false);
                    }
                }
                var pVarId = new fx.IdExprInstruction();
                pVarId.push(pVariable.getNameId(), false);
                if (!pVarId.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pVarId.getLastError());
                }
                ;
                return pVarId;
            };
            Effect.prototype.analyzeSimpleExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pInstruction = null;
                var sName = pNode.name;
                var sValue = pNode.value;
                switch(sName) {
                    case "T_UINT":
                        pInstruction = new fx.IntInstruction();
                        pInstruction.setValue((sValue) * 1);
                        break;
                    case "T_FLOAT":
                        pInstruction = new fx.FloatInstruction();
                        pInstruction.setValue((sValue) * 1.0);
                        break;
                    case "T_STRING":
                        pInstruction = new fx.StringInstruction();
                        pInstruction.setValue(sValue);
                        break;
                    case "T_KW_TRUE":
                        pInstruction = new fx.BoolInstruction();
                        pInstruction.setValue(true);
                        break;
                    case "T_KW_FALSE":
                        pInstruction = new fx.BoolInstruction();
                        pInstruction.setValue(false);
                        break;
                }
                return pInstruction;
            };
            Effect.prototype.analyzeMemExpr = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pMemExpr = new fx.MemExprInstruction();
                var pPostfixExpr = this.analyzeExpr(pChildren[0]);
                var pPostfixExprType = pPostfixExpr.getType();
                if (!pPostfixExprType.isFromVariableDecl()) {
                    this._error(2253);
                    return null;
                }
                var pBuffer = pPostfixExprType.getVideoBuffer();
                if (((pBuffer) === null)) {
                    this._error(2254);
                }
                if (!pPostfixExprType.isStrictPointer() && !((this.getCurrentAnalyzedFunction()) === null)) {
                    this.getCurrentAnalyzedFunction()._setForPixel(false);
                    this.getCurrentAnalyzedFunction()._notCanUsedAsFunction();
                    pPostfixExprType._setPointerToStrict();
                }
                pMemExpr.setBuffer(pBuffer);
                return pMemExpr;
            };
            Effect.prototype.analyzeConstTypeDim = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                if (pChildren.length > 1) {
                    this._error(2213);
                    return null;
                }
                var pType;
                pType = (this.analyzeType(pChildren[0]));
                if (!pType.isBase()) {
                    this._error(2214, {
                        typeName: pType.toString()
                    });
                }
                if (!pType.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pType.getLastError());
                }
                ;
                return pType;
            };
            Effect.prototype.analyzeVarStructDecl = function (pNode, pInstruction) {
                if (typeof pInstruction === "undefined") { pInstruction = null; }
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pUsageType = null;
                var pVariable = null;
                var i = 0;
                pUsageType = this.analyzeUsageStructDecl(pChildren[pChildren.length - 1]);
                for(i = pChildren.length - 2; i >= 1; i--) {
                    if (pChildren[i].name === "Variable") {
                        pVariable = this.analyzeVariable(pChildren[i], pUsageType);
                        if (!((pInstruction) === null)) {
                            pInstruction.push(pVariable, true);
                        }
                    }
                }
            };
            Effect.prototype.analyzeUsageStructDecl = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var i = 0;
                var pType = new fx.VariableTypeInstruction();
                for(i = pChildren.length - 1; i >= 0; i--) {
                    if (pChildren[i].name === "StructDecl") {
                        var pMainType = this.analyzeStructDecl(pChildren[i]);
                        pType.pushType(pMainType);
                        var pTypeDecl = new fx.TypeDeclInstruction();
                        pTypeDecl.push(pMainType, true);
                        this.addTypeDecl(pTypeDecl);
                    } else if (pChildren[i].name === "Usage") {
                        var sUsage = this.analyzeUsage(pChildren[i]);
                        pType.addUsage(sUsage);
                    }
                }
                if (!pType.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pType.getLastError());
                }
                ;
                return pType;
            };
            Effect.prototype.analyzeTypeDecl = function (pNode, pParentInstruction) {
                if (typeof pParentInstruction === "undefined") { pParentInstruction = null; }
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pTypeDeclInstruction = new fx.TypeDeclInstruction();
                if (pChildren.length === 2) {
                    var pStructInstruction = this.analyzeStructDecl(pChildren[1]);
                    pTypeDeclInstruction.push(pStructInstruction, true);
                } else {
                    this._error(2203);
                }
                if (!pTypeDeclInstruction.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pTypeDeclInstruction.getLastError());
                }
                ;
                this.addTypeDecl(pTypeDeclInstruction);
                pNode.isAnalyzed = true;
                if (!((pParentInstruction) === null)) {
                    pParentInstruction.push(pTypeDeclInstruction, true);
                }
                return pTypeDeclInstruction;
            };
            Effect.prototype.analyzeStructDecl = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pStruct = new fx.ComplexTypeInstruction();
                var pFieldCollector = new fx.InstructionCollector();
                var sName = pChildren[pChildren.length - 2].value;
                pStruct.setName(sName);
                this.newScope(fx.EScopeType.k_Struct);
                var i = 0;
                for(i = pChildren.length - 4; i >= 1; i--) {
                    if (pChildren[i].name === "VariableDecl") {
                        this.analyzeVariableDecl(pChildren[i], pFieldCollector);
                    }
                }
                this.endScope();
                pStruct.addFields(pFieldCollector, true);
                if (!pStruct.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pStruct.getLastError());
                }
                ;
                return pStruct;
            };
            Effect.prototype.analyzeStruct = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pStruct = new fx.ComplexTypeInstruction();
                var pFieldCollector = new fx.InstructionCollector();
                this.newScope(fx.EScopeType.k_Struct);
                var i = 0;
                for(i = pChildren.length - 4; i >= 1; i--) {
                    if (pChildren[i].name === "VariableDecl") {
                        this.analyzeVariableDecl(pChildren[i], pFieldCollector);
                    }
                }
                this.endScope();
                pStruct.addFields(pFieldCollector, true);
                if (!pStruct.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pStruct.getLastError());
                }
                ;
                return pStruct;
            };
            Effect.prototype.analyzeFunctionDeclOnlyDefinition = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pFunction = null;
                var pFunctionDef = null;
                var pStmtBlock = null;
                var pAnnotation = null;
                var sLastNodeValue = pChildren[0].value;
                var bNeedAddFunction = false;
                pFunctionDef = this.analyzeFunctionDef(pChildren[pChildren.length - 1]);
                pFunction = this.findFunctionByDef(pFunctionDef);
                if (!((pFunction) !== undefined)) {
                    this._error(2246, {
                        funcName: pFunction.getNameId().toString()
                    });
                    return null;
                }
                if (!((pFunction) === null) && pFunction.hasImplementation()) {
                    this._error(2227, {
                        funcName: pFunction.getNameId().toString()
                    });
                    return null;
                }
                if (((pFunction) === null)) {
                    pFunction = new fx.FunctionDeclInstruction();
                    bNeedAddFunction = true;
                } else {
                    if (!pFunction.getReturnType().isEqual(pFunctionDef.getReturnType())) {
                        this._error(2247, {
                            funcName: pFunction.getNameId().toString()
                        });
                        return null;
                    }
                    bNeedAddFunction = false;
                }
                pFunction.setFunctionDef(pFunctionDef);
                this.resumeScope();
                if (pChildren.length === 3) {
                    pAnnotation = this.analyzeAnnotation(pChildren[1]);
                    pFunction.setAnnotation(pAnnotation);
                }
                if (sLastNodeValue !== ";") {
                    pFunction._setParseNode(pNode);
                    pFunction._setImplementationScope(this.getScope());
                    this._pFunctionWithImplementationList.push(pFunction);
                }
                this.endScope();
                if (bNeedAddFunction) {
                    this.addFunctionDecl(pFunction);
                }
            };
            Effect.prototype.resumeFunctionAnalysis = function (pAnalzedFunction) {
                var pFunction = pAnalzedFunction;
                var pNode = pFunction._getParseNode();
                this.setAnalyzedNode(pNode);
                this.setScope(pFunction._getImplementationScope());
                var pChildren = pNode.children;
                var pStmtBlock = null;
                this.setCurrentAnalyzedFunction(pFunction);
                pStmtBlock = this.analyzeStmtBlock(pChildren[0]);
                pFunction.setImplementation(pStmtBlock);
                this.setCurrentAnalyzedFunction(null);
                this.endScope();
                if (!pFunction.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pFunction.getLastError());
                }
                ;
            };
            Effect.prototype.analyzeFunctionDef = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pFunctionDef = new fx.FunctionDefInstruction();
                var pReturnType = null;
                var pFuncName = null;
                var pArguments = null;
                var sFuncName = pChildren[pChildren.length - 2].value;
                pReturnType = this.analyzeUsageType(pChildren[pChildren.length - 1]);
                if (pReturnType.isPointer() || pReturnType._containSampler() || pReturnType._containPointer()) {
                    this._error(2264, {
                        funcName: sFuncName
                    });
                    return null;
                }
                pFuncName = new fx.IdInstruction();
                pFuncName.setName(sFuncName);
                pFunctionDef.setReturnType(pReturnType);
                pFunctionDef.setFunctionName(pFuncName);
                if (pChildren.length === 4) {
                    var sSemantic = this.analyzeSemantic(pChildren[0]);
                    pFunctionDef.setSemantic(sSemantic);
                }
                this.newScope();
                this.analyzeParamList(pChildren[pChildren.length - 3], pFunctionDef);
                this.endScope();
                if (!pFunctionDef.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pFunctionDef.getLastError());
                }
                ;
                return pFunctionDef;
            };
            Effect.prototype.analyzeParamList = function (pNode, pFunctionDef) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pParameter;
                var i = 0;
                for(i = pChildren.length - 2; i >= 1; i--) {
                    if (pChildren[i].name === "ParameterDecl") {
                        pParameter = this.analyzeParameterDecl(pChildren[i]);
                        pParameter._setScope(this.getScope());
                        pFunctionDef.addParameter(pParameter, this.isStrictMode());
                    }
                }
            };
            Effect.prototype.analyzeParameterDecl = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pType = null;
                var pParameter = null;
                pType = this.analyzeParamUsageType(pChildren[1]);
                pParameter = this.analyzeVariable(pChildren[0], pType);
                return pParameter;
            };
            Effect.prototype.analyzeParamUsageType = function (pNode) {
                var pChildren = pNode.children;
                var i = 0;
                var pType = new fx.VariableTypeInstruction();
                for(i = pChildren.length - 1; i >= 0; i--) {
                    if (pChildren[i].name === "Type") {
                        var pMainType = this.analyzeType(pChildren[i]);
                        pType.pushType(pMainType);
                    } else if (pChildren[i].name === "ParamUsage") {
                        var sUsage = this.analyzeUsage(pChildren[i]);
                        pType.addUsage(sUsage);
                    }
                }
                if (!pType.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pType.getLastError());
                }
                ;
                return pType;
            };
            Effect.prototype.analyzeStmtBlock = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pStmtBlock = new fx.StmtBlockInstruction();
                var pStmt;
                var i = 0;
                pStmtBlock._setScope(this.getScope());
                this.newScope();
                for(i = pChildren.length - 2; i > 0; i--) {
                    pStmt = this.analyzeStmt(pChildren[i]);
                    if (!((pStmt) === null)) {
                        pStmtBlock.push(pStmt);
                    }
                    this.addExtactionStmts(pStmtBlock);
                }
                this.endScope();
                if (!pStmtBlock.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pStmtBlock.getLastError());
                }
                ;
                return pStmtBlock;
            };
            Effect.prototype.analyzeStmt = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sFirstNodeName = pChildren[pChildren.length - 1].name;
                switch(sFirstNodeName) {
                    case "SimpleStmt":
                        return this.analyzeSimpleStmt(pChildren[0]);
                    case "UseDecl":
                        this.analyzeUseDecl(pChildren[0]);
                        return null;
                    case "T_KW_WHILE":
                        return this.analyzeWhileStmt(pNode);
                    case "T_KW_FOR":
                        return this.analyzeForStmt(pNode);
                    case "T_KW_IF":
                        return this.analyzeIfStmt(pNode);
                }
            };
            Effect.prototype.analyzeSimpleStmt = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sFirstNodeName = pChildren[pChildren.length - 1].name;
                switch(sFirstNodeName) {
                    case "T_KW_RETURN":
                        return this.analyzeReturnStmt(pNode);
                    case "T_KW_DO":
                        return this.analyzeWhileStmt(pNode);
                    case "StmtBlock":
                        return this.analyzeStmtBlock(pChildren[0]);
                    case "T_KW_DISCARD":
                    case "T_KW_BREAK":
                    case "T_KW_CONTINUE":
                        return this.analyzeBreakStmt(pNode);
                    case "TypeDecl":
                    case "VariableDecl":
                    case "VarStructDecl":
                        return this.analyzeDeclStmt(pChildren[0]);
                    default:
                        if (pChildren.length === 2) {
                            return this.analyzeExprStmt(pNode);
                        } else {
                            return (new fx.SemicolonStmtInstruction());
                        }
                }
            };
            Effect.prototype.analyzeReturnStmt = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pReturnStmtInstruction = new fx.ReturnStmtInstruction();
                var pFunctionReturnType = this.getCurrentAnalyzedFunction().getReturnType();
                if (pFunctionReturnType.isEqual(Effect.getSystemType("void")) && pChildren.length === 3) {
                    this._error(2261);
                    return null;
                } else if (!pFunctionReturnType.isEqual(Effect.getSystemType("void")) && pChildren.length === 2) {
                    this._error(2262);
                    return null;
                }
                if (pChildren.length === 3) {
                    var pExprInstruction = this.analyzeExpr(pChildren[1]);
                    var pOutVar = this.getCurrentAnalyzedFunction()._getOutVariable();
                    if (!((pOutVar) === null) && pOutVar.getType() !== pExprInstruction.getType()) {
                        this._error(2263);
                        return null;
                    }
                    if (!pFunctionReturnType.isEqual(pExprInstruction.getType())) {
                        this._error(2263);
                        return null;
                    }
                    pReturnStmtInstruction.push(pExprInstruction, true);
                }
                if (!pReturnStmtInstruction.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pReturnStmtInstruction.getLastError());
                }
                ;
                return pReturnStmtInstruction;
            };
            Effect.prototype.analyzeBreakStmt = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pBreakStmtInstruction = new fx.BreakStmtInstruction();
                var sOperatorName = pChildren[1].value;
                pBreakStmtInstruction.setOperator(sOperatorName);
                if (sOperatorName === "discard" && !((this.getCurrentAnalyzedFunction()) === null)) {
                    this.getCurrentAnalyzedFunction()._setForVertex(false);
                }
                if (!pBreakStmtInstruction.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pBreakStmtInstruction.getLastError());
                }
                ;
                return pBreakStmtInstruction;
            };
            Effect.prototype.analyzeDeclStmt = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sNodeName = pNode.name;
                var pDeclStmtInstruction = new fx.DeclStmtInstruction();
                switch(sNodeName) {
                    case "TypeDecl":
                        this.analyzeTypeDecl(pNode, pDeclStmtInstruction);
                        break;
                    case "VariableDecl":
                        this.analyzeVariableDecl(pNode, pDeclStmtInstruction);
                        break;
                    case "VarStructDecl":
                        this.analyzeVarStructDecl(pNode, pDeclStmtInstruction);
                        break;
                }
                if (!pDeclStmtInstruction.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pDeclStmtInstruction.getLastError());
                }
                ;
                return pDeclStmtInstruction;
            };
            Effect.prototype.analyzeExprStmt = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pExprStmtInstruction = new fx.ExprStmtInstruction();
                var pExprInstruction = this.analyzeExpr(pChildren[1]);
                pExprStmtInstruction.push(pExprInstruction, true);
                if (!pExprStmtInstruction.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pExprStmtInstruction.getLastError());
                }
                ;
                return pExprStmtInstruction;
            };
            Effect.prototype.analyzeWhileStmt = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var isDoWhile = (pChildren[pChildren.length - 1].value === "do");
                var isNonIfStmt = (pNode.name === "NonIfStmt") ? true : false;
                var pWhileStmt = new fx.WhileStmtInstruction();
                var pCondition = null;
                var pConditionType = null;
                var pBoolType = Effect.getSystemType("bool");
                var pStmt = null;
                if (isDoWhile) {
                    pWhileStmt.setOperator("do_while");
                    pCondition = this.analyzeExpr(pChildren[2]);
                    pConditionType = pCondition.getType();
                    if (!pConditionType.isEqual(pBoolType)) {
                        this._error(2229, {
                            typeName: pConditionType.toString()
                        });
                        return null;
                    }
                    pStmt = this.analyzeStmt(pChildren[0]);
                } else {
                    pWhileStmt.setOperator("while");
                    pCondition = this.analyzeExpr(pChildren[2]);
                    pConditionType = pCondition.getType();
                    if (!pConditionType.isEqual(pBoolType)) {
                        this._error(2228, {
                            typeName: pConditionType.toString()
                        });
                        return null;
                    }
                    if (isNonIfStmt) {
                        pStmt = this.analyzeNonIfStmt(pChildren[0]);
                    } else {
                        pStmt = this.analyzeStmt(pChildren[0]);
                    }
                    pWhileStmt.push(pCondition, true);
                    pWhileStmt.push(pStmt, true);
                }
                if (!pWhileStmt.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pWhileStmt.getLastError());
                }
                ;
                return pWhileStmt;
            };
            Effect.prototype.analyzeIfStmt = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var isIfElse = (pChildren.length === 7);
                var pIfStmtInstruction = new fx.IfStmtInstruction();
                var pCondition = this.analyzeExpr(pChildren[pChildren.length - 3]);
                var pConditionType = pCondition.getType();
                var pBoolType = Effect.getSystemType("bool");
                var pIfStmt = null;
                var pElseStmt = null;
                if (!pConditionType.isEqual(pBoolType)) {
                    this._error(2230, {
                        typeName: pConditionType.toString()
                    });
                    return null;
                }
                pIfStmtInstruction.push(pCondition, true);
                if (isIfElse) {
                    pIfStmtInstruction.setOperator("if_else");
                    pIfStmt = this.analyzeNonIfStmt(pChildren[2]);
                    pElseStmt = this.analyzeStmt(pChildren[0]);
                    pIfStmtInstruction.push(pIfStmt, true);
                    pIfStmtInstruction.push(pElseStmt, true);
                } else {
                    pIfStmtInstruction.setOperator("if");
                    pIfStmt = this.analyzeNonIfStmt(pChildren[0]);
                    pIfStmtInstruction.push(pIfStmt, true);
                }
                if (!pIfStmtInstruction.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pIfStmtInstruction.getLastError());
                }
                ;
                return pIfStmtInstruction;
            };
            Effect.prototype.analyzeNonIfStmt = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sFirstNodeName = pChildren[pChildren.length - 1].name;
                switch(sFirstNodeName) {
                    case "SimpleStmt":
                        return this.analyzeSimpleStmt(pChildren[0]);
                    case "T_KW_WHILE":
                        return this.analyzeWhileStmt(pNode);
                    case "T_KW_FOR":
                        return this.analyzeForStmt(pNode);
                }
            };
            Effect.prototype.analyzeForStmt = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var isNonIfStmt = (pNode.name === "NonIfStmt");
                var pForStmtInstruction = new fx.ForStmtInstruction();
                var pStmt = null;
                this.newScope();
                this.analyzeForInit(pChildren[pChildren.length - 3], pForStmtInstruction);
                this.analyzeForCond(pChildren[pChildren.length - 4], pForStmtInstruction);
                if (pChildren.length === 7) {
                    this.analyzeForStep(pChildren[2], pForStmtInstruction);
                } else {
                    pForStmtInstruction.push(null);
                }
                if (isNonIfStmt) {
                    pStmt = this.analyzeNonIfStmt(pChildren[0]);
                } else {
                    pStmt = this.analyzeStmt(pChildren[0]);
                }
                pForStmtInstruction.push(pStmt, true);
                this.endScope();
                if (!pForStmtInstruction.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                    this._errorFromInstruction(pForStmtInstruction.getLastError());
                }
                ;
                return pForStmtInstruction;
            };
            Effect.prototype.analyzeForInit = function (pNode, pForStmtInstruction) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sFirstNodeName = pChildren[pChildren.length - 1].name;
                switch(sFirstNodeName) {
                    case "VariableDecl":
                        this.analyzeVariableDecl(pChildren[0], pForStmtInstruction);
                        break;
                    case "Expr":
                        var pExpr = this.analyzeExpr(pChildren[0]);
                        pForStmtInstruction.push(pExpr, true);
                        break;
                    default:
                        pForStmtInstruction.push(null);
                        break;
                }
                return;
            };
            Effect.prototype.analyzeForCond = function (pNode, pForStmtInstruction) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                if (pChildren.length === 1) {
                    pForStmtInstruction.push(null);
                    return;
                }
                var pConditionExpr = this.analyzeExpr(pChildren[1]);
                pForStmtInstruction.push(pConditionExpr, true);
                return;
            };
            Effect.prototype.analyzeForStep = function (pNode, pForStmtInstruction) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pStepExpr = this.analyzeExpr(pChildren[0]);
                pForStmtInstruction.push(pStepExpr, true);
                return;
            };
            Effect.prototype.analyzeUseDecl = function (pNode) {
                this.setAnalyzedNode(pNode);
                this.setStrictModeOn();
            };
            Effect.prototype.analyzeTechniqueForImport = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pTechnique = new fx.TechniqueInstruction();
                var sTechniqueName = this.analyzeComplexName(pChildren[pChildren.length - 2]);
                var isComplexName = pChildren[pChildren.length - 2].children.length !== 1;
                pTechnique.setName(sTechniqueName, isComplexName);
                for(var i = pChildren.length - 3; i >= 0; i--) {
                    if (pChildren[i].name === "Annotation") {
                        var pAnnotation = this.analyzeAnnotation(pChildren[i]);
                        pTechnique.setAnnotation(pAnnotation);
                    } else if (pChildren[i].name === "Semantic") {
                        var sSemantic = this.analyzeSemantic(pChildren[i]);
                        pTechnique.setSemantic(sSemantic);
                    } else {
                        this.analyzeTechniqueBodyForImports(pChildren[i], pTechnique);
                    }
                }
                this.addTechnique(pTechnique);
            };
            Effect.prototype.analyzeComplexName = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sName = "";
                for(var i = pChildren.length - 1; i >= 0; i--) {
                    sName += pChildren[i].value;
                }
                return sName;
            };
            Effect.prototype.analyzeTechniqueBodyForImports = function (pNode, pTechnique) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                for(var i = pChildren.length - 2; i >= 1; i--) {
                    this.analyzePassDeclForImports(pChildren[i], pTechnique);
                }
            };
            Effect.prototype.analyzePassDeclForImports = function (pNode, pTechnique) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                if (pChildren[0].name === "ImportDecl") {
                    this.analyzeImportDecl(pChildren[0], pTechnique);
                } else if (pChildren.length > 1) {
                    var pPass = new fx.PassInstruction();
                    this.analyzePassStateBlockForShaders(pChildren[0], pPass);
                    pPass._setParseNode(pNode);
                    pTechnique.addPass(pPass);
                }
            };
            Effect.prototype.analyzePassStateBlockForShaders = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                for(var i = pChildren.length - 2; i >= 1; i--) {
                    this.analyzePassStateForShader(pChildren[i], pPass);
                }
            };
            Effect.prototype.analyzePassStateForShader = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                if (pChildren.length === 1) {
                    pPass._markAsComplex(true);
                    if (pChildren[0].name === "StateIf") {
                        this.analyzePassStateIfForShader(pChildren[0], pPass);
                    } else if (pChildren[0].name === "StateSwitch") {
                        this.analyzePassStateSwitchForShader(pChildren[0], pPass);
                    }
                    return;
                }
                var sType = pChildren[pChildren.length - 1].value.toUpperCase();
                var eShaderType = akra.EFunctionType.k_Vertex;
                if (sType === "VERTEXSHADER") {
                    eShaderType = akra.EFunctionType.k_Vertex;
                } else if (sType === "PIXELSHADER") {
                    eShaderType = akra.EFunctionType.k_Pixel;
                } else {
                    return;
                }
                pNode.isAnalyzed = true;
                var pStateExprNode = pChildren[pChildren.length - 3];
                var pExprNode = pStateExprNode.children[pStateExprNode.children.length - 1];
                var pCompileExpr = this.analyzeExpr(pExprNode);
                var pShaderFunc = pCompileExpr.getFunction();
                if (eShaderType === akra.EFunctionType.k_Vertex) {
                    if (!pShaderFunc._checkDefenitionForVertexUsage()) {
                        this._error(2259, {
                            funcDef: pShaderFunc._getStringDef()
                        });
                    }
                } else {
                    if (!pShaderFunc._checkDefenitionForPixelUsage()) {
                        this._error(2260, {
                            funcDef: pShaderFunc._getStringDef()
                        });
                    }
                }
                pShaderFunc._markUsedAs(eShaderType);
                pPass._addFoundFunction(pNode, pShaderFunc, eShaderType);
            };
            Effect.prototype.analyzePassStateIfForShader = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                if (pChildren.length === 5) {
                    this.analyzePassStateBlockForShaders(pChildren[0], pPass);
                } else if (pChildren.length === 7 && pChildren[0].name === "PassStateBlock") {
                    this.analyzePassStateBlockForShaders(pChildren[2], pPass);
                    this.analyzePassStateBlockForShaders(pChildren[0], pPass);
                } else {
                    this.analyzePassStateBlockForShaders(pChildren[2], pPass);
                    this.analyzePassStateIfForShader(pChildren[0], pPass);
                }
            };
            Effect.prototype.analyzePassStateSwitchForShader = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                this.analyzePassCaseBlockForShader(pChildren[0], pPass);
            };
            Effect.prototype.analyzePassCaseBlockForShader = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                for(var i = pChildren.length - 2; i >= 1; i--) {
                    if (pChildren[i].name === "CaseState") {
                        this.analyzePassCaseStateForShader(pChildren[i], pPass);
                    } else if (pChildren[i].name === "DefaultState") {
                        this.analyzePassDefaultStateForShader(pChildren[i], pPass);
                    }
                }
            };
            Effect.prototype.analyzePassCaseStateForShader = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                for(var i = pChildren.length - 4; i >= 0; i--) {
                    if (pChildren[i].name === "PassState") {
                        this.analyzePassStateForShader(pChildren[i], pPass);
                    }
                }
            };
            Effect.prototype.analyzePassDefaultStateForShader = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                for(var i = pChildren.length - 3; i >= 0; i--) {
                    if (pChildren[i].name === "PassState") {
                        this.analyzePassStateForShader(pChildren[i], pPass);
                    }
                }
            };
            Effect.prototype.resumeTechniqueAnalysis = function (pTechnique) {
                var pPassList = pTechnique.getPassList();
                for(var i = 0; i < pPassList.length; i++) {
                    this.resumePassAnalysis(pPassList[i]);
                }
                if (!pTechnique.checkForCorrectImports()) {
                    this._error(2275, {
                        techniqueName: pTechnique.getName()
                    });
                    return;
                }
                pTechnique.finalizeTechnique(this._sProvideNameSpace, this._pGlobalComponentList, this._pGlobalComponetShiftList);
            };
            Effect.prototype.resumePassAnalysis = function (pPass) {
                var pNode = pPass._getParseNode();
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                this.setAnalyzeInPass(true);
                this.analyzePassStateBlock(pChildren[0], pPass);
                this.setAnalyzeInPass(false);
                pPass.finalizePass();
            };
            Effect.prototype.analyzePassStateBlock = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                pPass._addCodeFragment("{");
                for(var i = pChildren.length - 2; i >= 1; i--) {
                    this.analyzePassState(pChildren[i], pPass);
                }
                pPass._addCodeFragment("}");
            };
            Effect.prototype.analyzePassState = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                if (pChildren.length === 1) {
                    if (pChildren[0].name === "StateIf") {
                        this.analyzePassStateIf(pChildren[0], pPass);
                    } else if (pChildren[0].name === "StateSwitch") {
                        this.analyzePassStateSwitch(pChildren[0], pPass);
                    }
                    return;
                }
                if (pNode.isAnalyzed) {
                    var pFunc = pPass._getFoundedFunction(pNode);
                    var eShaderType = pPass._getFoundedFunctionType(pNode);
                    var pShader = null;
                    if (eShaderType === akra.EFunctionType.k_Vertex) {
                        pShader = pFunc._getVertexShader();
                    } else {
                        pShader = pFunc._getPixelShader();
                    }
                    pPass.addShader(pShader);
                } else {
                    var sType = pChildren[pChildren.length - 1].value.toUpperCase();
                    var pStateExprNode = pChildren[pChildren.length - 3];
                    var pExprNode = pStateExprNode.children[pStateExprNode.children.length - 1];
                    switch(sType) {
                        case "ZENABLE":
                        case "ZWRITEENABLE":
                        case "SRCBLEND":
                        case "DESTBLEND":
                        case "CULLMODE":
                        case "ZFUNC":
                        case "DITHERENABLE":
                        case "ALPHABLENDENABLE":
                        case "ALPHATESTENABLE":
                            break;
                        default:
 {
                                akra.logger.setSourceLocation("fx/Effect.ts", 3780);
                                akra.logger.warning("Unsupported render state type used: " + sType + ". WebGl...");
                            }
                            ;
                            return;
                    }
                    if (pExprNode.value === "{" || pExprNode.value === "<" || ((pExprNode.value) === null)) {
 {
                            akra.logger.setSourceLocation("fx/Effect.ts", 3786);
                            akra.logger.warning("So pass state are incorrect");
                        }
                        ;
                        return;
                    }
                    var sValue = pExprNode.value.toUpperCase();
                    switch(sType) {
                        case "ALPHABLENDENABLE":
                        case "ALPHATESTENABLE":
 {
                                akra.logger.setSourceLocation("fx/Effect.ts", 3794);
                                akra.logger.warning("ALPHABLENDENABLE/ALPHATESTENABLE not supported in WebGL.");
                            }
                            ;
                            return;
                        case "DITHERENABLE":
                        case "ZENABLE":
                        case "ZWRITEENABLE":
                            switch(sValue) {
                                case "TRUE":
                                case "FALSE":
                                    break;
                                default:
 {
                                        akra.logger.setSourceLocation("fx/Effect.ts", 3807);
                                        akra.logger.warning("Unsupported render state ALPHABLENDENABLE/ZENABLE/ZWRITEENABLE/DITHERENABLE value used: " + sValue + ".");
                                    }
                                    ;
                                    return;
                            }
                            break;
                        case "SRCBLEND":
                        case "DESTBLEND":
                            switch(sValue) {
                                case "ZERO":
                                case "ONE":
                                case "SRCCOLOR":
                                case "INVSRCCOLOR":
                                case "SRCALPHA":
                                case "INVSRCALPHA":
                                case "DESTALPHA":
                                case "INVDESTALPHA":
                                case "DESTCOLOR":
                                case "INVDESTCOLOR":
                                case "SRCALPHASAT":
                                    break;
                                default:
 {
                                        akra.logger.setSourceLocation("fx/Effect.ts", 3829);
                                        akra.logger.warning("Unsupported render state SRCBLEND/DESTBLEND value used: " + sValue + ".");
                                    }
                                    ;
                                    return;
                            }
                            break;
                        case "CULLMODE":
                            switch(sValue) {
                                case "NONE":
                                case "CW":
                                case "CCW":
                                case "FRONT_AND_BACK":
                                    break;
                                default:
 {
                                        akra.logger.setSourceLocation("fx/Effect.ts", 3842);
                                        akra.logger.warning("Unsupported render state SRCBLEND/DESTBLEND value used: " + sValue + ".");
                                    }
                                    ;
                                    return;
                            }
                            break;
                        case "ZFUNC":
                            switch(sValue) {
                                case "NEVER":
                                case "LESS":
                                case "EQUAL":
                                case "LESSEQUAL":
                                case "GREATER":
                                case "NOTEQUAL":
                                case "GREATEREQUAL":
                                case "ALWAYS":
                                    break;
                                default:
 {
                                        akra.logger.setSourceLocation("fx/Effect.ts", 3860);
                                        akra.logger.warning("Unsupported render state ZFUNC value used: " + sValue + ".");
                                    }
                                    ;
                                    return;
                            }
                            break;
                    }
                    pPass.setState(sType, sValue);
                }
            };
            Effect.prototype.analyzePassStateIf = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pIfExpr = this.analyzeExpr(pChildren[pChildren.length - 3]);
                pIfExpr.prepareFor(akra.EFunctionType.k_PassFunction);
                pPass._addCodeFragment("if(" + pIfExpr.toFinalCode() + ")");
                this.analyzePassStateBlock(pChildren[pChildren.length - 5], pPass);
                if (pChildren.length > 5) {
                    pPass._addCodeFragment("else");
                    if (pChildren[0].name === "PassStateBlock") {
                        this.analyzePassStateBlock(pChildren[0], pPass);
                    } else {
                        pPass._addCodeFragment(" ");
                        this.analyzePassStateIf(pChildren[0], pPass);
                    }
                }
            };
            Effect.prototype.analyzePassStateSwitch = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sCodeFragment = "switch";
                var pSwitchExpr = this.analyzeExpr(pChildren[pChildren.length - 3]);
                pSwitchExpr.prepareFor(akra.EFunctionType.k_PassFunction);
                pPass._addCodeFragment("(" + pSwitchExpr.toFinalCode() + ")");
                this.analyzePassCaseBlock(pChildren[0], pPass);
            };
            Effect.prototype.analyzePassCaseBlock = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                pPass._addCodeFragment("{");
                for(var i = pChildren.length - 2; i >= 1; i--) {
                    if (pChildren[i].name === "CaseState") {
                        this.analyzePassCaseState(pChildren[i], pPass);
                    } else if (pChildren[i].name === "DefaultState") {
                        this.analyzePassDefault(pChildren[i], pPass);
                    }
                }
                pPass._addCodeFragment("}");
            };
            Effect.prototype.analyzePassCaseState = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var pCaseStateExpr = this.analyzeExpr(pChildren[pChildren.length - 2]);
                pCaseStateExpr.prepareFor(akra.EFunctionType.k_PassFunction);
                pPass._addCodeFragment("case " + pCaseStateExpr.toFinalCode() + ": ");
                for(var i = pChildren.length - 4; i >= 0; i--) {
                    if (pChildren[i].name === "PassState") {
                        this.analyzePassStateForShader(pChildren[i], pPass);
                    } else {
                        pPass._addCodeFragment(pChildren[i].value);
                    }
                }
            };
            Effect.prototype.analyzePassDefault = function (pNode, pPass) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                pPass._addCodeFragment("default: ");
                for(var i = pChildren.length - 3; i >= 0; i--) {
                    if (pChildren[i].name === "PassState") {
                        this.analyzePassStateForShader(pChildren[i], pPass);
                    } else {
                        pPass._addCodeFragment(pChildren[i].value);
                    }
                }
            };
            Effect.prototype.analyzeImportDecl = function (pNode, pTechnique) {
                if (typeof pTechnique === "undefined") { pTechnique = null; }
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var sComponentName = this.analyzeComplexName(pChildren[pChildren.length - 2]);
                var iShift = 0;
                if (pChildren[0].name === "ExtOpt") {
 {
                        akra.logger.setSourceLocation("fx/Effect.ts", 3974);
                        akra.logger.warning("We don`t suppor ext-commands for import");
                    }
                    ;
                }
                if (pChildren.length !== 2) {
                    iShift = this.analyzeShiftOpt(pChildren[0]);
                }
                var pComponent = this._pComposer.getComponentByName(sComponentName);
                if (!pComponent) {
                    this._error(2277, {
                        componentName: sComponentName
                    });
                    return;
                }
                this.addComponent(pComponent, iShift, pTechnique);
            };
            Effect.prototype.analyzeProvideDecl = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                if (pChildren.length === 2) {
                    this._sProvideNameSpace = this.analyzeComplexName(pChildren[0]);
                } else {
                    this._error(2303);
                    return;
                }
            };
            Effect.prototype.analyzeShiftOpt = function (pNode) {
                this.setAnalyzedNode(pNode);
                var pChildren = pNode.children;
                var iShift = (pChildren[0].value);
                if (pChildren.length === 2) {
                    iShift *= 1;
                } else {
                    iShift *= -1;
                }
                return iShift;
            };
            Effect.prototype.addComponent = function (pComponent, iShift, pTechnique) {
                if (!((pTechnique) === null)) {
                    pTechnique.addComponent(pComponent, iShift);
                } else {
                    if (((this._pGlobalComponentList) === null)) {
                        this._pGlobalComponentList = [];
                        this._pGlobalComponetShiftList = [];
                    }
                    this._pGlobalComponentList.push(pComponent);
                    this._pGlobalComponetShiftList.push(iShift);
                }
                var pComponentTechnique = pComponent.getTechnique();
                if (this.isAddedTechnique(pComponentTechnique)) {
                    return;
                }
                var pSharedListV = pComponentTechnique.getSharedVariablesForVertex();
                var pSharedListP = pComponentTechnique.getSharedVariablesForPixel();
                for(var i = 0; i < pSharedListV.length; i++) {
                    this.addExternalSharedVariable(pSharedListV[i], akra.EFunctionType.k_Vertex);
                }
                for(var i = 0; i < pSharedListP.length; i++) {
                    this.addExternalSharedVariable(pSharedListP[i], akra.EFunctionType.k_Pixel);
                }
                if (((this._pAddedTechniqueList) === null)) {
                    this._pAddedTechniqueList = [];
                }
                this._pAddedTechniqueList.push(pTechnique);
            };
            Effect.prototype.isAddedTechnique = function (pTechnique) {
                if (((this._pAddedTechniqueList) === null)) {
                    return false;
                }
                for(var i = 0; i < this._pAddedTechniqueList.length; i++) {
                    if (this._pAddedTechniqueList[i] === pTechnique) {
                        return true;
                    }
                }
                return false;
            };
            Effect.prototype.checkTwoOperandExprTypes = function (sOperator, pLeftType, pRightType) {
                if (pLeftType._isUnverifiable()) {
                    return pLeftType;
                }
                if (pRightType._isUnverifiable()) {
                    return pRightType;
                }
                var isComplex = pLeftType.isComplex() || pRightType.isComplex();
                var isArray = pLeftType.isNotBaseArray() || pRightType.isNotBaseArray();
                var isSampler = this.isSamplerType(pLeftType) || this.isSamplerType(pRightType);
                var pBoolType = Effect.getSystemType("bool").getVariableType();
                if (isArray || isSampler) {
                    return null;
                }
                if (sOperator === "%" || sOperator === "%=") {
                    return null;
                }
                if (this.isAssignmentOperator(sOperator)) {
                    if (!pLeftType.isWritable()) {
                        this._error(2267);
                        return null;
                    }
                    if (pLeftType.isStrongEqual(Effect.getSystemType("ptr"))) {
                        this.addPointerForExtract(pLeftType._getParentVarDecl());
                    }
                    if (!pRightType.isReadable()) {
                        this._error(2268);
                        return null;
                    }
                    if (sOperator !== "=" && !pLeftType.isReadable()) {
                        this._error(2268);
                    }
                } else {
                    if (!pLeftType.isReadable()) {
                        this._error(2268);
                        return null;
                    }
                    if (!pRightType.isReadable()) {
                        this._error(2268);
                        return null;
                    }
                }
                if (isComplex) {
                    if (sOperator === "=" && pLeftType.isEqual(pRightType)) {
                        return pLeftType;
                    } else if (this.isEqualOperator(sOperator) && !pLeftType._containArray() && !pLeftType._containSampler()) {
                        return pBoolType;
                    } else {
                        return null;
                    }
                }
                var pReturnType = null;
                var pLeftBaseType = (pLeftType.getBaseType()).getVariableType();
                var pRightBaseType = (pRightType.getBaseType()).getVariableType();
                if (pLeftType.isConst() && this.isAssignmentOperator(sOperator)) {
                    return null;
                }
                if (pLeftType.isEqual(pRightType)) {
                    if (this.isArithmeticalOperator(sOperator)) {
                        if (!this.isMatrixType(pLeftType) || (sOperator !== "/" && sOperator !== "/=")) {
                            return pLeftBaseType;
                        } else {
                            return null;
                        }
                    } else if (this.isRelationalOperator(sOperator)) {
                        if (this.isScalarType(pLeftType)) {
                            return pBoolType;
                        } else {
                            return null;
                        }
                    } else if (this.isEqualOperator(sOperator)) {
                        return pBoolType;
                    } else if (sOperator === "=") {
                        return pLeftBaseType;
                    } else {
                        return null;
                    }
                }
                if (this.isArithmeticalOperator(sOperator)) {
                    if (this.isBoolBasedType(pLeftType) || this.isBoolBasedType(pRightType) || this.isFloatBasedType(pLeftType) !== this.isFloatBasedType(pRightType) || this.isIntBasedType(pLeftType) !== this.isIntBasedType(pRightType)) {
                        return null;
                    }
                    if (this.isScalarType(pLeftType)) {
                        return pRightBaseType;
                    }
                    if (this.isScalarType(pRightType)) {
                        return pLeftBaseType;
                    }
                    if (sOperator === "*" || sOperator === "*=") {
                        if (this.isMatrixType(pLeftType) && this.isVectorType(pRightType) && pLeftType.getLength() === pRightType.getLength()) {
                            return pRightBaseType;
                        } else if (this.isMatrixType(pRightType) && this.isVectorType(pLeftType) && pLeftType.getLength() === pRightType.getLength()) {
                            return pLeftBaseType;
                        } else {
                            return null;
                        }
                    }
                }
                return null;
            };
            Effect.prototype.checkOneOperandExprType = function (sOperator, pType) {
                if (pType._isUnverifiable()) {
                    return pType;
                }
                var isComplex = pType.isComplex();
                var isArray = pType.isNotBaseArray();
                var isSampler = this.isSamplerType(pType);
                if (isComplex || isArray || isSampler) {
                    return null;
                }
                if (!pType.isReadable()) {
                    this._error(2268);
                    return null;
                }
                if (sOperator === "++" || sOperator === "--") {
                    if (!pType.isWritable()) {
                        this._error(2267);
                        return null;
                    }
                    if (pType.isStrongEqual(Effect.getSystemType("ptr"))) {
                        this.addPointerForExtract(pType._getParentVarDecl());
                    }
                    return pType;
                }
                if (sOperator === "!") {
                    var pBoolType = Effect.getSystemType("bool").getVariableType();
                    if (pType.isEqual(pBoolType)) {
                        return pBoolType;
                    } else {
                        return null;
                    }
                } else {
                    if (this.isBoolBasedType(pType)) {
                        return null;
                    } else {
                        return (pType.getBaseType()).getVariableType();
                    }
                }
            };
            Effect.prototype.isAssignmentOperator = function (sOperator) {
                return sOperator === "+=" || sOperator === "-=" || sOperator === "*=" || sOperator === "/=" || sOperator === "%=" || sOperator === "=";
            };
            Effect.prototype.isArithmeticalOperator = function (sOperator) {
                return sOperator === "+" || sOperator === "+=" || sOperator === "-" || sOperator === "-=" || sOperator === "*" || sOperator === "*=" || sOperator === "/" || sOperator === "/=";
            };
            Effect.prototype.isRelationalOperator = function (sOperator) {
                return sOperator === ">" || sOperator === ">=" || sOperator === "<" || sOperator === "<=";
            };
            Effect.prototype.isEqualOperator = function (sOperator) {
                return sOperator === "==" || sOperator === "!=";
            };
            Effect.prototype.isMatrixType = function (pType) {
                return pType.isEqual(Effect.getSystemType("float2x2")) || pType.isEqual(Effect.getSystemType("float3x3")) || pType.isEqual(Effect.getSystemType("float4x4")) || pType.isEqual(Effect.getSystemType("int2x2")) || pType.isEqual(Effect.getSystemType("int3x3")) || pType.isEqual(Effect.getSystemType("int4x4")) || pType.isEqual(Effect.getSystemType("bool2x2")) || pType.isEqual(Effect.getSystemType("bool3x3")) || pType.isEqual(Effect.getSystemType("bool4x4"));
            };
            Effect.prototype.isVectorType = function (pType) {
                return pType.isEqual(Effect.getSystemType("float2")) || pType.isEqual(Effect.getSystemType("float3")) || pType.isEqual(Effect.getSystemType("float4")) || pType.isEqual(Effect.getSystemType("bool2")) || pType.isEqual(Effect.getSystemType("bool3")) || pType.isEqual(Effect.getSystemType("bool4")) || pType.isEqual(Effect.getSystemType("int2")) || pType.isEqual(Effect.getSystemType("int3")) || pType.isEqual(Effect.getSystemType("int4"));
            };
            Effect.prototype.isScalarType = function (pType) {
                return pType.isEqual(Effect.getSystemType("bool")) || pType.isEqual(Effect.getSystemType("int")) || pType.isEqual(Effect.getSystemType("ptr")) || pType.isEqual(Effect.getSystemType("float"));
            };
            Effect.prototype.isFloatBasedType = function (pType) {
                return pType.isEqual(Effect.getSystemType("float")) || pType.isEqual(Effect.getSystemType("float2")) || pType.isEqual(Effect.getSystemType("float3")) || pType.isEqual(Effect.getSystemType("float4")) || pType.isEqual(Effect.getSystemType("float2x2")) || pType.isEqual(Effect.getSystemType("float3x3")) || pType.isEqual(Effect.getSystemType("float4x4")) || pType.isEqual(Effect.getSystemType("ptr"));
            };
            Effect.prototype.isIntBasedType = function (pType) {
                return pType.isEqual(Effect.getSystemType("int")) || pType.isEqual(Effect.getSystemType("int2")) || pType.isEqual(Effect.getSystemType("int3")) || pType.isEqual(Effect.getSystemType("int4")) || pType.isEqual(Effect.getSystemType("int2x2")) || pType.isEqual(Effect.getSystemType("int3x3")) || pType.isEqual(Effect.getSystemType("int4x4"));
            };
            Effect.prototype.isBoolBasedType = function (pType) {
                return pType.isEqual(Effect.getSystemType("bool")) || pType.isEqual(Effect.getSystemType("bool2")) || pType.isEqual(Effect.getSystemType("bool3")) || pType.isEqual(Effect.getSystemType("bool4")) || pType.isEqual(Effect.getSystemType("bool2x2")) || pType.isEqual(Effect.getSystemType("bool3x3")) || pType.isEqual(Effect.getSystemType("bool4x4"));
            };
            Effect.prototype.isSamplerType = function (pType) {
                return pType.isEqual(Effect.getSystemType("sampler")) || pType.isEqual(Effect.getSystemType("sampler2D")) || pType.isEqual(Effect.getSystemType("samplerCUBE")) || pType.isEqual(Effect.getSystemType("video_buffer"));
            };
            Effect.prototype.addExtactionStmts = function (pStmt) {
                var pPointerList = this.getPointerForExtractList();
                for(var i = 0; i < pPointerList.length; i++) {
                    this.generateExtractStmtFromPointer(pPointerList[i], pStmt);
                }
                this.clearPointersForExtract();
            };
            Effect.prototype.generateExtractStmtFromPointer = function (pPointer, pParentStmt) {
                var pPointerType = pPointer.getType();
                var pWhatExtracted = pPointerType._getDownPointer();
                var pWhatExtractedType = null;
                var pFunction = this.getCurrentAnalyzedFunction();
                while(!((pWhatExtracted) === null)) {
                    pWhatExtractedType = pWhatExtracted.getType();
                    if (!pWhatExtractedType.isComplex()) {
                        var pSingleExtract = new fx.ExtractStmtInstruction();
                        pSingleExtract.generateStmtForBaseType(pWhatExtracted, pWhatExtractedType.getPointer(), pWhatExtractedType.getVideoBuffer(), 0, null);
                        if (!pSingleExtract.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                            this._errorFromInstruction(pSingleExtract.getLastError());
                        }
                        ;
                        pParentStmt.push(pSingleExtract, true);
                        if (!((pFunction) === null)) {
                            pFunction._addUsedFunction(pSingleExtract.getExtractFunction());
                        }
                    } else {
                        this.generateExtractStmtForComplexVar(pWhatExtracted, pParentStmt, pWhatExtractedType.getPointer(), pWhatExtractedType.getVideoBuffer(), 0);
                    }
                    pWhatExtracted = pWhatExtractedType._getDownPointer();
                }
                return pParentStmt;
            };
            Effect.prototype.generateExtractStmtForComplexVar = function (pVarDecl, pParentStmt, pPointer, pBuffer, iPadding) {
                var pVarType = pVarDecl.getType();
                var pFieldNameList = pVarType.getFieldNameList();
                var pField = null;
                var pFieldType = null;
                var pSingleExtract = null;
                var pFunction = this.getCurrentAnalyzedFunction();
                for(var i = 0; i < pFieldNameList.length; i++) {
                    pField = pVarType.getField(pFieldNameList[i]);
                    if (((pField) === null)) {
                        continue;
                    }
                    pFieldType = pField.getType();
                    if (pFieldType.isPointer()) {
                        var pFieldPointer = pFieldType._getMainPointer();
                        pSingleExtract = new fx.ExtractStmtInstruction();
                        pSingleExtract.generateStmtForBaseType(pFieldPointer, pPointer, pFieldType.getVideoBuffer(), iPadding + pFieldType.getPadding(), null);
                        if (!pSingleExtract.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                            this._errorFromInstruction(pSingleExtract.getLastError());
                        }
                        ;
                        pParentStmt.push(pSingleExtract, true);
                        this.generateExtractStmtFromPointer(pFieldPointer, pParentStmt);
                        if (!((pFunction) === null)) {
                            pFunction._addUsedFunction(pSingleExtract.getExtractFunction());
                        }
                    } else if (pFieldType.isComplex()) {
                        this.generateExtractStmtForComplexVar(pField, pParentStmt, pPointer, pBuffer, iPadding + pFieldType.getPadding());
                    } else {
                        pSingleExtract = new fx.ExtractStmtInstruction();
                        pSingleExtract.generateStmtForBaseType(pField, pPointer, pBuffer, iPadding + pFieldType.getPadding(), null);
                        if (!pSingleExtract.check(akra.ECheckStage.CODE_TARGET_SUPPORT)) {
                            this._errorFromInstruction(pSingleExtract.getLastError());
                        }
                        ;
                        pParentStmt.push(pSingleExtract, true);
                        if (!((pFunction) === null)) {
                            pFunction._addUsedFunction(pSingleExtract.getExtractFunction());
                        }
                    }
                }
            };
            Effect.prototype.getNodeSourceLocation = function (pNode) {
                if (((pNode.line) !== undefined)) {
                    return {
                        line: pNode.line,
                        column: pNode.start
                    };
                } else {
                    return this.getNodeSourceLocation(pNode.children[pNode.children.length - 1]);
                }
            };
            return Effect;
        })();
        fx.Effect = Effect;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var TexcoordSwapper = (function () {
            function TexcoordSwapper() {
                this._pTmpToTex = null;
                this._pTexToTmp = null;
                this._pTexcoords = null;
                this._sTmpToTexCode = "";
                this._sTexToTmpCode = "";
                this._iMaxTexcoords = 0;
                this._iMaxTexcoords = akra.core.pool.resources.SurfaceMaterial.MAX_TEXTURES_PER_SURFACE;
                this._pTmpToTex = new Array(this._iMaxTexcoords);
                this._pTexToTmp = new Array(this._iMaxTexcoords);
                this._pTexcoords = new Array(this._iMaxTexcoords);
            }
            TexcoordSwapper.prototype.getTmpDeclCode = function () {
                return this._sTexToTmpCode;
            };
            TexcoordSwapper.prototype.getTecoordSwapCode = function () {
                return this._sTmpToTexCode;
            };
            TexcoordSwapper.prototype.clear = function () {
                for(var i = 0; i < this._iMaxTexcoords; i++) {
                    this._pTmpToTex[i] = "";
                    this._pTexToTmp[i] = "";
                    this._pTexcoords[i] = 0;
                }
                this._sTmpToTexCode = "";
                this._sTexToTmpCode = "";
            };
            TexcoordSwapper.prototype.generateSwapCode = function (pMaterial, pAttrConatiner) {
                this.clear();
                if (((pMaterial) === null)) {
                    return;
                }
                var pTexcoords = this._pTexcoords;
                for(var i = 0; i < this._iMaxTexcoords; i++) {
                    var iTexcoord = pMaterial.texcoord(i);
                    if (iTexcoord !== i && pAttrConatiner.hasTexcoord(i)) {
                        var pAttr = pAttrConatiner.getTexcoordVar(i);
                        this._pTexToTmp[i] = pAttr.getType().getBaseType().getRealName() + " " + "T" + i.toString() + "=" + pAttr.getRealName() + ";";
                        this._sTexToTmpCode += this._pTexToTmp[i] + "\n";
                    }
                    if (!pAttrConatiner.hasTexcoord(iTexcoord)) {
                        pTexcoords[iTexcoord] = 0;
                    } else {
                        pTexcoords[iTexcoord] = iTexcoord;
                    }
                }
                for(var i = 0; i < this._iMaxTexcoords; i++) {
                    if (pTexcoords[i] !== i && pAttrConatiner.hasTexcoord(i)) {
                        var pAttr = pAttrConatiner.getTexcoordVar(i);
                        if (this._pTexToTmp[pTexcoords[i]] !== "") {
                            this._pTmpToTex[i] = pAttr.getRealName() + "=" + this._pTexToTmp[pTexcoords[i]] + ";";
                        } else {
                            this._pTmpToTex[i] = pAttr.getRealName() + "=" + pAttrConatiner.getTexcoordVar(pTexcoords[i]).getRealName() + ";";
                        }
                        this._sTmpToTexCode += this._pTmpToTex[i] + "\n";
                    }
                }
            };
            return TexcoordSwapper;
        })();
        fx.TexcoordSwapper = TexcoordSwapper;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        function createSamplerState() {
            return {
                textureName: "",
                texture: null,
                wrap_s: akra.ETextureWrapModes.CLAMP_TO_EDGE,
                wrap_t: akra.ETextureWrapModes.CLAMP_TO_EDGE,
                mag_filter: akra.ETextureFilters.LINEAR,
                min_filter: akra.ETextureFilters.LINEAR
            };
        }
        fx.createSamplerState = createSamplerState;
        var PassInputBlend = (function () {
            function PassInputBlend(pCreator) {
                this._isFirstInit = true;
                this._pCreator = null;
                this._pUniformTypeMap = null;
                this._isUniformArrayMap = null;
                this._pForeignTypeMap = null;
                this._pTextureTypeMap = null;
                this._bNeedToCalcBlend = true;
                this._bNeedToCalcShader = true;
                this._iLastPassBlendId = 0;
                this._iLastShaderId = 0;
                this._pMaterialContainer = {
                    "DIFFUSE": null,
                    "AMBIENT": null,
                    "SPECULAR": null,
                    "EMISSIVE": null,
                    "SHININESS": 1.
                };
                this.samplers = null;
                this.samplerArrays = null;
                this.samplerArrayLength = null;
                this.uniforms = null;
                this.foreigns = null;
                this.textures = null;
                this.samplerKeys = null;
                this.samplerArrayKeys = null;
                this.uniformKeys = null;
                this.foreignKeys = null;
                this.textureKeys = null;
                this._pCreator = pCreator;
                this.init();
            }
            PassInputBlend.prototype.hasTexture = function (sName) {
                if (!this._pTextureTypeMap[sName]) {
                    this._pTextureTypeMap[sName] = akra.EAFXShaderVariableType.k_NotVar;
                    return false;
                }
                return true;
            };
            PassInputBlend.prototype.hasUniform = function (sName) {
                if (!this._pUniformTypeMap[sName]) {
                    this._pUniformTypeMap[sName] = akra.EAFXShaderVariableType.k_NotVar;
                    return false;
                }
                return true;
            };
            PassInputBlend.prototype.setUniform = function (sName, pValue) {
                var eType = this._pUniformTypeMap[sName];
                if (!eType) {
                    this._pUniformTypeMap[sName] = akra.EAFXShaderVariableType.k_NotVar;
                    return;
                }
                if (eType === akra.EAFXShaderVariableType.k_Sampler2D || eType === akra.EAFXShaderVariableType.k_SamplerCUBE) {
                    var isArray = this._isUniformArrayMap[sName];
                    if (isArray) {
                        this.setSamplerArray(sName, pValue);
                    } else {
                        this.setSampler(sName, pValue);
                    }
                    return;
                }
                this.uniforms[sName] = pValue;
            };
            PassInputBlend.prototype.setForeign = function (sName, pValue) {
                if (!this._pForeignTypeMap[sName]) {
                    this._pForeignTypeMap[sName] = akra.EAFXShaderVariableType.k_NotVar;
                    return;
                }
                var pOldValue = this.foreigns[sName];
                if (pOldValue !== pValue) {
                    this._bNeedToCalcBlend = true;
                    this._bNeedToCalcShader = true;
                }
                this.foreigns[sName] = pValue;
            };
            PassInputBlend.prototype.setSampler = function (sName, pValue) {
                PassInputBlend.copySamplerState(pValue, this.samplers[sName]);
            };
            PassInputBlend.prototype.setSamplerTexture = function (sName, pTexture) {
                if (this.hasUniform(sName)) {
                    if ((typeof (pTexture) === "string")) {
                        this.samplers[sName].textureName = pTexture;
                    } else {
                        this.samplers[sName].texture = pTexture;
                    }
                }
            };
            PassInputBlend.prototype.setSamplerArray = function (sName, pValue) {
                for(var i = 0; i < pValue.length; i++) {
                    PassInputBlend.copySamplerState(pValue[i], this.samplerArrays[sName][i]);
                }
                this.samplerArrayLength[sName] = pValue.length;
            };
            PassInputBlend.prototype.setStruct = function (sName, pValue) {
                this.setUniform(sName, pValue);
            };
            PassInputBlend.copySamplerState = function copySamplerState(pFrom, pTo) {
                pTo.textureName = pFrom.textureName;
                pTo.texture = pFrom.texture;
                pTo.wrap_s = pFrom.wrap_s;
                pTo.wrap_t = pFrom.wrap_t;
                pTo.mag_filter = pFrom.mag_filter;
                pTo.min_filter = pFrom.min_filter;
            };
            PassInputBlend.prototype.setTexture = function (sName, pValue) {
                if (!this._pTextureTypeMap[sName]) {
                    this._pTextureTypeMap[sName] = akra.EAFXShaderVariableType.k_NotVar;
                    return;
                }
                this.textures[sName] = pValue;
            };
            PassInputBlend.prototype.setSurfaceMaterial = function (pSurfaceMaterial) {
                if (((pSurfaceMaterial) === null)) {
                    return;
                }
                for(var i = 0; i < pSurfaceMaterial.totalTextures; i++) {
                    var pTexture = pSurfaceMaterial.texture(i);
                    this.setTexture("TEXTURE" + i, pTexture);
                }
                var pMaterial = pSurfaceMaterial.material;
                var pMatContainer = this._pMaterialContainer;
                pMatContainer.DIFFUSE = akra.util.colorToVec4(pMaterial.diffuse);
                pMatContainer.AMBIENT = akra.util.colorToVec4(pMaterial.ambient);
                pMatContainer.SPECULAR = akra.util.colorToVec4(pMaterial.specular);
                pMatContainer.EMISSIVE = akra.util.colorToVec4(pMaterial.emissive);
                pMatContainer.SHININESS = pMaterial.shininess;
                this.setStruct("MATERIAL", pMatContainer);
                this.setSamplerTexture("S_DIFFUSE", pSurfaceMaterial.texture(akra.ESurfaceMaterialTextures.DIFFUSE) || null);
                this.setSamplerTexture("S_AMBIENT", pSurfaceMaterial.texture(akra.ESurfaceMaterialTextures.AMBIENT) || null);
                this.setSamplerTexture("S_SPECULAR", pSurfaceMaterial.texture(akra.ESurfaceMaterialTextures.SPECULAR) || null);
                this.setSamplerTexture("S_EMISSIVE", pSurfaceMaterial.texture(akra.ESurfaceMaterialTextures.EMISSIVE) || null);
                this.setSamplerTexture("S_NORMAL", pSurfaceMaterial.texture(akra.ESurfaceMaterialTextures.NORMAL) || null);
            };
            PassInputBlend.prototype._getUnifromLength = function (sName) {
                return this._pCreator.uniformByRealName[sName].getType().getLength();
            };
            PassInputBlend.prototype._getUniformType = function (sName) {
                return this._pUniformTypeMap[sName];
            };
            PassInputBlend.prototype._getSamplerState = function (sName) {
                return this.samplers[sName];
            };
            PassInputBlend.prototype._getSamplerTexture = function (sName) {
                return this._getTextureForSamplerState(this._getSamplerState(sName));
            };
            PassInputBlend.prototype._getTextureForSamplerState = function (pSamplerState) {
                var pTexture = null;
                if (!((pSamplerState.texture) === null)) {
                    pTexture = pSamplerState.texture;
                } else if (pSamplerState.textureName !== "") {
                    if (this.hasTexture(pSamplerState.textureName)) {
                        pTexture = this.textures[pSamplerState.textureName];
                    }
                }
                return pTexture;
            };
            PassInputBlend.prototype._release = function () {
                for(var i = 0; i < this.uniformKeys.length; i++) {
                    this.uniforms[this.uniformKeys[i]] = null;
                }
                for(var i = 0; i < this.foreignKeys.length; i++) {
                    this.foreigns[this.foreignKeys[i]] = null;
                }
                for(var i = 0; i < this.textureKeys.length; i++) {
                    this.textures[this.textureKeys[i]] = null;
                }
                for(var i = 0; i < this.samplerKeys.length; i++) {
                    this.clearSamplerState(this.samplers[this.samplerKeys[i]]);
                }
                for(var i = 0; i < this.samplerArrayKeys.length; i++) {
                    var pStateList = this.samplerArrays[this.samplerArrayKeys[i]];
                    for(var j = 0; j < pStateList.length; j++) {
                        this.clearSamplerState(pStateList[j]);
                    }
                    this.samplerArrayLength[this.samplerArrayKeys[i]] = 0;
                }
                this._pCreator.releasePassInput(this);
                this._bNeedToCalcShader = true;
                this._bNeedToCalcBlend = true;
            };
            PassInputBlend.prototype._isNeedToCalcBlend = function () {
                return this._bNeedToCalcBlend;
            };
            PassInputBlend.prototype._isNeedToCalcShader = function () {
                return this._bNeedToCalcBlend || this._bNeedToCalcShader;
            };
            PassInputBlend.prototype._getLastPassBlendId = function () {
                return this._iLastPassBlendId;
            };
            PassInputBlend.prototype._getLastShaderId = function () {
                return this._iLastShaderId;
            };
            PassInputBlend.prototype._setPassBlendId = function (id) {
                this._iLastPassBlendId = id;
            };
            PassInputBlend.prototype._setShaderId = function (id) {
                this._iLastShaderId = id;
            };
            PassInputBlend.prototype._getAFXUniformVar = function (sName) {
                return this._pCreator.uniformByRealName[sName];
            };
            PassInputBlend.prototype.init = function () {
                this._pUniformTypeMap = {};
                this._isUniformArrayMap = {};
                this._pForeignTypeMap = {};
                this._pTextureTypeMap = {};
                this.samplers = {};
                this.samplerArrays = {};
                this.samplerArrayLength = {};
                this.uniforms = {};
                this.foreigns = {};
                this.textures = {};
                var pUniformKeys = this._pCreator.uniformRealNameList;
                var pForeignKeys = this._pCreator.foreignNameList;
                var pTextureKeys = this._pCreator.textureRealNameList;
                var pUniformMap = this._pCreator.uniformByRealName;
                var pForeignMap = this._pCreator.foreignByName;
                var pTextureMap = this._pCreator.textureByRealName;
                var eType = 0;
                var sName = "";
                var isArray = false;
                for(var i = 0; i < pUniformKeys.length; i++) {
                    sName = pUniformKeys[i];
                    eType = PassInputBlend.getVariableType(pUniformMap[sName]);
                    isArray = this.isVarArray(pUniformMap[sName]);
                    this._pUniformTypeMap[sName] = eType;
                    this._isUniformArrayMap[sName] = isArray;
                    if (eType === akra.EAFXShaderVariableType.k_Sampler2D || eType === akra.EAFXShaderVariableType.k_SamplerCUBE) {
                        if (isArray) {
                            this.samplerArrays[sName] = new Array(16);
                            this.samplerArrayLength[sName] = 0;
                            for(var j = 0; j < this.samplerArrays[sName].length; j++) {
                                this.samplerArrays[sName][j] = createSamplerState();
                            }
                        } else {
                            this.samplers[sName] = createSamplerState();
                        }
                    } else {
                        this.uniforms[sName] = null;
                    }
                }
                for(var i = 0; i < pForeignKeys.length; i++) {
                    sName = pForeignKeys[i];
                    eType = PassInputBlend.getVariableType(pForeignMap[sName]);
                    this._pForeignTypeMap[sName] = eType;
                    this.foreigns[sName] = null;
                }
                for(var i = 0; i < pTextureKeys.length; i++) {
                    sName = pTextureKeys[i];
                    eType = akra.EAFXShaderVariableType.k_Texture;
                    this._pTextureTypeMap[sName] = eType;
                    this.textures[sName] = null;
                }
                this.samplerKeys = Object.keys(this.samplers);
                this.samplerArrayKeys = Object.keys(this.samplerArrays);
                this.uniformKeys = Object.keys(this.uniforms);
                this.foreignKeys = Object.keys(this.foreigns);
                this.textureKeys = Object.keys(this.textures);
            };
            PassInputBlend.getVariableType = function getVariableType(pVar) {
                var sBaseType = pVar.getType().getBaseType().getName();
                switch(sBaseType) {
                    case "texture":
                        return akra.EAFXShaderVariableType.k_Texture;
                    case "float":
                        return akra.EAFXShaderVariableType.k_Float;
                    case "int":
                        return akra.EAFXShaderVariableType.k_Int;
                    case "bool":
                        return akra.EAFXShaderVariableType.k_Bool;
                    case "float2":
                        return akra.EAFXShaderVariableType.k_Float2;
                    case "int2":
                        return akra.EAFXShaderVariableType.k_Int2;
                    case "bool2":
                        return akra.EAFXShaderVariableType.k_Bool2;
                    case "float3":
                        return akra.EAFXShaderVariableType.k_Float3;
                    case "int3":
                        return akra.EAFXShaderVariableType.k_Int3;
                    case "bool3":
                        return akra.EAFXShaderVariableType.k_Bool3;
                    case "float4":
                        return akra.EAFXShaderVariableType.k_Float4;
                    case "int4":
                        return akra.EAFXShaderVariableType.k_Int4;
                    case "bool4":
                        return akra.EAFXShaderVariableType.k_Bool4;
                    case "float2x2":
                        return akra.EAFXShaderVariableType.k_Float2x2;
                    case "float3x3":
                        return akra.EAFXShaderVariableType.k_Float3x3;
                    case "float4x4":
                        return akra.EAFXShaderVariableType.k_Float4x4;
                    case "sampler":
                    case "sampler2D":
                        return akra.EAFXShaderVariableType.k_Sampler2D;
                    case "samplerCUBE":
                        return akra.EAFXShaderVariableType.k_SamplerCUBE;
                    default:
                        if (pVar.getType().isComplex()) {
                            return akra.EAFXShaderVariableType.k_Complex;
                        } else {
                            return akra.EAFXShaderVariableType.k_NotVar;
                        }
                }
            };
            PassInputBlend.prototype.isVarArray = function (pVar) {
                return pVar.getType().isNotBaseArray();
            };
            PassInputBlend.prototype.clearSamplerState = function (pState) {
                pState.textureName = "";
                pState.texture = null;
                pState.wrap_s = akra.ETextureWrapModes.CLAMP_TO_EDGE;
                pState.wrap_t = akra.ETextureWrapModes.CLAMP_TO_EDGE;
                pState.mag_filter = akra.ETextureFilters.LINEAR;
                pState.min_filter = akra.ETextureFilters.LINEAR;
            };
            return PassInputBlend;
        })();
        fx.PassInputBlend = PassInputBlend;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var Maker = (function () {
            function Maker(pComposer) {
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pComposer = null;
                this._pShaderProgram = null;
                this._pRealUniformNameList = null;
                this._pRealAttrNameList = null;
                this._pUniformExistMap = {};
                this._pAttrExistMap = {};
                this._pRealUniformLengthMap = {};
                this._pRealUniformTypeMap = {};
                this._pRealUnifromFromInput = null;
                this._pRealSampleArraysFromInput = null;
                this._pRealSamplersFromInput = null;
                this._pRealSamplersNames = null;
                this._isUsedZero2D = false;
                this._isUsedZeroCube = false;
                this._pAttrContainer = null;
                this._pRealAttrSlotFromFlows = null;
                this._pRealAttrIsIndexData = null;
                this._pBufferSamplersFromFlows = null;
                this._pDataPoolArray = new akra.util.ObjectArray();
                this._pComposer = pComposer;
            }
            Maker.prototype.getGuid = function () {
                return this._iGuid;
            };
            Maker.prototype.isArray = function (sName) {
                return this.getLength(sName) > 0;
            };
            Maker.prototype.getType = function (sName) {
                return this._pRealUniformTypeMap[sName];
            };
            Maker.prototype.getLength = function (sName) {
                return this._pRealUniformLengthMap[sName];
            };
            Maker.prototype.setUniform = function (sName, pValue) {
                var eType = this.getType(sName);
                var iLength = this.getLength(sName);
                if (akra.webgl.isANGLE && (!((eType) !== undefined) || eType === akra.EAFXShaderVariableType.k_NotVar)) {
                    this._pRealUniformTypeMap[sName] = akra.EAFXShaderVariableType.k_NotVar;
                    return;
                }
                if (iLength > 0) {
                    this.applyUnifromArray(sName, eType, pValue);
                } else {
                    this.applyUniform(sName, eType, pValue);
                }
            };
            Maker.prototype.applyUnifromArray = function (sName, eType, pValue) {
                switch(eType) {
                    case akra.EAFXShaderVariableType.k_Float:
                        this._pShaderProgram.setFloat32Array(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_Int:
                        this._pShaderProgram.setInt32Array(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_Float2:
                        this._pShaderProgram.setVec2Array(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_Int2:
                        this._pShaderProgram.setVec2iArray(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_Float3:
                        this._pShaderProgram.setVec3Array(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_Int3:
                        this._pShaderProgram.setVec3iArray(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_Float4:
                        this._pShaderProgram.setVec4Array(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_Int4:
                        this._pShaderProgram.setVec4iArray(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_Float3x3:
                        this._pShaderProgram.setMat3Array(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_Float4x4:
                        this._pShaderProgram.setMat4Array(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_Sampler2D:
                        this._pShaderProgram.setSamplerArray(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_SamplerCUBE:
                        this._pShaderProgram.setSamplerArray(sName, pValue);
                        break;
                    default:
 {
                            akra.logger.setSourceLocation("fx/Maker.ts", 147);
                            akra.logger.criticalError("Wrong uniform array type (" + eType + ") with name " + sName);
                        }
                        ;
                }
            };
            Maker.prototype.applyUniform = function (sName, eType, pValue) {
                switch(eType) {
                    case akra.EAFXShaderVariableType.k_Float:
                        this._pShaderProgram.setFloat(sName, pValue || 0.);
                        break;
                    case akra.EAFXShaderVariableType.k_Int:
                        this._pShaderProgram.setInt(sName, pValue || 0);
                        break;
                    case akra.EAFXShaderVariableType.k_Bool:
                        this._pShaderProgram.setInt(sName, pValue ? 1 : 0);
                        break;
                    case akra.EAFXShaderVariableType.k_Float2:
                        this._pShaderProgram.setVec2(sName, pValue || akra.vec2(0));
                        break;
                    case akra.EAFXShaderVariableType.k_Int2:
                        this._pShaderProgram.setVec2i(sName, pValue || akra.vec2(0));
                        break;
                    case akra.EAFXShaderVariableType.k_Float3:
                        this._pShaderProgram.setVec3(sName, pValue || akra.vec3(0));
                        break;
                    case akra.EAFXShaderVariableType.k_Int3:
                        this._pShaderProgram.setVec3i(sName, pValue || akra.vec3(0));
                        break;
                    case akra.EAFXShaderVariableType.k_Float4:
                        this._pShaderProgram.setVec4(sName, pValue || akra.vec4(0));
                        break;
                    case akra.EAFXShaderVariableType.k_Int4:
                        this._pShaderProgram.setVec4i(sName, pValue || akra.vec4(0));
                        break;
                    case akra.EAFXShaderVariableType.k_Float3x3:
                        this._pShaderProgram.setMat3(sName, pValue || akra.mat3(0));
                        break;
                    case akra.EAFXShaderVariableType.k_Float4x4:
                        this._pShaderProgram.setMat4(sName, pValue || akra.mat4(0));
                        break;
                    case akra.EAFXShaderVariableType.k_Sampler2D:
                        this._pShaderProgram.setSampler(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_SamplerCUBE:
                        this._pShaderProgram.setSampler(sName, pValue);
                        break;
                    case akra.EAFXShaderVariableType.k_SamplerVertexTexture:
                        this._pShaderProgram.setVertexBuffer(sName, pValue);
                        break;
                    default:
 {
                            akra.logger.setSourceLocation("fx/Maker.ts", 213);
                            akra.logger.criticalError("Wrong uniform type (" + eType + ") with name " + sName);
                        }
                        ;
                }
            };
            Object.defineProperty(Maker.prototype, "shaderProgram", {
                get: function () {
                    return this._pShaderProgram;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Maker.prototype, "attributeSemantics", {
                get: function () {
                    return this._pRealAttrSlotFromFlows;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Maker.prototype, "attributeNames", {
                get: function () {
                    return this._pRealAttrNameList;
                },
                enumerable: true,
                configurable: true
            });
            Maker.prototype._create = function (sVertex, sPixel) {
                var pRmgr = this._pComposer.getEngine().getResourceManager();
                var pProgram = pRmgr.createShaderProgram(".shader-prorgam-" + this.getGuid().toString());
                if (!pProgram.create(sVertex, sPixel)) {
                    return false;
                }
                this._pRealUniformNameList = pProgram._getActiveUniformNames();
                this._pRealAttrNameList = pProgram._getActiveAttributeNames();
                this._pShaderProgram = pProgram;
                for(var i = 0; i < this._pRealUniformNameList.length; i++) {
                    this._pUniformExistMap[this._pRealUniformNameList[i]] = true;
                }
                for(var i = 0; i < this._pRealAttrNameList.length; i++) {
                    this._pAttrExistMap[this._pRealAttrNameList[i]] = true;
                }
                return true;
            };
            Maker.prototype._getShaderInput = function () {
                return this._pDataPoolArray.length > 0 ? this._pDataPoolArray.pop() : this._createDataPool();
            };
            Maker.prototype._releaseShaderInput = function (pPool) {
                this._pDataPoolArray.push(pPool);
            };
            Maker.prototype.isUniformExists = function (sName) {
                return this._pUniformExistMap[sName];
            };
            Maker.prototype.isAttrExists = function (sName) {
                return this._pAttrExistMap[sName];
            };
            Maker.prototype._createDataPool = function () {
                var pInput = {};
                for(var i = 0; i < this._pRealUniformNameList.length; i++) {
                    var sName = this._pRealUniformNameList[i];
                    pInput[sName] = null;
                    var eType = this._pRealUniformTypeMap[sName];
                    var iLength = this._pRealUniformLengthMap[sName];
                    if ((eType === akra.EAFXShaderVariableType.k_Sampler2D || eType === akra.EAFXShaderVariableType.k_SamplerCUBE)) {
                        if (iLength > 0) {
                            pInput[sName] = new Array(iLength);
                            for(var j = 0; j < iLength; j++) {
                                pInput[sName][j] = fx.createSamplerState();
                            }
                        } else {
                            pInput[sName] = fx.createSamplerState();
                        }
                    }
                }
                for(var i = 0; i < this._pRealAttrNameList.length; i++) {
                    var sName = this._pRealAttrNameList[i];
                    pInput[sName] = null;
                }
                return pInput;
            };
            Maker.prototype._initInput = function (pPassInput, pBlend, pAttrs) {
                var pUniformKeys = pPassInput.uniformKeys;
                this._pRealUnifromFromInput = [];
                for(var i = 0; i < pUniformKeys.length; i++) {
                    var sName = pUniformKeys[i];
                    var eType = pPassInput._getUniformType(sName);
                    var iLength = pPassInput._getUnifromLength(sName);
                    if (eType === akra.EAFXShaderVariableType.k_Complex) {
                        if (this.expandStructUniforms(pPassInput._getAFXUniformVar(sName))) {
                            this._pRealUnifromFromInput.push(sName);
                        }
                        continue;
                    }
                    var sShaderName = (iLength > 0) ? (sName + "[0]") : sName;
                    if (this.isUniformExists(sShaderName)) {
                        this._pRealUniformTypeMap[sName] = eType;
                        this._pRealUniformLengthMap[sName] = iLength;
                        this._pRealUniformTypeMap[sShaderName] = eType;
                        this._pRealUniformLengthMap[sShaderName] = iLength;
                        this._pRealUnifromFromInput.push(sName);
                    } else {
                        this._pUniformExistMap[sShaderName] = false;
                    }
                }
                var pSamplerArrayKeys = pPassInput.samplerArrayKeys;
                this._pRealSampleArraysFromInput = [];
                for(var i = 0; i < pSamplerArrayKeys.length; i++) {
                    var sName = pSamplerArrayKeys[i];
                    var eType = pPassInput._getUniformType(sName);
                    var iLength = pPassInput._getUnifromLength(sName);
                    var sShaderName = sName + "[0]";
                    if (this.isUniformExists(sShaderName)) {
                        this._pRealUniformTypeMap[sName] = eType;
                        this._pRealUniformLengthMap[sName] = iLength;
                        this._pRealUniformTypeMap[sShaderName] = eType;
                        this._pRealUniformLengthMap[sShaderName] = iLength;
                        this._pRealSampleArraysFromInput.push(sName);
                    } else {
                        this._pUniformExistMap[sShaderName] = false;
                    }
                }
                this._pRealSamplersFromInput = [];
                this._pRealSamplersNames = [];
                var iTotalSamplerSlots = pBlend.totalActiveSlots;
                for(var i = 0; i < iTotalSamplerSlots; i++) {
                    if (i === 0) {
                        this._isUsedZero2D = this.isUniformExists("as0") || false;
                        this._isUsedZeroCube = this.isUniformExists("asc0") || false;
                        if (this._isUsedZero2D) {
                            this._pRealUniformTypeMap["as0"] = akra.EAFXShaderVariableType.k_Int;
                            this._pRealUniformLengthMap["as0"] = 0;
                        }
                        if (this._isUsedZeroCube) {
                            this._pRealUniformTypeMap["asc0"] = akra.EAFXShaderVariableType.k_Int;
                            this._pRealUniformLengthMap["asc0"] = 0;
                        }
                        continue;
                    }
                    var pSamplers = pBlend.getSamplersBySlot(i);
                    var sRealSamplerName = "as" + i.toString();
                    if (this.isUniformExists(sRealSamplerName)) {
                        var pSampler = pBlend.getSamplersBySlot(i).value(0);
                        var sSampler = pSampler.getSemantic() || pSampler.getName();
                        this._pRealSamplersFromInput.push(sSampler);
                        this._pRealSamplersNames.push(sRealSamplerName);
                        this._pRealUniformTypeMap[sRealSamplerName] = pSampler.getType().isSampler2D() ? akra.EAFXShaderVariableType.k_Sampler2D : akra.EAFXShaderVariableType.k_SamplerCUBE;
                        this._pRealUniformLengthMap[sRealSamplerName] = 0;
                    } else {
                        this._pUniformExistMap[sRealSamplerName] = false;
                    }
                }
                this._pRealAttrSlotFromFlows = [];
                this._pRealAttrIsIndexData = [];
                this._pBufferSamplersFromFlows = [];
                var iTotalAttrSlots = pAttrs.totalSlots;
                var pSemantics = pAttrs.semantics;
                var nPreparedAttrs = -1;
                var nPreparedBuffers = -1;
                var pSemanticsBySlot = {};
                for(var i = 0; i < pSemantics.length; i++) {
                    var sSemantic = pSemantics[i];
                    var iSlot = pAttrs.getSlotBySemantic(sSemantic);
                    if (iSlot === -1) {
                        continue;
                    }
                    var iBufferSlot = pAttrs.getBufferSlotBySemantic(sSemantic);
                    if (iSlot > nPreparedAttrs) {
                        var sAttrName = "aa" + iSlot.toString();
                        if (this.isAttrExists(sAttrName)) {
                            this._pRealAttrSlotFromFlows.push(sSemantic);
                            if (pAttrs.getType(sSemantic).isComplex()) {
                                this._pRealAttrIsIndexData.push(true);
                            } else {
                                this._pRealAttrIsIndexData.push(false);
                            }
                            pSemanticsBySlot[iSlot] = sSemantic;
                        } else {
                            this._pRealAttrSlotFromFlows.push(null);
                            this._pAttrExistMap[sAttrName] = false;
                            pSemanticsBySlot[iSlot] = null;
                        }
                        nPreparedAttrs++;
                    }
                    if (iBufferSlot > nPreparedBuffers) {
                        var sBufferName = "abs" + iBufferSlot.toString();
                        if (this.isUniformExists(sBufferName)) {
                            this._pBufferSamplersFromFlows.push(sSemantic);
                            this._pRealUniformTypeMap[sBufferName] = akra.EAFXShaderVariableType.k_SamplerVertexTexture;
                        } else {
                            this._pUniformExistMap[sBufferName] = false;
                        }
                        nPreparedBuffers++;
                    }
                }
                this._pAttrContainer = pAttrs;
                return true;
            };
            Maker.prototype._make = function (pPassInput, pBufferMap) {
                var pUniforms = pPassInput.uniforms;
                var pTextures = pPassInput.textures;
                var pSamplers = pPassInput.samplers;
                var pSamplerArrays = pPassInput.samplerArrays;
                var pInput = this._getShaderInput();
                for(var i = 0; i < this._pRealUnifromFromInput.length; i++) {
                    var sName = this._pRealUnifromFromInput[i];
                    var iLength = this._pRealUniformLengthMap[sName];
                    var eType = this._pRealUniformTypeMap[sName];
                    if (eType !== akra.EAFXShaderVariableType.k_Complex) {
                        if (iLength > 0) {
                            pInput[sName + "[0]"] = pUniforms[sName];
                        } else {
                            pInput[sName] = pUniforms[sName];
                        }
                    } else {
                        this.applyStructUniform(sName, pUniforms[sName], pInput);
                    }
                }
                for(var i = 0; i < this._pRealSamplersFromInput.length; i++) {
                    var sRealName = this._pRealSamplersNames[i];
                    var sName = this._pRealSamplersFromInput[i];
                    var pState = null;
                    var pTexture = null;
                    if (pPassInput._getAFXUniformVar(sName).getType().isArray()) {
                        pState = pSamplerArrays[sName][0];
                    } else {
                        pState = pPassInput._getSamplerState(sName);
                    }
                    pTexture = pPassInput._getTextureForSamplerState(pState);
                    this.setSamplerState(pInput[sRealName], pTexture, pState);
                }
                for(var i = 0; i < this._pRealSampleArraysFromInput.length; i++) {
                    var sName = this._pRealSampleArraysFromInput[i];
                    var iLength = this._pRealUniformLengthMap[sName];
                    var pSamplerStates = pSamplerArrays[sName];
                    var pInputStates = pInput[sName + "[0]"];
                    for(var j = 0; j < iLength; j++) {
                        var pTexture = pPassInput._getTextureForSamplerState(pSamplerStates[j]);
                        this.setSamplerState(pInputStates[j], pTexture, pSamplerStates[j]);
                    }
                }
                var iBufferSlot = 0;
                for(var i = 0; i < this._pRealAttrSlotFromFlows.length; i++) {
                    var sSemantic = this._pRealAttrSlotFromFlows[i];
                    if (((sSemantic) === null)) {
                        continue;
                    }
                    var isIndex = this._pRealAttrIsIndexData[i];
                    var pFlow = isIndex ? (pBufferMap.findFlow(sSemantic) || pBufferMap.getFlow(sSemantic, true)) : pBufferMap.getFlow(sSemantic, true);
                    var sBufferFlowSemantic = this._pBufferSamplersFromFlows[iBufferSlot];
                    if (sBufferFlowSemantic === sSemantic) {
                        var sBufferName = "abs" + iBufferSlot.toString();
                        pInput[sBufferName] = pFlow.data.buffer;
                        iBufferSlot++;
                    }
                    var sAttrName = "aa" + i.toString();
                    pInput[sAttrName] = pFlow;
                    var pOffsetVars = this._pAttrContainer.getOffsetVarsBySemantic(sSemantic);
                    if (!((pOffsetVars) === null)) {
                        var pVertexDecl = pFlow.data.getVertexDeclaration();
                        for(var j = 0; j < pOffsetVars.length; j++) {
                            var sOffsetSemantic = pOffsetVars[j].getSemantic();
                            var sOffsetName = pOffsetVars[j].getRealName();
                            if (this.isUniformExists(sOffsetName)) {
                                var pElement = pVertexDecl.findElement(sOffsetSemantic);
                                if (((pElement) === null)) {
                                    pInput[sOffsetName] = this._pAttrContainer.getOffsetDefault(sOffsetName);
                                } else {
                                    pInput[sOffsetName] = pElement.offset;
                                }
                                this._pRealUniformTypeMap[sOffsetName] = akra.EAFXShaderVariableType.k_Float;
                            } else {
                                this._pUniformExistMap[sOffsetName] = null;
                            }
                        }
                    }
                }
                if (this._isUsedZero2D) {
                    pInput["as0"] = 19;
                }
                if (this._isUsedZeroCube) {
                    pInput["asc0"] = 19;
                }
                return pInput;
            };
            Maker.prototype.setSamplerState = function (pOut, pTexture, pFrom) {
                pOut.texture = pTexture;
                pOut.wrap_s = pFrom.wrap_s;
                pOut.wrap_t = pFrom.wrap_t;
                pOut.mag_filter = pFrom.mag_filter;
                pOut.min_filter = pFrom.min_filter;
            };
            Maker.prototype.expandStructUniforms = function (pVariable, sPrevName) {
                if (typeof sPrevName === "undefined") { sPrevName = ""; }
                var sRealName = pVariable.getRealName();
                if (sPrevName !== "") {
                    sPrevName += "." + sRealName;
                } else {
                    sPrevName = sRealName;
                }
                var pVarType = pVariable.getType();
                var pFieldNameList = pVarType.getFieldNameList();
                var isArray = pVarType.isNotBaseArray();
                var iLength = isArray ? pVarType.getLength() : 1;
                if (isArray && (iLength === 0xffffff || iLength === 0)) {
                    this._pUniformExistMap[sPrevName] = false;
                    return;
                }
                var isAnyFieldExist = false;
                var sFieldPrevName = "";
                for(var i = 0; i < iLength; i++) {
                    sFieldPrevName = sPrevName;
                    if (isArray) {
                        sFieldPrevName += "[" + i + "]";
                    }
                    for(var j = 0; j < pFieldNameList.length; j++) {
                        var sFieldName = pFieldNameList[j];
                        var pField = pVarType.getField(sFieldName);
                        if (pField.getType().isComplex()) {
                            isAnyFieldExist = this.expandStructUniforms(pField, sFieldPrevName) || isAnyFieldExist;
                        } else {
                            var sFieldRealName = sFieldPrevName + "." + pField.getRealName();
                            var eFieldType = fx.PassInputBlend.getVariableType(pField);
                            var iFieldLength = pField.getType().getLength();
                            var sFieldShaderName = sFieldRealName;
                            if (pField.getType().isNotBaseArray()) {
                                sFieldShaderName += "[0]";
                            }
                            if (this.isUniformExists(sFieldShaderName)) {
                                this._pRealUniformTypeMap[sFieldRealName] = eFieldType;
                                this._pRealUniformLengthMap[sFieldRealName] = iFieldLength;
                                this._pUniformExistMap[sFieldRealName] = true;
                                this._pRealUniformTypeMap[sFieldShaderName] = eFieldType;
                                this._pRealUniformLengthMap[sFieldShaderName] = iFieldLength;
                                isAnyFieldExist = true;
                            } else {
                                this._pUniformExistMap[sFieldShaderName] = false;
                                this._pUniformExistMap[sFieldRealName] = false;
                            }
                        }
                    }
                }
                if (isAnyFieldExist) {
                    this._pRealUniformTypeMap[sPrevName] = akra.EAFXShaderVariableType.k_Complex;
                    this._pRealUniformLengthMap[sPrevName] = isArray ? iLength : 0;
                    this._pUniformExistMap[sPrevName] = true;
                } else {
                    this._pUniformExistMap[sPrevName] = false;
                }
                return isAnyFieldExist;
            };
            Maker.prototype.applyStructUniform = function (sName, pValue, pInput) {
                if (!((pValue) != null)) {
                    return;
                }
                var iLength = this._pRealUniformLengthMap[sName];
                if (iLength > 0) {
                    if (!((pValue.length) !== undefined)) {
                        return;
                    }
                    iLength = akra.math.min(iLength, pValue.length);
                    for(var i = 0; i < iLength; i++) {
                        var sFieldPrevName = sName + "[" + i + "]";
                        for(var j in pValue[i]) {
                            var sFieldName = sFieldPrevName + "." + j;
                            if (this.isUniformExists(sFieldName)) {
                                var eType = this._pRealUniformTypeMap[sFieldName];
                                if (eType === akra.EAFXShaderVariableType.k_Complex) {
                                    this.applyStructUniform(sFieldName, pValue[i][j], pInput);
                                } else {
                                    var iLength = this._pRealUniformLengthMap[sFieldName];
                                    if (iLength > 0) {
                                        pInput[sFieldName + "[0]"] = pValue[i][j];
                                    } else {
                                        pInput[sFieldName] = pValue[i][j];
                                    }
                                }
                            }
                        }
                    }
                } else {
                    for(var j in pValue) {
                        var sFieldName = sName + "." + j;
                        if (this.isUniformExists(sFieldName)) {
                            var eType = this._pRealUniformTypeMap[sFieldName];
                            if (eType === akra.EAFXShaderVariableType.k_Complex) {
                                this.applyStructUniform(sFieldName, pValue[j], pInput);
                            } else {
                                var iLength = this._pRealUniformLengthMap[sFieldName];
                                if (iLength > 0) {
                                    pInput[sFieldName + "[0]"] = pValue[j];
                                } else {
                                    pInput[sFieldName] = pValue[j];
                                }
                            }
                        }
                    }
                }
            };
            return Maker;
        })();
        fx.Maker = Maker;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var PassBlend = (function () {
            function PassBlend(pComposer) {
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pComposer = null;
                this._pFXMakerByHashMap = null;
                this._pExtSystemDataV = null;
                this._pComplexTypeContainerV = null;
                this._pForeignContainerV = null;
                this._pUniformContainerV = null;
                this._pSharedContainerV = null;
                this._pGlobalContainerV = null;
                this._pAttributeContainerV = null;
                this._pVaryingContainerV = null;
                this._pVertexOutType = null;
                this._pUsedFunctionListV = null;
                this._pPassFunctionListV = null;
                this._pTextureMapV = null;
                this._pExtSystemDataP = null;
                this._pComplexTypeContainerP = null;
                this._pForeignContainerP = null;
                this._pUniformContainerP = null;
                this._pSharedContainerP = null;
                this._pGlobalContainerP = null;
                this._pVaryingContainerP = null;
                this._pUsedFunctionListP = null;
                this._pPassFunctionListP = null;
                this._pTextureMapP = null;
                this._hasEmptyVertex = true;
                this._hasEmptyPixel = true;
                this._sUniformSamplerCodeV = "";
                this._sAttrBufferDeclCode = "";
                this._sAttrDeclCode = "";
                this._sAFXAttrDeclCode = "";
                this._sAttrBufferInitCode = "";
                this._sAFXAttrInitCode = "";
                this._sSystemExtBlockCodeV = "";
                this._sFunctionDefCodeV = "";
                this._sSharedVarCodeV = "";
                this._sVaryingDeclCodeV = "";
                this._sVertexOutDeclCode = "";
                this._sVertexOutToVaryingCode = "";
                this._sPassFunctionCallCodeV = "";
                this._sUniformSamplerCodeP = "";
                this._sSystemExtBlockCodeP = "";
                this._sFunctionDefCodeP = "";
                this._sSharedVarCodeP = "";
                this._sVaryingDeclCodeP = "";
                this._sPassFunctionCallCodeP = "";
                this._sVertexCode = "";
                this._sPixelCode = "";
                this._pDefaultSamplerBlender = null;
                this._pTexcoordSwapper = null;
                this._pComposer = pComposer;
                this._pFXMakerByHashMap = {};
                this._pExtSystemDataV = new fx.ExtSystemDataContainer();
                this._pComplexTypeContainerV = new fx.ComplexTypeBlendContainer();
                this._pForeignContainerV = new fx.VariableBlendContainer();
                this._pUniformContainerV = new fx.VariableBlendContainer();
                this._pSharedContainerV = new fx.VariableBlendContainer();
                this._pGlobalContainerV = new fx.VariableBlendContainer();
                this._pAttributeContainerV = new fx.AttributeBlendContainer();
                this._pVaryingContainerV = new fx.VariableBlendContainer();
                this._pVertexOutType = fx.Effect.getBaseVertexOutType();
                this._pUsedFunctionListV = [];
                this._pPassFunctionListV = [];
                this._pTextureMapV = {};
                this._pExtSystemDataP = new fx.ExtSystemDataContainer();
                this._pComplexTypeContainerP = new fx.ComplexTypeBlendContainer();
                this._pForeignContainerP = new fx.VariableBlendContainer();
                this._pUniformContainerP = new fx.VariableBlendContainer();
                this._pSharedContainerP = new fx.VariableBlendContainer();
                this._pGlobalContainerP = new fx.VariableBlendContainer();
                this._pVaryingContainerP = new fx.VariableBlendContainer();
                this._pUsedFunctionListP = [];
                this._pPassFunctionListP = [];
                this._pTextureMapP = {};
                this._pDefaultSamplerBlender = fx.Composer.pDefaultSamplerBlender;
                if (((PassBlend.texcoordSwapper) === null)) {
                    PassBlend.texcoordSwapper = new fx.TexcoordSwapper();
                }
                this._pTexcoordSwapper = PassBlend.texcoordSwapper;
            }
            PassBlend.prototype.getGuid = function () {
                return this._iGuid;
            };
            PassBlend.texcoordSwapper = null;
            PassBlend.prototype.initFromPassList = function (pPassList) {
                for(var i = 0; i < pPassList.length; i++) {
                    if (!this.addPass(pPassList[i])) {
                        return false;
                    }
                }
                if (!this.finalizeBlend()) {
                    return false;
                }
                return true;
            };
            PassBlend.prototype.generateFXMaker = function (pPassInput, pSurfaceMaterial, pBuffer, isFirst) {
                if (typeof isFirst === "undefined") { isFirst = true; }
                pPassInput.setSurfaceMaterial(pSurfaceMaterial);
                var iTime = akra.now();
                var sSamplerPartHash = this.prepareSamplers(pPassInput);
                var sMaterialPartHash = this.prepareSurfaceMaterial(pSurfaceMaterial);
                var sBufferPartHash = this.prepareBufferMap(pBuffer);
                var sTotalHash = sSamplerPartHash + "|" + sMaterialPartHash + "|" + sBufferPartHash;
                var pMaker = this.getMakerByHash(sTotalHash);
                if (((pMaker) === null)) {
 {
                        akra.logger.setSourceLocation("fx/PassBlend.ts", 162);
                        akra.logger.log("generateShaderProgram. HASH: ", sTotalHash, "---NEW---", akra.now() - iTime);
                    }
                    ;
                    this.applyForeigns(pPassInput);
                    this.swapTexcoords(pSurfaceMaterial);
                    this.generateShaderCode();
                    pMaker = new fx.Maker(this._pComposer);
                    var isCreate = pMaker._create(this._sVertexCode, this._sPixelCode);
                    if (!isCreate) {
                        return null;
                    }
                    pMaker._initInput(pPassInput, this._pDefaultSamplerBlender, this._pAttributeContainerV);
                    this._pFXMakerByHashMap[sTotalHash] = pMaker;
                } else {
                }
                this._pDefaultSamplerBlender.clear();
                return pMaker;
            };
            PassBlend.prototype.getMakerByHash = function (sHash) {
                return this._pFXMakerByHashMap[sHash] || null;
            };
            PassBlend.prototype.finalizeBlend = function () {
                if (!this.finalizeBlendForVertex()) {
                    return false;
                }
                if (!this.finalizeBlendForPixel()) {
                    return false;
                }
                return true;
            };
            PassBlend.prototype.addPass = function (pPass) {
                var pVertex = pPass.getVertexShader();
                var pPixel = pPass.getPixelShader();
                var pForeignMap = null;
                var pGlobalMap = null;
                var pSharedMap = null;
                var pUniformMap = null;
                var pTextureMap = null;
                var pAttributeMap = null;
                var pVaryingMap = null;
                var pComplexTypeMap = null;
                var pForeignKeys = null;
                var pGlobalKeys = null;
                var pSharedKeys = null;
                var pUniformKeys = null;
                var pTextureKeys = null;
                var pAttributeKeys = null;
                var pVaryingKeys = null;
                var pComplexTypeKeys = null;
                var pForeign = null;
                var pGlobal = null;
                var pShared = null;
                var pUniform = null;
                var pTexture = null;
                var pAttribute = null;
                var pVarying = null;
                var pComplexType = null;
                var pUsedFunctionList = null;
                var pUsedFunction = null;
                if (!((pVertex) === null)) {
                    this._hasEmptyVertex = false;
                    this._pExtSystemDataV.addFromFunction(pVertex);
                    pForeignMap = pVertex._getForeignVariableMap();
                    pForeignKeys = pVertex._getForeignVariableKeys();
                    if (!((pForeignKeys) === null)) {
                        for(var i = 0; i < pForeignKeys.length; i++) {
                            pForeign = pForeignMap[pForeignKeys[i]];
                            if (!this._pForeignContainerV.addVariable(pForeign, akra.EAFXBlendMode.k_Foreign)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 260);
                                    akra.logger.error("Could not add foreign variable");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pGlobalMap = pVertex._getGlobalVariableMap();
                    pGlobalKeys = pVertex._getGlobalVariableKeys();
                    if (!((pGlobalKeys) === null)) {
                        for(var i = 0; i < pGlobalKeys.length; i++) {
                            pGlobal = pGlobalMap[pGlobalKeys[i]];
                            if (!this._pGlobalContainerV.addVariable(pGlobal, akra.EAFXBlendMode.k_Global)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 275);
                                    akra.logger.error("Could not add global variable");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pSharedMap = pVertex._getSharedVariableMap();
                    pSharedKeys = pVertex._getSharedVariableKeys();
                    if (!((pSharedKeys) === null)) {
                        for(var i = 0; i < pSharedKeys.length; i++) {
                            pShared = pSharedMap[pSharedKeys[i]];
                            if (!this._pSharedContainerV.addVariable(pShared, akra.EAFXBlendMode.k_Shared)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 290);
                                    akra.logger.error("Could not add shared variable");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pUniformMap = pVertex._getUniformVariableMap();
                    pUniformKeys = pVertex._getUniformVariableKeys();
                    if (!((pUniformKeys) === null)) {
                        for(var i = 0; i < pUniformKeys.length; i++) {
                            pUniform = pUniformMap[pUniformKeys[i]];
                            if (((pUniform) === null)) {
                                continue;
                            }
                            if (!this._pUniformContainerV.addVariable(pUniform, akra.EAFXBlendMode.k_Uniform)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 309);
                                    akra.logger.error("Could not add uniform variable");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pTextureMap = pVertex._getTextureVariableMap();
                    pTextureKeys = pVertex._getTextureVariableKeys();
                    if (!((pTextureKeys) === null)) {
                        for(var i = 0; i < pTextureKeys.length; i++) {
                            pTexture = pTextureMap[pTextureKeys[i]];
                            if (((pTexture) === null)) {
                                continue;
                            }
                            this._pTextureMapV[pTexture.getRealName()] = true;
                        }
                    }
                    pAttributeMap = pVertex._getAttributeVariableMap();
                    pAttributeKeys = pVertex._getAttributeVariableKeys();
                    if (!((pAttributeKeys) === null)) {
                        for(var i = 0; i < pAttributeKeys.length; i++) {
                            pAttribute = pAttributeMap[pAttributeKeys[i]];
                            if (!this._pAttributeContainerV.addAttribute(pAttribute)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 341);
                                    akra.logger.error("Could not add attribute variable");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pVaryingMap = pVertex._getVaryingVariableMap();
                    pVaryingKeys = pVertex._getVaryingVariableKeys();
                    if (!((pVaryingKeys) === null)) {
                        for(var i = 0; i < pVaryingKeys.length; i++) {
                            pVarying = pVaryingMap[pVaryingKeys[i]];
                            if (!this._pVaryingContainerV.addVariable(pVarying, akra.EAFXBlendMode.k_Varying)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 356);
                                    akra.logger.error("Could not add varying variable");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pComplexTypeMap = pVertex._getUsedComplexTypeMap();
                    pComplexTypeKeys = pVertex._getUsedComplexTypeKeys();
                    if (!((pComplexTypeKeys) === null)) {
                        for(var i = 0; i < pComplexTypeKeys.length; i++) {
                            pComplexType = pComplexTypeMap[pComplexTypeKeys[i]];
                            if (!this._pComplexTypeContainerV.addComplexType(pComplexType)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 371);
                                    akra.logger.error("Could not add type declaration");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pUsedFunctionList = pVertex._getUsedFunctionList();
                    if (!((pUsedFunctionList) === null)) {
                        for(var i = 0; i < pUsedFunctionList.length; i++) {
                            pUsedFunction = pUsedFunctionList[i];
                            if (this._pUsedFunctionListV.indexOf(pUsedFunction) === -1) {
                                this._pUsedFunctionListV.push(pUsedFunction);
                            }
                        }
                    }
                    var pVertexOut = pVertex.getReturnType().getBaseType();
                    if (pVertexOut.isComplex()) {
                        this._pVertexOutType = this._pVertexOutType.blend(pVertexOut, akra.EAFXBlendMode.k_VertexOut);
                    }
                    this._pPassFunctionListV.push(pVertex);
                }
                if (!((pPixel) === null)) {
                    this._hasEmptyPixel = false;
                    this._pExtSystemDataP.addFromFunction(pPixel);
                    pForeignMap = pPixel._getForeignVariableMap();
                    pForeignKeys = pPixel._getForeignVariableKeys();
                    if (!((pForeignKeys) === null)) {
                        for(var i = 0; i < pForeignKeys.length; i++) {
                            pForeign = pForeignMap[pForeignKeys[i]];
                            if (!this._pForeignContainerP.addVariable(pForeign, akra.EAFXBlendMode.k_Foreign)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 412);
                                    akra.logger.error("Could not add foreign variable");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pGlobalMap = pPixel._getGlobalVariableMap();
                    pGlobalKeys = pPixel._getGlobalVariableKeys();
                    if (!((pGlobalKeys) === null)) {
                        for(var i = 0; i < pGlobalKeys.length; i++) {
                            pGlobal = pGlobalMap[pGlobalKeys[i]];
                            if (!this._pGlobalContainerP.addVariable(pGlobal, akra.EAFXBlendMode.k_Global)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 427);
                                    akra.logger.error("Could not add global variable");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pSharedMap = pPixel._getSharedVariableMap();
                    pSharedKeys = pPixel._getSharedVariableKeys();
                    if (!((pSharedKeys) === null)) {
                        for(var i = 0; i < pSharedKeys.length; i++) {
                            pShared = pSharedMap[pSharedKeys[i]];
                            if (!this._pSharedContainerP.addVariable(pShared, akra.EAFXBlendMode.k_Shared)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 442);
                                    akra.logger.error("Could not add shared variable");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pUniformMap = pPixel._getUniformVariableMap();
                    pUniformKeys = pPixel._getUniformVariableKeys();
                    if (!((pUniformKeys) === null)) {
                        for(var i = 0; i < pUniformKeys.length; i++) {
                            pUniform = pUniformMap[pUniformKeys[i]];
                            if (((pUniform) === null)) {
                                continue;
                            }
                            if (!this._pUniformContainerP.addVariable(pUniform, akra.EAFXBlendMode.k_Uniform)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 461);
                                    akra.logger.error("Could not add uniform variable");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pTextureMap = pPixel._getTextureVariableMap();
                    pTextureKeys = pPixel._getTextureVariableKeys();
                    if (!((pTextureKeys) === null)) {
                        for(var i = 0; i < pTextureKeys.length; i++) {
                            pTexture = pTextureMap[pTextureKeys[i]];
                            if (((pTexture) === null)) {
                                continue;
                            }
                            this._pTextureMapP[pTexture.getRealName()] = true;
                        }
                    }
                    pVaryingMap = pPixel._getVaryingVariableMap();
                    pVaryingKeys = pPixel._getVaryingVariableKeys();
                    if (!((pVaryingKeys) === null)) {
                        for(var i = 0; i < pVaryingKeys.length; i++) {
                            pVarying = pVaryingMap[pVaryingKeys[i]];
                            if (!this._pVaryingContainerP.addVariable(pVarying, akra.EAFXBlendMode.k_Varying)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 492);
                                    akra.logger.error("Could not add varying variable");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pComplexTypeMap = pPixel._getUsedComplexTypeMap();
                    pComplexTypeKeys = pPixel._getUsedComplexTypeKeys();
                    if (!((pComplexTypeKeys) === null)) {
                        for(var i = 0; i < pComplexTypeKeys.length; i++) {
                            pComplexType = pComplexTypeMap[pComplexTypeKeys[i]];
                            if (!this._pComplexTypeContainerP.addComplexType(pComplexType)) {
 {
                                    akra.logger.setSourceLocation("fx/PassBlend.ts", 507);
                                    akra.logger.error("Could not add type declaration");
                                }
                                ;
                                return false;
                            }
                        }
                    }
                    pUsedFunctionList = pPixel._getUsedFunctionList();
                    if (!((pUsedFunctionList) === null)) {
                        for(var i = 0; i < pUsedFunctionList.length; i++) {
                            pUsedFunction = pUsedFunctionList[i];
                            if (this._pUsedFunctionListP.indexOf(pUsedFunction) === -1) {
                                this._pUsedFunctionListP.push(pUsedFunction);
                            }
                        }
                    }
                    this._pPassFunctionListP.push(pPixel);
                }
                return true;
            };
            PassBlend.prototype.finalizeBlendForVertex = function () {
                if (this._hasEmptyVertex) {
                    return true;
                }
                if (!this.finalizeComplexTypeForShader(akra.EFunctionType.k_Vertex)) {
                    return false;
                }
                this._pAttributeContainerV.generateOffsetMap();
                return true;
            };
            PassBlend.prototype.finalizeBlendForPixel = function () {
                if (this._hasEmptyPixel) {
                    return true;
                }
                if (!this.finalizeComplexTypeForShader(akra.EFunctionType.k_Pixel)) {
                    return false;
                }
                return true;
            };
            PassBlend.prototype.enableVaringPrefixes = function (eType, bEnabled) {
                var pVars = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pVars = this._pVaryingContainerV;
                } else {
                    pVars = this._pVaryingContainerP;
                }
                var pKeys = pVars.keys;
                for(var i = 0; i < pKeys.length; i++) {
                    var sName = pKeys[i];
                    var pVarList = pVars.getVarList(sName);
                    for(var j = 0; j < pVarList.length; j++) {
                        pVarList[j]._markAsVarying(bEnabled);
                    }
                }
            };
            PassBlend.prototype.finalizeComplexTypeForShader = function (eType) {
                var pTypeContainer = null;
                var pUniformContainer = null;
                var pGlobalContainer = null;
                var pSharedContainer = null;
                var pUsedFunctions = null;
                var pAttributeContainer = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pTypeContainer = this._pComplexTypeContainerV;
                    pUniformContainer = this._pUniformContainerV;
                    pGlobalContainer = this._pGlobalContainerV;
                    pSharedContainer = this._pSharedContainerV;
                    pUsedFunctions = this._pUsedFunctionListV;
                    pAttributeContainer = this._pAttributeContainerV;
                } else if (eType === akra.EFunctionType.k_Pixel) {
                    pTypeContainer = this._pComplexTypeContainerP;
                    pUniformContainer = this._pUniformContainerP;
                    pGlobalContainer = this._pGlobalContainerP;
                    pSharedContainer = this._pSharedContainerP;
                    pUsedFunctions = this._pUsedFunctionListP;
                }
                if (!pTypeContainer.addFromVarConatiner(pUniformContainer) || !pTypeContainer.addFromVarConatiner(pGlobalContainer) || !pTypeContainer.addFromVarConatiner(pSharedContainer) || !pTypeContainer.addFromVarConatiner(pAttributeContainer)) {
                    return false;
                }
                for(var i = 0; i < pUsedFunctions.length; i++) {
                    var pReturnBaseType = pUsedFunctions[i].getReturnType().getBaseType();
                    if (pReturnBaseType.isComplex()) {
                        if (!pTypeContainer.addComplexType(pReturnBaseType)) {
                            return false;
                        }
                    }
                }
                return true;
            };
            PassBlend.prototype.hasUniform = function (pVar) {
                return this.hasUniformWithName(pVar.getRealName());
            };
            PassBlend.prototype.hasUniformWithName = function (sName) {
                return this._pUniformContainerV.hasVariableWithName(sName) || this._pUniformContainerP.hasVariableWithName(sName);
            };
            PassBlend.prototype.getUniformByName = function (sName) {
                return this._pUniformContainerV.getVariableByName(sName) || this._pUniformContainerP.getVariableByName(sName);
            };
            PassBlend.prototype.prepareSamplers = function (pPassInput) {
                var pBlender = this._pDefaultSamplerBlender;
                var pSamplers = pPassInput.samplers;
                var pSamplerKeys = pPassInput.samplerKeys;
                for(var i = 0; i < pSamplerKeys.length; i++) {
                    var sName = pSamplerKeys[i];
                    if (!this.hasUniformWithName(sName)) {
                        continue;
                    }
                    var pSampler = this.getUniformByName(sName);
                    var pSamplerState = pSamplers[sName];
                    var pTexture = pPassInput._getTextureForSamplerState(pSamplerState);
                    if (((pTexture) === null)) {
                        pBlender.addObjectToSlotById(pSampler, 0);
                    } else {
                        pBlender.addTextureSlot(pTexture.getGuid());
                        pBlender.addObjectToSlotById(pSampler, pTexture.getGuid());
                    }
                }
                var pSamplerArrays = pPassInput.samplerArrays;
                var pSamplerArrayKeys = pPassInput.samplerArrayKeys;
                for(var i = 0; i < pSamplerArrayKeys.length; i++) {
                    var sName = pSamplerArrayKeys[i];
                    if (!this.hasUniformWithName(sName)) {
                        continue;
                    }
                    var pSamplerStateList = pSamplerArrays[sName];
                    var isNeedToCollapse = true;
                    var pTexture = null;
                    var iLength = pPassInput.samplerArrayLength[sName];
                    for(var j = 0; j < iLength; j++) {
                        if (j === 0) {
                            pTexture = pPassInput._getTextureForSamplerState(pSamplerStateList[j]);
                        } else {
                            if (pTexture !== pPassInput._getTextureForSamplerState(pSamplerStateList[j])) {
                                isNeedToCollapse = false;
                            }
                        }
                    }
                    var pSamplerArray = this.getUniformByName(sName);
                    if (isNeedToCollapse) {
                        pSamplerArray._setCollapsed(true);
                        if (((pTexture) === null)) {
                            pBlender.addObjectToSlotById(pSamplerArray, 0);
                        } else {
                            pBlender.addTextureSlot(pTexture.getGuid());
                            pBlender.addObjectToSlotById(pSamplerArray, pTexture.getGuid());
                        }
                    } else {
                        pSamplerArray._setCollapsed(false);
                    }
                }
                return pBlender.getHash();
            };
            PassBlend.prototype.prepareSurfaceMaterial = function (pMaterial) {
                return ((pMaterial) === null) ? "" : pMaterial._getHash();
            };
            PassBlend.prototype.prepareBufferMap = function (pMap) {
                this._pAttributeContainerV.initFromBufferMap(pMap);
                return this._pAttributeContainerV.getHash();
            };
            PassBlend.prototype.swapTexcoords = function (pMaterial) {
                this._pTexcoordSwapper.generateSwapCode(pMaterial, this._pAttributeContainerV);
            };
            PassBlend.prototype.isSamplerUsedInShader = function (pSampler, eType) {
                return (eType === akra.EFunctionType.k_Vertex && this._pUniformContainerV.hasVariable(pSampler)) || (eType === akra.EFunctionType.k_Pixel && this._pUniformContainerP.hasVariable(pSampler));
            };
            PassBlend.prototype.applyForeigns = function (pPassInput) {
                var pForeignValues = pPassInput.foreigns;
                var pKeys = pPassInput.foreignKeys;
                var pForeignsV = this._pForeignContainerV;
                var pForeignsP = this._pForeignContainerP;
                for(var i = 0; i < pKeys.length; i++) {
                    var sName = pKeys[i];
                    var pVarList = null;
                    if (pForeignsV.hasVariableWithName(sName)) {
                        pVarList = pForeignsV.getVarList(sName);
                        for(var j = 0; j < pVarList.length; j++) {
                            pVarList[j].setValue(pForeignValues[sName] || 1);
                        }
                    }
                    if (pForeignsP.hasVariableWithName(sName)) {
                        pVarList = pForeignsP.getVarList(sName);
                        for(var j = 0; j < pVarList.length; j++) {
                            pVarList[j].setValue(pForeignValues[sName] || 1);
                        }
                    }
                }
            };
            PassBlend.prototype.generateShaderCode = function () {
                this.clearCodeFragments();
                this.reduceSamplers();
                this.reduceAttributes();
                this._sVertexCode = this.generateCodeForVertex();
                this._sPixelCode = this.generateCodeForPixel();
            };
            PassBlend.prototype.generateCodeForVertex = function () {
                var sCode = "";
                var eType = akra.EFunctionType.k_Vertex;
                sCode = this.generateSystemExtBlock(eType) + "\n" + this.generateTypeDels(eType) + "\n" + this.generateFunctionDefenitions(eType) + "\n" + this.generateSharedVars(eType) + "\n" + this.generateVertexOut() + "\n";
                this.enableVaringPrefixes(eType, true);
                sCode += this.generateVaryings(eType) + "\n";
                this.enableVaringPrefixes(eType, false);
                sCode += this.generateUniformSamplers(eType) + "\n" + this.generateUniformVars(eType) + "\n" + this.generateAttrBuffers() + "\n" + this.generateGlobalVars(eType) + "\n" + this.generateFunctions(eType) + "\n" + this.generateRealAttrs() + "\n" + this.generateAFXAttrs() + "\n" + this.generatePassFunctions(eType) + "\n" + "void main() {\n" + this.generateAttrBufferInit() + "\n" + this.generateAFXAttrInit() + "\n" + this.generateTexcoordSwap() + "\n" + this.generatePassFunctionCall(eType) + "\n" + this.generateVertexOutToVaryings() + "\n" + "}";
                return sCode;
            };
            PassBlend.prototype.generateCodeForPixel = function () {
                if (this._hasEmptyPixel) {
                    return "void main(){}";
                }
                var sCode = "";
                var eType = akra.EFunctionType.k_Pixel;
                this.enableVaringPrefixes(eType, true);
                sCode = this.generateSystemExtBlock(eType) + "\n" + this.generateTypeDels(eType) + "\n" + this.generateFunctionDefenitions(eType) + "\n" + this.generateSharedVars(eType) + "\n" + this.generateVaryings(eType) + "\n" + this.generateUniformSamplers(eType) + "\n" + this.generateUniformVars(eType) + "\n" + this.generateGlobalVars(eType) + "\n" + this.generateFunctions(eType) + "\n" + this.generatePassFunctions(eType) + "\n" + "void main() {\n" + this.generatePassFunctionCall(eType) + "\n" + "}";
                this.enableVaringPrefixes(eType, false);
                return sCode;
            };
            PassBlend.prototype.clearCodeFragments = function () {
                this._sUniformSamplerCodeV = "";
                this._sAttrBufferDeclCode = "";
                this._sAttrDeclCode = "";
                this._sAFXAttrDeclCode = "";
                this._sAttrBufferInitCode = "";
                this._sAFXAttrInitCode = "";
                this._sUniformSamplerCodeP = "";
            };
            PassBlend.prototype.reduceSamplers = function () {
                var pSamplerBlender = this._pDefaultSamplerBlender;
                var iTotalSlots = pSamplerBlender.totalActiveSlots;
                var sUniformSamplerCodeV = "";
                var sUniformSamplerCodeP = "";
                var isZeroSampler2DV = false;
                var isZeroSamplerCubeV = false;
                var isZeroSampler2DP = false;
                var isZeroSamplerCubeP = false;
                for(var i = 0; i < iTotalSlots; i++) {
                    var pSamplers = pSamplerBlender.getSamplersBySlot(i);
                    var isInVertex = false;
                    var isInPixel = false;
                    var sSamplerName = "as" + i.toString();
                    for(var j = 0; j < pSamplers.length; j++) {
                        if (i === 0) {
                            pSamplers.value(j).defineByZero(true);
                            if (this.isSamplerUsedInShader(pSamplers.value(j), akra.EFunctionType.k_Vertex)) {
                                if (pSamplers.value(j).getType().isSampler2D()) {
                                    isZeroSampler2DV = true;
                                } else {
                                    isZeroSamplerCubeV = true;
                                }
                            }
                            if (this.isSamplerUsedInShader(pSamplers.value(j), akra.EFunctionType.k_Pixel)) {
                                if (pSamplers.value(j).getType().isSampler2D()) {
                                    isZeroSampler2DP = true;
                                } else {
                                    isZeroSamplerCubeP = true;
                                }
                            }
                        } else {
                            if (this.isSamplerUsedInShader(pSamplers.value(j), akra.EFunctionType.k_Vertex)) {
                                isInVertex = true;
                            }
                            if (this.isSamplerUsedInShader(pSamplers.value(j), akra.EFunctionType.k_Pixel)) {
                                isInPixel = true;
                            }
                        }
                        pSamplers.value(j).setRealName(sSamplerName);
                    }
                    if (i === 0) {
                        if (isZeroSampler2DV) {
                            sUniformSamplerCodeV += "uniform sampler2D as0;";
                        }
                        if (isZeroSamplerCubeV) {
                            sUniformSamplerCodeV += "uniform samplerCube asc0;";
                        }
                        if (isZeroSampler2DP) {
                            sUniformSamplerCodeP += "uniform sampler2D as0;";
                        }
                        if (isZeroSamplerCubeP) {
                            sUniformSamplerCodeP += "uniform samplerCube asc0;";
                        }
                    } else {
                        if (isInVertex) {
                            sUniformSamplerCodeV += "uniform " + pSamplers.value(0).getType().getBaseType().getRealName() + " " + sSamplerName + ";";
                        }
                        if (isInPixel) {
                            sUniformSamplerCodeP += "uniform " + pSamplers.value(0).getType().getBaseType().getRealName() + " " + sSamplerName + ";";
                        }
                    }
                }
                this._sUniformSamplerCodeV = sUniformSamplerCodeV;
                this._sUniformSamplerCodeP = sUniformSamplerCodeP;
            };
            PassBlend.prototype.reduceAttributes = function () {
                var pAttributeContainer = this._pAttributeContainerV;
                var pSemantics = pAttributeContainer.semantics;
                var nPreparedBufferSlots = -1;
                var nPreparedAttributeSlots = -1;
                for(var i = 0; i < pSemantics.length; i++) {
                    var sSemantic = pSemantics[i];
                    var pFlow = pAttributeContainer.getFlowBySemantic(sSemantic);
                    var pAttributes = pAttributeContainer.getAttributeList(sSemantic);
                    var iBufferSlot = -1;
                    var iSlot = -1;
                    var sAttrName = "";
                    if (((pFlow) === null)) {
                        for(var j = 0; j < pAttributes.length; j++) {
                            if (pAttributes[j].getType().isStrictPointer()) {
                                pAttributes[j].getType().getVideoBuffer().defineByZero(true);
                            }
                        }
                    } else {
                        iSlot = pAttributeContainer.getSlotBySemantic(sSemantic);
                        iBufferSlot = pAttributeContainer.getBufferSlotBySemantic(sSemantic);
                        sAttrName = "aa" + iSlot.toString();
                        if (iBufferSlot >= 0) {
                            var sSamplerBufferName = "abs" + iBufferSlot.toString();
                            var sHeaderBufferName = "abh" + iBufferSlot.toString();
                            var pBufferVar = null;
                            for(var j = 0; j < pAttributes.length; j++) {
                                pBufferVar = pAttributes[j].getType().getVideoBuffer();
                                pBufferVar.setVideoBufferRealName(sSamplerBufferName, sHeaderBufferName);
                            }
                            if (iBufferSlot > nPreparedBufferSlots) {
                                var pBufferVar = pAttributes[0].getType().getVideoBuffer();
                                this._sAttrBufferDeclCode = pBufferVar.toFinalCode() + ";\n";
                                this._sAttrBufferInitCode = pBufferVar._getVideoBufferInitExpr().toFinalCode() + ";\n";
                                nPreparedBufferSlots++;
                            }
                        }
                        if (iSlot > nPreparedAttributeSlots) {
                            this._sAttrDeclCode += "attribute " + pAttributeContainer.getTypeBySlot(i).toFinalCode() + " " + sAttrName + ";\n";
                            nPreparedAttributeSlots++;
                        }
                    }
                    var pAttribute = pAttributeContainer.getAttribute(sSemantic);
                    var pAttributeType = pAttribute.getType();
                    this._sAFXAttrDeclCode += pAttribute.toFinalCode() + ";\n";
                    if (pAttributeType.isStrictPointer() || (pAttributeType.isPointer() && iBufferSlot >= 0)) {
                        var pAttrSubDecls = pAttribute.getSubVarDecls();
                        for(var j = 0; j < pAttrSubDecls.length; j++) {
                            this._sAFXAttrDeclCode += pAttrSubDecls[j].toFinalCode() + ";\n";
                        }
                    }
                    if (iSlot >= 0) {
                        if (iBufferSlot >= 0) {
                            this._sAFXAttrInitCode += pAttributeType._getMainPointer().getRealName() + "=" + sAttrName + ";";
                            this._sAFXAttrInitCode += pAttribute._getAttrExtractionBlock().toFinalCode();
                        } else {
                            this._sAFXAttrInitCode += pAttribute.getRealName() + "=" + sAttrName + ";";
                        }
                    }
                }
            };
            PassBlend.prototype.generateSystemExtBlock = function (eType) {
                var pExtBlock = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pExtBlock = this._pExtSystemDataV;
                    if (this._sSystemExtBlockCodeV !== "") {
                        return this._sSystemExtBlockCodeV;
                    }
                } else {
                    pExtBlock = this._pExtSystemDataP;
                    if (this._sSystemExtBlockCodeP !== "") {
                        return this._sSystemExtBlockCodeP;
                    }
                }
                var sCode = "";
                var pMacroses = pExtBlock.macroses;
                var pTypes = pExtBlock.types;
                var pFunctions = pExtBlock.functions;
                for(var i = 0; i < pMacroses.length; i++) {
                    sCode += pMacroses[i].toFinalCode() + "\n";
                }
                for(var i = 0; i < pTypes.length; i++) {
                    sCode += pTypes[i].toFinalCode() + "\n";
                }
                for(var i = 0; i < pFunctions.length; i++) {
                    sCode += pFunctions[i].toFinalCode() + "\n";
                }
                if (eType === akra.EFunctionType.k_Vertex) {
                    this._sSystemExtBlockCodeV = sCode;
                } else {
                    sCode = "#define AKRA_FRAGMENT 1\n" + "#ifdef GL_ES\nprecision highp float;\n#endif\n" + "#extension GL_OES_standard_derivatives : enable\n";
                    sCode;
                    this._sSystemExtBlockCodeP = sCode;
                }
                return sCode;
            };
            PassBlend.prototype.generateTypeDels = function (eType) {
                var pTypeBlock = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pTypeBlock = this._pComplexTypeContainerV;
                } else {
                    pTypeBlock = this._pComplexTypeContainerP;
                }
                var sCode = "";
                var pKeys = pTypeBlock.keys;
                var pTypes = pTypeBlock.types;
                for(var i = 0; i < pKeys.length; i++) {
                    sCode += pTypes[pKeys[i]]._toDeclString() + ";\n";
                }
                return sCode;
            };
            PassBlend.prototype.generateFunctionDefenitions = function (eType) {
                var pFunctions = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pFunctions = this._pUsedFunctionListV;
                    if (this._sFunctionDefCodeV !== "") {
                        return this._sFunctionDefCodeV;
                    }
                } else {
                    pFunctions = this._pUsedFunctionListP;
                    if (this._sFunctionDefCodeP !== "") {
                        return this._sFunctionDefCodeP;
                    }
                }
                var sCode = "";
                for(var i = 0; i < pFunctions.length; i++) {
                    sCode += pFunctions[i].toFinalDefCode() + ";\n";
                }
                if (eType === akra.EFunctionType.k_Vertex) {
                    this._sFunctionDefCodeV = sCode;
                } else {
                    this._sFunctionDefCodeP = sCode;
                }
                return sCode;
            };
            PassBlend.prototype.generateSharedVars = function (eType) {
                var pVars = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pVars = this._pSharedContainerV;
                    if (this._sSharedVarCodeV !== "") {
                        return this._sSharedVarCodeV;
                    }
                } else {
                    pVars = this._pSharedContainerP;
                    if (this._sSharedVarCodeP !== "") {
                        return this._sSharedVarCodeP;
                    }
                }
                var sCode = "";
                var pKeys = pVars.keys;
                for(var i = 0; i < pKeys.length; i++) {
                    sCode += pVars.getDeclCodeForVar(pKeys[i]) + ";\n";
                }
                if (eType === akra.EFunctionType.k_Vertex) {
                    this._sSharedVarCodeV = sCode;
                } else {
                    this._sSharedVarCodeP = sCode;
                }
                return sCode;
            };
            PassBlend.prototype.generateVertexOut = function () {
                if (this._sVertexOutDeclCode === "") {
                    this._sVertexOutDeclCode = this._pVertexOutType._toDeclString() + " Out;\n";
                }
                return this._sVertexOutDeclCode;
            };
            PassBlend.prototype.generateVaryings = function (eType) {
                var pVars = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pVars = this._pVaryingContainerV;
                    if (this._sVaryingDeclCodeV !== "") {
                        return this._sVaryingDeclCodeV;
                    }
                } else {
                    pVars = this._pVaryingContainerP;
                    if (this._sVaryingDeclCodeP !== "") {
                        return this._sVaryingDeclCodeP;
                    }
                }
                var sCode = "";
                var pKeys = pVars.keys;
                for(var i = 0; i < pKeys.length; i++) {
                    sCode += "varying " + pVars.getDeclCodeForVar(pKeys[i]) + ";\n";
                }
                if (eType === akra.EFunctionType.k_Vertex) {
                    this._sVaryingDeclCodeV = sCode;
                } else {
                    this._sVaryingDeclCodeP = sCode;
                }
                return sCode;
            };
            PassBlend.prototype.generateUniformSamplers = function (eType) {
                if (eType === akra.EFunctionType.k_Vertex) {
                    return this._sUniformSamplerCodeV;
                } else {
                    return this._sUniformSamplerCodeP;
                }
            };
            PassBlend.prototype.generateUniformVars = function (eType) {
                var pVars = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pVars = this._pUniformContainerV;
                } else {
                    pVars = this._pUniformContainerP;
                }
                var sCode = "";
                var pKeys = pVars.keys;
                for(var i = 0; i < pKeys.length; i++) {
                    var pVar = pVars.getVariableByName(pKeys[i]);
                    var pType = pVars.getBlendType(pKeys[i]);
                    if (pType.isSampler() && (!pType.isArray() || pVar.isDefinedByZero() || pVar._isCollapsed())) {
                        continue;
                    }
                    sCode += "uniform " + pVars.getDeclCodeForVar(pKeys[i]) + ";\n";
                }
                return sCode;
            };
            PassBlend.prototype.generateAttrBuffers = function () {
                return this._sAttrBufferDeclCode;
            };
            PassBlend.prototype.generateGlobalVars = function (eType) {
                var pVars = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pVars = this._pGlobalContainerV;
                } else {
                    pVars = this._pGlobalContainerP;
                }
                var sCode = "";
                var pKeys = pVars.keys;
                for(var i = 0; i < pKeys.length; i++) {
                    sCode += pVars.getDeclCodeForVar(pKeys[i]) + ";\n";
                }
                return sCode;
            };
            PassBlend.prototype.generateFunctions = function (eType) {
                var pFunctions = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pFunctions = this._pUsedFunctionListV;
                } else {
                    pFunctions = this._pUsedFunctionListP;
                }
                var sCode = "";
                for(var i = 0; i < pFunctions.length; i++) {
                    sCode += pFunctions[i].toFinalCode() + "\n";
                }
                return sCode;
            };
            PassBlend.prototype.generatePassFunctions = function (eType) {
                var pFunctions = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pFunctions = this._pPassFunctionListV;
                } else {
                    pFunctions = this._pPassFunctionListP;
                }
                var sCode = "";
                for(var i = 0; i < pFunctions.length; i++) {
                    sCode += pFunctions[i].toFinalCode() + "\n";
                }
                return sCode;
            };
            PassBlend.prototype.generateRealAttrs = function () {
                return this._sAttrDeclCode;
            };
            PassBlend.prototype.generateAFXAttrs = function () {
                return this._sAFXAttrDeclCode;
            };
            PassBlend.prototype.generateAttrBufferInit = function () {
                return this._sAttrBufferInitCode;
            };
            PassBlend.prototype.generateAFXAttrInit = function () {
                return this._sAFXAttrInitCode;
            };
            PassBlend.prototype.generateTexcoordSwap = function () {
                return this._pTexcoordSwapper.getTmpDeclCode() + "\n" + this._pTexcoordSwapper.getTecoordSwapCode();
            };
            PassBlend.prototype.generatePassFunctionCall = function (eType) {
                var pFunctions = null;
                if (eType === akra.EFunctionType.k_Vertex) {
                    pFunctions = this._pPassFunctionListV;
                    if (this._sPassFunctionCallCodeV !== "") {
                        return this._sPassFunctionCallCodeV;
                    }
                } else {
                    pFunctions = this._pPassFunctionListP;
                    if (this._sPassFunctionCallCodeP !== "") {
                        return this._sPassFunctionCallCodeP;
                    }
                }
                var sCode = "";
                for(var i = 0; i < pFunctions.length; i++) {
                    sCode += pFunctions[i].getRealName() + "();\n";
                }
                if (eType === akra.EFunctionType.k_Vertex) {
                    this._sPassFunctionCallCodeV = sCode;
                } else {
                    this._sPassFunctionCallCodeP = sCode;
                }
                return sCode;
            };
            PassBlend.prototype.generateVertexOutToVaryings = function () {
                if (this._sVertexOutToVaryingCode !== "") {
                    return this._sVertexOutToVaryingCode;
                }
                var pVars = this._pVaryingContainerV;
                var pKeys = pVars.keys;
                var sCode = "";
                sCode += "gl_Position=Out.POSITION;\ngl_PointSize=Out.PSIZE;\n";
                for(var i = 0; i < pKeys.length; i++) {
                    var sName = pKeys[i];
                    if (sName !== "POSITION" && sName !== "PSIZE") {
                        sCode += "V_" + sName + "=" + "Out." + sName + ";\n";
                    }
                }
                this._sVertexOutToVaryingCode = sCode;
                return this._sVertexOutToVaryingCode;
            };
            return PassBlend;
        })();
        fx.PassBlend = PassBlend;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var ComponentBlend = (function () {
            function ComponentBlend(pComposer) {
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pComposer = null;
                this._isReady = false;
                this._sHash = "";
                this._bNeedToUpdateHash = false;
                this._pComponentHashMap = null;
                this._pComponentList = null;
                this._pComponentShiftList = null;
                this._pComponentPassIdList = null;
                this._iShiftMin = 0;
                this._iShiftMax = 0;
                this._pPassesDList = null;
                this._pComponentInputVarBlend = null;
                this._pComposer = pComposer;
                this._pComponentHashMap = {};
                this._pComponentList = [];
                this._pComponentShiftList = [];
                this._pComponentPassIdList = [];
            }
            ComponentBlend.prototype.getGuid = function () {
                return this._iGuid;
            };
            ComponentBlend.prototype.isReadyToUse = function () {
                return this._isReady;
            };
            ComponentBlend.prototype.isEmpty = function () {
                return this._pComponentList.length === 0;
            };
            ComponentBlend.prototype.getComponentCount = function () {
                return this._pComponentList.length;
            };
            ComponentBlend.prototype.getTotalPasses = function () {
                return !((this._pPassesDList) === null) ? this._pPassesDList.length : 0;
            };
            ComponentBlend.prototype.getHash = function () {
                if (this._bNeedToUpdateHash) {
                    this._sHash = this.calcHash();
                    this._bNeedToUpdateHash = false;
                }
                return this._sHash;
            };
            ComponentBlend.prototype.containComponentWithShift = function (pComponent, iShift, iPass) {
                return this.containComponentHash(pComponent.getHash(iShift, iPass));
            };
            ComponentBlend.prototype.containComponentHash = function (sComponentHash) {
                return (this._pComponentHashMap[sComponentHash]);
            };
            ComponentBlend.prototype.addComponent = function (pComponent, iShift, iPass) {
                var sComponentHash = pComponent.getHash(iShift, iPass);
                var iPassCount = pComponent.getTotalPasses();
                if (iPass === 0xffffff) {
                    for(var i = 0; i < iPassCount; i++) {
                        this.addComponent(pComponent, iShift + i, i);
                    }
                    return;
                } else if (iPass < 0 || iPass >= iPassCount) {
                    return;
                }
                var sComponentHash = pComponent.getHash(iShift, iPass);
                if (this.containComponentHash(sComponentHash)) {
 {
                        akra.logger.setSourceLocation("fx/ComponentBlend.ts", 93);
                        akra.logger.warning("You try to add already used component '" + sComponentHash + "' in blend.");
                    }
                    ;
                    return;
                }
                if (iShift < this._iShiftMin) {
                    this._iShiftMin = iShift;
                }
                if (iShift > this._iShiftMax) {
                    this._iShiftMax = iShift;
                }
                this._pComponentHashMap[sComponentHash] = true;
                this._pComponentList.push(pComponent);
                this._pComponentShiftList.push(iShift);
                this._pComponentPassIdList.push(iPass);
                this._isReady = false;
                this._bNeedToUpdateHash = true;
            };
            ComponentBlend.prototype.removeComponent = function (pComponent, iShift, iPass) {
                var sComponentHash = pComponent.getHash(iShift, iPass);
                var iPassCount = pComponent.getTotalPasses();
                if (!this.containComponentHash(sComponentHash)) {
 {
                        akra.logger.setSourceLocation("fx/ComponentBlend.ts", 120);
                        akra.logger.warning("You try to remove not used component '" + sComponentHash + "' from blend.");
                    }
                    ;
                    return;
                }
                if (iPass === 0xffffff) {
                    for(var i = 0; i < iPassCount; i++) {
                        this.removeComponent(pComponent, iShift + i, i);
                    }
                    return;
                } else if (iPass < 0 || iPass >= iPassCount) {
                    return;
                }
                this._pComponentHashMap[sComponentHash] = false;
                for(var i = 0; i < this._pComponentList.length; i++) {
                    if (this._pComponentList[i] === pComponent && this._pComponentShiftList[i] === iShift && this._pComponentPassIdList[i] === iPass) {
                        this._pComponentList.splice(i, 1);
                        this._pComponentShiftList.splice(i, 1);
                        this._pComponentPassIdList.splice(i, 1);
                        break;
                    }
                }
                if (this._iShiftMin === iShift && this._iShiftMax === iShift) {
                    this._iShiftMax = 0;
                    this._iShiftMin = 0;
                    for(var i = 0; i < this._pComponentShiftList.length; i++) {
                        if (this._pComponentShiftList[i] < this._iShiftMin) {
                            this._iShiftMin = this._pComponentShiftList[i];
                        }
                        if (this._pComponentShiftList[i] > this._iShiftMax) {
                            this._iShiftMax = this._pComponentShiftList[i];
                        }
                    }
                }
                this._isReady = false;
                this._bNeedToUpdateHash = true;
            };
            ComponentBlend.prototype.finalizeBlend = function () {
                if (this._isReady) {
                    return true;
                }
                this._pPassesDList = [];
                this._pComponentInputVarBlend = [];
                for(var i = 0; i < this._pComponentList.length; i++) {
                    var pComponentTechnique = this._pComponentList[i].getTechnique();
                    var iShift = this._pComponentShiftList[i] - this._iShiftMin;
                    var iPass = this._pComponentPassIdList[i];
                    var pPass = pComponentTechnique.getPass(iPass);
                    if (!((this._pPassesDList[iShift]) !== undefined)) {
                        this._pPassesDList[iShift] = [];
                        this._pComponentInputVarBlend[iShift] = new ComponentPassInputBlend();
                    }
                    this._pPassesDList[iShift].push(pPass);
                    this._pComponentInputVarBlend[iShift].addDataFromPass(pPass);
                }
                for(var i = 0; i < this._pComponentInputVarBlend.length; i++) {
                    if (((this._pComponentInputVarBlend[i]) !== undefined)) {
                        this._pComponentInputVarBlend[i].finalizeInput();
                    } else {
                        this._pComponentInputVarBlend[i] = null;
                        this._pPassesDList[i] = null;
                    }
                }
                this._isReady = true;
                return true;
            };
            ComponentBlend.prototype.getPassInputForPass = function (iPass) {
                if (!this._isReady) {
                    return null;
                }
                if (iPass < 0 || iPass > this.getTotalPasses() || ((this._pComponentInputVarBlend[iPass]) === null)) {
                    return null;
                }
                return this._pComponentInputVarBlend[iPass].getPassInput();
            };
            ComponentBlend.prototype.getPassListAtPass = function (iPass) {
                if (!this._isReady) {
                    return null;
                }
                if (iPass < 0 || iPass > this.getTotalPasses()) {
                    return null;
                }
                return this._pPassesDList[iPass];
            };
            ComponentBlend.prototype.clone = function () {
                var pClone = new ComponentBlend(this._pComposer);
                pClone._setDataForClone(this._pComponentList, this._pComponentShiftList, this._pComponentPassIdList, this._pComponentHashMap, this._iShiftMin, this._iShiftMax);
                return pClone;
            };
            ComponentBlend.prototype._getComponentList = function () {
                return this._pComponentList;
            };
            ComponentBlend.prototype._getComponentShiftList = function () {
                return this._pComponentShiftList;
            };
            ComponentBlend.prototype._getComponentPassIdList = function () {
                return this._pComponentPassIdList;
            };
            ComponentBlend.prototype._setDataForClone = function (pComponentList, pComponentShiftList, pComponentPassNumnerList, pComponentHashMap, iShiftMin, iShiftMax) {
                for(var i = 0; i < pComponentList.length; i++) {
                    this._pComponentList.push(pComponentList[i]);
                    this._pComponentShiftList.push(pComponentShiftList[i]);
                    this._pComponentPassIdList.push(pComponentPassNumnerList[i]);
                    var sComponentHash = pComponentList[i].getHash(pComponentShiftList[i], pComponentPassNumnerList[i]);
                    this._pComponentHashMap[sComponentHash] = pComponentHashMap[sComponentHash];
                }
                this._iShiftMin = iShiftMin;
                this._iShiftMax = iShiftMax;
                this._bNeedToUpdateHash = true;
            };
            ComponentBlend.prototype.calcHash = function () {
                var sHash = "";
                if (this.isEmpty()) {
                    return "EMPTY_BLEND";
                }
                for(var i = 0; i < this._pComponentList.length; i++) {
                    var sComponentHash = this._pComponentList[i].getHash(this._pComponentShiftList[i], this._pComponentPassIdList[i]);
                    sHash += sComponentHash + ":";
                }
                return sHash;
            };
            return ComponentBlend;
        })();
        fx.ComponentBlend = ComponentBlend;        
        var ComponentPassInputBlend = (function () {
            function ComponentPassInputBlend() {
                this._pUniformNameToRealMap = null;
                this._pUniformByRealNameMap = null;
                this._pUniformDefaultValueMap = null;
                this._pTextureNameToRealMap = null;
                this._pTextureByRealNameMap = null;
                this._pForeignByNameMap = null;
                this._pUniformRealNameList = null;
                this._pUniformNameList = null;
                this._pTextureRealNameList = null;
                this._pTextureNameList = null;
                this._pForeignNameList = null;
                this._pFreePassInputBlendList = null;
                this._pUniformNameToRealMap = {};
                this._pUniformByRealNameMap = {};
                this._pUniformDefaultValueMap = {};
                this._pTextureNameToRealMap = {};
                this._pTextureByRealNameMap = {
                    TEXTURE0: null,
                    TEXTURE1: null,
                    TEXTURE2: null,
                    TEXTURE3: null,
                    TEXTURE4: null,
                    TEXTURE5: null,
                    TEXTURE6: null,
                    TEXTURE7: null,
                    TEXTURE8: null,
                    TEXTURE9: null,
                    TEXTURE10: null,
                    TEXTURE11: null,
                    TEXTURE12: null,
                    TEXTURE13: null,
                    TEXTURE14: null,
                    TEXTURE15: null
                };
                this._pForeignByNameMap = {};
            }
            Object.defineProperty(ComponentPassInputBlend.prototype, "uniformNameToReal", {
                get: function () {
                    return this._pUniformNameToRealMap;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ComponentPassInputBlend.prototype, "uniformByRealName", {
                get: function () {
                    return this._pUniformByRealNameMap;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ComponentPassInputBlend.prototype, "uniformDefaultValue", {
                get: function () {
                    return this._pUniformDefaultValueMap;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ComponentPassInputBlend.prototype, "textureNameToReal", {
                get: function () {
                    return this._pTextureNameToRealMap;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ComponentPassInputBlend.prototype, "textureByRealName", {
                get: function () {
                    return this._pTextureByRealNameMap;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ComponentPassInputBlend.prototype, "foreignByName", {
                get: function () {
                    return this._pForeignByNameMap;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ComponentPassInputBlend.prototype, "uniformNameList", {
                get: function () {
                    return this._pUniformNameList;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ComponentPassInputBlend.prototype, "uniformRealNameList", {
                get: function () {
                    return this._pUniformRealNameList;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ComponentPassInputBlend.prototype, "textureNameList", {
                get: function () {
                    return this._pTextureNameList;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ComponentPassInputBlend.prototype, "textureRealNameList", {
                get: function () {
                    return this._pTextureRealNameList;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ComponentPassInputBlend.prototype, "foreignNameList", {
                get: function () {
                    return this._pForeignNameList;
                },
                enumerable: true,
                configurable: true
            });
            ComponentPassInputBlend.prototype.addDataFromPass = function (pPass) {
                var pUniformMap = pPass._getFullUniformMap();
                var pForeignMap = pPass._getFullForeignMap();
                var pTextureMap = pPass._getFullTextureMap();
                var pVar = null;
                for(var i in pForeignMap) {
                    pVar = pForeignMap[i];
                    this._pForeignByNameMap[pVar.getName()] = pVar;
                }
                for(var i in pTextureMap) {
                    pVar = pTextureMap[i];
                    this._pTextureNameToRealMap[pVar.getName()] = pVar.getRealName();
                    this._pTextureByRealNameMap[pVar.getRealName()] = pVar;
                }
                for(var i in pUniformMap) {
                    pVar = pUniformMap[i];
                    this.addUniformVariable(pVar, "", "");
                }
            };
            ComponentPassInputBlend.prototype.finalizeInput = function () {
                this._pUniformNameList = Object.keys(this._pUniformNameToRealMap);
                this._pUniformRealNameList = Object.keys(this._pUniformByRealNameMap);
                this._pTextureNameList = Object.keys(this._pTextureNameToRealMap);
                this._pTextureRealNameList = Object.keys(this._pTextureByRealNameMap);
                this._pForeignNameList = Object.keys(this._pForeignByNameMap);
                this._pFreePassInputBlendList = [];
                this.generateNewPassInputs();
            };
            ComponentPassInputBlend.prototype.getPassInput = function () {
                if (this._pFreePassInputBlendList.length === 0) {
                    this.generateNewPassInputs();
                }
                return this._pFreePassInputBlendList.pop();
            };
            ComponentPassInputBlend.prototype.releasePassInput = function (pInput) {
                this._pFreePassInputBlendList.push(pInput);
            };
            ComponentPassInputBlend.prototype.addUniformVariable = function (pVariable, sPrevName, sPrevRealName) {
                var sName = "";
                var sRealName = "";
                sName = pVariable.getName();
                sRealName = pVariable.getRealName();
                var pHasVar = this._pUniformByRealNameMap[sRealName];
                if (((pHasVar) !== undefined) && !pHasVar.getType().isEqual(pVariable.getType())) {
 {
                        akra.logger.setSourceLocation("fx/ComponentBlend.ts", 462);
                        akra.logger.warning("You used uniforms with the same real-names. Now we don`t work very well with that.");
                    }
                    ;
                    return;
                }
                var pVariableType = pVariable.getType();
                this._pUniformNameToRealMap[sName] = sRealName;
                this._pUniformByRealNameMap[sRealName] = pVariable;
                this._pUniformDefaultValueMap[sRealName] = pVariable.getDefaultValue();
            };
            ComponentPassInputBlend.prototype.generateNewPassInputs = function (nCount) {
                if (typeof nCount === "undefined") { nCount = 5; }
                for(var i = 0; i < nCount; i++) {
                    var pPassInput = new fx.PassInputBlend(this);
                    this._pFreePassInputBlendList.push(pPassInput);
                }
            };
            return ComponentPassInputBlend;
        })();
        fx.ComponentPassInputBlend = ComponentPassInputBlend;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var Blender = (function () {
            function Blender(pComposer) {
                this._pComposer = null;
                this._pComponentBlendByHashMap = null;
                this._pBlendWithComponentMap = null;
                this._pBlendWithBlendMap = null;
                this._pPassBlendByHashMap = null;
                this._pPassBlendByIdMap = null;
                this._pComposer = pComposer;
                this._pComponentBlendByHashMap = {};
                this._pBlendWithComponentMap = {};
                this._pBlendWithBlendMap = {};
                this._pPassBlendByHashMap = {};
                this._pPassBlendByIdMap = {};
            }
            Blender.prototype.addComponentToBlend = function (pComponentBlend, pComponent, iShift, iPass) {
                var sBlendPartHash = ((pComponentBlend) != null) ? pComponentBlend.getGuid().toString() : "";
                var sComponentPartHash = pComponent.getHash(iShift, iPass);
                var sShortHash = sBlendPartHash + "+" + sComponentPartHash;
                if (!((pComponentBlend) === null) && pComponentBlend.containComponentHash(sComponentPartHash)) {
 {
                        akra.logger.setSourceLocation("fx/Blender.ts", 42);
                        akra.logger.warning("You try to add already used component '" + sComponentPartHash + "' in blend.");
                    }
                    ;
                    return pComponentBlend;
                }
                if (((this._pBlendWithComponentMap[sShortHash]) !== undefined)) {
                    return this._pBlendWithComponentMap[sShortHash];
                }
                var pNewBlend = null;
                if (((pComponentBlend) === null)) {
                    pNewBlend = new fx.ComponentBlend(this._pComposer);
                } else {
                    pNewBlend = pComponentBlend.clone();
                }
                var pTechnique = pComponent.getTechnique();
                var pTechComponentList = pTechnique.getFullComponentList();
                var pTechComponentShiftList = pTechnique.getFullComponentShiftList();
                if (iPass === 0xffffff) {
                    if (!((pTechComponentList) === null)) {
                        for(var i = 0; i < pTechComponentList.length; i++) {
                            pNewBlend.addComponent(pTechComponentList[i], pTechComponentShiftList[i] + iShift, 0xffffff);
                        }
                    }
                    pNewBlend.addComponent(pComponent, iShift, 0xffffff);
                } else {
                    if (!((pTechComponentList) === null)) {
                        for(var i = 0; i < pTechComponentList.length; i++) {
                            pNewBlend.addComponent(pTechComponentList[i], pTechComponentShiftList[i] + iShift, iPass - pTechComponentShiftList[i]);
                        }
                    }
                    pNewBlend.addComponent(pComponent, iShift, iPass);
                }
                this._pBlendWithComponentMap[sShortHash] = pNewBlend;
                var sNewBlendHash = pNewBlend.getHash();
                if (((this._pComponentBlendByHashMap[sNewBlendHash]) !== undefined)) {
                    return this._pComponentBlendByHashMap[sNewBlendHash];
                } else {
                    this._pComponentBlendByHashMap[sNewBlendHash] = pNewBlend;
                }
                return pNewBlend;
            };
            Blender.prototype.removeComponentFromBlend = function (pComponentBlend, pComponent, iShift, iPass) {
                if (((pComponentBlend) === null)) {
 {
                        akra.logger.setSourceLocation("fx/Blender.ts", 100);
                        akra.logger.warning("You try to remove component '" + pComponent.getName() + "' with shift " + iShift.toString() + "from empty blend.");
                    }
                    ;
                    return null;
                }
                var sBlendPartHash = ((pComponentBlend) != null) ? pComponentBlend.getGuid().toString() : "";
                var sComponentPartHash = pComponent.getHash(iShift, iPass);
                var sShortHash = sBlendPartHash + "-" + sComponentPartHash;
                if (((this._pBlendWithComponentMap[sShortHash]) !== undefined)) {
                    return this._pBlendWithComponentMap[sShortHash];
                }
                if (!pComponentBlend.containComponentHash(sComponentPartHash)) {
 {
                        akra.logger.setSourceLocation("fx/Blender.ts", 114);
                        akra.logger.warning("You try to remove component '" + pComponent.getName() + "' with shift " + iShift.toString() + "from blend that not contain it.");
                    }
                    ;
                    return null;
                }
                var pNewBlend = pComponentBlend.clone();
                var pTechnique = pComponent.getTechnique();
                var pTechComponentList = pTechnique.getFullComponentList();
                var pTechComponentShiftList = pTechnique.getFullComponentShiftList();
                if (iPass === 0xffffff) {
                    if (!((pTechComponentList) === null)) {
                        for(var i = 0; i < pTechComponentList.length; i++) {
                            pNewBlend.removeComponent(pTechComponentList[i], pTechComponentShiftList[i] + iShift, 0xffffff);
                        }
                    }
                    pNewBlend.removeComponent(pComponent, iShift, 0xffffff);
                } else {
                    if (!((pTechComponentList) === null)) {
                        for(var i = 0; i < pTechComponentList.length; i++) {
                            pNewBlend.removeComponent(pTechComponentList[i], pTechComponentShiftList[i] + iShift, iPass - pTechComponentShiftList[i]);
                        }
                    }
                    pNewBlend.removeComponent(pComponent, iShift, iPass);
                }
                this._pBlendWithComponentMap[sShortHash] = pNewBlend;
                var sNewBlendHash = pNewBlend.getHash();
                if (((this._pComponentBlendByHashMap[sNewBlendHash]) !== undefined)) {
                    return this._pComponentBlendByHashMap[sNewBlendHash];
                } else {
                    this._pComponentBlendByHashMap[sNewBlendHash] = pNewBlend;
                }
                return pNewBlend;
            };
            Blender.prototype.addBlendToBlend = function (pComponentBlend, pAddBlend, iShift) {
                if (((pComponentBlend) === null)) {
                    return pAddBlend;
                }
                if (((pAddBlend) === null)) {
                    return pComponentBlend;
                }
                var sShortHash = pComponentBlend.getGuid().toString() + "+" + pAddBlend.getGuid().toString();
                if (((this._pBlendWithBlendMap[sShortHash]) !== undefined)) {
                    return this._pBlendWithBlendMap[sShortHash];
                }
                var pNewBlend = pComponentBlend.clone();
                var pAddComponentList = pAddBlend._getComponentList();
                var pAddComponentShiftList = pAddBlend._getComponentShiftList();
                var pAddComponentPassIdList = pAddBlend._getComponentPassIdList();
                for(var i = 0; i < pAddComponentList.length; i++) {
                    pNewBlend.addComponent(pAddComponentList[i], pAddComponentShiftList[i] + iShift, pAddComponentPassIdList[i]);
                }
                this._pBlendWithBlendMap[sShortHash] = pNewBlend;
                var sNewBlendHash = pNewBlend.getHash();
                if (((this._pComponentBlendByHashMap[sNewBlendHash]) !== undefined)) {
                    return this._pComponentBlendByHashMap[sNewBlendHash];
                } else {
                    this._pComponentBlendByHashMap[sNewBlendHash] = pNewBlend;
                }
                return pNewBlend;
            };
            Blender.prototype.generatePassBlend = function (pPassList, pStates, pForeigns, pUniforms) {
                var sPassBlendHash = "";
                for(var i = 0; i < pPassList.length; i++) {
                    var pPass = pPassList[i];
                    pPass.evaluate(pStates, pForeigns, pUniforms);
                    var pVertexShader = pPass.getVertexShader();
                    var pPixelShader = pPass.getPixelShader();
                    if (!((pVertexShader) === null)) {
                        sPassBlendHash += pVertexShader.getGuid().toString() + ":";
                    } else {
                        sPassBlendHash += "E:";
                    }
                    if (!((pPixelShader) === null)) {
                        sPassBlendHash += pPixelShader.getGuid().toString() + ":";
                    } else {
                        sPassBlendHash += "E:";
                    }
                }
                if (((this._pPassBlendByHashMap[sPassBlendHash]) !== undefined)) {
                    return this._pPassBlendByHashMap[sPassBlendHash];
                }
                var pNewPassBlend = new fx.PassBlend(this._pComposer);
                var isOk = pNewPassBlend.initFromPassList(pPassList);
                if (!isOk) {
                    return null;
                }
                this._pPassBlendByHashMap[sPassBlendHash] = pNewPassBlend;
                this._pPassBlendByIdMap[pNewPassBlend.getGuid()] = pNewPassBlend;
                return pNewPassBlend;
            };
            Blender.prototype.getPassBlendById = function (id) {
                return this._pPassBlendByIdMap[id] || null;
            };
            return Blender;
        })();
        fx.Blender = Blender;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        var BufferMap = (function (_super) {
            __extends(BufferMap, _super);
            function BufferMap(pEngine) {
                        _super.call(this);
                this._pFlows = null;
                this._pMappers = null;
                this._pIndex = null;
                this._nLength = 0;
                this._pCompleteFlows = null;
                this._nCompleteFlows = 0;
                this._nCompleteVideoBuffers = 0;
                this._pCompleteVideoBuffers = null;
                this._nUsedFlows = 0;
                this._pEngine = null;
                this._nStartIndex = 0;
                this._pBuffersCompatibleMap = null;
                this._pSemanticsMap = null;
                this._pEngine = pEngine;
                this.reset();
            }
            Object.defineProperty(BufferMap.prototype, "primType", {
                get: function () {
                    return this._pIndex ? this._pIndex.getPrimitiveType() : this._ePrimitiveType;
                },
                set: function (eType) {
                    this._ePrimitiveType = eType;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BufferMap.prototype, "primCount", {
                get: function () {
                    return akra.data.IndexData.getPrimitiveCount(this.primType, this.length);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BufferMap.prototype, "index", {
                get: function () {
                    return this._pIndex;
                },
                set: function (pIndexData) {
                    if (this._pIndex === pIndexData) {
                        return;
                    }
                    this._pIndex = pIndexData;
                    this.update();
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BufferMap.prototype, "limit", {
                get: function () {
                    return this._pFlows.length;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BufferMap.prototype, "length", {
                get: function () {
                    return (this._pIndex ? this._pIndex.length : this._nLength);
                },
                set: function (nLength) {
                    this._nLength = Math.min(this._nLength, nLength);
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BufferMap.prototype, "_length", {
                set: function (nLength) {
                    this._nLength = nLength;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BufferMap.prototype, "startIndex", {
                get: function () {
                    return this._nStartIndex;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BufferMap.prototype, "size", {
                get: function () {
                    return this._nCompleteFlows;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BufferMap.prototype, "flows", {
                get: function () {
                    return this._pCompleteFlows;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BufferMap.prototype, "mappers", {
                get: function () {
                    return this._pMappers;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BufferMap.prototype, "offset", {
                get: function () {
                    return (this._pIndex ? this._pIndex.byteOffset : 0);
                },
                enumerable: true,
                configurable: true
            });
            BufferMap.prototype._draw = function () {
                ((this._pIndex) === null) ? this.drawArrays() : this.drawElements();
            };
            BufferMap.prototype.drawArrays = function () {
                (this._pEngine.getRenderer()).getWebGLContext().drawArrays(akra.webgl.getWebGLPrimitiveType(this._ePrimitiveType), this._nStartIndex, this._nLength);
            };
            BufferMap.prototype.drawElements = function () {
                (this._pEngine.getRenderer()).getWebGLContext().drawElements(akra.webgl.getWebGLPrimitiveType(this._ePrimitiveType), this._pIndex.getPrimitiveCount(), akra.webgl.getWebGLPrimitiveType(this._pIndex.getPrimitiveType()), this._pIndex.byteOffset / 4);
            };
            BufferMap.prototype.getFlow = function (iFlow, bComplete) {
                if (typeof bComplete === "undefined") { bComplete = true; }
                if ((typeof (arguments[0]) === "string")) {
                    var nTotal;
                    var pFlows;
                    if (bComplete) {
                        pFlows = this._pCompleteFlows;
                        nTotal = this._nCompleteFlows;
                    } else {
                        pFlows = this._pFlows;
                        nTotal = this._pFlows.length;
                    }
                    for(var i = 0; i < nTotal; ++i) {
                        if (!pFlows[i].data) {
                            continue;
                        }
                        if (pFlows[i].data.hasSemantics(arguments[0])) {
                            return pFlows[i];
                        }
                    }
                    return null;
                }
                if (bComplete) {
                    for(var i = 0, pFlows = this._pCompleteFlows; i < this._nCompleteFlows; ++i) {
                        if (pFlows[i].flow == iFlow) {
                            return pFlows[i];
                        }
                    }
                    return null;
                }
                return this._pFlows[iFlow];
            };
            BufferMap.prototype.reset = function () {
                this._pIndex = null;
                this._ePrimitiveType = akra.EPrimitiveTypes.TRIANGLELIST;
                var nFlowLimit = 16;
                nFlowLimit = Math.min(16, akra.webgl.maxVertexAttributes);
                this._pMappers = [];
                this._pFlows = new Array(nFlowLimit);
                for(var i = 0; i < nFlowLimit; i++) {
                    this._pFlows[i] = {
                        flow: i,
                        data: null,
                        type: akra.EDataFlowTypes.UNMAPPABLE,
                        mapper: null
                    };
                }
                this._nLength = akra.MAX_INT32;
                this._pCompleteFlows = new Array(nFlowLimit);
                this._nCompleteFlows = 0;
                this._nStartIndex = akra.MAX_INT32;
                this._pBuffersCompatibleMap = {};
                this._pCompleteVideoBuffers = new Array(nFlowLimit);
                this._nCompleteVideoBuffers = 0;
                this._nUsedFlows = 0;
                this._pSemanticsMap = {};
            };
            BufferMap.prototype.flow = function (iFlow, pData) {
                var pFlow = null;
                var pVertexData = null;
                if (arguments.length < 2) {
                    pVertexData = arguments[0];
                    iFlow = (this._nUsedFlows++);
                } else {
                    iFlow = arguments[0];
                    pVertexData = arguments[1];
                }
                pFlow = this._pFlows[iFlow];
 {
                    util.logger.setSourceLocation("util/BufferMap.ts", 239);
                    util.logger.assert(iFlow < this.limit, 'Invalid strem. Maximum allowable number of stream ' + this.limit + '.');
                }
                ;
                if (!pVertexData || pFlow.data === pVertexData) {
 {
                        util.logger.setSourceLocation("util/BufferMap.ts", 243);
                        util.logger.warning("BufferMap::flow(", iFlow, pVertexData, ") failed.", ((pVertexData) === null) ? "vertex data is null" : "flow.data alreay has same vertex data");
                    }
                    ;
                    return -1;
                }
                if (akra.core.pool.resources.isVBO(pVertexData.buffer)) {
                    pFlow.type = akra.EDataFlowTypes.UNMAPPABLE;
                    this.length = pVertexData.length;
 {
                        util.logger.setSourceLocation("util/BufferMap.ts", 252);
                        util.logger.assert(this.checkData(pVertexData), 'You can use several unmappable data flows from one buffer.');
                    }
                    ;
                    this.pushEtalon(pVertexData);
                } else {
                    pFlow.type = akra.EDataFlowTypes.MAPPABLE;
                }
                pFlow.data = pVertexData;
                return this.update() ? iFlow : -1;
            };
            BufferMap.prototype.clearLinks = function () {
                for(var sSemantics in this._pSemanticsMap) {
                    this._pSemanticsMap[sSemantics] = null;
                }
            };
            BufferMap.prototype.linkFlow = function (pFlow) {
                var pDecl = pFlow.data.getVertexDeclaration();
                for(var i = 0; i < pDecl.length; ++i) {
                    var pElement = pDecl.element(i);
                    var sSemantics = pElement.semantics;
                    if (pElement.isEnd()) {
                        continue;
                    }
                    var isSemanticsExists = ((this._pSemanticsMap[sSemantics]) != null);
 {
                        util.logger.setSourceLocation("util/BufferMap.ts", 285);
                        util.logger.assert(!isSemanticsExists, "overwrited semantics: " + sSemantics);
                    }
                    ;
                    if (!isSemanticsExists) {
                        this._pSemanticsMap[sSemantics] = pFlow;
                    }
                }
                if (pFlow.type === akra.EDataFlowTypes.MAPPABLE) {
                    var sSemantics = pFlow.mapper.semantics;
                    var isSemanticsExists = ((this._pSemanticsMap[sSemantics]) != null);
 {
                        util.logger.setSourceLocation("util/BufferMap.ts", 296);
                        util.logger.assert(!isSemanticsExists, "overwrited semantics(MAPPER!): " + sSemantics);
                    }
                    ;
                    if (!isSemanticsExists) {
                        this._pSemanticsMap[sSemantics] = pFlow;
                    }
                }
            };
            BufferMap.prototype.checkData = function (pData) {
                var pEtalon = this._pBuffersCompatibleMap[pData.getBufferHandle()];
                if (!pEtalon || pEtalon.byteOffset === pData.byteOffset) {
                    return true;
                }
                return false;
            };
            BufferMap.prototype.findMapping = function (pMap, eSemantics, iAddition) {
 {
                    util.logger.setSourceLocation("util/BufferMap.ts", 313);
                    util.logger.assert(this.checkData(pMap), 'You can use several different maps from one buffer.');
                }
                ;
                for(var i = 0, pMappers = this._pMappers, pExistsMap; i < pMappers.length; i++) {
                    pExistsMap = pMappers[i].data;
                    if (pExistsMap === pMap) {
                        if (pMappers[i].semantics === eSemantics && pMappers[i].addition == iAddition) {
                            return pMappers[i];
                        }
                    } else {
 {
                            util.logger.setSourceLocation("util/BufferMap.ts", 325);
                            util.logger.assert(pExistsMap.getStartIndex() === pMap.getStartIndex(), 'You can not use maps with different indexing');
                        }
                        ;
                    }
                }
                return null;
            };
            BufferMap.prototype.mapping = function (iFlow, pMap, eSemantics, iAddition) {
                if (typeof iAddition === "undefined") { iAddition = 0; }
                var pMapper = this.findMapping(pMap, eSemantics, iAddition);
                var pFlow = this._pFlows[iFlow];
 {
                    util.logger.setSourceLocation("util/BufferMap.ts", 337);
                    util.logger.assert(((pFlow.data) != null) && (pFlow.type === akra.EDataFlowTypes.MAPPABLE), 'Cannot mapping empty/unmappable flow.');
                }
                ;
 {
                    util.logger.setSourceLocation("util/BufferMap.ts", 338);
                    util.logger.assert(((pMap) !== undefined), 'Passed empty mapper.');
                }
                ;
                if (!eSemantics) {
                    eSemantics = pMap.getVertexDeclaration()[0].eUsage;
                } else if (pMap.hasSemantics(eSemantics) === false) {
 {
                        util.logger.setSourceLocation("util/BufferMap.ts", 344);
                        util.logger.error('Passed mapper does not have semantics: ' + eSemantics + '.');
                    }
                    ;
                    return false;
                }
                if (pMapper) {
                    if (pFlow.mapper === pMapper) {
                        return pMapper.semantics === eSemantics && pMapper.addition === iAddition ? true : false;
                    }
                } else {
                    pMapper = {
                        data: pMap,
                        semantics: eSemantics,
                        addition: iAddition
                    };
                    this._pMappers.push(pMapper);
                    this.length = pMap.length;
                    this.pushEtalon(pMap);
                }
                pFlow.mapper = pMapper;
                return this.update();
            };
            BufferMap.prototype.pushEtalon = function (pData) {
                this._pBuffersCompatibleMap[pData.getBufferHandle()] = pData;
            };
            BufferMap.prototype.update = function () {
                var pFlows = this._pFlows;
                var pFlow;
                var pMapper;
                var isMappable = false;
                var pCompleteFlows = this._pCompleteFlows;
                var nCompleteFlows = 0;
                var pCompleteVideoBuffers = this._pCompleteVideoBuffers;
                var nCompleteVideoBuffers = 0;
                var nUsedFlows = 0;
                var pVideoBuffer;
                var isVideoBufferAdded = false;
                var nStartIndex = akra.MAX_INT32, nCurStartIndex;
                this.clearLinks();
                for(var i = 0; i < pFlows.length; i++) {
                    pFlow = pFlows[i];
                    pMapper = pFlow.mapper;
                    isMappable = (pFlow.type === akra.EDataFlowTypes.MAPPABLE);
                    if (pFlow.data) {
                        nUsedFlows++;
                    }
                    if (pFlow.data === null || (isMappable && pMapper === null)) {
                        continue;
                    }
                    pCompleteFlows[nCompleteFlows++] = pFlow;
                    this.linkFlow(pFlow);
                    if (isMappable) {
                        nCurStartIndex = pMapper.data.startIndex;
                        pVideoBuffer = pFlow.data.buffer;
                        for(var j = 0; j < nCompleteVideoBuffers; j++) {
                            if (pCompleteVideoBuffers[j] === pVideoBuffer) {
                                isVideoBufferAdded = true;
                                break;
                            }
                        }
                        if (!isVideoBufferAdded) {
                            pCompleteVideoBuffers[nCompleteVideoBuffers++] = pVideoBuffer;
                        }
                    } else {
                        nCurStartIndex = pFlow.data.startIndex;
                    }
                    if (nStartIndex === akra.MAX_INT32) {
                        nStartIndex = nCurStartIndex;
                        continue;
                    }
 {
                        util.logger.setSourceLocation("util/BufferMap.ts", 427);
                        util.logger.assert(nStartIndex == nCurStartIndex, 'You can not use a maps or unmappable buffers having different starting index.');
                    }
                    ;
                }
                this._nStartIndex = nStartIndex;
                this._nCompleteFlows = nCompleteFlows;
                this._nCompleteVideoBuffers = nCompleteVideoBuffers;
                this._nUsedFlows = nUsedFlows;
                return true;
            };
            BufferMap.prototype.findFlow = function (sSemantics) {
                return !((this._pSemanticsMap[sSemantics]) !== undefined) ? (this._pSemanticsMap[sSemantics] = null) : this._pSemanticsMap[sSemantics];
            };
            BufferMap.prototype.clone = function (bWithMapping) {
                if (typeof bWithMapping === "undefined") { bWithMapping = true; }
                var pMap = this._pEngine.createBufferMap();
                for(var i = 0, pFlows = this._pFlows; i < pFlows.length; ++i) {
                    if (pFlows[i].data === null) {
                        continue;
                    }
                    if (pMap.flow(pFlows[i].flow, pFlows[i].data) < 0) {
                        pMap = null;
 {
                            util.logger.setSourceLocation("util/BufferMap.ts", 456);
                            util.logger.log("BufferMap::clone() failed on", pFlows[i].flow, pFlows[i].data);
                        }
                        ;
                        return null;
                    }
                    if (!bWithMapping) {
                        continue;
                    }
                    if (pFlows[i].mapper) {
                        pMap.mapping(pFlows[i].flow, pFlows[i].mapper.data, pFlows[i].mapper.semantics, pFlows[i].mapper.addition);
                    }
                }
                return pMap;
            };
            BufferMap.prototype.toString = function (bListAll) {
                if (typeof bListAll === "undefined") { bListAll = false; }
                function _an(sValue, n, bBackward) {
                    sValue = String(sValue);
                    bBackward = bBackward || false;
                    if (sValue.length < n) {
                        for(var i = 0, l = sValue.length; i < n - l; ++i) {
                            if (!bBackward) {
                                sValue += ' ';
                            } else {
                                sValue = ' ' + sValue;
                            }
                        }
                    }
                    return sValue;
                }
                var s = '\n\n', t;
                s += '      $1 Flows     : OFFSET / SIZE   |   BUFFER / OFFSET   :      Mapping  / Shift    : OFFSET |    Additional    \n';
                s = s.replace("$1", bListAll ? "   Total" : "Complete");
                t = '-------------------------:-----------------+---------------------:--------------------------:--------+------------------\n';
                s += t;
                var pFlows = bListAll ? this._pFlows : this._pCompleteFlows;
                var nFlows = bListAll ? this._nUsedFlows : this._nCompleteFlows;
                for(var i = 0; i < nFlows; ++i) {
                    var pFlow = pFlows[i];
                    var pMapper = pFlow.mapper;
                    var pVertexData = pFlow.data;
                    var pDecl = pVertexData.getVertexDeclaration();
                    s += '#' + _an(pFlow.flow, 2) + ' ' + _an('[ ' + (pDecl.element(0).usage !== akra.DeclUsages.END ? pDecl.element(0).usage : '<end>') + ' ]', 20) + ' : ' + _an(pDecl.element(0).offset, 6, true) + ' / ' + _an(pDecl.element(0).size, 6) + ' | ' + _an(pVertexData.getBufferHandle(), 8, true) + ' / ' + _an(pVertexData.byteOffset, 8) + ' : ' + (pMapper ? _an(pMapper.semantics, 15, true) + ' / ' + _an(pMapper.addition, 7) + ': ' + _an(pMapper.data.getVertexDeclaration().findElement(pMapper.semantics).offset, 6) : _an('-----', 25) + ': ' + _an('-----', 6)) + ' |                  \n';
                    for(var j = 1; j < pDecl.length; ++j) {
                        s += '    ' + _an('[ ' + (pDecl.element(j).usage !== akra.DeclUsages.END ? pDecl.element(j).usage : '<end>') + ' ]', 20) + ' : ' + _an(pDecl.element(j).offset, 6, true) + ' / ' + _an(pDecl.element(j).size, 6) + ' |                     :                          :        |                  \n';
                    }
                    s += t;
                }
                ;
                s += '=================================================================\n';
                s += '      PRIMITIVE TYPE : ' + '0x' + Number(this.primType).toString(16) + '\n';
                s += '     PRIMITIVE COUNT : ' + this.primCount + '\n';
                s += '         START INDEX : ' + this.startIndex + '\n';
                s += '              LENGTH : ' + this.length + '\n';
                s += '  USING INDEX BUFFER : ' + (this.index ? 'TRUE' : 'FALSE') + '\n';
                s += '=================================================================\n';
                return s + '\n\n';
            };
            return BufferMap;
        })(util.ReferenceCounter);
        util.BufferMap = BufferMap;        
        function createBufferMap(pEngine) {
            return new BufferMap(pEngine);
        }
        util.createBufferMap = createBufferMap;
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (fx) {
        var Composer = (function () {
            function Composer(pEngine) {
                this._pEngine = null;
                this._pTechniqueToBlendMap = null;
                this._pTechniqueToOwnBlendMap = null;
                this._pTechniqueLastGlobalBlendMap = null;
                this._pTechniqueNeedUpdateMap = null;
                this._pEffectResourceToComponentBlendMap = null;
                this._pBlender = null;
                this._pGlobalEffectResorceIdStack = null;
                this._pGlobalComponentBlendStack = null;
                this._pGlobalComponentBlend = null;
                this._pCurrentSceneObject = null;
                this._pCurrentViewport = null;
                this._pCurrentRenderable = null;
                this._pCurrentBufferMap = null;
                this._pCurrentSurfaceMaterial = null;
                this._pComposerState = {
                    mesh: {
                        isSkinning: false
                    }
                };
                this._pRenderTargetA = null;
                this._pRenderTargetB = null;
                this._pLastRenderTarget = null;
                this._pPostEffectTextureA = null;
                this._pPostEffectTextureB = null;
                this._pPostEffectDepthBuffer = null;
                this.bUseNormalMap = true;
                this._pEngine = pEngine;
                this._pBlender = new fx.Blender(this);
                this._pTechniqueToBlendMap = {};
                this._pTechniqueToOwnBlendMap = {};
                this._pTechniqueLastGlobalBlendMap = {};
                this._pTechniqueNeedUpdateMap = {};
                this._pEffectResourceToComponentBlendMap = {};
                this._pGlobalEffectResorceIdStack = [];
                this._pGlobalComponentBlendStack = [];
                this._pGlobalComponentBlend = null;
                this.initPostEffectTextures();
                if (((Composer.pDefaultSamplerBlender) === null)) {
                    Composer.pDefaultSamplerBlender = new fx.SamplerBlender();
                }
            }
            Composer.pDefaultSamplerBlender = null;
            Composer.prototype.getComponentByName = function (sComponentName) {
                return this._pEngine.getResourceManager().componentPool.findResource(sComponentName);
            };
            Composer.prototype.getEngine = function () {
                return this._pEngine;
            };
            Composer.prototype.getComponentCountForEffect = function (pEffectResource) {
                var id = pEffectResource.resourceHandle;
                if (((this._pEffectResourceToComponentBlendMap[id]) !== undefined)) {
                    return this._pEffectResourceToComponentBlendMap[id].getComponentCount();
                } else {
                    return 0;
                }
            };
            Composer.prototype.getTotalPassesForEffect = function (pEffectResource) {
                var id = pEffectResource.resourceHandle;
                if (((this._pEffectResourceToComponentBlendMap[id]) !== undefined)) {
                    return this._pEffectResourceToComponentBlendMap[id].getTotalPasses();
                } else {
                    return 0;
                }
            };
            Composer.prototype.addComponentToEffect = function (pEffectResource, pComponent, iShift, iPass) {
                var id = pEffectResource.resourceHandle;
                var pCurrentBlend = null;
                if (((this._pEffectResourceToComponentBlendMap[id]) !== undefined)) {
                    pCurrentBlend = this._pEffectResourceToComponentBlendMap[id];
                }
                var pNewBlend = this._pBlender.addComponentToBlend(pCurrentBlend, pComponent, iShift, iPass);
                if (((pNewBlend) === null)) {
                    return false;
                }
                this._pEffectResourceToComponentBlendMap[id] = pNewBlend;
                return true;
            };
            Composer.prototype.removeComponentFromEffect = function (pEffectResource, pComponent, iShift, iPass) {
                var id = pEffectResource.resourceHandle;
                var pCurrentBlend = null;
                if (((this._pEffectResourceToComponentBlendMap[id]) !== undefined)) {
                    pCurrentBlend = this._pEffectResourceToComponentBlendMap[id];
                }
                var pNewBlend = this._pBlender.removeComponentFromBlend(pCurrentBlend, pComponent, iShift, iPass);
                if (((pNewBlend) === null)) {
                    return false;
                }
                this._pEffectResourceToComponentBlendMap[id] = pNewBlend;
                return true;
            };
            Composer.prototype.activateEffectResource = function (pEffectResource, iShift) {
                var id = pEffectResource.resourceHandle;
                var pComponentBlend = this._pEffectResourceToComponentBlendMap[id];
                if (!((pComponentBlend) !== undefined)) {
                    return false;
                }
                var pNewGlobalBlend = null;
                if (((this._pGlobalComponentBlend) === null)) {
                    pNewGlobalBlend = pComponentBlend;
                } else {
                    pNewGlobalBlend = this._pBlender.addBlendToBlend(this._pGlobalComponentBlend, pComponentBlend, iShift);
                }
                if (((pNewGlobalBlend) === null)) {
                    return false;
                }
                this._pGlobalEffectResorceIdStack.push(id);
                this._pGlobalComponentBlendStack.push(pNewGlobalBlend);
                this._pGlobalComponentBlend = pNewGlobalBlend;
                return true;
            };
            Composer.prototype.deactivateEffectResource = function (pEffectResource) {
                var id = pEffectResource.resourceHandle;
                var iStackLength = this._pGlobalEffectResorceIdStack.length;
                if (iStackLength === 0) {
                    return false;
                }
                var iLastId = this._pGlobalEffectResorceIdStack[iStackLength - 1];
                if (iLastId !== id) {
                    return false;
                }
                this._pGlobalEffectResorceIdStack.splice(iStackLength - 1, 1);
                this._pGlobalComponentBlendStack.splice(iStackLength - 1, 1);
                if (iStackLength > 1) {
                    this._pGlobalComponentBlend = this._pGlobalComponentBlendStack[iStackLength - 2];
                } else {
                    this._pGlobalComponentBlend = null;
                }
                return true;
            };
            Composer.prototype.getTotalPassesForTechnique = function (pRenderTechnique) {
                this.prepareTechniqueBlend(pRenderTechnique);
                var id = pRenderTechnique.getGuid();
                if (((this._pTechniqueToBlendMap[id]) != null)) {
                    return this._pTechniqueToBlendMap[id].getTotalPasses();
                } else {
                    return 0;
                }
            };
            Composer.prototype.addOwnComponentToTechnique = function (pRenderTechnique, pComponent, iShift, iPass) {
                var id = pRenderTechnique.getGuid();
                var pCurrentBlend = null;
                if (((this._pTechniqueToOwnBlendMap[id]) !== undefined)) {
                    pCurrentBlend = this._pTechniqueToOwnBlendMap[id];
                }
                var pNewBlend = this._pBlender.addComponentToBlend(pCurrentBlend, pComponent, iShift, iPass);
                if (((pNewBlend) === null)) {
                    return false;
                }
                this._pTechniqueToOwnBlendMap[id] = pNewBlend;
                this._pTechniqueNeedUpdateMap[id] = true;
                return true;
            };
            Composer.prototype.removeOwnComponentToTechnique = function (pRenderTechnique, pComponent, iShift, iPass) {
                var id = pRenderTechnique.getGuid();
                var pCurrentBlend = null;
                if (((this._pTechniqueToOwnBlendMap[id]) !== undefined)) {
                    pCurrentBlend = this._pTechniqueToOwnBlendMap[id];
                }
                var pNewBlend = this._pBlender.removeComponentFromBlend(pCurrentBlend, pComponent, iShift, iPass);
                if (((pNewBlend) === null)) {
                    return false;
                }
                this._pTechniqueToOwnBlendMap[id] = pNewBlend;
                this._pTechniqueNeedUpdateMap[id] = true;
                return true;
            };
            Composer.prototype.hasOwnComponentInTechnique = function (pRenderTechnique, pComponent, iShift, iPass) {
                var id = pRenderTechnique.getGuid();
                var pCurrentBlend = null;
                if (((this._pTechniqueToOwnBlendMap[id]) !== undefined)) {
                    pCurrentBlend = this._pTechniqueToOwnBlendMap[id];
                }
                if (((pCurrentBlend) === null)) {
                    return false;
                }
                return pCurrentBlend.containComponentWithShift(pComponent, iShift, iPass);
            };
            Composer.prototype.prepareTechniqueBlend = function (pRenderTechnique) {
                if (pRenderTechnique.isFreeze()) {
                    return true;
                }
                var id = pRenderTechnique.getGuid();
                var isTechniqueUpdate = !!(this._pTechniqueNeedUpdateMap[id]);
                var isUpdateGlobalBlend = (this._pGlobalComponentBlend !== this._pTechniqueLastGlobalBlendMap[id]);
                var isNeedToUpdatePasses = false;
                if (isTechniqueUpdate || isUpdateGlobalBlend) {
                    var iEffect = pRenderTechnique.getMethod().effect.resourceHandle;
                    var pEffectBlend = this._pEffectResourceToComponentBlendMap[iEffect] || null;
                    var pTechniqueBlend = this._pTechniqueToOwnBlendMap[id] || null;
                    var pNewBlend = null;
                    pNewBlend = this._pBlender.addBlendToBlend(this._pGlobalComponentBlend, pEffectBlend, 0);
                    pNewBlend = this._pBlender.addBlendToBlend(pNewBlend, pTechniqueBlend, 0);
                    if (this._pTechniqueToBlendMap[id] !== pNewBlend) {
                        isNeedToUpdatePasses = true;
                    }
                    this._pTechniqueToBlendMap[id] = pNewBlend;
                    this._pTechniqueNeedUpdateMap[id] = false;
                    this._pTechniqueLastGlobalBlendMap[id] = this._pGlobalComponentBlend;
                }
                var pBlend = this._pTechniqueToBlendMap[id];
                if (((pBlend) != null)) {
                    if (!pBlend.isReadyToUse()) {
                        isNeedToUpdatePasses = true;
                    }
                    if (!pBlend.finalizeBlend()) {
                        return false;
                    }
                    if (isNeedToUpdatePasses) {
                        pRenderTechnique.updatePasses(isTechniqueUpdate);
                    }
                } else {
                    return false;
                }
            };
            Composer.prototype.markTechniqueAsNeedUpdate = function (pRenderTechnique) {
                this._pTechniqueNeedUpdateMap[pRenderTechnique.getGuid()] = true;
            };
            Composer.prototype.getPassInputBlend = function (pRenderTechnique, iPass) {
                var id = pRenderTechnique.getGuid();
                if (!((this._pTechniqueToBlendMap[id]) !== undefined)) {
                    return null;
                }
                return this._pTechniqueToBlendMap[id].getPassInputForPass(iPass);
            };
            Composer.prototype.applyBufferMap = function (pMap) {
                this._pCurrentBufferMap = pMap;
                return true;
            };
            Composer.prototype.applySurfaceMaterial = function (pSurfaceMaterial) {
                this._pCurrentSurfaceMaterial = pSurfaceMaterial;
                return true;
            };
            Composer.prototype._setCurrentSceneObject = function (pSceneObject) {
                this._pCurrentSceneObject = pSceneObject;
            };
            Composer.prototype._setCurrentViewport = function (pViewport) {
                this._pCurrentViewport = pViewport;
            };
            Composer.prototype._setCurrentRenderableObject = function (pRenderable) {
                this._pCurrentRenderable = pRenderable;
            };
            Composer.prototype._getCurrentSceneObject = function () {
                return this._pCurrentSceneObject;
            };
            Composer.prototype._getCurrentViewport = function () {
                return this._pCurrentViewport;
            };
            Composer.prototype._getCurrentRenderableObject = function () {
                return this._pCurrentRenderable;
            };
            Composer.prototype.renderTechniquePass = function (pRenderTechnique, iPass) {
                var pPass = pRenderTechnique.getPass(iPass);
                var pPassInput = pPass.getPassInput();
                var pPassBlend = null;
                var pMaker = null;
                this.applySystemUnifoms(pPassInput);
                if (!pPassInput._isNeedToCalcShader()) {
                } else {
                    if (!pPassInput._isNeedToCalcBlend()) {
                        pPassBlend = this._pBlender.getPassBlendById(pPassInput._getLastPassBlendId());
                    } else {
                        var id = pRenderTechnique.getGuid();
                        var pComponentBlend = this._pTechniqueToBlendMap[id];
                        var pPassInstructionList = pComponentBlend.getPassListAtPass(iPass);
                        if (!((this._pCurrentRenderable) === null)) {
                            if (akra.render.isMeshSubset(this._pCurrentRenderable) && (this._pCurrentRenderable).isSkinned()) {
                                this._pComposerState.mesh.isSkinning = true;
                            } else {
                                this._pComposerState.mesh.isSkinning = false;
                            }
                        }
                        pPassBlend = this._pBlender.generatePassBlend(pPassInstructionList, this._pComposerState, pPassInput.foreigns, pPassInput.uniforms);
                    }
                    if (((pPassBlend) === null)) {
 {
                            akra.logger.setSourceLocation("fx/Composer.ts", 468);
                            akra.logger.error("Could not render. Error with generation pass-blend.");
                        }
                        ;
                        return;
                    }
                    pMaker = pPassBlend.generateFXMaker(pPassInput, this._pCurrentSurfaceMaterial, this._pCurrentBufferMap);
                }
                var pInput = pMaker._make(pPassInput, this._pCurrentBufferMap);
                var pRenderer = this._pEngine.getRenderer();
                var pEntry = pRenderer.createEntry();
                pEntry.maker = pMaker;
                pEntry.input = pInput;
                pEntry.viewport = this._pCurrentViewport;
                pEntry.bufferMap = this._pCurrentBufferMap;
                if (pRenderTechnique.hasGlobalPostEffect()) {
                    if (!pRenderTechnique.isFirstPass(iPass)) {
                        pRenderer._setDepthBufferParams(false, false, 0);
                        pRenderer._setRenderTarget(this._pRenderTargetA);
                        pRenderer.clearFrameBuffer(akra.EFrameBufferTypes.COLOR | akra.EFrameBufferTypes.DEPTH, akra.Color.ZERO, 1., 0);
                        if (pEntry.viewport.getClearEveryFrame()) {
                            var pViewportState = pEntry.viewport._getViewportState();
                            pRenderer.clearFrameBuffer(pViewportState.clearBuffers, pViewportState.clearColor, pViewportState.clearDepth, 0);
                        }
                    }
                    if (pEntry.viewport.actualWidth > this._pRenderTargetA.width || pEntry.viewport.actualHeight > this._pRenderTargetA.height) {
                        this.resizePostEffectTextures(pEntry.viewport.actualWidth, pEntry.viewport.actualHeight);
                    }
                    if (!pRenderTechnique.isPostEffectPass(iPass)) {
                        this._pLastRenderTarget = this._pRenderTargetA;
                        pEntry.renderTarget = this._pRenderTargetA;
                    } else {
                        if (pRenderTechnique.isLastPass(iPass)) {
                            this._pLastRenderTarget = null;
                        } else {
                            if (this._pLastRenderTarget === this._pRenderTargetA) {
                                pEntry.renderTarget = this._pRenderTargetB;
                                this._pLastRenderTarget = this._pRenderTargetB;
                            } else {
                                pEntry.renderTarget = this._pRenderTargetA;
                                this._pLastRenderTarget = this._pRenderTargetA;
                            }
                        }
                    }
                }
                pRenderer.pushEntry(pEntry);
            };
            Composer.prototype._loadEffectFromSyntaxTree = function (pTree, sFileName) {
                var pEffect = new akra.fx.Effect(this);
                pEffect.setAnalyzedFileName(sFileName);
                var isOk = pEffect.analyze(pTree);
                if (isOk) {
                    var pTechniqueList = pEffect.getTechniqueList();
                    for(var i = 0; i < pTechniqueList.length; i++) {
                        isOk = this.initComponent(pTechniqueList[i]);
                        if (!isOk) {
 {
                                akra.logger.setSourceLocation("fx/Composer.ts", 559);
                                akra.logger.warning("Cannot initialize fx-component from technique '" + pTechniqueList[i].getName() + "'.");
                            }
                            ;
                            return false;
                        }
                    }
                } else {
 {
                        akra.logger.setSourceLocation("fx/Composer.ts", 565);
                        akra.logger.warning("Error are occured during analyze of effect file '" + sFileName + "'.");
                    }
                    ;
                    return false;
                }
                return true;
            };
            Composer.prototype._loadEffectFromBinary = function (pData, sFileName) {
                return false;
            };
            Composer.prototype.initComponent = function (pTechnique) {
                var sTechniqueName = pTechnique.getName();
                var pComponentPool = this._pEngine.getResourceManager().componentPool;
                if (!((pComponentPool.findResource(sTechniqueName)) === null)) {
                    return false;
                }
                var pComponent = pComponentPool.createResource(sTechniqueName);
                pComponent.create();
                pComponent.setTechnique(pTechnique);
                return true;
            };
            Composer.prototype.clearPreRenderState = function () {
            };
            Composer.prototype.applySystemUnifoms = function (pPassInput) {
                var pSceneObject = this._getCurrentSceneObject();
                var pViewport = this._getCurrentViewport();
                var pRenderable = this._getCurrentRenderableObject();
                if (!((pSceneObject) === null)) {
                    pPassInput.setUniform("MODEL_MATRIX", pSceneObject.worldMatrix);
                }
                if (!((pViewport) === null)) {
                    var pCamera = pViewport.getCamera();
                    pPassInput.setUniform("VIEW_MATRIX", pCamera.viewMatrix);
                    pPassInput.setUniform("PROJ_MATRIX", pCamera.projectionMatrix);
                    pPassInput.setUniform("INV_VIEW_CAMERA_MAT", pCamera.worldMatrix);
                    pPassInput.setUniform("CAMERA_POSITION", pCamera.worldPosition);
                    if (pCamera.type === akra.EEntityTypes.SHADOW_CASTER) {
                        pPassInput.setUniform("OPTIMIZED_PROJ_MATRIX", (pCamera).optimizedProjection);
                    }
                }
                if (!((pRenderable) === null)) {
                    if (akra.render.isMeshSubset(pRenderable) && (pRenderable).isSkinned()) {
                        pPassInput.setUniform("BIND_SHAPE_MATRIX", (pRenderable).skin.getBindMatrix());
                    }
                    pPassInput.setUniform("RENDER_OBJECT_ID", pRenderable.getGuid());
                }
                if (!((this._pLastRenderTarget) === null)) {
                    var pLastTexture = this._pLastRenderTarget === this._pRenderTargetA ? this._pPostEffectTextureA : this._pPostEffectTextureB;
                    pPassInput.setTexture("INPUT_TEXTURE", pLastTexture);
                    pPassInput.setSamplerTexture("INPUT_SAMPLER", pLastTexture);
                    pPassInput.setUniform("INPUT_TEXTURE_SIZE", akra.vec2(pLastTexture.width, pLastTexture.height));
                    pPassInput.setUniform("INPUT_TEXTURE_RATIO", akra.vec2(this._pCurrentViewport.actualWidth / pLastTexture.width, this._pCurrentViewport.actualHeight / pLastTexture.height));
                }
                pPassInput.setUniform("useNormal", this.bUseNormalMap);
            };
            Composer.prototype.initPostEffectTextures = function () {
                var pRmgr = this._pEngine.getResourceManager();
                this._pPostEffectTextureA = pRmgr.createTexture(".global-post-effect-texture-A");
                this._pPostEffectTextureB = pRmgr.createTexture(".global-post-effect-texture-B");
                this._pPostEffectTextureA.create(512, 512, 1, null, akra.ETextureFlags.RENDERTARGET, 0, 0, akra.ETextureTypes.TEXTURE_2D, akra.EPixelFormats.R8G8B8A8);
                this._pPostEffectTextureB.create(512, 512, 1, null, akra.ETextureFlags.RENDERTARGET, 0, 0, akra.ETextureTypes.TEXTURE_2D, akra.EPixelFormats.R8G8B8A8);
                this._pRenderTargetA = this._pPostEffectTextureA.getBuffer().getRenderTarget();
                this._pRenderTargetB = this._pPostEffectTextureB.getBuffer().getRenderTarget();
                this._pPostEffectDepthBuffer = pRmgr.renderBufferPool.createResource(".global-post-effect-depth");
                (this._pPostEffectDepthBuffer).create(0x1902, 512, 512, false);
                this._pRenderTargetA.attachDepthPixelBuffer(this._pPostEffectDepthBuffer);
            };
            Composer.prototype.resizePostEffectTextures = function (iWidth, iHeight) {
                iWidth = akra.math.ceilingPowerOfTwo(iWidth);
                iHeight = akra.math.ceilingPowerOfTwo(iHeight);
                this._pPostEffectTextureA.reset(iWidth, iHeight);
                this._pPostEffectTextureB.reset(iWidth, iHeight);
            };
            return Composer;
        })();
        fx.Composer = Composer;        
    })(akra.fx || (akra.fx = {}));
    var fx = akra.fx;
})(akra || (akra = {}));
var akra;
(function (akra) {
    var DDSCodec = (function (_super) {
        __extends(DDSCodec, _super);
        function DDSCodec() {
            _super.apply(this, arguments);

            this._sType = "dds";
        }
        DDSCodec._pInstance = null;
        DDSCodec.prototype.magicNumberToFileExt = function (pMagicNumber) {
            var dwMagic4 = (new Uint32Array(pMagicNumber.buffer, 0, 1))[0];
            if (0x20534444 == dwMagic4) {
                return "dds";
            }
            return null;
        };
        DDSCodec.startup = function startup() {
            if (!((this._pInstance) != null)) {
 {
                    akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 163);
                    akra.logger.log("DDS codec registering");
                }
                ;
                this._pInstance = new DDSCodec();
                akra.Codec.registerCodec(this._pInstance);
            }
        };
        DDSCodec.shutdown = function shutdown() {
            if (((this._pInstance) !== undefined)) {
                akra.Codec.unRegisterCodec(this._pInstance);
                this._pInstance = undefined;
            }
        };
        DDSCodec.prototype.getType = function () {
            return this._sType;
        };
        DDSCodec.prototype.decode = function (pData, pImgData) {
            var iOffset = 0;
            var dwMagic4 = (new Uint32Array(pData.buffer, 0, 1))[0];
            if (dwMagic4 != 0x20534444) {
 {
                    akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 189);
                    akra.logger.criticalError("This is not a DDS file! DDSCodec.decode");
                }
                ;
            }
            var pDDSHeader = new Uint32Array(pData.buffer, 4, 31);
            var pHeader = {};
            pHeader.dwSize = pDDSHeader[0];
            pHeader.dwFlags = pDDSHeader[1];
            pHeader.dwHeight = pDDSHeader[2];
            pHeader.dwWidth = pDDSHeader[3];
            pHeader.dwPitchOrLinearSize = pDDSHeader[4];
            pHeader.dwDepth = pDDSHeader[5];
            pHeader.dwMipMapCount = pDDSHeader[6];
            pHeader.dwReserved1 = [];
            pHeader.dwReserved1[0] = pDDSHeader[7];
            pHeader.dwReserved1[1] = pDDSHeader[8];
            pHeader.dwReserved1[2] = pDDSHeader[9];
            pHeader.dwReserved1[3] = pDDSHeader[10];
            pHeader.dwReserved1[4] = pDDSHeader[11];
            pHeader.dwReserved1[5] = pDDSHeader[12];
            pHeader.dwReserved1[6] = pDDSHeader[13];
            pHeader.dwReserved1[7] = pDDSHeader[14];
            pHeader.dwReserved1[8] = pDDSHeader[15];
            pHeader.dwReserved1[9] = pDDSHeader[16];
            pHeader.dwReserved1[10] = pDDSHeader[17];
            pHeader.ddspf = {};
            pHeader.ddspf.dwSize = pDDSHeader[18];
            pHeader.ddspf.dwFlags = pDDSHeader[19];
            pHeader.ddspf.dwFourCC = pDDSHeader[20];
            pHeader.ddspf.dwRGBBitCount = pDDSHeader[21];
            pHeader.ddspf.dwRBitMask = pDDSHeader[22];
            pHeader.ddspf.dwGBitMask = pDDSHeader[23];
            pHeader.ddspf.dwBBitMask = pDDSHeader[24];
            pHeader.ddspf.dwABitMask = pDDSHeader[25];
            pHeader.dwCaps = pDDSHeader[26];
            pHeader.dwCaps2 = pDDSHeader[27];
            pHeader.dwCaps3 = pDDSHeader[28];
            pHeader.dwCaps4 = pDDSHeader[29];
            pHeader.dwReserved2 = pDDSHeader[30];
            iOffset += 128;
            if (pHeader.dwSize != 124) {
 {
                    akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 258);
                    akra.logger.error("Размер заголовка DDS всегда должэен равняться 124");
                }
                ;
            }
            if (pHeader.ddspf.dwSize != 32) {
 {
                    akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 261);
                    akra.logger.error("Размер DDS_PIXELFORMAT всегда должен равняться 32");
                }
                ;
            }
            if (!(pHeader.dwFlags & 0x00000001)) {
 {
                    akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 264);
                    akra.logger.error("Флаг DDSD_CAPS в заголовке DDS всегда должен быть");
                }
                ;
            }
            if (!(pHeader.dwFlags & 0x00000002)) {
 {
                    akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 267);
                    akra.logger.error("Флаг DDSD_HEIGHT в заголовке DDS всегда должен быть");
                }
                ;
            }
            if (!(pHeader.dwFlags & 0x00000004)) {
 {
                    akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 270);
                    akra.logger.error("Флаг DDSD_WIDTH в заголовке DDS всегда должен быть");
                }
                ;
            }
            if (!(pHeader.dwFlags & 0x00001000)) {
 {
                    akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 273);
                    akra.logger.error("Флаг DDSD_PIXELFORMAT в заголовке DDS всегда должен быть");
                }
                ;
            }
            pImgData.width = pHeader.dwWidth;
            pImgData.height = pHeader.dwHeight;
            pImgData.depth = 1;
            var nFace = 1;
            pImgData.flags = 0;
            if (pHeader.dwCaps2 & 0x200) {
                pImgData.flags |= akra.EImageFlags.CUBEMAP;
                nFace = 0;
                if (pHeader.dwCaps2 & 0x400) {
                    nFace++;
                    pImgData.cubeFlags |= akra.EImageCubeFlags.POSITIVE_X;
                }
                if (pHeader.dwCaps2 & 0x800) {
                    nFace++;
                    pImgData.cubeFlags |= akra.EImageCubeFlags.NEGATIVE_X;
                }
                if (pHeader.dwCaps2 & 0x1000) {
                    nFace++;
                    pImgData.cubeFlags |= akra.EImageCubeFlags.POSITIVE_Y;
                }
                if (pHeader.dwCaps2 & 0x2000) {
                    nFace++;
                    pImgData.cubeFlags |= akra.EImageCubeFlags.NEGATIVE_Y;
                }
                if (pHeader.dwCaps2 & 0x4000) {
                    nFace++;
                    pImgData.cubeFlags |= akra.EImageCubeFlags.POSITIVE_Z;
                }
                if (pHeader.dwCaps2 & 0x8000) {
                    nFace++;
                    pImgData.cubeFlags |= akra.EImageCubeFlags.NEGATIVE_Z;
                }
                if (nFace == 0) {
 {
                        akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 313);
                        akra.logger.warning("Выставлен фдлаг с кубической текстурой, а самих текстур нету");
                    }
                    ;
                }
            }
            if (pHeader.dwCaps2 & 0x200000) {
                pImgData.flags |= akra.EImageFlags.TEXTURE_3D;
                pImgData.depth = pHeader.dwDepth;
            }
            var eSourceFormat = akra.EPixelFormats.UNKNOWN;
            if (pHeader.ddspf.dwFlags & 0x00000004) {
                if (pHeader.ddspf.dwFourCC == 0x31545844) {
                    eSourceFormat = akra.EPixelFormats.DXT1;
                } else if (pHeader.ddspf.dwFourCC == 0x32545844) {
                    eSourceFormat = akra.EPixelFormats.DXT1;
                } else if (pHeader.ddspf.dwFourCC == 0x33545844) {
                    eSourceFormat = akra.EPixelFormats.DXT3;
                } else if (pHeader.ddspf.dwFourCC == 0x34545844) {
                    eSourceFormat = akra.EPixelFormats.DXT4;
                } else if (pHeader.ddspf.dwFourCC == 0x35545844) {
                    eSourceFormat = akra.EPixelFormats.DXT5;
                } else if (pHeader.ddspf.dwFourCC == 0x30315844) {
                    var pDDS10Header = new Uint32Array(pData.buffer, 128, 5);
                    var header10 = {};
                    header10.dxgiFormat = pDDS10Header[0];
                    header10.resourceDimension = pDDS10Header[1];
                    header10.miscFlag = pDDS10Header[2];
                    header10.arraySize = pDDS10Header[3];
                    header10.reserved = pDDS10Header[4];
 {
                        akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 350);
                        akra.logger.criticalError("Формат D3DFMT_DX10 не поддерживается");
                    }
                    ;
                    iOffset += 20;
                } else if (pHeader.ddspf.dwFourCC == 0x0000006F) {
                    eSourceFormat = akra.EPixelFormats.FLOAT16_R;
                } else if (pHeader.ddspf.dwFourCC == 0x00000070) {
                    eSourceFormat = akra.EPixelFormats.FLOAT16_GR;
                } else if (pHeader.ddspf.dwFourCC == 0x00000071) {
                    eSourceFormat = akra.EPixelFormats.FLOAT16_RGBA;
                } else if (pHeader.ddspf.dwFourCC == 0x00000072) {
                    eSourceFormat = akra.EPixelFormats.FLOAT32_R;
                } else if (pHeader.ddspf.dwFourCC == 0x00000073) {
                    eSourceFormat = akra.EPixelFormats.FLOAT32_GR;
                } else if (pHeader.ddspf.dwFourCC == 0x00000074) {
                    eSourceFormat = akra.EPixelFormats.FLOAT32_RGBA;
                } else {
 {
                        akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 390);
                        akra.logger.criticalError("Флаг DDPF_FOURCC стоит, а подходящего dwFourCC нет");
                    }
                    ;
                }
            } else {
                var iAMask = pHeader.ddspf.dwFlags & 0x00000001 ? pHeader.ddspf.dwABitMask : 0;
                var ePF;
                for(ePF = akra.EPixelFormats.UNKNOWN + 1; ePF < akra.EPixelFormats.TOTAL; ePF++) {
                    if ((!!(pHeader.ddspf.dwFlags & 0x00020000)) != akra.pixelUtil.isLuminance(ePF)) {
                        continue;
                    }
                    if ((!!(pHeader.ddspf.dwFlags & 0x00000001)) != akra.pixelUtil.hasAlpha(ePF)) {
                        continue;
                    }
                    if (akra.pixelUtil.getNumElemBits(ePF) == pHeader.ddspf.dwRGBBitCount) {
                        var pTestMasks = akra.pixelUtil.getBitMasks(ePF);
                        var pTestBits = akra.pixelUtil.getBitDepths(ePF);
                        if (pTestMasks[0] == pHeader.ddspf.dwRBitMask && pTestMasks[1] == pHeader.ddspf.dwGBitMask && pTestMasks[2] == pHeader.ddspf.dwBBitMask && (pTestMasks[3] == iAMask || (iAMask == 0 && pTestBits[3] == 0))) {
                            break;
                        }
                    }
                }
                if (ePF == akra.EPixelFormats.TOTAL) {
 {
                        akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 429);
                        akra.logger.criticalError("Cannot determine pixel format. DDSCodec.decode");
                    }
                    ;
                } else {
                    eSourceFormat = ePF;
                }
            }
            pImgData.format = eSourceFormat;
            if (pHeader.dwFlags & 0x00020000) {
                pImgData.numMipMaps = pHeader.dwMipMapCount - 1;
                if (pImgData.numMipMaps != akra.core.pool.resources.Img.getMaxMipmaps(pImgData.width, pImgData.height, pImgData.depth, pImgData.format)) {
 {
                        akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 459);
                        akra.logger.warning("Количество мипмапов не такое чтобы уменьшить размер картинки до 1x1 " + pHeader.dwMipMapCount + "," + pHeader.dwWidth + "x" + pHeader.dwHeight + ")");
                    }
                    ;
                }
            } else {
                pImgData.numMipMaps = 0;
            }
            var pOutput = new Uint8Array(pImgData.size);
            var iOutputOffset = 0;
            for(var i = 0; i < nFace; i++) {
                var iWidth = pImgData.width;
                var iHeight = pImgData.height;
                var iDepth = pImgData.depth;
                for(var iMip = 0; iMip <= pImgData.numMipMaps; iMip++) {
                    if (akra.pixelUtil.isCompressed(pImgData.format)) {
                        var iDXTSize = akra.pixelUtil.getMemorySize(iWidth, iHeight, iDepth, pImgData.format);
                        for(var a = 0; a < iDXTSize; a++) {
                            pOutput[a + iOutputOffset] = pData[iOffset + a];
                        }
                        iOffset += iDXTSize;
                        iOutputOffset += iDXTSize;
                    } else {
                        var iDstPitch = iWidth * akra.pixelUtil.getNumElemBytes(pImgData.format);
                        var iSrcPitch = 0;
                        if (pHeader.dwFlags & 0x00000008) {
                            iSrcPitch = pHeader.dwPitchOrLinearSize / Math.max(1, iMip * 2);
                        } else {
                            iSrcPitch = iDstPitch;
                        }
                        if (iSrcPitch < iDstPitch) {
 {
                                akra.logger.setSourceLocation("pixelUtil/DDSCodec.ts", 506);
                                akra.logger.warning("Странный размер питча у картинки");
                            }
                        }
                        for(var z = 0; z < pImgData.depth; z++) {
                            for(var y = 0; y < pImgData.height; y++) {
                                for(var a = 0; a < iDstPitch; a++) {
                                    pOutput[a + iOutputOffset] = pData[iOffset + a];
                                }
                                iOutputOffset = iOutputOffset + iDstPitch;
                                iOffset = iOffset + iSrcPitch;
                            }
                        }
                    }
                    if (iWidth != 1) {
                        iWidth = Math.floor(iWidth / 2);
                    }
                    if (iHeight != 1) {
                        iHeight = Math.floor(iHeight / 2);
                    }
                    if (iDepth != 1) {
                        iDepth = Math.floor(iDepth / 2);
                    }
                }
            }
            return pOutput;
        };
        return DDSCodec;
    })(akra.ImgCodec);
    akra.DDSCodec = DDSCodec;    
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (util) {
        (function (EDepsManagerStates) {
            EDepsManagerStates._map = [];
            EDepsManagerStates._map[0] = "IDLE";
            EDepsManagerStates.IDLE = 0;
            EDepsManagerStates._map[1] = "LOADING";
            EDepsManagerStates.LOADING = 1;
        })(util.EDepsManagerStates || (util.EDepsManagerStates = {}));
        var EDepsManagerStates = util.EDepsManagerStates;
        var DepsManager = (function () {
            function DepsManager(pEngine) {
                this._eState = EDepsManagerStates.IDLE;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._pEngine = pEngine;
            }
            DepsManager.prototype.getEngine = function () {
                return this._pEngine;
            };
            DepsManager.prototype.load = function (pDeps, sRoot) {
                if (typeof sRoot === "undefined") { sRoot = null; }
                if (!((pDeps) != null)) {
                    return false;
                }
                if (this._eState === EDepsManagerStates.LOADING) {
 {
                        util.logger.setSourceLocation("util/DepsManager.ts", 33);
                        util.logger.warning("deps manager in loading state");
                    }
                    ;
                    return false;
                }
                this.normalizeDepsPaths(pDeps, pDeps.root || sRoot);
                this.createDepsResources(pDeps);
                this.loadDeps(pDeps);
                return true;
            };
            DepsManager.prototype.walk = function (pDeps, fn, iDepth) {
                if (typeof iDepth === "undefined") { iDepth = 0; }
                var pFiles = pDeps.files;
                if (((pFiles) != null)) {
                    for(var i = 0; i < pFiles.length; ++i) {
                        fn.call(this, pDeps, i, iDepth);
                    }
                }
                if (((pDeps.deps) != null)) {
                    this.walk(pDeps.deps, fn, ++iDepth);
                }
            };
            DepsManager.prototype.normalizeDepsPaths = function (pDeps, sRoot) {
                this.walk(pDeps, function (pDeps, i) {
                    pDeps.files[i] = (sRoot || "") + "/" + pDeps.files[i];
                });
            };
            DepsManager.prototype.createDepsResources = function (pDeps) {
                var pRmgr = this.getEngine().getResourceManager();
                this.walk(pDeps, function (pDeps, i) {
                    var pFiles = pDeps.files;
                    switch(util.pathinfo(pFiles[i]).ext.toLowerCase()) {
                        case "afx":
                            if (!pRmgr.effectDataPool.findResource(pFiles[i])) {
                                pRmgr.effectDataPool.createResource(pFiles[i]);
                            }
                            break;
                    }
                });
            };
            DepsManager.prototype.loadDeps = function (pDeps) {
                var _this = this;
                var pRmgr = this.getEngine().getResourceManager();
                var pRes;
                if (!akra.isArray(pDeps.files) || pDeps.files.length === 0) {
                    this._onDependencyLoad(pDeps);
                }
                this.walk({
                    files: pDeps.files
                }, function (pDep, i) {
                    var pFiles = pDeps.files;
                    var pManager = _this;
                    if (((pDep.type) != null)) {
                        if (pDep.type == "text" && (/*checked (origin: akra)>>*/akra.typeOf((pDep.loader)) === "function")) {
                            akra.io.fopen(pFiles[i], "r").read(function (pErr, sData) {
                                if (!((pErr) === null)) {
                                    pManager.error(pErr);
                                }
                                pDep.loader(pDep, sData);
                                pManager._onDependencyLoad(pDeps, i);
                            });
                        }
                    }
                    switch(util.pathinfo(pFiles[i]).ext.toLowerCase()) {
                        case "gr":
                            akra.io.fopen(pFiles[i], "r").read(function (pErr, sData) {
                                if (!((pErr) === null)) {
                                    pManager.error(pErr);
                                }
                                akra.util.initAFXParser(sData);
                                pManager._onDependencyLoad(pDeps, i);
                            });
                            break;
                        case "afx":
                            pRes = pRmgr.effectDataPool.findResource(pFiles[i]);
                            if (pRes.loadResource(pFiles[i])) {
                                pManager._handleResourceEventOnce(pRes, "loaded", function (pItem) {
                                    pManager._onDependencyLoad(pDeps, i);
                                });
                            } else {
                                _this.error(new Error("could not laod resource: " + pFiles[i]));
                            }
                            break;
                        default:
 {
                                util.logger.setSourceLocation("util/DepsManager.ts", 138);
                                util.logger.warning("dependence " + pFiles[i] + " unknown, and will be skipped.");
                            }
                            ;
                    }
                });
            };
            DepsManager.prototype._handleResourceEventOnce = function (pRsc, sSignal, fnHandler) {
                var fn;
                fn = function (pItem) {
                    fnHandler(pItem);
                    pRsc.unbind(sSignal, fn);
                };
                pRsc.bind(sSignal, fn);
            };
            DepsManager.prototype._onDependencyLoad = function (pDeps, n) {
                if (((n) !== undefined)) {
                    pDeps.files[n] = null;
                }
                for(var i = 0; i < pDeps.files.length; ++i) {
                    if (!((pDeps.files[i]) === null)) {
                        return;
                    }
                }
                ;
                if (((pDeps.deps) != null)) {
                    this.loadDeps(pDeps.deps);
                } else {
                    this.loaded(pDeps);
                }
            };
            DepsManager.prototype.getGuid = function () {
                return this._iGuid;
            };
            DepsManager._pEventTable = new akra.events.EventTable();
            DepsManager.prototype.getEventTable = function () {
                return DepsManager._pEventTable;
            };
            DepsManager.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            DepsManager.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            DepsManager.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            DepsManager.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            DepsManager.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            DepsManager.prototype.loaded = function (deps) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).loaded;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, deps) : _broadcast[i].listener(_recivier, deps);
                    }
                }
            };
            DepsManager.prototype.error = function (pErr) {
                if (true) {
                    throw pErr;
                }
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).error;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pErr) : _broadcast[i].listener(_recivier, pErr);
                    }
                }
                ;
            };
            return DepsManager;
        })();        
        function createDepsManager(pEngine) {
 {
                util.logger.setSourceLocation("util/DepsManager.ts", 190);
                util.logger.assert(((pEngine) != null));
            }
            ;
            return new DepsManager(pEngine);
        }
        util.createDepsManager = createDepsManager;
    })(akra.util || (akra.util = {}));
    var util = akra.util;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EGamepadCodes) {
        EGamepadCodes._map = [];
        EGamepadCodes.FACE_1 = 0;
        EGamepadCodes.FACE_2 = 1;
        EGamepadCodes.FACE_3 = 2;
        EGamepadCodes.FACE_4 = 3;
        EGamepadCodes.LEFT_SHOULDER = 4;
        EGamepadCodes.RIGHT_SHOULDER = 5;
        EGamepadCodes.LEFT_SHOULDER_BOTTOM = 6;
        EGamepadCodes.RIGHT_SHOULDER_BOTTOM = 7;
        EGamepadCodes.SELECT = 8;
        EGamepadCodes.START = 9;
        EGamepadCodes.LEFT_ANALOGUE_STICK = 10;
        EGamepadCodes.RIGHT_ANALOGUE_STICK = 11;
        EGamepadCodes.PAD_TOP = 12;
        EGamepadCodes.PAD_BOTTOM = 13;
        EGamepadCodes.PAD_LEFT = 14;
        EGamepadCodes.PAD_RIGHT = 15;
    })(akra.EGamepadCodes || (akra.EGamepadCodes = {}));
    var EGamepadCodes = akra.EGamepadCodes;
    (function (EGamepadAxis) {
        EGamepadAxis._map = [];
        EGamepadAxis.LEFT_ANALOGUE_HOR = 0;
        EGamepadAxis.LEFT_ANALOGUE_VERT = 1;
        EGamepadAxis.RIGHT_ANALOGUE_HOR = 2;
        EGamepadAxis.RIGHT_ANALOGUE_VERT = 3;
    })(akra.EGamepadAxis || (akra.EGamepadAxis = {}));
    var EGamepadAxis = akra.EGamepadAxis;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (controls) {
        var GamepadMap = (function () {
            function GamepadMap() {
                this._bTicking = false;
                this._pCollection = new akra.util.ObjectArray();
                this._pPrevRawGamepadTypes = [
                    null, 
                    null, 
                    null, 
                    null
                ];
                this._pPrevTimestamps = [
                    0, 
                    0, 
                    0, 
                    0
                ];
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
            }
            GamepadMap.prototype.init = function () {
                if (!akra.info.api.gamepad) {
 {
                        akra.logger.setSourceLocation("controls/GamepadMap.ts", 21);
                        akra.logger.warning("Gamepad API is unsupported.");
                    }
                    ;
                    return false;
                }
                var pMap = this;
                var pCollection = this._pCollection;
                window.addEventListener('MozGamepadConnected', function (e) {
                    pCollection.push(e.gamepad);
                    pMap.connected(e.gamepad);
                    pMap._startPolling();
                }, false);
                window.addEventListener('MozGamepadDisconnected', function (e) {
                    for(var i = 0; i < pCollection.length; ++i) {
                        if (pCollection.value(i).index == e.gamepad.index) {
                            pMap.disconnected(pCollection.takeAt(i));
                            break;
                        }
                    }
                    if (pCollection.length == 0) {
                        pMap._stopPolling();
                    }
                }, false);
                if (!!navigator.gamepads || !!navigator.getGamepads) {
                    this._startPolling();
                    return true;
                }
                return false;
            };
            GamepadMap.prototype.isActive = function () {
                return this._bTicking;
            };
            GamepadMap.prototype.find = function (id) {
                var sID = null;
                var i = 0;
                if (arguments.length) {
                    if ((typeof (arguments[0]) === "string")) {
                        sID = arguments[0];
                    } else if ((typeof (arguments[0]) === "number")) {
                        i = arguments[0];
                    }
                }
                if (!((sID) === null)) {
                    for(i = 0; i < this._pCollection.length; ++i) {
                        if (this._pCollection.value(i).id == sID) {
                            return this._pCollection.value(i);
                        }
                    }
                }
                return this._pCollection.value(i);
            };
            GamepadMap.prototype._startPolling = function () {
                if (!this._bTicking) {
                    this._bTicking = true;
                    this.update();
                }
            };
            GamepadMap.prototype._stopPolling = function () {
                this._bTicking = false;
            };
            GamepadMap.prototype.update = function () {
                this.pollStatus();
            };
            GamepadMap.prototype.pollStatus = function () {
                if (!this._bTicking) {
                    return;
                }
                this.pollGamepads();
                for(var i = 0; i < this._pCollection.length; ++i) {
                    var pGamepad = this._pCollection.value(i);
                    if (pGamepad.timestamp && (pGamepad.timestamp == this._pPrevTimestamps[i])) {
                        continue;
                    }
                    this._pPrevTimestamps[i] = pGamepad.timestamp;
                }
            };
            GamepadMap.prototype.pollGamepads = function () {
                var pRawGamepads = (navigator.getGamepads && navigator.getGamepads()) || navigator.gamepads;
                if (((pRawGamepads) != null)) {
                    this._pCollection.clear();
                    var isGamepadsChanged = false;
                    for(var i = 0; i < pRawGamepads.length; i++) {
                        if (typeof pRawGamepads[i] != this._pPrevRawGamepadTypes[i]) {
                            isGamepadsChanged = true;
                            this._pPrevRawGamepadTypes[i] = typeof pRawGamepads[i];
                            if (((pRawGamepads[i]) != null)) {
 {
                                    akra.logger.setSourceLocation("controls/GamepadMap.ts", 135);
                                    akra.logger.log("gamepad " + i + " updated: " + pRawGamepads[i].id);
                                }
                                ;
                                this.updated(pRawGamepads[i]);
                            }
                        }
                        if (((pRawGamepads[i]) != null)) {
                            this._pCollection.push(pRawGamepads[i]);
                        }
                    }
                }
            };
            GamepadMap.prototype.getGuid = function () {
                return this._iGuid;
            };
            GamepadMap._pEventTable = new akra.events.EventTable();
            GamepadMap.prototype.getEventTable = function () {
                return GamepadMap._pEventTable;
            };
            GamepadMap.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            GamepadMap.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            GamepadMap.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            GamepadMap.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            GamepadMap.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            GamepadMap.prototype.connected = function (pGamepad) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).connected;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pGamepad) : _broadcast[i].listener(_recivier, pGamepad);
                    }
                }
            };
            GamepadMap.prototype.disconnected = function (pGamepad) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).disconnected;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pGamepad) : _broadcast[i].listener(_recivier, pGamepad);
                    }
                }
            };
            GamepadMap.prototype.updated = function (pGamepad) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).updated;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pGamepad) : _broadcast[i].listener(_recivier, pGamepad);
                    }
                }
            };
            return GamepadMap;
        })();        
        function createGamepadMap() {
            return new GamepadMap();
        }
        controls.createGamepadMap = createGamepadMap;
    })(akra.controls || (akra.controls = {}));
    var controls = akra.controls;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EKeyCodes) {
        EKeyCodes._map = [];
        EKeyCodes.BACKSPACE = 8;
        EKeyCodes.TAB = 9;
        EKeyCodes.ENTER = 13;
        EKeyCodes.SHIFT = 16;
        EKeyCodes._map[17] = "CTRL";
        EKeyCodes.CTRL = 17;
        EKeyCodes._map[18] = "ALT";
        EKeyCodes.ALT = 18;
        EKeyCodes.PAUSE = 19;
        EKeyCodes.BREAK = 19;
        EKeyCodes.CAPSLOCK = 20;
        EKeyCodes.ESCAPE = 27;
        EKeyCodes.SPACE = 32;
        EKeyCodes.PAGEUP = 33;
        EKeyCodes._map[34] = "PAGEDOWN";
        EKeyCodes.PAGEDOWN = 34;
        EKeyCodes.END = 35;
        EKeyCodes._map[36] = "HOME";
        EKeyCodes.HOME = 36;
        EKeyCodes.LEFT = 37;
        EKeyCodes._map[38] = "UP";
        EKeyCodes.UP = 38;
        EKeyCodes._map[39] = "RIGHT";
        EKeyCodes.RIGHT = 39;
        EKeyCodes._map[40] = "DOWN";
        EKeyCodes.DOWN = 40;
        EKeyCodes.INSERT = 45;
        EKeyCodes._map[46] = "DELETE";
        EKeyCodes.DELETE = 46;
        EKeyCodes.N0 = 48;
        EKeyCodes._map[49] = "N1";
        EKeyCodes.N1 = 49;
        EKeyCodes._map[50] = "N2";
        EKeyCodes.N2 = 50;
        EKeyCodes._map[51] = "N3";
        EKeyCodes.N3 = 51;
        EKeyCodes._map[52] = "N4";
        EKeyCodes.N4 = 52;
        EKeyCodes._map[53] = "N5";
        EKeyCodes.N5 = 53;
        EKeyCodes._map[54] = "N6";
        EKeyCodes.N6 = 54;
        EKeyCodes._map[55] = "N7";
        EKeyCodes.N7 = 55;
        EKeyCodes._map[56] = "N8";
        EKeyCodes.N8 = 56;
        EKeyCodes._map[57] = "N9";
        EKeyCodes.N9 = 57;
        EKeyCodes.A = 65;
        EKeyCodes._map[66] = "B";
        EKeyCodes.B = 66;
        EKeyCodes._map[67] = "C";
        EKeyCodes.C = 67;
        EKeyCodes._map[68] = "D";
        EKeyCodes.D = 68;
        EKeyCodes._map[69] = "E";
        EKeyCodes.E = 69;
        EKeyCodes._map[70] = "F";
        EKeyCodes.F = 70;
        EKeyCodes._map[71] = "G";
        EKeyCodes.G = 71;
        EKeyCodes._map[72] = "H";
        EKeyCodes.H = 72;
        EKeyCodes._map[73] = "I";
        EKeyCodes.I = 73;
        EKeyCodes._map[74] = "J";
        EKeyCodes.J = 74;
        EKeyCodes._map[75] = "K";
        EKeyCodes.K = 75;
        EKeyCodes._map[76] = "L";
        EKeyCodes.L = 76;
        EKeyCodes._map[77] = "M";
        EKeyCodes.M = 77;
        EKeyCodes._map[78] = "N";
        EKeyCodes.N = 78;
        EKeyCodes._map[79] = "O";
        EKeyCodes.O = 79;
        EKeyCodes._map[80] = "P";
        EKeyCodes.P = 80;
        EKeyCodes._map[81] = "Q";
        EKeyCodes.Q = 81;
        EKeyCodes._map[82] = "R";
        EKeyCodes.R = 82;
        EKeyCodes._map[83] = "S";
        EKeyCodes.S = 83;
        EKeyCodes._map[84] = "T";
        EKeyCodes.T = 84;
        EKeyCodes._map[85] = "U";
        EKeyCodes.U = 85;
        EKeyCodes._map[86] = "V";
        EKeyCodes.V = 86;
        EKeyCodes._map[87] = "W";
        EKeyCodes.W = 87;
        EKeyCodes._map[88] = "X";
        EKeyCodes.X = 88;
        EKeyCodes._map[89] = "Y";
        EKeyCodes.Y = 89;
        EKeyCodes._map[90] = "Z";
        EKeyCodes.Z = 90;
        EKeyCodes.LEFTWINDOWKEY = 91;
        EKeyCodes._map[92] = "RIGHTWINDOWKEY";
        EKeyCodes.RIGHTWINDOWKEY = 92;
        EKeyCodes._map[93] = "SELECTKEY";
        EKeyCodes.SELECTKEY = 93;
        EKeyCodes.NUMPAD0 = 96;
        EKeyCodes._map[97] = "NUMPAD1";
        EKeyCodes.NUMPAD1 = 97;
        EKeyCodes._map[98] = "NUMPAD2";
        EKeyCodes.NUMPAD2 = 98;
        EKeyCodes._map[99] = "NUMPAD3";
        EKeyCodes.NUMPAD3 = 99;
        EKeyCodes._map[100] = "NUMPAD4";
        EKeyCodes.NUMPAD4 = 100;
        EKeyCodes._map[101] = "NUMPAD5";
        EKeyCodes.NUMPAD5 = 101;
        EKeyCodes._map[102] = "NUMPAD6";
        EKeyCodes.NUMPAD6 = 102;
        EKeyCodes._map[103] = "NUMPAD7";
        EKeyCodes.NUMPAD7 = 103;
        EKeyCodes._map[104] = "NUMPAD8";
        EKeyCodes.NUMPAD8 = 104;
        EKeyCodes._map[105] = "NUMPAD9";
        EKeyCodes.NUMPAD9 = 105;
        EKeyCodes.MULTIPLY = 106;
        EKeyCodes._map[107] = "ADD";
        EKeyCodes.ADD = 107;
        EKeyCodes.SUBTRACT = 109;
        EKeyCodes._map[110] = "DECIMALPOINT";
        EKeyCodes.DECIMALPOINT = 110;
        EKeyCodes._map[111] = "DIVIDE";
        EKeyCodes.DIVIDE = 111;
        EKeyCodes.F1 = 112;
        EKeyCodes._map[113] = "F2";
        EKeyCodes.F2 = 113;
        EKeyCodes._map[114] = "F3";
        EKeyCodes.F3 = 114;
        EKeyCodes._map[115] = "F4";
        EKeyCodes.F4 = 115;
        EKeyCodes._map[116] = "F5";
        EKeyCodes.F5 = 116;
        EKeyCodes._map[117] = "F6";
        EKeyCodes.F6 = 117;
        EKeyCodes._map[118] = "F7";
        EKeyCodes.F7 = 118;
        EKeyCodes._map[119] = "F8";
        EKeyCodes.F8 = 119;
        EKeyCodes._map[120] = "F9";
        EKeyCodes.F9 = 120;
        EKeyCodes._map[121] = "F10";
        EKeyCodes.F10 = 121;
        EKeyCodes._map[122] = "F11";
        EKeyCodes.F11 = 122;
        EKeyCodes._map[123] = "F12";
        EKeyCodes.F12 = 123;
        EKeyCodes.NUMLOCK = 144;
        EKeyCodes._map[145] = "SCROLLLOCK";
        EKeyCodes.SCROLLLOCK = 145;
        EKeyCodes.SEMICOLON = 186;
        EKeyCodes._map[187] = "EQUALSIGN";
        EKeyCodes.EQUALSIGN = 187;
        EKeyCodes._map[188] = "COMMA";
        EKeyCodes.COMMA = 188;
        EKeyCodes._map[189] = "DASH";
        EKeyCodes.DASH = 189;
        EKeyCodes._map[190] = "PERIOD";
        EKeyCodes.PERIOD = 190;
        EKeyCodes._map[191] = "FORWARDSLASH";
        EKeyCodes.FORWARDSLASH = 191;
        EKeyCodes._map[192] = "GRAVEACCENT";
        EKeyCodes.GRAVEACCENT = 192;
        EKeyCodes.OPENBRACKET = 219;
        EKeyCodes._map[220] = "BACKSLASH";
        EKeyCodes.BACKSLASH = 220;
        EKeyCodes._map[221] = "CLOSEBRACKET";
        EKeyCodes.CLOSEBRACKET = 221;
        EKeyCodes._map[222] = "SINGLEQUOTE";
        EKeyCodes.SINGLEQUOTE = 222;
        EKeyCodes.TOTAL = 256;
    })(akra.EKeyCodes || (akra.EKeyCodes = {}));
    var EKeyCodes = akra.EKeyCodes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (controls) {
        var KeyMap = (function () {
            function KeyMap(pTarget) {
                this._pMap = new Array(256);
                this._bAlt = false;
                this._bCtrl = false;
                this._bShift = false;
                this._bMouseDown = false;
                this._v2iMousePosition = new akra.Vec2();
                this._v2iMousePrevPosition = new akra.Vec2();
                this._v2iMouseShift = new akra.Vec2();
                for(var i = akra.EKeyCodes.TOTAL; i--; ) {
                    this._pMap[i] = false;
                }
                if (((pTarget) != null)) {
                    this.capture(pTarget);
                }
            }
            KeyMap.prototype.capture = function (pTarget) {
                this.captureMouse(pTarget);
                this.captureKeyboard(pTarget);
            };
            KeyMap.prototype.captureMouse = function (pTarget) {
                var pKeys = this;
                var fn = function (e) {
                    pKeys.dispatch(e);
                };
                if (pTarget.addEventListener) {
                    pTarget.addEventListener("mousemove", fn, true);
                    pTarget.addEventListener("mouseup", fn, true);
                    pTarget.addEventListener("mousedown", fn, true);
                } else if (pTarget.attachEvent) {
                    pTarget.attachEvent("onmousemove", fn);
                    pTarget.attachEvent("onmouseup", fn);
                    pTarget.attachEvent("onmousedown", fn);
                } else {
                    pTarget.onmousemove = pTarget.onmouseup = pTarget.onmousedown = fn;
                }
            };
            KeyMap.prototype.captureKeyboard = function (pTarget) {
                var pKeys = this;
                var fn = function (e) {
                    pKeys.dispatch(e);
                };
                if (pTarget.addEventListener) {
                    pTarget.addEventListener("keydown", fn, false);
                    pTarget.addEventListener("keyup", fn, false);
                } else if (pTarget.attachEvent) {
                    pTarget.attachEvent("onkeydown", fn);
                    pTarget.attachEvent("onkeyup", fn);
                } else {
                    pTarget.onkeydown = pTarget.onkeyup = fn;
                }
            };
            KeyMap.prototype.dispatch = function (e) {
                if (typeof e === "undefined") { e = window.event; }
                var iCode = (e).keyCode;
                if (e.type == "keydown") {
                    this._pMap[iCode] = true;
                    if (e.altKey) {
                        this._bAlt = true;
                    }
                    if (e.ctrlKey) {
                        this._bCtrl = true;
                    }
                    if (e.shiftKey) {
                        this._bShift = true;
                    }
                } else if (e.type == "keyup") {
                    this._pMap[iCode] = false;
                    if (iCode == akra.EKeyCodes.ALT) {
                        this._bAlt = false;
                    }
                    if (iCode == akra.EKeyCodes.CTRL) {
                        this._bCtrl = false;
                    }
                    if (iCode == akra.EKeyCodes.SHIFT) {
                        this._bShift = false;
                    }
                }
                if (e.type == "mousemove") {
                    this._v2iMousePosition.x = (e).pageX;
                    this._v2iMousePosition.y = (e).pageY;
                } else if (e.type == "mouseup") {
                    this._bMouseDown = false;
                } else if (e.type == "mousedown") {
                    this._bMouseDown = true;
                }
            };
            KeyMap.prototype.isKeyPress = function (iCode) {
                return this._pMap[iCode];
            };
            KeyMap.prototype.getMouse = function () {
                return this._v2iMousePosition;
            };
            KeyMap.prototype.getMouseShift = function () {
                return this._v2iMouseShift.set(this._v2iMousePosition.x - this._v2iMousePrevPosition.x, this._v2iMousePosition.y - this._v2iMousePrevPosition.y);
            };
            KeyMap.prototype.isMouseMoved = function () {
                return this._v2iMousePosition.x != this._v2iMousePrevPosition.x || this._v2iMousePosition.y != this._v2iMousePrevPosition.y;
            };
            KeyMap.prototype.isMousePress = function () {
                return this._bMouseDown;
            };
            KeyMap.prototype.update = function () {
                this._v2iMousePrevPosition.set(this._v2iMousePosition);
            };
            return KeyMap;
        })();        
        function createKeymap(target) {
            return new KeyMap(target);
        }
        controls.createKeymap = createKeymap;
    })(akra.controls || (akra.controls = {}));
    var controls = akra.controls;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EUILayouts) {
        EUILayouts._map = [];
        EUILayouts._map[0] = "UNKNOWN";
        EUILayouts.UNKNOWN = 0;
        EUILayouts._map[1] = "HORIZONTAL";
        EUILayouts.HORIZONTAL = 1;
        EUILayouts._map[2] = "VERTICAL";
        EUILayouts.VERTICAL = 2;
    })(akra.EUILayouts || (akra.EUILayouts = {}));
    var EUILayouts = akra.EUILayouts;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    (function (EUINodeTypes) {
        EUINodeTypes._map = [];
        EUINodeTypes._map[0] = "UNKNOWN";
        EUINodeTypes.UNKNOWN = 0;
        EUINodeTypes._map[1] = "HTML";
        EUINodeTypes.HTML = 1;
        EUINodeTypes._map[2] = "DND";
        EUINodeTypes.DND = 2;
        EUINodeTypes._map[3] = "LAYOUT";
        EUINodeTypes.LAYOUT = 3;
        EUINodeTypes._map[4] = "COMPONENT";
        EUINodeTypes.COMPONENT = 4;
    })(akra.EUINodeTypes || (akra.EUINodeTypes = {}));
    var EUINodeTypes = akra.EUINodeTypes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        ui.$document = $(document);
        ui.$body = $(document.body);
        var Node = (function (_super) {
            __extends(Node, _super);
            function Node(parent, eNodeType) {
                if (typeof eNodeType === "undefined") { eNodeType = akra.EUINodeTypes.UNKNOWN; }
                        _super.call(this, akra.EEntityTypes.UI_NODE);
                this._pUI = parent instanceof ui.UI ? parent : (parent).ui;
                this._eNodeType = eNodeType;
                if (parent instanceof Node) {
                    this.attachToParent(parent);
                }
            }
            Object.defineProperty(Node.prototype, "ui", {
                get: function () {
                    return this._pUI;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Node.prototype, "nodeType", {
                get: function () {
                    return this._eNodeType;
                },
                enumerable: true,
                configurable: true
            });
            Node.prototype.render = function (to) {
                return false;
            };
            Node.prototype.recursiveRender = function () {
                this.render();
                if (this.sibling) {
                    (this.sibling).recursiveRender();
                }
                if (this.child) {
                    (this.child).recursiveRender();
                }
            };
            Node.prototype.renderTarget = function () {
                var pTarget = this.findRenderTarget();
                return ((pTarget) === null) ? null : pTarget.renderTarget();
            };
            Node.prototype.hasRenderTarget = function () {
                return false;
            };
            Node.prototype.addChild = function (pChild) {
                if (this.child) {
                    var pRightSibling = this.child.rightSibling;
                    if (pRightSibling) {
                        pRightSibling.sibling = pChild;
                        this.childAdded(pChild);
                        return pChild;
                    }
                }
                return _super.prototype.addChild.call(this, pChild);
            };
            Node.prototype.attachToParent = function (pParent) {
                if (_super.prototype.attachToParent.call(this, pParent)) {
                    this.relocated(pParent);
                    return true;
                }
                return false;
            };
            Node.prototype.findRenderTarget = function () {
                var pParent = this.parent;
                while(!((pParent) === null)) {
                    if (!((pParent.hasRenderTarget()) === null)) {
                        return pParent;
                    }
                    pParent = pParent.parent;
                }
                return null;
            };
            Node.prototype.relocated = function (pLocation) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).relocated;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pLocation) : _broadcast[i].listener(_recivier, pLocation);
                    }
                }
                ;
                var pNode = this.child;
                while(!((pNode) === null)) {
                    pNode.relocated(pLocation);
                    pNode = pNode.sibling;
                }
            };
            return Node;
        })(akra.util.Entity);
        ui.Node = Node;        
                        function isUI(parent) {
            return parent instanceof ui.UI;
        }
        ui.isUI = isUI;
                        function getUI(parent) {
            return isUI(parent) ? parent : (parent).ui;
        }
        ui.getUI = getUI;
        function isUINode(pEntity) {
            return !((pEntity) === null) && pEntity.type === akra.EEntityTypes.UI_NODE;
        }
        ui.isUINode = isUINode;
        function isLayout(pEntity) {
            return isUINode(pEntity) && (pEntity).nodeType === akra.EUINodeTypes.LAYOUT;
        }
        ui.isLayout = isLayout;
        function containsHTMLElement(pEntity) {
            return isUINode(pEntity) && (pEntity).nodeType >= akra.EUINodeTypes.HTML;
        }
        ui.containsHTMLElement = containsHTMLElement;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var HTMLNode = (function (_super) {
            __extends(HTMLNode, _super);
            function HTMLNode(parent, pElement, eNodeType) {
                if (typeof pElement === "undefined") { pElement = null; }
                if (typeof eNodeType === "undefined") { eNodeType = akra.EUINodeTypes.HTML; }
                        _super.call(this, ui.getUI(parent), eNodeType);
                this.$element = null;
                this._fnEventRedirector = null;
                var pNode = this;
                var fnEventRedirector = this._fnEventRedirector = function (e) {
                    if (HTMLNode.EVENTS.indexOf(e.type) == -1) {
                        return;
                    }
                    return (pNode)[e.type](e);
                };
                this.$element = $(pElement || "<div />");
                if (!ui.isUI(parent)) {
                    this.attachToParent(parent);
                }
            }
            Object.defineProperty(HTMLNode.prototype, "el", {
                get: function () {
                    return this.$element;
                },
                enumerable: true,
                configurable: true
            });
            HTMLNode.prototype.handleEvent = function (sEvent) {
                this.$element.bind(sEvent, this._fnEventRedirector);
                return true;
            };
            HTMLNode.prototype.disableEvent = function (sEvent) {
                this.$element.unbind(sEvent, this._fnEventRedirector);
            };
            HTMLNode.prototype.hasRenderTarget = function () {
                return true;
            };
            HTMLNode.prototype.renderTarget = function () {
                return this.$element;
            };
            HTMLNode.prototype.getHTMLElement = function () {
                return this.$element.get()[0];
            };
            HTMLNode.prototype.render = function (to) {
                var $to = ui.$body;
                var pTarget = null;
                if (!((to) !== undefined)) {
                    pTarget = this.findRenderTarget();
                    $to = ((pTarget) === null) ? $to : pTarget.renderTarget();
                } else {
                    if (to instanceof ui.Node) {
                        if (this.parent != to) {
                            return this.attachToParent(to);
                        }
                        $to = (to).renderTarget();
                    } else {
                        $to = $(to);
                    }
                }
                this.beforeRender();
                $to.append(this.self());
                this.rendered();
                return true;
            };
            HTMLNode.prototype.attachToParent = function (pParent, bRender) {
                if (typeof bRender === "undefined") { bRender = true; }
                if (_super.prototype.attachToParent.call(this, pParent)) {
                    if (bRender && !this.isRendered()) {
                        this.render(pParent);
                    }
                    return true;
                }
                return false;
            };
            HTMLNode.prototype.isFocused = function () {
                return !((this.$element) === null) && this.$element.is(":focus");
            };
            HTMLNode.prototype.isRendered = function () {
                return !((this.$element) === null) && this.$element.parent().length > 0;
            };
            HTMLNode.prototype.destroy = function (bRecursive, bPromoteChildren) {
                _super.prototype.destroy.call(this, bRecursive, bPromoteChildren);
                this.$element.remove();
            };
            HTMLNode.prototype.width = function () {
                return this.$element.width();
            };
            HTMLNode.prototype.height = function () {
                return this.$element.height();
            };
            HTMLNode.prototype.valueOf = function () {
                return this.$element;
            };
            HTMLNode.prototype.hide = function () {
                this.el.hide();
            };
            HTMLNode.prototype.show = function () {
                this.el.show();
            };
            HTMLNode.prototype.self = function () {
                return this.$element;
            };
            HTMLNode.prototype.click = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).click;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.dblclick = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).dblclick;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.mousemove = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).mousemove;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.mouseup = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).mouseup;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.mousedown = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).mousedown;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.mouseover = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).mouseover;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.mouseout = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).mouseout;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.mouseenter = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).mouseenter;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.mouseleave = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).mouseleave;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.focusin = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).focusin;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.focusout = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).focusout;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.blur = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).blur;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.change = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).change;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.keydown = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).keydown;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.keyup = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).keyup;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            HTMLNode.prototype.resize = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).resize;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            HTMLNode.prototype.rendered = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).rendered;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            HTMLNode.prototype.beforeRender = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).beforeRender;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            HTMLNode.EVENTS = [
                "click", 
                "dblclick", 
                "mousemove", 
                "mouseup", 
                "mousedown", 
                "mouseover", 
                "mouseout", 
                "mouseenter", 
                "mouseleave", 
                "focusin", 
                "focusout", 
                "blur", 
                "change", 
                "keydown", 
                "keyup", 
                "resize"
            ];
            return HTMLNode;
        })(ui.Node);
        ui.HTMLNode = HTMLNode;        
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var DNDNode = (function (_super) {
            __extends(DNDNode, _super);
            function DNDNode(parent, element, eNodeType) {
                if (typeof eNodeType === "undefined") { eNodeType = akra.EUINodeTypes.DND; }
                        _super.call(this, ui.getUI(parent), element, eNodeType);
                this._bDraggableInited = false;
                this._bDroppableInited = false;
                if (!ui.isUI(parent)) {
                    this.attachToParent(parent);
                }
            }
            DNDNode.prototype.isDraggable = function () {
                return this._bDraggableInited && !this.$element.draggable("option", "disabled");
            };
            DNDNode.prototype.setDraggable = function (bValue) {
                if (typeof bValue === "undefined") { bValue = true; }
                if (!this._bDraggableInited) {
                    var pNode = this;
                    this.$element.draggable({
                        start: function (e) {
                            return pNode.dragStart(e);
                        },
                        stop: function (e) {
                            return pNode.dragStop(e);
                        },
                        drag: function (e) {
                            return pNode.move(e);
                        }
                    }).draggable("disable");
                    this._bDraggableInited = true;
                }
                if (!((this.parent) === null) && ((this.$element) != null)) {
                    this.$element.draggable("option", "containment", "parent");
                }
                this.$element.draggable("option", "disabled", !bValue);
            };
            DNDNode.prototype.setDroppable = function (bValue) {
                if (typeof bValue === "undefined") { bValue = true; }
                if (!this._bDroppableInited) {
                    var pNode = this;
                    this.$element.droppable({
                        drop: function (e) {
                            return pNode.drop(e);
                        }
                    });
                    this._bDroppableInited = true;
                }
            };
            DNDNode.prototype.attachToParent = function (pParent, bRender) {
                if (typeof bRender === "undefined") { bRender = true; }
                var isAttached = _super.prototype.attachToParent.call(this, pParent, bRender);
                if (this.isDraggable()) {
                    this.setDraggable(true);
                }
                return isAttached;
            };
            DNDNode.prototype.dragStart = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).dragStart;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            DNDNode.prototype.dragStop = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).dragStop;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            DNDNode.prototype.move = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).move;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            DNDNode.prototype.drop = function (e) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).drop;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, e) : _broadcast[i].listener(_recivier, e);
                    }
                }
            };
            return DNDNode;
        })(ui.HTMLNode);
        ui.DNDNode = DNDNode;        
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EUIComponents) {
        EUIComponents._map = [];
        EUIComponents._map[0] = "UNKNOWN";
        EUIComponents.UNKNOWN = 0;
        EUIComponents._map[1] = "WINDOW";
        EUIComponents.WINDOW = 1;
        EUIComponents._map[2] = "BUTTON";
        EUIComponents.BUTTON = 2;
        EUIComponents._map[3] = "SWITCH";
        EUIComponents.SWITCH = 3;
        EUIComponents._map[4] = "PANEL";
        EUIComponents.PANEL = 4;
        EUIComponents._map[5] = "TABS";
        EUIComponents.TABS = 5;
        EUIComponents._map[6] = "LABEL";
        EUIComponents.LABEL = 6;
        EUIComponents._map[7] = "VECTOR";
        EUIComponents.VECTOR = 7;
        EUIComponents._map[8] = "TREE";
        EUIComponents.TREE = 8;
        EUIComponents._map[9] = "TREE_NODE";
        EUIComponents.TREE_NODE = 9;
        EUIComponents._map[10] = "CANVAS";
        EUIComponents.CANVAS = 10;
        EUIComponents._map[11] = "SLIDER";
        EUIComponents.SLIDER = 11;
        EUIComponents._map[12] = "CHECKBOX";
        EUIComponents.CHECKBOX = 12;
        EUIComponents._map[13] = "CHECKBOX_LIST";
        EUIComponents.CHECKBOX_LIST = 13;
        EUIComponents._map[14] = "VIEWPORT_STATS";
        EUIComponents.VIEWPORT_STATS = 14;
        EUIComponents._map[15] = "GRAPH";
        EUIComponents.GRAPH = 15;
        EUIComponents._map[16] = "GRAPH_NODE";
        EUIComponents.GRAPH_NODE = 16;
        EUIComponents._map[17] = "GRAPH_CONNECTOR";
        EUIComponents.GRAPH_CONNECTOR = 17;
        EUIComponents._map[18] = "GRAPH_CONTROLS";
        EUIComponents.GRAPH_CONTROLS = 18;
        EUIComponents._map[19] = "GRAPH_CONNECTIONAREA";
        EUIComponents.GRAPH_CONNECTIONAREA = 19;
    })(akra.EUIComponents || (akra.EUIComponents = {}));
    var EUIComponents = akra.EUIComponents;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (EAjaxDataTypes) {
        EAjaxDataTypes._map = [];
        EAjaxDataTypes._map[0] = "TEXT";
        EAjaxDataTypes.TEXT = 0;
        EAjaxDataTypes._map[1] = "JSON";
        EAjaxDataTypes.JSON = 1;
        EAjaxDataTypes._map[2] = "BLOB";
        EAjaxDataTypes.BLOB = 2;
        EAjaxDataTypes._map[3] = "ARRAY_BUFFER";
        EAjaxDataTypes.ARRAY_BUFFER = 3;
        EAjaxDataTypes._map[4] = "DOCUMENT";
        EAjaxDataTypes.DOCUMENT = 4;
    })(akra.EAjaxDataTypes || (akra.EAjaxDataTypes = {}));
    var EAjaxDataTypes = akra.EAjaxDataTypes;
    (function (EAjaxHttpMethods) {
        EAjaxHttpMethods._map = [];
        EAjaxHttpMethods.GET = 1;
        EAjaxHttpMethods._map[2] = "POST";
        EAjaxHttpMethods.POST = 2;
    })(akra.EAjaxHttpMethods || (akra.EAjaxHttpMethods = {}));
    var EAjaxHttpMethods = akra.EAjaxHttpMethods;
    (function (EAjaxHttpCodes) {
        EAjaxHttpCodes._map = [];
        EAjaxHttpCodes.OK = 200;
        EAjaxHttpCodes._map[201] = "CREATED";
        EAjaxHttpCodes.CREATED = 201;
        EAjaxHttpCodes._map[202] = "ACCEPTED";
        EAjaxHttpCodes.ACCEPTED = 202;
        EAjaxHttpCodes._map[203] = "PARTIAL_INFORMATION";
        EAjaxHttpCodes.PARTIAL_INFORMATION = 203;
        EAjaxHttpCodes.MOVED = 301;
        EAjaxHttpCodes._map[302] = "FOUND";
        EAjaxHttpCodes.FOUND = 302;
        EAjaxHttpCodes._map[303] = "METHOD";
        EAjaxHttpCodes.METHOD = 303;
        EAjaxHttpCodes.NOT_MODIFIED = 304;
        EAjaxHttpCodes.BAD_REQUEST = 400;
        EAjaxHttpCodes._map[401] = "UNAUTHORIZED";
        EAjaxHttpCodes.UNAUTHORIZED = 401;
        EAjaxHttpCodes._map[402] = "PAYMENT_REQUIRED";
        EAjaxHttpCodes.PAYMENT_REQUIRED = 402;
        EAjaxHttpCodes._map[403] = "FORBIDDEN";
        EAjaxHttpCodes.FORBIDDEN = 403;
        EAjaxHttpCodes._map[404] = "NOT_FOUND";
        EAjaxHttpCodes.NOT_FOUND = 404;
        EAjaxHttpCodes.INTERNAL_ERROR = 500;
        EAjaxHttpCodes._map[501] = "NOT_IMPLEMENTED";
        EAjaxHttpCodes.NOT_IMPLEMENTED = 501;
        EAjaxHttpCodes._map[502] = "SERVICE_TEMPORARILY_OVERLOADED";
        EAjaxHttpCodes.SERVICE_TEMPORARILY_OVERLOADED = 502;
        EAjaxHttpCodes._map[503] = "GATEWAY_TIMEOUT";
        EAjaxHttpCodes.GATEWAY_TIMEOUT = 503;
    })(akra.EAjaxHttpCodes || (akra.EAjaxHttpCodes = {}));
    var EAjaxHttpCodes = akra.EAjaxHttpCodes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (io) {
        var pDefaulParams = {
            async: false,
            statusCode: {},
            success: null,
            error: null,
            beforeSend: null,
            data: null,
            cache: false,
            contentType: "application/x-www-form-urlencoded",
            dataType: akra.EAjaxDataTypes.TEXT,
            type: akra.EAjaxHttpMethods.GET,
            timeout: 0
        };
        function stringToHttpMethod(sMethod) {
            sMethod = sMethod.toLowerCase();
            if (sMethod === "get") {
                return akra.EAjaxHttpMethods.GET;
            }
            return akra.EAjaxHttpMethods.POST;
        }
        io.stringToHttpMethod = stringToHttpMethod;
        function stringToAjaxDataType(sDataType) {
            sDataType = sDataType.toLowerCase();
            switch(sDataType) {
                case "json":
                    return akra.EAjaxDataTypes.JSON;
                case "blob":
                    return akra.EAjaxDataTypes.BLOB;
                case "html":
                case "document":
                    return akra.EAjaxDataTypes.DOCUMENT;
                case "array_buffer":
                case "arraybuffer":
                    return akra.EAjaxDataTypes.ARRAY_BUFFER;
            }
            return akra.EAjaxDataTypes.TEXT;
        }
        io.stringToAjaxDataType = stringToAjaxDataType;
        function ajaxDataTypeToXHRResponseType(eDataType) {
            switch(eDataType) {
                case akra.EAjaxDataTypes.BLOB:
                    return "blob";
                case akra.EAjaxDataTypes.ARRAY_BUFFER:
                    return "arraybuffer";
                case akra.EAjaxDataTypes.DOCUMENT:
                    return "document";
                case akra.EAjaxDataTypes.TEXT:
                    return "text";
            }
            return "";
        }
        io.ajaxDataTypeToXHRResponseType = ajaxDataTypeToXHRResponseType;
        function createXMLHttpRequest() {
            if ((window).XMLHttpRequest) {
                return new XMLHttpRequest();
            } else if ((window).ActiveXObject) {
                return new ActiveXObject("Microsoft.XMLHTTP");
            }
            return null;
        }
        io.createXMLHttpRequest = createXMLHttpRequest;
        function queryString(pData, sPrefix) {
            if (typeof sPrefix === "undefined") { sPrefix = null; }
            if ((typeof (pData) === "string")) {
                return pData;
            }
            var pQueryParts = [];
            for(var p in pData) {
                var k = sPrefix ? sPrefix + "[" + p + "]" : p, v = pData[p];
                pQueryParts.push(akra.isObject(v) ? queryString(v, k) : encodeURIComponent(k) + "=" + encodeURIComponent(v));
            }
            return pQueryParts.join("&");
        }
        io.queryString = queryString;
        function convertXHRResponse(pRequest, eType, isAsync) {
            switch(eType) {
                case akra.EAjaxDataTypes.TEXT:
                    return String(pRequest.responseText);
                case akra.EAjaxDataTypes.JSON:
                    return akra.util.parseJSON(pRequest.responseText);
                case akra.EAjaxDataTypes.BLOB:
                    return (isAsync ? pRequest.response : (new (Blob)([
                        pRequest.responseText
                    ], {
                        type: "application/octet-stream"
                    })));
                case akra.EAjaxDataTypes.ARRAY_BUFFER:
                    return (isAsync ? (pRequest.response) : pRequest.responseText);
                case akra.EAjaxDataTypes.DOCUMENT:
                    return (isAsync ? pRequest.response : akra.util.parseHTML(pRequest.responseText));
            }
            return null;
        }
                        function _ajax(pUrl, pSettings, pRequest) {
            var iTimeoutId = 0;
            var isAborted = false;
            var sQueryString;
            var pData;
            var sUrl;
            if ((typeof (arguments[0]) === "string")) {
                sUrl = String(arguments[0]);
                pSettings = arguments[1] || {};
                pRequest = arguments[2];
                pSettings.url = sUrl;
            } else {
                pSettings = arguments[0];
                pRequest = arguments[1];
            }
            pData = pSettings.data || {};
            for(var sKey in pDefaulParams) {
                if (((pSettings[sKey]) !== undefined)) {
                    continue;
                }
                pSettings[sKey] = pDefaulParams[sKey];
            }
            if ((typeof (pSettings.type) === "string")) {
                pSettings.type = stringToHttpMethod(pSettings.type);
            }
            if ((typeof (pSettings.dataType) === "string")) {
                pSettings.dataType = stringToAjaxDataType(pSettings.dataType);
            }
            var fnCauseError = function (pReq, pErr) {
                if (!pSettings.error) {
 {
                        akra.logger.setSourceLocation("io/ajax.ts", 158);
                        akra.logger.error(pErr);
                    }
                    ;
                } else {
                    pSettings.error(pReq, (pReq ? pReq.statusText : null), pErr);
                }
            };
            var fnBeforeResult = function () {
                if (iTimeoutId !== null) {
                    clearTimeout(iTimeoutId);
                }
            };
            pRequest = pRequest || createXMLHttpRequest();
            if (!pRequest) {
                fnCauseError(null, new Error("Invalid request object."));
            }
            if (pSettings.timeout > 0) {
                iTimeoutId = setTimeout(function () {
                    isAborted = true;
                    pRequest.abort();
                    fnCauseError(pRequest, new Error("Timeout is over."));
                }, pSettings.timeout);
            }
            if (pSettings.beforeSend) {
                if (!pSettings.beforeSend(pRequest, pSettings)) {
                    return null;
                }
            }
            if (pSettings.cache) {
                pData["TIMESTAMP"] = akra.now();
            }
            sQueryString = queryString(pData);
            pRequest.onreadystatechange = function () {
                if (isAborted) {
                    return;
                }
                if (pRequest.readyState == this.HEADERS_RECEIVED) {
                    if (pSettings.timeout > 0) {
                        clearTimeout(iTimeoutId);
                    }
                }
                if (pRequest.readyState == this.DONE) {
                    var iStatusCode = pRequest.status;
                    var fnStatusHandler = pSettings.statusCode[iStatusCode];
                    if (((fnStatusHandler) != null)) {
                        fnStatusHandler(pRequest.status);
                    }
                    fnBeforeResult();
                    if (iStatusCode == akra.EAjaxHttpCodes.OK) {
                        if (pSettings.success) {
                            pSettings.success(convertXHRResponse(pRequest, pSettings.dataType, true), pRequest.statusText, pRequest);
                        }
                    } else if (!fnStatusHandler) {
                        fnCauseError(pRequest, new Error("Request is not completed successfully (code: " + iStatusCode + ")"));
                    }
                }
            };
            if (isAborted) {
                return null;
            }
            if (pSettings.async) {
                try  {
                    if (pSettings.type == akra.EAjaxHttpMethods.GET) {
                        pRequest.open("GET", pSettings.url + (sQueryString.length ? "?" + sQueryString : ""), true);
                        pRequest.responseType = ajaxDataTypeToXHRResponseType(pSettings.dataType);
                        pRequest.send(null);
                    } else {
                        pRequest.open("POST", pSettings.url, true);
                        pRequest.setRequestHeader("Content-Type", pSettings.contentType);
                        pRequest.responseType = ajaxDataTypeToXHRResponseType(pSettings.dataType);
                        pRequest.send(sQueryString);
                    }
                } catch (e) {
                    fnCauseError(pRequest, e);
                }
            } else {
                if (pSettings.type == akra.EAjaxHttpMethods.GET) {
                    pRequest.open("GET", pSettings.url + "?" + sQueryString, false);
                    pRequest.send(null);
                } else {
                    pRequest.open("POST", pSettings.url, false);
                    pRequest.setRequestHeader("Content-type", pSettings.contentType);
                    pRequest.send(sQueryString);
                }
                fnBeforeResult();
                return {
                    data: convertXHRResponse(pRequest, pSettings.dataType, false),
                    statusText: pRequest.statusText,
                    xhr: pRequest
                };
            }
            return null;
        }
        io.ajax = _ajax;
    })(akra.io || (akra.io = {}));
    var io = akra.io;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        function _template(pNode, sTemplate, sName, pData, bRenderAsNormal, iDepth) {
            if (typeof pData === "undefined") { pData = null; }
            if (typeof bRenderAsNormal === "undefined") { bRenderAsNormal = false; }
            if (typeof iDepth === "undefined") { iDepth = 0; }
            var fnTemplate = swig.compile(sTemplate, {
                filename: sName
            });
            var sTplData = fnTemplate(pData);
            pNode.el.append(sTplData);
            pNode.el.find("component").each(function (i) {
                var $comp = $(this);
                var sType = $comp.attr("type");
                var sName = $comp.attr("name");
                if ($comp.parent("component").length > 0) {
                    return;
                }
                bRenderAsNormal = pNode.el[0] == $comp.parent()[0];
                var pComponent = pNode.createComponent(sType, {
                    show: bRenderAsNormal,
                    name: sName
                });
                pComponent._createdFrom($comp);
                var $subComp = $comp.find("component:first");
                if ($subComp.length > 0) {
                    _template(pComponent, $comp.html(), sName, pData, false, iDepth + 1);
                }
                if (!bRenderAsNormal) {
                    var $span = $("<span/>");
                    $comp.before($span);
                    pComponent.render($span);
                    pComponent.el.unwrap();
                }
                $comp.remove();
            });
        }
        function template(pNode, sUrl, pData) {
            var sTemplate = akra.io.ajax(sUrl, {
                async: false
            }).data;
            _template(pNode, sTemplate, sUrl, pData);
        }
        ui.template = template;
        ui.COMPONENTS = {};
        var Component = (function (_super) {
            __extends(Component, _super);
            function Component(parent, options, eType, $el) {
                if (typeof eType === "undefined") { eType = akra.EUIComponents.UNKNOWN; }
                        _super.call(this, ui.getUI(parent), $el, akra.EUINodeTypes.COMPONENT);
                this._sGenericType = null;
                var pOptions = mergeOptions(options, null);
                if (!ui.isUI(parent)) {
                    this.attachToParent(parent, (!((pOptions.show) !== undefined) || pOptions.show == true));
                }
                this._eComponentType = eType;
                this.applyOptions(pOptions);
            }
            Object.defineProperty(Component.prototype, "componentType", {
                get: function () {
                    return this._eComponentType;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Component.prototype, "genericType", {
                get: function () {
                    return this._sGenericType;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Component.prototype, "name", {
                get: function () {
                    return this._sName;
                },
                set: function (sName) {
                    this.$element.attr("name", sName);
                    this._sName = sName;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Component.prototype, "layout", {
                get: function () {
                    return ui.isLayout(this.child) ? this.child : null;
                },
                enumerable: true,
                configurable: true
            });
            Component.prototype.template = function (sUrl, pData) {
                template(this, sUrl, pData);
            };
            Component.prototype.rendered = function () {
                _super.prototype.rendered.call(this);
                this.el.addClass("component");
            };
            Component.prototype.isGeneric = function () {
                return !((this._sGenericType) === null);
            };
            Component.prototype.setLayout = function (type) {
                var eType = akra.EUILayouts.UNKNOWN;
                if ((typeof (type) === "string")) {
                    switch((type).toLowerCase()) {
                        case "horizontal":
                            eType = akra.EUILayouts.HORIZONTAL;
                            break;
                        case "vertical":
                            eType = akra.EUILayouts.VERTICAL;
                            break;
                    }
                } else {
                    eType = type;
                }
                var pLayout = this.ui.createLayout(eType);
                if (ui.isLayout(this.child)) {
                    var pLayoutPrev = this.child;
                    pLayoutPrev.relocateChildren(pLayout);
                    pLayoutPrev.destroy();
                }
                this.relocateChildren(pLayout);
                return pLayout.render(this);
            };
            Component.prototype.attachToParent = function (pParent, bRender) {
                if (typeof bRender === "undefined") { bRender = true; }
                if (isComponent(pParent) && ui.isLayout(pParent.child) && !ui.isLayout(pParent)) {
                    pParent = pParent.child;
                }
                return _super.prototype.attachToParent.call(this, pParent, bRender);
            };
            Component.prototype.applyOptions = function (pOptions) {
                if (!((pOptions) != null)) {
                    return;
                }
                var $element = this.el;
                this.name = ((pOptions.name) !== undefined) ? pOptions.name : null;
                if (((pOptions.html) != null)) {
                    $element.html(pOptions.html);
                }
                if (((pOptions.css) != null)) {
 {
                        akra.logger.setSourceLocation("Component.ts", 165);
                        akra.logger.log(pOptions.css);
                    }
                    ;
                    $element.css(pOptions.css);
                }
                if (((pOptions.class) != null)) {
                    $element.addClass(pOptions.class);
                }
                if (((pOptions.width) != null)) {
                    $element.width(pOptions.width);
                }
                if (((pOptions.height) != null)) {
                    $element.height(pOptions.height);
                }
                if (((pOptions.draggable) != null)) {
                    this.setDraggable(pOptions.draggable);
                }
                if (((pOptions.layout) != null)) {
                    this.setLayout(pOptions.layout);
                }
                if ((typeof (pOptions.generic) === "string")) {
                    this._sGenericType = pOptions.generic;
                }
                if (((pOptions.dragZone) != null)) {
                    $element.draggable("option", "containment", pOptions.dragZone);
                }
                if (((pOptions.events) != null)) {
                    if (akra.isArray(pOptions.events)) {
                        pOptions.events = pOptions.events.join(' ');
                    }
                    this.handleEvent(pOptions.events);
                }
                if (((pOptions.parent) != null)) {
                    this.attachToParent(pOptions.parent, ((pOptions.show) != null) ? pOptions.show : true);
                }
            };
            Component.prototype.createComponent = function (sType, pOptions) {
                var pComp = this.ui.createComponent(sType, pOptions);
                pComp.attachToParent(this, !((pOptions) != null) || pOptions.show !== false);
                return pComp;
            };
            Component.prototype._createdFrom = function ($comp) {
                this.$element.attr("style", $comp.attr("style"));
                this.$element.attr("class", $comp.attr("class"));
                var sLayout = $comp.attr("layout");
                if ((typeof (sLayout) === "string")) {
                    this.setLayout(sLayout);
                }
            };
            Component.prototype.toString = function (isRecursive, iDepth) {
                if (typeof isRecursive === "undefined") { isRecursive = false; }
                if (typeof iDepth === "undefined") { iDepth = 0; }
                if (!isRecursive) {
                    return (this.isGeneric() ? "<generic-" + this.genericType : "<component-" + "*") + (this.name ? " " + this.name : "") + ">";
                }
                return _super.prototype.toString.call(this, isRecursive, iDepth);
            };
            return Component;
        })(ui.DNDNode);
        ui.Component = Component;        
        function register(sType, pComponent) {
            ui.COMPONENTS[sType] = pComponent;
        }
        ui.register = register;
        function isComponent(pEntity, eComponent) {
            if (!ui.isUINode(pEntity) || (pEntity).nodeType !== akra.EUINodeTypes.COMPONENT) {
                return false;
            }
            if (arguments.length > 1) {
                return (pEntity).componentType === eComponent;
            }
            return true;
        }
        ui.isComponent = isComponent;
        function isGeneric(pEntity) {
            return isComponent(pEntity) && (pEntity).isGeneric();
        }
        ui.isGeneric = isGeneric;
                                function mergeOptions(left, right) {
            var pOptionsLeft;
            var pOptionsRight;
            if ((typeof (left) === "string")) {
                pOptionsLeft = {
                    name: left
                };
            } else {
                pOptionsLeft = left || {};
            }
            if ((typeof (right) === "string")) {
                pOptionsRight = {
                    name: right
                };
            } else {
                pOptionsRight = right || {};
            }
            for(var sOpt in pOptionsRight) {
                pOptionsLeft[sOpt] = pOptionsRight[sOpt];
            }
            return pOptionsLeft;
        }
        ui.mergeOptions = mergeOptions;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var Panel = (function (_super) {
            __extends(Panel, _super);
            function Panel(parent, options, eType) {
                if (typeof eType === "undefined") { eType = akra.EUIComponents.PANEL; }
                        _super.call(this, parent, ui.mergeOptions({
            layout: akra.EUILayouts.VERTICAL
        }, options), eType, $("<div>						<div class='panel-title'>							<div class=\"controls\">								<input type=\"checkbox\" />							</div>							<span />						</div>					</div>"));
                this.index = -1;
                this.$controls = null;
                this.$title = this.el.find("div.panel-title:first");
                this.$controls = this.el.find("div.controls:first");
                if (((options) != null)) {
                    if ((typeof (options.title) === "string")) {
                        this.title = options.title;
                    }
                }
            }
            Object.defineProperty(Panel.prototype, "title", {
                get: function () {
                    return this.$title.find("span:first").html();
                },
                set: function (sTitle) {
                    this.$title.find("span:first").html(sTitle || "");
                    this.titleUpdated(sTitle);
                },
                enumerable: true,
                configurable: true
            });
            Panel.prototype._createdFrom = function ($comp) {
                _super.prototype._createdFrom.call(this, $comp);
                this.title = $comp.attr('title');
                if ((($comp.attr("collapsible")) !== undefined)) {
                    this.setCollapsible($comp.attr("collapsible").toLowerCase() !== "false");
                }
            };
            Panel.prototype.rendered = function () {
                _super.prototype.rendered.call(this);
                this.el.addClass("component-panel");
            };
            Panel.prototype.isCollapsible = function () {
                return this.el.hasClass("collapsible");
            };
            Panel.prototype.setCollapsible = function (bValue) {
                if (typeof bValue === "undefined") { bValue = true; }
                if (bValue === this.isCollapsible()) {
                    return;
                }
                this.el.addClass("collapsible");
                var $element = this.layout.el;
                this.$controls.click(function (e) {
                    $element.animate({
                        height: 'toggle'
                    }, 500);
                });
            };
            Panel.prototype.titleUpdated = function (sTitle) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).titleUpdated;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, sTitle) : _broadcast[i].listener(_recivier, sTitle);
                    }
                }
            };
            return Panel;
        })(ui.Component);
        ui.Panel = Panel;        
        ui.register("Panel", Panel);
        function isPanel(pEntity) {
            return ui.isComponent(pEntity, akra.EUIComponents.PANEL);
        }
        ui.isPanel = isPanel;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var Tabs = (function (_super) {
            __extends(Tabs, _super);
            function Tabs(parent, options, eType) {
                if (typeof eType === "undefined") { eType = akra.EUIComponents.TABS; }
                        _super.call(this, parent, options, eType, $("<div class=\"component-tabs\"><div class=\"bookmarks\"></div></div>"));
                this._pTabs = [];
                this._iActiveTab = -1;
                this.$bookmarks = this.el.find(".bookmarks:first");
            }
            Object.defineProperty(Tabs.prototype, "active", {
                get: function () {
                    return this._pTabs[this._iActiveTab] || null;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Tabs.prototype, "length", {
                get: function () {
                    return this._pTabs.length;
                },
                enumerable: true,
                configurable: true
            });
            Tabs.prototype.addChild = function (pEntity) {
 {
                    akra.logger.setSourceLocation("Tabs.ts", 30);
                    akra.logger.assert(ui.isPanel(pEntity), "only panels can be added to Tabs");
                }
                ;
                var pPanel = pEntity;
 {
                    akra.logger.setSourceLocation("Tabs.ts", 34);
                    akra.logger.assert(!pPanel.isCollapsible(), "panel cannot be collapsible!");
                }
                ;
                this.createBookmarkFor(pPanel);
                this.connect(pPanel, "titleUpdated", "_tabTitleUpdated");
                pPanel.index = this._pTabs.length;
                this._pTabs.push(pPanel);
                if (this._pTabs.length > 1) {
                    pPanel.hide();
                } else {
                    this.select(0);
                }
                return _super.prototype.addChild.call(this, pEntity);
            };
            Tabs.prototype.tabIndex = function (pPanel) {
                for(var i = 0; i < this._pTabs.length; ++i) {
                    if (pPanel == this._pTabs[i]) {
                        return i;
                    }
                }
                return -1;
            };
            Tabs.prototype.findTabByTitle = function (sName) {
                for(var i = 0; i < this._pTabs.length; ++i) {
                    if (this._pTabs[i].title === sName) {
                        return i;
                    }
                }
                return -1;
            };
            Tabs.prototype.select = function (panel) {
                var n = 0;
                if ((typeof (panel) === "number")) {
                    n = panel;
                } else {
                    n = this.tabIndex(panel);
                }
                if (n == this._iActiveTab || n < 0 || n > this._pTabs.length) {
                    return;
                }
                if (this.active) {
                    this.active.hide();
                    this.bookmarkFor(this.active).removeClass("active");
                }
                this.bookmarkFor(this._pTabs[n]).addClass("active");
                this._pTabs[n].show();
                this._iActiveTab = n;
            };
            Tabs.prototype._tabTitleUpdated = function (pPanel, sTitle) {
                this.bookmarkFor(pPanel).html(sTitle);
            };
            Tabs.prototype.bookmarkFor = function (pPanel) {
                return this.$bookmarks.find("#tab-" + pPanel.getGuid());
            };
            Tabs.prototype.createBookmarkFor = function (pPanel) {
                var $bookmark = $("<div class=\"bookmark\" id=\"tab-" + pPanel.getGuid() + "\">" + pPanel.title + "</div>");
                this.$bookmarks.append($bookmark);
                var pTabs = this;
                $bookmark.click(function (e) {
                    pTabs.select(pPanel.index);
                });
            };
            return Tabs;
        })(ui.Component);
        ui.Tabs = Tabs;        
        ui.register("Tabs", Tabs);
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var Button = (function (_super) {
            __extends(Button, _super);
            function Button(ui, options, eType) {
                if (typeof eType === "undefined") { eType = akra.EUIComponents.BUTTON; }
                        _super.call(this, ui, options, eType, $("<button class=\"component-button\"/>"));
                this.handleEvent("click");
            }
            Object.defineProperty(Button.prototype, "text", {
                get: function () {
                    return this.el.html();
                },
                set: function (x) {
                    this.el.html(x);
                },
                enumerable: true,
                configurable: true
            });
            Button.prototype._createdFrom = function ($comp) {
                _super.prototype._createdFrom.call(this, $comp);
                this.text = $comp.attr("text") || "push";
            };
            Button.prototype.applyOptions = function (pOptions) {
                _super.prototype.applyOptions.call(this, pOptions);
                this.text = pOptions.text || "push";
            };
            return Button;
        })(ui.Component);
        ui.Button = Button;        
        ui.register("Button", Button);
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var Switch = (function (_super) {
            __extends(Switch, _super);
            function Switch(parent, options, eType) {
                if (typeof eType === "undefined") { eType = akra.EUIComponents.SWITCH; }
                var _this = this;
                        _super.call(this, parent, options, eType, $(("<div class=\"component-switch\">" + "<input type=\"checkbox\" id=\"slider-$1\" />" + "<label for=\"slider-$1\"></label>" + "</div>").replace(/\$1/g, ((++/*checked (origin: akra)>>*/akra._total)))));
                this.$checkbox = this.el.find("input[type=checkbox]");
                this.$checkbox.click(function (e) {
                    e.stopPropagation();
                    _this.changed(_this.value);
                });
            }
            Object.defineProperty(Switch.prototype, "value", {
                get: function () {
                    return this.isOn();
                },
                set: function (bValue) {
                    if (bValue != this.value) {
                        this._setValue(bValue);
                        this.changed(bValue);
                    }
                },
                enumerable: true,
                configurable: true
            });
            Switch.prototype._setValue = function (bValue) {
                this.$checkbox.prop('checked', bValue);
            };
            Switch.prototype._createdFrom = function ($comp) {
                _super.prototype._createdFrom.call(this, $comp);
                this.value = (($comp.attr("on")) !== undefined);
            };
            Switch.prototype.isOn = function () {
                return this.$checkbox.is(':checked');
            };
            Switch.prototype.changed = function (bValue) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).changed;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, bValue) : _broadcast[i].listener(_recivier, bValue);
                    }
                }
            };
            return Switch;
        })(ui.Component);
        ui.Switch = Switch;        
        ui.register("Switch", Switch);
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var Label = (function (_super) {
            __extends(Label, _super);
            function Label(ui, options, eType) {
                if (typeof eType === "undefined") { eType = akra.EUIComponents.LABEL; }
                        _super.call(this, ui, options, eType, $("<div>					<div class='label-text'></div>					<input 					onfocus=\"this.style.width = ((this.value.length + 1) * 6) + 'px';\" 					onkeyup=\"this.style.width = ((this.value.length + 1) * 6) + 'px';\" class='label-input' style='display:none;' type='text' value=''/>				</div>"));
                this._bEditable = false;
                this._sPostfix = null;
                this.$text = this.$element.find(".label-text");
                this.$input = this.$element.find(".label-input");
                this.text = akra.isObject(options) ? options.text || "" : "";
                this.editable(akra.isObject(options) ? options.editable || false : false);
            }
            Object.defineProperty(Label.prototype, "text", {
                get: function () {
                    var s = this.$text.html();
                    return s.substr(0, s.length - (this._sPostfix || "").length);
                },
                set: function (x) {
                    this.$text.html(x + (this._sPostfix || ""));
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Label.prototype, "postfix", {
                get: function () {
                    return this._sPostfix;
                },
                set: function (s) {
                    this._sPostfix = s;
                },
                enumerable: true,
                configurable: true
            });
            Label.prototype._createdFrom = function ($comp) {
                _super.prototype._createdFrom.call(this, $comp);
                this.text = $comp.attr("text");
                this.editable((($comp.attr("editable")) !== undefined) || false);
                this.postfix = $comp.attr("postfix");
            };
            Label.prototype.isEditable = function () {
                return this._bEditable;
            };
            Label.prototype.editable = function (bValue) {
                if (typeof bValue === "undefined") { bValue = true; }
                this._bEditable = bValue;
                if (bValue) {
                    this.handleEvent("click keydown focusout");
                    this.el.addClass("editable");
                } else {
                    this.el.removeClass("editable");
                    this.disableEvent("click keydown focusout");
                }
            };
            Label.prototype.rendered = function () {
                _super.prototype.rendered.call(this);
                this.el.addClass("component-label");
            };
            Label.prototype.click = function (e) {
                this.$text.css("display", "none");
                this.$input.val(this.text);
                this.$input.css("display", "inline-block").focus();
                _super.prototype.click.call(this, e);
            };
            Label.prototype.keydown = function (e) {
                if (this.$input.is(":focus")) {
                    if ((e).keyCode == akra.EKeyCodes.ENTER) {
                        this.focusout(e);
                    }
                }
                _super.prototype.keydown.call(this, e);
            };
            Label.prototype.focusout = function (e) {
                var sText = this.$input.val();
                var isChanged = (this.text !== sText);
                this.text = sText;
                this.$text.css("display", "inline-block");
                this.$input.css("display", "none");
                if (isChanged) {
                    this.changed(sText);
                }
                _super.prototype.focusout.call(this, e);
            };
            Label.prototype.changed = function (value) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).changed;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, value) : _broadcast[i].listener(_recivier, value);
                    }
                }
            };
            return Label;
        })(ui.Component);
        ui.Label = Label;        
        ui.register("Label", Label);
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        function prettifyNumber(x) {
            if (x === akra.math.floor(x)) {
                return "" + x + ".";
            }
            return x.toFixed(2);
        }
        var Vector = (function (_super) {
            __extends(Vector, _super);
            function Vector(ui, options, eType) {
                if (typeof eType === "undefined") { eType = akra.EUIComponents.VECTOR; }
                        _super.call(this, ui, options, eType);
                this.totalComponents = 4;
                this._iFixed = 2;
                this._bEditable = false;
                this.template("ui/templates/Vector.tpl");
                this.x = this.findEntity('x');
                this.y = this.findEntity('y');
                this.z = this.findEntity('z');
                this.w = this.findEntity('w');
                this.connect(this.x, "changed", "changed");
                this.connect(this.y, "changed", "changed");
                this.connect(this.z, "changed", "changed");
                this.connect(this.w, "changed", "changed");
                this.setVec4(akra.vec4(0.));
            }
            Object.defineProperty(Vector.prototype, "value", {
                get: function () {
                    switch(this.totalComponents) {
                        case 2:
                            return this.toVec2();
                        case 3:
                            return this.toVec3();
                        case 4:
                            return this.toVec4();
                    }
                    return null;
                },
                enumerable: true,
                configurable: true
            });
            Vector.prototype._createdFrom = function ($comp) {
                var bValue = $comp.attr("editable") || false;
                var sPostfix = $comp.attr("postfix") || null;
                this.x.postfix = sPostfix;
                this.y.postfix = sPostfix;
                this.z.postfix = sPostfix;
                this.w.postfix = sPostfix;
                this.editable(bValue);
            };
            Vector.prototype.editable = function (bValue) {
                if (typeof bValue === "undefined") { bValue = true; }
                if (bValue) {
                    this.el.addClass("editable");
                } else {
                    this.el.removeClass("editable");
                }
                this.x.editable(bValue);
                this.y.editable(bValue);
                this.z.editable(bValue);
                this.w.editable(bValue);
                this._bEditable = bValue;
            };
            Vector.prototype.isEditable = function () {
                return this._bEditable;
            };
            Vector.prototype.changed = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).changed;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, this.value) : _broadcast[i].listener(_recivier, this.value);
                    }
                }
                ;
            };
            Vector.prototype.useComponents = function (n) {
                if (n === this.totalComponents) {
                    return;
                }
                var pSpanList = this.el.find(">span");
                switch(n) {
                    case 2:
                        $(pSpanList[3]).css("display", "none");
                        $(pSpanList[2]).css("display", "none");
                        break;
                    case 3:
                        $(pSpanList[3]).css("display", "none");
                        $(pSpanList[2]).css("display", "inline-block");
                        break;
                    case 4:
                        $(pSpanList[3]).css("display", "inline-block");
                        $(pSpanList[2]).css("display", "inline-block");
                }
                this.totalComponents = n;
            };
            Vector.prototype.setVec2 = function (v) {
                var n = this._iFixed;
                this.x.text = prettifyNumber(v.x);
                this.y.text = prettifyNumber(v.y);
                this.useComponents(2);
            };
            Vector.prototype.setVec3 = function (v) {
                var n = this._iFixed;
                this.x.text = prettifyNumber(v.x);
                this.y.text = prettifyNumber(v.y);
                this.z.text = prettifyNumber(v.z);
                this.useComponents(3);
            };
            Vector.prototype.setVec4 = function (v) {
                var n = this._iFixed;
                this.x.text = prettifyNumber(v.x);
                this.y.text = prettifyNumber(v.y);
                this.z.text = prettifyNumber(v.z);
                this.w.text = prettifyNumber(v.w);
                this.useComponents(4);
            };
            Vector.prototype.toVec2 = function () {
                return akra.vec2(parseFloat(this.x.text), parseFloat(this.y.text));
            };
            Vector.prototype.toVec3 = function () {
                return akra.vec3(parseFloat(this.x.text), parseFloat(this.y.text), parseFloat(this.z.text));
            };
            Vector.prototype.toVec4 = function () {
                return akra.vec4(parseFloat(this.x.text), parseFloat(this.y.text), parseFloat(this.z.text), parseFloat(this.w.text));
            };
            Vector.prototype.rendered = function () {
                _super.prototype.rendered.call(this);
                this.el.addClass("component-vector");
            };
            return Vector;
        })(ui.Component);
        ui.Vector = Vector;        
        ui.register("Vector", Vector);
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var Layout = (function (_super) {
            __extends(Layout, _super);
            function Layout(parent, element, eType) {
                if (typeof element === "undefined") { element = $("<div />"); }
                if (typeof eType === "undefined") { eType = akra.EUILayouts.UNKNOWN; }
                        _super.call(this, parent, element, akra.EUINodeTypes.LAYOUT);
                this._pAttrs = null;
                this._eLayoutType = eType;
            }
            Object.defineProperty(Layout.prototype, "layoutType", {
                get: function () {
                    return this._eLayoutType;
                },
                enumerable: true,
                configurable: true
            });
            Layout.prototype.attachToParent = function (pParent) {
                if (((pParent) === null) || !((pParent.child) === null)) {
                }
                return _super.prototype.attachToParent.call(this, pParent);
            };
            Layout.prototype.attr = function (sAttr) {
                return ((this._pAttrs) === null) ? null : (this._pAttrs)[sAttr];
            };
            Layout.prototype.setAttributes = function (pAttrs) {
                if (((pAttrs) === null)) {
                    return;
                }
                this._pAttrs = pAttrs;
            };
            Layout.prototype.childAdded = function (pChild) {
                _super.prototype.childAdded.call(this, pChild);
            };
            Layout.prototype.toString = function (isRecursive, iDepth) {
                if (typeof isRecursive === "undefined") { isRecursive = false; }
                if (typeof iDepth === "undefined") { iDepth = 0; }
                if (!isRecursive) {
                    return '<layout' + (this.name ? " " + this.name : "") + '>';
                }
                return _super.prototype.toString.call(this, isRecursive, iDepth);
            };
            return Layout;
        })(ui.HTMLNode);
        ui.Layout = Layout;        
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var Horizontal = (function (_super) {
            __extends(Horizontal, _super);
            function Horizontal(parent) {
                        _super.call(this, parent, $("<div class='layout horizontal'><table/></div>"), akra.EUILayouts.HORIZONTAL);
                this.$table = this.$element.find("table:first");
                this.$row = $("<tr />");
                this.$table.append(this.$row);
            }
            Horizontal.prototype.renderTarget = function () {
                var $td = $("<td />");
                this.$row.append($td);
                return $td;
            };
            Horizontal.prototype.removeChild = function (pChild) {
                if (ui.containsHTMLElement(pChild)) {
                    (pChild).$element.parent().remove();
                }
                return _super.prototype.removeChild.call(this, pChild);
            };
            Horizontal.prototype.toString = function (isRecursive, iDepth) {
                if (typeof isRecursive === "undefined") { isRecursive = false; }
                if (typeof iDepth === "undefined") { iDepth = 0; }
                if (!isRecursive) {
                    return '<horizontal' + (this.name ? " " + this.name : "") + '>';
                }
                return _super.prototype.toString.call(this, isRecursive, iDepth);
            };
            return Horizontal;
        })(ui.Layout);
        ui.Horizontal = Horizontal;        
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var Vertical = (function (_super) {
            __extends(Vertical, _super);
            function Vertical(parent) {
                        _super.call(this, parent, $("<div class='layout vertical'><table /></div>"), akra.EUILayouts.VERTICAL);
                this.$table = this.$element.find("table:first");
            }
            Vertical.prototype.renderTarget = function () {
                var $trtd = $("<tr><td /></tr>");
                this.$table.append($trtd);
                return $trtd.find("> td");
            };
            Vertical.prototype.removeChild = function (pChild) {
                if (ui.containsHTMLElement(pChild)) {
                    var $el = (pChild).$element;
                    $el.parent().parent().remove();
                }
                return _super.prototype.removeChild.call(this, pChild);
            };
            Vertical.prototype.toString = function (isRecursive, iDepth) {
                if (typeof isRecursive === "undefined") { isRecursive = false; }
                if (typeof iDepth === "undefined") { iDepth = 0; }
                if (!isRecursive) {
                    return '<vertical' + (this.name ? " " + this.name : "") + '>';
                }
                return _super.prototype.toString.call(this, isRecursive, iDepth);
            };
            return Vertical;
        })(ui.Layout);
        ui.Vertical = Vertical;        
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var Slider = (function (_super) {
            __extends(Slider, _super);
            function Slider(parent, options, eType) {
                if (typeof eType === "undefined") { eType = akra.EUIComponents.SLIDER; }
                        _super.call(this, parent, options, eType);
                this._fRange = 100.0;
                this._fValue = 0.0;
                this.ui.createComponent("pin", {
                    class: "component-pin"
                }).attachToParent(this);
                this.pin.setDraggable();
                this.connect(this.pin, "move", "_updated");
            }
            Object.defineProperty(Slider.prototype, "pin", {
                get: function () {
                    return this.child;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Slider.prototype, "value", {
                get: function () {
                    return this._fValue * this._fRange;
                },
                set: function (fValue) {
                    fValue = (/*checked (origin: math)>>*/akra.math.max((0.), /*checked (origin: math)>>*/akra.math.min((fValue / this._fRange), (1.))));
                    var iElementOffset = this.$element.offset().left;
                    var iPixelTotal = this.$element.width() - this.pin.$element.width();
                    var iPixelCurrent = iPixelTotal * fValue;
                    var iPinOffset = iPixelCurrent + iElementOffset + 1;
                    this.pin.$element.offset({
                        left: iPinOffset
                    });
                    this._fValue = fValue;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Slider.prototype, "range", {
                get: function () {
                    return this._fRange;
                },
                set: function (fValue) {
                    this._fRange = fValue;
                },
                enumerable: true,
                configurable: true
            });
            Slider.prototype.rendered = function () {
                _super.prototype.rendered.call(this);
                this.el.addClass("component-slider");
            };
            Slider.prototype._updated = function (pPin, e) {
                var fValuePrev = this._fValue;
                var fValue;
                var iPinOffset = this.pin.$element.offset().left;
                var iElementOffset = this.$element.offset().left;
                var iPixelTotal = this.$element.width() - this.pin.$element.width();
                var iPixelCurrent = iPinOffset - iElementOffset - 1;
                fValue = this._fValue = (/*checked (origin: math)>>*/akra.math.max((0.), /*checked (origin: math)>>*/akra.math.min((iPixelCurrent / iPixelTotal), (1.))));
                if (fValue != fValuePrev) {
                    this.updated(this.value);
                }
            };
            Slider.prototype.toString = function (isRecursive, iDepth) {
                if (typeof isRecursive === "undefined") { isRecursive = false; }
                if (typeof iDepth === "undefined") { iDepth = 0; }
                if (!isRecursive) {
                    return '<slider' + (this.name ? " " + this.name : "") + '>';
                }
                return _super.prototype.toString.call(this, isRecursive, iDepth);
            };
            Slider.prototype.updated = function (value) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).updated;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, value) : _broadcast[i].listener(_recivier, value);
                    }
                }
            };
            return Slider;
        })(ui.Component);
        ui.Slider = Slider;        
        ui.register("Slider", Slider);
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var Checkbox = (function (_super) {
            __extends(Checkbox, _super);
            function Checkbox(parent, options, eType) {
                if (typeof eType === "undefined") { eType = akra.EUIComponents.CHECKBOX; }
                        _super.call(this, ui.getUI(parent), options, eType, $("<div><span class=\"checkbox-item-text\"></span></div>"));
                this._bChecked = false;
                this.$text = this.$element.find(".checkbox-item-text:first");
                if (((options) != null) && (typeof (options.text) === "string")) {
                    this.text = options.text;
                }
                if (!ui.isUI(parent)) {
                    this.attachToParent(parent);
                }
                this.text = akra.isObject(options) ? options.text || "" : "";
                this.handleEvent("click");
            }
            Object.defineProperty(Checkbox.prototype, "checked", {
                get: function () {
                    return this.isChecked();
                },
                set: function (bValue) {
                    var bPrev = this.isChecked();
                    this._setValue(bValue);
                    if (bValue != bPrev) {
                        this.changed(bValue);
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Checkbox.prototype, "text", {
                get: function () {
                    return this.$text.html();
                },
                set: function (sValue) {
                    this.$text.html(sValue);
                },
                enumerable: true,
                configurable: true
            });
            Checkbox.prototype._setValue = function (bValue) {
                if (bValue) {
                    this.$element.addClass("active");
                } else {
                    this.$element.removeClass("active");
                }
                this._bChecked = bValue;
            };
            Checkbox.prototype._createdFrom = function ($comp) {
                _super.prototype._createdFrom.call(this, $comp);
                this.text = $comp.attr("text");
                if ((($comp.attr("checked")) !== undefined)) {
                    this.checked = true;
                }
                var sImage = $comp.attr("img");
                if ((typeof (sImage) === "string")) {
                    this.$text.before("<img src='" + sImage + "' />");
                }
            };
            Checkbox.prototype.rendered = function () {
                _super.prototype.rendered.call(this);
                this.el.addClass("component-checkbox");
            };
            Checkbox.prototype.isChecked = function () {
                return this._bChecked;
            };
            Checkbox.prototype.click = function (e) {
                this.checked = !this.checked;
                _super.prototype.click.call(this, e);
            };
            Checkbox.prototype.toString = function (isRecursive, iDepth) {
                if (typeof isRecursive === "undefined") { isRecursive = false; }
                if (typeof iDepth === "undefined") { iDepth = 0; }
                if (!isRecursive) {
                    return '<checkbox' + (this.name ? " " + this.name : "") + '>';
                }
                return _super.prototype.toString.call(this, isRecursive, iDepth);
            };
            Checkbox.prototype.changed = function (value) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).changed;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, value) : _broadcast[i].listener(_recivier, value);
                    }
                }
            };
            return Checkbox;
        })(ui.Component);
        ui.Checkbox = Checkbox;        
        function isCheckbox(pEntity) {
            return ui.isComponent(pEntity, akra.EUIComponents.CHECKBOX);
        }
        ui.isCheckbox = isCheckbox;
        ui.register("Checkbox", Checkbox);
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var CheckboxList = (function (_super) {
            __extends(CheckboxList, _super);
            function CheckboxList(parent, options, eType) {
                if (typeof eType === "undefined") { eType = akra.EUIComponents.CHECKBOX_LIST; }
                        _super.call(this, parent, options, eType);
                this._nSize = 0;
                this._pItems = [];
                this._bMultiSelect = false;
                this._bLikeRadio = false;
                this.setLayout(akra.EUILayouts.HORIZONTAL);
                this.connect(this.layout, "childAdded", "_childAdded", akra.EEventTypes.UNICAST);
                this.connect(this.layout, "childRemoved", "_childRemoved", akra.EEventTypes.UNICAST);
                var pChild = this.layout.child;
                while(!((pChild) === null)) {
                    if (ui.isCheckbox(pChild)) {
                        this.addCheckbox(pChild);
                    }
                    pChild = pChild.sibling;
                }
            }
            Object.defineProperty(CheckboxList.prototype, "length", {
                get: function () {
                    return this._nSize;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(CheckboxList.prototype, "radio", {
                get: function () {
                    return this._bLikeRadio;
                },
                set: function (b) {
                    this._bLikeRadio = b;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(CheckboxList.prototype, "items", {
                get: function () {
                    return this._pItems;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(CheckboxList.prototype, "checked", {
                get: function () {
                    for(var i = 0; i < this.items.length; ++i) {
                        if (this.items[i].checked) {
                            return this.items[i];
                        }
                    }
                    return null;
                },
                enumerable: true,
                configurable: true
            });
            CheckboxList.prototype._createdFrom = function ($comp) {
                _super.prototype._createdFrom.call(this, $comp);
                this.radio = (($comp.attr("radio")) !== undefined) && $comp.attr("radio").toLowerCase() !== "false";
                this._bMultiSelect = (($comp.attr("multiselect")) !== undefined) && $comp.attr("multiselect").toLowerCase() !== "false";
            };
            CheckboxList.prototype.rendered = function () {
                _super.prototype.rendered.call(this);
                this.el.addClass("component-checkboxlist");
            };
            CheckboxList.prototype.hasMultiSelect = function () {
                return this._bMultiSelect;
            };
            CheckboxList.prototype.update = function () {
                var pItems = this._pItems;
                if (pItems.length == 0) {
                    return;
                }
                pItems.first.$element.addClass("first");
                for(var i = 0; i < pItems.length - 1; ++i) {
                    pItems[i].$element.removeClass("last");
                }
                ;
                pItems.last.$element.addClass("last");
                return _super.prototype.update.call(this);
            };
            CheckboxList.prototype.addCheckbox = function (pCheckbox) {
                this._pItems.push(pCheckbox);
                this.connect(pCheckbox, "changed", "_changed");
                this.update();
            };
            CheckboxList.prototype._childAdded = function (pLayout, pNode) {
                if (ui.isCheckbox(pNode)) {
                    this.addCheckbox(pNode);
                }
            };
            CheckboxList.prototype._childRemoved = function (pLayout, pNode) {
                if (ui.isCheckbox(pNode)) {
                    var i = this._pItems.indexOf(pNode);
                    if (i != -1) {
                        var pCheckbox = this._pItems[i];
                        this.disconnect(pCheckbox, "changed", "_changed");
                        this._pItems.splice(i, 1);
                        this.update();
                    }
                }
            };
            CheckboxList.prototype._changed = function (pCheckbox, bCheked) {
                if (this.hasMultiSelect()) {
                    this.changed(pCheckbox);
                    return;
                } else {
                    if (!bCheked && this.radio) {
                        pCheckbox.checked = true;
                        return;
                    }
                    var pItems = this._pItems;
                    for(var i = 0; i < pItems.length; ++i) {
                        if (pItems[i] === pCheckbox) {
                            continue;
                        }
                        pItems[i]._setValue(false);
                    }
                    this.changed(pCheckbox);
                }
            };
            CheckboxList.prototype.changed = function (pCheckbox) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).changed;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pCheckbox) : _broadcast[i].listener(_recivier, pCheckbox);
                    }
                }
            };
            return CheckboxList;
        })(ui.Component);
        ui.CheckboxList = CheckboxList;        
        ui.register("CheckboxList", CheckboxList);
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var Window = (function (_super) {
            __extends(Window, _super);
            function Window(pUI, options) {
                        _super.call(this, pUI, options, akra.EUIComponents.WINDOW);
                this._pWindow = window.open("", "", "height=480, width=640", false);
                this.$document = $(this._pWindow.document);
                this.$element = this.$document.find("body");
                this.$document.find("head").append(ui.$document.find("link"));
                this.$element.html("");
            }
            return Window;
        })(ui.Component);
        ui.Window = Window;        
        ui.register("Window", Window);
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var RenderTargetStats = (function (_super) {
            __extends(RenderTargetStats, _super);
            function RenderTargetStats(ui, options, pRenderTarget) {
                        _super.call(this, ui, options, akra.EUIComponents.VIEWPORT_STATS, $("<div class=\"component-fps\" ><div class=\"info\"></div><div class=\"graph\"></div></div>"));
                this._pRenderTarget = null;
                this._pUpdateInterval = -1;
                var $graph = this.el.find(".graph");
                var pInfo = this.el.find(".info").get()[0];
                var pTicks = [];
                var pValues = [];
                var iTotal = 100;
                for(var i = 0; i < iTotal; ++i) {
                    var $tick = $("<span class=\"tick\"/>");
                    $graph.append($tick);
                    pTicks.push($tick.get()[0]);
                    pValues.push(0);
                }
                this._pInfoElement = pInfo;
                this._pValues = pValues;
                this._pTicks = pTicks;
                if (((pRenderTarget) != null)) {
                    this.target = pRenderTarget;
                }
            }
            Object.defineProperty(RenderTargetStats.prototype, "info", {
                get: function () {
                    return this._pInfoElement;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(RenderTargetStats.prototype, "target", {
                get: function () {
                    return this._pRenderTarget;
                },
                set: function (pRenderTarget) {
                    var _this = this;
                    if (!((this._pRenderTarget) === null)) {
                        clearInterval(this._pUpdateInterval);
                    }
                    this._pRenderTarget = pRenderTarget;
                    this._pUpdateInterval = setInterval(/** @inline */function () {
                        _this.updateStats();
                    }, 1000);
                },
                enumerable: true,
                configurable: true
            });
            RenderTargetStats.prototype.updateStats = function () {
                var pTarget = this.target;
                var pStat = pTarget.getStatistics();
                var fFPS = pStat.fps.last;
                var v = this._pValues;
                var iTotal = v.length;
                var iMaxHeight = 27;
                var sFps = fFPS.toFixed(2);
                for(var i = 0, n = iTotal - 1; i < n; ++i) {
                    v[i] = v[i + 1];
                }
                v[n] = fFPS;
                this.info.textContent = "FPS: " + (v[n] < 100 ? (v[n] < 10 ? "  " + sFps : " " + sFps) : sFps);
                var max = akra.math.max.apply(akra.math, v);
                var pTicks = this._pTicks;
                for(var i = 0; i < iTotal; ++i) {
                    pTicks[i].style.height = akra.math.floor(v[i] / max * iMaxHeight) + "px";
                    var fColor = akra.math.min(v[i], 60.) / 60.;
                    pTicks[i].style.backgroundColor = "rgb(" + (akra.math.floor((1 - fColor) * 125) + 125) + ", " + (akra.math.floor(fColor * 125) + 125) + ", 0)";
                }
            };
            RenderTargetStats.prototype.rendered = function () {
                this.el.addClass("component-fps");
            };
            return RenderTargetStats;
        })(ui.Component);
        ui.RenderTargetStats = RenderTargetStats;        
        ui.register("RenderTargetStats", RenderTargetStats);
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var TreeNode = (function () {
            function TreeNode(pTree, pSource) {
                this.el = null;
                this.parent = null;
                this.tree = null;
                this.source = null;
                this.expanded = false;
                this._pNodeMap = {};
                this.$childrenNode = null;
                this.tree = pTree;
                this.source = pSource;
 {
                    akra.logger.setSourceLocation("Tree.ts", 45);
                    akra.logger.assert(!((pSource) === null), "source entity can not be null");
                }
                ;
                var pNode = this;
                this.el = $("<li><label  for=\"" + this.getID() + "\">" + this.sourceName() + "</label></li>");
                this.el.find("label:first").click(function (e) {
                    e.stopPropagation();
                    pNode.select();
                });
                this.tree._link(this);
                this.sync();
            }
            Object.defineProperty(TreeNode.prototype, "totalChildren", {
                get: function () {
                    return Object.keys(this._pNodeMap).length;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(TreeNode.prototype, "selected", {
                get: function () {
                    return this.tree.isSelected(this);
                },
                set: function (bValue) {
                    if (!this.selected && !bValue) {
                        this.el.find("label:first").removeClass("selected");
                    } else if (this.selected && bValue) {
                        this.el.find("label:first").addClass("selected");
                    }
                },
                enumerable: true,
                configurable: true
            });
            TreeNode.prototype.expand = function (bValue) {
                if (typeof bValue === "undefined") { bValue = true; }
                if (this.totalChildren) {
                    this.el.find("input").attr("checked", bValue);
                }
                this.expanded = bValue;
            };
            TreeNode.prototype.select = function (isSelect) {
                if (typeof isSelect === "undefined") { isSelect = true; }
                return this.tree.select(this);
            };
            TreeNode.prototype.getID = function () {
                return "node-guid-" + this.source.getGuid();
            };
            TreeNode.prototype.sync = function (bRecursive) {
                if (typeof bRecursive === "undefined") { bRecursive = true; }
                this.el.find("label:first").html(this.sourceName());
                if (bRecursive) {
                    var pChildren = this.source.children();
                    var pChildMap = {};
                    for(var i = 0; i < pChildren.length; ++i) {
                        var pChild = pChildren[i];
                        pChildMap[pChild.getGuid()] = pChild;
                        if (!this.inChildren(pChild)) {
                            this.addChild(this.tree._createNode(pChild));
                        }
                    }
                    for(var iGuid in this._pNodeMap) {
                        if (!((pChildMap[iGuid]) !== undefined)) {
                            this._pNodeMap[iGuid].destroy();
                        }
                    }
                }
            };
            TreeNode.prototype.synced = function () {
                this.el.find("label:first").removeClass("updating");
            };
            TreeNode.prototype.waitForSync = function () {
                this.el.find("label:first").addClass("updating");
            };
            TreeNode.prototype.removeChildren = function () {
                for(var i in this._pNodeMap) {
                    this._pNodeMap[i].destroy();
                    this._pNodeMap[i] = null;
                }
            };
            TreeNode.prototype.inChildren = function (pNode) {
                return ((this._pNodeMap[pNode.getGuid()]) != null);
            };
            TreeNode.prototype.sourceName = function () {
                return this.source.name ? this.source.name : "<span class=\"unnamed\">[unnamed]</span>";
            };
            TreeNode.prototype.addChild = function (pNode) {
                if (((this.$childrenNode) === null)) {
                    this.el.append("<input " + (this.expanded ? "checked" : "") + " type=\"checkbox\"  id=\"" + this.getID() + "\" />");
                    this.el.removeClass("file");
                    this.$childrenNode = $("<ol />");
                    this.el.append(this.$childrenNode);
                }
                this.$childrenNode.append(pNode.el);
                this._pNodeMap[pNode.source.getGuid()] = pNode;
            };
            TreeNode.prototype.destroy = function () {
                this.removeChildren();
                this.tree._unlink(this);
                this.tree = null;
                this.source = null;
                this.el.remove();
            };
            return TreeNode;
        })();
        ui.TreeNode = TreeNode;        
        var Tree = (function (_super) {
            __extends(Tree, _super);
            function Tree(ui, options, eType) {
                if (typeof eType === "undefined") { eType = akra.EUIComponents.TREE; }
                        _super.call(this, ui, options, eType, $("<ol class='tree'/>"));
                this._pNodeMap = {};
                this._pRootNode = null;
                this._pSelectedNode = null;
            }
            Tree.prototype.fromTree = function (pEntity) {
                if (!((this._pRootNode) === null)) {
 {
                        akra.logger.setSourceLocation("Tree.ts", 160);
                        akra.logger.criticalError("TODO: replace node");
                    }
                    ;
                }
                this._pRootNode = this._createNode(pEntity);
                this._pRootNode.sync();
                this._pRootNode.expand();
                this.el.append(this._pRootNode.el);
                this._pRootNode.select();
            };
            Object.defineProperty(Tree.prototype, "rootNode", {
                get: function () {
                    return this._pRootNode;
                },
                enumerable: true,
                configurable: true
            });
            Tree.prototype.select = function (pNode) {
                var pPrev = this._pSelectedNode;
                this._pSelectedNode = null;
                if (!((pPrev) === null)) {
                    pPrev.selected = false;
                }
                this._pSelectedNode = pNode;
                if (!((this._pSelectedNode) === null)) {
                    this._pSelectedNode.selected = true;
                }
                return true;
            };
            Tree.prototype.isSelected = function (pNode) {
                return this._pSelectedNode === pNode;
            };
            Tree.prototype.rendered = function () {
                _super.prototype.rendered.call(this);
                this.el.addClass("component-tree");
            };
            Tree.prototype._createNode = function (pEntity) {
                var pNode = new TreeNode(this, pEntity);
                return pNode;
            };
            Tree.prototype._link = function (pNode) {
                this._pNodeMap[pNode.source.getGuid()] = pNode;
            };
            Tree.prototype._unlink = function (pNode) {
                this._pNodeMap[pNode.source.getGuid()] = null;
            };
            Tree.prototype.sync = function (pEntity) {
                if (arguments.length && !((pEntity) === null)) {
                    this._pNodeMap[pEntity.getGuid()].sync(false);
                } else {
                    this.rootNode.sync();
                }
            };
            return Tree;
        })(ui.Component);
        ui.Tree = Tree;        
        ui.register("Tree", Tree);
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    (function (EUIGraphNodes) {
        EUIGraphNodes._map = [];
        EUIGraphNodes._map[0] = "UNKNOWN";
        EUIGraphNodes.UNKNOWN = 0;
        EUIGraphNodes._map[1] = "ANIMATION_DATA";
        EUIGraphNodes.ANIMATION_DATA = 1;
        EUIGraphNodes._map[2] = "ANIMATION_PLAYER";
        EUIGraphNodes.ANIMATION_PLAYER = 2;
        EUIGraphNodes._map[3] = "ANIMATION_BLENDER";
        EUIGraphNodes.ANIMATION_BLENDER = 3;
        EUIGraphNodes._map[4] = "ANIMATION_MASK";
        EUIGraphNodes.ANIMATION_MASK = 4;
    })(akra.EUIGraphNodes || (akra.EUIGraphNodes = {}));
    var EUIGraphNodes = akra.EUIGraphNodes;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    ;
    ;
    (function (EUIGraphDirections) {
        EUIGraphDirections._map = [];
        EUIGraphDirections.IN = 0x01;
        EUIGraphDirections.OUT = 0x02;
    })(akra.EUIGraphDirections || (akra.EUIGraphDirections = {}));
    var EUIGraphDirections = akra.EUIGraphDirections;
    (function (EUIGraphTypes) {
        EUIGraphTypes._map = [];
        EUIGraphTypes._map[0] = "UNKNOWN";
        EUIGraphTypes.UNKNOWN = 0;
        EUIGraphTypes._map[1] = "ANIMATION";
        EUIGraphTypes.ANIMATION = 1;
    })(akra.EUIGraphTypes || (akra.EUIGraphTypes = {}));
    var EUIGraphTypes = akra.EUIGraphTypes;
    (function (EUIGraphEvents) {
        EUIGraphEvents._map = [];
        EUIGraphEvents._map[0] = "UNKNOWN";
        EUIGraphEvents.UNKNOWN = 0;
        EUIGraphEvents._map[1] = "DELETE";
        EUIGraphEvents.DELETE = 1;
        EUIGraphEvents._map[2] = "SHOW_MAP";
        EUIGraphEvents.SHOW_MAP = 2;
        EUIGraphEvents._map[3] = "HIDE_MAP";
        EUIGraphEvents.HIDE_MAP = 3;
    })(akra.EUIGraphEvents || (akra.EUIGraphEvents = {}));
    var EUIGraphEvents = akra.EUIGraphEvents;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (graph) {
            var Controls = (function (_super) {
                __extends(Controls, _super);
                function Controls(parent, options, pGraph) {
                    if (typeof pGraph === "undefined") { pGraph = null; }
                                _super.call(this, parent, options);
                    this.controls = this.ui.createComponent("Controls");
                    this.graph = pGraph || this.ui.createComponent("Graph");
                    this.controls.attachToParent(this);
                    this.graph.attachToParent(this);
                    var pControlPanel = this.controls;
                }
                Controls.prototype.createNode = function () {
                    return new graph.Node(this.graph);
                };
                Controls.prototype.rendered = function () {
                    _super.prototype.rendered.call(this);
                    this.el.addClass("component-graphcontrols");
                };
                return Controls;
            })(ui.Panel);
            graph.Controls = Controls;            
            ui.register("GraphControls", Controls);
        })(ui.graph || (ui.graph = {}));
        var graph = ui.graph;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    ;
    (function (EGraphConnectorOrient) {
        EGraphConnectorOrient._map = [];
        EGraphConnectorOrient._map[0] = "UNKNOWN";
        EGraphConnectorOrient.UNKNOWN = 0;
        EGraphConnectorOrient._map[1] = "UP";
        EGraphConnectorOrient.UP = 1;
        EGraphConnectorOrient._map[2] = "DOWN";
        EGraphConnectorOrient.DOWN = 2;
        EGraphConnectorOrient._map[3] = "LEFT";
        EGraphConnectorOrient.LEFT = 3;
        EGraphConnectorOrient._map[4] = "RIGHT";
        EGraphConnectorOrient.RIGHT = 4;
    })(akra.EGraphConnectorOrient || (akra.EGraphConnectorOrient = {}));
    var EGraphConnectorOrient = akra.EGraphConnectorOrient;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (graph) {
            var Connector = (function (_super) {
                __extends(Connector, _super);
                function Connector(parent, options) {
                                _super.call(this, parent, options, akra.EUIComponents.GRAPH_CONNECTOR);
                    this._eOrient = akra.EGraphConnectorOrient.UNKNOWN;
                    this._eDirect = akra.EUIGraphDirections.IN;
                    this._bActive = false;
                    this._pRoute = null;
                    this.handleEvent("mousedown mouseup");
                    this.el.disableSelection();
                }
                Object.defineProperty(Connector.prototype, "orient", {
                    get: function () {
                        return this._eOrient;
                    },
                    set: function (e) {
                        this._eOrient = e;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Connector.prototype, "area", {
                    get: function () {
                        return (this.parent.parent);
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Connector.prototype, "node", {
                    get: function () {
                        return this.area.node;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Connector.prototype, "graph", {
                    get: function () {
                        return this.node.graph;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Connector.prototype, "route", {
                    get: function () {
                        return this._pRoute;
                    },
                    set: function (pRoute) {
                        this._pRoute = pRoute;
                        if (pRoute.isBridge()) {
                            if (this === pRoute.left) {
                                this.output();
                                this.connected(pRoute.right);
                            } else {
                                this.input();
                                this.connected(pRoute.left);
                            }
                        }
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Connector.prototype, "direction", {
                    get: function () {
                        return this._eDirect;
                    },
                    enumerable: true,
                    configurable: true
                });
                Connector.prototype.mousedown = function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!((this.route) === null)) {
                        return;
                    }
                    this.graph.createRouteFrom(this);
                };
                Connector.prototype.mouseup = function (e) {
                    if (this.direction === akra.EUIGraphDirections.IN && !this.isConnected() && this.node.isSuitable()) {
                        e.stopPropagation();
                        this.graph.connectTo(this);
                    }
                };
                Connector.prototype.hasRoute = function () {
                    return !((this.route) === null);
                };
                Connector.prototype.rendered = function () {
                    _super.prototype.rendered.call(this);
                    this.el.addClass("component-graphconnector");
                };
                Connector.prototype.isConnected = function () {
                    return !((this.route) === null) && this.route.isBridge();
                };
                Connector.prototype.isActive = function () {
                    return this._bActive;
                };
                Connector.prototype.activate = function (bValue) {
                    if (typeof bValue === "undefined") { bValue = true; }
                    if (this.isActive() === bValue) {
                        return;
                    }
                    this._bActive = bValue;
                    this.activated(bValue);
                    this.highlight(bValue);
                    this.route.activate(bValue);
                };
                Connector.prototype.sendEvent = function (e) {
                    this.node.sendEvent(e);
                };
                Connector.prototype.input = function () {
                    this.el.addClass("in");
                    this._eDirect = akra.EUIGraphDirections.IN;
                    return true;
                };
                Connector.prototype.output = function () {
                    this.el.addClass("out");
                    this._eDirect = akra.EUIGraphDirections.OUT;
                    return true;
                };
                Connector.prototype.highlight = function (bToggle) {
                    if (typeof bToggle === "undefined") { bToggle = false; }
                    bToggle ? this.$element.addClass("highlight") : this.$element.removeClass("highlight");
                };
                Connector.prototype.routing = function () {
                    this.route.routing();
                };
                Connector.prototype.connected = function (pTarget) {
                    this.el.addClass("connected");
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).connected;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pTarget) : _broadcast[i].listener(_recivier, pTarget);
                        }
                    }
                    ;
                };
                Connector.prototype.activated = function (value) {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).activated;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, value) : _broadcast[i].listener(_recivier, value);
                        }
                    }
                };
                Connector.prototype.routeBreaked = function (pRoute) {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).routeBreaked;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pRoute) : _broadcast[i].listener(_recivier, pRoute);
                        }
                    }
                };
                return Connector;
            })(ui.Component);
            graph.Connector = Connector;            
            ui.register("GraphConnector", Connector);
        })(ui.graph || (ui.graph = {}));
        var graph = ui.graph;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (graph) {
            var MouseConnector = (function (_super) {
                __extends(MouseConnector, _super);
                function MouseConnector(pGraph, options) {
                                _super.call(this, pGraph, options);
                    this.connect(pGraph, "\"mousemove\"", "_onMouseMove");
                    this.setDraggable();
                    this.el.css({
                        "background": "red"
                    });
                }
                MouseConnector.prototype.mousedown = function (e) {
                };
                MouseConnector.prototype._onMouseMove = function (pGraph, e) {
                    var pOffset = this.$element.offset();
                    this.$element.offset({
                        left: e.pageX - pOffset.left,
                        top: e.pageY - pOffset.top
                    });
                };
                return MouseConnector;
            })(graph.Connector);
            graph.MouseConnector = MouseConnector;            
        })(ui.graph || (ui.graph = {}));
        var graph = ui.graph;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (graph) {
            var Route = (function () {
                function Route(pLeft, pRight) {
                    this._pLeft = null;
                    this._pRight = null;
                    this._bActive = false;
                    this._bHighlighted = false;
                    this._pPath = null;
                    this._pArrow = null;
                    this._pInactiveColor = new akra.Color(.0, .0, .0, .75);
                    this._fWeight = 1.;
                    this._fMaxWeight = 1.;
                    this._pLeft = pLeft;
                    this._pRight = pRight;
                    this._pColor = akra.util.randomColor(true);
                    this._pColor.a = .5;
                    if (!((pLeft) === null)) {
                        pLeft.route = this;
                    }
                    if (!((pRight) === null)) {
                        pRight.route = this;
                    }
                }
                Object.defineProperty(Route.prototype, "inactiveColor", {
                    get: function () {
                        return this._pInactiveColor;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Route.prototype, "color", {
                    get: function () {
                        return this._pColor;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Route.prototype, "left", {
                    get: function () {
                        return this._pLeft;
                    },
                    set: function (pConnector) {
                        if (!((this._pLeft) === null)) {
                            this._pLeft.destroy();
                        }
                        this._pLeft = pConnector;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Route.prototype, "right", {
                    get: function () {
                        return this._pRight;
                    },
                    set: function (pConnector) {
                        if (!((this._pRight) === null)) {
                            this._pRight.destroy();
                        }
                        this._pRight = pConnector;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Route.prototype, "weight", {
                    get: function () {
                        return this._fWeight;
                    },
                    set: function (fWeight) {
 {
                            akra.logger.setSourceLocation("Route.ts", 60);
                            akra.logger.log(("\n" + (new Error()).stack.split("\n").slice(1).join("\n")));
                        }
                        this._fWeight = fWeight;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Route.prototype, "arrow", {
                    get: function () {
                        return this._pArrow;
                    },
                    set: function (pPath) {
                        this._pArrow = pPath;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Route.prototype, "path", {
                    get: function () {
                        return this._pPath;
                    },
                    set: function (pPath) {
                        var pRoute = this;
                        (pPath).click(/** @inline */function () {
                            pRoute.activate(!pRoute.isActive());
                        });
                        this._pPath = pPath;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Route.prototype, "canvas", {
                    get: function () {
                        return this.left.graph.canvas;
                    },
                    enumerable: true,
                    configurable: true
                });
                Route.prototype.isConnectedWithNode = function (pNode) {
                    return this.left.node === pNode || this.right.node === pNode;
                };
                Route.prototype.isConnectedWith = function (pConnector) {
                    return this.left === pConnector || this.right === pConnector;
                };
                Route.prototype.isBridge = function () {
                    return !((this.left) === null) && !((this.right) === null);
                };
                Route.prototype.isActive = function () {
                    return this._bActive;
                };
                Route.prototype.detach = function () {
                    this._pLeft = null;
                    this._pRight = null;
                };
                Route.prototype.remove = function (bRecirsive) {
                    if (typeof bRecirsive === "undefined") { bRecirsive = false; }
                    if (!((this.left) === null)) {
                        this.left.routeBreaked(this);
                        bRecirsive && this.left.destroy();
                    }
                    if (!((this.right) === null)) {
                        this.left.routeBreaked(this);
                        bRecirsive && this.right.destroy();
                    }
                    if (!((this.path) === null)) {
                        (this.path).remove();
                        (this.arrow).remove();
                    }
                };
                Route.prototype.sendEvent = function (e) {
                    for(var i = 0; i < e.traversedRoutes.length; ++i) {
                        if (e.traversedRoutes[i] === this) {
                            return;
                        }
                    }
                    e.traversedRoutes.push(this);
                    if (!((this.right) === null)) {
                        this.right.sendEvent(e);
                    }
                    switch(e.type) {
                        case akra.EUIGraphEvents.SHOW_MAP:
                            this._bHighlighted = true;
                            this.left.el.css("backgroundColor", this.color.html);
                            this.right.el.css("backgroundColor", this.color.html);
                            this.routing();
                            break;
                        case akra.EUIGraphEvents.HIDE_MAP:
                            this._bHighlighted = false;
                            this.left.el.css("backgroundColor", "");
                            this.right.el.css("backgroundColor", "");
                            this.routing();
                            break;
                    }
                };
                Route.prototype.destroy = function () {
                    this.remove(false);
                };
                Route.prototype.activate = function (bValue) {
                    if (typeof bValue === "undefined") { bValue = true; }
                    if (this.isActive() === bValue) {
                        return;
                    }
                    this._bActive = bValue;
                    if (!((this.path) === null)) {
                        (this.path).attr({
                            "stroke-width": bValue ? 3 : 2
                        });
                    }
                    this.left && this.left.activate(bValue);
                    this.right && this.right.activate(bValue);
                };
                Route.prototype.routing = function () {
                    var pLeft = Route.calcPosition(this.left);
                    var pRight = Route.calcPosition(this.right);
                    this.drawRoute(pLeft, pRight, this.left.orient, this.right.orient);
                };
                Route.prototype.drawRoute = function (pFrom, pTo, eFromOr, eToOr) {
                    if (typeof eFromOr === "undefined") { eFromOr = akra.EGraphConnectorOrient.UNKNOWN; }
                    if (typeof eToOr === "undefined") { eToOr = akra.EGraphConnectorOrient.UNKNOWN; }
                    var pFromAdd = {
                        x: 0,
                        y: 0
                    };
                    var pToAdd = {
                        x: 0,
                        y: 0
                    };
                    var dY = pTo.y - pFrom.y;
                    var dX = pTo.x - pFrom.x;
                    var isVertF = false;
                    var isVertT = false;
                    if (eFromOr == akra.EGraphConnectorOrient.UP || eFromOr == akra.EGraphConnectorOrient.DOWN) {
                        isVertF = true;
                    }
                    if (eToOr == akra.EGraphConnectorOrient.UP || eToOr == akra.EGraphConnectorOrient.DOWN) {
                        isVertT = true;
                    }
                    if (isVertT != isVertF) {
                        this.drawRoute(pFrom, pTo);
                        return;
                    }
                    if (dY > 0) {
                        if (eFromOr == akra.EGraphConnectorOrient.UP) {
                            pFromAdd.y = dY;
                        }
                        if (eToOr == akra.EGraphConnectorOrient.DOWN) {
                            pToAdd.y = -dY;
                        }
                    }
                    if (dY < 0) {
                        if (eFromOr == akra.EGraphConnectorOrient.DOWN) {
                            pFromAdd.y = -dY;
                        }
                        if (eToOr == akra.EGraphConnectorOrient.UP) {
                            pToAdd.y = dY;
                        }
                    }
                    if (dX > 0) {
                        if (eFromOr == akra.EGraphConnectorOrient.LEFT) {
                            pFromAdd.x = dX;
                        }
                        if (eToOr == akra.EGraphConnectorOrient.RIGHT) {
                            pToAdd.x = -dX;
                        }
                    }
                    if (dX < 0) {
                        if (eFromOr == akra.EGraphConnectorOrient.RIGHT) {
                            pFromAdd.x = -dX;
                        }
                        if (eToOr == akra.EGraphConnectorOrient.LEFT) {
                            pToAdd.x = dX;
                        }
                    }
                    var pPath = [
                        [
                            "M", 
                            pFrom.x, 
                            pFrom.y
                        ], 
                        [
                            "C", 
                            pFrom.x, 
                            pFrom.y, 
                            isVertF ? pFrom.x : ((pFrom.x + pFromAdd.x) * 7 + pTo.x * 3) / 10, 
                            isVertF ? ((pFrom.y + pFromAdd.y) * 7 + pTo.y * 3) / 10 : pFrom.y, 
                            (pFrom.x + pTo.x) / 2, 
                            (pFrom.y + pTo.y) / 2, 
                            (pFrom.x + pTo.x) / 2, 
                            (pFrom.y + pTo.y) / 2, 
                            isVertT ? pTo.x : (pFrom.x * 3 + (pTo.x + pToAdd.x) * 7) / 10, 
                            isVertT ? (pFrom.y * 3 + (pTo.y + pToAdd.y) * 7) / 10 : pTo.y, 
                            pTo.x, 
                            pTo.y, 
                            
                        ]
                    ];
                    var sColor = this._bHighlighted ? this.color.htmlRgba : this.inactiveColor.htmlRgba;
                    var fWeight = this._bHighlighted ? 2. * this._fMaxWeight * this._fWeight : this._fMaxWeight * this._fWeight;
                    sColor = this.isBridge() ? sColor : "rgba(255, 255, 255, 1.)";
                    if (!((this.path) === null)) {
                        (this.path).attr({
                            path: pPath,
                            "stroke": sColor,
                            "stroke-width": fWeight
                        });
                    } else {
                        this.path = ((this.canvas).path(pPath)).attr({
                            "stroke": sColor,
                            "stroke-width": fWeight,
                            "stroke-linecap": "round"
                        });
                    }
                    var iLength = (this.path).getTotalLength();
                    var iArrowHeight = 3;
                    var iArrowWidth = 10;
                    var pCenter = (this.path).getPointAtLength(akra.math.max(iLength - iArrowWidth, 0));
                    var pArrowPos = (this.path).getPointAtLength(akra.math.max(this.isBridge() ? iLength - 5 : iLength, 0));
                    var fAngle = akra.math.HALF_PI + akra.math.atan2(pCenter.x - pTo.x, pTo.y - pCenter.y);
                    var pA0 = {
                        x: (0 - iArrowWidth),
                        y: (0 - iArrowHeight)
                    };
                    var pA1 = {
                        x: (0 - iArrowWidth),
                        y: (0 + iArrowHeight)
                    };
                    var pA0n = {
                        x: pA0.x * akra.math.cos(fAngle) - pA0.y * akra.math.sin(fAngle),
                        y: pA0.x * akra.math.sin(fAngle) + pA0.y * akra.math.cos(fAngle)
                    };
                    var pA1n = {
                        x: pA1.x * akra.math.cos(fAngle) - pA1.y * akra.math.sin(fAngle),
                        y: pA1.x * akra.math.sin(fAngle) + pA1.y * akra.math.cos(fAngle)
                    };
                    var pArrow = [
                        [
                            "M", 
                            pArrowPos.x, 
                            pArrowPos.y
                        ], 
                        [
                            "L", 
                            pArrowPos.x + pA0n.x, 
                            pArrowPos.y + pA0n.y
                        ], 
                        [
                            "L", 
                            pArrowPos.x + pA1n.x, 
                            pArrowPos.y + pA1n.y
                        ], 
                        [
                            "L", 
                            (pArrowPos.x), 
                            (pArrowPos.y)
                        ]
                    ];
                    if (!((this.arrow) === null)) {
                        (this.arrow).attr({
                            path: pArrow,
                            "fill": sColor
                        });
                    } else {
                        this.arrow = (((this.canvas).path(pArrow)).attr({
                            "fill": sColor,
                            "stroke-width": 1
                        }));
                    }
                };
                Route.calcPosition = function calcPosition(pConnector) {
                    var pGraph = pConnector.graph;
                    var pGraphOffset = pGraph.$element.offset();
                    var pPosition = pConnector.$element.offset();
                    var pOut = {
                        x: pPosition.left - pGraphOffset.left,
                        y: pPosition.top - pGraphOffset.top
                    };
                    pOut.x += pConnector.$element.width() / 2.;
                    pOut.y += pConnector.$element.height() / 2.;
                    return pOut;
                };
                return Route;
            })();
            graph.Route = Route;            
            var TempRoute = (function (_super) {
                __extends(TempRoute, _super);
                function TempRoute(pLeft) {
                                _super.call(this, pLeft, null);
                }
                TempRoute.prototype.routing = function (pRight) {
                    if (typeof pRight === "undefined") { pRight = {
                        x: 0,
                        y: 0
                    }; }
                    var pLeft = Route.calcPosition(this.left);
                    this.drawRoute(pLeft, pRight);
                };
                return TempRoute;
            })(Route);
            graph.TempRoute = TempRoute;            
        })(ui.graph || (ui.graph = {}));
        var graph = ui.graph;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (graph) {
            var ConnectionArea = (function (_super) {
                __extends(ConnectionArea, _super);
                function ConnectionArea(parent, options, eType) {
                    if (typeof eType === "undefined") { eType = akra.EUIComponents.GRAPH_CONNECTIONAREA; }
                                _super.call(this, parent, options, eType);
                    this._iMode = akra.EUIGraphDirections.IN | akra.EUIGraphDirections.OUT;
                    this._pConnectors = new Array();
                    this._pTempConnect = null;
                    this._iConnectionLimit = -1;
                    this._iInConnectionLimit = akra.MAX_INT8;
                    this._iOutConnectionLimit = akra.MAX_INT8;
                    this._eConectorOrient = akra.EGraphConnectorOrient.UNKNOWN;
                    if (!((options) === null)) {
                        this._iConnectionLimit = (typeof ((options).maxConnections) === "number") ? options.maxConnections : -1;
                        this._iInConnectionLimit = (typeof ((options).maxInConnections) === "number") ? options.maxInConnections : akra.MAX_INT8;
                        this._iOutConnectionLimit = (typeof ((options).maxOutConnections) === "number") ? options.maxOutConnections : akra.MAX_INT8;
                    }
                    if (this._iConnectionLimit == -1) {
                        this._iConnectionLimit = this._iInConnectionLimit + this._iOutConnectionLimit;
                    }
                    this.el.disableSelection();
                }
                Object.defineProperty(ConnectionArea.prototype, "connectors", {
                    get: function () {
                        return this._pConnectors;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ConnectionArea.prototype, "node", {
                    get: function () {
                        return this.parent;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ConnectionArea.prototype, "graph", {
                    get: function () {
                        return this.node.graph;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ConnectionArea.prototype, "maxInConnections", {
                    set: function (n) {
                        this._iInConnectionLimit = n;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ConnectionArea.prototype, "maxOutConnections", {
                    set: function (n) {
                        this._iOutConnectionLimit = n;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ConnectionArea.prototype, "maxConnections", {
                    set: function (n) {
                        this._iConnectionLimit = n;
                    },
                    enumerable: true,
                    configurable: true
                });
                ConnectionArea.prototype.attachToParent = function (pParent) {
 {
                        akra.logger.setSourceLocation("ConnectionArea.ts", 53);
                        akra.logger.assert(ui.isComponent(pParent, akra.EUIComponents.GRAPH_NODE), "only graph node can be parent!!");
                    }
                    ;
                    if (_super.prototype.attachToParent.call(this, pParent)) {
                        this.connect(this.node, "mouseenter", "_onNodeMouseover");
                        this.connect(this.node, "mouseleave", "_onNodeMouseout");
                    }
                    return false;
                };
                ConnectionArea.prototype._createdFrom = function ($comp) {
                    _super.prototype._createdFrom.call(this, $comp);
                    var sMode = $comp.attr("mode");
                    var sMaxConnections = $comp.attr("connections-limit");
                    var sMaxInConnections = $comp.attr("connections-in-limit");
                    var sMaxOutConnections = $comp.attr("connections-out-limit");
                    var sOrient = $comp.attr("orientation");
                    if ((typeof (sMode) === "string")) {
                        if (sMode === "out") {
                            this.setMode(akra.EUIGraphDirections.OUT);
                        } else if (sMode === "in") {
                            this.setMode(akra.EUIGraphDirections.IN);
                        } else if (sMode === "inout") {
                            this.setMode(akra.EUIGraphDirections.IN | akra.EUIGraphDirections.OUT);
                        }
                    }
                    if ((typeof (sMaxConnections) === "string")) {
                        this.maxConnections = parseInt(sMaxConnections);
                    }
                    if ((typeof (sMaxInConnections) === "string")) {
                        this.maxConnections = parseInt(sMaxInConnections);
                    }
                    if ((typeof (sMaxOutConnections) === "string")) {
                        this.maxConnections = parseInt(sMaxOutConnections);
                    }
                    if ((typeof (sOrient) === "string")) {
                        switch(sOrient.toLowerCase()) {
                            case "up":
                                this._eConectorOrient = akra.EGraphConnectorOrient.UP;
                                break;
                            case "down":
                                this._eConectorOrient = akra.EGraphConnectorOrient.DOWN;
                                break;
                            case "left":
                                this._eConectorOrient = akra.EGraphConnectorOrient.LEFT;
                                break;
                            case "right":
                                this._eConectorOrient = akra.EGraphConnectorOrient.RIGHT;
                                break;
                        }
                    }
                };
                ConnectionArea.prototype.findRoute = function (pNode) {
                    for(var i = 0; i < this._pConnectors.length; ++i) {
                        var pRoute = this._pConnectors[i].route;
                        if (pRoute.isConnectedWithNode(pNode)) {
                            return pRoute;
                        }
                    }
                    return null;
                };
                ConnectionArea.prototype.connectorsCount = function (eDir) {
                    if (arguments.length === 0) {
                        return this._pConnectors.length;
                    }
                    var n = 0;
                    for(var i = 0; i < this._pConnectors.length; ++i) {
                        if (this._pConnectors[i].direction === eDir) {
                            n++;
                        }
                    }
                    return n;
                };
                ConnectionArea.prototype.setMode = function (iMode) {
                    this._iMode = iMode;
                };
                ConnectionArea.prototype.isSupportsIncoming = function () {
                    return this.connectorsCount(akra.EUIGraphDirections.IN) < this._iInConnectionLimit && (((this._iMode) & (akra.EUIGraphDirections.IN)) != 0) && !this.isLimitReached();
                };
                ConnectionArea.prototype.isSupportsOutgoing = function () {
                    return this.connectorsCount(akra.EUIGraphDirections.OUT) < this._iOutConnectionLimit && (((this._iMode) & (akra.EUIGraphDirections.OUT)) != 0) && !this.isLimitReached();
                };
                ConnectionArea.prototype.isLimitReached = function () {
                    return this._pConnectors.length >= this._iConnectionLimit;
                };
                ConnectionArea.prototype.hasConnections = function () {
                    return !(this.connectors.length == 0 || ((this.connectors[0]) === null));
                };
                ConnectionArea.prototype.isActive = function () {
                    return this.node.isActive();
                };
                ConnectionArea.prototype.activate = function (bValue) {
                    if (typeof bValue === "undefined") { bValue = true; }
                    for(var i = 0; i < this._pConnectors.length; ++i) {
                        this._pConnectors[i].activate(bValue);
                    }
                };
                ConnectionArea.prototype.sendEvent = function (e) {
                    for(var i = 0; i < this._pConnectors.length; ++i) {
                        if (this._pConnectors[i].direction === akra.EUIGraphDirections.OUT) {
                            this._pConnectors[i].route.sendEvent(e);
                        }
                    }
                    if (e.type === akra.EUIGraphEvents.DELETE) {
                        if (this.isActive()) {
                            this.destroy();
                        }
                    }
                };
                ConnectionArea.prototype._onNodeMouseover = function (pNode, e) {
                    var pArea = this;
                    setTimeout(/** @inline */function () {
                        pArea.routing();
                    }, 10);
                    if ((!this.isSupportsIncoming() && this.graph.isReadyForConnect()) || (!this.isSupportsOutgoing() && !this.graph.isReadyForConnect())) {
                        return;
                    }
                    if (!((this._pTempConnect) === null)) {
                        return;
                    }
                    var pConnector = this._pTempConnect = new graph.Connector(this);
                    pConnector.orient = this._eConectorOrient;
                    this.connect(pConnector, "routeBreaked", "destroyTempConnect");
                    this.connect(pConnector, "connected", "onConnection");
                };
                ConnectionArea.prototype.onConnection = function (pConnector, pTarget) {
 {
                        akra.logger.setSourceLocation("ConnectionArea.ts", 208);
                        akra.logger.assert(pConnector === this._pTempConnect, "oO!!");
                    }
                    ;
                    this.disconnect(pConnector, "connected", "onConnection");
                    this._pTempConnect = null;
                    this._pConnectors.push(pConnector);
                    this.connected(pConnector, pTarget);
                };
                ConnectionArea.prototype.destroyTempConnect = function () {
                    this._pTempConnect.destroy();
                    this._pTempConnect = null;
                };
                ConnectionArea.prototype._onNodeMouseout = function (pNode, e) {
                    var pArea = this;
                    setTimeout(/** @inline */function () {
                        pArea.routing();
                    }, 10);
                    if (((this._pTempConnect) === null) || this._pTempConnect.hasRoute()) {
                        return;
                    }
                    this.destroyTempConnect();
                };
                ConnectionArea.prototype.routing = function () {
                    for(var i = 0; i < this._pConnectors.length; ++i) {
                        this._pConnectors[i].routing();
                    }
                };
                ConnectionArea.prototype.rendered = function () {
                    _super.prototype.rendered.call(this);
                    this.el.addClass("component-connectionarea");
                };
                ConnectionArea.prototype.connected = function (pFrom, pTo) {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).connected;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pFrom, pTo) : _broadcast[i].listener(_recivier, pFrom, pTo);
                        }
                    }
                };
                return ConnectionArea;
            })(ui.Panel);
            graph.ConnectionArea = ConnectionArea;            
            function isConnectionArea(pEntity) {
                return ui.isComponent(pEntity, akra.EUIComponents.GRAPH_CONNECTIONAREA);
            }
            graph.isConnectionArea = isConnectionArea;
            ui.register("GraphConnectionArea", ConnectionArea);
        })(ui.graph || (ui.graph = {}));
        var graph = ui.graph;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (graph) {
            var Node = (function (_super) {
                __extends(Node, _super);
                function Node(pGraph, options, eType, $el) {
                    if (typeof eType === "undefined") { eType = akra.EUIGraphNodes.UNKNOWN; }
                                _super.call(this, ui.getUI(pGraph), options, akra.EUIComponents.GRAPH_NODE, $el);
                    this._isActive = false;
                    this._pAreas = {};
                    this._isSuitable = true;
                    this._eGraphNodeType = eType;
 {
                        akra.logger.setSourceLocation("../graph/Node.ts", 37);
                        akra.logger.assert(ui.isComponent(pGraph, akra.EUIComponents.GRAPH), "only graph may be as parent", pGraph);
                    }
                    ;
                    this.attachToParent(pGraph);
                    if (!((options) !== undefined) || options.init !== false) {
                        this.template("ui/templates/GraphNode.tpl");
                        this.init();
                    }
                    this.handleEvent("mouseenter mouseleave dblclick click");
                    this.setDraggable();
                    this.$element.css("position", "absolute");
                    this.$element.offset(this.graph.$element.offset());
                    this.connect(pGraph, "connectionBegin", "onConnectionBegin");
                    this.connect(pGraph, "connectionEnd", "onConnectionEnd");
                    this.el.disableSelection();
                }
                Object.defineProperty(Node.prototype, "graphNodeType", {
                    get: function () {
                        return this._eGraphNodeType;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Node.prototype, "graph", {
                    get: function () {
                        return this.parent;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Node.prototype, "areas", {
                    get: function () {
                        return this._pAreas;
                    },
                    enumerable: true,
                    configurable: true
                });
                Node.prototype.onConnectionEnd = function (pGraph) {
                    this._isSuitable = false;
                    this.el.removeClass("open blocked");
                    this.routing();
                };
                Node.prototype.onConnectionBegin = function (pGraph, pRoute) {
                    if (pRoute.left.node === this) {
                        return;
                    }
                    if (!this.canAcceptConnect()) {
                        this.el.addClass("blocked");
                        return;
                    }
                    this._isSuitable = true;
                    this.el.addClass("open");
                };
                Node.prototype.linkAreas = function () {
                    var pChildren = this.children();
                    for(var i = 0; i < pChildren.length; ++i) {
                        if (graph.isConnectionArea(pChildren[i])) {
                            this.addConnectionArea(pChildren[i].name, pChildren[i]);
                        }
                    }
                };
                Node.prototype.isSuitable = function () {
                    return this._isSuitable;
                };
                Node.prototype.findRoute = function (pNode) {
                    var pRoute = null;
                    for(var i in this._pAreas) {
                        pRoute = this._pAreas[i].findRoute(pNode);
                        if (!((pRoute) === null)) {
                            return pRoute;
                        }
                    }
                    return null;
                };
                Node.prototype.isConnectedWith = function (pNode) {
                    return !((this.findRoute(pNode)) === null);
                };
                Node.prototype.canAcceptConnect = function () {
                    for(var i in this._pAreas) {
                        if (this._pAreas[i].isSupportsIncoming()) {
                            return true;
                        }
                    }
                    return false;
                };
                Node.prototype.mouseenter = function (e) {
                    _super.prototype.mouseenter.call(this, e);
                    this.sendEvent(graph.Graph.event(akra.EUIGraphEvents.SHOW_MAP));
                };
                Node.prototype.mouseleave = function (e) {
                    _super.prototype.mouseleave.call(this, e);
                    this.sendEvent(graph.Graph.event(akra.EUIGraphEvents.HIDE_MAP));
                };
                Node.prototype.rendered = function () {
                    _super.prototype.rendered.call(this);
                    this.el.addClass("component-graphnode");
                };
                Node.prototype.move = function (e) {
                    this.routing();
                };
                Node.prototype.dblclick = function (e) {
                    this.activate(!this.isActive());
                };
                Node.prototype.activate = function (bValue) {
                    if (typeof bValue === "undefined") { bValue = true; }
                    this._isActive = bValue;
                    this.highlight(bValue);
                    for(var sArea in this._pAreas) {
                        this._pAreas[sArea].activate(bValue);
                    }
                };
                Node.prototype.isActive = function () {
                    return this._isActive;
                };
                Node.prototype.init = function () {
                    var pSidesLR = [
                        "left", 
                        "right"
                    ];
                    var pSidesTB = [
                        "top", 
                        "bottom"
                    ];
                    var pSidePanels = [];
                    for(var i = 0; i < pSidesTB.length; ++i) {
                        var sSide = pSidesTB[i];
                        pSidePanels[i] = new graph.ConnectionArea(this, {
                            show: false
                        });
                        pSidePanels[i].setLayout(akra.EUILayouts.HORIZONTAL);
                        pSidePanels[i].render(this.el.find(".graph-node-" + sSide + ":first"));
                        this._pAreas[sSide] = pSidePanels[i];
                    }
                    for(var i = 0; i < pSidesLR.length; ++i) {
                        var sSide = pSidesLR[i];
                        pSidePanels[i] = new graph.ConnectionArea(this, {
                            show: false
                        });
                        pSidePanels[i].render(this.el.find(".graph-node-" + sSide + ":first"));
                        this.addConnectionArea(sSide, pSidePanels[i]);
                    }
                };
                Node.prototype.addConnectionArea = function (sName, pArea) {
                    this.connect(pArea, "connected", "connected");
                    this._pAreas[sName] = pArea;
                };
                Node.prototype.connected = function (pArea, pFrom, pTo) {
                };
                Node.prototype.sendEvent = function (e) {
                    for(var i in this._pAreas) {
                        this._pAreas[i].sendEvent(e);
                    }
                    if (e.type === akra.EUIGraphEvents.DELETE) {
                        if (this.isActive()) {
                            this.beforeDestroy(this);
                            this.destroy();
                        }
                    }
                };
                Node.prototype.highlight = function (bValue) {
                    if (typeof bValue === "undefined") { bValue = true; }
                    if (bValue) {
                        this.$element.addClass('highlight');
                    } else {
                        this.$element.removeClass('highlight');
                    }
                };
                Node.prototype.routing = function () {
                    for(var i in this._pAreas) {
                        this._pAreas[i].routing();
                    }
                };
                Node.prototype.beforeDestroy = function (node) {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).beforeDestroy;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, node) : _broadcast[i].listener(_recivier, node);
                        }
                    }
                };
                return Node;
            })(ui.Component);
            graph.Node = Node;            
            ui.register("GraphNode", Node);
        })(ui.graph || (ui.graph = {}));
        var graph = ui.graph;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (animation) {
            var Node = (function (_super) {
                __extends(Node, _super);
                function Node(parent, options, eType) {
                    if (typeof eType === "undefined") { eType = akra.EUIGraphNodes.UNKNOWN; }
                                _super.call(this, parent, options, eType);
                }
                Node.prototype.attachToParent = function (pParent) {
                    if (_super.prototype.attachToParent.call(this, pParent)) {
                        this.connect(pParent, "nodeSelected", "_selected");
                    }
                    return false;
                };
                Node.prototype._selected = function (pGraph, pNode, bPlay) {
                    if (this === pNode) {
                        this.el.addClass("selected");
                    } else {
                        this.el.removeClass("selected");
                    }
                };
                Object.defineProperty(Node.prototype, "animation", {
                    get: function () {
                        return null;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Node.prototype, "graph", {
                    get: function () {
                        return this.parent;
                    },
                    enumerable: true,
                    configurable: true
                });
                Node.prototype.connected = function (pArea, pFrom, pTo) {
                    if (pFrom.direction === akra.EUIGraphDirections.IN) {
                        this.animation = (pTo.node).animation;
                    }
                };
                return Node;
            })(ui.graph.Node);
            animation.Node = Node;            
        })(ui.animation || (ui.animation = {}));
        var animation = ui.animation;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (animation) {
            var Data = (function (_super) {
                __extends(Data, _super);
                function Data(pGraph, pAnim) {
                    if (typeof pAnim === "undefined") { pAnim = null; }
                                _super.call(this, pGraph, {
                init: false
            }, akra.EUIGraphNodes.ANIMATION_DATA);
                    this._pAnimation = null;
                    this.template("ui/templates/AnimationData.tpl");
                    if (!((pAnim) === null)) {
                        this.animation = pAnim;
                    }
                    this.linkAreas();
                }
                Object.defineProperty(Data.prototype, "animation", {
                    get: function () {
                        return this._pAnimation;
                    },
                    set: function (pAnim) {
                        this._pAnimation = pAnim;
                        (this.child).text = pAnim.name;
                    },
                    enumerable: true,
                    configurable: true
                });
                Data.prototype.rendered = function () {
                    _super.prototype.rendered.call(this);
                    this.el.addClass("component-animationdata");
                };
                return Data;
            })(animation.Node);
            animation.Data = Data;            
            ui.register("AnimationData", Data);
        })(ui.animation || (ui.animation = {}));
        var animation = ui.animation;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (animation) {
        var Container = (function (_super) {
            __extends(Container, _super);
            function Container(pAnimation, sName) {
                        _super.call(this, akra.EAnimationTypes.CONTAINER, sName);
                this._bEnable = true;
                this._fStartTime = 0;
                this._fSpeed = 1.0;
                this._bLoop = false;
                this._pAnimation = null;
                this._bReverse = false;
                this._fTrueTime = 0;
                this._fRealTime = 0;
                this._fTime = 0;
                this._bPause = false;
                this._bLeftInfinity = true;
                this._bRightInfinity = true;
                if (pAnimation) {
                    this.setAnimation(pAnimation);
                }
            }
            Object.defineProperty(Container.prototype, "animationName", {
                get: function () {
                    return this._pAnimation.name;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Container.prototype, "speed", {
                get: function () {
                    return this._fSpeed;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Container.prototype, "animationTime", {
                get: function () {
                    return this._fTrueTime;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Container.prototype, "time", {
                get: function () {
                    return this._fTime;
                },
                enumerable: true,
                configurable: true
            });
            Container.prototype.play = function (fRealTime) {
                this._fRealTime = fRealTime;
                this._fTime = 0;
                this.played(this._fTime);
            };
            Container.prototype.stop = function () {
                this.stoped(this._fTime);
            };
            Container.prototype.attach = function (pTarget) {
                this._pAnimation.attach(pTarget);
                this.grab(this._pAnimation, true);
            };
            Container.prototype.setAnimation = function (pAnimation) {
 {
                    akra.logger.setSourceLocation("animation/Container.ts", 73);
                    akra.logger.assert(!this._pAnimation, "anim. already exists");
                }
                ;
                this._pAnimation = pAnimation;
                this.setSpeed(this.speed);
                this.connect(pAnimation, "durationUpdated", "_onDurationUpdate");
                this.grab(pAnimation);
            };
            Container.prototype._onDurationUpdate = function (pAnimation, fDuration) {
                this.setSpeed(this.speed);
            };
            Container.prototype.getAnimation = function () {
                return this._pAnimation;
            };
            Container.prototype.enable = function () {
                this._bEnable = true;
            };
            Container.prototype.disable = function () {
                this._bEnable = false;
            };
            Container.prototype.isEnabled = function () {
                return this._bEnable;
            };
            Container.prototype.leftInfinity = function (bValue) {
                this._bLeftInfinity = bValue;
            };
            Container.prototype.inLeftInfinity = function () {
                return this._bLeftInfinity;
            };
            Container.prototype.inRightInfinity = function () {
                return this._bRightInfinity;
            };
            Container.prototype.rightInfinity = function (bValue) {
                this._bRightInfinity = bValue;
            };
            Container.prototype.setStartTime = function (fRealTime) {
                this._fStartTime = fRealTime;
            };
            Container.prototype.getStartTime = function () {
                return this._fStartTime;
            };
            Container.prototype.setSpeed = function (fSpeed) {
                this._fSpeed = fSpeed;
                this.duration = this._pAnimation.duration / fSpeed;
                this.durationUpdated(this.duration);
            };
            Container.prototype.getSpeed = function () {
                return this._fSpeed;
            };
            Container.prototype.useLoop = function (bValue) {
                this._bLoop = bValue;
            };
            Container.prototype.inLoop = function () {
                return this._bLoop;
            };
            Container.prototype.reverse = function (bValue) {
                this._bReverse = bValue;
            };
            Container.prototype.isReversed = function () {
                return this._bReverse;
            };
            Container.prototype.pause = function (bValue) {
                if (typeof bValue === "undefined") { bValue = true; }
                this._fRealTime = -1;
                this._bPause = bValue;
            };
            Container.prototype.rewind = function (fRealTime) {
                this._fTime = fRealTime;
            };
            Container.prototype.isPaused = function () {
                return this._bPause;
            };
            Container.prototype.calcTime = function (fRealTime) {
                if (this._bPause) {
                    return;
                }
                if (this._fRealTime < 0) {
                    this._fRealTime = fRealTime;
                }
                this._fTime = this._fTime + (fRealTime - this._fRealTime) * this._fSpeed;
                this._fRealTime = fRealTime;
                var fTime = this._fTime;
                if (this._bLoop) {
                    fTime = (((fTime) - /*checked (origin: math)>>*/akra.math.floor((fTime) / ((this._pAnimation.duration))) * ((this._pAnimation.duration))));
                    if (this._bReverse) {
                        fTime = this._pAnimation.duration - fTime;
                    }
                }
                this._fTrueTime = fTime;
            };
            Container.prototype.frame = function (sName, fRealTime) {
                if (!this._bEnable) {
                    return null;
                }
                if (this._fRealTime !== fRealTime) {
                    this.calcTime(fRealTime);
                    this.enterFrame(fRealTime, this._fTrueTime);
                }
                if (!this._bLeftInfinity && this._fRealTime < this._fStartTime) {
                    return null;
                }
                if (!this._bRightInfinity && this._fRealTime > this.duration + this._fStartTime) {
                    return null;
                }
                return this._pAnimation.frame(sName, this._fTrueTime);
            };
            Container.prototype.durationUpdated = function (fDuration) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).durationUpdated;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, fDuration) : _broadcast[i].listener(_recivier, fDuration);
                    }
                }
            };
            Container.prototype.enterFrame = function (fRealTime, fTime) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).enterFrame;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, fRealTime, fTime) : _broadcast[i].listener(_recivier, fRealTime, fTime);
                    }
                }
            };
            return Container;
        })(animation.Base);
        animation.Container = Container;        
        function isContainer(pAnimation) {
            return pAnimation.type === akra.EAnimationTypes.CONTAINER;
        }
        animation.isContainer = isContainer;
        function createContainer(pAnimation, sName) {
            return new Container(pAnimation, sName);
        }
        animation.createContainer = createContainer;
    })(akra.animation || (akra.animation = {}));
    var animation = akra.animation;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (animation) {
            var Player = (function (_super) {
                __extends(Player, _super);
                function Player(pGraph, pContainer) {
                    if (typeof pContainer === "undefined") { pContainer = null; }
                                _super.call(this, pGraph, {
                init: false
            }, akra.EUIGraphNodes.ANIMATION_PLAYER);
                    this._pAnimation = null;
                    this.template("ui/templates/AnimationPlayer.tpl");
                    this.linkAreas();
                    this._pSpeedLabel = this.findEntity("speed");
                    this._pSlider = this.findEntity("state");
                    this._pPlayBtn = this.findEntity("play");
                    this._pLoopBtn = this.findEntity("loop");
                    this._pReverseBtn = this.findEntity("reverse");
                    this._pLeftInf = this.findEntity("left-inf");
                    this._pRightInf = this.findEntity("right-inf");
                    this._pNameLabel = this.findEntity("name");
                    this._pAnimation = pContainer = pContainer || akra.animation.createContainer();
                    this.graph.addAnimation(pContainer);
                    this.connect(pContainer, "enterFrame", "_enterFrame");
                    this.connect(pContainer, "durationUpdated", "_durationUpdated");
                    this.connect(this._pLoopBtn, "changed", "_useLoop");
                    this.connect(this._pReverseBtn, "changed", "_reverse");
                    this.connect(this._pPlayBtn, "changed", "_play");
                    this.connect(this._pSpeedLabel, "changed", "_setSpeed");
                    this.connect(this._pNameLabel, "changed", "_setName");
                    this.connect(this._pLeftInf, "changed", "_setLeftInf");
                    this.connect(this._pRightInf, "changed", "_setRightInf");
                    this.$time = this.el.find(".time:first");
                    this.setup();
                }
                Object.defineProperty(Player.prototype, "animation", {
                    get: function () {
                        return this._pAnimation;
                    },
                    set: function (pAnim) {
                        this._pAnimation.setAnimation(pAnim);
                        this.setup();
                    },
                    enumerable: true,
                    configurable: true
                });
                Player.prototype.onConnectionBegin = function (pGraph, pRoute) {
                    if (!((this._pAnimation.getAnimation()) === null)) {
                        this.el.addClass("blocked");
                    } else {
                        _super.prototype.onConnectionBegin.call(this, pGraph, pRoute);
                    }
                };
                Player.prototype.setup = function () {
                    var pAnimation = this._pAnimation;
                    this._pSlider.range = pAnimation.duration;
                    this._pPlayBtn.checked = !pAnimation.isPaused();
                    this._pLoopBtn.checked = pAnimation.inLoop();
                    this._pReverseBtn.checked = pAnimation.isReversed();
                    this._pNameLabel.text = pAnimation.name;
                    this._pSpeedLabel.text = pAnimation.speed.toString();
                    this._pLeftInf.checked = pAnimation.inLeftInfinity();
                    this._pRightInf.checked = pAnimation.inRightInfinity();
                };
                Player.prototype._setLeftInf = function (pCheckbox, bValue) {
                    this._pAnimation.leftInfinity(bValue);
                };
                Player.prototype._setRightInf = function (pCheckbox, bValue) {
                    this._pAnimation.rightInfinity(bValue);
                };
                Player.prototype._reverse = function (pCheckbox, bValue) {
                    this._pAnimation.reverse(bValue);
                };
                Player.prototype._useLoop = function (pCheckbox, bValue) {
                    this._pAnimation.useLoop(bValue);
                };
                Player.prototype._pause = function (pCheckbox, bValue) {
                    this._pAnimation.pause(bValue);
                };
                Player.prototype._play = function (pCheckbox, bValue) {
                    this._pAnimation.pause(!bValue);
                };
                Player.prototype._setName = function (pLabel, sName) {
                    this._pAnimation.name = sName;
                };
                Player.prototype._setSpeed = function (pLabel, x) {
                    this._pAnimation.setSpeed(parseFloat(x));
                };
                Player.prototype._durationUpdated = function (pContainer, fDuration) {
                    this._pSlider.range = fDuration;
                };
                Player.prototype._enterFrame = function (pContainer, fRealTime, fTime) {
                    if (this._pAnimation.isPaused()) {
                    } else {
                        if (this._pAnimation.inLoop()) {
                            this._pSlider.value = ((((fRealTime - this._pAnimation.getStartTime())) - /*checked (origin: math)>>*/akra.math.floor(((fRealTime - this._pAnimation.getStartTime())) / (this._pAnimation.duration)) * (this._pAnimation.duration)));
                        } else if (fRealTime >= this._pAnimation.getStartTime()) {
                            this._pSlider.value = (akra.math.min(fRealTime, this._pAnimation.duration) - this._pAnimation.getStartTime());
                        }
                        this.$time.text(fTime.toFixed(2));
                    }
                };
                Player.prototype.rendered = function () {
                    _super.prototype.rendered.call(this);
                    this.el.addClass("component-animationplayer");
                };
                return Player;
            })(animation.Node);
            animation.Player = Player;            
            ui.register("AnimationPlayer", Player);
        })(ui.animation || (ui.animation = {}));
        var animation = ui.animation;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (animation) {
            var Mask = (function (_super) {
                __extends(Mask, _super);
                function Mask(pGraph) {
                                _super.call(this, pGraph, {
                init: false
            }, akra.EUIGraphNodes.ANIMATION_MASK);
                    this._pAnimation = null;
                    this._pMask = null;
                    this._pSliders = [];
                    this._pViewBtn = null;
                    ui.template(this, "ui/templates/AnimationMask.tpl");
                    this.init();
                }
                Object.defineProperty(Mask.prototype, "animation", {
                    get: function () {
                        return this._pAnimation;
                    },
                    set: function (pAnim) {
                        this._pAnimation = pAnim;
                    },
                    enumerable: true,
                    configurable: true
                });
                Mask.prototype.init = function () {
                    var pArea = new ui.graph.ConnectionArea(this, {
                        show: false,
                        maxInConnections: 1
                    });
                    pArea.setMode(akra.EUIGraphDirections.OUT | akra.EUIGraphDirections.IN);
                    pArea.setLayout(akra.EUILayouts.HORIZONTAL);
                    pArea.render(this.el);
                    this.addConnectionArea("out", pArea);
                };
                Mask.prototype.rendered = function () {
                    _super.prototype.rendered.call(this);
                    this.el.addClass("component-animationmask");
                };
                Mask.prototype.create = function (pMask, pAnimation) {
                    if (typeof pMask === "undefined") { pMask = null; }
                    if (typeof pAnimation === "undefined") { pAnimation = null; }
                    if (((pAnimation) === null)) {
                        pAnimation = this._pAnimation;
                    }
                    if (((pMask) === null)) {
                        pMask = pAnimation.createAnimationMask();
                    }
                    var $location = this.$element.find(".controls:first");
                    var pSliders = this._pSliders;
                    var pViewBtn = new ui.Button(this, {
                        text: "view mask"
                    });
                    var pParent = this;
                    $location.append(pViewBtn.$element);
                    var fnViewHide = function (pBtn, e) {
                        for(var i = 0; i < pSliders.length; ++i) {
                            var $el = pSliders[i].$element;
                            $el.is(":visible") ? $el.hide() : $el.show();
                        }
                    };
                    var fnCreate = function (pBtn, e) {
                        for(var sTarget in pMask) {
                            pSliders.push(Mask.createSlider(pParent, $location, pMask, sTarget));
                        }
                        pViewBtn.unbind("click", fnCreate);
                        pViewBtn.bind("click", fnViewHide);
                        pViewBtn.text = "hide/view";
                    };
                    pViewBtn.bind("click", fnCreate);
                    this._pViewBtn = pViewBtn;
                    this._pMask = pMask;
                };
                Mask.prototype.getMask = function () {
                    if (((this._pAnimation) === null)) {
                        return null;
                    }
                    if (((this._pMask) === null)) {
                        this.create();
                    }
                    return this._pMask;
                };
                Mask.createSlider = function createSlider(pParent, $location, pMask, sName) {
                    var pSlider;
                    pSlider = new ui.Slider(pParent, {
                        show: false
                    });
                    pSlider.render($location);
                    pSlider.range = 10;
                    pSlider.value = pMask[sName];
                    pSlider.bind("updated", function (pSlider, fValue) {
                        pMask[sName] = fValue;
                    });
                    return pSlider;
                };
                return Mask;
            })(animation.Node);
            animation.Mask = Mask;            
            ui.register("AnimationMask", Mask);
        })(ui.animation || (ui.animation = {}));
        var animation = ui.animation;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (animation) {
            var Blender = (function (_super) {
                __extends(Blender, _super);
                function Blender(pGraph, pBlender) {
                    if (typeof pBlender === "undefined") { pBlender = null; }
                                _super.call(this, pGraph, {
                init: false
            }, akra.EUIGraphNodes.ANIMATION_BLENDER);
                    this._pBlend = null;
                    this._pSliders = [];
                    this._pMaskNodes = [];
                    this.template("ui/templates/AnimationBlender.tpl");
                    this.linkAreas();
                    this._pNameLabel = this.findEntity("name");
                    this.connect(this._pNameLabel, "changed", "_textChanged");
                    this._pBlend = pBlender = pBlender || akra.animation.createBlend();
                    this.graph.addAnimation(pBlender);
                    this._pNameLabel.text = pBlender.name;
                }
                Object.defineProperty(Blender.prototype, "animation", {
                    get: function () {
                        return this._pBlend;
                    },
                    enumerable: true,
                    configurable: true
                });
                Blender.prototype.onConnectionBegin = function (pGraph, pRoute) {
                    if (pRoute.left.node === this) {
                        return;
                    }
                    if (!this.isConnectedWith(pRoute.left.node)) {
                        _super.prototype.onConnectionBegin.call(this, pGraph, pRoute);
                        return;
                    }
                    this.el.addClass("blocked");
                };
                Blender.prototype._textChanged = function (pLabel, sValue) {
 {
                        akra.logger.setSourceLocation("Blender.ts", 58);
                        akra.logger.log("new blend name > " + sValue);
                    }
                    ;
                    this._pBlend.name = sValue;
                };
                Blender.prototype.destroy = function () {
                    (this.graph).removeAnimation(this._pBlend);
                    _super.prototype.destroy.call(this);
                };
                Blender.prototype.getMaskNode = function (iAnimation) {
                    return this._pMaskNodes[iAnimation] || null;
                };
                Blender.prototype.setMaskNode = function (iAnimation, pNode) {
                    this._pMaskNodes[iAnimation] = pNode;
                };
                Blender.prototype.setup = function () {
                    var pBlend = this._pBlend;
                    for(var i = 0; i < pBlend.totalAnimations; i++) {
                        for(var j = 0; j < this._pSliders.length; ++j) {
                            if (this._pSliders[j].animation === pBlend.getAnimation(i)) {
                                this._pSliders[j].slider.value = pBlend.getAnimationWeight(i);
                            }
                        }
                    }
                    this._pNameLabel.text = pBlend.name;
                };
                Blender.prototype.connected = function (pArea, pFrom, pTo) {
                    if (pFrom.direction === akra.EUIGraphDirections.IN) {
                        var pTarget = (pTo.node);
                        var pAnimation = pTarget.animation;
                        var pBlend = null;
                        var pSlider = null;
                        var pMask;
                        var iAnim = this._pBlend.addAnimation(pAnimation);
                        pSlider = this.createComponent("slider", {
                            show: false
                        });
                        pSlider.render(this.el.find(".controls"));
                        pSlider.range = 100;
                        pSlider.bind("updated", function (pSlider, iValue) {
                            pBlend.setAnimationWeight(iAnim, iValue);
                        });
                        this._pSliders[iAnim] = {
                            slider: pSlider,
                            animation: pAnimation
                        };
                    }
                };
                Blender.prototype.rendered = function () {
                    _super.prototype.rendered.call(this);
                    this.el.addClass("component-animationblender");
                };
                return Blender;
            })(animation.Node);
            animation.Blender = Blender;            
            ui.register("AnimationBlender", Blender);
        })(ui.animation || (ui.animation = {}));
        var animation = ui.animation;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (animation) {
            var Controls = (function (_super) {
                __extends(Controls, _super);
                function Controls(parent, options) {
                                _super.call(this, parent, options, ui.getUI(parent).createComponent("AnimationGraph"));
                    var pControlPanel = this.controls;
                    var pPlayerBtn = new ui.Button(pControlPanel, {
                        text: "Create player"
                    });
                    var pBlenderBtn = new ui.Button(pControlPanel, {
                        text: "Create blender"
                    });
                    var pMaskBtn = new ui.Button(pControlPanel, {
                        text: "Create mask"
                    });
                    this.connect(pPlayerBtn, "click", "createPlayer");
                    this.connect(pBlenderBtn, "click", "createBlender");
                    this.connect(pMaskBtn, "click", "createMask");
                }
                Controls.prototype.createData = function () {
                    return new animation.Data(this.graph);
                };
                Controls.prototype.createPlayer = function () {
                    return new animation.Player(this.graph);
                };
                Controls.prototype.createBlender = function () {
                    return new animation.Blender(this.graph);
                };
                Controls.prototype.createMask = function () {
                    return new animation.Mask(this.graph);
                };
                return Controls;
            })(ui.graph.Controls);
            animation.Controls = Controls;            
            ui.register("AnimationControls", Controls);
        })(ui.animation || (ui.animation = {}));
        var animation = ui.animation;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (graph) {
            var Graph = (function (_super) {
                __extends(Graph, _super);
                function Graph(parent, options, eType) {
                    if (typeof eType === "undefined") { eType = akra.EUIGraphTypes.UNKNOWN; }
                                _super.call(this, parent, options, akra.EUIComponents.GRAPH);
                    this._pCanvas = null;
                    this._pTempRoute = null;
                    this._eGraphType = eType;
                    this.el.disableSelection();
                    this.handleEvent("mouseup mousemove keydown click");
                }
                Object.defineProperty(Graph.prototype, "nodes", {
                    get: function () {
                        var pNodes = [];
                        var pChild = this.child;
                        while(!((pChild) === null)) {
                            pNodes.push(pChild);
                            pChild = pChild.sibling;
                        }
                        return pNodes;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Graph.prototype, "graphType", {
                    get: function () {
                        return this._eGraphType;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Graph.prototype, "canvas", {
                    get: function () {
                        return this._pCanvas;
                    },
                    enumerable: true,
                    configurable: true
                });
                Graph.prototype.createRouteFrom = function (pConnector) {
                    this._pTempRoute = new graph.TempRoute(pConnector);
                    this.connectionBegin(this._pTempRoute);
                };
                Graph.prototype.removeTempRoute = function () {
                    this._pTempRoute.destroy();
                    this._pTempRoute = null;
                    this.connectionEnd();
                };
                Graph.prototype.isReadyForConnect = function () {
                    return !((this._pTempRoute) === null);
                };
                Graph.prototype.connectTo = function (pTo) {
                    if (((this._pTempRoute) === null)) {
                        return;
                    }
                    var pFrom = this._pTempRoute.left;
                    if (pFrom.node === pTo.node) {
 {
                            akra.logger.setSourceLocation("../graph/Graph.ts", 69);
                            akra.logger.log("connection to same node forbidden");
                        }
                        ;
                        this.removeTempRoute();
                        return;
                    }
                    var pRoute = new graph.Route(pFrom, pTo);
                    pRoute.routing();
                    this._pTempRoute.detach();
                    this.removeTempRoute();
                };
                Graph.prototype.rendered = function () {
                    _super.prototype.rendered.call(this);
                    this._pCanvas = Raphael(this.getHTMLElement(), 0, 0);
                    var $svg = this.$element.children(":first");
                    $svg.css({
                        width: "100%",
                        height: "100%"
                    });
                    this.el.addClass("component-graph");
                };
                Graph.prototype.mouseup = function (e) {
                    if (!((this._pTempRoute) === null)) {
                        this.removeTempRoute();
                    }
                };
                Graph.prototype.mousemove = function (e) {
                    if (!((this._pTempRoute) === null)) {
                        var pOffset = this.el.offset();
                        this._pTempRoute.routing({
                            x: e.pageX - pOffset.left,
                            y: e.pageY - pOffset.top
                        });
                    }
                };
                Graph.prototype.keydown = function (e) {
                    var pNodes = this.nodes;
                    for(var i = 0; i < pNodes.length; ++i) {
                        var iKeyCode = (e).keyCode;
                        if (iKeyCode === akra.EKeyCodes.DELETE) {
                            pNodes[i].sendEvent(Graph.event(akra.EUIGraphEvents.DELETE));
                        }
                    }
                    _super.prototype.keydown.call(this, e);
                };
                Graph.prototype.click = function (e) {
                    var pNodes = this.nodes;
                    for(var i = 0; i < pNodes.length; ++i) {
                        pNodes[i].activate(false);
                    }
                    _super.prototype.click.call(this, e);
                };
                Graph.prototype.connectionBegin = function (pRoute) {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).connectionBegin;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pRoute) : _broadcast[i].listener(_recivier, pRoute);
                        }
                    }
                };
                Graph.prototype.connectionEnd = function () {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).connectionEnd;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                        }
                    }
                };
                Graph.event = function event(eType) {
                    return {
                        type: eType,
                        traversedRoutes: []
                    };
                };
                return Graph;
            })(ui.Component);
            graph.Graph = Graph;            
            ui.register("Graph", Graph);
        })(ui.graph || (ui.graph = {}));
        var graph = ui.graph;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        (function (animation) {
            var Graph = (function (_super) {
                __extends(Graph, _super);
                function Graph(parent, options) {
                                _super.call(this, parent, options, akra.EUIGraphTypes.ANIMATION);
                    this._pSelectedNode = null;
                    this._pAnimationController = null;
                    this._pTimer = null;
                }
                Graph.prototype.setTimer = function (pTimer) {
                    this._pTimer = pTimer;
                };
                Graph.prototype.getController = function () {
                    return this._pAnimationController;
                };
                Graph.prototype.selectNode = function (pNode) {
                    var bPlay = true;
                    if (this._pSelectedNode === pNode) {
                        return;
                    }
                    this._pSelectedNode = pNode;
                    if (bPlay && !((this._pTimer) === null)) {
                        this._pAnimationController.play(pNode.animation, this._pTimer.appTime);
                    }
                    this.nodeSelected(pNode, bPlay);
                };
                Graph.prototype.nodeSelected = function (pNode, bPlay) {
                    this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                    var _broadcast = (this._pBroadcastSlotList).nodeSelected;
                    var _recivier = this;
                    if (((_broadcast) !== undefined)) {
                        for(var i = 0; i < _broadcast.length; ++i) {
                            _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, pNode, bPlay) : _broadcast[i].listener(_recivier, pNode, bPlay);
                        }
                    }
                };
                Graph.prototype.addAnimation = function (pAnimation) {
                    this._pAnimationController.addAnimation(pAnimation);
                };
                Graph.prototype.removeAnimation = function (animation) {
                    this._pAnimationController.removeAnimation(animation);
                };
                Graph.prototype.findNodeByAnimation = function (animation) {
                    return null;
                };
                Graph.prototype.createNodeByController = function (pController) {
                    var pNode = null;
                    for(var i = 0; i < pController.totalAnimations; ++i) {
                        var pAnimation = pController.getAnimation(i);
                        pNode = this.createNodeByAnimation(pAnimation);
                    }
                    return;
                };
                Graph.prototype.createNodeByAnimation = function (pAnimation) {
                    var pNode = this.findNodeByAnimation(pAnimation.name);
                    var pSubNode;
                    var pMaskNode;
                    var pSubAnimation;
                    var n = 0;
                    var pMask = null;
                    if (!((pNode) === null)) {
                        return pNode;
                    }
                    if (akra.animation.isAnimation(pAnimation)) {
                        pNode = new animation.Data(this);
                        pNode.animation = pAnimation;
                    } else {
 {
                            akra.logger.setSourceLocation("animation/Graph.ts", 108);
                            akra.logger.criticalError("AHTUNG!!!");
                        }
                        ;
                    }
                    return null;
                };
                Graph.prototype.capture = function (pController) {
 {
                        akra.logger.setSourceLocation("animation/Graph.ts", 115);
                        akra.logger.assert(((this._pAnimationController) === null), "\"controller exists!!!\"");
                    }
                    ;
                    this._pAnimationController = pController;
                    this.connect(pController, "play", "onControllerPlay");
                    this.createNodeByController(pController);
                    this.setTimer(pController.getEngine().getTimer());
                    var pEngine = pController.getEngine();
                    pEngine.getScene().bind("beforeUpdate", /** @inline */function () {
                        pController.update(pEngine.time);
                    });
                    return true;
                };
                Graph.prototype.onControllerPlay = function (pAnimation) {
                };
                Graph.prototype.addChild = function (pChild) {
                    pChild = _super.prototype.addChild.call(this, pChild);
                    if (ui.isComponent(pChild, akra.EUIComponents.GRAPH_NODE)) {
                        var pNode = pChild;
                        this.connect(pNode, "click", "selectNode");
                    }
                    return pChild;
                };
                return Graph;
            })(ui.graph.Graph);
            animation.Graph = Graph;            
            ui.register("AnimationGraph", Graph);
        })(ui.animation || (ui.animation = {}));
        var animation = ui.animation;
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (ui) {
        var UI = (function () {
            function UI(pManager) {
                if (typeof pManager === "undefined") { pManager = null; }
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._pManager = pManager;
            }
            Object.defineProperty(UI.prototype, "type", {
                get: function () {
                    return akra.ESceneTypes.TYPE_2D;
                },
                enumerable: true,
                configurable: true
            });
            UI.prototype.getManager = function () {
                return this._pManager;
            };
            UI.prototype.createHTMLNode = function (pElement) {
                return new ui.HTMLNode(this, pElement);
            };
            UI.prototype.createDNDNode = function (pElement) {
                return new ui.DNDNode(this, pElement);
            };
            UI.prototype.createComponent = function (sType, pOptions) {
                if (((/*checked (origin: ui)>>*/akra.ui.COMPONENTS[sType]) != null)) {
                    return new ui.COMPONENTS[sType](this, pOptions);
                }
                return new ui.Component(this, ui.mergeOptions(pOptions, {
                    generic: sType
                }));
            };
            UI.prototype.createLayout = function (type, pAttrs) {
                if (typeof type === "undefined") { type = null; }
                if (typeof pAttrs === "undefined") { pAttrs = null; }
                var pLayout = null;
                if ((typeof (type) === "string")) {
                    type = type.toLowerCase();
                }
                switch(type) {
                    case "horizontal":
                    case akra.EUILayouts.HORIZONTAL:
                        pLayout = new ui.Horizontal(this);
                        break;
                    case "vertical":
                    case akra.EUILayouts.VERTICAL:
                        pLayout = new ui.Vertical(this);
                        break;
                    default:
                        pLayout = new ui.Layout(this);
                }
                if (!((pLayout) === null) && !((pAttrs) === null)) {
                    pLayout.setAttributes(pAttrs);
                }
                return pLayout;
            };
            UI.prototype.getGuid = function () {
                return this._iGuid;
            };
            UI._pEventTable = new akra.events.EventTable();
            UI.prototype.getEventTable = function () {
                return UI._pEventTable;
            };
            UI.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            UI.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            UI.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            UI.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            UI.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            return UI;
        })();
        ui.UI = UI;        
    })(akra.ui || (akra.ui = {}));
    var ui = akra.ui;
})(akra || (akra = {}));
var akra;
(function (akra) {
    (function (core) {
        var Engine = (function () {
            function Engine(pOptions) {
                if (typeof pOptions === "undefined") { pOptions = null; }
                this._iAppPausedCount = 0;
                this._isActive = false;
                this._isFrameMoving = true;
                this._isDepsLoaded = false;
                this._pGamepads = null;
                this._fElapsedAppTime = 0.0;
                this._iGuid = ((++/*checked (origin: akra)>>*/akra._total));
                this._pUnicastSlotMap = null;
                this._pBroadcastSlotList = null;
                this._pResourceManager = new core.pool.ResourcePoolManager(this);
                if (!this._pResourceManager.initialize()) {
 {
                        akra.logger.setSourceLocation("core/Engine.ts", 80);
                        akra.logger.error('cannot initialize ResourcePoolManager');
                    }
                    ;
                }
                this._pSceneManager = new akra.scene.SceneManager(this);
                if (!this._pSceneManager.initialize()) {
 {
                        akra.logger.setSourceLocation("core/Engine.ts", 85);
                        akra.logger.error("cannot initialize SceneManager");
                    }
                    ;
                }
                this._pParticleManager = null;
                this._pTimer = akra.util.UtilTimer.start();
                this._pRenderer = new akra.webgl.WebGLRenderer(this);
                this._pComposer = new akra.fx.Composer(this);
                akra.DDSCodec.startup();
                this.pause(false);
                this.parseOptions(pOptions);
            }
            Object.defineProperty(Engine.prototype, "time", {
                get: function () {
                    return this._pTimer.appTime;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Engine.prototype, "elapsedTime", {
                get: function () {
                    return this._fElapsedAppTime;
                },
                enumerable: true,
                configurable: true
            });
            Engine.prototype.enableGamepads = function () {
                if (!((this._pGamepads) === null)) {
                    return true;
                }
                var pGamepads = akra.controls.createGamepadMap();
                if (pGamepads.init()) {
                    this._pGamepads = pGamepads;
                    return true;
                }
                return false;
            };
            Engine.prototype.getGamepads = function () {
                if (this.enableGamepads()) {
                    return this._pGamepads;
                }
                return null;
            };
            Engine.prototype.parseOptions = function (pOptions) {
                var pDeps = Engine.DEPS;
                var sDepsRoot = Engine.DEPS_ROOT;
                var pDepsManager = akra.util.createDepsManager(this);
                if (!((pOptions) === null)) {
                    sDepsRoot = pOptions.depsRoot || Engine.DEPS_ROOT;
                    if (((pOptions.deps) != null)) {
                        Engine.depends(pOptions.deps);
                    }
                    if (pOptions.gamepads === true) {
                        this.enableGamepads();
                    }
                }
                this.connect(pDepsManager, "loaded", "_depsLoaded");
                if (!pDepsManager.load(pDeps, sDepsRoot)) {
 {
                        akra.logger.setSourceLocation("core/Engine.ts", 155);
                        akra.logger.criticalError("load dependencies are not started.");
                    }
                    ;
                }
            };
            Engine.prototype.getScene = function () {
                return this._pSceneManager.getScene3D(0);
            };
            Engine.prototype.getSceneManager = function () {
                return this._pSceneManager;
            };
            Engine.prototype.getParticleManager = function () {
                return null;
            };
            Engine.prototype.getResourceManager = function () {
                return this._pResourceManager;
            };
            Engine.prototype.getRenderer = function () {
                return this._pRenderer;
            };
            Engine.prototype.getComposer = function () {
                return this._pComposer;
            };
            Engine.prototype.isActive = function () {
                return this._isActive;
            };
            Engine.prototype.isDepsLoaded = function () {
                return this._isDepsLoaded;
            };
            Engine.prototype.exec = function (bValue) {
                if (typeof bValue === "undefined") { bValue = true; }
                var pRenderer = this._pRenderer;
                var pEngine = this;
 {
                    akra.logger.setSourceLocation("core/Engine.ts", 203);
                    akra.logger.assert(!((pRenderer) === null));
                }
                ;
                pRenderer._initRenderTargets();
                bValue ? this.active() : this.inactive();
                function render(iTime) {
                    if (pRenderer.isValid()) {
 {
                            akra.logger.setSourceLocation("core/Engine.ts", 215);
                            akra.logger.error(pRenderer.getError());
                        }
                        ;
                    }
                    if (pEngine.isActive() && pEngine.isDepsLoaded()) {
                        if (!pEngine.renderFrame()) {
 {
                                akra.logger.setSourceLocation("core/Engine.ts", 220);
                                akra.logger.error("Engine::exec() error.");
                            }
                            ;
                            return;
                        }
                    }
                    requestAnimationFrame(render);
                }
                render(0);
            };
            Engine.prototype.getTimer = function () {
                return this._pTimer;
            };
            Engine.prototype.renderFrame = function () {
                this._fElapsedAppTime = this._pTimer.elapsedTime;
                if (0. == this._fElapsedAppTime && this._isFrameMoving) {
                    return true;
                }
                if (this._isFrameMoving) {
                    if (!((this._pGamepads) === null)) {
                        this._pGamepads.update();
                    }
                    this._pSceneManager.update();
                }
                this.frameStarted();
                this._pRenderer._updateAllRenderTargets();
                this.frameEnded();
                return true;
            };
            Engine.prototype.play = function () {
                if (!this.isActive()) {
                    this._iAppPausedCount = 0;
                    this.active();
                    if (this._isFrameMoving) {
                        this._pTimer.start();
                    }
                }
                return this.isActive();
            };
            Engine.prototype.pause = function (isPause) {
                if (typeof isPause === "undefined") { isPause = false; }
                this._iAppPausedCount += (isPause ? +1 : -1);
                (this._iAppPausedCount ? this.inactive() : this.active());
                if (isPause && (1 == this._iAppPausedCount)) {
                    if (this._isFrameMoving) {
                        this._pTimer.stop();
                    }
                }
                if (0 == this._iAppPausedCount) {
                    if (this._isFrameMoving) {
                        this._pTimer.start();
                    }
                }
                return !this.isActive();
            };
            Engine.prototype.createMesh = function (sName, eOptions, pDataBuffer) {
                if (typeof sName === "undefined") { sName = null; }
                if (typeof eOptions === "undefined") { eOptions = 0; }
                if (typeof pDataBuffer === "undefined") { pDataBuffer = null; }
                return akra.model.createMesh(this, sName, eOptions, pDataBuffer);
            };
            Engine.prototype.createRenderDataCollection = function (iOptions) {
                if (typeof iOptions === "undefined") { iOptions = 0; }
                return akra.render.createRenderDataCollection(this, iOptions);
            };
            Engine.prototype.createBufferMap = function () {
                return akra.util.createBufferMap(this);
            };
            Engine.prototype.createAnimationController = function (iOptions) {
                if (typeof iOptions === "undefined") { iOptions = 0; }
                return akra.animation.createController(this, iOptions);
            };
            Engine.prototype._depsLoaded = function (pLoader, pDeps) {
 {
                    akra.logger.setSourceLocation("core/Engine.ts", 311);
                    akra.logger.log("[ALL DEPTS LOADED]");
                }
                ;
                this._isDepsLoaded = true;
                this.depsLoaded(pDeps);
            };
            Engine.depends = function depends(pData) {
                var pDeps = Engine.DEPS;
                while(((pDeps.files) != null)) {
                    pDeps = pDeps.deps;
                }
                if ((typeof (pData) === "string")) {
                    pDeps.files = [
                        pData
                    ];
                } else {
                    pDeps.files = pData;
                }
            };
            Engine.DEPS_ROOT = "/akra-engine-core/src2/data/";
            Engine.DEPS = {
                files: [
                    "grammars/HLSL.gr"
                ],
                deps: {
                    files: [
                        "effects/SystemEffects.afx", 
                        "effects/Plane.afx", 
                        "effects/fxaa.afx", 
                        "effects/skybox.afx", 
                        "effects/mesh.afx", 
                        "effects/TextureToScreen.afx", 
                        "effects/mesh_geometry.afx", 
                        "effects/prepare_shadows.afx", 
                        "effects/terrain.afx", 
                        "effects/prepareDeferredShading.afx"
                    ],
                    deps: {
                        files: [
                            "effects/mesh_texture.afx", 
                            "effects/deferredShading.afx", 
                            "effects/apply_lights_and_shadows.afx"
                        ]
                    }
                }
            };
            Engine.prototype.getGuid = function () {
                return this._iGuid;
            };
            Engine._pEventTable = new akra.events.EventTable();
            Engine.prototype.getEventTable = function () {
                return Engine._pEventTable;
            };
            Engine.prototype.connect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().addDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Engine.prototype.disconnect = function (pSender, sSignal, sSlot, eType) {
                return pSender.getEventTable().removeDestination((pSender).getGuid(), sSignal, this, sSlot, eType);
            };
            Engine.prototype.bind = function (sSignal, fnListener, eType) {
                return this.getEventTable().addListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Engine.prototype.unbind = function (sSignal, fnListener, eType) {
                return this.getEventTable().removeListener(this.getGuid(), sSignal, fnListener, eType);
            };
            Engine.prototype._syncTable = function (pFrom) {
                this.getEventTable()._sync(this, pFrom);
            };
            Engine.prototype.frameStarted = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).frameStarted;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            Engine.prototype.frameEnded = function () {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).frameEnded;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
            };
            Engine.prototype.depsLoaded = function (deps) {
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).depsLoaded;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier, deps) : _broadcast[i].listener(_recivier, deps);
                    }
                }
            };
            Engine.prototype.inactive = function () {
                this._isActive = false;
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).inactive;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
                ;
            };
            Engine.prototype.active = function () {
                this._isActive = true;
                this._pBroadcastSlotList = this._pBroadcastSlotList || (this.getEventTable()).findBroadcastList(this._iGuid);
                var _broadcast = (this._pBroadcastSlotList).active;
                var _recivier = this;
                if (((_broadcast) !== undefined)) {
                    for(var i = 0; i < _broadcast.length; ++i) {
                        _broadcast[i].target ? _broadcast[i].target[_broadcast[i].callback](_recivier) : _broadcast[i].listener(_recivier);
                    }
                }
                ;
            };
            return Engine;
        })();
        core.Engine = Engine;        
    })(akra.core || (akra.core = {}));
    var core = akra.core;
})(akra || (akra = {}));
var akra;
(function (akra) {
    akra.createEngine = function (pOptions) {
        return new akra.core.Engine(pOptions);
    };
})(akra || (akra = {}));
